<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en-GB-hixie">
 <head>
  <title>Web Applications 1.0</title>
  <link rel="stylesheet" type="text/css" href="/style/specification">
  <link rel="icon" href="/images/icon">
  <style type="text/css">
   h4 + .element { margin-top: -2.5em; padding-top: 2em; }
   h4 + p + .element { margin-top: -5em; padding-top: 4em; }
   .element { background: #EEFFEE; color: black; margin: 0 0 1em -1em; padding: 0 1em 0.25em 0.75em; border-left: solid #99FF99 0.25em; -padding: 0; /* that last decl is for IE6. Try removing it, it's hilarious! */ }
   .proposal { border: blue solid; padding: 1em; }
   table.matrix, table.matrix td { border: none; text-align: right; }
   table.matrix { margin-left: 2em; }
  </style>
 </head>
 <body class="draft">

  <div class="head">
   <p><a rel="home" href="http://www.whatwg.org/" class="logo"><img alt="WHATWG" src="/images/logo"></a></p>
   <h1>Web Applications 1.0</h1>
   <h2 class="no-num no-toc">Working Draft &mdash; [DATE: 01 Jan 1901]</h2>
   <p>You can take part in this work. <a href="http://www.whatwg.org/mailing-list">Join the working group's discussion list.</a></p>
   <p><strong>Web designers!</strong> We have a <a href="http://blog.whatwg.org/faq/">FAQ</a>, a <a href="http://forums.whatwg.org/">forum</a>, and a <a href="http://www.whatwg.org/mailing-list#help">help mailing list</a> for you!</p>
   <dl>
    <dt>This version:</dt>
    <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/">http://www.whatwg.org/specs/web-apps/current-work/</a></dd>
    <dt>Latest version:</dt>
    <dd><a href="http://www.whatwg.org/specs/web-apps/current-work/">http://www.whatwg.org/specs/web-apps/current-work/</a></dd>
    <dt>Previous versions:</dt>
    <dd><a href="http://www.whatwg.org/specs/web-apps/2006-01-01/">http://www.whatwg.org/specs/web-apps/2006-01-01/</a><!-- (<a href="diff-2006-01-01">diffs</a>)--></dd>
    <dd><a href="http://www.whatwg.org/specs/web-apps/2005-09-01/">http://www.whatwg.org/specs/web-apps/2005-09-01/</a><!-- (<a href="diff-2005-09-01">diffs</a>)--></dd>
    <dd>Version history from 2006-03-01 available by interactive Web interface at: <a href="http://html5.org/tools/web-apps-tracker">http://html5.org/tools/web-apps-tracker</a></dd>
    <dd>Version history from 2006-03-01 available by Subversion interface at: <a href="http://svn.whatwg.org/">http://svn.whatwg.org/</a></dd>
    <dt>Editor:</dt>
    <dd>Ian Hickson, Google, ian@hixie.ch</dd>
   </dl>
   <p class="copyright">&copy; Copyright 2004-2007 Apple Computer, Inc.,
   Mozilla Foundation, and Opera Software ASA.</p>
   <p class="copyright">You are granted a license to use, reproduce
   and create derivative works of this document.</p>
  </div>

  <hr>

  <h2 class="no-num no-toc" id="abstract">Abstract</h2>

  <p>This specification introduces features to HTML and the DOM that
  ease the authoring of Web-based applications. Additions include the
  context menus, a direct-mode graphics canvas, inline popup windows,
  and server-sent events.</p>

  <h2 class="no-num no-toc" id="status">Status of this document</h2>

  <p><strong>This is a work in progress!</strong> This document is
  changing on a daily if not hourly basis in response to comments and
  as a general part of its development process. Comments are very
  welcome, please send them to <a
  href="mailto:whatwg@whatwg.org">whatwg@whatwg.org</a>. Thank
  you.</p>

  <p>Implementors should be aware that this specification is not
  stable. <strong>Implementors who are not taking part in the
  discussions are likely to find the specification changing out from
  under them in incompatible ways.</strong> Vendors interested in
  implementing this specification before it eventually reaches the
  call for implementations should join the <a
  href="/mailing-list">WHATWG mailing list</a> and take part in the
  discussions.</p>

  <p>This draft may contain namespaces that use the <code>uuid:</code>
  URI scheme. These are temporary and will be changed before those
  parts of the specification are ready to be implemented in shipping
  products.</p>

  <p>This specification is intended to replace (be the new version of)
  what was previously the HTML4, XHTML 1.x, and DOM2 HTML
  specifications.</p>

  <h3 class="no-num no-toc">Stability</h3>

  <p>Different parts of this specification are at different levels of
  maturity.</p>

  <div id="stability"></div>

  <p class="big-issue">Known issues are usually marked like
  this. There are some spec-wide issues that have not yet been
  addressed: case-sensitivity is a very poorly handled topic
  right now</p>


  <h2 class="no-num no-toc" id="contents">Table of contents</h2>
  <!--toc-->
  <hr>

  <h2 id="introduction">Introduction</h2>

  <p><em>This section is non-normative.</em></p>

  <p>The World Wide Web's markup language has always been HTML. HTML
  was primarily designed as a language for semantically describing
  scientific documents, although its general design and adaptations
  over the years has enabled it to be used to describe a number of
  other types of documents.</p>

  <p>The main area that has not been adequately addressed by HTML is a
  vague subject referred to as Web Applications. This specification
  attempts to rectify this, while at the same time updating the HTML
  specifications to address issues raised in the past few years.</p>

  <h3>Scope</h3>

  <p><em>This section is non-normative.</em></p>

  <p>This specification is limited to providing a semantic-level
  markup language and associated semantic-level scripting APIs for
  authoring accessible pages on the Web ranging from static documents
  to dynamic applications.</p>

  <p>The scope of this specification does not include addressing
  presentation concerns (although default rendering rules for Web
  browsers are included at the end of this specification).</p>

  <p>The scope of this specification does not include documenting
  every HTML or DOM feature supported by Web browsers. Browsers
  support many features that are considered to be very bad for
  accessibility or that are otherwise inappropriate. For example, the
  <code>blink</code> element is clearly presentational and authors
  wishing to cause text to blink should instead use CSS.</p>

  <p>The scope of this specification is not to describe an entire
  operating system. In particular, hardware configuration software,
  image manipulation tools, and applications that users would be
  expected to use with high-end workstations on a daily basis are out
  of scope. In terms of applications, this specification is targeted
  specifically at applications that would be expected to be used by
  users on an occasional basis, or regularly but from disparate
  locations, with low CPU requirements. For instance online purchasing
  systems, searching systems, games (especially multiplayer online
  games), public telephone books or address books, communications
  software (e-mail clients, instant messaging clients, discussion
  software), document editing software, etc.</p>

  <p>For sophisticated cross-platform applications, there already
  exist several proprietary solutions (such as Mozilla's XUL and
  Macromedia's Flash). These solutions are evolving faster than any
  standards process could follow, and the requirements are evolving
  even faster. These systems are also significantly more complicated
  to specify, and are orders of magnitude more difficult to achieve
  interoperability with, than the solutions described in this
  document. Platform-specific solutions for such sophisticated
  applications (for example the MacOS X Core APIs) are even further
  ahead.</p>


  <h3>Structure of this specification</h3>

  <p><em>This section is non-normative.</em></p>

  <p>This specification is divided into five key parts:</p>

  <dl>


   <dt><a href="#dom">The DOM</a></dt>

   <dd>The DOM, or Document Object Model, provides a base for the rest
   of the specification.</dd>


   <dt><a href="#semantics">The Semantics</a></dt>

   <dd>Documents are built from elements. These elements form a tree
   using the DOM. Each element also has a predefined meaning, which is
   explained in this section. User agent requirements for how to
   handle each element are also given, along with rules for authors on
   how to use the element.</dd>


   <dt><a href="#processing-models">The Processing Models</a></dt>

   <dd>In addition to the rules for each element, there are rules for
   handling features that cover multiple elements. These are defined
   in the processing models section, so that the whole feature can be
   defined in one place instead of being split across the definitions
   for multiple elements.</dd>


   <dt><a href="#apis">The High-Level APIs</a></dt>

   <dd>Certain extensions to the DOM provide APIs for interacting with
   the user. Three sections, covering <a href="#apis">the browser
   enviroment</a>, <a href="#editing">editing</a>, and <a
   href="#comms">communication</a>, define these high-level APIs.</dd>


   <dt><a href="#syntax">The Language Syntax</a></dt>

   <dd>All of these features would be for naught if they couldn't be
   represented in a serialised form and sent to other people, and so
   this section defines the syntax of HTML, along with rules for how
   to parse HTML.</dd>


  </dl>

  <p>There are also a couple of appendices, defining <a
  href="#rendering">rendering rules</a> for Web browsers, and listing
  <a href="#no">areas that are out of scope</a> for this
  specification.</p>


  <h4>How to read this specification</h4>

  <p>This specification should be read like all other specifications.
  First, it should be read cover-to-cover, multiple times. Then, it
  should be read backwards at least once. Then it should be read by
  picking random sections from the contents list and following all the
  cross-references.</p>


  <h3>Conformance requirements</h3>

  <p>All diagrams, examples, and notes in this specification are
  non-normative, as are all sections explicitly marked non-normative.
  Everything else in this specification is normative.</p>

  <p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
  NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL"
  in the normative parts of this document are to be interpreted as
  described in RFC2119. For readability,
  these words do not appear in all uppercase letters in this
  specification. <a href="#refsRFC2119">[RFC2119]</a></p>
  <!-- XXX but they should be marked up -->

  <p>This specification describes the conformance criteria for user
  agents (relevant to implementors) and documents (relevant to
  authors and authoring tool implementors).</p>

  <p class="note">There is no implied relationship between document
  conformance requirements and implementation conformance
  requirements. User agents are not free to handle non-conformant
  documents as they please; the processing model described in this
  specification applies to implementations regardless of the
  conformity of the input documents.</p> <!--XXX quite possible that
  this is stated twice. check for whether this is a dupe. -->

  <p>User agents fall into several (overlapping) categories with
  different conformance requirements.</p>

  <dl>

   <dt id="interactive">Web browsers and other interactive user agents</dt>

   <dd>

    <p>Web browsers that support <span>XHTML</span> must process
    elements and attributes from the <span>HTML namespace</span> found
    in <span>XML documents</span> as described in this specification,
    so that users can interact with them, unless the semantics of
    those elements have been overridden by other specifications.</p>

    <p class="example">A conforming XHTML processor would, upon
    finding an XHTML <code>script</code> element in an XML document,
    execute the script contained in that element. However, if the
    element is found within an XSLT transformation sheet (assuming the
    UA also supports XSLT), then the processor would instead treat the
    <code>script</code> element as an opaque element that forms part
    of the transform.</p>

    <p>Web browsers that support <span title="HTML5">HTML</span> must
    process documents labelled as <code>text/html</code> as described
    in this specification, so that users can interact with them.</p>

   </dd>

   <dt id="non-interactive">Non-interactive presentation user agents</dt>

   <dd>

    <p>User agents that process HTML and XHTML documents purely to
    render non-interactive versions of them must comply to the same
    conformance criteria as Web browsers, except that they are exempt
    from requirements regarding user interaction.</p>

    <p class="note">Typical examples of non-interactive presentation
    user agents are printers (static UAs) and overhead displays
    (dynamic UAs). It is expected that most static non-interactive
    presentation user agents will also opt to <a
    href="#non-scripted">lack scripting support</a>.</p>

    <p class="example">A non-interactive but dynamic presentation UA
    would still execute scripts, allowing forms to be dynamically
    submitted, and so forth. However, since the concept of "focus" is
    irrelevant when the user cannot interact with the document, the UA
    would not need to support any of the focus-related DOM APIs.</p>

   </dd>

   <dt><dfn id="non-scripted">User agents with no scripting support</dfn></dt>

   <dd>

    <p>Implementations that do not support scripting (or which have
    their scripting features <span title="scripting is
    disabled">disabled</span>) are exempt from supporting the events
    and DOM interfaces mentioned in this specification. For the parts
    of this specification that are defined in terms of an events model
    or in terms of the DOM, such user agents must still act as if
    events and the DOM were supported.</p>

    <p class="note">Scripting can form an integral part of an
    application. Web browsers that do not support scripting, or that
    have scripting disabled, might be unable to fully convey the
    author's intent.</p>

   </dd>

   <dt>Conformance checkers</dt>

   <dd id="conformance-checkers">

    <p>Conformance checkers must verify that a document conforms to
    the applicable conformance criteria described in this
    specification. Conformance checkers are exempt from detecting
    errors that require interpretation of the author's intent (for
    example, while a document is non-conforming if the content of a
    <code>blockquote</code> element is not a quote, conformance
    checkers do not have to check that <code>blockquote</code>
    elements only contain quoted material).</p>

    <p>Conformance checkers must check that the input document
    conforms when <span>scripting is disabled</span>, and should also
    check that the input document conforms when <span>scripting is
    enabled</span>. (This is only a "SHOULD" and not a "MUST"
    requirement because it has been proven to be impossible. <a
    href="#refsHALTINGPROBLEM">[HALTINGPROBLEM]</a>)</p> <!-- XXX
    http://en.wikipedia.org/wiki/Halting_problem but I'd rather
    reference Godel's original paper if someone can find the
    ref... -->

    <div class="note">
     <p>The term "validation" specifically refers to a subset of
     conformance checking that only verifies that a document complies
     with the requirements given by an SGML or XML DTD. Conformance
     checkers that only perform validation are non-conforming, as
     there are many conformance requirements described in this
     specification that cannot be checked by SGML or XML DTDs.</p>
     <p>To put it another way, there are three types of conformance
     criteria:</p>
     <ol>
      <li>Criteria that can be expressed in a DTD.</li>
      <li>Criteria that cannot be expressed by a DTD, but can still be
      checked by a machine.</li>
      <li>Criteria that can only be checked by a human.</li>
     </ol>
     <p>A conformance checker must check for the first two. A simple
     DTD-based validator only checks for the first class of errors and
     is therefore not a conforming conformance checker according to
     this specification.</p>
    </div>
   </dd>

   <dt>Data mining tools</dt>

   <dd id="data-mining">

    <p>Applications and tools that process HTML and XHTML documents
    for reasons other than to either render the documents or check
    them for conformance should act in accordance to the semantics of
    the documents that they process.</p>

    <p class="example">A tool that generates <span title="sections and
    headings">document outlines</span> but increases the nesting level
    for each paragraph and does not increase the nesting level for
    each section would not be conforming.</p>

   </dd>

   <dt id="editors">Authoring tools and markup generators</dt>

   <dd>

    <p>Authoring tools and markup generators must generate conforming
    documents. Conformance criteria that apply to authors also apply
    to authoring tools, where appropriate.</p>

    <p>Authoring tools are exempt from the strict requirements of
    using elements only for their specified purpose, but only to the
    extent that authoring tools are not yet able to determine author
    intent.</p>

    <p class="example">For example, it is not conforming to use an
    <code>address</code> element for arbitrary contact information;
    that element can only be used for marking up contact information
    for the author of the document or section. However, since an
    authoring tools is likely unable to determine the difference, an
    authoring tool is exempt from that requirement.</p>

    <p class="note">In terms of conformance checking, an editor is
    therefore required to output documents that conform to the same
    extent that a conformance checker will verify.</p>

    <p>When an authoring tool is used to edit a non-conforming
    document, it may preserve the conformance errors in sections of
    the document that were not edited during the editing session
    (i.e. an editing tool is allowed to round-trip errorneous
    content). However, an authoring tool must not claim that the
    output is conformant if errors have been so preserved.</p>

    <p>Authoring tools are expected to come in two broad varieties:
    tools that work from structure or semantic data, and tools that
    work on a What-You-See-Is-What-You-Get media-specific editing
    basis (WYSIWYG).</p>

    <p>The former is the preferred mechanism for tools that author
    HTML, since the structure in the source information can be used to
    make informed choices regarding which HTML elements and attributes
    are most appropriate.</p>

    <p>However, WYSIWYG tools are legitimate, and this specification
    <span title="WYSIWYG editors">makes certain concessions to WYSIWYG
    editors</span>.</p>

    <p>All authoring tools, whether WYSIWYG or not, should make a best
    effort attempt at enabling users to create well-structured,
    semantically rich, media-independent content.</p>

   </dd>

  </dl>

  <p>Some conformance requirements are phrased as requirements on
  elements, attributes, methods or objects. Such requirements fall
  into two categories; those describing content model restrictions,
  and those describing implementation behaviour. The former category
  of requirements are requirements on documents and authoring
  tools. The second category are requirements on user agents.</p>

  <p>Conformance requirements phrased as algorithms or specific steps
  may be implemented in any manner, so long as the end result is
  equivalent. (In particular, the algorithms defined in this
  specification are intended to be easy to follow, and not intended to
  be performant.)</p>

  <p id="hardwareLimitations">User agents may impose
  implementation-specific limits on otherwise unconstrained inputs,
  e.g. to prevent denial of service attacks, to guard against running
  out of memory, or to work around platform-specific limitations.</p>

  <p>For compatibility with existing content and prior specifications,
  this specification describes two authoring formats: one based on XML
  (referred to as <dfn id="xhtml5" title="XHTML">XHTML5</dfn>), and
  one using a <a href="#parsing">custom format</a> inspired by SGML
  (referred to as <dfn id="html5">HTML5</dfn>). Implementations may
  support only one of these two formats, although supporting both is
  encouraged.</p>

  <p id="authors-using-xhtml"><span>XHTML</span> documents (<span>XML
  documents</span> using elements from the <span>HTML
  namespace</span>) that use the new features described in this
  specification and that are served over the wire (e.g. by HTTP) must
  be sent using an XML MIME type such as <code>application/xml</code>
  or <code>application/xhtml+xml</code> and must not be served as
  <code>text/html</code>. <a href="#refsRFC3023">[RFC3023]</a></p>

  <p>Such XML documents may contain a <code>DOCTYPE</code> if desired,
  but this is not required to conform to this specification.</p>

  <p id="authors-using-html"><span title="HTML5">HTML
  documents</span>, if they are served over the wire (e.g. by HTTP)
  must be labelled with the <code>text/html</code> MIME type.</p> <!--
  XXX update RFC 2854 -->

  <p id="entity-references">The language in this specification assumes
  that the user agent expands all entity references, and therefore
  does not include entity reference nodes in the DOM. If user agents
  do include entity reference nodes in the DOM, then user agents must
  handle them as if they were fully expanded when implementing this
  specification. For example, if a requirement talks about an
  element's child text nodes, then any text nodes that are children of
  an entity reference that is a child of that element would be used as
  well.</p> <!-- XXX unexpandable entities? -->


  <p class="big-issue">A lot of arrays/lists/<span>collection</span>s
  in this spec assume zero-based indexes but use the term "<var
  title="">index</var>th" liberally. We should define those to be
  zero-based and be clearer about this.</p>
  

  <h4>Dependencies</h4>

  <p>This specification relies on several other underlying
  specifications.</p>

  <dl>

   <dt>XML</dt>

   <dd>

    <p>Implementations that support XHTML5 must support some version
    of XML, as well as its corresponding namespaces specification,
    because XHTML5 uses an XML serialisation with namespaces. <a
    href="#refsXML">[XML]</a> <a
    href="#refsXMLNAMES">[XMLNAMES]</a></p>

   </dd>

   <dt>XML Base</dt>

   <dd>

    <p id="xmlBase">User agents must follow the rules given by XML
    Base to resolve relative URIs in HTML and XHTML fragments, because
    that is the mechanism used in this specification for resolving
    relative URIs in DOM trees. <a
    href="#refsXMLBASE">[XMLBASE]</a></p>

    <p class="note">It is possible for <code>xml:base</code> attributes
    to be present even in HTML fragments, as such attributes can be
    added dynamically using script.</p>

   </dd>

   <dt>DOM</dt>

   <dd>

    <p>Implementations must support some version of DOM Core and DOM
    Events, because this specification is defined in terms of the DOM,
    and some of the features are defined as extensions to the DOM Core
    interfaces. <a href="#refsDOM3CORE">[DOM3CORE]</a> <a
    href="#refsDOM3CORE">[DOM3EVENTS]</a></p>

    <p>Implementations must support some version of the Window Object,
    because this specification extends this interface to provide some
    of its features. <a href="#refsWINDOW">[WINDOW]</a></p>

   </dd>

   <dt>ECMAScript</dt>

   <dd>

    <p>Implementations that use ECMAScript to implement the APIs
    defined in this specification must implement them in a manner
    consistent with the ECMAScript Bindings for DOM Specifications
    specification, as this specification uses that specification's
    terminology. <a href="#refsEBFD">[EBFD]</a></p>

   </dd>

  </dl>

  <p>This specification does not require support of any particular
  network transport protocols, image formats, audio formats, video
  formats, style sheet language, scripting language, or any of the DOM
  and WebAPI specifications beyond those described above. However, the
  language described by this specification is biased towards CSS as
  the styling language, ECMAScript as the scripting language, and HTTP
  as the network protocol, and several features assume that those
  languages and protocols are in use.</p>


  <h4>Features defined in other specifications</h4>

  <p>Some elements are defined in terms of their DOM
  <dfn><code>textContent</code></dfn> attribute. This is an attribute
  defined on the <code>Node</code> interface in DOM3 Core. <a
  href="#refsDOM3CORE">[DOM3CORE]</a></p>

  <p class="big-issue">Should textContent be defined differently for
  dir="" and &lt;bdo>? Should we come up with an alternative to
  textContent that handles those and other things, like alt=""?</p>

  <!-- This section is currently here exclusively so that we crossref
  to textContent. XXX also add event-click, event-change,
  event-DOMActivate, etc, here, and just have the section be a general
  "defined in other specifications" section -->

  <p>The term <dfn>activation behavior</dfn> is used as defined in the
  DOM3 Events specification. <a
  href="#refsDOM3EVENTS">[DOM3EVENTS]</a> <span class="big-issue">At
  the time of writing, DOM3 Events hadn't yet been updated to define
  that phrase.</span></p>

  <p>The terms <dfn>browsing context</dfn> and <dfn>top-level browsing
  context</dfn> are used as defined in the Window Object
  specification. <a href="#refsWINDOW">[WINDOW]</a></p>


  <h4>Relationship to HTML 4.01, XHTML 1.1, DOM2 HTML</h4>

  <p><em>This section is non-normative.</em></p>

  <p>This specification represents a new version of HTML4 and XHTML1,
  along with a new version of the associated DOM2 HTML API. Migration
  from HTML4 or XHTML1 to the format and APIs described in this
  specification should in most cases be straightforward, as care has
  been taken to ensure that backwards-compatibility is retained.</p>
  <!-- XXX refs -->

  <p>This specification will eventually supplant Web Forms 2.0 as
  well. <a href="#refsWF2">[WF2]</a></p>


  <h4>Relationship to XHTML2</h4>

  <p><em>This section is non-normative.</em></p>

  <p>XHTML2 <a href="#refsXHTML2">[XHTML2]</a> defines a new HTML
  vocabulary with better features for hyperlinks, multimedia content,
  annotating document edits, rich metadata, declarative interactive
  forms, and describing the semantics of human literary works such as
  poems and scientific papers.</p>

  <p>However, it lacks elements to express the semantics of many of
  the non-document types of content often seen on the Web. For
  instance, forum sites, auction sites, search engines, online shops,
  and the like, do not fit the document metaphor well, and are not
  covered by XHTML2.</p>

  <p><em>This</em> specification aims to extend HTML so that it is
  also suitable in these contexts.</p>

  <p>XHTML2 and this specification use different namespaces and
  therefore can both be implemented in the same XML processor.</p>


  <h4>Relationship to XUL, WPF/XAML, and other proprietary UI languages</h4>

  <p><em>This section is non-normative.</em></p>

  <p>This specification is independent of the various proprietary UI
  languages that various vendors provide.</p> <!-- XXX flesh this out? -->


  <h3>Terminology</h3>

  <p>This specification refers to both HTML and XML attributes and DOM
  attributes, often in the same context. When it is not clear which is
  being referred to, they are referred to as <dfn>content
  attributes</dfn> for HTML and XML attributes, and <dfn>DOM
  attributes</dfn> for those from the DOM. Similarly, the term
  "properties" is used for both ECMAScript object properties and CSS
  properties. When these are ambiguous they are qualified as object
  properties and CSS properties respectively.</p>

  <p id="html-namespace">To ease migration from HTML to XHTML, UAs
  conforming to this specification will place elements in HTML in the
  <code>http://www.w3.org/1999/xhtml</code> namespace, at least for
  the purposes of the DOM and CSS. The term "<dfn>elements in the HTML
  namespace</dfn>", or "<dfn>HTML elements</dfn>" for short, when used
  in this specification, thus refers to both HTML and XHTML
  elements.</p>

  <p>Unless otherwise stated, all elements defined or mentioned in
  this specification are in the
  <code>http://www.w3.org/1999/xhtml</code> namespace, and all
  attributes defined or mentioned in this specification have no
  namespace (they are in the per-element partition).</p>

  <p>The term <span>HTML documents</span> is sometimes used in
  contrast with <span>XML documents</span> to mean specifically
  documents that were parsed using an <span>HTML parser</span> (as
  opposed to using an XML parser or created purely through the
  DOM).</p>

  <p>Generally, when the specification states that a feature applies
  to HTML or XHTML, it also includes the other. When a feature
  specifically only applies to one of the two languages, it is called
  out by explicitly stating that it does not apply to the other
  format, as in "for HTML, ... (this does not apply to XHTML)".</p>

  <p>This specification uses the term <em>document</em> to refer to
  any use of HTML, ranging from short static documents to long essays
  or reports with rich multimedia, as well as to fully-fledged
  interactive applications.</p>

  <p>For readability, the term URI is used to refer to both ASCII URIs
  and Unicode IRIs, as those terms are defined by <a
  href="#refsRFC3986">[RFC3986]</a> and <a
  href="#refsRFC3987">[RFC3987]</a> respectively. On the rare
  occasions where IRIs are not allowed but ASCII URIs are, this is
  called out explicitly.</p>

  <p>The term <dfn>root element</dfn>, when not qualified to
  explicitly refer to the document's root element, means the furthest
  ancestor element node of whatever node is being discussed, or the
  node itself is there is none. When the node is a part of the
  document, then that is indeed the document's root element. However,
  if the node is not currently part of the document tree, the root
  element will be an orphaned node.</p>

  <p>An element is said to have been <dfn title="insert an element
  into a document">inserted into a document</dfn> when its <span>root
  element</span> changes and is now the document's <span>root
  element</span>.</p>

  <p>The term <dfn>tree order</dfn> means a pre-order, depth-first
  traversal of DOM nodes involved (through the <code
  title="">parentNode</code>/<code title="">childNodes</code>
  relationship).</p>

  <p>When it is stated that some element or attribute is <dfn
  title="ignore">ignored</dfn>, or treated as some other value, or
  handled as if it was something else, this refers only to the
  processing of the node after it is in the DOM. A user agent must not
  mutate the DOM in such situations.</p>

  <p>When an XML name, such as an attribute or element name, is
  referred to in the form
  <code><var title="">prefix</var>:<var title="">localName</var></code>, as in
  <code>xml:id</code> or <code>svg:rect</code>, it refers to a name
  with the local name <var title="">localName</var> and the namespace given by
  the prefix, as defined by the following table:</p>

  <dl>
   <dt><code title="">xml</code></dt>
   <dd><code>http://www.w3.org/XML/1998/namespace</code></dd>
   <dt><code title="">html</code></dt>
   <dd><code>http://www.w3.org/1999/xhtml</code></dd>
   <dt><code title="">svg</code></dt>
   <dd><code>http://www.w3.org/2000/svg</code></dd>
  </dl>

  <p>For simplicity, terms such as <em>shown</em>, <em>displayed</em>,
  and <em>visible</em> might sometimes be used when referring to the
  way a document is rendered to the user. These terms are not meant to
  imply a visual medium; they must be considered to apply to other
  media in equivalent ways.</p>

  <p>Various DOM interfaces are defined in this specification using
  pseudo-IDL. This looks like OMG IDL but isn't. For instance, method
  overloading is used, and types from the W3C DOM specifications are
  used without qualification. Language-specific bindings for these
  abstract interface definitions must be derived in the way consistent
  with W3C DOM specifications. Some interface-specific binding
  information for ECMAScript is included in this specification.</p>

  <p class="big-issue">The current situation with IDL blocks is
  pitiful. IDL is totally inadequate to properly represent what
  objects have to look like in JS; IDL can't say if a member is
  enumerable, what the indexing behaviour is, what the stringification
  behaviour is, what behaviour setting a member whose type is a
  particular interface should be (e.g. setting of document.location or
  element.className), what constructor an object implementing an
  interface should claim to have, how overloads work, etc. I think we
  should make the IDL blocks non-normative, and/or replace them with
  something else that is better for JS while still being clear on how
  it applies to other languages. However, we do need to have something
  that says what types the methods take as arguments, since we have to
  raise exceptions if they are wrong.</p>

  <p>The construction "a <code>Foo</code> object", where
  <code>Foo</code> is actually an interface, is sometimes used instead
  of the more accurate "an object implementing the interface
  <code>Foo</code>".</p>

  <p>A DOM attribute is said to be <em>getting</em> when its value is
  being retrieved (e.g. by author script), and is said to be
  <em>setting</em> when a new value is assigned to it.</p>

  <p>If a DOM object is said to be <dfn>live</dfn>, then that means
  that any attributes returning that object must always return the
  same object (not a new object each time), and the attributes and
  methods on that object must operate on the actual underlying data,
  not a snapshot of the data.</p>

  <!-- XXX should define "same instance of" to mean JS===. -->

  <p>The terms <em>fire</em> and <em>dispatch</em> are used
  interchangeably in the context of events, as in the DOM Events
  specifications. <a href="#refsDOM3EVENTS">[DOM3EVENTS]</a></p>

  <p>The term <dfn>text node</dfn> refers to any <code>Text</code>
  node, including <code>CDATASection</code> nodes (any
  <code>Node</code> with node type 3 or 4).</p>

  <p>Some of the algorithms in this specification, for historical
  reasons, require the user agent to <dfn>pause</dfn> until some
  condition has been met. While a user agent is paused, it must ensure
  that no scripts execute (e.g. no event handlers, no timers,
  etc). User agents should remain responsive to user input while
  paused, however.</p>


  <h4>HTML vs XHTML</h4>

  <p><em>This section is non-normative.</em></p>

  <p>This specification defines an abstract language for describing
  documents and applications, and some APIs for interacting with
  in-memory representations of resources that use this language.</p>

  <p>The in-memory representation is known as "DOM5 HTML", or "the
  DOM" for short.</p>

  <p>There are various concrete syntaxes that can be used to transmit
  resources that use this abstract language, two of which are defined
  in this specification.</p>

  <p>The first such concrete syntax is "HTML5". This is the format
  recommended for most authors. It is compatible with all legacy Web
  browsers. If a document is transmitted with the MIME type <code
  title="">text/html</code>, then it will be processed as an "HTML5"
  document by Web browsers.</p>

  <p>The second concrete syntax uses XML, and is known as
  "XHTML5". When a document is transmitted with an XML MIME type, such
  as <code title="">application/xhtml+xml</code>, then it is processed
  by an XML processor by Web browsers, and treated as an "XHTML5"
  document. Generally speaking, authors are discouraged from trying to
  use XML on the Web, because XML has much stricter syntax rules than
  the "HTML5" variant described above, and is relatively newer and
  therefore less mature.</p>

  <p>The "DOM5 HTML", "HTML5", and "XHTML5" representations cannot all
  represent the same content. For example, namespaces cannot be
  represented using "HTML5", but they are supported in "DOM5 HTML" and
  "XHTML5". Similarly, documents that use the <code>noscript</code>
  feature can be represented using "HTML5", but cannot be represented
  with "XHTML5" and "DOM5 HTML". Comments that contain the string
  "<code title="">--&gt;</code>" can be represented in "DOM5 HTML" but
  not in "HTML5" and "XHTML5". And so forth.</p>


  <h2 id="dom">The Document Object Model</h2>

  <p>The Document Object Model (DOM) is a representation &mdash; a
  model &mdash; of a document and its content. <a
  href="#refsDOM3CORE">[DOM3CORE]</a> The DOM is not just an API; the
  conformance criteria of HTML implementations are defined, in this
  specification, in terms of operations on the DOM.</p>

  <p>This specification defines the language represented in the DOM by
  features together called DOM5 HTML. DOM5 HTML consists of DOM Core
  <code>Document</code> nodes and DOM Core <code>Element</code> nodes,
  along with text nodes and other content.</p>

  <p>Elements in the DOM represent things; that is, they have
  intrinsic <em>meaning</em>, also known as semantics.</p>

  <p class="example">For example, a <code>p</code> element represents
  a paragraph.</p>

  <p>In addition, documents and elements in the DOM host APIs that
  extend the DOM Core APIs, providing new features to application
  developers using DOM5 HTML.</p>


  <h3>Documents</h3>

  <p>Every XML and HTML document in an HTML UA is represented by a
  <code>Document</code> object. <a
  href="#refsDOM3CORE">[DOM3CORE]</a></p>

  <p><code>Document</code> objects are assumed to be <dfn>XML
  documents</dfn> unless they are flagged as being <dfn>HTML
  documents</dfn> when they are created. Whether a document is an
  <span title="HTML documents">HTML document</span> or an <span
  title="XML documents">XML document</span> affects the behaviour of
  certain APIs, as well as a few CSS rendering rules. <a
  href="#refsCSS21">[CSS21]</a></p>

  <p class="note">A <code>Document</code> object created by the <code
  title="">createDocument()</code> API on the
  <code>DOMImplementation</code> object is initially an <span
  title="XML documents">XML document</span>, but can be made into an
  <span title="HTML documents">HTML document</span> by calling <code
  title="dom-document-open">document.open()</code> on it.</p>

  <p>All <code>Document</code> objects (in user agents implementing
  this specification) must also implement the
  <code>HTMLDocument</code> interface, available using
  binding-specific methods. (This is the case whether or not the
  document in question is an <span title="HTML documents">HTML
  document</span> or indeed whether it contains any <span>HTML
  elements</span> at all.) <code>Document</code> objects must also
  implement the document-level interface of any other namespaces found
  in the document that the UA supports. For example, if an HTML
  implementation also supports SVG, then the <code>Document</code>
  object must implement <code>HTMLDocument</code> and
  <code>SVGDocument</code>.</p>

  <p class="note">Because the <code>HTMLDocument</code> interface is
  now obtained using binding-specific casting methods instead of
  simply being the primary interface of the document object, it is no
  longer defined as inheriting from <code>Document</code>.</p>

  <pre class="idl">interface <dfn>HTMLDocument</dfn> {
  // <span>Resource metadata management</span>
  readonly attribute Location <span title="dom-document-location">location</span>;
  readonly attribute DOMString <span title="dom-document-URL">URL</span>;
           attribute DOMString <span title="dom-document-domain">domain</span>;
  readonly attribute DOMString <span title="dom-document-referrer">referrer</span>;
           attribute DOMString <span title="dom-document-cookie">cookie</span>;

  // <span>DOM tree accessors</span>
           attribute DOMString <span title="dom-document-title">title</span>;
           attribute <span>HTMLElement</span> <span title="dom-document-body">body</span>;
  readonly attribute <span>HTMLCollection</span> <span title="dom-document-images">images</span>;
<!--  readonly attribute <span>HTMLCollection</span> <span title="dom-document-applets">applets</span>;
-->  readonly attribute <span>HTMLCollection</span> <span title="dom-document-links">links</span>;
  readonly attribute <span>HTMLCollection</span> <span title="dom-document-forms">forms</span>;
  readonly attribute <span>HTMLCollection</span> <span title="dom-document-anchors">anchors</span>;
  NodeList <span title="dom-document-getElementsByName">getElementsByName</span>(in DOMString elementName);
  NodeList <span title="dom-document-getElementsByClassName">getElementsByClassName</span>(in DOMString[] classNames);

  // <span>Dynamic markup insertion</span>
           attribute DOMString <span title="dom-innerHTML">innerHTML</span>;
  void <span title="dom-document-open">open</span>();
  void <span title="dom-document-open">open</span>(in DOMString type);
  void <span title="dom-document-open">open</span>(in DOMString type, in DOMString replace);
  void <span title="dom-document-open">open</span>(in DOMString url, in DOMString name, in DOMString features);
  void <span title="dom-document-open">open</span>(in DOMString url, in DOMString name, in DOMString features, in bool replace);
  void <span title="dom-document-close">close</span>();
  void <span title="dom-document-write">write</span>(in DOMString text);
  void <span title="dom-document-writeln">writeln</span>(in DOMString text);

  // <span>Interaction</span>
  readonly attribute <span>Element</span> <span title="dom-document-activeElement">activeElement</span>;
  readonly attribute boolean <span title="dom-document-hasFocus">hasFocus</span>;

  // <span title="concept-command">Commands</span>
  readonly attribute <span>HTMLCollection</span> <span title="dom-document-commands">commands</span>;

  // <span>Editing</span>
           attribute boolean <span title="dom-document-designMode">designMode</span>;
  boolean <span title="dom-document-execCommand">execCommand</span>(in DOMString commandID);
  boolean <span title="dom-document-execCommand">execCommand</span>(in DOMString commandID, in boolean doShowUI);
  boolean <span title="dom-document-execCommand">execCommand</span>(in DOMString commandID, in boolean doShowUI, in DOMString value);
  <span>Selection</span> <span title="dom-document-getSelection">getSelection</span>();

  // <span>Cross-document messaging</span>
  void <span title="dom-document-postMessage">postMessage</span>(in DOMString message);
<!-- XXX we're not done here.
     XXX see e.g. http://lxr.mozilla.org/seamonkey/source/dom/public/idl/html/nsIDOMNSHTMLDocument.idl 
     XXX see e.g. http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/dom/Document.cpp 
     XXX see e.g. http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/html/HTMLDocument.cpp
  -->
};</pre>

  <p class="note">This specification requires that implementations
  also implement some version of the Window object specification, so
  all <code>HTMLDocument</code> objects also implement the
  <code>DocumentWindow</code> object and thus the
  <code>DocumentView</code> object.</p>

  <p>Since the <code>HTMLDocument</code> interface holds methods and
  attributes related to a number of disparate features, the members of
  this interface are described in various different sections.</p>



  <h4><dfn>Resource metadata management</dfn></h4>

  <p>The <dfn title="dom-document-URL"><code>URL</code></dfn>
  attribute must return <span>the document's address</span><!-- XXX
  xref -->.</p>


  <p>The <dfn title="dom-document-domain"><code>domain</code></dfn>
  attribute must be initialised to <span>the document's
  domain</span><!-- XXX xref --> upon the creation of the
  <code>Document</code> object. On getting, the attribute must return
  its current value. On setting, if the new value is an allowed value
  (as defined below), the attribute's value must be changed to the new
  value. If the new value is not an allowed value, then a
  <span>security exception</span> must be raised instead.</p>

  <p>A new value is an allowed value for the <code
  title="dom-document-domain">document.domain</code> attribute if it
  is equal to the attribute's current value, or if the new value,
  prefixed by a U+002E FULL STOP ("."), exactly matches the end of the
  current value.</p>

  <p class="note">The <code title="dom-document-domain">domain</code>
  attribute is used to enable pages on different hosts of a domain to
  access each others' DOMs.</p><!-- XXX xref -->

  <!--XXX
    http://lxr.mozilla.org/seamonkey/source/content/html/document/src/nsHTMLDocument.cpp
    search for ::GetDomain ::SetDomain
    http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/dom/Document.cpp
    search for ::domain ::setDomain
  -->


  <p>The <dfn
  title="dom-document-referrer"><code>referrer</code></dfn> attribute
  must return either the URI of the page which navigated<!-- xref XXX
  --> the <span>browsing context</span> to the current document (if
  any), or the empty string (if there is no such originating page, or
  if the UA has been configured not to report referrers).</p>

  <p class="note">In the case of HTTP, the <code
  title="dom-document-referrer">referrer</code> DOM attribute will
  match the <code>Referer</code> (sic) header that was sent when
  fetching the current page.</p>


  <p>The <dfn title="dom-document-cookie"><code>cookie</code></dfn>
  attribute must, on getting, return the same string as the value of
  the <code title="">Cookie</code> HTTP header it would include if
  fetching the resource indicated by the <span>document's
  address</span> over HTTP, as per RFC 2109 section 4.3.4. <a
  href="#refsRFC2109">[RFC2109]</a></p>

  <p>On setting, the <code title="dom-document-cookie">cookie</code>
  attribute must cause the user agent to act as it would when
  processing cookies if it had just attempted to fetch the
  <span>document's address</span> over HTTP, and had received a
  response with a <code>Set-Cookie</code> header whose value was the
  specified value, as per RFC 2109 sections 4.3.1, 4.3.2, and
  4.3.3. <a href="#refsRFC2109">[RFC2109]</a></p>



  <h3>Elements</h3>

  <p>The nodes representing <span>HTML elements</span> in the DOM must
  implement, and expose to scripts, the interfaces listed for them in
  the relevant sections of this specification. This includes
  <span>XHTML</span> elements in <span>XML documents</span>, even when
  those documents are in another context (e.g. inside an XSLT
  transform).</p>

  <p>The basic interface, from which all the <span>HTML
  elements</span>' interfaces inherit, and which must be used by
  elements that have no additional requirements, is the
  <code>HTMLElement</code> interface.</p>

  <pre class="idl">interface <dfn>HTMLElement</dfn> : <span>Element</span> {
  // <span>DOM tree accessors</span>
  NodeList <span title="dom-getElementsByClassName">getElementsByClassName</span>(in DOMString[] classNames);

  // <span>Dynamic markup insertion</span>
           attribute DOMString <span title="dom-innerHTML">innerHTML</span>;

  // <span>Metadata attributes</span>
           attribute DOMString <span title="dom-id">id</span>;
           attribute DOMString <span title="dom-title">title</span>;
           attribute DOMString <span title="dom-lang">lang</span>;
           attribute DOMString <span title="dom-dir">dir</span>;
           attribute <span>DOMString</span> <span title="dom-className">className</span>;
  readonly attribute <span>DOMTokenList</span> <span title="dom-classList">classList</span>;

  // <span>Interaction</span>
           attribute long <span title="dom-tabindex">tabindex</span>;
  void <span title="dom-click">click</span>();
  void <span title="dom-focus">focus</span>();
  void <span title="dom-blur">blur</span>();

  // <span title="concept-command">Commands</span>
           attribute <span>HTMLMenuElement</span> <span title="dom-contextMenu">contextMenu</span>;

  // <span>Editing</span>
           attribute boolean <span title="dom-draggable">draggable</span>;
           attribute DOMString <span title="dom-contenteditable">contenteditable</span>;

  // <span>event handler DOM attributes</span>
           attribute <span>EventListener</span> <span title="handler-onabort">onabort</span>;
           attribute <span>EventListener</span> <span title="handler-onbeforeunload">onbeforeunload</span>;
           attribute <span>EventListener</span> <span title="handler-onblur">onblur</span>;
           attribute <span>EventListener</span> <span title="handler-onchange">onchange</span>;
           attribute <span>EventListener</span> <span title="handler-onclick">onclick</span>;
           attribute <span>EventListener</span> <span title="handler-oncontextmenu">oncontextmenu</span>;
           attribute <span>EventListener</span> <span title="handler-ondblclick">ondblclick</span>;
           attribute <span>EventListener</span> <span title="handler-ondrag">ondrag</span>;
           attribute <span>EventListener</span> <span title="handler-ondragend">ondragend</span>;
           attribute <span>EventListener</span> <span title="handler-ondragenter">ondragenter</span>;
           attribute <span>EventListener</span> <span title="handler-ondragleave">ondragleave</span>;
           attribute <span>EventListener</span> <span title="handler-ondragover">ondragover</span>;
           attribute <span>EventListener</span> <span title="handler-ondragstart">ondragstart</span>;
           attribute <span>EventListener</span> <span title="handler-ondrop">ondrop</span>;
           attribute <span>EventListener</span> <span title="handler-onerror">onerror</span>;
           attribute <span>EventListener</span> <span title="handler-onfocus">onfocus</span>;
           attribute <span>EventListener</span> <span title="handler-onkeydown">onkeydown</span>;
           attribute <span>EventListener</span> <span title="handler-onkeypress">onkeypress</span>;
           attribute <span>EventListener</span> <span title="handler-onkeyup">onkeyup</span>;
           attribute <span>EventListener</span> <span title="handler-onload">onload</span>;
           attribute <span>EventListener</span> <span title="handler-onmessage">onmessage</span>;
           attribute <span>EventListener</span> <span title="handler-onmousedown">onmousedown</span>;
           attribute <span>EventListener</span> <span title="handler-onmousemove">onmousemove</span>;
           attribute <span>EventListener</span> <span title="handler-onmouseout">onmouseout</span>;
           attribute <span>EventListener</span> <span title="handler-onmouseover">onmouseover</span>;
           attribute <span>EventListener</span> <span title="handler-onmouseup">onmouseup</span>;
           attribute <span>EventListener</span> <span title="handler-onmousewheel">onmousewheel</span>;
           attribute <span>EventListener</span> <span title="handler-onresize">onresize</span>;
           attribute <span>EventListener</span> <span title="handler-onscroll">onscroll</span>;
           attribute <span>EventListener</span> <span title="handler-onselect">onselect</span>;
           attribute <span>EventListener</span> <span title="handler-onsubmit">onsubmit</span>;
           attribute <span>EventListener</span> <span title="handler-onunload">onunload</span>;

};</pre>

  <p>As with the <code>HTMLDocument</code> interface, the
  <code>HTMLElement</code> interface holds methods and attributes
  related to a number of disparate features, and the members of this
  interface are therefore described in various different sections of
  this specification.</p>


  <h4>Reflecting content attributes in DOM attributes</h4>

  <p>Some <span title="DOM attribute">DOM attributes</span> are
  defined to <dfn>reflect</dfn> a particular <span>content
  attribute</span>. This means that on getting, the DOM attribute
  returns the current value of the content attribute, and on setting,
  the DOM attribute changes the value of the content attribute to the
  given value.</p>

  <p>If a reflecting DOM attribute is a <code>DOMString</code>
  attribute defined to contain a URI, then on getting, the DOM
  attribute must return the value of the content attribute, resolved
  to an absolute URI, and on setting, must set the content attribute
  to the specified literal value. If the content attribute is absent,
  the DOM attribute must return the default value, if the content
  attribute has one, or else the empty string.</p>

  <p>If a reflecting DOM attribute is a <code>DOMString</code>
  attribute that is not defined to contain a URI, then the getting and
  setting must be done in a transparent, case-sensitive manner, except
  if the content attribute is defined to only allow a specific set of
  values. In this latter case, the attribute's value must first be
  <span>converted to lowercase</span><!--XXX xref --> before being
  returned. If the content attribute is absent, the DOM attribute must
  return the default value, if the content attribute has one, or else
  the empty string.</p>

  <p>If a reflecting DOM attribute is a boolean attribute, then the
  DOM attribute must return true if the attribute is set, and false if
  it is absent. On setting, the content attribute must be removed if
  the DOM attribute is set to false, and must be set to have the same
  value as its name if the DOM attribute is set to true. (This
  corresponds to the rules for <span title="boolean attribute">boolean
  content attributes</span>.)</p>

  <p>If a reflecting DOM attribute is a signed integer type
  (<code>long</code>) then the content attribute must be parsed
  according to <span title="rules for parsing integers">the rules for
  parsing signed integers</span> first. If that fails, or if the
  attribute is absent, the default value must be returned instead, or
  0 if there is no default value. On setting, the given value must be
  converted to a string representing the number as a <span>valid
  integer</span> in base ten and then that string must be used as the
  new content attribute value.</p>

  <p>If a reflecting DOM attribute is an <em>unsigned</em> integer
  type (<code>unsigned long</code>) then the content attribute must be
  parsed according to <span title="rules for parsing non-negative
  integers">the rules for parsing unsigned integers</span> first. If
  that fails, or if the attribute is absent, the default value must be
  returned instead, or 0 if there is no default value. On setting, the
  given value must be converted to a string representing the number as
  a <span>valid non-negative integer</span> in base ten and then that
  string must be used as the new content attribute value.</p>

  <p>If a reflecting DOM attribute is of the type
  <code>DOMTokenList</code>, then on getting it must return a
  <code>DOMTokenList</code> object whose underlying string is the
  element's corresponding content attribute. When the
  <code>DOMTokenList</code> object mutates its underlying string, the
  attribute must itself be immediately mutated. When the attribute is
  absent, then the string represented by the <code>DOMTokenList</code>
  object is the empty string; when the object mutates this empty
  string, the user agent must first add the corresponding content
  attribute, and then mutate that attribute
  instead. <code>DOMTokenList</code> attributes are always
  read-only. The same <code>DOMTokenList</code> object must be
  returned every time for each attribute.</p>

  <p>If a reflecting DOM attribute has the type
  <code>HTMLElement</code>, or an interface that descends from
  <code>HTMLElement</code>, then, on getting, it must run the
  following algorithm (stopping at the first point where a value is
  returned):

  <ol>

   <li>If the corresponding content attribute is absent, then the
   DOM attribute must return null.</li>

   <li>Let <var title="">candidate</var> be the element that the <code
   title="">document.getElementById()</code> method would find if it
   was passed as its argument the current value of the corresponding
   content attribute.</li>

   <li>If <var title="">candidate</var> is null, or if it is not
   type-compatible with the DOM attribute, then the DOM attribute must
   return null.</li>

   <li>Otherwise, it must return <var title="">candidate</var>.</li>

  </ol>

  <p>On setting, if the given element has an <code
  title="attr-id">id</code> attribute, then the content attribute must
  be set to the value of that <code title="attr-id">id</code>
  attribute. Otherwise, the DOM attribute must be set to the empty
  string.</p><!-- XXX or raise an exception? -->




  <h3>Common DOM interfaces</h3>

  <h4>Collections</h4>

  <p>The <code>HTMLCollection</code>,
  <code>HTMLFormControlsCollection</code>, and
  <code>HTMLOptionsCollection</code> interfaces represent various
  lists of DOM nodes. Collectively, objects implementing these
  interfaces are called <dfn>collections</dfn>.</p>

  <p>When a <span title="collections">collection</span> is created, a
  filter and a root are associated with the collection.</p>

  <p class="example">For example, when the <code>HTMLCollection</code>
  object for the <code
  title="dom-document-images">document.images</code> attribute is
  created, it is associated with a filter that selects only
  <code>img</code> elements, and rooted at the root of the
  document.</p>

  <p>The <span>collection</span> then <dfn title="representated by the
  collection">represents</dfn> a <span>live</span> view of the subtree
  rooted at the collection's root, containing only nodes that match
  the given filter. The view is linear. In the absence of specific
  requirements to the contrary, the nodes within the collection must
  be sorted in <span>tree order</span>.</p>

  <p class="note">The <code title="dom-table-rows">rows</code> list is
  not in tree order.</p>

  <p>An attribute that returns a collection must return the same
  object every time it is retrieved.</p>


  <h5>HTMLCollection</h5>

  <p>The <code>HTMLCollection</code> interface represents a generic
  <span>collection</span> of elements.</p>

  <pre class="idl">interface <dfn>HTMLCollection</dfn> {
  readonly attribute unsigned long <span title="dom-HTMLCollection-length">length</span>;
  Element <span title="dom-HTMLCollection-item">item</span>(in unsigned long index);
  Element <span title="dom-HTMLCollection-namedItem">namedItem</span>(in DOMString name);
};</pre>

  <p>The <dfn
  title="dom-HTMLCollection-length"><code>length</code></dfn>
  attribute must return the number of nodes <span>represented by the
  collection</span>.</p>

  <p>The <dfn title="dom-HTMLCollection-item"><code>item(<var
  title="">index</var>)</code></dfn> method must return the <var
  title="">index</var>th node in the collection. If there is no <var
  title="">index</var>th node in the collection, then the method must
  return null.</p>

  <p>The <dfn
  title="dom-HTMLCollection-namedItem"><code>namedItem(<var
  title="">key</var>)</code></dfn> method must return the first node
  in the collection that matches the following requirements:</p>

  <ul>

   <li>It is an <code>a</code>, <code>applet</code>,
   <code>area</code>, <code>form</code>, <code>img</code>, or
   <code>object</code> element with a <code
   title="attr-name">name</code> attribute equal to <var
   title="">key</var>, or,</li>

   <li>It is an HTML element of any kind with an <code
   title="attr-id">id</code> attribute equal to <var
   title="">key</var>. (Non-HTML elements, even if they have IDs, are
   not searched for the purposes of <code
   title="dom-HTMLCollection-namedItem">namedItem()</code>.)</li>

  </ul>

  <p>If no such elements are found, then the method must return
  null.</p>

  <p>In the ECMAScript DOM binding, objects implementing the
  <code>HTMLCollection</code> interface must support being
  dereferenced using the square bracket notation, such that
  dereferencing with an integer index is equivalent to invoking the
  <code title="dom-HTMLCollection-item">item()</code> method with that
  index, and such that dereferencing with a string index is equivalent
  to invoking the <code
  title="dom-HTMLCollection-namedItem">namedItem()</code> method with
  that index.</p>



  <h5>HTMLFormControlsCollection</h5>

  <p>The <code>HTMLFormControlsCollection</code> interface represents
  a <span>collection</span> of form controls.</p>

  <pre class="idl">interface <dfn>HTMLFormControlsCollection</dfn> {
  readonly attribute unsigned long <span title="dom-HTMLFormControlsCollection-length">length</span>;
  <span>HTMLElement</span> <span title="dom-HTMLFormControlsCollection-item">item</span>(in unsigned long index);
  Object <span title="dom-HTMLFormControlsCollection-namedItem">namedItem</span>(in DOMString name);
};</pre>

  <p>The <dfn
  title="dom-HTMLFormControlsCollection-length"><code>length</code></dfn>
  attribute must return the number of nodes <span>represented by the
  collection</span>.</p>

  <p>The <dfn
  title="dom-HTMLFormControlsCollection-item"><code>item(<var
  title="">index</var>)</code></dfn> method must return the <var
  title="">index</var>th node in the collection. If there is no <var
  title="">index</var>th node in the collection, then the method must
  return null.</p>

  <p>The <dfn
  title="dom-HTMLFormControlsCollection-namedItem"><code>namedItem(<var title="">key</var>)</code></dfn>
  method must act according to the following algorithm:

  <ol>

   <li>If, at the time the method is called, there is exactly one node
   in the collection that has either an <code
   title="attr-id">id</code> attribute or a <code
   title="attr-name">name</code> attribute equal to <var title="">key</var>,
   then return that node and stop the algorithm.</li>

   <li>Otherwise, if there are no nodes in the collection that have
   either an <code title="attr-id">id</code> attribute or a <code
   title="attr-name">name</code> attribute equal to <var
   title="">key</var>, then return null and stop the algorithm.</li>

   <li>Otherwise, create a <code>NodeList</code> object representing a
   live view of the <code>HTMLFormControlsCollection</code> object,
   further filtered so that the only nodes in the
   <code>NodeList</code> object are those that have either an <code
   title="attr-id">id</code> attribute or a <code
   title="attr-name">name</code> attribute equal to <var
   title="">key</var>. The nodes in the <code>NodeList</code> object
   must be sorted in <span>tree order</span>.</li>

   <li>Return that <code>NodeList</code> object.</li>

  </ol>

  <p>In the ECMAScript DOM binding, objects implementing the
  <code>HTMLFormControlsCollection</code> interface must support being
  dereferenced using the square bracket notation, such that
  dereferencing with an integer index is equivalent to invoking the
  <code title="dom-HTMLFormControlsCollection-item">item()</code>
  method with that index, and such that dereferencing with a string
  index is equivalent to invoking the <code
  title="dom-HTMLFormControlsCollection-namedItem">namedItem()</code>
  method with that index.</p>


<!--
http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E...%0A%3Cform%20name%3D%22a%22%3E%3Cinput%20id%3D%22x%22%20name%3D%22y%22%3E%3Cinput%20name%3D%22x%22%20id%3D%22y%22%3E%3C/form%3E%0A%3Cscript%3E%0A%20%20var%20x%3B%0A%20%20w%28x%20%3D%20document.forms%5B%27a%27%5D%5B%27x%27%5D%29%3B%0A%20%20w%28x.length%29%3B%0A%20%20x%5B0%5D.parentNode.removeChild%28x%5B0%5D%29%3B%0A%20%20w%28x.length%29%3B%0A%20%20w%28x%20%3D%3D%20document.forms%5B%27a%27%5D%5B%27x%27%5D%29%3B%0A%3C/script%3E%0A
-->


  <h5>HTMLOptionsCollection</h5>

  <p>The <code>HTMLOptionsCollection</code> interface represents
  a list of <code>option</code> elements.</p>

  <pre class="idl">interface <dfn>HTMLOptionsCollection</dfn> {
           attribute unsigned long <span title="dom-HTMLOptionsCollection-length">length</span>;
  HTMLOptionElement <span title="dom-HTMLOptionsCollection-item">item</span>(in unsigned long index);
  Object <span title="dom-HTMLOptionsCollection-namedItem">namedItem</span>(in DOMString name);
};</pre>

  <p>On getting, the <dfn
  title="dom-HTMLOptionsCollection-length"><code>length</code></dfn>
  attribute must return the number of nodes <span>represented by the
  collection</span>.</p>

  <p>On setting, the behaviour depends on whether the new value is
  equal to, greater than, or less than the number of nodes
  <span>represented by the collection</span> at that time. If the
  number is the same, then setting the attribute must do nothing. If
  the new value is greater, then <var title="">n</var> new
  <code>option</code> elements with no attributes and no child nodes
  must be appended to the <code>select</code> element on which the
  <code>HTMLOptionsCollection</code> is rooted, where <var
  title="">n</var> is the difference between the two numbers (new
  value minus old value). If the new value is lower, then the last
  <var title="">n</var> nodes in the collection must be removed from
  their parent nodes, where <var title="">n</var> is the difference
  between the two numbers (old value minus new value).</p>

  <p class="note">Setting <code
  title="dom-HTMLOptionsCollection-length">length</code> never removes
  or adds any <code>optgroup</code> elements, and never adds new
  children to existing <code>optgroup</code> elements (though it can
  remove children from them).</p>

  <p>The <dfn title="dom-HTMLOptionsCollection-item"><code>item(<var
  title="">index</var>)</code></dfn> method must return the <var
  title="">index</var>th node in the collection. If there is no <var
  title="">index</var>th node in the collection, then the method must
  return null.</p>

  <p>The <dfn
  title="dom-HTMLOptionsCollection-namedItem"><code>namedItem(<var title="">key</var>)</code></dfn>
  method must act according to the following algorithm:

  <ol>

   <li>If, at the time the method is called, there is exactly one node
   in the collection that has either an <code
   title="attr-id">id</code> attribute or a <code
   title="attr-name">name</code> attribute equal to <var
   title="">key</var>, then return that node and stop the
   algorithm.</li>

   <li>Otherwise, if there are no nodes in the collection that have
   either an <code title="attr-id">id</code> attribute or a <code
   title="attr-name">name</code> attribute equal to <var
   title="">key</var>, then return null and stop the algorithm.</li>

   <li>Otherwise, create a <code>NodeList</code> object representing a
   live view of the <code>HTMLOptionsCollection</code> object, further
   filtered so that the only nodes in the <code>NodeList</code> object
   are those that have either an <code title="attr-id">id</code>
   attribute or a <code title="attr-option-name">name</code> attribute
   equal to <var title="">key</var>. The nodes in the
   <code>NodeList</code> object must be sorted in <span>tree
   order</span>.</li>

   <li>Return that <code>NodeList</code> object.</li>

  </ol>

  <p>In the ECMAScript DOM binding, objects implementing the
  <code>HTMLOptionsCollection</code> interface must support being
  dereferenced using the square bracket notation, such that
  dereferencing with an integer index is equivalent to invoking the
  <code title="dom-HTMLOptionsCollection-item">item()</code>
  method with that index, and such that dereferencing with a string
  index is equivalent to invoking the <code
  title="dom-HTMLOptionsCollection-namedItem">namedItem()</code>
  method with that index.</p>

  <!-- see also http://ln.hixie.ch/?start=1161042744&count=1 -->

  <p class="big-issue">We may want to add <code>add()</code> and
  <code>remove()</code> methods here too because IE implements
  HTMLSelectElement and HTMLOptionsCollection on the same object, and
  so people use them almost interchangeably in the wild.</p>


  <h4>DOMTokenList</h4>

  <p>The <code>DOMTokenList</code> interface represents an interface
  to an underlying string that consists of an <span>unordered set of
  space-separated tokens</span>.</p>

  <p>Which string underlies a particular <code>DOMTokenList</code>
  object is defined when the object is created. It might be a content
  attribute (e.g. the string that underlies the <code
  title="dom-classList">classList</code> object is the <code
  title="attr-class">class</code> attribute), or it might be an
  anonymous string (e.g. when a <code>DOMTokenList</code> object is
  passed to an author-implemented callback in the
  <code>datagrid</code> APIs).</p>

  <pre class="idl">interface <dfn>DOMTokenList</dfn> {
  boolean <span title="dom-tokenlist-has">has</span>(in DOMString token);
  void <span title="dom-tokenlist-add">add</span>(in DOMString token);
  void <span title="dom-tokenlist-remove">remove</span>(in DOMString token);
};</pre>

  <p>The <dfn title="dom-tokenlist-has"><code>has(<var
  title="">token</var>)</code></dfn> method must run the following
  algorithm:</p>

  <ol>

   <li>If the <var title="">token</var> argument contains any
   spaces<!-- XXX elaborate -->, then raise an
   <code>INVALID_CHARACTER_ERR</code> exception and stop the
   algorithm.</li>

   <li>Otherwise, <span title="split a string on spaces">split the
   underlying string on spaces</span> to get the list of tokens in the
   object's underlying string.</li>

   <li>If the token indicated by <var title="">token</var> is one of
   the tokens in the object's underlying string then return true and
   stop this algorithm.</li>

   <li>Otherwise, return false.</li>

  </ol>

  <p>The <dfn title="dom-tokenlist-add"><code>add(<var
  title="">token</var>)</code></dfn> method must run the following
  algorithm:</p>

  <ol>

   <li>If the <var title="">token</var> argument contains any
   spaces<!-- XXX elaborate -->, then raise an
   <code>INVALID_CHARACTER_ERR</code> exception and stop the
   algorithm.</li>

   <li>Otherwise, <span title="split a string on spaces">split the
   underlying string on spaces</span> to get the list of tokens in the
   object's underlying string.</li>

   <li>If the given <var title="">token</var> is already one of the
   tokens in the <code>DOMTokenList</code> object's underlying string
   then stop the algorithm.</li>

   <li>Otherwise, if the last character of the
   <code>DOMTokenList</code> object's underlying string is not a
   <span>space character</span>, then append a U+0020 SPACE character
   to the end of that string.</li>

   <li>Append the value of <var title="">token</var> to the end of the
   <code>DOMTokenList</code> object's underlying string.</li>

  </ol>

  <p>The <dfn title="dom-tokenlist-add"><code>remove(<var
  title="">token</var>)</code></dfn> method must run the following
  algorithm:</p>

  <ol>

   <li>If the <var title="">token</var> argument contains any <span
   title="space character">spaces</span>, then raise an
   <code>INVALID_CHARACTER_ERR</code> exception and stop the
   algorithm.</li>

   <li>Otherwise, <span title="remove a token from a string">remove
   the given <var title="">token</var> from the underlying
   string</span>.</li>

  </ol>

  <p>In the ECMAScript DOM binding, objects implementing the
  <code>DOMTokenList</code> interface must stringify to the object's
  underlying string representation.</p>


  <h4>DOM feature strings</h4>

  <p>DOM3 Core defines mechanisms for checking for interface support,
  and for obtaining implementations of interfaces, using <a
  href="http://www.w3.org/TR/DOM-Level-3-Core/core.html#DOMFeatures">feature
  strings</a>. <a href="#refsDOM3CORE">[DOM3CORE]</a></p>

  <p>A DOM application can use the <dfn
  title="hasFeature"><code>hasFeature(<var title="">feature</var>,
  <var title="">version</var>)</code></dfn> method of the
  <code>DOMImplementation</code> interface with parameter values
  "<code title="">HTML</code>" and "<code>5.0</code>" (respectively)
  to determine whether or not this module is supported by the
  implementation. In addition to the feature string "<code
  title="">HTML</code>", the feature string "<code
  title="">XHTML</code>" (with version string "<code>5.0</code>") can
  be used to check if the implementation supports XHTML. User agents
  should respond with a true value when the <code>hasFeature</code>
  method is queried with these values. Authors are cautioned, however,
  that UAs returning true might not be perfectly compliant, and that
  UAs returning false might well have support for features in this
  specification; in general, therefore, use of this method is
  discouraged.</p>

  <p>The values "<code title="">HTML</code>" and "<code
  title="">XHTML</code>" (both with version "<code>5.0</code>") should
  also be supported in the context of the <code>getFeature()</code>
  and <code>isSupported()</code> methods, as defined by DOM3 Core.</p>

  <p class="note">The interfaces defined in this specification are not
  always supersets of the interfaces defined in DOM2 HTML; some
  features that were formerly deprecated, poorly supported, rarely
  used or considered unnecessary have been removed. Therefore it is
  not guarenteed that an implementation that supports "<code
  title="">HTML</code>" "<code>5.0</code>" also supports "<code
  title="">HTML</code>" "<code>2.0</code>".</p>




  <h3><dfn>DOM tree accessors</dfn></h3>

  <p><dfn>The <code>html</code> element</dfn> of a document is the
  document's root element, if there is one and it's an
  <code>html</code> element, or null otherwise.</p>

  <p><dfn>The <code>head</code> element</dfn> of a document is the
  first <code>head</code> element that is a child of <span>the
  <code>html</code> element</span>, if there is one, or null
  otherwise.</p>

  <p><dfn>The <code>title</code> element</dfn> of a document is the
  first <code>title</code> element that is a child of <span>the
  <code>head</code> element</span>, if there is one, or null
  otherwise.</p>

  <p>The <dfn id="document.title"
  title="dom-document-title"><code>title</code></dfn> attribute must,
  on getting, return a concatenation of the data of all the child
  <span title="text node">text nodes</span> of <span>the
  <code>title</code> element</span>, in tree order, or the empty
  string if <span>the <code>title</code> element</span> is null.</p>


  <p>On setting, the following algorithm must be run:</p>

  <ol>

   <li>If <span>the <code>head</code> element</span> is null, then the
   attribute must do nothing. Stop the algorithm here.</li>

   <li>If <span>the <code>title</code> element</span> is null, then a
   new <code>title</code> element must be created and appended to
   <span>the <code>head</code> element</span>.</li>

   <li>The children of <span>the <code>title</code> element</span> (if
   any) must all be removed.</li>

   <li>A single <code>Text</code> node whose data is the new value
   being assigned must be appended to <span>the <code>title</code>
   element</span>.</li>

  </ol>

  <p><dfn>The body element</dfn> of a document is the first child of
  <span>the <code>html</code> element</span> that is either a
  <code>body</code> element or a <code>frameset</code> element. If
  there is no such element, it is null. If the body element is null,
  then when the specification requires that events be fired at "the
  body element", they must instead be fired at the
  <code>Document</code> object.</p>

  <p>The <dfn title="dom-document-body"><code>body</code></dfn>
  attribute, on getting, must return <span>the body element</span> of
  the document (either a <code>body</code> element, a
  <code>frameset</code> element, or null). On setting, the following
  algorithm must be followed:</p>

  <ol>

   <li>If the new value is not a <code>body</code> or
   <code>frameset</code> element, then raise a
   <code>HIERARCHY_REQUEST_ERR</code> exception and abort these
   steps.</li>

   <li>Otherwise, if the new value is the same as <span>the body
   element</span>, do nothing. Abort these steps.</li>

   <li>Otherwise, if <span>the body element</span> is not null, then
   replace that element with the new value in the DOM, as if the root
   element's <code title="">replaceChild()</code> method had been
   called with the new value and <span title="the body element">the
   incumbent body element</span> as its two arguments respectively,
   then abort these steps.</li>

   <li>Otherwise, the <span>the body element</span> is null. Append
   the new value to the root element.</li>

  </ol>

  <!--XXX
    http://lxr.mozilla.org/seamonkey/source/content/html/document/src/nsHTMLDocument.cpp
    search for ::GetBody ::SetBody
    http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/html/HTMLDocument.cpp
    search for ::setBody
    http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/dom/Document.cpp
    search for ::body
  -->

  <p>The <dfn title="dom-document-images"><code>images</code></dfn>
  attribute must return an <code>HTMLCollection</code> rooted at the
  <code>Document</code> node, whose filter matches only
  <code>img</code> elements.</p>

  <p>The <dfn title="dom-document-links"><code>links</code></dfn>
  attribute must return an <code>HTMLCollection</code> rooted at the
  <code>Document</code> node, whose filter matches only <code>a</code>
  elements with <code title="attr-hyperlink-href">href</code>
  attributes and <code>area</code> elements with <code
  title="attr-hyperlink-href">href</code> attributes.</p>

  <p>The <dfn title="dom-document-forms"><code>forms</code></dfn>
  attribute must return an <code>HTMLCollection</code> rooted at the
  <code>Document</code> node, whose filter matches only
  <code>form</code> elements.</p>

  <p>The <dfn title="dom-document-anchors"><code>anchors</code></dfn>
  attribute must return an <code>HTMLCollection</code> rooted at the
  <code>Document</code> node, whose filter matches only <code>a</code>
  elements with <code title="attr-a-name">name</code> attributes.</p><!-- XXX note that such elements are
  non-conforming -->

  <p>The <dfn
  title="dom-document-getElementsByName"><code>getElementsByName(<var
  title="">name</var>)</code></dfn> method a string <var
  title="">name</var>, and must return a live <code>NodeList</code>
  containing all the <code>a</code>, <code>applet</code>,
  <code>button</code>, <code>form</code>, <!-- frame? frameset?
  XXX--><code>iframe</code>, <code>img</code>, <code>input</code>,
  <code>map</code>, <code>meta</code>, <code>object</code>,<!-- param?
  XXX--> <code>select</code>, and <code>textarea</code> elements in
  that document that have a <code title="">name</code> attribute whose
  value is equal<!-- XXX case sensitivity --> to the <var
  title="">name</var> argument.</p> <!-- XXX what about XHTML? -->

  <p>The <dfn
  title="dom-document-getElementsByClassName"><code>getElementsByClassName(<var
  title="">classNames</var>)</code></dfn> method takes an array of
  strings representing classes. When called, the method must return a
  live <code>NodeList</code> object containing all the elements in the
  document that have all the classes specified in that array. If the
  array is empty, then the method must return an empty
  <code>NodeList</code>.</p>

  <p>HTML, XHTML, SVG and MathML elements define which classes they
  are in by having an attribute in the per-element partition with the
  name <code title="">class</code> containing a space-separated list
  of classes to which the element belongs. Other specifications may
  also allow elements in their namespaces to be labelled as being in
  specific classes. UAs must not assume that all attributes of the
  name <code>class</code> for elements in any namespace work in this
  way, however, and must not assume that such attributes, when used as
  global attributes, label other elements as being in specific
  classes.</p>

  <div class="example">
   <p>Given the following XHTML fragment:</p>
   <pre>&lt;div id="example"&gt;
 &lt;p id="p1" class="aaa bbb"/&gt;
 &lt;p id="p2" class="aaa ccc"/&gt;
 &lt;p id="p3" class="bbb ccc"/&gt;
&lt;/div&gt;</pre>
   <p>A call to
   <code>document.getElementById('example').getElementsByClassName('aaa')</code>
   would return a <code>NodeList</code> with the two paragraphs
   <code>p1</code> and <code>p2</code> in it.</p>
   <p>A call to <code>getElementsByClassName(['ccc', 'bbb'])</code>
   would only return one node, however, namely <code>p3</code>.  A
   call to
   <code>document.getElementById('example').getElementsByClassName('ccc
   bbb')</code> would return the same thing.</p>
   <p>A call to <code>getElementsByClassName(['aaa bbb'])</code> would
   return no nodes; none of the elements above are in the "aaa bbb"
   class.</p>
   <p>A call to <code>getElementsByClassName([''])</code> would also
   return no nodes, since none of the nodes are in the "" class
   (indeed, in HTML, it is impossible to specify that an element is in
   the "" class).</p>
  </div>

  <p>The <dfn
  title="dom-getElementsByClassName"><code>getElementsByClassName()</code></dfn>
  method on the <code>HTMLElement</code> interface must return the
  nodes that the <code>HTMLDocument</code> <code
  title="dom-document-getElementsByClassName">getElementsByClassName()</code>
  method would return, excluding any elements that are not descendants
  of the <code>HTMLElement</code> object on which the method was
  invoked.</p>

<!-- XXX
>         * xGetParentElementByClassName(rootElement, className, tagName) -
> Navigates upwards until we hit a parent element with the given class name and
> optional tag name.
-->



  <h3><dfn>Dynamic markup insertion</dfn></h3>

  <p>The <code title="dom-document-write">document.write()</code>
  family of methods and the <code
  title="dom-innerHTML">innerHTML</code> family of DOM attributes
  enable script authors to dynamically insert markup into the
  document.</p>

  <p class="issue">bz argues that innerHTML should be called something
  else on XML documents and XML elements. Is the sanity worth the
  migration pain?</p>

  <p>Because these APIs interact with the parser, their behaviour
  varies depending on whether they are used with <span>HTML
  documents</span> (and the <span>HTML parser</span>) or XHTML in
  <span>XML documents</span> (and the <span>XML parser</span>). The
  following table cross-references the various versions of these
  APIs.</p>

  <table>
   <thead>
    <tr>
     <td></td>
     <th><dfn title="dom-document-write"><code>document.write()</code></dfn></th>
     <th><dfn title="dom-innerHTML"><code>innerHTML</code></dfn></th>
    </tr>
   </thead>
   <tbody>
    <tr>
     <th>For documents that are <span>HTML documents</span></th>
     <td><span title="dom-document-write-HTML"><code>document.write()</code> in HTML</span></td>
     <td><span title="dom-innerHTML-HTML"><code>innerHTML</code> in HTML</span></td>
    </tr>
    <tr>
     <th>For documents that are <span>XML documents</span></th>
     <td><span title="dom-document-write-XML"><code>document.write()</code> in XML</span></td>
     <td><span title="dom-innerHTML-XML"><code>innerHTML</code> in XML</span></td>
    </tr>
   </tbody>
  </table>

  <p>Regardless of the parsing mode, the <dfn
  title="dom-document-writeln"><code>document.writeln(<var
  title="">s</var>)</code></dfn> method must call the <code
  title="dom-document-write">document.write()</code> method with the
  same argument <var title="">s</var>, and then call the <code
  title="dom-document-write">document.write()</code> method with, as
  its argument, a string consisting of a single line feed character
  (U+000A).</p>


  <h4>Controlling the input stream</h4>

  <p>The <dfn title="dom-document-open"><code>open()</code></dfn>
  method comes in several variants with different numbers of
  arguments.</p>

  <p>When called with two or fewer arguments, the method must act as
  follows:</p>

  <ol>

   <li><p>Let <var title="">type</var> be the value of the first
   argument, if there is one, or "<code>text/html</code>"
   otherwise.</p></li>

   <li><p>Let <var title="">replace</var> be true if there is a second
   argument and it has the value "replace"<!-- case-insensitive. XXX
   -->, and false otherwise.</p></li>

   <li>

    <p>If the document has an <span>active parser</span><!-- XXX xref
    --> that isn't a <span>script-created parser</span>, and the
    <span>insertion point</span> associated with that parser's
    <span>input stream</span> is not undefined (that is, it
    <em>does</em> point to somewhere in the input stream), then the
    method does nothing. Abort these steps.</p>

    <p class="note">This basically causes <code
    title="dom-document-open">document.open()</code> to be ignored
    when it's called in an inline script found during the parsing of
    data sent over the network, while still letting it have an effect
    when called asynchronously or on a document that is itself being
    spoon-fed using these APIs.</p>

   </li>

   <li><p>Otherwise, if the document has an <span>active
   parser</span><!--XXX xref-->, then stop that parser, and throw away
   any pending content in the input stream. <span
   class="big-issue">what about if it doesn't, because it's either
   like a text/plain, or Atom, or PDF, or XHTML, or image document, or
   something?</span></p></li><!-- XXX see also innerHTML in HTML -->

   <li><p>Remove all child nodes of the document.</p></li>

   <li><p>Create a new <span>HTML parser</span> and associate it with
   the document. This is a <dfn>script-created parser</dfn> (meaning
   that it can be closed by the <code
   title="dom-document-open">document.open()</code> and <code
   title="dom-document-close">document.close()</code> methods, and
   that the tokeniser will wait for an explicit call to <code
   title="dom-document-close">document.close()</code> before emitting
   an end-of-file token).</p></li>

   <li>Mark the document as being an <span title="HTML documents">HTML
   document</span> (it might already be so-marked).</li>

   <!-- text/plain handling --><li><p>If <var title="">type</var> does
   not have the value "<code>text/html</code>"<!-- XXX matched how?
   -->, then act as if the tokeniser had emitted a <code>pre</code>
   element start tag, then set the <span>HTML parser</span>'s
   <span>tokenisation</span> stage's <span>content model flag</span>
   to <em>PLAINTEXT</em>.</p></li>

   <li><p>If <var title="">replace</var> is false, then: remove all
   the entries in the <span>browsing context</span>'s <span>session
   history</span> after the <span>current entry</span> in its
   <code>Document</code>'s <code>History</code> object, add a new
   entry whose address is the same as the <span>current entry</span>'s
   at the end of the list, and then advance to that page as if the
   <code title="dom-history-forward">history.forward()</code> method
   had been invoked.</p></li>

   <li><p>Finally, set the <span>insertion point</span> to point at just
   before the end of the <span>input stream</span> (which at this
   point will be empty).</p></li>

  </ol>

  <p class="big-issue">We shouldn't hard-code <code>text/plain</code>
  there. We should do it some other way, e.g. hand off to the section
  on content-sniffing and handling of incoming data streams, the part
  that defines how this all works when stuff comes over the
  network.</p>

  <!-- XXX Should we support XML/XHTML as a type to that method? -->

  <p>When called with three or more arguments, the <code
  title="dom-document-open">open()</code> method on the
  <code>HTMLDocument</code> object must call the <code
  title="dom-open">open()</code> method on the <code>WindowHTML</code>
  interface of the object returned by the <code
  title="dom-document-defaultView">defaultView</code> attribute of the
  <code>DocumentView</code> interface of the <code>HTMLDocument</code>
  object, with the same arguments as the original call to the <code
  title="dom-document-open">open()</code> method. If the <code
  title="dom-document-defaultView">defaultView</code> attribute of the
  <code>DocumentView</code> interface of the <code>HTMLDocument</code>
  object is null, then the method must raise an
  <code>INVALID_ACCESS_ERR</code> exception.</p>

  <p>The <dfn title="dom-document-close"><code>close()</code></dfn>
  method must do nothing if there is no <span>script-created
  parser</span> associated with the document. If there is such a
  parser, then, when the method is called, the user agent must insert
  an <span>explicit "EOF" character</span> at the <span>insertion
  point</span> of the parser's <span>input stream</span>.</p>


  <h4>Dynamic markup insertion in HTML</h4>

  <p>In HTML, the <dfn
  title="dom-document-write-HTML"><code>document.write(<var
  title="">s</var>)</code></dfn>
  method must act as follows:</p>

  <ol>

   <li>

    <p>If the <span>insertion point</span> is undefined, the <code
    title="dom-document-open">open()</code> method must be called
    (with no arguments) on the <code title="Document">document</code>
    object. The <span>insertion point</span> will point at just before
    the end of the (empty) <span>input stream</span>.</p>

   </li>

   <li>

    <p>The string <var title="">s</var> must be inserted into the
    <span>input stream</span><!-- XXX xref --> just before the
    <span>insertion point</span>.</p>

   </li>

   <li>

    <p>If there is <span title="the script that will execute as soon
    as the parser resumes">a script that will execute as soon as the
    parser resumes</span>, then the method must now return without
    further processing of the <span>input stream</span>.</p>

   </li>

   <li>

    <p>Otherwise, the tokeniser must process the characters that were
    inserted, one at a time, processing resulting tokens as they are
    emitted, and stopping when the tokeniser reaches the insertion
    point or when the processing of the tokeniser is aborted by the
    tree construction stage (this can happen if a <code>script</code>
    start tag token is emitted by the tokeniser).

    <p class="note">If the <code
    title="dom-document-write-HTML">document.write()</code> method was
    called from script executing inline (i.e. executing because the
    parser parsed a set of <code>script</code> tags), then this is a
    <a href="#nestedParsing">reentrant invocation of the
    parser</a>.</p>

   </li>

   <li>

    <p>Finally, the method must return.</p>

   </li>

  </ol>

  <p>In HTML, the <dfn
  title="dom-innerHTML-HTML"><code>innerHTML</code></dfn> DOM
  attribute of all <code>HTMLElement</code> and
  <code>HTMLDocument</code> nodes returns a serialisation of the
  node's children using the <span>HTML syntax</span><!-- XXX xref
  -->. On setting, it replaces the node's children with new nodes that
  result from parsing the given value. The formal definitions
  follow.</p>

  <p>On getting, the <code title="dom-innerHTML-HTML">innerHTML</code>
  DOM attribute must return the result of running the following
  algorithm:</p>

  <ol>

   <li><p>Let <var title="">s</var> be a string, and initialise it to
   the empty string.</p></li>

   <li>

    <p>For each child node <var title="">child</var>, in <span>tree order</span>,
    append the appropriate string from the following list to <var
    title="">s</var>:</p>

    <dl class="switch">

     <dt>If the child node is an <code title="">Element</code></dt>

     <dd>

      <p>Append a U+003C LESS-THAN SIGN (<code title="">&lt;</code>)
      character, followed by the element's tag name (which is all
      lowercase).</p>

      <p>For each attribute that the element has, append a U+0020
      SPACE character, the attribute's name (which again will be all
      lowercase), a U+003D EQUALS SIGN (<code title="">=</code>)
      character, a U+0022 QUOTATION MARK (<code
      title="">&quot;</code>) character, the attribute's value, <span
      title="escaping a string">escaped as described below</span>, and
      a second U+0022 QUOTATION MARK (<code title="">&quot;</code>)
      character.</p>

      <p>While the exact order of attributes is UA-defined, and may
      depend on factors such as the order that the attributes were
      given in the original markup, the sort order must be stable,
      such that consecutive calls to <code
      title="dom-innerHTML-HTML">innerHTML</code> serialise an
      element's attributes in the same order.</p>

      <p>Append a U+003E GREATER-THAN SIGN (<code title="">&gt;</code>)
      character.</p>

      <p>If the child node is an <code title="">Element</code> with a
      tag name that is one of <code>area</code>, <code>base</code>,
      <code>basefont</code>, <code>bgsound</code>, <code>br</code>,
      <code>col</code>, <code>embed</code>, <code>frame</code>,
      <code>hr</code>, <code>img</code>, <code>input</code>,
      <code>link</code>, <code>meta</code>, <code>param</code>,
      <code>spacer</code>, or <code>wbr</code>, then continue on to
      the next child node at this point.</p> <!-- also, i guess:
      image, isindex, and keygen, but we don't list those because we
      don't consider those "elements", more "macros", and thus we
      should never serialise them --> <!-- XXX when we get around to
      it, add event-source -->

      <p>Otherwise, append the value of the <var
      title="">child</var> element's <code
      title="dom-innerHTML-HTML">innerHTML</code> DOM attribute
      (thus recursing into this algorithm for that element),
      followed by a U+003C LESS-THAN SIGN (<code
      title="">&lt;</code>) character, a U+002F SOLIDUS (<code
      title="">/</code>) character, the element's tag name again
      (which is again all lowercase), and finally a U+003E
      GREATER-THAN SIGN (<code title="">&gt;</code>) character.</p>

     </dd>


     <dt>If the child node is a <code title="">Text</code> or <code
     title="">CDATASection</code> node</dt>

     <dd>

      <p>If one of the ancestors of the child node is a
      <code>style</code>, <code>script</code>, <code>xmp</code>,
      <code>iframe</code>, <code>noembed</code>,
      <code>noframes</code>, or <code>noscript</code> element, then
      append the value of the <var title="">child</var> node's <code
      title="">data</code> DOM attribute literally.</p>
      <!-- note about noscript: because this is defining an API, it
      can assume that scripting is enabled, and that thus the
      <noscript> element in the DOM will have been parsed in the
      scripting-enabled mode, and that thus the text node is raw
      markup -->

      <p>Otherwise, append the value of the <var title="">child</var>
      node's <code title="">data</code> DOM attribute, <span
      title="escaping a string">escaped as described below</span>.</p>

     </dd>


     <dt>If the child node is a <code title="">Comment</code></dt>

     <dd>

      <p>Append the literal string <code>&lt;!--</code> (U+003C
      LESS-THAN SIGN, U+0021 EXCLAMATION MARK, U+002D HYPHEN-MINUS,
      U+002D HYPHEN-MINUS), followed by the value of the <var
      title="">child</var> node's <code title="">data</code> DOM
      attribute, followed by the literal string <code>--&gt;</code>
      (U+002D HYPHEN-MINUS, U+002D HYPHEN-MINUS, U+003E GREATER-THAN
      SIGN).</p>

     </dd>


     <dt>If the child node is a <code title="">DocumentType</code></dt>

     <dd>

      <p>Append the literal string <code>&lt;!DOCTYPE</code> (U+003C
      LESS-THAN SIGN, U+0021 EXCLAMATION MARK, U+0044 LATIN CAPITAL
      LETTER D, U+004F LATIN CAPITAL LETTER O, U+0043 LATIN CAPITAL
      LETTER C, U+0054 LATIN CAPITAL LETTER T, U+0059 LATIN CAPITAL
      LETTER Y, U+0050 LATIN CAPITAL LETTER P, U+0045 LATIN CAPITAL
      LETTER E), followed by a space (U+0020 SPACE), followed by the
      value of the <var title="">child</var> node's <code
      title="">name</code> DOM attribute, followed by the literal
      string <code>&gt;</code> (U+003E GREATER-THAN SIGN).</p>

     </dd>


    </dl>

    <p>Other nodes types (e.g. <code title="">Attr</code>) cannot
    occur as children of elements. If they do, the <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute must raise
    an <code>INVALID_STATE_ERR</code> exception.</p>

   </li>

   <li><p>The result of the algorithm is the string <var
   title="">s</var>.</p></li>

  </ol>

  <p><dfn id="escapingString">Escaping a string</dfn> (for the
  purposes of the algorithm above) consists of replacing any
  occurances of the "<code title="">&amp;</code>" character by the
  string "<code title="">&amp;amp;</code>", any occurances of the
  "<code title="">&lt;</code>" character by the string "<code
  title="">&amp;lt;</code>", any occurances of the "<code
  title="">&gt;</code>" character by the string "<code
  title="">&amp;gt;</code>", and any occurances of the "<code
  title="">&quot;</code>" character by the string "<code
  title="">&amp;quot;</code>".</p>

  <p class="note">Entity reference nodes are <a
  href="#entity-references">assumed to be expanded</a> by the user
  agent, and are therefore not covered in the algorithm above.</p>

  <p class="note">If the element's contents are not conformant, it is
  possible that the roundtripping through <code
  title="dom-innerHTML-HTML">innerHTML</code> will not work. For
  instance, if the element is a <code>textarea</code> element to which
  a <code title="">Comment</code> node has been appended, then
  assigning <code title="dom-innerHTML-HTML">innerHTML</code> to
  itself will result in the comment being displayed in the text
  field. Similarly, if, as a result of DOM manipulation, the element
  contains a comment that contains the literal string "<code
  title="">--&gt;</code>", then when the result of serialising the
  element is parsed, the comment will be truncated at that point and
  the rest of the comment will be interpreted as markup. Another
  example would be making a <code>script</code> element contain a text
  node with the text string "<code>&lt;/script></code>".</p>

  <p>On setting, if the node is a document, the <code
  title="dom-innerHTML-HTML">innerHTML</code> DOM attribute must run
  the following algorithm:</p>

  <ol>

   <li>

    <p>Otherwise, if the document has an <span>active
    parser</span><!--XXX xref-->, then stop that parser, and throw
    away any pending content in the input stream. <span
    class="big-issue">what about if it doesn't, because it's either
    like a text/plain, or Atom, or PDF, or XHTML, or image document,
    or something?</span></p><!-- XXX see also document.open() -->

   </li>

   <li>

    <p>The user agent must remove the children nodes of the
    <code>Document</code> whose <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute is being
    set.</p>

   </li>

   <li>

    <p>The user agent must create a new <span>HTML parser</span>, in
    its initial state, and associate it with the
    <code>Document</code> node.</p>

   </li>

<!-- redundant, the document is forcably already so labelled if we get here
   <li>

    <p>The user agent must mark the <code>Document</code> object as
    being an <span title="HTML documents">HTML document</span>.</p>

   </li>
-->

   <li>

    <p>The user agent must place into the <span>input stream</span>
    for the <span>HTML parser</span> just created the string being
    assigned into the <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute.</p>

   </li>

   <li>

    <p>The user agent must start the parser and let it run until it
    has consumed all the characters just inserted into the input
    stream. (The <code>Document</code> node will have been populated
    with elements and a <code title="event-load">load</code> event
    will have fired on <span title="the body element">its body
    element</span>.)</p>

   </li>

  </ol>

  <p>Otherwise, if the node is an element, then setting the <code
  title="dom-innerHTML-HTML">innerHTML</code> DOM attribute must cause
  the following algorithm to run instead:</p>

  <ol>

   <li>

    <p>The user agent must create a new <code>Document</code> node,
    and mark it as being an <span title="HTML documents">HTML
    document</span>.</p>

    <p>The user agent must create a new <span>HTML parser</span>, and
    associate it with the just created <code>Document</code> node.</p>

    <p class="note">Parts marked <dfn title="innerHTML
    case"><code>innerHTML</code> case</dfn> in algorithms in the
    parser section are parts that only occur if the parser was created
    for the purposes of handling the setting of an element's <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute. The
    algorithms have been annotated with such markings for
    informational purposes only; such markings have no normative
    weight. If it is possible for a condition described as an
    <span><code>innerHTML</code> case</span> to occur even when the
    parser wasn't created for the purposes of handling an element's
    <code title="dom-innerHTML-HTML">innerHTML</code> attribute, then
    that is an error in the specification.</p>

   </li>

   <li>

    <p>The user agent must set the <span>HTML parser</span>'s
    <span>tokenisation</span> stage's <span>content model flag</span>
    according to the name of the element whose <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute is being
    set, as follows:</p>

    <dl class="switch">

     <dt>If it is a <code>title</code> or <code>textarea</code>
     element</dt>

     <dd>Set the <span>content model flag</span> to
     <em>RCDATA</em>.</dd>


     <dt>If it is a <code>style</code>, <code>script</code>,
     <code>xmp</code>, <code>iframe</code>, <code>noembed</code>,
     <code>noframes</code>, or <code>noscript</code> element</dt>

     <dd>Set the <span>content model flag</span> to
     <em>CDATA</em>.</dd>
     <!-- note about noscript: we set it to CDATA here because if
     someone is setting innerHTML, then we know scripting is enabled,
     so the noscript element will be in CDATA mode -->


     <dt>If it is a <code>plaintext</code> element</dt>

     <dd>Set the <span>content model flag</span> to
     <em>PLAINTEXT</em>.</dd>


     <dt>Otherwise</dt>

     <dd>Set the <span>content model flag</span> to <em>PCDATA</em>.</dd>

    </dl>

   </li>

   <li>

    <p>The user agent must switch the <span>HTML parser</span>'s
    <span>tree construction</span> stage to <span>the main
    phase</span>.

   </li>

   <li>

    <p>Let <var title="">root</var> be a new <code>html</code> element
    with no attributes.</p>

   </li>

   <li>

    <p>The user agent must append the element <var title="">root</var>
    to the <code>Document</code> node created above.</p>

   </li>

   <li>

    <p>The user agent must set up the parser's <span>stack of open
    elements</span> so that it contains just the single element <var
    title="">root</var>.</p>

   </li>

   <li>

    <p>The user agent must <span title="reset the insertion mode
    appropriately">reset the parser's insertion mode
    appropriately</span>.</p>

   </li>

   <li>

    <p>The user agent must set the parser's <span><code>form</code>
    element pointer</span> to the nearest node to the element whose
    <code title="dom-innerHTML-HTML">innerHTML</code> attribute is
    being set that is a <code>form</code> element (going straight up
    the ancestor chain, and including the element itself, if it is a
    <code>form</code> element), or, if there is no such
    <code>form</code> element, to null.</p>

   </li>

   <li>

    <p>The user agent must place into the <span>input stream</span>
    for the <span>HTML parser</span> just created the string being
    assigned into the <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute.</p>

   </li>

   <li>

    <p>The user agent must start the parser and let it run until it
    has consumed all the characters just inserted into the input
    stream.</p>

   </li>

   <li>

    <p>The user agent must remove the children of the element whose
    <code title="dom-innerHTML-HTML">innerHTML</code> attribute is
    being set.</p>

   </li>

   <li>

    <p>The user agent must move all the child nodes of the <var
    title="">root</var> element to the element whose <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute is being
    set, preserving their order.</p>

   </li>

  </ol>

  <!-- XXX must make sure we spec that innerHTML causes mutation
  events to fire, but document.write() doesn't. (the latter is already
  req-stated in the parser section, btw) -->

  <!-- http://msdn.microsoft.com/workshop/author/dhtml/reference/properties/innerhtml.asp -->
  <!-- http://lxr.mozilla.org/seamonkey/source/content/html/content/src/nsGenericHTMLElement.cpp#879
       note script execution disabled
       http://lxr.mozilla.org/seamonkey/source/content/base/src/nsContentUtils.cpp#3308
       http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/html/HTMLElement.cpp#L295
       http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/html/HTMLElement.cpp#L242
       http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/html/HTMLTokenizer.cpp#L1742
   -->

  <h4>Dynamic markup insertion in XML</h4>

  <p>In an XML context, the <dfn
  title="dom-document-write-XML"><code>document.write(<var
  title="">s</var>)</code></dfn> method must raise an
  <code>INVALID_ACCESS_ERR</code> exception.</p>

<!--
  For XHTML: content must be well-formed. Where does
  it insert? Immediately after the script that called document.write()?</p>
  how do we handle async scripts vs sync scripts?

Consider:
data:text/xml,<script xmlns="http://www.w3.org/1999/xhtml"><![CDATA[ document.write('<foo>Test</foo>'); ]]></script>
data:text/xml,<script xmlns="http://www.w3.org/1999/xhtml"><![CDATA[ alert('test'); alert(document.write); try { document.write('<foo>Test</foo>'); alert(document.childNodes.length); } catch (e) { alert(e); } ]]></script>

-->

  <p>The <dfn title="dom-innerHTML-XML"><code>innerHTML</code></dfn>
  attributes, on the other hand, in an XML context, are usable.</p>

  <p>On getting, the <code title="dom-innerHTML-XML">innerHTML</code>
  DOM attribute on <code>HTMLElement</code>s and
  <code>HTMLDocument</code>s, in an XML context, must return a
  namespace-well-formed XML representation of the element or
  document. User agents may adjust prefixes and namespace declarations
  in the serialisation (and indeed might be forced to do so in some
  cases to obtain namespace-well-formed XML). <a
  href="#refsXML">[XML]</a> <a href="#refsXMLNS">[XMLNS]</a></p>

  <p>On setting, if the node is a document, the <code
  title="dom-innerHTML-HTML">innerHTML</code> DOM attribute on must run
  the following algorithm:</p>

  <ol>

   <li>

    <p>The user agent must remove the children nodes of the
    <code>Document</code> whose <code
    title="dom-innerHTML-XML">innerHTML</code> attribute is being
    set.</p>

   </li>

   <li>

    <p>The user agent must create a new <span>XML parser</span>.</p>

   </li>

   <li>

    <p>If the <code title="dom-innerHTML-XML">innerHTML</code>
    attribute is being set on an element, the user agent must
    <span>feed the parser</span> just created the string corresponding
    to the start tag of that element, declaring all the namespace
    prefixes that are in scope on that element in the DOM, as well as
    declaring the default namespace (if any) that is in scope on that
    element in the DOM.</p>

   </li>

   <li>

    <p>The user agent must <span>feed the parser</span> just created
    the string being assigned into the <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute.</p>

   </li>

   <li>

    <p>If the <code title="dom-innerHTML-XML">innerHTML</code>
    attribute is being set on an element, the user agent must
    <span>feed the parser</span> the string corresponding to the end
    tag of that element.</p>

   </li>

   <li>

    <p>If the parser found a well-formedness error, the attribute's
    setter must raise a <code>SYNTAX_ERR</code> exception and abort
    these steps.</p>

   </li>

   <li>

    <p>Otherwise, the user agent must take the children of the
    document, if the attribute is being set on a <code>Document</code>
    node, or of the document's root element, if the attribute is being
    set on an <code>Element</code> node, and append them to the node
    whose <code title="dom-innerHTML-HTML">innerHTML</code> attribute
    is being set, preserving their order.</p>

   </li>

  </ol>




  <h3>APIs in HTML documents</h3>
  <!-- XXX case-sensitivity training required here. -->

  <p>For <span>HTML documents</span>, and for <span>HTML
  elements</span> in <span>HTML documents</span>, certain APIs defined
  in DOM3 Core become case-insensitive or case-changing, as sometimes
  defined in DOM3 Core, and as summarised or required below. <a
  href="#refsDOM3CORE">[DOM3CORE]</a>.</p>

  <p>This does not apply to <span>XML documents</span> or to elements
  that are not in the <span>HTML namespace</span> despite being in
  <span>HTML documents</span>.</p>

  <dl>

   <dt><code title="">Element.tagName</code>, <code
   title="">Node.nodeName</code>, and <code
   title="">Node.localName</code></dt>

   <dd>

    <p>These attributes return tag names in all uppercase<!-- XXX
    xref-->, regardless of the case with which they were created.</p>

   </dd>


   <dt><code title="">Document.createElement()</code></dt>

   <dd>

    <p>The canonical form of HTML markup is all-lowercase; thus, this
    method will lowercase<!-- XXX xref --> the argument before
    creating the requisite element. Also, the element created must be
    in the <span>HTML namespace</span>.</p>

    <p class="note">This doesn't apply to <code
    title="">Document.createElementNS()</code>. Thus, it is possible,
    by passing this last method a tag name in the wrong case, to
    create an element that claims to have the tag name of an HTML
    element, but doesn't support its interfaces, because it really has
    another tag name not accessible from the DOM APIs.</p>

   </dd>


   <dt><code title="">Element.setAttributeNode()</code></dt>

   <dd>

    <p>When an <code>Attr</code> node is set on an <span title="HTML
    elements">HTML element</span>, it must have its name
    lowercased<!-- XXX xref --> before the element is affected.</p>

    <p class="note">This doesn't apply to <code
    title="">Document.setAttributeNodeNS()</code>.</p>

   </dd>


   <dt><code title="">Element.setAttribute()</code></dt>

   <dd>

    <p>When an attribute is set on an <span title="HTML elements">HTML
    element</span>, the name argument must be lowercased<!-- XXX xref
    --> before the element is affected.</p>

    <p class="note">This doesn't apply to <code
    title="">Document.setAttributeNS()</code>.</p>

   </dd>


   <dt><code title="">Document.getElementsByTagName()</code> and <code
   title="">Element.getElementsByTagName()</code></dt>

   <dd>

    <p>These methods (but not their namespaced counterparts) must
    compare the given argument case-insensitively<!-- XXX xref -->
    when looking at <span title="HTML elements">HTML elements</span>,
    and case-sensitively otherwise.</p>

    <p class="note">Thus, in an <span>HTML document</span> with nodes
    in multiple namespaces, these methods will be both case-sensitive
    and case-insensitive at the same time.</p>

   </dd>


   <dt><code title="">Document.renameNode()</code></dt>

   <dd>

    <p>If the new namespace is the <span>HTML namespace</span>, then
    the new qualified name must be lowercased before the rename takes
    place.<!-- XXX xref --></p>

   </dd>
   

  </dl>




  <h2 id="semantics">Semantics and structure of HTML elements</h2>


  <h3 id="semantics-intro">Introduction</h3>

  <p><em>This section is non-normative.</em></p>

  <p class="big-issue">An introduction to marking up a document.</p>


  <h3>Common microsyntaxes</h3>

  <p>There are various places in HTML that accept particular data
  types, such as dates or numbers. This section describes what the
  conformance criteria for content in those formats is, and how to
  parse them.</p>

  <!-- XXX need to define how to handle U+000A LINE FEED and U+000D
  CARRIAGE RETURN in attributes (for HTML) -->

  <p class="big-issue">Need to go through the whole spec and make sure
  all the attribute values are clearly defined either in terms of
  microsyntaxes or in terms of other specs, or as "Text" or some
  such.</p>


  <h4>Common parser idioms</h4>

  <p>The <dfn title="space character">space characters</dfn>, for the
  purposes of this specification, are U+0020 SPACE, U+0009 CHARACTER
  TABULATION (tab), U+000A LINE FEED (LF), U+000B LINE TABULATION,
  U+000C FORM FEED (FF), and U+000D CARRIAGE RETURN (CR).</p>

  <p>Some of the micro-parsers described below follow the pattern of
  having an <var title="">input</var> variable that holds the string
  being parsed, and having a <var title="">position</var> variable
  pointing at the next character to parse in <var
  title="">input</var>.</p>

  <p>For parsers based on this pattern, a step that requires the user
  agent to <dfn>collect a sequence of characters</dfn> means that the
  following algorithm must be run, with <var title="">characters</var>
  being the set of characters that can be collected:</p>

  <ol>

   <li><p>Let <var title="">input</var> and <var
   title="">position</var> be the same variables as those of the same
   name in the algorithm that invoked these steps.</p></li>

   <li><p>Let <var title="">result</var> be the empty string.</p></li>

   <li><p>While <var title="">position</var> doesn't point past the
   end of <var title="">input</var> and the character at <var
   title="">position</var> is one of the <var
   title="">characters</var>, append that character to the end of <var
   title="">result</var> and advance <var title="">position</var> to
   the next character in <var title="">input</var>.</p></li>

   <li><p>Return <var title="">result</var>.</p></li>

  </ol>

  <p>The step <dfn>skip whitespace</dfn> means that the user agent
  must <span>collect a sequence of characters</span> that are <span
  title="space character">space characters</span>. The step <dfn>skip
  Zs characters</dfn> means that the user agent must <span>collect a
  sequence of characters</span> that are in the Unicode character
  class Zs. In both cases, the collected characters are not used. <a
  href="#refsUNICODE">[UNICODE]</a></p>


  <h4>Boolean attributes</h4>

  <p>A number of attributes in HTML5 are <dfn title="boolean
  attribute">boolean attributes</dfn>. The presence of a boolean
  attribute on an element represents the true value, and the absence
  of the attribute represents the false value.</p>

  <p>If the attribute is present, its value must either be the empty
  string or the attribute's canonical name, exactly, with no leading
  or trailing whitespace, and in lowercase.</p>


  <h4>Numbers</h4>

  <h5>Unsigned integers</h5>

  <p>A string is a <dfn>valid non-negative integer</dfn> if it
  consists of one of more characters in the range U+0030 DIGIT ZERO
  (0) to U+0039 DIGIT NINE (9).</p>

  <p>The <dfn>rules for parsing non-negative integers</dfn> are as
  given in the following algorithm. When invoked, the steps must be
  followed in the order given, aborting at the first step that returns
  a value. This algorithm will either return zero, a positive integer,
  or an error. Leading spaces are ignored. Trailing spaces and indeed
  any trailing garbage characters are ignored.</p>

  <ol>

   <li><p>Let <var title="">input</var> be the string being
   parsed.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p>Let <var title="">value</var> have the value 0.</li>

   <li><p><span>Skip whitespace.</span></p></li>

   <li><p>If <var title="">position</var> is past the end of <var
   title="">input</var>, return an error.</p></li>

   <li><p>If the next character is not one of U+0030 DIGIT ZERO (0)
   .. U+0039 DIGIT NINE (9), then return an error.</p></li>

   <!-- Ok. At this point we know we have a number. It might have
   trailing garbage which we'll ignore, but it's a number, and we
   won't return an error. -->

   <li>

    <p>If the next character is one of U+0030 DIGIT ZERO (0) .. U+0039
    DIGIT NINE (9):</p>

    <ol>

     <li>Multiply <var title="">value</var> by ten.</li>

     <li>Add the value of the current character (0..9) to <var
     title="">value</var>.</li>

     <li>Advance <var title="">position</var> to the next
     character.</li>

     <li>If <var title="">position</var> is not past the end of <var
     title="">input</var>, return to the top of step 7 in the overall
     algorithm (that's the step within which these substeps find
     themselves).</li>

    </ol>

   </li>

   <li><p>Return <var title="">value</var>.</p></li>

  </ol>


  <h5>Signed integers</h5>

  <p>A string is a <dfn>valid integer</dfn> if it consists of one of
  more characters in the range U+0030 DIGIT ZERO (0) to U+0039 DIGIT
  NINE (9), optionally prefixed with a U+002D HYPHEN-MINUS ("-")
  character.</p>

  <p>The <dfn>rules for parsing integers</dfn> are similar to the
  rules for non-negative integers, and are as given in the following
  algorithm. When invoked, the steps must be followed in the order
  given, aborting at the first step that returns a value. This
  algorithm will either return an integer or an error. Leading spaces
  are ignored. Trailing spaces and trailing garbage characters are
  ignored.</p>

  <ol>

   <li><p>Let <var title="">input</var> be the string being
   parsed.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p>Let <var title="">value</var> have the value 0.</p></li>

   <li><p>Let <var title="">sign</var> have the value
   "positive".</p></li>

   <li><p><span>Skip whitespace.</span></p></li>

   <li><p>If <var title="">position</var> is past the end of <var
    title="">input</var>, return an error.</p></li>

   <li>

    <p>If the character indicated by <var title="">position</var> (the
    first character) is a U+002D HYPHEN-MINUS ("-") character:</p>

    <ol>

     <li>Let <var title="">sign</var> be "negative".</li>

     <li>Advance <var title="">position</var> to the next
     character.</li>

     <li>If <var title="">position</var> is past the end of <var
     title="">input</var>, return an error.</li>

    </ol>

   </li>

   <li><p>If the next character is not one of U+0030 DIGIT ZERO (0)
   .. U+0039 DIGIT NINE (9), then return an error.</p></li>

   <!-- Ok. At this point we know we have a number. It might have
   trailing garbage which we'll ignore, but it's a number, and we
   won't return an error. -->

   <li>

    <p>If the next character is one of U+0030 DIGIT ZERO (0) .. U+0039
    DIGIT NINE (9):</p>

    <ol>

     <li>Multiply <var title="">value</var> by ten.</li>

     <li>Add the value of the current character (0..9) to <var
     title="">value</var>.</li>

     <li>Advance <var title="">position</var> to the next
     character.</li>

     <li>If <var title="">position</var> is not past the end of <var
     title="">input</var>, return to the top of step 9 in the overall
     algorithm (that's the step within which these substeps find
     themselves).</li>

    </ol>

   </li>

   <li><p>If <var title="">sign</var> is "positive", return <var
   title="">value</var>, otherwise return 0-<var
   title="">value</var>.</p></li>

  </ol>


  <h5>Real numbers</h5>

  <p>A string is a <dfn>valid floating point number</dfn> if it
  consists of one of more characters in the range U+0030 DIGIT ZERO
  (0) to U+0039 DIGIT NINE (9), optionally with a single U+002E FULL
  STOP (".") character somewhere (either before these numbers, in
  between two numbers, or after the numbers), all optionally prefixed
  with a U+002D HYPHEN-MINUS ("-") character.</p>

  <p>The <dfn>rules for parsing floating point number values</dfn> are
  as given in the following algorithm. As with the previous
  algorithms, when this one is invoked, the steps must be followed in
  the order given, aborting at the first step that returns a
  value. This algorithm will either return a number or an
  error. Leading spaces are ignored. Trailing spaces and garbage
  characters are ignored.</p>

  <ol>

   <li><p>Let <var title="">input</var> be the string being
   parsed.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p>Let <var title="">value</var> have the value 0.</li>

   <li><p>Let <var title="">sign</var> have the value "positive".</li>

   <li><p><span>Skip whitespace.</span></p></li>

   <li><p>If <var title="">position</var> is past the end of <var
    title="">input</var>, return an error.</p></li>

   <li>

    <p>If the character indicated by <var title="">position</var> (the
    first character) is a U+002D HYPHEN-MINUS ("-") character:</p>

    <ol>

     <li>Let <var title="">sign</var> be "negative".</li>

     <li>Advance <var title="">position</var> to the next
     character.</li>

     <li>If <var title="">position</var> is past the end of <var
     title="">input</var>, return an error.</li>

    </ol>

   </li>

   <li><p>If the next character is not one of U+0030 DIGIT ZERO (0)
   .. U+0039 DIGIT NINE (9) or U+002E FULL STOP ("."), then return an
   error.</p></li>

   <li><p>If the next character is U+002E FULL STOP ("."), but either
   that is the last character or the character after that one is not
   one of U+0030 DIGIT ZERO (0) .. U+0039 DIGIT NINE (9), then return
   an error.</p></li>

   <!-- Ok. At this point we know we have a number. It might have
   trailing garbage which we'll ignore, but it's a number, and we
   won't return an error. -->

   <li>

    <p>If the next character is one of U+0030 DIGIT ZERO (0) .. U+0039
    DIGIT NINE (9):</p>

    <ol>

     <li>Multiply <var title="">value</var> by ten.</li>

     <li>Add the value of the current character (0..9) to <var
     title="">value</var>.</li>

     <li>Advance <var title="">position</var> to the next
     character.</li>

     <li>If <var title="">position</var> is past the end of <var
     title="">input</var>, then if <var title="">sign</var> is
     "positive", return <var title="">value</var>, otherwise return
     0-<var title="">value</var>.</li>

     <li>Otherwise return to the top of step 10 in the overall
     algorithm (that's the step within which these substeps find
     themselves).</li>

    </ol>

   </li>

   <li><p>Otherwise, if the next character is not a U+002E FULL STOP
   ("."), then if <var title="">sign</var> is "positive", return <var
   title="">value</var>, otherwise return 0-<var
   title="">value</var>.</p></li>

   <li><p>The next character is a U+002E FULL STOP ("."). Advance <var
   title="">position</var> to the character after that.</p></li>

   <li><p>Let <var title="">divisor</var> be 1.</p></li>

   <li>

    <p>If the next character is one of U+0030 DIGIT ZERO (0) .. U+0039
    DIGIT NINE (9):</p>

    <ol>

     <li>Multiply <var title="">divisor</var> by ten.</li>

     <li>Add the value of the current character (0..9) divided by <var
     title="">divisor</var>, to <var title="">value</var>.</li>

     <li>Advance <var title="">position</var> to the next
     character.</li>

     <li>If <var title="">position</var> is past the end of <var
     title="">input</var>, then if <var title="">sign</var> is
     "positive", return <var title="">value</var>, otherwise return
     0-<var title="">value</var>.</li>

     <li>Otherwise return to the top of step 14 in the overall
     algorithm (that's the step within which these substeps find
     themselves).</li>

    </ol>

   </li>

   <li><p>Otherwise, if <var title="">sign</var> is "positive", return
   <var title="">value</var>, otherwise return 0-<var
   title="">value</var>.</p></li>

  </ol>


  <h5>Ratios</h5>

  <p class="note">The algorithms described in this section are used by
  the <code>progress</code> and <code>meter</code> elements.</p>

  <p>A <dfn>valid denominator punctuation character</dfn> is one of
  the characters from the table below. There is <dfn title="values
  associated with denominator punctuation characters">a value
  associated with each denominator punctuation character</dfn>, as
  shown in the table below.</p>

  <table>
   <thead>
    <tr>
     <th colspan="2">Denominator Punctuation Character</th>
     <th>Value</th>
    </tr>
   </thead>
   <tbody>
    <tr>
     <td>U+0025 PERCENT SIGN</td>
     <td>&#x0025;</td>
     <td>100</td>
    </tr>
    <tr>
     <td>U+066A ARABIC PERCENT SIGN</td>
     <td>&#x066A;</td>
     <td>100</td>
    </tr>
    <tr>
     <td>U+FE6A SMALL PERCENT SIGN</td>
     <td>&#xFE6A;</td>
     <td>100</td>
    </tr>
    <tr>
     <td>U+FF05 FULLWIDTH PERCENT SIGN</td>
     <td>&#xFF05;</td>
     <td>100</td>
    </tr>
    <tr>
     <td>U+2030 PER MILLE SIGN</td>
     <td>&#x2030;</td>
     <td>1000</td>
    </tr>
    <tr>
     <td>U+2031 PER TEN THOUSAND SIGN</td>
     <td>&#x2031;</td>
     <td>10000</td>
    </tr>
   </tbody>
  </table>

  <p>The <dfn>steps for finding one or two numbers of a ratio in a
  string</dfn> are as follows:</p>

  <ol>

   <li>If the string is empty, then return nothing and abort these
   steps.</li>

   <li><span>Find a number</span> in the string according to the
   algorithm below, starting at the start of the string.</li>

   <li>If the sub-algorithm in step 2 returned nothing or returned an
   error condition, return nothing and abort these steps.</li>

   <li>Set <var title="">number1</var> to the number returned by the
   sub-algorithm in step 2.</li>

   <li>Starting with the character immediately after the last one
   examined by the sub-algorithm in step 2, skip any characters in the
   string that are in the Unicode character class Zs (this might match
   zero characters). <a href="#refsUNICODE">[UNICODE]</a></li>

   <li>If there are still further characters in the string, and the
   next character in the string is a <span>valid denominator
   punctuation character</span>, set <var title="">denominator</var>
   to that character.</li>

   <li>If the string contains any other characters in the range U+0030
   DIGIT ZERO to U+0039 DIGIT NINE, but <var title="">denominator</var> was
   given a value in the step 6, return nothing and abort these
   steps.</li>

   <li>Otherwise, if <var title="">denominator</var> was given a value in step
   6, return <var title="">number1</var> and <var title="">denominator</var> and abort
   these steps.</li>

   <li><span>Find a number</span> in the string again, starting
   immediately after the last character that was examined by the
   sub-algorithm in step 2.</li>

   <li>If the sub-algorithm in step 9 returned nothing or an error
   condition, return nothing and abort these steps.</li>

   <li>Set <var title="">number2</var> to the number returned by the
   sub-algorithm in step 9.</li>

   <li>If there are still further characters in the string, and the
   next character in the string is a <span>valid denominator
   punctuation character</span>, return nothing and abort these
   steps.</li>

   <li>If the string contains any other characters in the range U+0030
   DIGIT ZERO to U+0039 DIGIT NINE, return nothing and abort these
   steps.</li>
 
   <li>Otherwise, return <var title="">number1</var> and
   <var title="">number2</var>.</li>

  </ol>

  <!-- XXX again, this should say "positive number" -->
  <p>The algorithm to <dfn>find a number</dfn> is as follows. It is
  given a string and a starting position, and returns either nothing,
  a number, or an error condition.</p>

  <ol>

   <li>Starting at the given starting position, ignore all characters
   in the given string until the first character that is either a
   U+002E FULL STOP or one of the ten characters in the range U+0030
   DIGIT ZERO to U+0039 DIGIT NINE.</li>

   <li>If there are no such characters, return nothing and abort these
   steps.</li>

   <li>Starting with the character matched in step 1, collect all the
   consecutive characters that are either a U+002E FULL STOP or one of
   the ten characters in the range U+0030 DIGIT ZERO to U+0039 DIGIT
   NINE, and assign this string of one or more characters to
   <var title="">string</var>.</li>

   <li>If <var title="">string</var> contains more than one U+002E FULL STOP
   character then return an error condition and abort these
   steps.</li>

   <li>Parse <var title="">string</var> according to the <span>rules for
   parsing floating point number values</span>, to obtain
   <var title="">number</var>. This step cannot fail (<var title="">string</var> is
   guarenteed to be a <span>valid floating point number</span>).</li>

   <li>Return <var title="">number</var>.</li>

  </ol>


  <h5 id="percentages-and-dimensions">Percentages and dimensions</h5>

  <p class="big-issue"><dfn title="valid non-negative
  percentage">valid non-negative percentages</dfn>, <dfn>rules for
  parsing dimension values</dfn> (only used by height/width on img,
  embed, object &mdash; maybe they should do the same as canvas, then
  this wouldn't even be needed)</p>



  <h5>Lists of integers</h5>

  <p>A <dfn>valid list of integers</dfn> is a number of <span
  title="valid integer">valid integers</span> separated by U+002C
  COMMA characters, with no other characters (e.g. no <span
  title="space character">space characters</span>). In addition, there
  might be restrictions on the number of integers that can be given,
  or on the range of values allowed.</p>

  <p>The <dfn>rules for parsing a list of integers</dfn> are as
  follows:</p>

  <ol>

   <li><p>Let <var title="">input</var> be the string being
   parsed.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p>Let <var title="">numbers</var> be an initially empty list
   of integers. This list will be the result of this
   algorithm.</p></li>

   <li><p>If there is a character in the string <var
   title="">input</var> at position <var title="">position</var>, and
   it is either U+002C COMMA character or a U+0020 SPACE character,
   then advance <var title="">position</var> to the next character in
   <var title="">input</var>, or to beyond the end of the string if
   there are no more characters.</p></li>

   <li><p>If <var title="">position</var> points to beyond the end of
   <var title="">input</var>, return <var title="">numbers</var> and
   abort.</p></li>

   <li><p>If the character in the string <var title="">input</var> at
   position <var title="">position</var> is a U+002C COMMA character
   or a U+0020 SPACE character, return to step 4.</li>

   <li><p>Let <var title="">negated</var> be false.</p></li>
   <li><p>Let <var title="">value</var> be 0.</p></li>
   <li><p>Let <var title="">multiple</var> be 1.</p></li>
   <li><p>Let <var title="">started</var> be false.</p></li>
   <li><p>Let <var title="">finished</var> be false.</p></li>
   <li><p>Let <var title="">bogus</var> be false.</p></li>

   <li><p><em>Parser:</em> If the character in the string <var
   title="">input</var> at position <var title="">position</var>
   is:</p>

    <dl class="switch">

     <!-- XXX this doesn't quite match what IE does: http://www.hixie.ch/tests/adhoc/html/flow/image-maps/004-demo.html
          I couldn't work out a pattern to IE's results. Let me know if you can see one. -->

     <dt>A U+002D HYPHEN-MINUS character</dt>

     <dd>

      <p>Follow these substeps:</p>

      <ol>

       <li>If <var title="">finished</var> is true, skip to the next
       step in the overall set of steps.</li>

       <li>If <var title="">started</var> is true or if <var
       title="">bogus</var> is true, let <var title="">negated</var>
       be false.</li>

       <li>Otherwise, if <var title="">started</var> is false and if <var
       title="">bogus</var> is false, let <var title="">negated</var>
       be true.</li>

       <li>Let <var title="">started</var> be true.</li>

      </ol>

     </dd>


     <dt>A character in the range U+0030 DIGIT ZERO .. U+0039 DIGIT
     NINE</dt>

     <dd>

      <p>Follow these substeps:</p>

      <ol>

       <li>If <var title="">finished</var> is true, skip to the next
       step in the overall set of steps.</li>

       <li>Let <var title="">n</var> be the value of the digit,
       interpreted in base ten, multiplied by <var
       title="">multiple</var>.</li>

       <li>Add <var title="">n</var> to <var title="">value</var>.</li>

       <li>If <var title="">value</var> is greater than zero, multiply
       <var title="">multiple</var> by ten.</li>

       <li>Let <var title="">started</var> be true.</li>

      </ol>

     </dd>


     <dt>A U+002C COMMA character</dt>
     <dt>A U+0020 SPACE character</dt>

     <dd>

      <p>Follow these substeps:</p>

      <ol>

       <li>If <var title="">started</var> is false, return the <var
       title="">numbers</var> list and abort.</li>

       <li>If <var title="">negated</var> is true, then negate <var
       title="">value</var>.</li>

       <li>Append <var title="">value</var> to the <var
       title="">numbers</var> list.</li>

       <li>Jump to step 4 in the overall set of steps.</li>

      </ol>

     </dd>


     <dt>A U+002E FULL STOP  character</dt>

     <dd>

      <p>Follow these substeps:</p>

      <ol>

       <li>Let <var title="">finished</var> be true.</li>

      </ol>

     </dd>


     <dt>Any other character</dt>

     <dd>

      <p>Follow these substeps:</p>

      <ol>

       <li>If <var title="">finished</var> is true, skip to the next
       step in the overall set of steps.</li>

       <li>Let <var title="">negated</var> be false.</li>

       <li>Let <var title="">bogus</var> be true.</li>

       <li>If <var title="">started</var> is true, then return the
       <var title="">numbers</var> list, and abort. (The value in <var
       title="">value</var> is not appended to the list first; it is
       dropped.)</li>

      </ol>

     </dd>

    </dl>   

   </li>

   <li><p>Advance <var title="">position</var> to the next character
   in <var title="">input</var>, or to beyond the end of the string if
   there are no more characters.</p></li>

   <li><p>If <var title="">position</var> points to a character (and
   not to beyond the end of <var title="">input</var>), jump to the
   big <em>Parser</em> step above.</p></li>

   <li><p>If <var title="">negated</var> is true, then negate <var
   title="">value</var>.</li>

   <li><p>If <var title="">started</var> is true, then append <var
   title="">value</var> to the <var title="">numbers</var> list,
   return that list, and abort.</li>

   <li><p>Return the <var title="">numbers</var> list and
   abort.</p></li>

  </ol>



  <h4>Dates and times</h4>

  <p>In the algorithms below, the <dfn>number of days in month <var
  title="">month</var> of year <var title="">year</var></dfn> is:
  <em>31</em> if <var title="">month</var> is 1, 3, 5, 7, 8, 10, or
  12; <em>30</em> if <var title="">month</var> is 4, 6, 9, or 11;
  <em>29</em> if <var title="">month</var> is 2 and <var
  title="">year</var> is a number divisible by 400, or if <var
  title="">year</var> is a number divisible by 4 but not by 100; and
  <em>28</em> otherwise. This takes into account leap years in the
  Gregorian calendar. <a
  href="#refsGREGORIAN">[GREGORIAN]</a></p>

  <h5>Specific moments in time</h5>

  <p>A string is a <dfn>valid datetime</dfn> if it has four digits
  (representing the year), a literal hyphen, two digits (representing
  the month), a literal hyphen, two digits (representing the day),
  optionally some spaces, either a literal T or a space, optionally
  some more spaces, two digits (for the hour), a colon, two digits
  (the minutes), optionally the seconds (which, if included, must
  consist of another colon, two digits (the integer part of the
  seconds), and optionally a decimal point followed by one or more
  digits (for the fractional part of the seconds)), optionally some
  spaces, and finally either a literal Z (indicating the time zone is
  UTC), or, a plus sign or a minus sign followed by two digits, a
  colon, and two digits (for the sign, the hours and minutes of the
  timezone offset respectively); with the month-day combination being
  a valid date in the given year according to the Gregorian calendar,
  the hour values (<var title="">h</var>) being in the range
  0&nbsp;&le;&nbsp;<var title="">h</var>&nbsp;&le;&nbsp;23, the minute
  values (<var title="">m</var>) in the range 0&nbsp;&le;&nbsp;<var
  title="">m</var>&nbsp;&le;&nbsp;59, and the second value (<var
  title="">s</var>) being in the range 0&nbsp;&le;&nbsp;<var
  title="">h</var>&nbsp;&lt;&nbsp;60. <a
  href="#refsGREGORIAN">[GREGORIAN]</a></p>

  <!--XXX [GREGORIAN] should point to
  <dd id="refsGREGORIAN">[GREGORIAN]</dd>
  <dd>(Non-normative) <cite>Inter Gravissimas</cite>, A. Lilius, C. Clavius. Gregory XIII Papal Bulls, February 1582.</dd>
  -->

  <p>The digits must be characters in the range U+0030 DIGIT ZERO (0)
  to U+0039 DIGIT NINE (9), the hyphens must be a U+002D HYPHEN-MINUS
  characters, the T must be a U+0054 LATIN CAPITAL LETTER T, the
  colons must be U+003A COLON characters, the decimal point must be a
  U+002E FULL STOP, the Z must be a U+005A LATIN CAPITAL LETTER Z, the
  plus sign must be a U+002B PLUS SIGN, and the minus U+002D (same as
  the hyphen).</p>

  <div class="example">

   <p>The following are some examples of dates written as <span
   title="valid datetime">valid datetimes</span>.</p>

   <dl>

    <dt>"<code>0037-12-13 00:00 Z</code>"</dt>

    <dd>Midnight UTC on the birthday of Nero (the Roman Emperor).</dd>

    <dt>"<code>1979-10-14T12:00:00.001-04:00</code>"</dt>

    <dd>One millisecond after noon on October 14th 1979, in the time
    zone in use on the east coast of North America during daylight
    saving time.</dd>

    <dt>"<code>8592-01-01 T 02:09 +02:09</code>"</dt>

    <dd>Midnight UTC on the 1st of January, 8592. The time zone
    associated with that time is two hours and nine minutes ahead of
    UTC.</dd>

   </dl>

   <p>Several things are notable about these dates:</p>

   <ul>

    <li>Years with fewer than four digits have to be
    zero-padded. The date "37-12-13" would not be a valid date.</li>

    <li>To unambiguously identify a moment in time prior to the
    introduction of the Gregorian calendar, the date has to be first
    converted to the Gregorian calendar from the calendar in use at
    the time (e.g. from the Julian calendar). The date of Nero's
    birth is the 15th of December 37, in the Julian Calendar, which
    is the 13th of December 37 in the Gregorian Calendar.</li> <!--
    XXX this might not be true. I can't find a reference that gives
    his birthday with an explicit statement about the calendar being
    used. However, it seems unlikely that it would be given in the
    Gregorian calendar, so I assume sites use the Julian one. -->

    <li>The time and timezone components are not optional.</li>

    <li>Dates before the year 0 or after the year 9999 can't be
    represented as a datetime in this version of HTML.</li>

    <li>Time zones differ based on daylight savings time.</li>

   </ul>

  </div>

  <p class="note">Conformance checkers can use the algorithm below to
  determine if a datetime is a valid datetime or not.</p>

  <p>To <dfn id="datetime-parser">parse a string as a datetime
  value</dfn>, a user agent must apply the following algorithm to the
  string. This will either return a time in UTC, with associated
  timezone information for round tripping or display purposes, or
  nothing, indicating the value is not a <span>valid
  datetime</span>. If at any point the algorithm says that it "fails",
  this means that it returns nothing.</p>

  <ol>

   <li><p>Let <var title="">input</var> be the string being
   parsed.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p><span>Collect a sequence of characters</span> in the range
   U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
   sequence is not exactly four characters long, then fail. Otherwise,
   interpret the resulting sequence as a base ten integer. Let that
   number be the <var title="">year</var>.</p></li>

   <li><p>If <var title="">position</var> is beyond the end of <var
   title="">input</var> or if the character at <var
   title="">position</var> is not a U+002D HYPHEN-MINUS character,
   then fail. Otherwise, move <var title="">position</var> forwards
   one character.</p></li>

   <li><p><span>Collect a sequence of characters</span> in the range
   U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
   sequence is not exactly two characters long, then fail. Otherwise,
   interpret the resulting sequence as a base ten integer. Let that
   number be the <var title="">month</var>.</p></li>

   <li>If <var title="">month</var> is not a number in the range
   1&nbsp;&le;&nbsp;<var title="">month</var>&nbsp;&le;&nbsp;12, then fail.</li>

   <li><p>Let <var title="">maxday</var> be the <span>number of days
   in month <var title="">month</var> of year <var
   title="">year</var></span>.</p></li>

   <li><p>If <var title="">position</var> is beyond the end of <var
   title="">input</var> or if the character at <var
   title="">position</var> is not a U+002D HYPHEN-MINUS character,
   then fail. Otherwise, move <var title="">position</var> forwards
   one character.</p></li>

   <li><p><span>Collect a sequence of characters</span> in the range
   U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
   sequence is not exactly two characters long, then fail. Otherwise,
   interpret the resulting sequence as a base ten integer. Let that
   number be the <var title="">day</var>.</p></li>

   <li><p>If <var title="">day</var> is not a number in the range
   1&nbsp;&le;&nbsp;<var title="">month</var>&nbsp;&le;&nbsp;<var
   title="">maxday</var>, then fail.</li>

   <li><p><span>Collect a sequence of characters</span> that are
   either U+0054 LATIN CAPITAL LETTER T characters or <span
   title="space character">space characters</span>. If the collected
   sequence is zero characters long, or if it contains more than one
   U+0054 LATIN CAPITAL LETTER T character, then fail.</p></li>

   <li><p><span>Collect a sequence of characters</span> in the range
   U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
   sequence is not exactly two characters long, then fail. Otherwise,
   interpret the resulting sequence as a base ten integer. Let that
   number be the <var title="">hour</var>.</p></li>

   <li>If <var title="">hour</var> is not a number in the range
   0&nbsp;&le;&nbsp;<var title="">hour</var>&nbsp;&le;&nbsp;23, then fail.</li>

   <li><p>If <var title="">position</var> is beyond the end of <var
   title="">input</var> or if the character at <var
   title="">position</var> is not a U+003A COLON character,
   then fail. Otherwise, move <var title="">position</var> forwards
   one character.</p></li>

   <li><p><span>Collect a sequence of characters</span> in the range
   U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
   sequence is not exactly two characters long, then fail. Otherwise,
   interpret the resulting sequence as a base ten integer. Let that
   number be the <var title="">minute</var>.</p></li>

   <li>If <var title="">minute</var> is not a number in the range
   0&nbsp;&le;&nbsp;<var title="">minute</var>&nbsp;&le;&nbsp;59, then fail.</li>

   <li><p>Let <var title="">second</var> be a string with the value
   "0".</p></li>

   <li><p>If <var title="">position</var> is beyond the end of <var
   title="">input</var>, then fail.</p></li>

   <li><p>If the character at <var title="">position</var> is a U+003A
   COLON, then:</p>

    <ol>

     <li><p>Advance <var title="">position</var> to the next character
     in <var title="">input</var>.</p></li>

     <li><p>If <var title="">position</var> is beyond the end of <var
     title="">input</var>, or at the last character in <var
     title="">input</var>, or if the next <em>two</em> characters in
     <var title="">input</var> starting at <var
     title="">position</var> are not two characters both in the range
     U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9), then
     fail.</p></li>

     <li><p><span>Collect a sequence of characters</span> that are
     either characters in the range U+0030 DIGIT ZERO (0) to U+0039
     DIGIT NINE (9) or U+002E FULL STOP characters. If the collected
     sequence has more than one U+002E FULL STOP characters, or if the
     last character in the sequence is a U+002E FULL STOP character,
     then fail. Otherwise, let the collected string be <var
     title="">second</var> instead of its previous value.</p></li>

    </ol>

   </li>

   <li><p>Interpret <var title="">second</var> as a base ten number
   (possibly with a fractional part). Let that number be <var
   title="">second</var> instead of the string version.</p></li>

   <li>If <var title="">second</var> is not a number in the range
   0&nbsp;&le;&nbsp;<var title="">hour</var>&nbsp;&lt;&nbsp;60, then fail. (The
   values 60 and 61 are not allowed: leap seconds cannot be
   represented by datetime values.)</li>

   <li><p>If <var title="">position</var> is beyond the end of <var
   title="">input</var>, then fail.</p></li>

   <li><p><span>Skip whitespace.</span></p></li>

   <li><p>If the character at <var title="">position</var> is a
   U+005A LATIN CAPITAL LETTER Z, then:</p>

    <ol>

     <li><p>Let <var title="">timezone<sub title="">hours</sub></var> be
     0.</p></li>

     <li><p>Let <var title="">timezone<sub title="">minutes</sub></var> be
     0.</p></li>

     <li><p>Advance <var title="">position</var> to the next character
     in <var title="">input</var>.</p></li>

    </ol>

   </li>

   <li><p>Otherwise, if the character at <var title="">position</var>
   is either a U+002B PLUS SIGN ("+") or a U+002D HYPHEN-MINUS ("-"),
   then:</p>

    <ol>

     <li><p>If the character at <var title="">position</var> is a
     U+002B PLUS SIGN ("+"), let <var title="">sign</var> be
     "positive". Otherwise, it's a U+002D HYPHEN-MINUS ("-"); let <var
     title="">sign</var> be "negative".</p></li>

     <li><p>Advance <var title="">position</var> to the next character
     in <var title="">input</var>.</p></li>

     <li><p><span>Collect a sequence of characters</span> in the range
     U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
     sequence is not exactly two characters long, then
     fail. Otherwise, interpret the resulting sequence as a base ten
     integer. Let that number be the <var
     title="">timezone<sub title="">hours</sub></var>.</p></li>

     <li>If <var title="">timezone<sub title="">hours</sub></var> is not a
     number in the range 0&nbsp;&le;&nbsp;<var
     title="">timezone<sub title="">hours</sub></var>&nbsp;&le;&nbsp;23, then
     fail.</li>

     <li>If <var title="">sign</var> is "negative", then negate <var
     title="">timezone<sub title="">hours</sub></var>.</li>

     <li><p>If <var title="">position</var> is beyond the end of <var
     title="">input</var> or if the character at <var
     title="">position</var> is not a U+003A COLON character, then
     fail. Otherwise, move <var title="">position</var> forwards one
     character.</p></li>

     <li><p><span>Collect a sequence of characters</span> in the range
     U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
     sequence is not exactly two characters long, then
     fail. Otherwise, interpret the resulting sequence as a base ten
     integer. Let that number be the <var
     title="">timezone<sub title="">minutes</sub></var>.</p></li>

     <li>If <var title="">timezone<sub title="">minutes</sub></var> is not a
     number in the range 0&nbsp;&le;&nbsp;<var
     title="">timezone<sub title="">minutes</sub></var>&nbsp;&le;&nbsp;59, then
     fail.</li>

    </ol>

   </li>

   <li><p>If <var title="">position</var> is <em>not</em> beyond the
   end of <var title="">input</var>, then fail.</p></li>

   <li><p>Let <var title="">time</var> be the moment in time at year
   <var title="">year</var>, month <var title="">month</var>, day <var
   title="">day</var>, hours <var title="">hour</var>, minute <var
   title="">minute</var>, second <var title="">second</var>, adding
   <var title="">timezone<sub title="">hours</sub></var> hours and <var
   title="">timezone<sub title="">minutes</sub></var> minutes. That moment in
   time is a moment in the UTC timezone.</p></li>

   <li><p>Let <var title="">timezone</var> be <var
   title="">timezone<sub title="">hours</sub></var> hours and <var
   title="">timezone<sub title="">minutes</sub></var> minutes from
   UTC.</p></li>

   <li><p>Return <var title="">time</var> and <var
   title="">timezone</var>.</p></li>

  </ol>


  <h5>Vaguer moments in time</h5>

  <p>This section defines <dfn title="date or time string">date or
  time strings</dfn>. There are two kinds, <dfn title="date or time
  string in content">date or time strings in content</dfn>, and <dfn
  title="date or time string in attributes">date or time strings in
  attributes</dfn>. The only difference is in the handling of
  whitespace characters.</p>

  <p>To parse a <span>date or time string</span>, user agents must use
  the following algorithm. A <span>date or time string</span> is a
  <em>valid</em> date or time string if the following algorithm, when
  run on the string, doesn't say the string is invalid.</p>

  <p>The algorithm may return nothing (in which case the string will
  be invalid), or it may return a date, a time, a date and a time, or
  a date and a time and and a timezone. Even if the algorithm returns
  one or more values, the string can still be invalid.</p>

  <ol>

   <!-- INIT -->
   <li><p>Let <var title="">input</var> be the string being
   parsed.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p>Let <var title="">results</var> be the collection of results
   that are to be returned (one or more of a date, a time, and a
   timezone), initially empty. If the algorithm aborts at any point,
   then whatever is currently in <var title="">results</var> must be
   returned as the result of the algorithm.</p></li>

   <!-- LEADING WHITESPACE -->
   <li><p>For the "in content" variant: <span>skip Zs
   characters</span>; for the "in attributes" variant: <span>skip
   whitespace</span>.</p></li><!-- XXX skip whitespace in attribute?
   really? -->

   <!-- YEAR or HOUR -->
   <li><p><span>Collect a sequence of characters</span> in the range
   U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
   sequence is empty, then the string is invalid; abort these
   steps.</p></li>

   <li><p>Let the sequence of characters collected in the last step be
   <var title="">s</var>.</p></li>

   <li><p>If <var title="">position</var> is past the end of <var
   title="">input</var>, the string is invalid; abort these
   steps.</p></li>

   <li><p>If the character at <var title="">position</var> is
   <em>not</em> a U+003A COLON character, then:</p>

    <!-- DATE -->
    <ol>

     <li><p>If the character at <var title="">position</var> is not a
     U+002D HYPHEN-MINUS ("-") character either, then the string is
     invalid, abort these steps.</p></li>

     <!-- YEAR -->
     <li><p>If the sequence <var title="">s</var> is not exactly four
     digits long, then the string is invalid. (This does not stop the
     algorithm, however.)</p></li>

     <li><p>Interpret the sequence of characters collected in step 5 as
     a base ten integer, and let that number be <var
     title="">year</var>.</p></li>

     <li><p>Advance <var title="">position</var> past the U+002D
     HYPHEN-MINUS ("-") character.</p></li>

     <!-- MONTH -->
     <li><p><span>Collect a sequence of characters</span> in the range
     U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
     sequence is empty, then the string is invalid; abort these
     steps.</p></li>

     <li><p>If the sequence collected in the last step is not exactly
     two digits long, then the string is invalid.</p></li>

     <li><p>Interpret the sequence of characters collected two steps ago
     as a base ten integer, and let that number be <var
     title="">month</var>.</p></li>

     <li>If <var title="">month</var> is not a number in the range
     1&nbsp;&le;&nbsp;<var title="">month</var>&nbsp;&le;&nbsp;12, then
     the string is invalid, abort these steps.</li>

     <li><p>Let <var title="">maxday</var> be the <span>number of days
     in month <var title="">month</var> of year <var
     title="">year</var></span>.</p></li>

     <li><p>If <var title="">position</var> is past the end of <var
     title="">input</var>, or if the character at <var
     title="">position</var> is <em>not</em> a U+002D HYPHEN-MINUS ("-")
     character, then the string is invalid, abort these
     steps. Otherwise, advance <var title="">position</var> to the next
     character.</p></li>

     <!-- DAY -->
     <li><p><span>Collect a sequence of characters</span> in the range
     U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
     sequence is empty, then the string is invalid; abort these
     steps.</p></li>

     <li><p>If the sequence collected in the last step is not exactly
     two digits long, then the string is invalid.</p></li>

     <li><p>Interpret the sequence of characters collected two steps
     ago as a base ten integer, and let that number be <var
     title="">day</var>.</p></li>

     <li><p>If <var title="">day</var> is not a number in the range
     1&nbsp;&le;&nbsp;<var title="">day</var>&nbsp;&le;&nbsp;<var
     title="">maxday</var>, then the string is invalid, abort these
     steps.</p></li>

     <li><p>Add the date represented by <var title="">year</var>, <var
     title="">month</var>, and <var title="">day</var> to the <var
     title="">results</var>.</p></li>

     <!-- WHITESPACE -->
     <li><p>For the "in content" variant: <span>skip Zs
     characters</span>; for the "in attributes" variant: <span>skip
     whitespace</span>.</p></li>

     <li><p>If the character at <var title="">position</var> is a U+0054
     LATIN CAPITAL LETTER T, then move <var title="">position</var>
     forwards one character.</p></li>

     <li><p>For the "in content" variant: <span>skip Zs
     characters</span>; for the "in attributes" variant: <span>skip
     whitespace</span>.</p></li>

     <!-- at this point, if <var title="">position</var> points to a
     number, we know that we passed at least one space or a T, because
     otherwise the number would have been slurped up in the last
     "collect" step. -->

     <!-- HOUR -->
     <li><p><span>Collect a sequence of characters</span> in the range
     U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
     sequence is empty, then the string is invalid; abort these
     steps.</p></li>

     <li><p>Let <var title="">s</var> be the sequence of characters
     collected in the last step.</p></li>

    </ol>

   </li>

   <!-- TIME -->

   <li><p>If <var title="">s</var> is not exactly two digits long,
   then the string is invalid.</p></li>

   <li><p>Interpret the sequence of characters collected two steps
   ago as a base ten integer, and let that number be <var
   title="">hour</var>.</p></li>

   <li><p>If <var title="">hour</var> is not a number in the range
   0&nbsp;&le;&nbsp;<var title="">hour</var>&nbsp;&le;&nbsp;23, then
   the string is invalid, abort these steps.</p></li>

   <li><p>If <var title="">position</var> is past the end of <var
   title="">input</var>, or if the character at <var
   title="">position</var> is <em>not</em> a U+003A COLON character,
   then the string is invalid, abort these steps. Otherwise, advance
   <var title="">position</var> to the next character.</p></li>

   <!-- MINUTE -->
   <li><p><span>Collect a sequence of characters</span> in the range
   U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
   sequence is empty, then the string is invalid; abort these
   steps.</p></li>

   <li><p>If the sequence collected in the last step is not exactly
   two digits long, then the string is invalid.</p></li>

   <li><p>Interpret the sequence of characters collected two steps
   ago as a base ten integer, and let that number be <var
   title="">minute</var>.</p></li>

   <li><p>If <var title="">minute</var> is not a number in the range
   0&nbsp;&le;&nbsp;<var title="">minute</var>&nbsp;&le;&nbsp;59, then
   the string is invalid, abort these steps.</p></li>

   <!-- SECOND -->
   <li><p>Let <var title="">second</var> be 0. It may be changed to
   another value in the next step.</p></li>

   <li><p>If <var title="">position</var> is not past the end of <var
   title="">input</var> and the character at <var
   title="">position</var> is a U+003A COLON character, then:</p>

    <ol>

     <li><p><span>Collect a sequence of characters</span> that are
     either characters in the range U+0030 DIGIT ZERO (0) to U+0039
     DIGIT NINE (9) or are U+002E FULL STOP. If the collected sequence
     is empty, or contains more than one U+002E FULL STOP character,
     then the string is invalid; abort these steps.</p></li>

     <li><p>If the first character in the sequence collected in the
     last step is not in the range U+0030 DIGIT ZERO (0) to U+0039
     DIGIT NINE (9), then the string is invalid.</p></li>

     <li><p>Interpret the sequence of characters collected two steps
     ago as a base ten number (possibly with a fractional part), and
     let that number be <var title="">second</var>.</p></li>

     <li><p>If <var title="">second</var> is not a number in the range
     0&nbsp;&le;&nbsp;<var title="">minute</var>&nbsp;&lt;&nbsp;60,
     then the string is invalid, abort these steps.</p></li>

    </ol>

   </li>

   <li><p>Add the time represented by <var title="">hour</var>, <var
   title="">minute</var>, and <var title="">second</var> to the <var
   title="">results</var>.</p></li>

   <!-- TIME ZONE -->

   <li><p>If <var title="">results</var> has both a date and a time,
   then:</p>

    <ol>

     <li><p>For the "in content" variant: <span>skip Zs
     characters</span>; for the "in attributes" variant: <span>skip
     whitespace</span>.</p></li>

     <li><p>If <var title="">position</var> is past the end of <var
     title="">input</var>, then skip to the next step in the overall
     set of steps.</p>

     <!-- UTC -->
     <li><p>Otherwise, if the character at <var
     title="">position</var> is a U+005A LATIN CAPITAL LETTER Z,
     then:</p>

      <ol>

       <li><p>Add the timezone corresponding to UTC (zero offset) to
       the <var title="">results</var>.</p></li>

       <li><p>Advance <var title="">position</var> to the next character
       in <var title="">input</var>.</p></li>

       <li><p>Skip to the next step in the overall set of
       steps.</p></li>

      </ol>

     </li>

     <!-- EXPLICIT TIMEZONE OFFSET -->
     <li><p>Otherwise, if the character at <var
     title="">position</var> is either a U+002B PLUS SIGN ("+") or a
     U+002D HYPHEN-MINUS ("-"), then:</p>

      <ol>

       <!-- SIGN -->
       <li><p>If the character at <var title="">position</var> is a
       U+002B PLUS SIGN ("+"), let <var title="">sign</var> be
       "positive". Otherwise, it's a U+002D HYPHEN-MINUS ("-"); let
       <var title="">sign</var> be "negative".</p></li>

       <!-- HOURS -->
       <li><p>Advance <var title="">position</var> to the next
       character in <var title="">input</var>.</p></li>

       <li><p><span>Collect a sequence of characters</span> in the
       range U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the
       collected sequence is not exactly two characters long, then
       the string is invalid.</p></li>

       <li><p>Interpret the sequence collected in the last step as a
       base ten number, and let that number be <var
       title="">timezone<sub title="">hours</sub></var>.</p></li>

       <li>If <var title="">timezone<sub title="">hours</sub></var> is not a
       number in the range 0&nbsp;&le;&nbsp;<var
       title="">timezone<sub title="">hours</sub></var>&nbsp;&le;&nbsp;23, then
       the string is invalid; abort these steps.</li>

       <li>If <var title="">sign</var> is "negative", then negate <var
       title="">timezone<sub title="">hours</sub></var>.</li>

       <li><p>If <var title="">position</var> is beyond the end of
       <var title="">input</var> or if the character at <var
       title="">position</var> is not a U+003A COLON character, then
       the string is invalid; abort these steps. Otherwise, move <var
       title="">position</var> forwards one character.</p></li>

       <!-- MINUTES -->
       <li><p><span>Collect a sequence of characters</span> in the range
       U+0030 DIGIT ZERO (0) to U+0039 DIGIT NINE (9). If the collected
       sequence is not exactly two characters long, then the string is invalid.</p></li>

       <li><p>Interpret the sequence collected in the last step as a
       base ten number, and let that number be <var
       title="">timezone<sub title="">minutes</sub></var>.</p></li>

       <li>If <var title="">timezone<sub title="">minutes</sub></var> is not a
       number in the range 0&nbsp;&le;&nbsp;<var
       title="">timezone<sub title="">minutes</sub></var>&nbsp;&le;&nbsp;59,
       then the string is invalid; abort these steps.</li>

       <li><p>Add the timezone corresponding to an offset of <var
       title="">timezone<sub title="">hours</sub></var> hours and <var
       title="">timezone<sub title="">minutes</sub></var> minutes to the <var
       title="">results</var>.</p></li>

       <li><p>Skip to the next step in the overall set of
       steps.</p></li>

      </ol>

     </li>

     <li><p>Otherwise, the string is invalid; abort these
     steps.</p></li>

    </ol>

   </li>

   <li><p>For the "in content" variant: <span>skip Zs
   characters</span>; for the "in attributes" variant: <span>skip
   whitespace</span>.</p></li>

   <li><p>If <var title="">position</var> is <em>not</em> past the end
   of <var title="">input</var>, then the string is invalid.</p>

   <li><p>Abort these steps (the string is parsed).</p></li>

  </ol>



  <h4>Tokens</h4>

  <p>An <dfn>unordered set of space-separated tokens</dfn> is a set of
  zero or more words separated by one or more <span title="space
  character">space characters</span>, where words consist of any
  string of one or more characters, none of which are <span
  title="space character">space characters</span>.</p>

  <p>A string containing an <span>unordered set of space-separated
  tokens</span> may have leading or trailing <span title="space
  character">space characters</span>.</p>

  <p class="note">Thus, any string is a valid representation of an
  <span>unordered set of space-separated tokens</span>.</p>

  <p>When a user agent has to <dfn>split a string on spaces</dfn>, it
  must use the following algorithm:</p>

  <ol>

   <li><p>Let <var title="">input</var> be the string being
   parsed.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p>Let <var title="">tokens</var> be a list of tokens,
   initially empty.</p></li>

   <li><p><span>Skip whitespace</span></p></li>

   <li><p>While <var title="">position</var> is not past the end of
   <var title="">input</var>:</p>

    <ol>

     <li><p><span>Collect a sequence of characters</span> that are not
     <span title="space character">space characters</span>.</p></li>

     <li><p>Add the string collected in the previous step to <var
     title="">tokens</var>.</p></li>

     <li><p><span>Skip whitespace</span></p></li>

    </ol>

   </li>

   <li><p>Return <var title="">tokens</var>.</p></li>  

  </ol>

  <p>When a user agent has to <dfn>remove a token from a string</dfn>,
  it must use the following algorithm:</p>

  <ol>

   <li><p>Let <var title="">input</var> be the string being
   modified.</p></li>

   <li><p>Let <var title="">token</var> be the token being removed. It
   will not contain any <span title="space character">space
   characters</span>.</p></li>

   <li><p>Let <var title="">output</var> be the output string,
   initially empty.</p></li>

   <li><p>Let <var title="">position</var> be a pointer into <var
   title="">input</var>, initially pointing at the start of the
   string.</p></li>

   <li><p>If <var title="">position</var> is beyond the end of <var
   title="">input</var>, set the string being modified to <var
   title="">output</var>, and abort these steps.</p></li>

   <li><p>If the character at <var title="">position</var> is a
   <span>space character</span>:

    <ol>

     <li><p>Append the character at <var title="">position</var> to
     the end of <var title="">output</var>.</p></li>

     <li><p>Increment <var title="">position</var> so it points at the
     next character in <var title="">input</var>.</p></li>

     <li><p>Return to step 5 in the overall set of steps.</p></li>

    </ol>

   </li>

   <li><p>Otherwise, the character at <var title="">position</var> is
   the first character of a token. <span>Collect a sequence of
   characters</span> that are not <span title="space character">space
   characters</span>, and let that be <var title="">s</var>.</p></li>

   <li><p>If <var title="">s</var> is exactly equal to <var
   title="">token</var>, then:</p>

    <ol>

     <li><p><span>Skip whitespace</span> (in <var
     title="">input</var>).</p></li>

     <li><p>Remove any <span title="space character">space
     characters</span> currently at the end of <var
     title="">output</var>.</p></li>

     <li><p>If <var title="">position</var> is not past the end of
     <var title="">input</var>, and <var title="">output</var> is not
     the empty string, append a single U+0020 SPACE character at the
     end of <var title="">output</var>.</p></li>

    </ol>

   </li>

   <li><p>Otherwise, append <var title="">s</var> to the end of <var
   title="">output</var>.</p></li>

   <li><p>Return to step 6 in the overall set of steps.</p></li>

  </ol>

  <p class="note">This causes any occurrences of the token to be
  removed from the string, and any spaces that were surrounding the
  token to be collapsed to a single space, except at the start and end
  of the string, where such spaces are removed.</p>



  <h4>Keywords and enumerated attributes</h4>

  <p>Some attributes are defined as taking one of a finite set of
  keywords. Such attributes are called <dfn title="enumerated
  attribute">enumerated attributes</dfn>. The keywords are each
  defined to map to a particular <em>state</em> (several keywords
  might map to the same state, in which case some of the keywords are
  synonyms of each other; additionally, some of the keywords can be
  said to be non-conforming, and are only in the specification for
  historical reasons). In addition, two default states can be
  given. The first is the <em>invalid value default</em>, the second
  is the <em>missing value default</em>.</p>

  <p>If an enumerated attribute is specified, the attribute's value
  must be one of the given keywords that are not said to be
  non-conforming, with no leading or trailing whitespace. The keyword
  may use any mix of uppercase and lowercase letters.<!-- XXX should
  say "uppercase and lowercase ASCII letters" or some such --></p>

  <p>When the attribute is specified, if its value
  <span>case-insensitively</span><!-- XXX ascii case folding -->
  matches one of the given keywords then that keyword's state is the
  state that the attribute represents. If the attribute value matches
  none of the given keywords, but the attribute has an <em>invalid
  value default</em>, then the attribute represents that
  state. Otherwise, if the attribute value matches none of the
  keywords but there is a <em>missing value default</em> state
  defined, then <em>that</em> is the state represented by the
  attribute. Otherwise, there is no default, and invalid values must
  simply be ignored.</p>

  <p>When the attribute is <em>not</em> specified, if there is a
  <em>missing value default</em> state defined, then that is the state
  represented by the (missing) attribute. Otherwise, the absence of
  the attribute means that there is no state represented.</p>

  <p class="note">The empty string can be one of the keywords in some
  cases. For example the <code
  title="attr-contenteditable">contenteditable</code> attribute has
  two states: <em>true</em>, matching the <code title="">true</code>
  keyword and the empty string, <em>false</em>, matching <code
  title="">false</code> and all other keywords (it's the <em>invalid
  value default</em>). It could further be thought of as having a
  third state <em>inherit</em>, which would be the default when the
  attribute is not specified at all (the <em>missing value
  default</em>), but for various reasons that isn't the way this
  specification actually defines it.</p>


  <h4 id="syntax-references">References</h4>

  <p>A <dfn>valid hashed ID reference</dfn> to an element of type <var
  title="">type</var> is a string consisting of a U+0023 NUMBER SIGN
  (<code title="">#</code>) character followed by a string which
  exactly matches the value of the <code title="attr-id">id</code>
  attribute of an element in the document with type <var
  title="">type</var>.</p>

  <p>The <dfn>rules for parsing a hashed ID reference</dfn> to an
  element of type <var title="">type</var> are as follows:</p>

  <ol>

   <li><p>If the string being parsed does not contain a U+0023 NUMBER
   SIGN character, or if the first such character in the string is the
   last character in the string, then return null and abort these
   steps.</p></li>

   <li><p>Let <var title="">s</var> be the string from the character
   immediately after the first U+0023 NUMBER SIGN character in the
   string being parsed up to the end of that string.</p></li>

   <li><p>Return the first element of type <var title="">type</var>
   that has an <code title="attr-id">id</code> or <code
   title="">name</code> attribute whose value case-insensitively
   matches <var title="">s</var>.</p></li>

  </ol>




  <h3>Documents and document fragments</h3>

  <h4>Semantics</h4>

  <p>Elements, attributes, and attribute values in HTML are defined
  (by this specification) to have certain meanings (semantics). For
  example, the <code>ol</code> element represents an ordered list, and
  the <code title="lang">lang</code> attribute represents the language
  of the content.</p>

  <p>Authors must only use elements, attributes, and attribute values
  for their appropriate semantic purposes.</p>

  <div class="example">
   <p>For example, the following document is non-conforming, despite
   being syntactically correct:</p>

   <pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en-GB"&gt;
 &lt;head&gt; &lt;title&gt; Demonstration &lt;/title&gt; &lt;/head&gt;
 &lt;body&gt;
  &lt;table&gt;
   &lt;tr&gt; &lt;td&gt; My favourite animal is the cat. &lt;/td&gt; &lt;/tr&gt;
   &lt;tr&gt;
    &lt;td&gt;
     &mdash;&lt;a href="http://example.org/~ernest/"&gt;&lt;cite&gt;Ernest&lt;/cite&gt;&lt;/a&gt;,
     in an essay from 1992
    &lt;/td&gt;
   &lt;/tr&gt;
  &lt;/table&gt;
 &lt;/body&gt;
&lt;/html&gt;</pre>

   <p>...because the data placed in the cells is clearly not tabular
   data. A corrected version of this document might be:</p>

   <pre>&lt;!DOCTYPE html&gt;
&lt;html lang="en-GB"&gt;
 &lt;head&gt; &lt;title&gt; Demonstration &lt;/title&gt; &lt;/head&gt;
 &lt;body&gt;
  &lt;blockquote&gt;
   &lt;p&gt; My favourite animal is the cat. &lt;/p&gt;
  &lt;/blockquote&gt;
  &lt;p&gt;
   &mdash;&lt;a href="http://example.org/~ernest/"&gt;&lt;cite&gt;Ernest&lt;/cite&gt;&lt;/a&gt;,
   in an essay from 1992
  &lt;/p&gt;
 &lt;/body&gt;
&lt;/html&gt;</pre>

   <p>This next document fragment, intended to represent the heading
   of a corporate site, is similarly non-conforming because the second
   line is not intended to be a heading of a subsection, but merely a
   subheading or subtitle (a subordinate heading for the same
   section).</p>

   <pre>&lt;body&gt;
 &lt;h1&gt;ABC Company&lt;/h1&gt;
 &lt;h2&gt;Leading the way in widget design since 1432&lt;/h2&gt;
 ...</pre>

   <p>The <code>header</code> element should be used in these kinds of
   situations:</p>

   <pre>&lt;body&gt;
 &lt;header&gt;
  &lt;h1&gt;ABC Company&lt;/h1&gt;
  &lt;h2&gt;Leading the way in widget design since 1432&lt;/h2&gt;
 &lt;/header&gt;
 ...</pre>

  </div>

  <p>Through scripting and using other mechanisms, the values of
  attributes, text, and indeed the entire structure of the document
  may change dynamically while a user agent is processing it. The
  semantics of a document at an instant in time are those represented
  by the state of the document at that instant in time, and the
  semantics of a document can therefore change over time. User agents
  must update their presentation of the document as this occurs.</p>

  <p class="example">HTML has a <code>progress</code> element that
  describes a progress bar. If its "value" attribute is dynamically
  updated by a script, the UA would update the rendering to show the
  progress changing.</p>


  <h4>Structure</h4>

  <p>All the elements in this specification have a defined content
  model, which describes what nodes are allowed inside the elements,
  and thus what the structure of an HTML document or fragment must
  look like. Authors must only put elements inside an element if that
  element allows them to be there according to its content model.</p>

  <p class="note">As noted in the conformance and terminology
  sections, for the purposes of determining if an element matches its
  content model or not, <span title="text
  node"><code>CDATASection</code> nodes in the DOM are treated as
  equivalent to <code>Text</code> nodes</span>, and <a
  href="#entity-references">entity reference nodes are treated as if
  they were expanded in place</a>.</p>

  <p>The <span title="space character">space characters</span> are
  always allowed between elements. User agents represent these
  characters between elements in the source markup as text nodes in
  the DOM.<!-- not a conf criteria since the parser now requires this
  --> Empty <span title="text node">text nodes</span> and <span
  title="text node">text nodes</span> consisting of just sequences of
  those characters are considered <dfn>inter-element
  whitespace</dfn>.</p>

  <p><span>Inter-element whitespace</span>, comment nodes, and
  processing instruction nodes must be ignored when establishing
  whether an element matches its content model or not, and must be
  ignored when following algorithms that define document and element
  semantics.</p>

  <p>An element <var title="">A</var> is said to be <dfn>preceeded or
  followed</dfn> by a second element <var title="">B</var> if <var
  title="">A</var> and <var title="">B</var> have the same parent node
  and there are no other element nodes or text nodes (other than
  <span>inter-element whitespace</span>) between them.</p>

  <p>Authors must only use <span>elements in the HTML namespace</span>
  in the contexts where they are allowed, as defined for each
  element. For XML compound documents, these contexts could be inside
  elements from other namespaces, if those elements are defined as
  providing the relevant contexts.</p>

  <div class="example">
   <p>The SVG specification defines the SVG <code>foreignObject</code>
   element as allowing foreign namespaces to be included, thus
   allowing compound documents to be created by inserting subdocument
   content under that element. <em>This</em> specification defines the
   XHTML <code>html</code> element as being allowed where subdocument
   fragments are allowed in a compound document. Together, these two
   definitions mean that placing an XHTML <code>html</code> element as
   a child of an SVG <code>foreignObject</code> element is
   conforming.</p>
  </div>


  <h4>Kinds of elements</h4>

  <p>Each element in HTML falls into zero or more categories that
  group elements with similar characteristics together. This
  specification uses the following categories:</p>

  <ul class="brief">
   <li><span>Metadata elements</span></li>
   <li><span>Sectioning elements</span></li>
   <li><span>Block-level elements</span></li>
   <li><span>Strictly inline-level content</span></li>
   <li><span>Structured inline-level elements</span></li>
   <li><span>Interactive elements</span></li>
   <li><span>Form control elements</span></li>
  </ul>

  <!-- XXX check that all the above got a section defining them,
  however briefly -->

  <!-- XXX check that the element definitions also link to those
  sections -->

  <p>Some elements have unique requirements and do not fit into any
  particular category.</p>

  <p>In addition, some elements represent various common concepts; for
  example, some elements represent <span>paragraphs</span>.</p>


  <h5><dfn>Block-level elements</dfn></h5>

  <p>Block-level elements are used for structural grouping of page
  content.</p>

  <p>There are several kinds of block-level elements:</p>

  <ul>

   <li>Some can only contain other block-level elements:
   <code>blockquote</code>, <code>section</code>,
   <code>article</code>, <code>header</code>.</li>

   <li>Some can only contain <span>inline-level content</span>:
   <code>p</code>, <code>h1</code>-<code>h6</code>,
   <code>address</code>.</li>

   <li>Some can contain either block-level elements or
   <span>inline-level content</span> (but not both):
   <code>nav</code>, <code>aside</code>, <code>footer</code>,
   <code>div</code>.</li>

   <li>Finally, some have very specific content models:
   <code>ul</code>, <code>ol</code>, <code>dl</code>,
   <code>table</code>, <code>script</code>.

   </li>

  </ul>

  <p>There are also elements that seem to be block-level but aren't,
  such as <code>body</code>, <code>li</code>, <code>dt</code>,
  <code>dd</code>, and <code>td</code>. These elements are allowed
  only in specific places, not simply anywhere that block-level
  elements are allowed.</p>

  <p>Some block-level elements play multiple roles. For instance, the
  <code>script</code> elements is allowed inside <code>head</code>
  elements and can also be used as <span>inline-level content</span>.
  Similarly, the <code>ul</code>, <code>ol</code>, <code>dl</code>,
  <code>table</code>, and <code>blockquote</code> elements play dual
  roles as both block-level and inline-level elements.</p>


  <h5><dfn>Inline-level content</dfn></h5>

  <p>Inline-level content consists of text and various elements to
  annotate the text, as well as some <span>embedded content</span>
  (such as images or sound clips).</p>

  <p>Inline-level content comes in various types:</p>

  <dl>

   <dt><dfn>Strictly inline-level content</dfn></dt>
   <dd>Text, <span>embedded content</span>, and elements that annotate
   the text without introducing structural grouping. For example:
   <code>a</code>, <code>meter</code>, <code>img</code>. Elements used
   in contexts allowing only strictly inline-level content must not
   have any descendants that are anything other than strictly
   inline-level content.</dd>

   <dt><dfn>Structured inline-level elements</dfn></dt>
   <dd>Block-level elements that can also be used as inline-level
   content. For example: <code>ol</code>, <code>blockquote</code>,
   <code>table</code>.</dd>

  </dl>

  <p>Some elements are defined to have as a content model
  <dfn>significant inline content</dfn>. This means that at least one
  descendant of the element must be <span>significant text</span> or
  <span>embedded content</span>.</p>

  <p>Unless an element's content model explicitly states that it must
  contain <span>significant inline content</span>, simply having no
  <span title="text node">text nodes</span> and no elements satisfies
  an element whose content model is some kind of inline content.</p>

  <p><dfn>Significant text</dfn>, for the purposes of determining the
  presence of <span>significant inline content</span>, consists of any
  character other than those falling in the <a
  href="http://unicode.org/Public/UNIDATA/UCD.html#General_Category_Values">Unicode
  categories</a> Zs, Zl, Zp, Cc, and Cf. <a
  href="#refsUNICODE">[UNICODE]</a></p>

  <div class="example">
   <p>The following three paragraphs are non-conforming because their
   content model is not satisfied (they all count as empty).</p>
   <pre>
&lt;p&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&amp;#x00A0;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;
 &lt;ol&gt;
  &lt;li&gt;&lt;/li&gt;
 &lt;/ol&gt;
&lt;/p&gt;
</pre>
  </div>

  <p><dfn>Embedded content</dfn> consists of elements that introduce
  content from other resources into the document, for example
  <code>img</code>. Embedded content elements can have <dfn>fallback
  content</dfn>: content that is to be used when the external resource
  cannot be used (e.g. because it is of an unsupported format). The
  element definitions state what the fallback is, if any.</p>


  <h5>Transparent content models</h5>

  <p>Some elements are described as <dfn>transparent</dfn> (they also
  have "transparent" as their content model). Transparent elements
  must only contain content that would still be conformant if all such
  transparent elements in the tree were replaced, in their parent
  element, by their children, retaining order.</p>

  <p>When a transparent element has no parent, then its content model
  must instead be treated as zero or more <span>block-level
  elements</span>, or <span>inline-level content</span> (but not
  both).</p>


  <h5><dfn>Determining if a particular element contains block-level
  elements or inline-level content</dfn></h5>

  <p>Some elements are defined to have content models that allow
  either <span>block-level elements</span> or <span>inline-level
  content</span>, but not both. For example, the <code>aside</code>
  and <code>li</code> elements.</p>

  <p>To establish whether such an element is being used as a
  block-level container or as an inline-level container, for example
  in order to determine if a document conforms to these requirements,
  user agents must look at the element's child nodes. If any of the
  child nodes are not allowed in block-level contexts, then the
  element is being used for <span>inline-level content</span>. If all
  the child nodes are allowed in a block-level context, then the
  element is being used for <span>block-level elements</span>.</p>

  <p>Whenever this search would examine a <span>transparent</span>
  element, the element's own child nodes must be examined instead,
  potentially recursing further if any of those are themselves
  transparent.</p>

  <div class="example">
   <p>For instance, in the following (non-conforming) XML fragment,
   the <code>li</code> element is being used as an inline-level
   element container, because the <code>meta</code> element is not
   allowed in a block-level context. (It doesn't matter, for the
   purposes of determining whether it is an inline-level or
   block-level context, that the <code>meta</code> element is not
   allowed in inline-level contexts either.)</p>
   <pre>&lt;ol&gt;
 &lt;li&gt;
  &lt;p&gt; Hello World &lt;/p&gt;
  &lt;meta title="this is an invalid example"/&gt;
 &lt;/li&gt;
&lt;/ol&gt;
</pre>
   <p>In the following fragment, the <code>aside</code> element is
   being used as a block-level container, because even though all the
   elements it contains could be considered inline-level elements,
   there are no nodes that can only be considered inline-level.</p>
   <pre>&lt;aside&gt;
 &lt;ol&gt;
  &lt;li&gt; ... &lt;/li&gt;
 &lt;/ol&gt;
 &lt;ul&gt;
  &lt;li&gt; ... &lt;/li&gt;
 &lt;/ul&gt;
&lt;/aside&gt;</pre>
   <p>On the other hand, in the following similar fragment, the
   <code>aside</code> element is an inline-level container, because
   the text ("Foo") can only be considered inline-level.</p>
   <pre>&lt;aside&gt;
 &lt;ol&gt;
  &lt;li&gt; ... &lt;/li&gt;
 &lt;/ol&gt;
 Foo
&lt;/aside&gt;</pre>
  </div>
  


  <h5><dfn>Interactive elements</dfn></h5>

  <!-- Don't change the above <dfn> or the text below without checking
  all cross-references. Some of them refer specifically to the
  activation behavior stuff. -->

  <p class="big-issue">Parts of this section should eventually be
  moved to DOM3 Events.</p> <!-- but see comment above -->

<!--
TESTS:
http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A%3Cp%20tabindex%3D1%3Etest%20%3Ca%20href%3D%22%22%3E%20%3Cem%3Etest%3C/em%3E%20%3C/a%3E%0A%3Cscript%3E%0A%20function%20test%20%28e%29%20%7B%20w%28e.type%20+%20%27%20on%20%27%20+%20e.target.tagName%20+%20%27%20through%20%27%20+%20e.currentTarget.tagName%29%3B%20%7D%0A%20document.getElementsByTagName%28%27a%27%29%5B0%5D.addEventListener%28%27click%27%2C%20test%2C%20false%29%3B%0A%20document.getElementsByTagName%28%27a%27%29%5B0%5D.addEventListener%28%27DOMActivate%27%2C%20test%2C%20false%29%3B%0A%20document.getElementsByTagName%28%27p%27%29%5B0%5D.addEventListener%28%27click%27%2C%20test%2C%20false%29%3B%0A%20document.getElementsByTagName%28%27p%27%29%5B0%5D.addEventListener%28%27DOMActivate%27%2C%20test%2C%20false%29%3B%0A%3C/script%3E%0A
http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20HTML%3E%0A%3Ca%20href%3Dhttp%3A//google.com/%20target%3Da%3EA%3C/a%3E%3Ca%20href%3Dhttp%3A//yahoo.com/%20target%3Db%3EB%3C/a%3E%3Cbr%3E%0A%3Ciframe%20name%3Da%3E%3C/iframe%3E%3Ciframe%20name%3Db%3E%3C/iframe%3E%0A%3Cscript%3E%0A%20var%20a%20%3D%20document.getElementsByTagName%28%27a%27%29%5B0%5D%3B%0A%20var%20b%20%3D%20document.getElementsByTagName%28%27a%27%29%5B1%5D%3B%0A%20a.appendChild%28b%29%3B%0A%3C/script%3E
http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20HTML%3E%0A%3Cform%20action%3D%22http%3A//google.com/%22%20onsubmit%3D%22w%28%27onsubmit%27%29%22%3E%3Cem%3EA%3C/em%3E%3C/form%3E%0A%3Cscript%3E%0Adocument.getElementsByTagName%28%27form%27%29%5B0%5D.attachEvent%28%27onsubmit%27%2C%20function%20%28%29%20%7B%20w%28%27submit%20fired%27%29%20%7D%29%3B%0Adocument.getElementsByTagName%28%27form%27%29%5B0%5D.fireEvent%28%27onsubmit%27%29%3B%0A%3C/script%3E
http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20HTML%3E%0A%3Cform%20action%3D%22http%3A//google.com/%22%3EX%3C/form%3E%0A%3Cscript%3E%0Avar%20evt%20%3D%20document.createEvent%28%22Events%22%29%3B%0Aevt.initEvent%28%22submit%22%2C%20true%2C%20true%29%3B%0Adocument.getElementsByTagName%28%27form%27%29%5B0%5D.dispatchEvent%28evt%29%3B%0A%3C/script%3E
-->

  <p>Certain elements in HTML can be activated, for instance
  <code>a</code> elements, <code>button</code> elements, or
  <code>input</code> elements when their <code>type</code> attribute
  is set to <code>radio</code>. Activation of those elements can
  happen in various (UA-defined) ways, for instance via the mouse or
  keyboard.</p>

  <p>When activation is performed via some method other than clicking
  the pointing device, the default action of the event that triggers
  the activation must, instead of being activating the element
  directly, be to <span>fire a <code title="">click</code>
  event</span> on the same element.</p>

  <p>The default action of this <code title="event-click">click</code>
  event, or of the real <code title="event-click">click</code> event
  if the element was activated by clicking a pointing device, must be
  to <span title="fire a DOMActivate event">fire a further <code
  title="event-DOMActivate">DOMActivate</code> event</span> at the
  same element, whose own default action is to go through all the
  elements the <code title="event-DOMActivate">DOMActivate</code>
  event bubbled through (starting at the target node and going towards
  the <code>Document</code> node), looking for an element with an
  <span>activation behavior</span>; the first element, in reverse tree
  order, to have one, must have its activation behavior executed.</p>

  <p class="note">The above doesn't happen for arbitrary synthetic
  events dispatched by author script. However, the <code
  title="dom-click">click()</code> method can be used to make it
  happen programmatically.</p>

  <p>For certain form controls, this process is complicated further by
  <a
  href="http://www.whatwg.org/specs/web-forms/current-work/#the-click">changes
  that must happen around the click event</a>. <a
  href="#refsWF2">[WF2]</a></p> <!-- XXX WF2: when this is merged into
  this spec, update xrefs -->

  <p class="note">Most interactive elements have content models that
  disallow nesting interactive elements.</p>

<!--
   <li><span>Form control elements</span></li> XXX
-->


  <h5>Paragraphs</h5>

  <p>A <dfn>paragraph</dfn> is typically a block of text with one or
  more sentences that discuss a particular topic, as in typography,
  but can also be used for more general thematic grouping. For
  instance, an address is also a paragraph, as is a part of a form, a
  byline, or a stanza in a poem.</p>

  <p>Paragraphs can be represented by several elements. The
  <code>address</code> element always represents a paragraph of
  contact information for its section, the <code>aside</code>,
  <code>nav</code>, <code>footer</code>, <code>li</code>, and
  <code>dd</code> elements represent paragraphs with various specific
  semantics when they are <span title="Determining if a particular
  element contains block-level elements or inline-level content">used
  as inline-level content containers</span>, the <code>figure</code>
  element represents a paragraph in the form of <span>embedded
  content</span>, and the <code>p</code> element represents all the
  other kinds of paragraphs, for which there are no dedicated
  elements.</p>


  <h3>Global attributes</h3>

  <p>The following attributes are common to and may be specified on
  all <span>HTML elements</span> (even those not defined in this
  specification):</p>

  <dl class="element">
   <dt>Global attributes:</dt>
   <dd><code title="attr-class">class</code></dd>
   <dd><code title="attr-contenteditable">contenteditable</code></dd>
   <dd><code title="attr-contextmenu">contextmenu</code></dd>
   <dd><code title="attr-dir">dir</code></dd>
   <dd><code title="attr-draggable">draggable</code></dd>
   <dd><code title="attr-id">id</code></dd>
   <dd><code title="attr-lang">lang</code></dd>
   <dd><code title="attr-tabindex">tabindex</code></dd>
   <dd><code title="attr-title">title</code></dd>
  </dl>

  <p>In addition, the following <span>event handler content
  attributes</span> may be specified on any <span>HTML
  element</span>:</p>

  <ul class="brief">
   <li><code title="handler-onabort">onabort</code></li>
   <li><code title="handler-onbeforeunload">onbeforeunload</code></li>
   <li><code title="handler-onblur">onblur</code></li>
   <li><code title="handler-onchange">onchange</code></li>
   <li><code title="handler-onclick">onclick</code></li>
   <li><code title="handler-oncontextmenu">oncontextmenu</code></li>
   <li><code title="handler-ondblclick">ondblclick</code></li>
   <li><code title="handler-ondrag">ondrag</code></li>
   <li><code title="handler-ondragend">ondragend</code></li>
   <li><code title="handler-ondragenter">ondragenter</code></li>
   <li><code title="handler-ondragleave">ondragleave</code></li>
   <li><code title="handler-ondragover">ondragover</code></li>
   <li><code title="handler-ondragstart">ondragstart</code></li>
   <li><code title="handler-ondrop">ondrop</code></li>
   <li><code title="handler-onerror">onerror</code></li>
   <li><code title="handler-onfocus">onfocus</code></li>
   <li><code title="handler-onkeydown">onkeydown</code></li>
   <li><code title="handler-onkeypress">onkeypress</code></li>
   <li><code title="handler-onkeyup">onkeyup</code></li>
   <li><code title="handler-onload">onload</code></li>
   <li><code title="handler-onmessage">onmessage</code></li>
   <li><code title="handler-onmousedown">onmousedown</code></li>
   <li><code title="handler-onmousemove">onmousemove</code></li>
   <li><code title="handler-onmouseout">onmouseout</code></li>
   <li><code title="handler-onmouseover">onmouseover</code></li>
   <li><code title="handler-onmouseup">onmouseup</code></li>
   <li><code title="handler-onmousewheel">onmousewheel</code></li>
   <li><code title="handler-onresize">onresize</code></li>
   <li><code title="handler-onscroll">onscroll</code></li>
   <li><code title="handler-onselect">onselect</code></li>
   <li><code title="handler-onsubmit">onsubmit</code></li>
   <li><code title="handler-onunload">onunload</code></li>
  </ul>


  <h4>The <dfn title="attr-id"><code>id</code></dfn> attribute</h4>

  <p>The <code title="attr-id">id</code> attribute represents its
  element's unique identifier. The value must be unique in the subtree
  within which the element finds itself and must contain at least one
  character.</p>

  <p>If the value is not the empty string, user agents must associate
  the element with the given value (exactly) for the purposes of ID
  matching within the subtree the element finds itself (e.g. for
  selectors in CSS or for the <code>getElementById()</code> method in
  the DOM).</p>

  <p>Identifiers are opaque strings. Particular meanings should not be
  derived from the value of the <code title="attr-id">id</code>
  attribute.</p>

  <p>This specification doesn't preclude an element having multiple
  IDs, if other mechanisms (e.g. DOM Core methods) can set an
  element's ID in a way that doesn't conflict with the <code
  title="attr-id">id</code> attribute.</p>

  <p>The <dfn title="dom-id"><code>id</code></dfn> DOM attribute must
  <span>reflect</span> the <code title="attr-id">id</code> content
  attribute.</p>


  <h4>The <dfn title="attr-title"><code>title</code></dfn> attribute</h4>

  <p>The <code title="attr-title">title</code> attribute represents
  advisory information for the element, such as would be appropriate
  for a tooltip. On a link, this could be the title or a description
  of the target resource; on an image, it could be the image credit or
  a description of the image; on a paragraph, it could be a footnote
  or commentary on the text; on a citation, it could be further
  information about the source; and so forth. The value is text.</p>

  <p>If this attribute is omitted from an element, then it implies
  that the <code title="attr-title">title</code> attribute of the
  nearest ancestor with a <code title="attr-title">title</code>
  attribute set is also relevant to this element. Setting the
  attribute overrides this, explicitly stating that the advisory
  information of any ancestors is not relevant to this element.
  Setting the attribute to the empty string indicates that the element
  has no advisory information.</p>

  <p>Some elements, such as <code>link</code> and <code>dfn</code>,
  define additional semantics for the <code
  title="attr-title">title</code> attribute beyond the semantics
  described above.</p>

  <p>The <dfn title="dom-title"><code>title</code></dfn> DOM attribute
  must <span>reflect</span> the <code title="attr-title">title</code>
  content attribute.</p>


  <h4>The <dfn title="attr-lang"><code>lang</code></dfn> (HTML only)
  and <dfn title="attr-xml-lang"><code>xml:lang</code></dfn> (XML
  only) attributes</h4>

  <p>The <code title="attr-lang">lang</code> attribute specifies the
  primary <dfn>language</dfn> for the element's contents and for any
  of the element's attributes that contain text. Its value must be a
  valid RFC 3066 language code, or the empty string. <a
  href="#refsRFC3066">[RFC3066]</a></p>

  <p>The <code title="attr-xml-lang">xml:lang</code> attribute is
  defined in XML. <a href="#refsXML">[XML]</a></p>

  <p>If these attributes are omitted from an element, then it implies
  that the language of this element is the same as the language of the
  parent element. Setting the attribute to the empty string indicates
  that the primary language is unknown.</p>

  <p>The <code title="attr-lang">lang</code> attribute may only be
  used on elements of <span>HTML documents</span>.  Authors must not
  use the <code title="attr-lang">lang</code> attribute in <span>XML
  documents</span>.</p>

  <p>The <code title="attr-xml-lang">xml:lang</code> attribute may
  only be used on elements of <span>XML documents</span>.  Authors
  must not use the <code title="attr-xml-lang">xml:lang</code>
  attribute in <span>HTML documents</span>.</p> <!-- technically this
  is redundant with the XML spec -->

  <p>To determine the language of a node, user agents must look at the
  nearest ancestor element (including the element itself if the node
  is an element) that has a <code title="attr-lang">lang</code> or
  <code title="attr-xml-lang">xml:lang</code> attribute set. That
  specifies the language of the node.</p>

  <p>If both the <code title="attr-xml-lang">xml:lang</code> attribute
  and the <code title="attr-lang">lang</code> attribute are set on an
  element, user agents must use the <code
  title="attr-xml-lang">xml:lang</code> attribute, and the <code
  title="attr-lang">lang</code> attribute must be <span
  title="ignore">ignored</span> for the purposes of determining the
  element's language.</p>

  <p>If no explicit language is given for the <span>root
  element</span>, then language information from a higher-level
  protocol (such as HTTP), if any, must be used as the final
  fallback language. In the absence of any language information, the
  default value is unknown (the empty string).</p>

  <p>User agents may use the element's language to determine proper
  processing or rendering (e.g. in the selection of appropriate
  fonts or pronounciations, or for dictionary selection). <!--User
  agents must not use the element's language to determine text
  directionality. (commented out because text directionality is a
  rendering-level concern.)--></p>

  <p>The <dfn title="dom-lang"><code>lang</code></dfn> DOM attribute
  must <span>reflect</span> the <code title="attr-lang">lang</code>
  content attribute.</p>


  <h4>The <dfn title="attr-dir"><code>dir</code></dfn> attribute</h4>

  <p>The <code title="attr-dir">dir</code> attribute specifies the
  element's text directionality. The attribute is an <span>enumerated
  attribute</span> with the keyword <code title="">ltr</code> mapping
  to the state <em>ltr</em>, and the keyword <code title="">rtl</code>
  mapping to the state <em>rtl</em>. The attribute has no
  defaults.</p>

  <p>If the attribute has the state <em>ltr</em>, the element's
  directionality is left-to-right. If the attribute has the state
  <em>rtl</em>, the element's directionality is
  right-to-left. Otherwise, the element's directionality is the same
  as its parent.</p>

  <p>The processing of this attribute depends on the presentation
  layer. For example, CSS 2.1 defines a mapping from this attribute to
  the CSS 'direction' and 'unicode-bidi' properties, and defines
  rendering in terms of those properties.</p>

  <p>The <dfn title="dom-dir"><code>dir</code></dfn> DOM attribute
  must <span>reflect</span> the <code title="attr-dir">dir</code>
  content attribute.</p>


  <h4 id="classes">Classes</h4>

  <p>Every <span>HTML element</span> may have a <dfn
  title="attr-class"><code>class</code></dfn> attribute specified.</p>

  <p>The attribute, if specified, must have a value that is an
  <span>unordered set of space-separated tokens</span> representing
  the various classes that the element belongs to.</p>

  <p>The classes that an HTML element has assigned to it consists of
  all the classes returned when the value of the <code
  title="attr-class">class</code> attribute is <span title="split a
  string on spaces">split on spaces</span>.</p>

  <p class="note">Assinging classes to an element affects class
  matching in selectors in CSS, the <code
  title="dom-document-getElementsByClassName">getElementsByClassName()</code>
  method in the DOM, and other such features.</p>

  <p>Authors may use any value in the <code
  title="attr-class">class</code> attribute, but are encouraged to use
  the predefined values defined in this specification where
  appropriate.</p>

  <p>Classes that are not defined in this specification can be defined
  as <span title="concept-class-extensions">extensions</span>, as
  described below.</p>

  <p>Authors should bear in mind that using the <code
  title="attr-class">class</code> attribute does not convey any
  additional meaning to the element unless the classes used have been
  defined by this specification or registered in the Wiki. There is no
  semantic difference between an element <em>with</em> a class
  attribute and one <em>without</em>. Authors that use classes that
  are not so defined should make sure, therefore, that their documents
  make as much sense once all <code title="attr-class">class</code>
  attributes have been removed as they do with the attributes
  present. User agents should not derive particular meanings from <code
  title="attr-class">class</code> attribute values that are neither
  defined by this specification nor registered in the Wiki.</p>

  <p>The <dfn title="dom-className"><code>className</code></dfn> and
  <dfn title="dom-classList"><code>classList</code></dfn> DOM
  attributes must both <span>reflect</span> the <code
  title="attr-class">class</code> content attribute.</p>


  <h5>Predefined class names</h5>

  <p>The following table summarises the class names that are defined
  by this specification. This table is non-normative; the actual
  definitions for the class names are given in the next few
  sections.</p>

  <table>
   <thead>
    <tr>
     <th>Class name</th>
     <th>Applicable elements</th>
     <th>Brief description</th>
    </tr>
   </thead>
   <tbody>

    <tr>
     <td><code title="class-copyright">copyright</code></td>
     <td><code>p</code>, <code>span</code></td>
     <td>Indicates that the element contains the copyright for the
     document.</td>
    </tr>

    <tr>
     <td><code title="class-error">error</code></td>
     <td><code>p</code>, <code>section</code>, <code>span</code>,
     <code>strong</code></td>
     <td>Indicates that the element contains an error message, e.g. in
     an error message to the user in an interactive application, or an
     error notification in the report of a conformance checker.</td>
    </tr>

    <tr>
     <td><code title="class-example">example</code></td>
     <td><code>aside</code>, <code>figure</code>, <code>p</code>,
     <code>section</code>, <code>span</code></td>
     <td>Indicates that the element contains some sample material or a
     worked example illustrating the neighboring content.</td>
    </tr>

    <tr>
     <td><code title="class-issue">issue</code></td>
     <td><code>aside</code>, <code>p</code>, <code>span</code></td>
     <td>Indicates that the element contains a point in dispute or a
     problem with the neighboring content that needs resolving. (Thus,
     this is typically only found in works-in-progress or drafts, not
     in completed documents.)</td>
    </tr>

    <tr>
     <td><code title="class-note">note</code></td>
     <td><code>aside</code>, <code>p</code>, <code>span</code></td>
     <td>Indicates that the element contains an explanatory note or
     clarification.</td>
    </tr>

    <tr>
     <td><code title="class-search">search</code></td>
     <td><code>aside</code>, <code>body</code>, <code>form</code>,
     <code>p</code>, <code>section</code>, <code>span</code></td>
     <td>Indicates that the element's primary purpose is to provide
     the user with an interface to perform a search (e.g. of the
     site's pages or of a database).</td>
    </tr>

    <tr>
     <td><code title="class-warning">warning</code></td>
     <td><code>article</code>, <code>aside</code>, <code>body</code>,
     <code>figure</code>, <code>p</code>, <code>section</code>,
     <code>span</code>, <code>strong</code></td>
     <td>Indicates that the element contains a warning or admonition.</td>
    </tr>

   </tbody>
  </table>


  <h6>Class name "<dfn title="class-copyright"><code>copyright</code></dfn>"</h6>

  <p>The <code title="class-copyright">copyright</code> class name
  indicates that the element contains the copyright for the
  document.</p>

  <p>It must only be used on the following elements: <code>p</code>,
  <code>span</code></p>



  <h6>Class name "<dfn title="class-error"><code>error</code></dfn>"</h6>

  <p>The <code title="class-error">error</code> class name indicates
  that the element contains an error message, e.g. in an error message
  to the user in an interactive application, or an error notification
  in the report of a conformance checker.</p>

  <p>It must only be used on the following elements: <code>p</code>,
  <code>section</code>, <code>span</code>, <code>strong</code></p>

  <p>It cannot be used on the <code>body</code> element; if the whole
  document is an error message then the appropriate metadata should be
  included at the network layer (e.g. with HTTP using the 4xx and 5xx
  status codes).</p>



  <h6>Class name "<dfn title="class-example"><code>example</code></dfn>"</h6>

  <p>The <code title="class-example">example</code> class name
  indicates that the element contains some sample material or a worked
  example illustrating the neighboring content.</p>

  <p>It must only be used on the following elements:
  <code>aside</code>, <code>figure</code>, <code>p</code>,
  <code>span</code></p>



  <h6>Class name "<dfn title="class-issue"><code>issue</code></dfn>"</h6>

  <p>The <code title="class-issue">issue</code> class name indicates
  that the element contains a point in dispute or a problem with the
  neighboring content that needs resolving. (Thus, this is typically
  only found in works-in-progress or drafts, not in completed
  documents.)</p>

  <p>It must only be used on the following elements:
  <code>aside</code>, <code>p</code>, <code>span</code></p>



  <h6>Class name "<dfn title="class-note"><code>note</code></dfn>"</h6>

  <p>The <code title="class-note">note</code> class name indicates
  that the element contains an explanatory note or clarification.</p>

  <p>It must only be used on the following elements:
  <code>aside</code>, <code>p</code>, <code>span</code></p>



  <h6>Class name "<dfn title="class-search"><code>search</code></dfn>"</h6>

  <p>The <code title="class-search">search</code> class name indicates
  that the element's primary purpose is to provide the user with an
  interface to perform a search (e.g. of the site's pages or of a
  database).</p>

  <p>It must only be used on the following elements:
  <code>aside</code>, <code>body</code>, <code>form</code>,
  <code>p</code>, <code>section</code>, <code>span</code></p>

<!--
  <p>A <code>form</code> element inside a <code>nav</code> element
  must be treated by user agents as if it had a <code>search</code> class.</p>
(but this musn't affect the DOM, or CSS, etc)
-->


  <h6>Class name "<dfn title="class-warning"><code>warning</code></dfn>"</h6>

  <p>The <code title="class-warning">warning</code> class name
  indicates that the element contains a warning or admonition.</p>

  <p>It must only be used on the following elements:
  <code>article</code>, <code>aside</code>, <code>body</code>,
  <code>figure</code>, <code>p</code>, <code>section</code>,
  <code>span</code>, <code>strong</code></p>



  <h5>Other classes</h5>

  <p><dfn title="concept-class-extensions">Extensions to the
  predefined set of class keywords</dfn> may be registered in the <a
  href="http://wiki.whatwg.org/wiki/ClassExtensions">WHATWG Wiki
  ClassExtensions page</a>.

  <p>Anyone is free to edit the WHATWG Wiki ClassExtensions page at
  any time to add a type. New classes must be specified with the
  following information:</p>

  <dl>

   <dt>Keyword</dt>

   <dd><p>The actual class name being defined. The class name should
   not be confusingly similar to any other defined class name
   (e.g. differing only in case).</p></dd>


   <dt>Applicable elements</dt>

   <dd><p>A list of HTML elements to which the class applies, or one
   of the following values:</p>

    <dl>

     <dt>Metadata elements</dt>

     <dd>Meaning any element described as being a <span
     title="metadata elements">metadata element</span>.</dd>

     <dt>Sectioning elements</dt>

     <dd>Meaning any element described as being a <span
     title="sectioning elements">sectioning element</span>.</dd>

     <dt>Block-level elements</dt>

     <dd>Meaning any element described as being a <span
     title="block-level elements">block-level element</span>, but only
     when that element is actually <span title="Determining if a
     particular element contains block-level elements or inline-level
     content">being used</span> as a block-level element, and not,
     say, as a structured inline-level element.</dd>

     <dt>Strictly inline-level elements</dt>

     <dd>Meaning any element described as being <span>strictly
     inline-level content</span>.</dd>

     <dt>Structured inline-level elements</dt>

     <dd>Meaning any element described as being a <span
     title="structured inline-level elements">structured inline-level
     element</span>.</dd>

     <dt>Interactive</dt>

     <dd>Meaning any element described as being an <span
     title="interactive elements">interactive element</span>.</dd>

     <dt>Embedded content elements</dt>

     <dd>Meaning any element described as being <span>embedded
     content</span>.</dd>

     <dt>All elements</dt>

     <dd>Meaning any element.</dd>

    </dl>

    <p>A document must not use a class defined in the Wiki on an
    element other than the elements that the Wiki says that class name
    is allowed on.</p>

   </dd>


   <dt>Brief description</dt>

   <dd><p>A short description of what the keyword's meaning is.</p></dd>


   <dt>Link to more details</dt>

   <dd><p>A link to a more detailed description of the keyword's
   semantics and requirements. It could be another page on the Wiki,
   or a link to an external page.</p></dd>


   <dt>Synonyms</dt>

   <dd><p>A list of other keyword values that have exactly the same
   processing requirements. Authors should not use the values defined
   to be synonyms, they are only intended to allow user agents to
   support legacy content.</p></dd>


   <dt>Status</dt>

   <dd>

    <p>One of the following:</p>

    <dl>

     <dt>Proposal</dt>

     <dd>The keyword has not received wide peer review and
     approval. Someone has proposed it and is using it.</dd>

     <dt>Accepted</dt>

     <dd>The keyword has received wide peer review and approval. It
     has a specification that unambiguously defines how to handle
     pages that use the keyword, including when they use them in
     incorrect ways. Pages should use the keyword to mark up the
     semantic that it describes.</dd>

     <dt>Unendorsed</dt>

     <dd>The keyword has received wide peer review and it has been
     found wanting. Existing pages are using this keyword, but new
     pages should avoid it. The "brief description" and "link to more
     details" entries will give details of what authors should use
     instead.</dd>

    </dl>

    <p>If a keyword is added with the "proposal" status and found to
    be redundant with existing values, it should be removed and listed
    as a synonym for the existing value.</p>

   </dd>

  </dl>

  <p>Conformance checkers must use the information given on the WHATWG
  Wiki ClassExtensions page to establish if a value not explicitly
  defined in this specification is defined, and if so, whether it is
  being used on the right elements. When an author uses a new class
  name not defined by either this specification or the Wiki page,
  conformance checkers may offer to add the value to the Wiki, with
  the details described above, with the "proposal" status.</p>

  <p>This specification does not define how new values will get
  approved. It is expected that the Wiki will have a community that
  addresses this.</p>



  <h3><dfn>Interaction</dfn></h3>

<!--
ELEMENT
           attribute long <span title="dom-tabindex">tabindex</span>;
  void <span title="dom-click">click</span>();
  void <span title="dom-focus">focus</span>();
  void <span title="dom-blur">blur</span>();

DOCUMENT
  readonly attribute <span>Element</span> <span title="dom-document-activeElement">activeElement</span>;
  readonly attribute boolean <span title="dom-document-hasFocus">hasFocus</span>;
-->


  <h4>Activation</h4>

  <p>The <dfn title="dom-click">click()</dfn> method must <span>fire a
  <code>click</code> event</span> at the element, whose default action
  is the <span title="fire a DOMActivate event">firing of a further
  <code title="event-DOMActivate">DOMActivate</code> event</span> at
  the same element, whose own default action is to go through all the
  elements the <code title="event-DOMActivate">DOMActivate</code>
  event bubbled through (starting at the target node and going towards
  the <code>Document</code> node), looking for an element with an
  <span>activation behavior</span>; the first element, in reverse tree
  order, to have one, must have its activation behavior executed.</p>


  <h4>Focus</h4>

  <p>When an element is <em>focused</em>, key events received by the
  document must be targeted at that element. There is always an
  element focused; in the absence of other elements being focused, the
  document's root element is it.</p>

  <p>Which element within a document currently has focus is
  independent of whether or not the document itself has the <em>system
  focus</em>.</p>

  <p>Some focusable elements might take part in <em>sequential focus
  navigation</em>.</p>


  <h5 id="focus-management">Focus management</h5>

  <p>The <dfn title="dom-focus"><code>focus()</code></dfn> and <dfn
  title="dom-blur"><code>blur()</code></dfn> methods must focus and
  unfocus the element respectively, if the element is focusable.</p>

  <p>Some elements, most notably <code>area</code>, can correspond to
  more than one distinct focusable area. When such an element is
  focused using the <code title="dom-focus">focus()</code> method, the
  first such region in tree order is the one that must be focused.</p>

  <p class="big-issue">Well that clearly needs more.</p>
  <!-- XXX e.g. should the click, focus, blur methods be recursible? -->

  <p>The <dfn
  title="dom-document-activeElement"><code>activeElement</code></dfn>
  attribute must return the element in the document that has focus. If
  no element specifically has focus, this must return the root
  element.</p>

  <p>The <dfn
  title="dom-document-hasFocus"><code>hasFocus</code></dfn> attribute
  must return true if the document, one of its nested <span
  title="browsing context">browsing contexts</span>, or any element in
  the document or its browsing contexts currently has the system
  focus.</p>


  <h5>Sequential focus navigation</h5>

  <p class="issue">This section on the <code>tabindex</code> attribute
  needs to be checked for backwards-compatibility.</p>

  <p>The <dfn title="attr-tabindex"><code>tabindex</code></dfn>
  attribute specifies the relative order of elements for the purposes
  of sequential focus navigation. The name "tab index" comes from the
  common use of the "tab" key to navigate through the focusable
  elements. The term "tabbing" refers to moving forward through the
  focusable elements.</p>

  <p>The <code title="attr-tabindex">tabindex</code> attribute, if
  specified, must have a value that is a <span>valid
  integer</span>.</p>

  <p>If the attribute is specified, it must be parsed using the
  <span>rules for parsing integers</span>. If parsing the value
  returns an error, the attribute is ignored for the purposes of focus
  management (as if it wasn't specified).</p>

  <p>A positive integer or zero specifies the index of the element in
  the current scope's tab order. Elements with the same index are
  sorted in <span>tree order</span> for the purposes of tabbing.</p>

  <p id="negative-tabindex">A negative integer specifies that the
  element should be removed from the tab order. If the element does
  normally take focus, it may still be focused using other means (e.g.
  it could be focused by a click).</p>

  <p>If the attribute is absent (or invalid), then the user agent must
  treat the element as if it had the value 0 or the value -1, based on
  platform conventions.</p>

  <p class="example">For example, a user agent might default
  <code>textarea</code> elements to 0, and <code>button</code>
  elements to -1, making text fields part of the tabbing cycle but
  buttons not.</p>

  <p>When an element that does not normally take focus (i.e. whose
  default value would be -1) has the <code
  title="attr-tabindex">tabindex</code> attribute specified with a
  positive value, then it should be added to the tab order and should
  be made focusable. When focused, the element matches the CSS
  <code>:focus</code> pseudo-class and key events are dispatched on
  that element in response to keyboard input.</p>

  <p>The <dfn title="dom-tabIndex"><code>tabIndex</code></dfn> DOM
  attribute reflects the value of the <code
  title="attr-tabIndex">tabIndex</code> content attribute. If the
  attribute is not present (or has an invalid value) then the DOM
  attribute must return the UA's default value for that element, which
  will be either 0 (for elements in the tab order) or -1 (for elements
  not in the tab order).</p>



<!--XXX
  <h5>The <dfn><code>DocumentFocus</code></dfn> interface</h5>

  <p>The <code>DocumentFocus</code> interface contains methods for
  moving focus around the document. It can be obtained from objects
  that implement the <code>Document</code> interface using
  binding-specific casting methods.</p>

  <pre class="idl">interface <dfn>DocumentFocus</dfn> {
  void moveFocusForward();
  void moveFocusBackward();
  void moveFocusUp();
  void moveFocusRight();
  void moveFocusDown();
  void moveFocusLeft();
};</pre>

  <p>The <dfn><code>currentFocus</code></dfn> attribute returns the
  element to which key events will be sent when the document receives
  key events.</p>

  <p>The <dfn><code>moveFocusForward</code></dfn> method uses the
  <code>'nav-index'</code> property and the <code>tabindex</code>
  attribute to find the next focusable element and focuses it.</p>

  <p>The <dfn><code>moveFocusBackward</code></dfn> method uses the
  <code>'nav-index'</code> property and the <code>tabindex</code>
  attribute to find the previous focusable element and focuses
  it.</p>

  <p>The <dfn><code>moveFocusUp</code></dfn> method uses the
  <code>'nav-up'</code> property and the <code>tabindex</code>
  attribute to find an appropriate focusable element and focuses
  it.</p>

  <p>In a similar manner, the <dfn><code>moveFocusRight</code></dfn>,
  <dfn><code>moveFocusDown</code></dfn>, and
  <dfn><code>moveFocusLeft</code></dfn> methods use the
  <code>'nav-right'</code>, <code>'nav-down'</code>, and
  <code>'nav-left'</code> properties (respectively), and the
  <code>tabindex</code> attribute, to find an appropriate focusable
  element and focus it.</p>

  <p>The <code>'nav-index'</code>, <code>'nav-up'</code>,
  <code>'nav-right'</code>, <code>'nav-down'</code>, and
  <code>'nav-left'</code> properties are defined in <a
  href="#refsCSS3UI">[CSS3UI]</a>.</p>

Other things to look at are IE's focus APIs (document.activeElement,
document.hasFocus, HTMLElement.setActive(), onBeforeActivate,
onActivate, onBeforeDeactivate, onDeactivate, document.hasFocus):
   https://bugzilla.mozilla.org/show_bug.cgi?id=296471
   https://bugzilla.mozilla.org/show_bug.cgi?id=296469
   http://msdn.microsoft.com/workshop/author/dhtml/reference/properties/activeelement.asp
   http://msdn.microsoft.com/workshop/author/dhtml/reference/methods/setactive.asp
   http://msdn.microsoft.com/workshop/author/dhtml/reference/events/onbeforeactivate.asp
   http://msdn.microsoft.com/workshop/author/dhtml/reference/methods/focus.asp
-->




  <h3>The root element</h3>

  <h4>The <dfn><code>html</code></dfn> element</h4>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the root element of a document.</dd>
   <dd>Wherever a subdocument fragment is allowed in a compound document.</dd>
   <dt>Content model:</dt>
   <dd>A <code>head</code> element followed by a <code>body</code> element.</dd>
<!--XXX
Steven Pemberton was as always, a remarkable speaker, but his answer
to my question leaves me a very bad taste. Basically, I asked him why
XHTML2 preserves the useless head and body element. The answer was in
substance "because this is a compromise". Ah. So XHTML2 preserves two
useless elements that add potential dangers to the interpretation and
styling of documents because it's a compromise. Getting rid of head
would allow to attach directly the document's metadata to the root
element of the document, making much more sense than a head element.
Having a head element also preserves the ridiculous
engraved-in-the-marble "head contents are not rendered". Body is
dangerous because it's another box between the document and the
contents; you all have written a blog template with a <div
class="main"> or <div class="content">. Why do we also need a body?
 - http://www.glazman.org/weblog/dotclear/index.php?2005/05/27/1055-adam-2
-->
   <dt>Element-specific attributes:</dt>
   <dd>None (but see prose).</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>html</code> element represents the root of an HTML
  document.</p>

  <p>Though it has absolutely no effect and no meaning, the
  <code>html</code> element, in <span>HTML documents</span>, may have
  an <code title="">xmlns</code> attribute specified, if, and only if,
  it has the exact value
  "<code>http://www.w3.org/1999/xhtml</code>". This does not apply to
  <span>XML documents</span>.</p>

  <p class="note">In HTML, the <code title="">xmlns</code> attribute
  has absolutely no effect. It is basically a talisman. It is allowed
  merely to make migration to and from XHTML mildly easier. When
  parsed by an <span>HTML parser</span>, the attribute ends up in the
  null namespace, not the "<code>http://www.w3.org/2000/xmlns/</code>"
  namespace like namespace declaration attributes in XML do.</p>

  <p class="note">In XML, an <code title="">xmlns</code> attribute is
  part of the namespace declaration mechanism, and an element cannot
  actually have an <code title="">xmlns</code> attribute in the null
  namespace specified.</p>


  <h3>Document metadata</h3>

  <p>Document metadata is represented by <dfn>metadata elements</dfn>
  in the document's <code>head</code> element.</p>

  <h4>The <dfn><code>head</code></dfn> element</h4>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the first element in an <code>html</code> element.</dd>
   <dt>Content model:</dt>
   <dd>In any order, exactly one <code>title</code> element,
   optionally one <code>base</code> element (HTML only), and zero or
   more other <span>metadata elements</span> (in particular,
   <code>link</code>, <code>meta</code>, <code>style</code>, and
   <code>script</code>).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>head</code> element collects the document's
  metadata.</p>


  <h4>The <dfn><code>title</code></dfn> element</h4>

  <p><span title="metadata elements">Metadata element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element containing no other <code>title</code> elements.</dd>
   <dt>Content model:</dt>
   <dd>Text (for details, see prose).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>title</code> element represents the document's title or
  name. Authors should use titles that identify their documents even
  when they are used out of context, for example in a user's history
  or bookmarks, or in search results. The document's title is often
  different from its first header, since the first header does not
  have to stand alone when taken out of context.</p>

  <div class="example">

   <p>Here are some examples of appropriate titles, contrasted with
   the top-level headers that might be used on those same pages.</p>

   <pre>  &lt;title>Introduction to The Mating Rituals of Bees&lt;/title>
    ...
  &lt;h1>Introduction&lt;/h1>
  &lt;p>This companion guide to the highly successful
  &lt;cite>Introduction to Medieval Bee-Keeping&lt;/cite> book is...
</pre>

   <p>The next page might be a part of the same site. Note how the
   title describes the subject matter unambiguously, while the first
   header assumes the reader knowns what the context is and therefore
   won't wonder if the dances are Salsa or Waltz:</p>

   <pre>  &lt;title>Dances used during bee mating rituals&lt;/title>
    ...
  &lt;h1>The Dances&lt;/h1></pre>

  </div>

  <p>The <code>title</code> element must not contain any
  elements.</p>

  <p>The string to use as the document's title is given by the <code
  title="dom-document-title">document.title</code> DOM attribute. User
  agents should use the document's title when referring to the
  document in their user interface.</p>


  <h4>The <dfn><code>base</code></dfn> element</h4>

  <p><span title="metadata elements">Metadata element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element, before any elements that use
   relative URIs, and only if there are no other <code>base</code>
   elements anywhere in the document. Only in <span>HTML
   documents</span> (never in <span>XML documents</span>).</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-base-href">href</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLBaseElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-base-href">href</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>base</code> element allows authors to specify the
  document's base URI for the purposes of resolving relative URIs.</p>

  <p>The <dfn title="attr-base-href"><code>href</code></dfn> content
  attribute, if specified, must contain a URI (or IRI).</p>

  <p>User agents must use the value of the <code
  title="att-base-href">href</code> attribute on the first
  <code>base</code> element in the document as the document entity's
  base URI for the purposes of section 5.1.1 of RFC 2396
  ("Establishing a Base URI": "Base URI within Document Content"). <a
  href="#refsRFC2396">[RFC2396]</a> Note that this base URI from RFC
  2396 is referred to by the algorithm given in XML Base, which <a
  href="#xmlBase">is a normative part of this specification</a>.</p>

  <p>If the base URI given by this attribute is a relative URI, it
  must be resolved relative to the higher-level base URIs (i.e. the
  base URI from the encapsulating entity or the URI used to retrieve
  the entity) to obtain an absolute base URI.</p>

  <p>The <code title="attr-base-href">href</code> content attribute
  must be reflected by the DOM <dfn
  title="dom-base-href"><code>href</code></dfn> attribute.</p>

  <p>Authors must not use the <code>base</code> element in <span>XML
  documents</span>. Authors should instead use the
  <code>xml:base</code> attribute. <a
  href="#refsXMLBASE">[XMLBASE]</a></p>

  <p class="big-issue"><dfn
  title="attr-base-target"><code>target</code></dfn> attribute?</p>


  <h4>The <dfn><code>link</code></dfn> element</h4>

  <p><span title="metadata elements">Metadata element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-link-href">href</code> (required)</dd>
   <dd><code title="attr-link-rel">rel</code> (required)</dd>
   <dd><code title="attr-link-media">media</code></dd>
   <dd><code title="attr-link-hreflang">hreflang</code></dd>
   <dd><code title="attr-link-type">type</code></dd>
   <dd>Also, the <code title="attr-link-title">title</code> attribute has special semantics on this element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLLinkElement</dfn> : <span>HTMLElement</span> {
           attribute boolean <span title="dom-link-disabled">disabled</span>;
           attribute DOMString <span title="dom-link-href">href</span>;
           attribute DOMString <span title="dom-link-rel">rel</span>;
  readonly attribute DOMTokenList <span title="dom-link-relList">relList</span>;
           attribute DOMString <span title="dom-link-media">media</span>;
           attribute DOMString <span title="dom-link-hreflang">hreflang</span>;
           attribute DOMString <span title="dom-link-type">type</span>;
};</pre>
    <p>The <code>LinkStyle</code> interface must also be implemented
    by this element, the <span>styling processing model</span> defines
    how. <a href="#refsCSSOM">[CSSOM]</a></p>
   </dd>
  </dl>

  <p>The <code>link</code> element allows authors to indicate explicit
  relationships between their document and other resources.</p>

  <p>The destination of the link is given by the <dfn
  title="attr-link-href"><code>href</code></dfn> attribute, which must
  be present and must contain a URI (or IRI). If the <code
  title="attr-link-href">href</code> attribute is absent, then the
  element does not define a link.</p>

  <p>The type of link indicated (the relationship) is given by the
  value of the <dfn title="attr-link-rel"><code>rel</code></dfn>
  attribute, which must be present, with an <span>unordered set of
  space-separated tokens</span>. The <a href="#linkTypes">allowed
  values and their meanings</a> are defined in a later section. If the
  <code title="attr-link-rel">rel</code> attribute is absent, or if
  the value used is not allowed according to the definitions in this
  specification, then the element does not define a link.</p>

  <p>Two categories of links can be created using the
  <code>link</code> element. <dfn title="external resource link">Links
  to external resources</dfn> are links to resources that are to be
  used to augment the current document, and <dfn title="hyperlink
  link">hyperlink links</dfn> are <span title="hyperlink">links to
  other documents</span>. The <a href="#linkTypes">link types
  section</a> defines whether a particular link type is an external
  resource or a hyperlink. One element can create multiple links (of
  which some might be external resource links and some might be
  hyperlinks). User agents should process the links on a per-link
  basis, not a per-element basis.</p>

  <p>The exact behaviour for links to external resources depends on
  the exact relationship, as defined for the relevant link type. Some
  of the attributes control whether or not the external resource is to
  be applied (as defined below). For external resources that are
  represented in the DOM (for example, style sheets), the DOM
  representation must be made available even if the resource is not
  applied. (However, user agents may opt to only fetch such resources
  when they are needed, instead of pro-actively downloading all the
  external resources that are not applied.)</p>

  <p>Interactive user agents should provide users with a means to
  <span title="following hyperlinks">follow the hyperlinks</span>
  created using the <code>link</code> element, somewhere within their
  user interface. The exact interface is not defined by this
  specification, but it should include the following information
  (obtained from the element's attributes, again as defined below), in
  some form or another (possibly simplified), for each hyperlink
  created with each <code>link</code> element in the document:</p>

  <ul> <!-- the order here is the order that makes most sense for a UI -->

   <li>The relationship between this document and the resource (given
   by the <code title="attr-link-rel">rel</code> attribute)</li>

   <li>The title of the resource (given by the <code
   title="attr-link-title">title</code> attribute).</li>

   <li>The URI of the resource (given by the <code
   title="attr-link-href">href</code> attribute).</li>

   <li>The language of the resource (given by the <code
   title="attr-link-hreflang">hreflang</code> attribute).</li>

   <li>The optimum media for the resource (given by the <code
   title="attr-link-media">media</code> attribute).</li>

  </ul>

  <p>User agents may also include other information, such as the type
  of the resource (as given by the <code
  title="attr-link-type">type</code> attribute).</p>

  <p>The <dfn title="attr-link-media"><code>media</code></dfn>
  attribute says which media the resource applies to. The value must
  be a valid media query. <a href="#refsMQ">[MQ]</a></p>

  <p>If the link is a <span title="hyperlink link">hyperlink</span>
  then the <code title="attr-link-media">media</code> attribute is
  purely advisory, and describes for which media the document in
  question was designed.</p>

  <p>However, if the link is an <span>external resource link</span>,
  then the <code title="attr-link-media">media</code> attribute is
  prescriptive. The user agent must only apply the external resource
  to <span>views</span><!-- XXX xref --> while their state match the
  listed media.</p>

  <p id="default-media">The default, if the <code
  title="attr-link-media">media</code> attribute is omitted, is
  <code>all</code>, meaning that by default links apply to all
  media.</p>

  <p>The <dfn title="attr-link-hreflang"><code>hreflang</code></dfn>
  attribute on the <code>link</code> element has the same semantics as
  the <span title="attr-hyperlink-hreflang"><code>hreflang</code>
  attribute on hyperlink elements</span>.</p>

  <p>The <dfn title="attr-link-type"><code>type</code></dfn> attribute
  gives the MIME type of the linked resource. It is purely advisory.
  The value must be a valid MIME type, optionally with parameters. <a
  href="#refsRFC2046">[RFC2046]</a></p>

  <p>For <span title="external resource link">external resource
  links</span>, user agents may use the type given in this attribute
  to decide whether or not to consider using the resource at all. If
  the UA does not support the given MIME type for the given link
  relationship, then the UA may opt not to download and apply the
  resource.</p>

  <p>User agents must not consider the <code
  title="attr-link-type">type</code> attribute authoritative &mdash;
  upon fetching the resource, user agents must only use the <span
  title="Content-Type">Content-Type information associated with the
  resource</span> to determine its type, not metadata included in the
  link to the resource.</p>

  <p>If the attribute is omitted, then the UA must fetch the resource
  to determine its type and thus determine if it supports (and can
  apply) that external resource.</p>

  <div class="example">

   <p>If a document contains three style sheet links labelled as
   follows:</p>

   <pre>&lt;link rel="stylesheet" href="A" type="text/css"&gt;
&lt;link rel="stylesheet" href="B" type="text/plain"&gt;
&lt;link rel="stylesheet" href="C"&gt;</pre>

   <p>...then a compliant UA that supported only CSS style sheets
   would fetch the A and C files, and skip the B file (since
   <code>text/plain</code> is not the MIME type for CSS style sheets).
   For these two files, it would then check the actual types returned
   by the UA. For those that are sent as <code>text/css</code>, it
   would apply the styles, but for those labelled as
   <code>text/plain</code>, or any other type, it would not.</p>

  </div>

<!--(to be deleted) (charset dropped)
  <p>The <dfn title="attr-link-charset"><code>charset</code></dfn>
  attribute gives the character encoding of the linked resource. It is
  purely advisory. The value must be a valid character encoding name.
  <a href="#refsIANACHARSET">[IANACHARSET]</a></p>

  <p>For <span title="external resource link">external resource
  links</span>, user agents may use the character encoding given in
  this attribute to decide whether or not to consider using the
  resource at all. If the UA does not support the given encoding for
  the given link relationship, then the UA may opt not to download and
  apply the resource.</p>

  <p>However, once the resource has been fetched, user agents must
  follow the rules for that resource type when determining the actual
  character encoding.</p>
-->

  <p>The <dfn title="attr-link-title"><code>title</code></dfn>
  attribute gives the title of the link. With one exception, it is
  purely advisory. The value is text. The exception is for style sheet
  links, where the <code title="attr-link-title">title</code>
  attribute defines <span>alternative style sheet sets</span>.</p>

  <p class="note">The <code title="attr-link-title">title</code>
  attribute on <code>link</code> elements differs from the global
  <code title="attr-title">title</code> attribute of most other
  elements in that a link without a title does not inherit the title
  of the parent element: it merely has no title.</p>

  <p>Some versions of HTTP defined a <code title="">Link:</code>
  header, to be processed like a series of <code>link</code> elements.
  When processing links, those must be taken into consideration as
  well. For the purposes of ordering, links defined by HTTP headers
  must be assumed to come before any links in the document, in the
  order that they were given in the HTTP entity header. Relative URIs
  in these headers must be resolved according to the rules given in
  HTTP, not relative to base URIs set by the document (e.g. using a
  <code>base</code> element or <code>xml:base</code> attributes). <a
  href="#refsRFC2616">[RFC2616]</a> <a
  href="#refsRFC2068">[RFC2068]</a></p>

  <p>The DOM attributes <dfn
  title="dom-link-href"><code>href</code></dfn>, <dfn
  title="dom-link-rel"><code>rel</code></dfn>, <dfn
  title="dom-link-media"><code>media</code></dfn>, <dfn
  title="dom-link-hreflang"><code>hreflang</code></dfn>, and <dfn
  title="dom-link-type"><code>type</code></dfn> each must
  <span>reflect</span> the respective content attributes of the same
  name.</p>

  <p>The DOM attribute <dfn
  title="dom-link-rellist"><code>relList</code></dfn> must
  <span>reflect</span> the <code title="attr-link-rel">rel</code>
  content attribute.</p>

  <p>The DOM attribute <dfn
  title="dom-link-disabled"><code>disabled</code></dfn> only applies
  to style sheet links. When the <code>link</code> element defines a
  style sheet link, then the <code
  title="dom-link-disabled">disabled</code> attribute behaves as
  defined <span title="dom-linkstyle-disabled">for the alternative
  style sheets DOM</span>. For all other <code>link</code> elements it
  always return false and does nothing on setting.</p>


  <h4 id="meta">The <dfn><code>meta</code></dfn> element</h4>

  <p><span title="metadata elements">Metadata element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-meta-name">name</code></dd>
   <dd><code title="attr-meta-http-equiv">http-equiv</code></dd>
   <dd><code title="attr-meta-content">content</code></dd>
   <dd><code title="attr-meta-charset">charset</code> (<span title="HTML documents">HTML</span> only)</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLMetaElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-meta-content">content</span>;
           attribute DOMString <span title="dom-meta-name">name</span>;
           attribute DOMString <span title="dom-meta-httpEquiv">httpEquiv</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>meta</code> element represents various kinds of
  metadata that cannot be expressed using the <code>title</code>,
  <code>base</code>, <code>link</code>, <code>style</code>, and
  <code>script</code> elements.</p>

  <p>The <code>meta</code> element can represent document-level
  metadata with the <code title="attr-meta-name">name</code>
  attribute, pragma directives with the <code
  title="attr-meta-http-equiv">http-equiv</code> attribute, and the
  file's character encoding declaration when an HTML document is
  serialised to string form (e.g. for transmission over the network or
  for disk storage) with the <code
  title="attr-meta-charset">charset</code> attribute.</p>

  <p>Exactly one of the <code title="attr-meta-name">name</code>,
  <code title="attr-meta-http-equiv">http-equiv</code>, and <code
  title="attr-meta-charset">charset</code> attributes must be
  specified.</p>

  <p>If either <code title="attr-meta-name">name</code> or <code
  title="attr-meta-http-equiv">http-equiv</code> is specified, then
  the <code title="attr-meta-content">content</code> attribute must
  also be specified. Otherwise, it must be omitted.</p>

  <p>The <code title="attr-meta-charset">charset</code> attribute may
  only be specified in <span title="HTML5">HTML documents</span>, it
  must not be used in <span title="XHTML">XML documents</span>. If the
  <code title="attr-meta-charset">charset</code> attribute is
  specified, the element must be the first element in <span>the
  <code>head</code> element</span> of the file.</p>

  <p>The <dfn title="attr-meta-content"><code>content</code></dfn>
  attribute gives the value of the document metadata or pragma
  directive when the element is used for those purposes. The allowed
  values depend on the exact context, as described in subsequent
  sections of this specification.</p>

  <p>If a <code>meta</code> element has a <dfn
  title="attr-meta-name"><code>name</code></dfn> attribute, it sets
  document metadata. Document metadata is expressed in terms of
  name/value pairs, the <code title="attr-meta-name">name</code>
  attribute on the <code>meta</code> element giving the name, and the
  <code title="attr-meta-content">content</code> attribute on the same
  element giving the value. The name specifies what aspect of metadata
  is being set; valid names and the meaning of their values are
  described in the following sections.  If a <code>meta</code> element
  has no <code title="attr-meta-content">content</code> attribute,
  then the value part of the metadata name/value pair is the empty
  string.</p>

  <p>The DOM attributes <dfn
  title="dom-meta-name"><code>name</code></dfn> and <dfn
  title="dom-meta-content"><code>content</code></dfn> must
  <span>reflect</span> the respective content attributes of the same
  name. The DOM attribute <dfn
  title="dom-meta-httpEquiv"><code>httpEquiv</code></dfn> must reflect
  the content attribute <code
  title="attr-meta-http-equiv">http-equiv</code>.</p>


  <h5>Standard metadata names</h5>

  <p>This specification defines a few names for the <code
  title="attr-meta-name">name</code> attribute of the
  <code>meta</code> element.</p>

  <dl>

   <dt><dfn title="meta-generator">generator</dfn></dt>

   <dd>The value must be a free-form string that identifies the
   software used to generate the document. This value must not be used
   on hand-authored pages. WYSIWYG editors have <span title="WYSIWYG
   signature">additional constraints</span> on the value used with
   this metadata name.</dd>

  </dl>


  <h5>Other metadata names</h5>

  <p><dfn title="concept-meta-extensions">Extensions to the predefined
  set of metadata names</dfn> may be registered in the <a
  href="http://wiki.whatwg.org/wiki/MetaExtensions">WHATWG Wiki
  MetaExtensions page</a>.

  <p>Anyone is free to edit the WHATWG Wiki MetaExtensions page at any
  time to add a type. These new names must be specified with the
  following information:</p>

  <dl>

   <dt>Keyword</dt>

   <dd><p>The actual name being defined. The name should not be
   confusingly similar to any other defined name (e.g. differing only
   in case).</p></dd>


   <dt>Brief description</dt>

   <dd><p>A short description of what the metadata name's meaning is,
   including the format the value is required to be in.</p></dd>


   <dt>Link to more details</dt>

   <dd>A link to a more detailed description of the metadata name's
   semantics and requirements. It could be another page on the Wiki,
   or a link to an external page.</dd>


   <dt>Synonyms</dt>

   <dd><p>A list of other names that have exactly the same processing
   requirements. Authors should not use the names defined to be
   synonyms, they are only intended to allow user agents to support
   legacy content.</p></dd>


   <dt>Status</dt>

   <dd>

    <p>One of the following:</p>

    <dl>

     <dt>Proposal</dt>

     <dd>The name has not received wide peer review and
     approval. Someone has proposed it and is using it.</dd>

     <dt>Accepted</dt>

     <dd>The name has received wide peer review and approval. It has a
     specification that unambiguously defines how to handle pages that
     use the name, including when they use it in incorrect ways.</dd>

     <dt>Unendorsed</dt>

     <dd>The metadata name has received wide peer review and it has
     been found wanting. Existing pages are using this keyword, but
     new pages should avoid it. The "brief description" and "link to
     more details" entries will give details of what authors should
     use instead, if anything.</dd>

    </dl>

    <p>If a metadata name is added with the "proposal" status and
    found to be redundant with existing values, it should be removed
    and listed as a synonym for the existing value.</p>

   </dd>

  </dl>

  <p>Conformance checkers must use the information given on the WHATWG
  Wiki MetaExtensions page to establish if a value not explicitly
  defined in this specification is allowed or not. When an author uses
  a new type not defined by either this specification or the Wiki
  page, conformance checkers should offer to add the value to the
  Wiki, with the details described above, with the "proposal"
  status.</p>

  <p>This specification does not define how new values will get
  approved. It is expected that the Wiki will have a community that
  addresses this.</p>

  <p>Metadata names whose values are to be URIs must not be proposed
  or accepted. Links must be represented using the <code>link</code>
  element, not the <code>meta</code> element.</p>


  <h5>Pragma directives</h5>

  <p>When the <dfn
  title="attr-meta-http-equiv"><code>http-equiv</code></dfn> attribute
  is specified on a <code>meta</code> element, the element is a pragma
  directive.</p>

  <p>The <dfn
  title="attr-meta-http-equiv"><code>http-equiv</code></dfn> attribute
  is an <span>enumerated attribute</span>. The following table lists
  the keywords defined for this attribute. The states given in the
  first cell of the the rows with keywords give the states to which
  those keywords map.<!-- Some of the keywords are non-conforming, as
  noted in the last column.--></p>

  <table>
   <thead>
    <tr>
     <th>State
     <th>Keywords
<!--     <th>Notes-->
   <tbody>
<!-- things that are neither conforming nor do anything are commented out
    <tr>
     <td><span title="attr-meta-http-equiv-content-language">Content-Language</span>
     <td><code title="">Content-Language</code>
     <td>Non-conforming
    <tr>
     <td><span title="attr-meta-http-equiv-content-type">Content-Type</span>
     <td><code title="">Content-Type</code>
     <td>Non-conforming
    <tr>
     <td><span title="attr-meta-http-equiv-content-script-type">Content-Script-Type</span>
     <td><code title="">Content-Script-Type</code>
     <td>Non-conforming
    <tr>
     <td><span title="attr-meta-http-equiv-content-style-type">Content-Style-Type</span>
     <td><code title="">Content-Style-Type</code>
     <td>Non-conforming
-->
    <tr>
     <td><span title="attr-meta-http-equiv-refresh">Refresh</span>
     <td><code title="">refresh</code>
<!--     <td>-->
    <tr>
     <td><span title="attr-meta-http-equiv-default-style">Default style</span>
     <td><code title="">default-style</code>
<!--     <td>-->
  </table>

  <p>When a <code>meta</code> element is inserted into the document,
  if its <code title="attr-meta-http-equiv">http-equiv</code>
  attribute is present and represents one of the above states, then
  the user agent must run the algorithm appropriate for that state, as
  described in the following list:</p>

  <dl>

   <dt><dfn title="attr-meta-http-equiv-refresh">Refresh state</dfn>

   <dd>

    <ol>
     <!-- TESTS: http://www.hixie.ch/tests/adhoc/html/meta/refresh/ -->

     <li><p>If another <code>meta</code> element in the <span
     title="attr-meta-http-equiv-refresh">Refresh state</span> has
     already been successfully processed (i.e. when it was inserted
     the user agent processed it and reached the last step of this
     list of steps), then abort steps steps.</p></li>

     <li><p>If the <code>meta</code> element has no <code
     title="attr-meta-content">content</code> attribute, or if that
     attribute's value is the empty string, then abort these
     steps.</p></li>

     <li><p>Let <var title="">input</var> be the value of the
     element's <code title="attr-meta-content">content</code>
     attribute.</p></li>

     <li><p>Let <var title="">position</var> point at the first
     character of <var title="">input</var>.</p></li>

     <li><p><span>Skip whitespace</span>.</p></li>

     <li><p><span title="collect a sequence of characters">Collect a
     sequence of characters</span> in the range U+0030 DIGIT ZERO to
     U+0039 DIGIT NINE, and parse the resulting string using the
     <span>rules for parsing non-negative integers</span>. If the
     sequence of characters collected is the empty string, then no
     number will have been parsed; abort these steps. Otherwise, let
     <var title="">time</var> be the parsed number.</p></li>

     <li><p><span title="collect a sequence of characters">Collect a
     sequence of characters</span> in the range U+0030 DIGIT ZERO to
     U+0039 DIGIT NINE and U+002E FULL STOP ("<code
     title="">.</code>"). Ignore any collected characters.</p></li>

     <li><p><span>Skip whitespace</span>.</p></li>

     <li><p>Let <var title="">url</var> be the address of the current
     page.</p></li>

     <li><p>If the character in <var title="">input</var> pointed to
     by <var title="">position</var> is a U+003B SEMICOLON ("<code
     title="">;</code>"), then advance <var title="">position</var> to
     the next character. Otherwise, jump to the last step.</p></li>

     <li><p><span>Skip whitespace</span>.</p></li>

     <li><p>If the character in <var title="">input</var> pointed to
     by <var title="">position</var> is one of U+0055 LATIN CAPITAL
     LETTER U or U+0075 LATIN SMALL LETTER U, then advance <var
     title="">position</var> to the next character. Otherwise, jump to
     the last step.</p></li>

     <li><p>If the character in <var title="">input</var> pointed to
     by <var title="">position</var> is one of U+0052 LATIN CAPITAL
     LETTER R or U+0072 LATIN SMALL LETTER R, then advance <var
     title="">position</var> to the next character. Otherwise, jump to
     the last step.</p></li>

     <li><p>If the character in <var title="">input</var> pointed to
     by <var title="">position</var> is one of U+004C LATIN CAPITAL
     LETTER L or U+006C LATIN SMALL LETTER L, then advance <var
     title="">position</var> to the next character. Otherwise, jump to
     the last step.</p></li>

     <li><p><span>Skip whitespace</span>.</p></li>

     <li><p>If the character in <var title="">input</var> pointed to
     by <var title="">position</var> is a U+003D EQUALS SIGN ("<code
     title="">=</code>"), then advance <var title="">position</var> to
     the next character. Otherwise, jump to the last step.</p></li>

     <li><p><span>Skip whitespace</span>.</p></li>

     <li><p>Let <var title="">url</var> be equal to the substring of
     <var title="">input</var> from the character at <var
     title="">position</var> to the end of the string.</p></li>

     <li><p>Strip any trailing <span title="space character">space
     characters</span> from the end of <var
     title="">url</var>.</p></li>

     <li><p>Strip any U+0009 CHARACTER TABULATION, U+000A LINE FEED
     (LF), and U+000D CARRIAGE RETURN (CR) characters from <var
     title="">url</var>.</p></li>

     <li><p>Resolve the <var title="">url</var> value to an absolute
     URI using the base URI of the <code>meta</code> element.</p></li>

     <li><p>Set a timer so that in <var title="">time</var> seconds,
     if the user has not canceled the redirect, the user agent acts as
     if the <code title="dom-location-replace">replace()</code> method
     of the document's corresponding <code>Location</code> object was
     invoked with <var title="">url</var> as its argument.</p></li>
     <!-- XXX or, make the definition of "navigate" have a flag
     instead of having replace() behaviour only happen when it is
     called by replace(). -->

    </ol>

    <p>For <code>meta</code> elements in the <span
    title="attr-meta-http-equiv-refresh">Refresh state</span>, the
    <code title="attr-meta-content">content</code> attribute must have
    a value consisting either of:

    <ul>

     <li> just a <span>valid non-negative integer</span>, or</li>

     <li> a <span>valid non-negative integer</span>, followed by a
     U+003B SEMICOLON (<code title="">;</code>), followed by one or
     more <span title="space character">space characters</span>,
     followed by either a U+0055 LATIN CAPITAL LETTER U or a U+0075
     LATIN SMALL LETTER U, a U+0052 LATIN CAPITAL LETTER R or a U+0072
     LATIN SMALL LETTER R, a U+004C LATIN CAPITAL LETTER L or a U+006C
     LATIN SMALL LETTER L, a U+003D EQUALS SIGN (<code
     title="">=</code>), and then a valid URI (or IRI).</p>

    </ul>

    <p>In the former case, the integer represents a number of seconds
    before the page is to be reloaded; in the latter case the integer
    represents a number of seconds before the page is to be replaced
    by the page at the given URI.</p>

   <dd>

   <dt><dfn title="attr-meta-http-equiv-default-style">Default style state</dfn>

   <dd>

    <ol>

     <li class="big-issue">...</li>

    </ol>

   <dd>

  </dl>


  <h5 id="charset">Specifying and establishing the document's
  character encoding</h5>

  <p>The <code>meta</code> element may also be used to provide UAs
  with character encoding information for <span
  title="HTML5">HTML</span> files, by setting the <dfn
  title="attr-meta-charset"><code>charset</code></dfn> attribute to
  the name of a character encoding. This is called a character
  encoding declaration.</p>

  <p>The following restrictions apply to character encoding
  declarations:</p>

  <ul>

   <li>When <a href="#syntax">serialised</a>, the <code
   title="attr-meta-charset">charset</code> attribute and its value
   must be contained completely in the first 512 bytes of the
   file.</li>

   <li>The attribute value must be serialised without the use of
   character entity references of any kind.</li>

   <li>The value must be a valid character encoding name. <a
   href="#refsIANACHARSET">[IANACHARSET]</a> <!-- XXX
   http://www.iana.org/assignments/character-sets --></li>

   <li>The character encoding name given must be the name of the
   character encoding used to serialise the file.</li>

   <li>The character encoding used must be a superset of US-ASCII
   (specifically, ANSI_X3.4-1968) for bytes in the range 0x09 - 0x0D,
   0x20, 0x21, 0x22, 0x26, 0x27, 0x2C - 0x3F, 0x41 - 0x5A, and 0x61 -
   0x7A.</li> <!-- XXX #refs RFC1345 ? --> <!-- is that list ok? do
   any character sets we want to support do things outside that range?
   -->

  </ul>

  <p>If the encoding is one of UTF-8, UTF-16BE, UTF-16LE, UTF-32BE, or
  UTF-32LE, then authors can use a BOM at the start of the file to
  indicate the character encoding.</p> <!-- UTF-EBCDIC, too! -->

  <p>In XHTML, the XML declaration should be used for inline character
  encoding information, if necessary.</p>

  <p>Authors should avoid including inline character encoding
  information. Character encoding information should instead be
  included at the transport level (e.g. using the HTTP <code
  title="">Content-Type</code> header).</p> <!-- XXX should we remove
  this paragraph? Experts disagree on this. -->


  <h4>The <dfn><code>style</code></dfn> element</h4>

  <p><span title="metadata elements">Metadata element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element.</dd>
   <dd>At the start of <code>article</code>, <code>aside</code>, <code>div</code>, and <code>section</code> elements.</dd>
   <dt>Content model:</dt>
   <dd>Depends on the value of the <code title="attr-style-type">type</code> attribute.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-style-media">media</code></dd>
   <dd><code title="attr-style-type">type</code></dd>
   <dd><code title="attr-style-scoped">scoped</code></dd>
   <dd>Also, the <code title="attr-style-title">title</code> attribute has special semantics on this element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLStyleElement</dfn> : <span>HTMLElement</span> {
           attribute boolean <code title="dom-style-disabled">disabled</code>;
           attribute DOMString <code title="dom-style-media">media</code>;
           attribute DOMString <code title="dom-style-type">type</code>;
           attribute boolean <code title="dom-style-scoped">scoped</code>;
};</pre>
    <p>The <code>LinkStyle</code> interface must also be implemented
    by this element, the <span>styling processing model</span> defines
    how. <a href="#refsCSSOM">[CSSOM]</a></p>
   </dd>
  </dl>

  <p>The <code>style</code> element allows authors to embed style
  information in their documents. The <code>style</code> element is
  one of several inputs to the <span>styling processing
  model</span>.</p>

  <p>If the <dfn title="attr-style-type"><code>type</code></dfn>
  attribute is given, it must contain a valid MIME type, optionally
  with parameters, that designates a styling language. <a
  href="#refsRFC2046">[RFC2046]</a> If the attribute is absent, the
  type defaults to <code>text/css</code>. <a
  href="#refsRFC2318">[RFC2138]</a></p>

  <!-- XXX this is the second time we have this paragraph here... -->
  <p>When examining types to determine if they support the language,
  user agents must not ignore unknown MIME parameters &mdash; types
  with unknown parameters must be assumed to be unsupported.</p>

  <p>The <dfn title="attr-style-media"><code>media</code></dfn>
  attribute says which media the styles apply to. The value must be a
  valid media query. <a href="#refsMQ">[MQ]</a> User agents must only
  apply the styles to <span>views</span> while their state match the
  listed media. <a href="#refsDOM3VIEWS">[DOM3VIEWS]</a></p>

  <p id="style-default-media">The default, if the <code
  title="attr-style-media">media</code> attribute is omitted, is
  <code>all</code>, meaning that by default styles apply to all
  media.</p>

  <p>The <dfn title="attr-style-scoped"><code>scoped</code></dfn>
  attribute is a <span>boolean attribute</span>. If the attribute is
  present, then the user agent must only apply the specified style
  information to the <code>style</code> element's parent element (if
  any), and that element's child nodes. Otherwise, the specified
  styles must, if applied, be applied to the entire document.</p>

  <p id="title-on-style">The <dfn
  title="attr-style-title"><code>title</code></dfn> attribute on
  <code>style</code> elements defines <span>alternative style sheet
  sets</span>. If the <code>style</code> element has no <code
  title="attr-style-title">title</code> attribute, then it has no
  title; the <code title="attr-title">title</code> attribute of
  ancestors does not apply to the <code>style</code> element.</p> <!--
  XXX xref -->

  <p class="note">The <code title="attr-style-title">title</code>
  attribute on <code>style</code> elements, like the <code
  title="attr-link-title">title</code> attribute on <code>link</code>
  elements, differs from the global <code
  title="attr-title">title</code> attribute in that a
  <code>style</code> block without a title does not inherit the title
  of the parent element: it merely has no title.</p>

  <p>All descendant elements must be processed, according to their
  semantics, before the <code>style</code> element itself is
  evaluated. For styling languages that consist of pure text, user
  agents must evaluate <code>style</code> elements by passing the
  concatenation of the contents of all the <span title="text
  node">text nodes</span> that are direct children of the
  <code>style</code> element (not any other nodes such as comments or
  elements), in <span>tree order</span>, to the style system. For
  XML-based styling languages, user agents must pass all the children
  nodes of the <code>style</code> element to the style system.</p>

  <p class="note">This specification does not specify a style system,
  but CSS is expected to be supported by most Web browsers. <a
  href="#refsCSS21">[CSS21]</a></p>

  <p>The <dfn title="dom-style-media"><code>media</code></dfn>, <dfn
  title="dom-style-type"><code>type</code></dfn> and <dfn
  title="dom-style-scoped"><code>scoped</code></dfn> DOM attributes
  must <span>reflect</span> the respective content attributes of the
  same name.</p>

  <p>The DOM <dfn
  title="dom-style-disabled"><code>disabled</code></dfn> attribute
  behaves as defined <span title="dom-linkstyle-disabled">for the
  alternative style sheets DOM</span>.</p>


  <h3>Sections</h3>

  <p><dfn>Sectioning elements</dfn> are elements that divide the page
  into, for lack of a better word, sections. This section describes
  HTML's sectioning elements and elements that support them.</p>

  <p id="applyToSection">Some elements are scoped to their nearest
  ancestor sectioning element. For example, <code>address</code>
  elements apply just to their section. For such elements <var
  title="">x</var>, the elements that apply to a sectioning element
  <var title="">e</var> are all the <var title="">x</var> elements
  whose nearest sectioning element is <var title="">e</var>.</p>


  <h4>The <dfn><code>body</code></dfn> element</h4>

  <p><span title="sectioning elements">Sectioning element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the second element in an <code>html</code> element.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-search">search</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>body</code> element represents the main content of the
  document.</p>

  <p>The <code>body</code> element potentially has a heading. See the
  section on <span>headings and sections</span> for further
  details.</p>

  <p>In conforming documents, there is only one <code>body</code>
  element. The <code title="dom-document-body">document.body</code>
  DOM attribute provides scripts with easy access to a document's
  <code>body</code> element.</p>

  <p class="note">Some DOM operations (for example, parts of the
  <span>drag and drop</span> model) are defined in terms of "<span>the
  body element</span>". This refers to a particular element in the
  DOM, as per the definition of the term, and not any arbitrary
  <code>body</code> element.</p>


  <h4>The <dfn><code>section</code></dfn> element</h4>

  <p><span title="sectioning elements">Sectioning</span> <span
  title="block-level elements">block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>style</code> elements, followed by zero or more <span>block-level elements</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-error">error</code>, <code
   title="class-example">example</code>, <code
   title="class-search">search</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>section</code> element represents a generic document or
  application section. A section, in this context, is a thematic
  grouping of content, typically with a header, possibly with a
  footer.</p>

  <p class="example">Examples of sections would be chapters, the
  various tabbed pages in a tabbed dialog box, or the numbered
  sections of a thesis. A Web site's home page could be split into
  sections for an introduction, news items, contact information.</p>

  <p>Each <code>section</code> element potentially has a heading. See
  the section on <span>headings and sections</span> for
  further details.</p>


  <h4>The <dfn><code>nav</code></dfn> element</h4>

  <p><span title="sectioning elements">Sectioning</span> <span
  title="block-level elements">block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>, or <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>nav</code> element represents a section of a page that
  links to other pages or to parts within the page: a section with
  navigation links.</p>

  <p>When <span title="Determining if a particular element contains
  block-level elements or inline-level content">used as an
  inline-level content</span> container, the element represents a
  <span>paragraph</span>.</p>

  <p>Each <code>nav</code> element potentially has a heading.
  See the section on <span>headings and sections</span> for
  further details.</p>


  <h4>The <dfn><code>article</code></dfn> element</h4>

  <p><span title="sectioning elements">Sectioning</span> <span
  title="block-level elements">block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>style</code> elements, followed by zero or more <span>block-level elements</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
<!--
XXX attributes to give the date authored, date published
-->
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>article</code> element represents a section of a page
  that consists of a composition that forms an independent part of a
  document, page, or site. This could be a forum post, a magazine or
  newspaper article, a Web log entry, a user-submitted comment, or any
  other independent item of content.</p>

  <p class="note">An <code>article</code> element is "independent" in
  that its contents could stand alone, for example in syndication.
  However, the element is still associated with its ancestors; for
  instance, contact information that <a
  href="#applyToSection">applies</a> to a parent <code>body</code>
  element still covers the <code>article</code> as well.</p>

  <p>When <code>article</code> elements are nested, the inner
  <code>article</code> elements represent articles that are in
  principle related to the contents of the outer article. For
  instance, a Web log entry on a site that accepts user-submitted
  comments could represent the comments as <code>article</code>
  elements nested within the <code>article</code> element for the Web
  log entry.</p>

  <p>Author information associated with an <code>article</code>
  element (q.v. the <code>address</code> element) does not apply to
  nested <code>article</code> elements.</p>

  <p>Each <code>article</code> element potentially has a heading. See
  the section on <span>headings and sections</span> for
  further details.</p>


  <h4>The <dfn><code>blockquote</code></dfn> element</h4>

  <p><span title="sectioning elements">Sectioning</span> <span
  title="block-level elements">block-level element</span>, and <span
  title="structured inline-level elements">structured inline-level
  element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>structured inline-level elements</span> are allowed.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-blockquote-cite">cite</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLQuoteElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-quote-cite">cite</span>;
};</pre>
    <p class="note">The <code>HTMLQuoteElement</code> interface is
    also used by the <code>q</code> element.</p>
   </dd>
  </dl>

  <p>The <code>blockquote</code> element represents a section that is
  quoted from another source.</p>

  <p>Content inside a <code>blockquote</code> must be quoted from
  another source, whose URI, if it has one, should be cited in the
  <dfn title="attr-blockquote-cite"><code>cite</code></dfn>
  attribute.</p>

  <p>If the <code title="attr-blockquote-cite">cite</code> attribute
  is present, it must be a URI (or IRI). User agents should allow
  users to follow such citation links.</p>

  <p>If a <code>blockquote</code> element is <span>preceeded or
  followed</span> by a <code>p</code> element that contains a single
  <code>cite</code> element and is itself not <span>preceeded or
  followed</span> by another <code>blockquote</code> element and does
  not itself have a <code>q</code> element descendant, then, the
  citation given by that <code>cite</code> element gives the source of
  the quotation contained in the <code>blockquote</code> element.</p>

  <p>Each <code>blockquote</code> element potentially has a heading.
  See the section on <span>headings and sections</span> for
  further details.</p>

  <p>The <dfn title="dom-quote-cite"><code>cite</code></dfn> DOM
  attribute <code>reflects</code> the element's <code
  title="">cite</code> content attribte.

  <p class="note">The best way to represent a conversation is not with
  the <code>cite</code> and <code>blockquote</code> elements, but with
  the <code>dialog</code> element.</p>


  <h4>The <dfn><code>aside</code></dfn> element</h4>

  <p><span title="sectioning elements">Sectioning</span> <span
  title="block-level elements">block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>style</code> elements, followed by either
   zero or more <span>block-level elements</span>, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-example">example</code>, <code
   title="class-issue">issue</code>, <code
   title="class-note">note</code>, <code
   title="class-search">search</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>aside</code> element represents a section of a page
  that consists of content that is tangentially related to the content
  around the <code>aside</code> element, and which could be considered
  separate from that content. Such sections are often represented as
  sidebars in printed typography.</p>

  <p>When <span title="Determining if a particular element contains
  block-level elements or inline-level content">used as an
  inline-level content</span> container, the element represents a
  <span>paragraph</span>.</p>

  <p>Each <code>aside</code> element potentially has a heading. See
  the section on <span>headings and sections</span> for
  further details.</p>


  <h4>The <dfn><code>h1</code></dfn>, <dfn><code>h2</code></dfn>,
  <dfn><code>h3</code></dfn>, <dfn><code>h4</code></dfn>,
  <dfn><code>h5</code></dfn>, and <dfn><code>h6</code></dfn>
  elements</h4>

  <p><span>Block-level elements</span>.</p>

  <dl class="element">
   <dt>Contexts in which these elements may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd><span title="significant inline content">Significant</span> <span>strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>These elements define headers for their sections.</p>

  <p>The semantics and meaning of these elements are defined in the
  section on <span>headings and sections</span>.</p>

  <p>These elements have a <dfn>rank</dfn> given by the number in
  their name. The <code>h1</code> element is said to have the highest
  rank, the <code>h6</code> element has the lowest rank, and two
  elements with the same name have equal rank.</p>

  <p>These elements must not be <span title="significant inline
  content">empty</span>.</p>


  <h4>The <dfn><code>header</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected and there
   are no <code>header</code> ancestors.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>, including at
   least one descendant <code>h1</code>, <code>h2</code>,
   <code>h3</code>, <code>h4</code>, <code>h5</code>, or
   <code>h6</code> element, but no <span>sectioning element</span>
   descendants, no <code>header</code> element descendants, and no
   <code>footer</code> element descendants.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>header</code> element represents the header of a
  section. Headers may contain more than just the section's heading
  &mdash; for example it would be reasonable for the header to include
  version history information.</p>

  <p><code>header</code> elements must not contain any
  <code>header</code> elements, <code>footer</code> elements, or any
  sectioning elements (such as <code>section</code>) as
  descendants.</p>

  <p><code>header</code> elements must have at least one
  <code>h1</code>, <code>h2</code>, <code>h3</code>, <code>h4</code>,
  <code>h5</code>, or <code>h6</code> element as a descendant.</p>

  <p>For the purposes of document summaries, outlines, and the like,
  <code>header</code> elements are equivalent to the highest <span
  title="rank">ranked</span> <code>h1</code>-<code>h6</code> element
  descendant (the first such element if there are multiple elements
  with that <span>rank</span>).</p>

  <p>Other heading elements indicate subheadings or subtitles.</p>

  <div class="example">

   <p>Here are some examples of valid headers. In each case, the
   emphasised text represents the text that would be used as the
   header in an application extracting header data and ignoring
   subheadings.</p>

   <pre>&lt;header&gt;
 &lt;h1&gt;<strong>The reality dysfunction</strong>&lt;/h1&gt;
 &lt;h2&gt;Space is not the only void&lt;/h2&gt;
&lt;/header&gt;</pre>

   <pre>&lt;header&gt;
 &lt;p&gt;Welcome to...&lt;/p&gt;
 &lt;h1&gt;<strong>Voidwars!</strong>&lt;/h1&gt;
&lt;/header&gt;</pre>

   <pre>&lt;header&gt;
 &lt;h1&gt;<strong>Scalable Vector Graphics (SVG) 1.2</strong>&lt;/h1&gt;
 &lt;h2&gt;W3C Working Draft 27 October 2004&lt;/h2&gt;
 &lt;dl&gt;
  &lt;dt&gt;This version:&lt;/dt&gt;
  &lt;dd&gt;&lt;a href="http://www.w3.org/TR/2004/WD-SVG12-20041027/"&gt;http://www.w3.org/TR/2004/WD-SVG12-20041027/&lt;/a&gt;&lt;/dd&gt;
  &lt;dt&gt;Previous version:&lt;/dt&gt;
  &lt;dd&gt;&lt;a href="http://www.w3.org/TR/2004/WD-SVG12-20040510/"&gt;http://www.w3.org/TR/2004/WD-SVG12-20040510/&lt;/a&gt;&lt;/dd&gt;
  &lt;dt&gt;Latest version of SVG 1.2:&lt;/dt&gt;
  &lt;dd&gt;&lt;a href="http://www.w3.org/TR/SVG12/"&gt;http://www.w3.org/TR/SVG12/&lt;/a&gt;&lt;/dd&gt;
  &lt;dt&gt;Latest SVG Recommendation:&lt;/dt&gt;
  &lt;dd&gt;&lt;a href="http://www.w3.org/TR/SVG/"&gt;http://www.w3.org/TR/SVG/&lt;/a&gt;&lt;/dd&gt;
  &lt;dt&gt;Editor:&lt;/dt&gt;
  &lt;dd&gt;Dean Jackson, W3C, &lt;a href="mailto:dean@w3.org"&gt;dean@w3.org&lt;/a&gt;&lt;/dd&gt;
  &lt;dt&gt;Authors:&lt;/dt&gt;
  &lt;dd&gt;See &lt;a href="#authors"&gt;Author List&lt;/a&gt;&lt;/dd&gt;
 &lt;/dl&gt;
 &lt;p class="copyright"&gt;&lt;a href="http://www.w3.org/Consortium/Legal/ipr-notic <em>...</em>
&lt;/header&gt;</pre>
  </div>

  <p>The section on <span>headings and sections</span>
  defines how <code>header</code> elements are assigned to individual
  sections.</p>

  <p>The <span>rank</span> of a <code>header</code> element is the
  same as for an <code>h1</code> element (the highest rank).</p>


  <h4>The <dfn><code>footer</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level
  element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Either zero or more <span>block-level elements</span>, but with
   no <code>h1</code>, <code>h2</code>, <code>h3</code>,
   <code>h4</code>, <code>h5</code>, <code>h6</code>,
   <code>header</code>, or <code>footer</code> elements as
   descendants, and with no <span title="sectioning
   elements">sectioning elements</span> as descendants; or,
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>footer</code> element represents the footer for the
  section it <a href="#applyToSection">applies</a> to. A footer
  typically contains information about its section such as who wrote
  it, links to related documents, copyright data, and the like.</p>

  <p><code>footer</code> elements must not contain any
  <code>footer</code>, <code>header</code>, <code>h1</code>,
  <code>h2</code>, <code>h3</code>, <code>h4</code>, <code>h5</code>,
  or <code>h6</code> elements, or any of the sectioning elements (such
  as <code>section</code>), as descendants.</p>

  <p>When <span title="Determining if a particular element contains
  block-level elements or inline-level content">used as an
  inline-level content</span> container, the element represents a
  <span>paragraph</span>.</p>

  <p>Contact information for the section given in a
  <code>footer</code> should be marked up using the
  <code>address</code> element.</p>

<!-- XXX examples needed -->


  <h4>The <dfn><code>address</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level
  element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd><span>Inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>address</code> element represents a
  <span>paragraph</span> of contact information for the section it <a
  href="#applyToSection">applies</a> to.</p>

  <div class="example">
   <p>For example, a page at the W3C Web site related to HTML might
   include the following contact information:</p>
   <pre>&lt;ADDRESS>
 &lt;A href="../People/Raggett/">Dave Raggett&lt;/A>, 
 &lt;A href="../People/Arnaud/">Arnaud Le Hors&lt;/A>, 
 contact persons for the &lt;A href="Activity">W3C HTML Activity&lt;/A>
&lt;/ADDRESS></pre>
  </div>

  <p>The <code>address</code> element must not be used to represent
  arbitrary addresses (e.g. postal addresses), unless those addresses
  are contact information for the section. (The <code>p</code> element
  is the appropriate element for marking up such addresses.)</p>

  <p>The <code>address</code> element must not contain information
  other than contact information.</p>

  <div class="example">
   <p>For example, the following is non-conforming use of the
   <code>address</code> element:</p>
   <pre>&lt;ADDRESS>Last Modified: 1999/12/24 23:37:50&lt;/ADDRESS></pre>
  </div>

  <p>Typically, the <code>address</code> element would be included
  with other information in a <code>footer</code> element.</p>

  <p>To determine the contact information for a sectioning element
  (such as a document's <code>body</code> element, which would give the
  contact information for the page), UAs must collect all the
  <code>address</code> elements that <a
  href="#applyToSection">apply</a> to that sectioning element and its
  ancestor sectioning elements. The contact information is the
  collection of all the information given by those elements.</p>

  <p class="note">Contact information for one sectioning element, e.g.
  a <code>aside</code> element, does not apply to its ancestor
  elements, e.g. the page's <code>body</code>.</p>



  <h4><dfn>Headings and sections</dfn></h4>

  <p>The <code>h1</code>-<code>h6</code> elements and the
  <code>header</code> element are headings.</p>

  <p>The first heading in a sectioning element gives the header for
  that section. Subsequent headers of equal or higher
  <span>rank</span> start new (implied) sections, headers of lower
  <span>rank</span> start subsections that are part of the previous
  one.</p>

  <p>Sectioning elements other than <code>blockquote</code> are always
  considered subsections of their nearest ancestor sectioning element,
  regardless of what implied sections other headings may have created.
  However, <code>blockquote</code> elements <em>are</em> associated
  with implied sections. Effectively, <code>blockquote</code> elements
  act like sections on the inside, and act opaquely on the
  outside.</p>

  <div class="example">

   <p>For the following fragment:</p>
   <pre>&lt;body&gt;
 &lt;h1&gt;Foo&lt;/h1&gt;
 &lt;h2&gt;Bar&lt;/h2&gt;
 &lt;blockquote&gt;
  &lt;h3&gt;Bla&lt;/h3&gt;
 &lt;/blockquote&gt;
 &lt;p&gt;Baz&lt;/p&gt;
 &lt;h2&gt;Quux&lt;/h2&gt;
 &lt;section&gt;
  &lt;h3&gt;Thud&lt;/h3&gt;
 &lt;/section&gt;
 &lt;p&gt;Grunt&lt;/p&gt;
&lt;/body&gt;</pre>
   <p>...the structure would be:</p>
   <ol>
    <li>
     Foo (heading of explicit <code>body</code> section)
     <ol>
      <li>
       Bar (heading starting implied section)
       <ol>
        <li>
         Bla (heading of explicit <code>blockquote</code> section)
        </li>
       </ol>
       Baz (paragraph)
      </li>
      <li>
       Quux (heading starting implied section)
      </li>
      <li>
       Thud (heading of explicit <code>section</code> section)
      </li>
     </ol>
     Grunt (paragraph)
    </li>
   </ol>
   <p>Notice how the <code>blockquote</code> nests inside an implicit
   section while the <code>section</code> does not (and in fact, ends
   the earlier implicit section so that a later paragraph is back at
   the top level).</p>
  </div>

  <p>Sections may contain headers of any <span>rank</span>, but
  authors are strongly encouraged to either use only <code>h1</code>
  elements, or to use elements of the appropriate <span>rank</span>
  for the section's nesting level.</p>

  <p>Authors are also encouraged to explictly wrap sections in
  sectioning elements, instead of relying on the implicit sections
  generated by having multiple heading in one sectioning element.</p>

  <div class="example">
   <p>For example, the following is correct:</p>

   <pre>&lt;body&gt;
 &lt;h4&gt;Apples&lt;/h4&gt;
 &lt;p&gt;Apples are fruit.&lt;/p&gt;
 &lt;section&gt;
  &lt;h2&gt;Taste&lt;/h2&gt;
  &lt;p&gt;They taste lovely.&lt;/p&gt;
  &lt;h6&gt;Sweet&lt;/h6&gt;
  &lt;p&gt;Red apples are sweeter than green ones.&lt;/p&gt;
  &lt;h1&gt;Color&lt;/h1&gt;
  &lt;p&gt;Apples come in various colors.&lt;/p&gt;
 &lt;/section&gt;
&lt;/body&gt;</pre>

   <p>However, the same document would be more clearly expressed
   as:</p>

   <pre>&lt;body&gt;
 &lt;h1&gt;Apples&lt;/h1&gt;
 &lt;p&gt;Apples are fruit.&lt;/p&gt;
 &lt;section&gt;
  &lt;h2&gt;Taste&lt;/h2&gt;
  &lt;p&gt;They taste lovely.&lt;/p&gt;
  &lt;section&gt;
   &lt;h3&gt;Sweet&lt;/h3&gt;
   &lt;p&gt;Red apples are sweeter than green ones.&lt;/p&gt;
  &lt;/section&gt;
 &lt;/section&gt;
 &lt;section&gt;
  &lt;h2&gt;Color&lt;/h2&gt;
  &lt;p&gt;Apples come in various colors.&lt;/p&gt;
 &lt;/section&gt;
&lt;/body&gt;</pre>

   <p>Both of the documents above are semantically identical and would
   produce the same outline in compliant user agents.</p>

  </div>


  <h5 id="outlines">Creating an outline</h5>

  <p>Documents can be viewed as a tree of sections, which defines how
  each element in the tree is semantically related to the others, in
  terms of the overall section structure. This tree is related to the
  document tree, but there is not a one-to-one relationship between
  elements in the DOM and the document's sections.</p>

  <p>The tree of sections should be used when generating document
  outlines, for example when generating tables of contents.</p>

  <p>To derive the tree of sections from the document tree, a
  hypothetical tree is used, consisting of a view of the document tree
  containing only the <code>h1</code>-<code>h6</code> and
  <code>header</code> elements, and the sectioning elements other than
  <code>blockquote</code>. Descendants of
  <code>h1</code>-<code>h6</code>, <code>header</code>, and
  <code>blockquote</code> elements must be removed from this view.</p>

  <p>The hypothetical tree must be rooted at the <span>root
  element</span> or at a sectioning element. In particular, while the
  sections inside <code>blockquote</code>s do not contribute to the
  document's tree of sections, <code>blockquote</code>s can have
  outlines of their own.</p>

  <p>UAs must take this hypothetical tree (which will become the
  outline) and mutate it by walking it depth first in <span>tree order</span> and,
  for each <code>h1</code>-<code>h6</code> or <code>header</code>
  element that is not the first element of its parent sectioning
  element, inserting a new sectioning element, as follows:</p>

  <dl class="switch">

   <dt>If the element is a <code>header</code> element, or if it is an
   <code>h1</code>-<code>h6</code> node of <span>rank</span> equal to
   or higher than the first element in the parent sectioning element
   (assuming that is also an <code>h1</code>-<code>h6</code> node), or
   if the first element of the parent sectioning element is a
   sectioning element:</dt>

   <dd>Insert the new sectioning element as the immediately following
   sibling of the parent sectioning element, and move all the elements
   from the current heading element up to the end of the parent
   sectioning element into the new sectioning element.</dd>

   <dt>Otherwise:</dt>

   <dd>Move the current heading element, and all subsequent siblings
   up to but excluding the next sectioning element,
   <code>header</code> element, or <code>h1</code>-<code>h6</code> of
   equal or higher <span>rank</span>, whichever comes first, into the
   new sectioning element, then insert the new sectioning element
   where the current header was.</dd>

  </dl>

  <p>The outline is then the resulting hypothetical tree. The
  <span>rank</span>s of the headers become irrelevant at this point:
  each sectioning element in the hypothetical tree contains either no
  or one heading element child. If there is one, then it gives the
  section's heading, of there isn't, the section has no heading.</p>

  <p>Sections are nested as in the hypothetical tree. If a sectioning
  element is a child of another, that means it is a subsection of that
  other section.</p>

  <p>When creating an interactive table of contents, entries should
  jump the user to the relevant section element, if it was a real
  element in the original document, or to the heading, if the section
  element was one of those created during the above process.</p>

  <p class="example">Selecting the first section of the document
  therefore always takes the user to the top of the document,
  regardless of where the first header in the <code>body</code> is to
  be found.</p> <!-- XXX assuming there is a body, anyway -->

  <div class="note">

   <p>The hypothetical tree (before mutations) could be generated by
   creating a <code>TreeWalker</code> with the following <a
   href="http://www.w3.org/TR/DOM-Level-2-Traversal-Range/traversal.html#Traversal-NodeFilter"><code>NodeFilter</code></a>
   (described here as an anonymous ECMAScript function). <a
   href="#refsDOMTR">[DOMTR]</a> <a
   href="#refsECMA262">[ECMA262]</a></p>

   <pre>function (n) {
  // This implementation only knows about HTML elements.
  // An implementation that supports other languages might be
  // different.

  // Reject anything that isn't an element.
  if (n.nodeType != Node.ELEMENT_NODE)
    return NodeFilter.FILTER_REJECT;

  // Skip any descendants of headings.
  if (n.parentNode &amp;&amp; n.parentNode.namespaceURI == 'http://www.w3.org/1999/xhtml') &amp;&amp;
      (n.parentNode.localName == 'h1' || n.parentNode.localName == 'h2' ||
       n.parentNode.localName == 'h3' || n.parentNode.localName == 'h4' ||
       n.parentNode.localName == 'h5' || n.parentNode.localName == 'h6' ||
       n.parentNode.localName == 'header')
    return NodeFilter.FILTER_REJECT;

  // Skip any blockquotes.
  if (n.namespaceURI == 'http://www.w3.org/1999/xhtml') &amp;&amp;
      (n.localName == 'blockquote'))
    return NodeFilter.FILTER_REJECT;

  // Accept HTML elements in the list given in the prose above.
  if ((n.namespaceURI == 'http://www.w3.org/1999/xhtml') &amp;&amp;
      (n.localName == 'body' || /*n.localName == 'blockquote' ||*/
       n.localName == 'section' || n.localName == 'nav' ||
       n.localName == 'article' || n.localName == 'aside' ||
       n.localName == 'h1' || n.localName == 'h2' ||
       n.localName == 'h3' || n.localName == 'h4' ||
       n.localName == 'h5' || n.localName == 'h6' ||
       n.localName == 'header'))
    return NodeFilter.FILTER_ACCEPT;

  // Skip the rest.
  return NodeFilter.FILTER_SKIP;
}</pre>
  </div>


  <h5 id="associatedSection">Determining which heading and section
  applies to a particular node</h5>

  <p>Given a particular node, user agents must use the following
  algorithm, <em>in the given order</em>, to determine which heading
  and section the node is most closely associated with. The processing
  of this algorithm must stop as soon as the associated section and
  heading are established (even if they are established to be
  nothing).</p>

  <ol>

   <li>If the node has an ancestor that is a <code>header</code>
   element, then the associated heading is the most distant such
   ancestor. The associated section is that <code>header</code>'s
   associated section (i.e. repeat this algorithm for that
   <code>header</code>).</li>

   <li>If the node has an ancestor that is an
   <code>h1</code>-<code>h6</code> element, then the associated
   heading is the most distant such ancestor. The associated section
   is that heading's section (i.e. repeat this algorithm for that
   heading element).</li>

   <li>If the node is an <code>h1</code>-<code>h6</code> element or a
   <code>header</code> element, then the associated heading is the
   element itself. The UA must then generate the <a
   href="#outlines">hypothetical section tree</a> described in the
   previous section, rooted at the nearest section ancestor (or the
   <span>root element</span> if there is no such ancestor). If the
   parent of the heading in that hypothetical tree is an element in
   the real document tree, then that element is the associated
   section. Otherwise, there is no associated section element.</li>

   <li>If the node is a sectioning element, then the associated
   section is itself. The UA must then generate the <a
   href="#outlines">hypothetical section tree</a> described in the
   previous section, rooted at the section itself. If the section
   element, in that hypothetical tree, has a child element that is an
   <code>h1</code>-<code>h6</code> element or a <code>header</code>
   element, then that element is the associated heading. Otherwise,
   there is no associated heading element.</li>

   <li>If the node is a <code>footer</code> or <code>address</code>
   element, then the associated section is the nearest ancestor
   sectioning element, if there is one. The node's associated heading
   is the same as that sectioning element's associated heading (i.e.
   repeat this algorithm for that sectioning element). If there is no
   ancestor sectioning element, the element has no associated section
   nor an associated heading.</li>

   <li>Otherwise, the node is just a normal node, and the document has
   to be examined more closely to determine its section and heading.
   Create a view rooted at the nearest ancestor sectioning element (or
   the <span>root element</span> if there is none) that has just
   <code>h1</code>-<code>h6</code> elements, <code>header</code>
   elements, the node itself, and sectioning elements other than
   <code>blockquote</code> elements. (Descendants of any of the nodes
   in this view can be ignored, as can any node later in the tree than
   the node in question, as the algorithm below merely walks backwards
   up this view.)</li>

   <li>Let <var title="">n</var> be an iterator for this view, initialised at
   the node in question.</li>

   <li>Let <var title="">c</var> be the current best candidate heading,
   initially null, and initially not used. It is used when top-level
   heading candidates are to be searched for (see below).</li>

   <li>Repeat these steps (which effectively goes backwards through
   the node's previous siblings) until an answer is found:

    <ol>

     <li>If <var title="">n</var> points to a node with no previous sibling,
     and <var title="">c</var> is null, then return the node's parent node as
     the answer. If the node has no parent node, return null as the
     answer.</li>

     <li>Otherwise, if <var title="">n</var> points to a node with no
     previous sibling, return <var title="">c</var> as the answer.</li>

     <li>Adjust <var title="">n</var> so that it points to the previous sibling
     of the current position.</li>

     <li>If <var title="">n</var> is pointing at an <code>h1</code> or
     <code>header</code> element, then return that element as the
     answer.</li>

     <li>If <var title="">n</var> is pointing at an
     <code>h2</code>-<code>h6</code> element, and heading candidates
     are not being searched for, then return that element as the
     answer.</li>

     <li>Otherwise, if <var title="">n</var> is pointing at an
     <code>h2</code>-<code>h6</code> element, and either <var title="">c</var>
     is still null, or <var title="">c</var> is a heading of lower
     <span>rank</span> than this one, then set <var title="">c</var> to be this
     element, and continue going backwards through the previous
     siblings.</li>

     <li>If <var title="">n</var> is pointing at a sectioning element, then
     from this point on top-level heading candidates are being
     searched for. (Specifically, we are looking for the nearest
     top-level header for the current section.) Continue going
     backwards through the previous siblings.</li>

    </ol>

   </li>

   <li>If the answer from the previous step (the loop) is null, which
   can only happen if the node has no preceeding headings and is not
   contained in a sectioning element, then there is no associated
   heading and no associated section.</li>

   <li>Otherwise, if the answer from the earlier loop step is a
   sectioning element, then the associated section is that element and
   the associated heading is that sectioning element's associated
   heading (i.e. repeat this algorithm for that section).</li>

   <li>Otherwise, if the answer from that same earlier step is an
   <code>h1</code>-<code>h6</code> element or a <code>header</code>
   element, then the associated heading is that element and the
   associated section is that heading element's associated
   section (i.e. repeat this algorithm for that heading).</li>

  </ol>

  <p class="note">Not all nodes have an associated header or section.
  For example, if a section is implied, as when multiple headers are
  found in one sectioning element, then a node in that section has an
  anonymous associated section (its section is not represented by a
  real element), and the algorithm above does not associate that node
  with any particular sectioning element.</p>

  <div class="example">
   <p>For the following fragment:</p>
   <pre>&lt;body&gt;
 &lt;h1&gt;X&lt;/h1&gt;
 &lt;h2&gt;X&lt;/h2&gt;
 &lt;blockquote&gt;
  &lt;h3&gt;X&lt;/h3&gt;
 &lt;/blockquote&gt;
 &lt;p id="a"&gt;X&lt;/p&gt;
 &lt;h4&gt;Text Node A&lt;/h4&gt;
 &lt;section&gt;
  &lt;h5&gt;X&lt;/h5&gt;
 &lt;/section&gt;
 &lt;p&gt;Text Node B&lt;/p&gt;
&lt;/body&gt;</pre>
   <p>The associations are as follows (not all associations are shown):</p>
   <table>
    <thead>
     <tr>
      <th>Node</th> <th>Associated heading</th> <th>Associated section</th>
     </tr>
    </thead>
    <tbody>
     <tr> <td><code>&lt;body&gt;</code></td> <td><code>&lt;h1&gt;</code></td> <td><code>&lt;body&gt;</code></td> </tr>
     <tr> <td><code>&lt;h1&gt;</code></td> <td><code>&lt;h1&gt;</code></td> <td><code>&lt;body&gt;</code></td> </tr>
     <tr> <td><code>&lt;h2&gt;</code></td> <td><code>&lt;h2&gt;</code></td> <td>None.</td> </tr>
     <tr> <td><code>&lt;blockquote&gt;</code></td> <td><code>&lt;h2&gt;</code></td> <td>None.</td> </tr>
     <tr> <td><code>&lt;h3&gt;</code></td> <td><code>&lt;h3&gt;</code></td> <td><code>&lt;blockquote&gt;</code></td> </tr>
     <tr> <td><code>&lt;p id="a"&gt;</code></td> <td><code>&lt;h2&gt;</code></td> <td>None.</td> </tr>
     <tr> <td><code>Text Node A</code></td> <td><code>&lt;h4&gt;</code></td> <td>None.</td> </tr>
     <tr> <td><code>Text Node B</code></td> <td><code>&lt;h1&gt;</code></td> <td><code>&lt;body&gt;</code></td> </tr>
    </tbody>
   </table>
  </div>




  <h3>Prose</h3>

  <h4>The <dfn><code>p</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level
  element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd><span title="significant inline content">Significant</span>
   <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-copyright">copyright</code>, <code
   title="class-error">error</code>, <code
   title="class-example">example</code>, <code
   title="class-issue">issue</code>, <code
   title="class-note">note</code>, <code
   title="class-search">search</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>p</code> element represents a
  <span>paragraph</span>.</p>

  <p><code>p</code> elements can contain a mixture of <span>strictly
  inline-level content</span>, such as text, images, hyperlinks, etc,
  and <span>structured inline-level elements</span>, such as lists,
  tables, and block quotes. <code>p</code> elements must not be <span
  title="significant inline content">empty</span>.</p>

  <div class="example">
   <p>The following examples are conforming HTML fragments:</p>
   <pre>&lt;p&gt;The little kitten gently seated himself on a piece of
carpet. Later in his life, this would be referred to as the time the
cat sat on the mat.&lt;/p&gt;</pre>
   <pre>&lt;fieldset&gt;
 &lt;legend&gt;Personal information&lt;/legend&gt;
 &lt;p&gt;
   &lt;label&gt;Name: &lt;input name="n"&gt;&lt;/label&gt;
   &lt;label&gt;&lt;input name="anon" type="checkbox"&gt; Hide from other users&lt;/label&gt;
 &lt;/p&gt;
 &lt;p&gt;&lt;label&gt;Address: &lt;textarea name="a"&gt;&lt;/textarea&gt;&lt;/label&gt;&lt;/p&gt;
&lt;/fieldset&gt;</pre>
   <pre>&lt;p&gt;There was once an example from Femley,&lt;br&gt;
Whose markup was of dubious quality.&lt;br&gt;
The validator complained,&lt;br&gt;
So the author was pained,&lt;br&gt;
To move the error from the markup to the rhyming.&lt;/p&gt;</pre>
  </div>

  <p>The <code>p</code> element should not be used when a more
  specific element is more appropriate.</p>

  <div class="example">

   <p>The following example is technically correct:</p>

<pre>&lt;section&gt;
 &lt;!-- ... --&gt;
 &lt;p&gt;Last modified: 2001-04-23&lt;/p&gt;
 &lt;p&gt;Author: fred@example.com&lt;/p&gt;
&lt;/section&gt;</pre>

   <p>However, it would be better marked-up as:</p>

<pre>&lt;section&gt;
 &lt;!-- ... --&gt;
 &lt;footer&gt;Last modified: 2001-04-23&lt;/footer&gt;
 &lt;address&gt;Author: fred@example.com&lt;/address&gt;
&lt;/section&gt;</pre>

   <p>Or:</p>

<pre>&lt;section&gt;
 &lt;!-- ... --&gt;
 &lt;footer&gt;
  &lt;p&gt;Last modified: 2001-04-23&lt;/p&gt;
  &lt;address&gt;Author: fred@example.com&lt;/address&gt;
 &lt;/footer&gt;
&lt;/section&gt;</pre>

  </div>


  <h4>The <dfn><code>hr</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level
  element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>hr</code> element represents a
  <span>paragraph</span>-level thematic break, e.g. a scene change in
  a story, or a transition to another topic within a section of a
  reference book.</p>


  <h4>The <dfn><code>br</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>br</code> element represents a line break.</p>

  <p><code>br</code> elements must be empty. Any content inside
  <code>br</code> elements must not be considered part of the
  surrounding text.</p>

  <p><code>br</code> elements must only be used for line breaks that
  are actually part of the content, as in poems or addresses.</p>

  <div class="example">

  <p>The following example is correct usage of the <code>br</code>
  element:</p>

   <pre>&lt;p&gt;P. Sherman&lt;br&gt;
42 Wallaby Way&lt;br&gt;
Sydney&lt;/p&gt;</pre>

  </div>

  <p><code>br</code> elements must not be used for separating thematic
  groups in a paragraph.</p>

  <div class="example">

   <p>The following examples are non-conforming, as they abuse the
   <code>br</code> element:</p>

   <pre>&lt;p&gt;&lt;a ...&gt;34 comments.&lt;/a&gt;&lt;br&gt;
&lt;a ...&gt;Add a comment.&lt;a&gt;&lt;/p&gt;</pre>

   <pre>&lt;p&gt;Name: &lt;input name="name"&gt;&lt;br&gt;
Address: &lt;input name="address"&gt;&lt;/p&gt;</pre>

   <p>Here are alternatives to the above, which are correct:</p>

   <pre>&lt;p&gt;&lt;a ...&gt;34 comments.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a ...&gt;Add a comment.&lt;a&gt;&lt;/p&gt;</pre>

   <pre>&lt;p&gt;Name: &lt;input name="name"&gt;&lt;/p&gt;
&lt;p&gt;Address: &lt;input name="address"&gt;&lt;/p&gt;</pre>

   <!-- XXX should have labels in the examples above -->

  </div>


  <h4>The <dfn><code>dialog</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more pairs of <code>dt</code> and <code>dd</code>
   elements.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>dialog</code> element represents a conversation.</p>

  <p>Each part of the conversation must have an explicit talker (or
  speaker) given by a <code>dt</code> element, and a discourse (or
  quote) given by a <code>dd</code> element.</p>

  <div class="example">
   <p>This example demonstrates this using an extract from Abbot and
   Costello's famous sketch, <cite>Who's on first</cite>:</p>
<pre>&lt;dialog>
 &lt;dt>Costello
 &lt;dd> Look, you gotta first baseman?
 &lt;dt> Abbott
 &lt;dd> Certainly.
 &lt;dt> Costello
 &lt;dd> Who's playing first?
 &lt;dt> Abbott
 &lt;dd> That's right.
 &lt;dt> Costello
 &lt;dd> When you pay off the first baseman every month, who gets the money?
 &lt;dt> Abbott
 &lt;dd> Every dollar of it. 
&lt;/dialog></pre>
  </div>

  <p class="note">Text in a <code>dt</code> element in a
  <code>dialog</code> element is implicitly the source of the text
  given in the following <code>dd</code> element, and the contents of
  the <code>dd</code> element are implicitly a quote from that
  speaker. There is thus no need to include <code>cite</code>,
  <code>q</code>, or <code>blockquote</code> elements in this
  markup. Indeed, a <code>q</code> element inside a <code>dd</code>
  element in a conversation would actually imply the person talking
  were themselves quoting someone else. See the <code>cite</code>,
  <code>q</code>, and <code>blockquote</code> elements for other ways
  to cite or quote.</p>


  <h3>Preformatted text</h3>

  <h4>The <dfn><code>pre</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  and <span title="structured inline-level elements">structured
  inline-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>structured inline-level elements</span> are allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>pre</code> element represents a block of preformatted
  text, in which structure is represented by typographic conventions
  rather than by elements.</p>

  <p>Some examples of cases where the <code>pre</code> element could
  be used:</p>

  <ul>

   <li>Including an e-mail, with paragraphs indicated by blank lines,
   lists indicated by lines prefixed with a bullet, and so on.</li>

   <li>Including fragments of computer code, with structure indicated
   according to the conventions of that language.</li>

   <li>Displaying ASCII art.</li> <!-- XXX need a note about non-visual UAs -->

  </ul>

  <p>If, ignoring <span title="text node">text nodes</span> consisting
  only of <span title="inter-element whitespace">whitespace</span>,
  the only child of a <code>pre</code> is a <code>code</code> element,
  then the <code>pre</code> element represents a block of computer
  code.</p>

  <p>If, ignoring <span title="text node">text nodes</span> consisting
  only of <span title="inter-element whitespace">whitespace</span>,
  the only child of a <code>pre</code> is a <code>samp</code> element,
  then the <code>pre</code> element represents a block of computer
  output.</p>

  <!-- XXX examples -->


  <h3>Lists</h3>

  <h4>The <dfn><code>ol</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  and <span title="structured inline-level elements">structured
  inline-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>structured inline-level elements</span> are allowed.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>li</code> elements.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-ol-start">start</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLOListElement</dfn> : <span>HTMLElement</span> {
           attribute long <span title="dom-ol-start">start</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>ol</code> element represents an ordered list of items
  (which are represented by <code>li</code> elements).</p>

  <p>The <dfn title="attr-ol-start"><code>start</code></dfn>
  attribute, if present, must be a <span>valid integer</span> giving
  the ordinal value of the first list item.</p>

  <p>If the <code title="attr-ol-start">start</code> attribute is
  present, user agents must <span title="rules for parsing
  integers">parse it as an integer</span>, in order to determine the
  attribute's value. The default value, used if the attribute is
  missing or if the value cannot be converted to a number according to
  the referenced algorithm, is 1.</p>

  <p>The items of the list are the <code>li</code> element child nodes
  of the <code>ol</code> element, in <span>tree order</span>.</p>

  <p>The first item in the list has the ordinal value given by the
  <code>ol</code> element's <code title="attr-ol-start">start</code>
  attribute, unless that <code>li</code> element has a <code
  title="attr-li-value">value</code> attribute with a value that can
  be successfully parsed, in which case it has the ordinal value given
  by that <code title="attr-li-value">value</code> attribute.</p>

  <p>Each subsequent item in the list has the ordinal value given by
  its <code title="attr-li-value">value</code> attribute, if it has
  one, or, if it doesn't, the ordinal value of the previous item, plus
  one.</p>

  <p>The <dfn title="dom-ol-start"><code>start</code></dfn> DOM
  attribute must <span>reflect</span> the value of the <code
  title="attr-ol-start">start</code> content attribute.</p>

  <!-- XXX resuming numbering of lists from previous lists? -->
  <!-- XXX counting up and down? -->
  <!-- XXX reverse-counted lists? -->


  <h4>The <dfn><code>ul</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  and <span title="structured inline-level elements">structured
  inline-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>structured inline-level elements</span> are allowed.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>li</code> elements.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>ul</code> element represents an unordered list of items
  (which are represented by <code>li</code> elements).</p>

  <p>The items of the list are the <code>li</code> element child nodes
  of the <code>ul</code> element.</p>


  <h4>The <dfn><code>li</code></dfn> element</h4>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Inside <code>ol</code> elements.</dd>
   <dd>Inside <code>ul</code> elements.</dd>
   <dd>Inside <code>menu</code> elements.</dd>
   <dt>Content model:</dt>
   <dd>When the element is a child of an <code>ol</code> or
   <code>ul</code> element and the grandchild of an element that is
   <span title="Determining if a particular element contains
   block-level elements or inline-level content">being used as an
   inline-level content container</span>, or, when the element is a
   child of a <code>menu</code> element:
   <span>inline-level content</span>.</dd>
   <dd>Otherwise: zero or more <span>block-level elements</span>, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>If the element is a child of an <code>ol</code> element: <code title="attr-li-value">value</code></dd>
   <dd>If the element is not the child of an <code>ol</code> element: None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLLIElement</dfn> : <span>HTMLElement</span> {
           attribute long <span title="dom-li-value">value</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>li</code> element represents a list item. If its parent
  element is an <code>ol</code>, <code>ul</code>, or <code>menu</code>
  element, then the element is an item of the parent element's list,
  as defined for those elements. Otherwise, the list item has no
  defined list-related relationship to any other <code>li</code>
  element.</p>

  <p>When the list item is the child of an <code>ol</code> or
  <code>ul</code> element, the content model of the item depends on
  the way that parent element was used. If it was used as structured
  inline content (i.e. if <em>that</em> element's parent was <span
  title="Determining if a particular element contains block-level
  elements or inline-level content">used as an inline-level
  content</span> container), then the <code>li</code> element must
  only contain <span>inline-level content</span>. Otherwise, the
  element may be used either for <span title="inline-level
  content">inline content</span> or <span>block-level
  elements</span>.</p>

  <p>When the list item is the child of a <code>menu</code> element,
  the <code>li</code> element must contain only <span>inline-level
  content</span>.</p>

  <p>When the list item is not the child of an <code>ol</code>,
  <code>ul</code>, or <code>menu</code> element, e.g. because it is an
  orphaned node not in the document, it may contain either for <span
  title="inline-level content">inline content</span> or
  <span>block-level elements</span>.

  <p>When <span title="Determining if a particular element contains
  block-level elements or inline-level content">used as an
  inline-level content</span> container, the list item represents a
  single <span>paragraph</span>.</p>

  <p>The <dfn title="attr-li-value"><code>value</code></dfn>
  attribute, if present, must be a <span>valid integer</span> giving
  the ordinal value of the first list item.</p>

  <p>If the <code title="attr-li-value">value</code> attribute is
  present, user agents must <span title="rules for parsing
  integers">parse it as an integer</span>, in order to determine the
  attribute's value. If the attribute's value cannot be converted to a
  number, it must be treated as if the attribute was absent. The
  attribute has no default value.</p>

  <p>The <code title="attr-li-value">value</code> attribute is
  processed relative to the element's parent <code>ol</code> element
  (q.v.), if there is one. If there is not, the attribute has no
  effect.</p>

  <p>The <dfn title="dom-li-value"><code>value</code></dfn> DOM
  attribute must <span>reflect</span> the value of the <code
  title="dom-li-value">value</code> content attribute.</p>


  <h4>The <dfn><code>dl</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  and <span title="structured inline-level elements">structured
  inline-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>structured inline-level elements</span> are allowed.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more groups each consisting of one or more
   <code>dt</code> elements followed by one or mode <code>dd</code>
   elements.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>dl</code> element introduces an unordered association
  list consisting of zero or more name-value groups (a description
  list). Each group must consist of one or more names (<code>dt</code>
  elements) followed by one or more values (<code>dd</code>
  elements).</p>

  <p>Name-value groups may be terms and definitions, metadata topics
  and values, or any other groups of name-value data.</p>

  <div class="example">
   <p>The following are all conforming HTML fragments.</p>
   <p>In the following example, one entry ("Authors") is linked to two
   values ("John" and "Luke").</p>
   <pre>&lt;dl&gt;
 &lt;dt&gt; Authors
 &lt;dd&gt; John
 &lt;dd&gt; Luke
 &lt;dt&gt; Editor
 &lt;dd&gt; Frank
&lt;/dl&gt;</pre>
   <p>In the following example, one definition is linked to two
   terms.</p>
   <pre>&lt;dl&gt;
 &lt;dt lang="en-US"&gt; &lt;dfn>color&lt;/dfn> &lt;/dt&gt;
 &lt;dt lang="en-GB"&gt; &lt;dfn>colour&lt;/dfn> &lt;/dt&gt;
 &lt;dd&gt; A sensation which (in humans) derives from the ability of
 the fine structure of the eye to distinguish three differently
 filtered analyses of a view. &lt;/dd&gt;
&lt;/dl&gt;</pre>
   <p>The following example illustrates the use of the <code>dl</code>
   element to mark up metadata of sorts. At the end of the example,
   one group has two metadata labels ("Authors" and "Editors") and two
   values ("Robert Rothman" and "Daniel Jackson").</p>
   <pre>&lt;dl&gt;
 &lt;dt&gt; Last modified time &lt;/dt&gt;
 &lt;dd&gt; 2004-12-23T23:33Z &lt;/dd&gt;
 &lt;dt&gt; Recommended update interval &lt;/dt&gt;
 &lt;dd&gt; 60s &lt;/dd&gt;
 &lt;dt&gt; Authors &lt;/dt&gt;
 &lt;dt&gt; Editors &lt;/dt&gt;
 &lt;dd&gt; Robert Rothman &lt;/dd&gt;
 &lt;dd&gt; Daniel Jackson &lt;/dd&gt;
&lt;/dl&gt;</pre>
  </div>

  <p>If a <code>dl</code> element is empty, it contains no groups.</p>

  <p>If a <code>dl</code> element contains non-<span
  title="inter-element whitespace">whitespace</span> <span title="text
  node">text nodes</span>, or elements other than <code>dt</code> and
  <code>dd</code>, then those elements or <span title="text node">text
  nodes</span> do not form part of any groups in that <code>dl</code>,
  and the document is non-conforming.</p>

  <p>If a <code>dl</code> element contains only <code>dt</code>
  elements, then it consists of one group with names but no values,
  and the document is non-conforming.</p>

  <p>If a <code>dl</code> element contains only <code>dd</code>
  elements, then it consists of one group with values but no names,
  and the document is non-conforming.</p>

  <p class="note">The <code>dl</code> element is inappropriate for
  marking up dialogue, since dialogue is ordered (each speaker/line
  pair comes after the next). For an example of how to mark up
  dialogue, see the <code>dialog</code> element.</p>


  <h4>The <dfn><code>dt</code></dfn> element</h4>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Before <code>dd</code> or <code>dt</code> elements inside <code>dl</code> elements.</dd>
   <dd>Before a <code>dd</code> element inside a <code>dialog</code> element.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>dt</code> element represents the term, or name, part of
  a term-description group in a description list (<code>dl</code>
  element), and the talker, or speaker, part of a talker-discourse
  pair in a conversation (<code>dialog</code> element).</p>

  <p class="note">The <code>dt</code> element itself, when used in a
  <code>dl</code> element, does not indicate that its contents are a
  term being defined, but this can be indicated using the
  <code>dfn</code> element.</p>


  <h4>The <dfn><code>dd</code></dfn> element</h4>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>After <code>dt</code> or <code>dd</code> elements inside <code>dl</code> elements.</dd>
   <dd>After a <code>dt</code> element inside a <code>dialog</code> element.</dd>
   <dt>Content model:</dt>
   <dd>When the element is a child of a <code>dl</code> element and
   the grandchild of an element that is <span title="Determining if a
   particular element contains block-level elements or inline-level
   content">being used as an inline-level content container</span>:
   <span>inline-level content</span>.</dd>
   <dd>Otherwise: zero or more <span>block-level elements</span>, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>dd</code> element represents the description,
  definition, or value, part of a term-description group in a
  description list (<code>dl</code> element), and the discourse, or
  quote, part in a conversation (<code>dialog</code> element).</p>

  <p>The content model of a <code>dd</code> element depends on the way
  its parent element is being used. If the parent element is a
  <code>dl</code> element that is being used as structured inline
  content (i.e. if the <code>dl</code> element's parent element is
  being <span title="Determining if a particular element contains
  block-level elements or inline-level content">used as an
  inline-level content</span> container), then the <code>dd</code>
  element must only contain <span>inline-level content</span>.</p>

  <p>Otherwise, the element may be used either for <span
  title="inline-level content">inline content</span> or
  <span>block-level elements</span>.</p>


  <h3>Phrase elements</h3>

  <!-- XXXX ruby (delayed until someone can define it with error handling rules) -->

  <h4>The <dfn><code>a</code></dfn> element</h4>

  <p><span title="interactive elements">Interactive</span>,
  <span>strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed, if
   there are no ancestor <span>interactive elements</span>.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span
   title="significant inline content">significant</span> <span>strictly
   inline-level content</span>, but there must be no <span
   title="interactive elements">interactive</span> descendants.</dd>
   <dd>Otherwise: any <span title="significant inline
   content">significant</span> <span>inline-level content</span>, but
   there must be no <span title="interactive
   elements">interactive</span> descendants.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-hyperlink-href">href</code></dd>
   <dd><code title="attr-hyperlink-rel">rel</code></dd>
   <dd><code title="attr-hyperlink-media">media</code></dd>
   <dd><code title="attr-hyperlink-hreflang">hreflang</code></dd>
   <dd><code title="attr-hyperlink-type">type</code></dd>
   <dd><code title="attr-hyperlink-ping">ping</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLAnchorElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-a-href">href</span>;
           attribute DOMString <span title="dom-a-rel">rel</span>;
  readonly attribute DOMTokenList <span title="dom-a-relList">relList</span>;
           attribute DOMString <span title="dom-a-media">media</span>;
           attribute DOMString <span title="dom-a-hreflang">hreflang</span>;
           attribute DOMString <span title="dom-a-type">type</span>;
           attribute DOMString <span title="dom-a-ping">ping</span>;
};</pre>
    <p>The <code title="command-ro">Command</code> interface must also be implemented by
    this element.</p>
   </dd>
  </dl>

  <p>If the <code>a</code> element has an <code
  title="attr-hyperlink-href">href</code> attribute, then it
  represents a <span>hyperlink</span>.</p>

  <p>If the <code>a</code> element has no <code
  title="attr-hyperlink-href">href</code> attribute, then the element
  is a placeholder for where a link might otherwise have been placed,
  if it had been relevant.</p>

  <div class="example">
   <p>If a site uses a consistent navigation toolbar on every page,
   then the link that would normally link to the page itself could be
   marked up using an <code>a</code> element:</p>
   <pre>&lt;nav>
 &lt;ul>
  &lt;li> &lt;a href="/">Home&lt;/a> &lt;/li>
  &lt;li> &lt;a href="/news">News&lt;/a> &lt;/li>
  &lt;li> &lt;a>Examples&lt;/a> &lt;/li>
  &lt;li> &lt;a href="/legal">Legal&lt;/a> &lt;/li>
 &lt;/ul>
&lt;/nav></pre>
  </div>

  <p>Interactive user agents should allow users to <span
  title="following hyperlinks">follow hyperlinks</span> created using
  the <code>a</code> element. The <code
  title="attr-hyperlink-href">href</code> and <code
  title="attr-hyperlink-ping">ping</code> attributes decide how the
  link is followed. The <code title="attr-hyperlink-rel">rel</code>,
  <code title="attr-hyperlink-media">media</code>, <code
  title="attr-hyperlink-hreflang">hreflang</code>, and <code
  title="attr-hyperlink-type">type</code> attributes may be used to
  indicate to the user the likely nature of the target resource before
  the user follows the link.</p>

  <p>The <span>activation behavior</span> of <code>a</code> elements
  that represent <span>hyperlinks</span> is to run the following
  steps:</p>

  <ol>

   <li><p>If the <code title="event-DOMActivate">DOMActivate</code>
   event in question is not <span
   title="concept-events-trusted">trusted</span> (i.e. a <code
   title="dom-click">click()</code> method call was the reason for the
   event being dispatched), and the <code>a</code> element's <code
   title="attr-a-target">target</code> attribute is <span
   class="big-issue">...</span> then raise an
   <code>INVALID_ACCESS_ERR</code> exception and abort these
   steps.</p></li>

   <li><p>If the target of the <code
   title="event-DOMActivate">DOMActivate</code> event is an
   <code>img</code> element with an <code
   title="attr-img-ismap">ismap</code> attribute specified, then
   server-side image map processing must be performed, as follows:</p>

    <ol>

     <!-- http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A...%3Ca%20href%3D%22%23%22%3E%3Cimg%20ismap%20usemap%3D%22%23a%22%20src%3D/resources/images/smallcats%3E%3C/a%3E%0A%3Cmap%20name%3Da%3E%3Carea%20shape%3Drect%20coords%3D0%2C0%2C50%2C50%20href%3Db%3E%3C/map%3E -->

     <li>If the <code title="event-DOMActivate">DOMActivate</code>
     event was dispatched as the result of a real
     pointing-device-triggered <code title="event-click">click</code>
     event on the <code>img</code> element, then let <var
     title="">x</var> be the distance in CSS pixels from the left edge
     of the image to the location of the click, and let <var
     title="">y</var> be the distance in CSS pixels from the top edge
     of the image to the location of the click. Otherwise, let <var
     title="">x</var> and <var title="">y</var> be zero.</li>

     <li>Let the <var title="">hyperlink suffix</var> be a U+003F
     QUESTION MARK character, the value of <var title="">x</var>
     expressed as a base-ten integer using ASCII digits (U+0030 DIGIT
     ZERO to U+0039 DIGIT NINE), a U+002C COMMA character, and the
     value of <var title="">y</var> expressed as a base-ten integer
     using ASCII digits.</li>

    </ol>

   </li>

   <li><p>Finally, the user agent must <span title="following
   hyperlinks">follow the hyperlink</span> defined by the
   <code>a</code> element. If the steps above defined a <var
   title="">hyperlink suffix</var>, then take that into account when
   following the hyperlink.</p></li>

  </ol>

  <p class="note">One way that a user agent can enable users to follow
  hyperlinks is by allowing <code>a</code> elements to be clicked, or
  focussed and activated by the keyboard. This <span
  title="interactive elements">will cause</span> the aforementioned
  <span>activation behavior</span> to be invoked.</p>

  <p>The <code>a</code> element must not be <span title="significant
  inline content">empty</span>.</p>

  <p>The DOM attributes <dfn
  title="dom-a-href"><code>href</code></dfn>, <dfn
  title="dom-a-rel"><code>rel</code></dfn>, <dfn
  title="dom-a-media"><code>media</code></dfn>, <dfn
  title="dom-a-hreflang"><code>hreflang</code></dfn>, <dfn
  title="dom-a-type"><code>type</code></dfn>, and <dfn
  title="dom-a-ping"><code>ping</code></dfn> each must
  <span>reflect</span> the respective content attributes of the same
  name.</p>

  <p>The DOM attribute <dfn
  title="dom-a-rellist"><code>relList</code></dfn> must
  <span>reflect</span> the <code title="attr-hyperlink-rel">rel</code>
  content attribute.</p>



  <h4>The <dfn><code>q</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-q-cite">cite</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
    The <code>q</code> element uses the <code>HTMLQuoteElement</code> interface.
   </dd>
  </dl>

  <p>The <code>q</code> element represents a part of a paragraph
  quoted from another source.</p>

  <p>Content inside a <code>q</code> element must be quoted from
  another source, whose URI, if it has one, should be cited in the
  <dfn title="attr-q-cite"><code>cite</code></dfn> attribute.</p>

  <p>If the <code title="attr-q-cite">cite</code> attribute is
  present, it must be a URI (or IRI). User agents should allow
  users to follow such citation links.</p>

  <p>If a <code>q</code> element is contained (directly or indirectly)
  in a <span>paragraph</span> that contains a single <code>cite</code>
  element and has no other <code>q</code> element descendants, then,
  the citation given by that <code>cite</code> element gives the
  source of the quotation contained in the <code>q</code> element.</p>

  <!-- XXX need examples -->


  <h4>The <dfn><code>cite</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
   <!-- XXX should the cite element have a cite attribute? -->
  </dl>

  <p>The <code>cite</code> element represents a citation: the source,
  or reference, for a quote or statement made in the document.</p>

  <p class="note">A <em>citation</em> is not a <em>quote</em> (for
  which the <code>q</code> element is appropriate).</p>

  <div class="example">

   <p>This is incorrect usage:</p>

   <pre>&lt;p>&lt;cite>This is wrong!&lt;/cite>, said Ian.&lt;/p></pre>

   <p>This is the correct way to do it:</p>

   <pre>&lt;p>&lt;q>This is correct!&lt;/q>, said &lt;cite>Ian&lt;/cite>.&lt;/p></pre>

   <p>This is also wrong, because the title and the name are not
   references or citations:</p>

   <pre>&lt;p>My favourite book is &lt;cite>The Reality Dysfunction&lt;/cite>
by &lt;cite>Peter F. Hamilton&lt;/cite>.&lt;/p></pre>

   <p>This is correct, because even though the source is not quoted, it is cited:</p>

   <pre>&lt;p>According to &lt;cite>the Wikipedia article on
HTML&lt;/cite>, HTML is defined in formal specifications that were
developed and published throughout the 1990s.&lt;/p></pre>

  </div>

  <p class="note">The <code>cite</code> element can apply to
  <code>blockquote</code> and <code>q</code> elements in certain cases
  described in the definitions of those elements.</p>


  <h4>The <dfn><code>em</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>em</code> element represents stress emphasis of its
  contents.</p>

  <p>The level of emphasis that a particlar piece of content has is
  given by its number of ancestor <code>em</code> elements.</p>

  <p>The placement of emphasis changes the meaning of the sentence.
  The element thus forms an integral part of the content. The precise
  way in which emphasis is used in this way depends on the
  language.</p>

  <div class="example">

   <p>These examples show how changing the emphasis changes the
   meaning. First, a general statement of fact, with no emphasis:</p>

   <pre>&lt;p>Cats are cute animals.&lt;/p></pre>

   <p>By emphasising the first word, the statement implies that the
   kind of animal under discussion is in question (maybe someone is
   asserting that dogs are cute):</p>

   <pre>&lt;p>&lt;em>Cats&lt;/em> are cute animals.&lt;/p></pre>

   <p>Moving the emphasis to the verb, one highlights that the truth
   of the entire sentence is in question (maybe someone is saying cats
   are not cute):</p>

   <pre>&lt;p>Cats &lt;em>are&lt;/em> cute animals.&lt;/p></pre>

   <p>By moving it to the adjective, the exact nature of the cats
   is reasserted (maybe someone suggested cats were <em>mean</em>
   animals):</p>

   <pre>&lt;p>Cats are &lt;em>cute&lt;/em> animals.&lt;/p></pre>

   <p>Similarly, if someone asserted that cats were vegetables,
   someone correcting this might emphasise the last word:</p>

   <pre>&lt;p>Cats are cute &lt;em>animals&lt;/em>.&lt;/p></pre>

   <p>By emphasising the entire sentence, it becomes clear that the
   speaker is fighting hard to get the point across. This kind of
   emphasis also typically affects the punctuation, hence the
   exclamation mark here.</p>

   <pre>&lt;p>&lt;em>Cats are cute animals!&lt;/em>&lt;/p></pre>

   <p>Anger mixed with emphasising the cuteness could lead to markup
   such as:</p>

   <pre>&lt;p>&lt;em>Cats are &lt;em>cute&lt;/em> animals!&lt;/em>&lt;/p></pre>

  </div>

  <!-- XXX should say it is wrong to use as in:

   <p><em>Note</em>: ...</p>

  -->


  <h4>The <dfn><code>strong</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-error">error</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>strong</code> element represents strong importance for
  its contents.</p>

  <p>The relative level of importance of a piece of content is given
  by its number of ancestor <code>strong</code> elements; each
  <code>strong</code> element increases the importance of its
  contents.</p>

  <p>Changing the importance of a piece of text with the
  <code>strong</code> element does not change the meaning of the
  sentence.</p>

  <div class="example">
   <p>Here is an example of a warning notice in a game, with the
   various parts marked up according to how important they are:</p>
   <!-- DO NOT REFLOW THIS EXAMPLE it has been carefully balanced -->
   <pre>&lt;p>&lt;strong>Warning.&lt;/strong> This dungeon is dangerous.
&lt;strong>Avoid the ducks.&lt;/strong> Take any gold you find.
&lt;strong>&lt;strong>Do not take any of the diamonds&lt;/strong>,
they are explosive and &lt;strong>will destroy anything within
ten meters.&lt;/strong>&lt;/strong> You have been warned.&lt;/p></pre>
  </div>

  <h4>The <dfn><code>small</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>small</code> element represents small print (part of a
  document often describing legal restrictions, such as copyrights or
  other disadvantages), or other side comments.</p>

  <p class="note">The <code>small</code> element does not
  "de-emphasise" or lower the importance of text emphasised by the
  <code>em</code> element or marked as important with the
  <code>strong</code> element.</p>

  <div class="example">

   <p>In this example the footer contains contact information and a
   copyright.</p>

   <pre>&lt;footer>
 &lt;address>
  For more details, contact
  &lt;a href="mailto:js@example.com">John Smith&lt;/a>.
 &lt;/address>
 &lt;p>&lt;small>&copy; copyright 2038 Example Corp.&lt;/small>&lt;/p>
&lt;/footer></pre>

   <p>In this second example, the <code>small</code> element is used
   for a side comment.</p>

   <pre>&lt;p>Example Corp today announced record profits for the
second quarter &lt;small>(Full Disclosure: Foo News is a subsidiary of
Example Corp)&lt;/small>, leading to speculation about a third quarter
merger with Demo Group.&lt;/p></pre>

   <p>In this last example, the <code>small</code> element is marked
   as being <em>important</em> small print.</p>

   <pre>&lt;p>&lt;strong>&lt;small>Continued use of this service will result in a kiss.&lt;/small>&lt;/strong>&lt;/p></pre>

  </div>

  <h4>The <dfn><code>m</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>m</code> element represents a run of text marked or
  highlighted.</p>

  <div class="example">

   <p>In the following snippet, a paragraph of text refers to a
   specific part of a code fragment.</p>

   <pre>&lt;p>The highlighted part below is where the error lies:&lt;/p>
&lt;pre>&lt;code>var i: Integer;
begin
   i := &lt;m>1.1&lt;/m>;
end.&lt;/code>&lt;/pre></pre>

   <p>Another example of the <code>m</code> element is highlighting
   parts of a document that are matching some search string. If
   someone looked at a document, and the server knew that the user was
   searching for the word "kitten", then the server might return the
   document with one paragraph modified as follows:</p>

   <pre>&lt;p>I also have some &lt;m>kitten&lt;/m>s who are visiting me
these days. They're really cute. I think they like my garden!&lt;/p></pre>

  </div>



  <h4>The <dfn><code>dfn</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed, if
   there are no ancestor <code>dfn</code> elements.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>, but there must be
   no descendant <code>dfn</code> elements.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-dfn-title">title</code> attribute has special semantics on this element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>dfn</code> element represents the defining instance of
  a term. The <span>paragraph</span>, <span title="dl">description
  list group</span>, or <span title="sectioning
  elements">section</span> that contains the <code>dfn</code> element
  contains the definition for the term given by the contents of the
  <code>dfn</code> element.</p>

  <p><code>dfn</code> elements must not be nested.</p>

  <p><dfn>Defining term</dfn>: If the <code>dfn</code> element has a
  <dfn title="attr-dfn-title"><code>title</code></dfn> attribute, then
  the exact value of that attribute is the term being defined.
  Otherwise, if it contains exactly one element child node and no
  child <span title="text node">text nodes</span>, and that child
  element is an <code>abbr</code> element with a <code
  title="attr-abbr-title">title</code> attribute, then the exact value
  of <em>that</em> attribute is the term being defined. Otherwise, it
  is the exact <code>textContent</code> of the <code>dfn</code>
  element that gives the term being defined.</p>

  <!-- XXX that means <dfn>x \n x</dfn> won't match <span>x x</span> -->

  <p>If the <code title="attr-dfn-title">title</code> attribute of the
  <code>dfn</code> element is present, then it must only contain the
  term being defined.</p>

  <p>There must only be one <code>dfn</code> element per document for
  each term defined (i.e. there must not be any duplicate <span
  title="defining term">terms</span>).</p>

  <p class="note">The <code title="attr-title">title</code> attribute
  of ancestor elements does not affect <code>dfn</code> elements.</p>

  <p>The <code>dfn</code> element enables automatic cross-references.
  Specifically, any <code>span</code>, <code>abbr</code>,
  <code>code</code>, <code>var</code>, <code>samp</code>, or
  <code>i</code> element that has a non-empty <code
  title="attr-title">title</code> attribute whose value exactly equals
  the <span title="defining term">term</span> of a <code>dfn</code>
  element in the same document, or which has no <code
  title="attr-title">title</code> attribute but whose
  <code>textContent</code> exactly equals the <span title="defining
  term">term</span> of a <code>dfn</code> element in the document, and
  that has no <span>interactive elements</span> or <code>dfn</code>
  elements either as ancestors or descendants, and has no other
  elements as ancestors that are themselves matching these conditions,
  should be presented in such a way that the user can jump from the
  element to the first <code>dfn</code> element giving the defining
  instance of that term.</p>

  <!-- XXX that means <dfn>x x</dfn> won't match <span>x \n x</span> -->

  <!-- need to mention that <span> is useful for cross-refs that don't
  actually use the term itself -->

  <div class="example">

   <p>In the following fragment, the term "GDO" is first defined in
   the first paragraph, then used in the second. A compliant UA could
   provide a link from the <code>abbr</code> element in the second
   paragraph to the <code>dfn</code> element in the first.</p>

   <pre>&lt;p>The &lt;dfn>&lt;abbr title="Garage Door Opener">GDO&lt;/abbr>&lt;/dfn>
is a device that allows off-world teams to open the iris.&lt;/p>
&lt;!-- ... later in the document: -->
&lt;p>Teal'c activated his &lt;abbr title="Garage Door Opener">GDO&lt;/abbr>
and so Hammond ordered the iris to be opened.&lt;/p></pre>

   <!-- XXX need some examples of nesting where the top element makes
   a crossref but the inner ones don't despite also matching the
   algorithm above -->

   <!-- XXX need some examples of duplicates being bad, of title
   attributes being bad, etc -->

  </div>


  <h4>The <dfn><code>abbr</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-abbr-title">title</code> attribute has special semantics on this element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>abbr</code> element represents an abbreviation or
  acronym. The <dfn title="attr-abbr-title"><code>title</code></dfn>
  attribute should be used to provide an expansion of the
  abbreviation. If present, the attribute must only contain an
  expansion of the abbreviation.</p>

  <div class="example">
   <p>The paragraph below contains an abbreviation marked up with the
   <code>abbr</code> element.</p>
   <pre>&lt;p>The &lt;abbr title="Web Hypertext Application Technology
Working Group">WHATWG&lt;/abbr> is a loose unofficial collaboration of
Web browser manufacturers and interested parties who wish to develop
new technologies designed to allow authors to write and deploy
Applications over the World Wide Web.&lt;/p></pre>
  </div>

  <p>The <code title="attr-abbr-title">title</code> attribute may be
  omitted if there is a <code>dfn</code> element in the document whose
  <span>defining term</span> is the abbreviation (the
  <code>textContent</code> of the <code>abbr</code> element).</p>

  <div class="example">

   <p>In the example below, the word "Zat" is used as an abbreviation
   in the second paragraph. The abbreviation is defined in the first,
   so the explanatory <code title="attr-abbr-title">title</code>
   attribute has been omitted. Because of the way <code>dfn</code>
   elements are defined, the second <code>abbr</code> element in this
   example would be connected (in some UA-specific way) to the
   first.</p>

   <pre>&lt;p>The &lt;dfn>&lt;abbr>Zat&lt;/abbr>&lt;/dfn>, short for Zat'ni'catel, is a weapon.&lt;/p>
&lt;p>Jack used a &lt;abbr>Zat&lt;/abbr> to make the boxes of evidence disappear.&lt;/p></pre>

  </div>


  <h4>The <dfn><code>time</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-time-datetime">datetime</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLTimeElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-time-datetime">datetime</span>;
  readonly attribute DOMTimeStamp <span title="dom-time-date">date</span>;
  readonly attribute DOMTimeStamp <span title="dom-time-time">time</span>;
  readonly attribute DOMTimeStamp <span title="dom-time-timezone">timezone</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>time</code> element represents a date and/or a time.</p>

  <p>The <dfn title="attr-time-datetime"><code>datetime</code></dfn>
  attribute, if present, must contain a <span>date or time
  string</span> that identifies the date or time being specified.</p>

  <p>If the <code title="attr-time-datetime">datetime</code> attribute is
  not present, then the date or time must be specified in the content
  of the element, such that parsing the element's
  <code>textContent</code> according to the rules for parsing <span
  title="date or time string in content">date or time strings in
  content</span> successfully extracts a date or time.</p>

  <p>The <dfn title="dom-time-datetime"><code>datetime</code></dfn> DOM
  attribute must <span>reflect</span> the <code
  title="attr-time-datetime">datetime</code> content attribute.</p>

  <p>User agents, to obtain the <dfn
  title="concept-time-date">date</dfn>, <dfn
  title="concept-time-time">time</dfn>, and <dfn
  title="concept-time-timezone">timezone</dfn> represented by a
  <code>time</code> element, must follow the following steps:</p>

  <ol>

   <li>If the <code title="attr-time-datetime">datetime</code> attribute
   is present, then parse it according to the rules for parsing <span
   title="date or time string in attributes">date or time strings in
   content</span>, and let the result be <var
   title="">result</var>.</li>

   <li>Otherwise, parse the element's <code>textContent</code>
   according to the rules for parsing <span title="date or time string
   in attributes">date or time strings in content</span>, and let the
   result be <var title="">result</var>.</li>

   <li>If <var title="">result</var> is empty (because the parsing
   failed), then the <span title="concept-time-date">date</span> is
   unknown, the <span title="concept-time-time">time</span> is unknown,
   and the <span title="concept-time-timezone">timezone</span> is
   unknown.</li>

   <li>Otherwise: if <var title="">result</var> contains a date, then
   that is the <span title="concept-time-date">date</span>; if <var
   title="">result</var> contains a time, then that is the <span
   title="concept-time-time">time</span>; and if <var
   title="">result</var> contains a timezone, then the timezone is the
   element's <span title="concept-time-timezone">timezone</span>. (A
   timezone can only be present if both a date and a time are also
   present.)</li>

  </ol>

  <p>The <dfn title="dom-time-date"><code>date</code></dfn> DOM attribute
  must return null if the <span title="concept-time-date">date</span> is
  unknown, and otherwise must return the time corresponding to
  midnight UTC (i.e. the first second) of the given <span
  title="concept-time-date">date</span>.</p>

  <p>The <dfn title="dom-time-time"><code>time</code></dfn> DOM attribute
  must return null if the <span title="concept-time-time">time</span> is
  unknown, and otherwise must return the time corresponding to the
  given <span title="concept-time-time">time</span> of 1970-01-01, with
  the timezone UTC.</p>

  <p>The <dfn title="dom-time-timezone"><code>timezone</code></dfn> DOM
  attribute must return null if the <span
  title="concept-time-timezone">timezone</span> is unknown, and otherwise
  must return the time corresponding to 1970-01-01 00:00 UTC in the
  given <span title="concept-time-timezone">timezone</span>, with the
  timezone set to UTC (i.e. the time corresponding to 1970-01-01 at
  00:00 UTC plus the offset corresponding to the timezone).</p>

  <div class="example">

   <p>In the following snippet:</p>

   <pre>&lt;p>Our first date was &lt;time datetime="2006-09-23">a saturday&lt;/time>.&lt;/p></pre>

   <p>...the <code>time</code> element's <code
   title="dom-time-date">date</code> attribute would have the value
   1,158,969,600,000ms, and the <code title="dom-time-time">time</code>
   and <code title="dom-time-timezone">timezone</code> attributes would
   return null.</p>


   <p>In the following snippet:</p>

   <pre>&lt;p>We stopped talking at &lt;time datetime="2006-09-24 05:00 -7">5am the next morning&lt;/time>.&lt;/p></pre>

   <p>...the <code>time</code> element's <code
   title="dom-time-date">date</code> attribute would have the value
   1,159,056,000,000ms, the <code title="dom-time-time">time</code>
   attribute would have the value 18,000,000ms, and the <code
   title="dom-time-timezone">timezone</code> attribute would return
   -25,200,000ms. To obtain the actual time, the three attributes can
   be added together, obtaining 1,159,048,800,000, which is the
   specified date and time in UTC.</p>


   <p>Finally, in the following snippet:</p>

   <pre>&lt;p>Many people get up at &lt;time>08:00&lt;/time>.&lt;/p></pre>

   <p>...the <code>time</code> element's <code
   title="dom-time-date">date</code> attribute would have the value null,
   the <code title="dom-time-time">time</code> attribute would have the
   value 28,800,000ms, and the <code
   title="dom-time-timezone">timezone</code> attribute would return
   null.</p>

  </div>

  <p class="big-issue">These APIs may be suboptimal. Comments on
  making them more useful to JS authors are welcome. The primary use
  cases for these elements are for marking up publication dates
  e.g. in blog entries, and for marking event dates in hCalendar
  markup. Thus the DOM APIs are likely to be used as ways to generate
  interactive calendar widgets or some such.</p>



  <h4>The <dfn><code>meter</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-meter-value">value</code></dd>
   <dd><code title="attr-meter-min">min</code></dd>
   <dd><code title="attr-meter-low">low</code></dd>
   <dd><code title="attr-meter-high">high</code></dd>
   <dd><code title="attr-meter-max">max</code></dd>
   <dd><code title="attr-meter-optimum">optimum</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLMeterElement</dfn> : <span>HTMLElement</span> {
           attribute long <span title="dom-meter-value">value</span>;
           attribute long <span title="dom-meter-min">min</span>;
           attribute long <span title="dom-meter-max">max</span>;
           attribute long <span title="dom-meter-low">low</span>;
           attribute long <span title="dom-meter-high">high</span>;
           attribute long <span title="dom-meter-optimum">optimum</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>meter</code> element represents a scalar measurement
  within a known range, or a fractional value; for example disk usage,
  the relevance of a query result, or the fraction of a voting
  population to have selected a particular candidate.</p>

  <p>This is also known as a gauge.</p>

  <p class="note">The <code>meter</code> element should not be used to
  indicate progress (as in a progress bar). For that role, HTML
  provides a separate <code>progress</code> element.</p>

  <p>There are six attributes that determine the semantics of the
  gauge represented by the element.</p>

  <p>The <dfn title="attr-meter-min"><code>min</code></dfn> attribute
  specifies the lower bound of the range, and the <dfn
  title="attr-meter-max"><code>max</code></dfn> attribute specifies
  the upper bound. The <dfn
  title="attr-meter-value"><code>value</code></dfn> attribute
  specifies the value to have the gauge indicate as the "measured"
  value.</p>

  <p>The other three attributes can be used to segment the gauge's
  range into "low", "medium", and "high" parts, and to indicate which
  part of the gauge is the "optimum" part. The <dfn
  title="attr-meter-low"><code>low</code></dfn> attribute specifies
  the range that is considered to be the "low" part, and the <dfn
  title="attr-meter-high"><code>high</code></dfn> attribute specifies
  the range that is considered to be the "high" part. The <dfn
  title="attr-meter-optimum"><code>optimum</code></dfn> attribute
  gives the position that is "optimum"; if that is higher than the
  "high" value  then this indicates that the higher the value, the
  better; if it's lower than the "low" mark then it indicates that
  lower values are better, and naturally if it is in between then it
  indicates that neither high nor low values are good.</p>

  <p><strong>Authoring requirements</strong>: The recommended way of
  giving the value is to include it as contents of the element, either
  as two numbers (the higher number represents the maximum, the other
  number the current value), or as a percentage or similar (using one
  of the characters such as "%"), or as a fraction.</p>

  <p>The <code title="attr-meter-value">value</code>, <code
  title="attr-meter-min">min</code>, <code
  title="attr-meter-low">low</code>, <code
  title="attr-meter-high">high</code>, <code
  title="attr-meter-max">max</code>, and <code
  title="attr-meter-optimum">optimum</code> attributes are all
  optional. When present, they must have values that are <span
  title="valid floating point number">valid floating point
  numbers</span>.</p>

  <div class="example">

   <p>The following examples all represent a measurement of three
   quarters (of the maximum of whatever is being measured):</p>

   <pre>&lt;meter>75%&lt;/meter>
&lt;meter>750&#x2030;&lt;/meter>
&lt;meter>3/4&lt;/meter>
&lt;meter>6 blocks used (out of 8 total)&lt;/meter>
&lt;meter>max: 100; current: 75&lt;/meter>
&lt;meter>&lt;object data="graph75.png">0.75&lt;/object>&lt;/meter>
&lt;meter min="0" max="100" value="75">&lt;/meter></pre>

  </div>

  <p><strong>User agent requirements</strong>: User agents must parse
  the <code title="attr-meter-min">min</code>, <code
  title="attr-meter-max">max</code>, <code
  title="attr-meter-value">value</code>, <code
  title="attr-meter-low">low</code>, <code
  title="attr-meter-high">high</code>, and <code
  title="attr-meter-optimum">optimum</code> attributes using the
  <span>rules for parsing floating point number values</span>.</p>

  <p>If the <code title="attr-meter-value">value</code> attribute has
  been omitted, the user agent must also process the
  <code>textContent</code> of the element according to the <span>steps
  for finding one or two numbers of a ratio in a string</span>. These
  steps will return nothing, one number, one number with a denominator
  punctuation character, or two numbers.</p>

  <p>User agents must then use all these numbers to obtain values for
  six points on the gauge, as follows. (The order in which these are
  evaluated is important, as some of the values refer to earlier
  ones.)</p>

  <dl>

   <dt>The minimum value</dt>

   <dd>
    <p>If the <code title="attr-meter-min">min</code> attribute is
    specified and a value could be parsed out of it, then the minimum
    value is that value. Otherwise, the minimum value is zero.</p>
   </dd>

   <dt>The maximum value</dt>

   <dd>

    <p>If the <code title="attr-meter-max">max</code> attribute is
    specified and a value could be parsed out of it, the maximum
    value is that value.</p>

    <p>Otherwise, if the <code title="attr-meter-max">max</code>
    attribute is specified but no value could be parsed out of it, or
    if it was not specified, but either or both of the <code
    title="attr-meter-min">min</code> or <code
    title="attr-meter-value">value</code> attributes <em>were</em>
    specified, then the maximum value is 1.</p>

    <p>Otherwise, none of the <code title="attr-meter-max">max</code>,
    <code title="attr-meter-min">min</code>, and <code
    title="attr-meter-value">value</code> attributes were
    specified. If the result of processing the
    <code>textContent</code> of the element was either nothing or just
    one number with no denominator punctuation character, then the
    maximum value is 1; if the result was one number but it had an
    associated denominator punctuation character, then the maximum
    value is the <span title="values associated with denominator
    punctuation characters">value associated with that denominator
    punctuation character</span>; and finally, if there were two
    numbers parsed out of the <code>textContent</code>, then the
    maximum is the higher of those two numbers.</p>

    <p>If the above machinations result in a maximum value less than
    the minimum value, then the maximum value is actually the same as
    the minimum value.</p>

   </dd>

   <dt>The actual value</dt>

   <dd>

    <p>If the <code title="attr-meter-value">value</code> attribute is
    specified and a value could be parsed out of it, then that value
    is the actual value.</p>

    <p>If the <code title="attr-meter-value">value</code> attribute is
    not specified but the <code title="attr-meter-max">max</code>
    attribute <em>is</em> specified and the result of processing the
    <code>textContent</code> of the element was one number with no
    associated denominator punctuation character, then that number is
    the actual value.</p>

    <p>If neither of the <code title="attr-meter-value">value</code>
    and <code title="attr-meter-max">max</code> attributes are
    specified, then, if the result of processing the
    <code>textContent</code> of the element was one number (with or
    without an associated denominator punctuation character), then
    that is the actual value, and if the result of processing the
    <code>textContent</code> of the element was two numbers, then the
    actual value is the lower of the two numbers found.</p>

    <p>Otherwise, if none of the above apply, the actual value is
    zero.</p>

    <p>If the above procedure results in an actual value less than
    the minimum value, then the actual value is actually the same as
    the minimum value.</p>

    <p>If, on the other hand, the result is an actual value greater
    than the maximum value, then the actual value is the maximum
    value.</p>

   </dd>

   <dt>The low boundary</dt>

   <dd>

    <p>If the <code title="attr-meter-low">low</code> attribute is
    specified and a value could be parsed out of it, then the low
    boundary is that value. Otherwise, the low boundary is the same as
    the minimum value.</p>

    <p>If the above results in a low boundary that is less than the
    minimum value, the low boundary is the minimum value.</p>

   </dd>

   <dt>The high boundary</dt>

   <dd>

    <p>If the <code title="attr-meter-high">high</code> attribute is
    specified and a value could be parsed out of it, then the high
    boundary is that value. Otherwise, the high boundary is the same
    as the maximum value.</p>

    <p>If the above results in a high boundary that is higher than the
    maximum value, the high boundary is the maximum value.</p>

   </dd>

   <dt>The optimum point</dt>

   <dd>

    <p>If the <code title="attr-meter-optimum">optimum</code>
    attribute is specified and a value could be parsed out of it, then
    the optimum point is that value. Otherwise, the optimum point is
    the midpoint between the minimum value and the maximum value.</p>

    <p>If the optimum point is then less than the minimum value, then
    the optimum point is actually the same as the minimum
    value. Similarly, if the optimum point is greater than the maximum
    value, then it is actually the maximum value instead.</p>

   </dd>

  </dl>

  <p>All of which should result in the following inequalities all
  being true:</p>

  <ul class="brief">
   <li>minimum value &le; actual value &le; maximum value</li>
   <li>minimum value &le; low boundary &le; high boundary &le; maximum value</li>
   <li>minimum value &le; optimum point &le; maximum value</li>
  </ul>

  <p><strong>UA requirements for regions of the gauge</strong>: If the
  optimum point is equal to the low boundary or the high boundary, or
  anywhere in between them, then the region between the low and high
  boundaries of the gauge must be treated as the optimum region, and
  the low and high parts, if any, must be treated as
  suboptimal. Otherwise, if the optimum point is less than the low
  boundary, then the region between the minimum value and the low
  boundary must be treated as the optimum region, the region between
  the low boundary and the high boundary must be treated as a
  suboptimal region, and the region between the high boundary and the
  maximum value must be treated as an even less good region. Finally,
  if the optimum point is higher than the high boundary, then the
  situation is reversed; the region between the high boundary and the
  maximum value must be treated as the optimum region, the region
  between the high boundary and the low boundary must be treated as a
  suboptimal region, and the remaining region between the low boundary
  and the minimum value must be treated as an even less good
  region.</p>

  <p><strong>UA requirements for showing the gauge</strong>: When
  representing a <code>meter</code> element to the user, the UA should
  indicate the relative position of the actual value to the minimum
  and maximum values, and the relationship between the actual value
  and the three regions of the gauge.</p>

  <div class="example">
   <p>The following markup:</p>
   <pre>
&lt;h3>Suggested groups&lt;/h3>
&lt;menu type="toolbar">
 &lt;a href="?cmd=hsg" onclick="hideSuggestedGroups()">Hide suggested groups&lt;/a>
&lt;/menu>
&lt;ul>
 &lt;li>
  &lt;p>&lt;a href="/group/comp.infosystems.www.authoring.stylesheets/view">comp.infosystems.www.authoring.stylesheets&lt;/a> -
     &lt;a href="/group/comp.infosystems.www.authoring.stylesheets/subscribe">join&lt;/a>&lt;/p>
  &lt;p>Group description: &lt;strong>Layout/presentation on the WWW.&lt;/strong>&lt;/p>
  &lt;p><strong>&lt;meter value="0.5">Moderate activity,&lt;/meter></strong> Usenet, 618 subscribers&lt;/p>
 &lt;/li>
 &lt;li>
  &lt;p>&lt;a href="/group/netscape.public.mozilla.xpinstall/view">netscape.public.mozilla.xpinstall&lt;/a> -
     &lt;a href="/group/netscape.public.mozilla.xpinstall/subscribe">join&lt;/a>&lt;/p>
  &lt;p>Group description: &lt;strong>Mozilla XPInstall discussion.&lt;/strong>&lt;/p>
  &lt;p><strong>&lt;meter value="0.25">Low activity,&lt;/meter></strong> Usenet, 22 subscribers&lt;/p>
 &lt;/li>
 &lt;li>
  &lt;p>&lt;a href="/group/mozilla.dev.general/view">mozilla.dev.general&lt;/a> -
     &lt;a href="/group/mozilla.dev.general/subscribe">join&lt;/a>&lt;/p>
  &lt;p><strong>&lt;meter value="0.25">Low activity,&lt;/meter></strong> Usenet, 66 subscribers&lt;/p>
 &lt;/li>
&lt;/ul>
</pre>
   <p>Might be rendered as follows:</p>
   <p><img src="sample-meter.png" alt="With the &lt;meter> elements rendered as inline green bars of varying lengths."></p>
  </div>

  <p>The <dfn title="dom-meter-min"><code>min</code></dfn>, <dfn
  title="dom-meter-max"><code>max</code></dfn>, <dfn
  title="dom-meter-value"><code>value</code></dfn>, <dfn
  title="dom-meter-low"><code>low</code></dfn>, <dfn
  title="dom-meter-high"><code>high</code></dfn>, and <dfn
  title="dom-meter-optimum"><code>optimum</code></dfn> DOM attributes
  must reflect the elements' content attributes of the same name. When
  the relevant content attributes are absent, the DOM attributes must
  return zero. The value parsed from the <code>textContent</code>
  never affects the DOM values.</p>

  <p class="big-issue">Would be cool to have the <code
  title="dom-meter-value">value</code> DOM attribute update the
  <code>textContent</code> in-line...</p>

<!-- XXX
should we also look inside the title="" attribute?
   Disk usage: <meter title="985MB of 986MB total" high="980">Full!</meter>
should we make the contents accessible in some way, e.g. as a tooltip?
-->



  <h4>The <dfn><code>progress</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-progress-value">value</code></dd>
   <dd><code title="attr-progress-max">max</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLProgressElement</dfn> : <span>HTMLElement</span> {
           attribute float <span title="dom-progress-value">value</span>;
           attribute float <span title="dom-progress-max">max</span>;
  readonly attribute float <span title="dom-progress-position">position</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>progress</code> element represents the completion
  progress of a task. The progress is either indeterminate, indicating
  that progress is being made but that it is not clear how much more
  work remains to be done before the task is complete (e.g. because
  the task is waiting for a remote host to respond), or the progress
  is a number in the range zero to a maximum, giving the fraction of
  work that has so far been completed.</p>

  <p>There are two attributes that determine the current task
  completion represented by the element.</p>

  <p>The <dfn title="attr-progress-value"><code>value</code></dfn>
  attribute specifies how much of the task has been completed, and the
  <dfn title="attr-progress-max"><code>max</code></dfn> attribute
  specifies how much work the task requires in total. The units are
  arbitrary and not specified.</p>

  <p>Instead of using the attributes, authors are recommended to
  simply include the current value and the maximum value inline as
  text inside the element.</p>

  <div class="example">
   <p>Here is a snippet of a Web application that shows the progress
   of some automated task:</p>
   <pre>&lt;section>
 &lt;h2>Task Progress&lt;/h2>
 &lt;p>&lt;label>Progress: &lt;progress>&lt;span id="p">0&lt;/span>%&lt;/progress>&lt;/p>
 &lt;script>
  var progressBar = document.getElementById('p');
  function updateProgress(newValue) {
    progressBar.textContent = newValue;
  }
 &lt;/script>
&lt;/section></pre>
   <p>(The <code>updateProgress()</code> method in this example would
   be called by some other code on the page to update the actual
   progress bar as the task progressed.)</p>
  </div>

  <p><strong>Author requirements</strong>: The <code
  title="attr-progress-max">max</code> and <code
  title="attr-progress-value">value</code> attributes, when present,
  must have values that are <span title="valid floating point
  number">valid floating point numbers</span>. The <code
  title="attr-progress-max">max</code> attribute, if present, must
  have a value greater than zero. The <code
  title="attr-progress-value">value</code> attribute, if present, must
  have a value equal to or greater than zero, and less than or equal
  to the value of the <code title="attr-progress-max">max</code>
  attribute, if present.</p>

  <p><strong>User agent requirements</strong>: User agents must parse
  the <code title="attr-progress-max">max</code> and <code
  title="attr-progress-value">value</code> attributes' values
  according to the <span>rules for parsing floating point number
  values</span>.</p>

  <p>If the <code title="attr-progress-value">value</code> attribute
  is omitted, then user agents must also parse the
  <code>textContent</code> of the <code>progress</code> element in
  question using the <span>steps for finding one or two numbers of a
  ratio in a string</span>. These steps will return nothing, one
  number, one number with a denominator punctuation character, or two
  numbers.</p>

  <p>Using the results of this processing, user agents must determine
  whether the progress bar is an indeterminate progress bar, or
  whether it is a determinate progress bar, and in the latter case,
  what its current and maximum values are, all as follows:</p>

  <ol>

   <li>If the <code title="attr-progress-max">max</code> attribute is
   omitted, and the <code title="attr-progress-value">value</code> is
   omitted, and the results of parsing the <code>textContent</code>
   was nothing, then the progress bar is an indeterminate progress
   bar. Abort these steps.</li>

   <li>Otherwise, it is a determinate progress bar.</li>

   <li>If the <code title="attr-progress-max">max</code> attribute is
   included, then, if a value could be parsed out of it, then the
   maximum value is that value.</li>

   <li>Otherwise, if the <code title="attr-progress-max">max</code>
   attribute is absent but the <code
   title="attr-progress-value">value</code> attribute is present, or,
   if the <code title="attr-progress-max">max</code> attribute is
   present but no value could be parsed from it, then the maximum is
   1.</li>

   <li>Otherwise, if neither attribute is included, then, if the
   <code>textContent</code> contained one number with an associated
   denominator punctuation character, then the maximum value is the
   <span>value associated with that denominator punctuation
   character</span>; otherwise, if the <code>textContent</code>
   contained two numbers, the maximum value is the higher of the two
   values; otherwise, the maximum value is 1.</li>

   <li>If the <code title="attr-progress-value">value</code> attribute
   is present on the element and a value could be parsed out of it,
   that value is the current value of the progress bar. Otherwise, if
   the attribute is present but no value could be parsed from it, the
   current value is zero.</li>

   <li>Otherwise if the <code title="attr-progress-value">value</code>
   attribute is absent and the <code
   title="attr-progress-max">max</code> attribute is present, then, if
   the <code>textContent</code> was parsed and found to contain just
   one number, with no associated denominator punctuation character,
   then the current value is that number. Otherwise, if the <code
   title="attr-progress-value">value</code> attribute is absent and
   the <code title="attr-progress-max">max</code> attribute is present
   then the current value is zero.</li>

   <li>Otherwise, if neither attribute is present, then the current
   value is the lower of the one or two numbers that were found in the
   <code>textContent</code> of the element.</li>

   <li>If the maximum value is less than or equal to zero, then it is
   reset to 1.</li>

   <li>If the current value is less than zero, then it is reset to
   zero.</li>

   <li>Finally, if the current value is greater than the maximum
   value, then the current value is reset to the maximum value.</li>

  </ol>

  <p><strong>UA requirements for showing the progress bar</strong>:
  When representing a <code>progress</code> element to the user, the
  UA should indicate whether it is a determinate or indeterminate
  progress bar, and in the former case, should indicate the relative
  position of the current value relative to the maximum value.</p>

  <p>The <dfn title="dom-progress-max"><code>max</code></dfn> and <dfn
  title="dom-progress-value"><code>value</code></dfn> DOM attributes
  must reflect the elements' content attributes of the same name. When
  the relevant content attributes are absent, the DOM attributes must
  return zero. The value parsed from the <code>textContent</code>
  never affects the DOM values.</p>

  <p class="big-issue">Would be cool to have the <code
  title="dom-progress-value">value</code> DOM attribute update the
  <code>textContent</code> in-line...</p>

  <p>If the progress bar is an indeterminate progress bar, then the
  <dfn title="dom-progress-position"><code>position</code></dfn> DOM
  attribute must return -1. Otherwise, it must return the result of
  dividing the current value by the maximum value.</p>


  <h4>The <dfn><code>code</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-title">title</code> attribute has special semantics on this element when used with the <code>dfn</code> element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>code</code> element represents a fragment of computer
  code. This could be an XML element name, a filename, a computer
  program, or any other string that a computer would recognise.</p>

  <p class="note">See the <code>pre</code> element for more detais.</p>

  <div class="example">

   <p>The following example shows how a block of code could be marked
   up using the <code>pre</code> and <code>code</code> elements.</p>

   <pre>&lt;pre>&lt;code>var i: Integer;
begin
   i := 1;
end.&lt;/code>&lt;/pre></pre>

  </div>

  <h4>The <dfn><code>var</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-title">title</code> attribute has special semantics on this element when used with the <code>dfn</code> element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>var</code> element represents a variable. This could be
  an actual variable in a mathematical expression or programming
  context, or it could just be a term used as a placeholder in
  prose.</p>

  <div class="example">
   <p>In the paragraph below, the letter "n" is being used as a
   variable in prose:</p>
   <pre>&lt;p>If there are &lt;var>n&lt;/var> pipes leading to the ice
cream factory then I expect at &lt;em>least&lt;/em> &lt;var>n&lt;/var>
flavours of ice cream to be available for purchase!&lt;/p></pre>
  </div>

  <h4>The <dfn><code>samp</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-title">title</code> attribute has special semantics on this element when used with the <code>dfn</code> element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>samp</code> element represents (sample) output from a
  program or computing system.</p>

  <p class="note">See the <code>pre</code> and <code>kbd</code>
  elements for more detais.</p>

  <div class="example">
   <p>This example shows the <code>samp</code> element being used
   inline:</p>
   <pre>&lt;p>The computer said &lt;samp>Too much cheese in tray
two&lt;/samp> but I didn't know what that meant.&lt;/p></pre>

   <p>This second example shows a block of sample output. Nested
   <code>samp</code> and <code>kbd</code> elements allow for the
   styling of specific elements of the sample output using a
   style sheet.</p>

   <!-- XXX should those nested SAMPs be SPANs? -->
   <pre>&lt;pre>&lt;samp>&lt;samp class="prompt">jdoe@mowmow:~$&lt;/samp> &lt;kbd>ssh demo.example.com&lt;/kbd>
Last login: Tue Apr 12 09:10:17 2005 from mowmow.example.com on pts/1
Linux demo 2.6.10-grsec+gg3+e+fhs6b+nfs+gr0501+++p3+c4a+gr2b-reslog-v6.189 #1 SMP Tue Feb 1 11:22:36 PST 2005 i686 unknown

&lt;samp class="prompt">jdoe@demo:~$&lt;/samp> &lt;samp class="cursor">_&lt;/samp>&lt;/samp>&lt;/pre></pre>
  </div>

  <h4>The <dfn><code>kbd</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>kbd</code> element represents user input (typically
  keyboard input, although it may also be used to represent other
  input, such as voice commands).</p>

  <p>When the <code>kbd</code> element is nested inside a
  <code>samp</code> element, it represents the input as it was echoed
  by the system.</p>

  <p>When the <code>kbd</code> element <em>contains</em> a
  <code>samp</code> element, it represents input based on system
  output, for example invoking a menu item.</p>

  <p>When the <code>kbd</code> element is nested inside another
  <code>kbd</code> element, it represents an actual key or other
  single unit of input as appropriate for the input mechanism.</p>

  <div class="example">
   <p>Here the <code>kbd</code> element is used to indicate keys to press:</p>
   <pre>&lt;p>To make George eat an apple, press &lt;kbd>&lt;kbd>Shift&lt;/kbd>+&lt;kbd>F3&lt;/kbd>&lt;/kbd>&lt;/p></pre>

   <p>In this second example, the user is told to pick a particular
   menu item. The outer <code>kbd</code> element marks up a block of
   input, with the inner <code>kbd</code> elements representing each
   individual step of the input, and the <code>samp</code> elements
   inside them indicating that the steps are input based on something
   being displayed by the system, in this case menu labels:</p>

   <pre>&lt;p>To make George eat an apple, select
    &lt;kbd>&lt;kbd>&lt;samp>File&lt;/samp>&lt;/kbd>|&lt;kbd>&lt;samp>Eat Apple...&lt;/samp>&lt;/kbd>&lt;/kbd>
&lt;/p></pre>
  </div>

  <h4>The <dfn><code>sup</code></dfn> and <dfn><code>sub</code></dfn> elements</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which these elements may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>sup</code> element represents a superscript and the
  <code>sub</code> element represents a subscript.</p>

  <p>These elements must only be used to mark up typographical
  conventions with specific meanings, not for typographical
  presentation for presentation's sake. For example, it would be
  inappropriate for the <code>sup</code> and <code>sub</code> elements
  to be used in the name of the LaTeX document preparation system. In
  general, authors should not use these elements if the
  <em>absence</em> of those elements would not change the meaning of
  the content.</p>

  <p>When the <code>sub</code> element is used inside a
  <code>var</code> element, it represents the subscript that
  identifies the variable in a family of variables.</p>

  <div class="example">
   <pre>&lt;p>The coordinate of the &lt;var>i&lt;/var>th point is
(&lt;var>x&lt;sub>&lt;var>i&lt;/var>&lt;/sub>&lt;/var>, &lt;var>y&lt;sub>&lt;var>i&lt;/var>&lt;/sub>&lt;/var>).
For example, the 10th point has coordinate
(&lt;var>x&lt;sub>10&lt;/sub>&lt;/var>, &lt;var>y&lt;sub>10&lt;/sub>&lt;/var>).&lt;/p></pre>
  </div>

  <p>In certain languages, superscripts are part of the typographical
  conventions for some abbreviations.</p>

  <div class="example">
   <pre>&lt;p>The most beautiful women are
&lt;span lang="fr">&lt;abbr>M&lt;sup>lle&lt;/sup>&lt;/abbr> Gwendoline&lt;/span> and 
&lt;span lang="fr">&lt;abbr>M&lt;sup>me&lt;/sup>&lt;/abbr> Denise&lt;/span>.&lt;/p></pre>
  </div>

  <p>Mathematical expressions often use subscripts and superscripts.
  <!--Authors are encouraged to use MathML for marking up mathematics, but
  authors may opt to use <code>sub</code> and <code>sup</code> if
  detailed mathematical markup is not desired. <a
  href="#refsMathML">[MathML]</a>--></p> <!-- XXXX -->

  <div class="example">
   <pre>&lt;var>E&lt;/var>=&lt;var>m&lt;/var>&lt;var>c&lt;/var>&lt;sup>2&lt;/sup></pre>
   <pre>f(&lt;var>x&lt;/var>, &lt;var>n&lt;/var>) = log&lt;sub>4&lt;/sub>&lt;var>x&lt;/var>&lt;sup>&lt;var>n&lt;/var>&lt;/sup></pre>
  </div>


  <h4>The <dfn><code>span</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used in an element whose content model is only
   <span>strictly inline-level content</span>: only <span>strictly
   inline-level content</span>.</dd>
   <dd>Otherwise: any <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-title">title</code> attribute has special semantics on this element when used with the <code>dfn</code> element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-copyright">copyright</code>, <code
   title="class-error">error</code>, <code
   title="class-example">example</code>, <code
   title="class-issue">issue</code>, <code
   title="class-note">note</code>, <code
   title="class-search">search</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>span</code> element doesn't mean anything on its own,
  but can be useful when used together with other attributes,
  e.g. <code title="attr-class">class</code>, <code
  title="attr-lang">lang</code>, or <code title="attr-dir">dir</code>,
  or when used in conjunction with the <code>dfn</code> element.</p>

  <!-- XXX need examples -->


  <h4>The <dfn><code>i</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-title">title</code> attribute has special semantics on this element when used with the <code>dfn</code> element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd> <!-- XXX ship? name? dream? -->
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>i</code> element represents a span of text in an
  alternate voice or mood, or otherwise offset from the normal prose,
  such as a taxonomic designation, a technical term, an idiomatic
  phrase from another language, a thought, a ship name, or some other
  prose whose typical typographic presentation is italicized.</p>

  <p>Terms in languages different from the main text should be
  annotated with <code title="attr-lang">lang</code> attributes (<code
  title="attr-xml-lang">xml:lang</code> in XML).</p>

  <div class="example">
   <p>The examples below show uses of the <code>i</code> element:</p>
   <pre>&lt;p>The &lt;i>felis silvestris catus&lt;/i> is cute.&lt;/p>
&lt;p>The &lt;i>block-level elements&lt;/i> are defined above.&lt;/p>
&lt;p>There is a certain &lt;i lang="fr">je ne sais quoi&lt;/i> in the air.&lt;/p></pre>
   <p>In the following example, a dream sequence is marked up using
   <code>i</code> elements.</p>
   <pre>&lt;p>Raymond tried to sleep.&lt;/p>
&lt;p>&lt;i>The ship sailed away on Thursday&lt;/i>, he
dreamt. &lt;i>The ship had many people aboard, including a beautiful
princess called Carey. He watched her, day-in, day-out, hoping she
would notice him, but she never did.&lt;/i>&lt;/p>
&lt;p>&lt;i>Finally one night he picked up the courage to speak with
her&mdash;&lt;/i>&lt;/p>
&lt;p>Raymond woke with a start as the fire alarm rang out.&lt;/p></pre>
  </div>

  <p>The <code>i</code> element should be used as a last resort when
  no other element is more appropriate. In particular, citations
  should use the <code>cite</code> element, defining instances of
  terms should use the <code>dfn</code> element, stress emphasis
  should use the <code>em</code> element, importance should be denoted
  with the <code>strong</code> element, quotes should be marked up
  with the <code>q</code> element, and small print should use the
  <code>small</code> element.</p>

  <p class="note">Style sheets can be used to format <code>i</code>
  elements, just like any other element can be restyled. Thus, it is
  not the case that content in <code>i</code> elements will
  necessarily be italicised.</p>


  <h4>The <dfn><code>b</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>b</code> element represents a span of text to be
  stylistically offset from the normal prose without conveying any
  extra importance, such as key words in a document abstract, product
  names in a review, or other spans of text whose typical typographic
  presentation is boldened.</p>

  <div class="example">
   <p>The following example shows a use of the <code>b</code> element
   to highlight key words without marking them up as important:</p>
   <pre>&lt;p>The &lt;b>frobonitor&lt;/b> and &lt;b>barbinator&lt;/b> components are fried.&lt;/p></pre>
   <p>The following would be <em>incorrect</em> usage:</p>
   <pre>&lt;p>&lt;b>WARNING!&lt;/b> Do not frob the barbinator!&lt;/p></pre>
   <p>In the previous example, the correct element to use would have
   been <code>strong</code>, not <code>b</code>.</p>
   <p>In the following example, objects in a text adventure are
   highlighted as being special by use of the <code>b</code>
   element.</p>
   <pre>&lt;p>You enter a small room. Your &lt;b>sword&lt;/b> glows
brighter. A &lt;b>rat&lt;/b> scurries past the corner wall.&lt;/p></pre>
  </div>

  <p>The <code>b</code> element should be used as a last resort when
  no other element is more appropriate. In particular, headers should
  use the <code>h1</code> to <code>h6</code> elements, stress emphasis
  should use the <code>em</code> element, importance should be denoted
  with the <code>strong</code> element, and text marked or highlighted
  should use the <code>m</code> element.</p>

  <p class="note">Style sheets can be used to format <code>b</code>
  elements, just like any other element can be restyled. Thus, it is
  not the case that content in <code>b</code> elements will
  necessarily be boldened.</p>


  <h4>The <dfn><code>bdo</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None, but the <code title="attr-dir">dir</code> global attribute is required on this element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>bdo</code> element allows authors to override the
  Unicode bidi algorithm by explicitly specifying a direction
  override. <a href="#refsBIDI">[BIDI]</a></p>

  <p>Authors must specify the <code title="attr-dir">dir</code> attribute on this
  element, with the value <code>ltr</code> to specify a left-to-right
  override and with the value <code>rtl</code> to specify a
  right-to-left override.</p>

  <p>If the element has the <code title="attr-dir">dir</code> attribute set to the
  exact value <code>ltr</code>, then for the purposes of the bidi
  algorithm, the user agent must act as if there was a U+202D
  LEFT-TO-RIGHT OVERRIDE character at the start of the element, and a
  U+202C POP DIRECTIONAL FORMATTING at the end of the element.</p>

  <p>If the element has the <code title="attr-dir">dir</code> attribute set to the
  exact value <code>rtl</code>, then for the purposes of the bidi
  algorithm, the user agent must act as if there was a U+202E
  RIGHT-TO-LEFT OVERRIDE character at the start of the element, and a
  U+202C POP DIRECTIONAL FORMATTING at the end of the element.</p>

  <p>The requirements on handling the <code>bdo</code> element for the
  bidi algorithm may be implemented indirectly through the style
  layer. For example, an HTML+CSS user agent should implement these
  requirements by implementing the CSS <code>unicode-bidi</code>
  property. <a href="#refsCSS21">[CSS21]</a></p>

  <!-- XXX need examples -->




  <h3>Edits</h3>

  <p>The <code>ins</code> and <code>del</code> elements represent
  edits to the document.</p>

  <h4>The <dfn><code>ins</code></dfn> element</h4>

  <p><span>Transparent</span> <span title="block-level
  elements">block-level element</span>, and <span>transparent</span>
  <span>strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> is expected.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Transparent</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-mod-cite">cite</code></dd>
   <dd><code title="attr-mod-datetime">datetime</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>Uses the <code>HTMLModElement</code> interface.</dd>
  </dl>

  <p>The <code>ins</code> element represents an addition to the
  document.</p>

  <p>The <code>ins</code> element must be used only where
  <span>block-level elements</span> or <span>strictly inline-level
  content</span> can be used.</p>

  <p>An <code>ins</code> element can only contain content that would
  still be conformant if all elements with <span>transparent</span>
  content models were replaced by their contents.</p>

  <div class="example">

   <p>The following would be syntactically legal:</p>

   <pre>&lt;aside>
 &lt;ins>
  &lt;p>...&lt;/p>
 &lt;/ins>
&lt;/aside></pre>

   <p>As would this:</p>

   <pre>&lt;aside>
 &lt;ins>
  &lt;em>...&lt;/em>
 &lt;/ins>
&lt;/aside></pre>

   <p>However, this last example would be illegal, as <code>em</code>
   and <code>p</code> cannot both be used inside an <code>aside</code>
   element at the same time:</p>

   <pre>&lt;aside>
 &lt;ins>
  &lt;p>...&lt;/p>
 &lt;/ins>
 &lt;ins>
  &lt;em>...&lt;/em>
 &lt;/ins>
&lt;/aside></pre>

  </div>

  <h4>The <dfn><code>del</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  and <span>strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> is expected.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When the element has a parent: same content model as the parent
   element (without taking into account the other children of the
   parent element).</dd>
   <dd>Otherwise: zero or more <span>block-level elements</span>, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-mod-cite">cite</code></dd>
   <dd><code title="attr-mod-datetime">datetime</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>Uses the <code>HTMLModElement</code> interface.</dd>
  </dl>

  <p>The <code>del</code> element represents a removal from the
  document.</p>

  <p>The <code>del</code> element must only contain content that would
  be allowed inside the parent element (regardless of what the parent
  element actually contains).</p>

  <div class="example">

   <p>The following would be syntactically legal:</p>

   <pre>&lt;aside>
 &lt;del>
  &lt;p>...&lt;/p>
 &lt;/del>
 &lt;ins>
  &lt;em>...&lt;/em>
 &lt;/ins>
&lt;/aside></pre>

   <p>...even though the <code>p</code> and <code>em</code> elements
   would never be allowed side by side in the <code>aside</code>
   element. This is allowed because the <code>del</code> element
   represents content that was removed, and it is quite possible that
   an edit could cause an element to go from being an inline-level
   container to a block-level container, or vice-versa.</p>

  </div>

  <h4>Attributes common to <code>ins</code> and <code>del</code> elements</h4>

  <p>The <dfn title="attr-mod-cite"><code>cite</code></dfn> attribute
  may be used to specify a URI that explains the change. When that
  document is long, for instance the minutes of a meeting, authors are
  encouraged to include a fragment identifier pointing to the specific
  part of that document that discusses the change.</p>

  <p>If the <code title="attr-mod-cite">cite</code> attribute is
  present, it must be a URI (or IRI) that explains the change. User
  agents should allow users to follow such citation links.</p>

  <p>The <dfn title="attr-mod-datetime"><code>datetime</code></dfn>
  attribute may be used to specify the time and date of the change.</p>

  <p>If present, the <code title="attr-mod-datetime">datetime</code>
  attribute must be a <span>valid datetime</span> value.</p>

  <p>User agents must parse the <code
  title="attr-mod-datetime">datetime</code> attribute according to the
  <span>parse a string as a datetime value</span> algorithm. If that
  doesn't return a time, then the modification has no associated
  timestamp (the value is non-conforming; it is not a <span>valid
  datetime</span>). Otherwise, the modification is marked as having
  been made at the given datetime. User agents should use the
  associated timezone information to determine which timezone to
  present the given datetime in.</p>

  <p>The <code>ins</code> and <code>del</code> elements must implement
  the <code>HTMLModElement</code> interface:</p>

  <pre class="idl">interface <dfn>HTMLModElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-mod-cite">cite</span>;
           attribute DOMString <span title="dom-mod-datetime">datetime</span>;
};</pre>

  <p>The <dfn title="dom-mod-cite"><code>cite</code></dfn> and <dfn
  title="dom-mod-datetime"><code>datetime</code></dfn> DOM attributes
  must reflect the elements' content attributes of the same name.</p>



  <h3>Embedded content</h3>

  <h4>The <dfn><code>figure</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>In any order, exactly one <code>legend</code> element, and exactly one <span>embedded content</span> element.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code
   title="class-issue">example</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>figure</code> element represents a
  <span>paragraph</span> consisting of embedded content and a
  caption.</p>

  <p>The first <span>embedded content</span> element child of the
  <code>figure</code> element, if any, is the paragraph's content.</p>

  <p>The first <code>legend</code> element child of the element, if
  any, represents the caption of the embedded content. If there is no
  child <code>legend</code> element, then there is no caption.</p>

  <p>If the embedded content cannot be used, then, for the purposes of
  establishing what the <code>figure</code> element represents:</p>

  <dl class="switch">

   <dt>If the embedded content's <span>fallback content</span> is a single
   <span>embedded content</span> element</dt>
   <dd>The <code>figure</code> element must be treated as if that
   <span>embedded content</span> element was the <code>figure</code>
   element's embedded content. (If that embedded content can't be used
   either, then this processing must be done again, with the new
   embedded content's <span>fallback content</span>.)</dd>

   <dt>If the embedded content's fallback is nothing</dt>
   <dd>The entire <code>figure</code> element (including the caption,
   if any) must be ignored.</dd>

   <dt>If the embedded content's fallback is <span>inline-level
   content</span></dt>
   <dd>The entire <code>figure</code> element (including the caption,
   if any) must be treated as being a single <span>paragraph</span>
   with that <span>inline-level content</span> as its content.</dd>

   <dt>Otherwise</dt>
   <dd>The entire <code>figure</code> element (including the caption,
   if any) must be treated as being replaced by that fallback
   content.</dd>

  </dl>


  <h4>The <dfn><code>img</code></dfn> element</h4>

  <p><span title="Strictly inline-level content">Strictly inline-level</span> <span>embedded content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the only <span>embedded content</span> child of a <code>figure</code> element.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-img-alt">alt</code> (required)</dd>
   <dd><code title="attr-img-src">src</code> (required)</dd>
   <dd><code title="attr-hyperlink-usemap">usemap</code></dd>
   <dd><code title="attr-img-ismap">ismap</code> (but only if one of the ancestor elements is an <code>a</code> element)</dd>
   <dd><code title="attr-img-height">height</code></dd>
   <dd><code title="attr-img-width">width</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLImageElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-img-alt">alt</span>;
           attribute DOMString <span title="dom-img-src">src</span>;
           attribute DOMString <span title="dom-img-useMap">useMap</span>;
           attribute boolean <span title="dom-img-isMap">isMap</span>;
           attribute long <span title="dom-img-height">height</span>;
           attribute long <span title="dom-img-width">width</span>;
  readonly attribute boolean <span title="dom-img-complete">complete</span>;
};</pre>
    <p class="note">An instance of <code>HTMLImageElement</code> can
    be obtained using the <code title="dom-image">Image</code>
    constructor.</p>
   </dd>
  </dl>

  <p>The <code>img</code> element represents a piece of text with an
  alternate graphical representation. The text is given by the <dfn
  title="attr-img-alt"><code>alt</code></dfn> attribute, which must be
  present, and the URI to the graphical representation of that text is
  given in the <dfn title="attr-img-src"><code>src</code></dfn>
  attribute, which must also be present.</p>

  <p>The image given by the <code title="attr-img-src">src</code>
  attribute is the embedded content, and the value of the <code
  title="attr-img-alt">alt</code> attribute is the <code>img</code>
  element's <span>fallback content</span>.</p>

  <p>When the <code title="attr-img-alt">alt</code> attribute's value
  is the empty string, the image supplements the surrounding
  content. In such cases, the image could be omitted without affecting
  the meaning of the document.</p>

  <p>If the <code title="attr-img-alt">alt</code> attribute is
  omitted, user agents must treat the element as if it had an <code
  title="attr-img-alt">alt</code> attribute set to the empty
  string.</p>

  <p>The <code title="attr-img-alt">alt</code> attribute does not
  represent advisory information. User agents must not present the
  contents of the <code title="attr-img-alt">alt</code> attribute in
  the same way as content of the <code title="attr-title">title</code>
  attribute.</p>

  <p class="big-issue">Guidelines on writing "alt" text here.</p>
  <!-- http://www.cs.tut.fi/~jkorpela/html/alt.html -->

  <p>The <code title="attr-img-src">src</code> attribute must contain
  a URI (or IRI). If the <code title="attr-img-src">src</code>
  attribute is omitted, there is no alternative image
  representation.</p>

  <p>When the <code title="attr-img-src">src</code> attribute is set,
  the user agent must immediately begin to download the specified
  resource<!-- XXX xref what fetching means, how to resolve URIs in
  attributes (including those not in the DOM) -->, unless the user
  agent cannot support images, or its support for images has been
  disabled.</p>

  <p>The download of the image must <span>delay the <code
  title="event-load">load</code> event</span>.</p>

  <p>Once the download has completed, if the image is a valid image,
  the user agent must <span>fire a <code
  title="event-load">load</code> event</span> on the <code>img</code>
  element. If the download fails or it completes but the image is not
  a valid or supported image, the user agent must <span>fire an <code
  title="event-error">error</code> event</span> on the <code>img</code>
  element.</p>

  <p>The remote server's response metadata (e.g. an HTTP 404 status
  code, or <span title="Content-Type">associated Content-Type
  headers</span>) must be ignored when determining whether the
  resource obtained is a valid image or not.</p>

  <p class="note">This allows servers to return images with error
  responses.</p>

  <p>User agents must not support non-image resources with the
  <code>img</code> element.</p>

  <p>The <code title="attr-hyperlink-usemap">usemap</code> attribute,
  if present, can indicate that the image has an associated
  <span>image map</span>.</p>

  <p>The <dfn title="attr-img-ismap"><code>ismap</code></dfn>
  attribute, when used on an element that is a descendant of an
  <code>a</code> element with an <code
  title="attr-hyperlink-href">href</code> attribute, indicates by its
  presence that the element provides access to a server-side image
  map. This affects how events are handled on the corresponding
  <code>a</code> element.</p>

  <p>The <code title="attr-img-ismap">ismap</code> attribute is a
  <span>boolean attribute</span>. The attribute must not be specified
  on an element that does not have an ancestor <code>a</code>
  element.</p>

  <p>The <dfn title="attr-img-height"><code>height</code></dfn> and
  <dfn title="attr-img-width"><code>width</code></dfn> attributes give
  the preferred rendered dimensions of the image if the image is to be
  shown in a visual medium.</p>

  <p class="big-issue">Should we require the dimensions to be correct?
  Should we disallow percentages?</p>

  <p>The values of the <code title="attr-img-height">height</code> and
  <code title="attr-img-width">width</code> attributes must be either
  <span title="valid non-negative integer">valid non-negative
  integers</span> or <span title="valid non-negative percentage">valid
  non-negative percentages</span>.</p>

  <p>To parse the attributes, user agents must use the <span>rules for
  parsing dimension values</span>. This will return either an integer
  length, a percentage value, or nothing. When one of these attributes
  has no value, it must be <span>ignored</span><!-- XXX xref -->.</p>

  <p>The user agent requirements for processing the values obtained
  from parsing these attributes are described <span title="sizing of
  embedded content">in the rendering section</span><!-- XXX xref
  -->.</p>

  <p>The <code>img</code> element must be empty.</p><!-- contents
  should be ignored for rendering but not for semantics,
  e.g. <script>, <input>, etc. -->

  <p>The DOM attributes <dfn
  title="dom-img-alt"><code>alt</code></dfn>, <dfn
  title="dom-img-src"><code>src</code></dfn>, <dfn
  title="dom-img-useMap"><code>useMap</code></dfn>, and <dfn
  title="dom-img-isMap"><code>isMap</code></dfn> each must
  <span>reflect</span> the respective content attributes of the same
  name.</p>

  <p>The DOM attributes <dfn
  title="dom-img-height"><code>height</code></dfn> and <dfn
  title="dom-img-width"><code>width</code></dfn> must return the
  rendered height and width of the image, in CSS pixels, if the image
  is being rendered, and is being rendered to a visual medium, or 0
  otherwise. <a href="#refsCSS21">[CSS21]</a></p>

  <p>The DOM attribute <dfn
  title="dom-img-complete"><code>complete</code></dfn> must return
  true if the user agent has downloaded the image specified in the
  <code title="attr-img-src">src</code> attribute, and it is a valid
  image.</p>


  <h4>The <dfn><code>iframe</code></dfn> element</h4>

  <p><span title="Strictly inline-level content">Strictly inline-level</span> <span>embedded content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the only <span>embedded content</span> child of a <code>figure</code> element.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>Text (for details, see prose).</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-iframe-src">src</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLIFrameElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-iframe-src">src</span>;<!--
  readonly attribute Document <span title="dom-iframe-contentDocument">contentDocument</span>;
  readonly attribute Window <span title="dom-iframe-contentWindow">contentWindow</span>;-->
};</pre>
    <p>Objects implementing the <code>HTMLIFrameElement</code>
    interface must also implement the <code>EmbeddingElement</code>
    interface defined in the Window Object specification. <a
    href="#refsWINDOW">[WINDOW]</a></p>
   </dd>
  </dl>

  <p>The <code>iframe</code> element introduces a new nested
  <span>browsing context</span>.</p>

  <p>The <dfn title="attr-iframe-src"><code>src</code></dfn>
  attribute, if present, must be a URI (or IRI) to a page that the
  nested <span>browsing context</span> is to contain. If the user
  navigates away from this page, the <code>iframe</code>'s
  corresponding <code>Window</code> object will reference new
  <code>Document</code> objects, but the <code
  title="attr-iframe-src">src</code> attribute will not change.</p>

  <p>Whenever the <code title="attr-iframe-src">src</code> attribute
  is set, the nested <span>browsing context</span> must be
  <span>navigated</span><!-- XXX xref --> to the given URI.</p>

  <p>The default value, which must be used if the <code
  title="attr-iframe-src">src</code> attribute is not set when the
  element is created, or if the attribute is ever removed, is
  <code>about:blank</code><!-- XXX xref -->.</p>

  <p>The download of the resource must <span>delay the <code
  title="event-load">load</code> event</span>.</p>

  <p>When content loads in an <code>iframe</code>, the user agent must
  <span>fire a <code title="event-load">load</code> event</span> at
  the <code>iframe</code> element. When content fails to load
  (e.g. due to a network error), then the user agent must <span>fire
  an <code title="event-error">error</code> event</span> instead.</p>

  <p class="big-issue">order of events when content is also firing its
  own load/error?</p>

  <p>An <code>iframe</code> element never has <span>fallback
  content</span>, as it will always create a nested <span>browsing
  context</span>, regardless of whether the specified initial contents
  are successfully used.</p>

  <p><code>iframe</code> elements may contain any
  text. <code>iframe</code> elements must not contain element nodes.
  Descendants of <code>iframe</code> elements represent nothing. (In
  legacy user agents that do not support <code>iframe</code> elements,
  the contents would be parsed as markup that could act as fallback
  content.)</p>

  <p class="big-issue">restrictions for what that text must be?</p>

  <p class="note">The <span>HTML parser</span> treats markup inside
  <code>iframe</code> elements as text.</p>

  <p>The DOM attribute <dfn
  title="dom-iframe-src"><code>src</code></dfn> must
  <span>reflect</span> the content attribute of the same name.</p>


  <h4>The <dfn><code>embed</code></dfn> element</h4>

  <p><span title="Strictly inline-level content">Strictly inline-level</span> <span>embedded content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the only <span>embedded content</span> child of a <code>figure</code> element.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-embed-src">src</code> (required)</dd>
   <dd><code title="attr-embed-type">type</code></dd>
   <dd><code title="attr-embed-height">height</code></dd>
   <dd><code title="attr-embed-width">width</code></dd>
   <dd>Any other attribute that has no namespace (see prose).</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLEmbedElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-embed-src">src</span>;
           attribute DOMString <span title="dom-embed-type">type</span>;
           attribute long <span title="dom-embed-height">height</span>;
           attribute long <span title="dom-embed-width">width</span>;
};</pre>
    <p>Depending on the type of content instantiated by the
    <code>embed</code> element, the node may also support other
    interfaces.</p>
   </dd>
  </dl>

  <p>The <code>embed</code> element represents an integration point
  for an external (typically non-HTML) application or interactive
  content.</p>

  <p>The <dfn title="attr-embed-src"><code>src</code></dfn> attribute
  gives the address of the resource being embedded. The attribute must
  be present and contain a URI (or IRI).</p>

  <p>If the <code title="attr-embed-src">src</code> attribute is
  missing, then the <code>embed</code> element must be ignored.</p>

  <p>When the <code title="attr-embed-src">src</code> attribute is
  set, user agents are expected to find an appropriate handler for the
  specified resource, based on the <span
  title="concept-embed-type">content's type</span>, and hand that
  handler the content of the resource. If the handler supports a
  scriptable interface, the <code>HTMLEmbedElement</code> object
  representing the element should expose that interfaces.</p>

  <p>The download of the resource must <span>delay the <code
  title="event-load">load</code> event</span>.</p>

  <p>The user agent should pass the names and values of all the
  attributes of the <code>embed</code> element that have no namespace
  to the handler used. Any (namespace-less) attribute may be specified
  on the <code>embed</code> element.</p>

  <!-- duplicates what's in <object> section below -->
  <p class="note">This specification does not define a mechanism for
  interacting with third-party handlers, as it is expected to be
  user-agent-specific. Some UAs might opt to support a plugin
  mechanism such as the Netscape Plugin API; others may use remote
  content convertors or have built-in support for certain types. <a
  href="#refsNPAPI">[NPAPI]</a></p>

  <p>The <code>embed</code> element has no <span>fallback
  content</span>. If the user agent can't display the specified
  resource, e.g. because the given type is not supported, then the
  user agent must use a default handler for the content. (This default
  could be as simple as saying "Unsupported Format", of course.)</p>

  <p>The <dfn title="attr-embed-type"><code>type</code></dfn>
  attribute, if present, gives the MIME type of the linked resource.
  The value must be a valid MIME type, optionally with parameters. <a
  href="#refsRFC2046">[RFC2046]</a></p>

  <p>The <dfn title="concept-embed-type">type of the content</dfn>
  being embedded is defined as follows:</p>

  <ol>

   <li>If the element has a <code title="attr-embed-type">type</code>
   attribute, then the value of the <code
   title="attr-embed-type">type</code> attribute is the
   <span>content's type</span>.</li>

   <li>Otherwise, if the specified resource has <span
   title="Content-Type">explicit Content-Type metadata</span>, then
   that is the <span>content's type</span>.</li>

   <li>Otherwise, the content has no type and there can be no
   appropriate handler for it.</li>

  </ol>

  <p class="big-issue">Should we instead say that the content-sniffing
  that we're going to define for top-level browsing contexts should
  apply here?</p>

  <p class="big-issue">Should we require the type attribute to match
  the server information?</p>

  <p class="big-issue">We should say that 404s, etc, don't affect
  whether the resource is used or not. Not sure how to say it here
  though.</p>

  <p>Browsers should take extreme care when interacting with external
  content intended for third-party renderers. When third-party
  software is run with the same privileges as the user agent itself,
  vulnerabilities in the third-party software become as dangerous as
  those in the user agent.</p>

  <p class="big-issue">height/width</p>

  <p>The DOM attributes <dfn
  title="dom-embed-src"><code>src</code></dfn> and <dfn
  title="dom-embed-type"><code>type</code></dfn> each must
  <span>reflect</span> the respective content attributes of the same
  name.</p>

  <p>The DOM attributes <dfn
  title="dom-embed-height"><code>height</code></dfn> and <dfn
  title="dom-embed-width"><code>width</code></dfn> must return the
  rendered height and width of the image, in CSS pixels, if the image
  is being rendered, and is being rendered to a visual medium, or 0
  otherwise. <a href="#refsCSS21">[CSS21]</a></p>


  <h4>The <dfn><code>object</code></dfn> element</h4>

  <p><span title="Strictly inline-level content">Strictly inline-level</span> <span>embedded content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the only <span>embedded content</span> child of a <code>figure</code> element.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>When used as the child of a <code>figure</code> element, or,
   when used as a <em><code>figure</code> fallback
   <code>object</code></em>: Zero or more <code>param</code> elements,
   followed by either zero or more <span>block-level elements</span>
   or a single <code>object</code> element, which is then considered
   to be a <em><code>figure</code> fallback
   <code>object</code></em>.</dd>
   <dd>Otherwise: Zero or more <code>param</code> elements, followed
   by <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-object-data">data</code> (required if <code title="attr-object-type">type</code> is not given)</dd>
   <dd><code title="attr-object-type">type</code> (required if <code title="attr-object-data">data</code> is not given)</dd>
   <dd><code title="attr-hyperlink-usemap">usemap</code></dd>
   <dd><code title="attr-object-height">height</code></dd>
   <dd><code title="attr-object-width">width</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLObjectElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-object-data">data</span>;
           attribute DOMString <span title="dom-object-type">type</span>;
           attribute DOMString <span title="dom-object-useMap">useMap</span>;
           attribute long <span title="dom-object-height">height</span>;
           attribute long <span title="dom-object-width">width</span>;<!--
  readonly attribute Document <span title="dom-object-contentDocument">contentDocument</span>;
  readonly attribute Window <span title="dom-object-contentWindow">contentWindow</span>;-->
};</pre>
    <p>Objects implementing the <code>HTMLObjectElement</code>
    interface must also implement the <code>EmbeddingElement</code>
    interface defined in the Window Object specification. <a
    href="#refsWINDOW">[WINDOW]</a></p>
    <p>Depending on the type of content instantiated by the
    <code>object</code> element, the node may also support other
    interfaces.</p>
   </dd>
  </dl>

  <p class="big-issue">Shouldn't allow inline-level content to be the
  content model when the parent's content model is strictly inline
  only.</p>

  <p>The <code>object</code> element can represent an external
  resource, which, depending on the type of the resource, will either
  be treated as an image, as a nested <span>browsing context</span>,
  or as an external resource to be processed by a third-party software
  package.</p>

  <p>The <dfn title="attr-object-data"><code>data</code></dfn>
  attribute, if present, specifies the address of the resource. If
  present, the attribute must be a URI (or IRI).</p>

  <p>The <dfn title="attr-object-type"><code>type</code></dfn>
  attribute, if present, specifies the type of the resource. If
  present, the attribute must be a valid MIME type, optionally with
  parameters. <a href="#refsRFC2046">[RFC2046]</a></p>

  <p>One or both of the <code title="attr-object-data">data</code> and
  <code title="attr-object-type">type</code> attributes must be
  present.</p>

  <p>Whenever the <code title="attr-object-data">data</code> attribute
  changes, or, if the <code title="attr-object-data">data</code>
  attribute is not present, whenever the <code
  title="attr-object-type">type</code> attribute changes, the user
  agent must follow the following steps to determine what the
  <code>object</code> element represents:</p>

  <ol>

   <li><p>If the <code title="attr-object-data">data</code> attribute
   is present, then:</p>

    <ol>

     <li>

      <p>Begin a load for the resource.</p><!-- XXX define that
      --><!-- XXX xref -->

      <p>The download of the resource must <span>delay the <code
      title="event-load">load</code> event</span>.</p>

     </li>

     <li><p>If the resource is not yet available (e.g. because the
     resource was not available in the cache, so that loading the
     resource required making a request over the network), then jump
     to step 3 in the overall set of steps (fallback). When the
     resource becomes available, or if the load fails, restart this
     algorithm from this step. Resources can load incrementally; user
     agents may opt to consider a resource "available" whenever enough
     data has been obtained to begin processing the resource.</p></li>

     <li><p>If the load failed (e.g. DNS error), <span>fire an <code
     title="event-error">error</code> event</span>, then jump to step
     3 in the overall set of steps (fallback).</p></li>

     <li><p>Determine the <em>resource type</em>, as follows:</p>

      <p class="big-issue">This says to trust the type. Should we
      instead use the same mechanism as for browsing contexts?</p>

      <dl class="switch">

       <dt>If the resource has <span title="Content-Type">associated
       Content-Type metadata</span></dt>

       <dd>The type is the type specified in <span
       title="Content-Type">the resource's Content-Type
       metadata</span>.</dd>


       <dt>Otherwise, if the <code
       title="attr-object-type">type</code> attribute is present</dt>

       <dd>The type is the type specified in the <code
       title="attr-object-type">type</code> attribute.</dd>


       <dt>Otherwise, there is no explicit type information</dt>

       <dd>The type is the <span title="sniffed type of a
       resource">sniffed type of the resource</span>.</dd>

      </dl>

     </li>

     <li><p>Handle the content as given by the first of the following
     cases that matches:</p>

      <dl class="switch">

       <dt>If the resource requires a special handler (e.g. a plugin)</dt>

       <dd>

        <p>The user agent should find an appropriate handler for the
        specified resource, based on the <em>resource type</em> found
        in the previous step, and pass the content of the resource to
        that handler. If the handler supports a scriptable interface,
        the <code>HTMLObjectElement</code> object representing the
        element should expose that interface. The handler is not a
        nested <span>browsing context</span>. If no appropriate
        handler can be found, then jump to step 3 in the overall set
        of steps (fallback).</p>

        <p>The user agent should pass the names and values of all the
        <span title="concept-param-parameter">parameters</span> given
        by <code>param</code> elements that are children of the
        <code>object</code> element to the handler used.</p>

        <!-- duplicates what's in <embed> section above -->
        <p class="note">This specification does not define a mechanism
        for interacting with third-party handlers, as it is expected
        to be user-agent-specific. Some UAs might opt to support a
        plugin mechanism such as the Netscape Plugin API; others may
        use remote content convertors or have built-in support for
        certain types. <a href="#refsNPAPI">[NPAPI]</a></p>

        <p class="big-issue">this doesn't completely duplicate the
        navigation section, since it handles &lt;param>, etc, but
        surely some work should be done to work with it</p>

       </dd>


       <dt>If the type of the resource is an <span>XML MIME
       type</span><!-- XXX xref --></dt>
       <dt>If the type of the resource is HTML</dt>
       <dt>If the type of the resource does not start with
       "<code>image/</code>"</dt>

       <dd>

        <p>The <code>object</code> element must be associated with a
        nested <span>browsing context</span>, if it does not already
        have one. The element's nested <span>browsing context</span>
        must then be <span>navigated</span> to the given
        resource. (The <code title="attr-object-data">data</code>
        attribute of the <code>object</code> element doesn't get
        updated if the browsing context gets further navigated to
        other locations.)</p>

        <p class="big-issue">navigation might end up treating it as
        something else, because it can do sniffing. how should we
        handle that?</p>

       </dd>


       <dt>If the resource is a supported image format, and support
       for images has not been disabled</dt>

       <dd>

        <p>The <code>object</code> element represents the specified
        image. The image is not a nested <span>browsing
        context</span>.</p>

        <p class="big-issue">shouldn't we use the image-sniffing stuff
        here?</p>

       </dd>


       <dt>Otherwise</dt>

       <dd>

        <p>The <code>object</code> element represents the specified
        image, but the image cannot be shown. Jump to step 3 below in
        the overall set of steps (fallback).</p>

       </dd>

      </dl>

     </li>

     <li><p>The element's contents are not part of what the
     <code>object</code> element represents.</p>

     <li><p>Once the resource is completely loaded, <span>fire a <code
     title="event-load">load</code> event</span>.</p></li> <!-- XXX
     ordering of events (like with iframe) -->

    </ol>

   <li><p>If the <code title="attr-object-data">data</code> attribute
   is absent but the <code title="attr-object-type">type</code>
   attribute is present, and if the user agent can find a handler
   suitable according to the value of the <code
   title="attr-object-type">type</code> attribute, then that handler
   should be used. If the handler supports a scriptable interface, the
   <code>HTMLObjectElement</code> object representing the element
   should expose that interface. The handler is not a nested
   <span>browsing context</span>. If no suitable handler can be found,
   jump to the next step (fallback).</p></li>

   <li><p>(Fallback.) The <code>object</code> element doesn't
   represent anything except what the element's contents represent,
   ignoring any leading <code>param</code> element children. This is
   the element's <span>fallback content</span>.</li>

  </ol>

  <p>In the absence of other factors (such as style sheets), user
  agents must show the user what the <code>object</code> element
  represents. Thus, the contents of <code>object</code> elements act
  as <span>fallback content</span>, to be used only when referenced
  resources can't be shown (e.g. because it returned a 404
  error). This allows multiple <code>object</code> elements to be
  nested inside each other, targeting multiple user agents with
  different capabilities, with the user agent picking the best one it
  supports.</p>

  <p>The <code title="attr-hyperlink-usemap">usemap</code> attribute,
  if present while the <code>object</code> element represents an
  image, can indicate that the object has an associated <span>image
  map</span>. The attribute must be ignored if the <code>object</code>
  element doesn't represent an image.</p>

  <p class="big-issue">height/width</p>

  <p>The DOM attributes <dfn
  title="dom-object-data"><code>data</code></dfn>, <dfn
  title="dom-object-type"><code>type</code></dfn>, <dfn
  title="dom-object-useMap"><code>useMap</code></dfn>, <dfn
  title="dom-object-height"><code>height</code></dfn>, and <dfn
  title="dom-object-width"><code>width</code></dfn> each must
  <span>reflect</span> the respective content attributes of the same
  name.</p>


  <h4>The <dfn><code>param</code></dfn> element</h4>

  <!-- no type -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of an <code>object</code> element, before any
   content other than <code>param</code> elements.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-param-name">name</code> (required)</dd>
   <dd><code title="attr-param-value">value</code> (required)</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLParamElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-param-name">name</span>;
           attribute DOMString <span title="dom-param-value">value</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>param</code> element defines parameters for handlers
  invoked by <code>object</code> elements.</p>

  <p>The <dfn title="attr-param-name"><code>name</code></dfn>
  attribute gives the name of the parameter.</p>

  <p>The <dfn title="attr-param-value"><code>value</code></dfn>
  attribute gives the value of the parameter.</p>

  <p>Both attributes must be present. They may have any value.</p>

  <p>If both attributes are present, and if the parent element of the
  <code>param</code> is an <code>object</code> element, then the
  element defines a <dfn
  title="concept-param-parameters">parameter</dfn> with the given
  name/value pair.</p>

  <p>The DOM attributes <dfn
  title="dom-param-name"><code>name</code></dfn> and <dfn
  title="dom-name-value"><code>value</code></dfn> must both
  <span>reflect</span> the respective content attributes of the same
  name.</p>


  <h4>The <dfn id="canvas"><code>canvas</code></dfn> element</h4>

  <p><span title="Strictly inline-level content">Strictly inline-level</span> <span>embedded content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the only <span>embedded content</span> child of a <code>figure</code> element.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-canvas-height">height</code></dd>
   <dd><code title="attr-canvas-width">width</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
    <pre class="idl">interface <dfn>HTMLCanvasElement</dfn> : <span>HTMLElement</span> {
         attribute long <span title="dom-canvas-width">width</span>;
         attribute long <span title="dom-canvas-height">height</span>;

  DOMString <span title="dom-canvas-toDataURL">toDataURL()</span>;
  DOMString <span title="dom-canvas-toDataURL-type">toDataURL</span>(in DOMString type);

  DOMObject <span title="dom-canvas-getContext">getContext</span>(in DOMString contextID);
};</pre>
   </dd>
  </dl>

  <p class="big-issue">Shouldn't allow inline-level content to be the
  content model when the parent's content model is strictly inline
  only.</p>

  <p>The <code>canvas</code> element represents a resolution-dependent
  bitmap canvas, which can be used for rendering graphs, game
  graphics, or other visual images on the fly.</p>

  <p>Authors should not use the <code>canvas</code> element in a
  document when a more suitable element is available. For example, it
  is inappropriate to use a <code>canvas</code> element to render a
  page heading: if the desired presentation of the heading is
  graphically intense, it should be marked up using appropriate
  elements (typically <code>h1</code>) and then styled using CSS and
  supporting technologies such as XBL.</p>

  <p>When authors use the <code>canvas</code> element, they should
  also provide content that, when presented to the user, conveys
  essentially the same function or purpose as the bitmap canvas. This
  content may be placed as content of the <code>canvas</code>
  element. The contents of the <code>canvas</code> element, if any,
  are the element's <span>fallback content</span>.</p>

  <p>In interactive visual media with <span>scripting enabled</span>,
  the canvas element is an embedded element with a dynamically created
  image.</p>

  <p>In non-interactive, static, visual media, if the
  <code>canvas</code> element has been previously painted on (e.g. if
  the page was viewed in an interactive visual medium and is now being
  printed, or if some script that ran during the page layout process
  painted on the element), then the <code>canvas</code> element must
  be treated as embedded content with the current image and
  size. Otherwise, the element's fallback content must be used
  instead.</p>

  <p>In non-visual media, and in visual media with <span>scripting
  disabled</span>, the <code>canvas</code> element's fallback content
  must be used instead.</p>

  <p>The <code>canvas</code> element has two attributes to control the
  size of the coordinate space: <dfn
  title="attr-canvas-height"><code>height</code></dfn> and <dfn
  title="attr-canvas-width"><code>width</code></dfn>. These
  attributes, when specified, must have values that are <span
  title="valid non-negative integer">valid non-negative
  integers</span>. The <span>rules for parsing non-negative
  integers</span> must be used to obtain their numeric values. If an
  attribute is missing, or if parsing its value returns an error, then
  the default value must be used instead. The <code>width</code>
  attribute defaults to 300, and the <code>height</code> attribute
  defaults to 150.</p>

  <p>The intrinsic dimensions of the <code>canvas</code> element equal
  the size of the coordinate space, with the numbers interpreted in
  CSS pixels. However, the element can be sized arbitrarily by a
  style sheet. During rendering, the image is scaled to fit this layout
  size.</p>

  <p>The size of the coordinate space does not necessarily represent
  the size of the actual bitmap that the user agent will use
  internally or during rendering. On high-definition displays, for
  instance, the user agent may internally use a bitmap with two device
  pixels per unit in the coordinate space, so that the rendering
  remains at high quality throughout.</p>

  <p>The canvas must initially be fully transparent black.</p>

  <p>If the <code title="attr-canvas-width">width</code> and <code
  title="attr-canvas-height">height</code> attributes are dynamically
  modified, the bitmap and any associated contexts must be cleared
  back to their initial state and reinitialised with the newly
  specified coordinate space dimensions.</p>

  <p>The <dfn title="dom-canvas-width"><code>width</code></dfn> and
  <dfn title="dom-canvas-height"><code>height</code></dfn> DOM
  attributes must <span>reflect</span> the content attributes of the
  same name.</p>

  <p>To draw on the canvas, authors must first obtain a reference to a
  <dfn>context</dfn> using the <dfn
  title="dom-canvas-getContext"><code>getContext</code></dfn> method
  of the <code>canvas</code> element.</p>

  <p>This specification only defines one context, with the name "<code
  title="canvas-context-2d">2d</code>". If <code
  title="dom-canvas-getContext">getContext()</code> is called with
  that exact string, then the UA must return a reference to an object
  implementing <code>CanvasRenderingContext2D</code>. Other
  specifications may define their own contexts, which would return
  different objects.</p>

  <p>Vendors may also define experimental contexts using the syntax
  <code><var title="">vendorname</var>-<var
  title="">context</var></code>, for example, <code>moz-3d</code>.</p>

  <p>When the UA is passed an empty string or a string specifying a
  context that it does not support, then it must return null. String
  comparisons should be literal and case-sensitive.</p>

  <p class="note">A future version of this specification will probably
  define a <code>3d</code> context (probably based on the OpenGL ES
  API).</p>

  <p>The <dfn
  title="dom-canvas-toDataURL"><code>toDataURL()</code></dfn> method
  must, when called with no arguments, return a <code
  title="">data:</code> URI containing a representation of the image
  as a PNG file. <a href="#refsPNG">[PNG]</a>.</p>

  <p>The <dfn title="dom-canvas-toDataURL-type"><code>toDataURL(<var
  title="">type</var>)</code></dfn> method (when called with one
  <em>or more</em> arguments) must return a <code>data:</code> URI
  containing a representation of the image in the format given by <var
  title="">type</var>. The possible values are MIME types with no
  parameters, for example <code>image/png</code>,
  <code>image/jpeg</code>, or even maybe <code>image/svg+xml</code> if
  the implementation actually keeps enough information to reliably
  render an SVG image from the canvas.</p>

  <p>Only support for <code>image/png</code> is required. User agents
  may support other types. If the user agent does not support the
  requested type, it must return the image using the PNG format.</p>

  <p>User agents must convert the provided type to lower case before
  establishing if they support that type and before creating the
  <code>data:</code> URL.</p> <!-- XXX define "convert to lower case"
  -->

  <p class="note">When trying to use types other than
  <code>image/png</code>, authors can check if the image was really
  returned in the requested format by checking to see if the returned
  string starts with one the exact strings "<code
  title="">data:image/png,</code>" or "<code
  title="">data:image/png;</code>". If it does, the image is PNG, and
  thus the requested type was not supported.</p>

  <p>Arguments other than the <var title="">type</var> must be
  ignored, and must not cause the user agent to raise an exception (as
  would normally occur if a method was called with the wrong number of
  arguments). A future version of this specification will probably
  allow extra parameters to be passed to <code
  title="dom-canvas-toDataURL">toDataURL()</code> to allow authors to
  more carefully control compression settings, image metadata,
  etc.</p>

  <p><strong>Security:</strong> To prevent <em>information
  leakage</em>, the <code
  title="dom-canvas-toDataURL">toDataURL()</code> and <code
  title="dom-context-2d-getImageData">getImageData()</code> methods
  should raise a <span>security exception</span> if the canvas ever
  had images painted on it that originate from a domain other than the
  <span title="script's domain">domain of the script</span> that
  painted the images onto the canvas.</p>


  <h5>The 2D context</h5>

  <p>When the <code title="dom-canvas-getContext">getContext()</code>
  method of a <code>canvas</code> element is invoked with <dfn
  title="canvas-context-2d"><code>2d</code></dfn> as the argument, a
  <code>CanvasRenderingContext2D</code> object is returned.</p>

  <p>There is only one <code>CanvasRenderingContext2D</code> object
  per canvas, so calling the <code
  title="dom-canvas-getContext">getContext()</code> method with the
  <code title="canvas-context-2d">2d</code> argument a second time
  must return the same object.</p>

  <p>The 2D context represents a flat cartesian surface whose origin
  (0,0) is at the top left corner, with the coordinate space having
  <var title="">x</var> values increasing when going right, and <var
  title="">y</var> values increasing when going down.</p>

  <pre class="idl">interface <dfn>CanvasRenderingContext2D</dfn> {

  // back-reference to the canvas readonly attribute
  <span>HTMLCanvasElement</span> <span
  title="dom-context-2d-canvas">canvas</span>;

  // state
  void <span title="dom-context-2d-save">save</span>(); // push state on state stack
  void <span title="dom-context-2d-restore">restore</span>(); // pop state stack and restore state

  // transformations (default transform is the identity matrix)
  void <span title="dom-context-2d-scale">scale</span>(in float x, in float y);
  void <span title="dom-context-2d-rotate">rotate</span>(in float angle);
  void <span title="dom-context-2d-translate">translate</span>(in float x, in float y);
  void <span title="dom-context-2d-transform">transform</span>(in float m11, in float m12, in float m21, in float m22, in float dx, in float dy);
  void <span title="dom-context-2d-setTransform">setTransform</span>(in float m11, in float m12, in float m21, in float m22, in float dx, in float dy);
<!--
  // XXX we've also received requests for:
  void skew(...);
  void reflect(...); // or mirror(...)
-->
  // compositing
           attribute float <span title="dom-context-2d-globalAlpha">globalAlpha</span>; // (default 1.0)
           attribute DOMString <span title="dom-context-2d-globalCompositeOperation">globalCompositeOperation</span>; // (default over)

  // colors and styles
           attribute DOMObject <span title="dom-context-2d-strokeStyle">strokeStyle</span>; // (default black)
           attribute DOMObject <span title="dom-context-2d-fillStyle">fillStyle</span>; // (default black)
  <span>CanvasGradient</span> <span title="dom-context-2d-createLinearGradient">createLinearGradient</span>(in float x0, in float y0, in float x1, in float y1);
  <span>CanvasGradient</span> <span title="dom-context-2d-createRadialGradient">createRadialGradient</span>(in float x0, in float y0, in float r0, in float x1, in float y1, in float r1);
  <span>CanvasPattern</span> <span title="dom-context-2d-createPattern">createPattern</span>(in <span>HTMLImageElement</span> image, DOMString repetition);
  <span>CanvasPattern</span> <span title="dom-context-2d-createPattern">createPattern</span>(in <span>HTMLCanvasElement</span> image, DOMString repetition);

  // line caps/joins
           attribute float <span title="dom-context-2d-lineWidth">lineWidth</span>; // (default 1)
           attribute DOMString <span title="dom-context-2d-lineCap">lineCap</span>; // "butt", "round", "square" (default "butt")
           attribute DOMString <span title="dom-context-2d-lineJoin">lineJoin</span>; // "round", "bevel", "miter" (default "miter")
           attribute float <span title="dom-context-2d-miterLimit">miterLimit</span>; // (default 10)

  // shadows
           attribute float <span title="dom-context-2d-shadowOffsetX">shadowOffsetX</span>; // (default 0)
           attribute float <span title="dom-context-2d-shadowOffsetY">shadowOffsetY</span>; // (default 0)
           attribute float <span title="dom-context-2d-shadowBlur">shadowBlur</span>; // (default 0)
           attribute DOMString <span title="dom-context-2d-shadowColor">shadowColor</span>; // (default black)

  // rects
  void <span title="dom-context-2d-clearRect">clearRect</span>(in float x, in float y, in float w, in float h);
  void <span title="dom-context-2d-fillRect">fillRect</span>(in float x, in float y, in float w, in float h);
  void <span title="dom-context-2d-strokeRect">strokeRect</span>(in float x, in float y, in float w, in float h);

  // path API
  void <span title="dom-context-2d-beginPath">beginPath</span>();
  void <span title="dom-context-2d-closePath">closePath</span>();
  void <span title="dom-context-2d-moveTo">moveTo</span>(in float x, in float y);
  void <span title="dom-context-2d-lineTo">lineTo</span>(in float x, in float y);
  void <span title="dom-context-2d-quadraticCurveTo">quadraticCurveTo</span>(in float cpx, in float cpy, in float x, in float y);
  void <span title="dom-context-2d-bezierCurveTo">bezierCurveTo</span>(in float cp1x, in float cp1y, in float cp2x, in float cp2y, in float x, in float y);
  void <span title="dom-context-2d-arcTo">arcTo</span>(in float x1, in float y1, in float x2, in float y2, in float radius);
  void <span title="dom-context-2d-rect">rect</span>(in float x, in float y, in float w, in float h);
  void <span title="dom-context-2d-arc">arc</span>(in float x, in float y, in float radius, in float startAngle, in float endAngle, in boolean anticlockwise);
  void <span title="dom-context-2d-fill">fill</span>();
  void <span title="dom-context-2d-stroke">stroke</span>();
  void <span title="dom-context-2d-clip">clip</span>();
  boolean <span title="dom-context-2d-isPointInPath">isPointInPath</span>(in float x, in float y);

  // drawing images
  void <span title="dom-context-2d-drawImage">drawImage</span>(in <span>HTMLImageElement</span> image, in float dx, in float dy);
  void <span title="dom-context-2d-drawImage">drawImage</span>(in <span>HTMLImageElement</span> image, in float dx, in float dy, in float dw, in float dh);
  void <span title="dom-context-2d-drawImage">drawImage</span>(in <span>HTMLImageElement</span> image, in float sx, in float sy, in float sw, in float sh, in float dx, in float dy, in float dw, in float dh);
  void <span title="dom-context-2d-drawImage">drawImage</span>(in <span>HTMLCanvasElement</span> image, in float dx, in float dy);
  void <span title="dom-context-2d-drawImage">drawImage</span>(in <span>HTMLCanvasElement</span> image, in float dx, in float dy, in float dw, in float dh);
  void <span title="dom-context-2d-drawImage">drawImage</span>(in <span>HTMLCanvasElement</span> image, in float sx, in float sy, in float sw, in float sh, in float dx, in float dy, in float dw, in float dh);

  // pixel manipulation
  <span>ImageData</span> <span title="dom-context-2d-getImageData">getImageData</span>(in float sx, in float sy, in float sw, in float sh);
  void <span title="dom-context-2d-putImageData">putImageData</span>(in <span>ImageData</span> image, in float dx, in float dy);

  // drawing text is not supported in this version of the API
  // (there is no way to predict what metrics the fonts will have,
  // which makes fonts very hard to use for painting)

};

interface <dfn>CanvasGradient</dfn> {
  // opaque object
  void <span title="dom-canvasgradient-addColorStop">addColorStop</span>(in float offset, in DOMString color);
};

interface <dfn>CanvasPattern</dfn> {
  // opaque object
};

interface <dfn>ImageData</dfn> {
  readonly attribute long int <span title="dom-imagedata-width">width</span>;
  readonly attribute long int <span title="dom-imagedata-height">height</span>;
  readonly attribute int[] <span title="dom-imagedata-data">data</span>;
};</pre>

  <p>The <dfn title="dom-context-2d-canvas"><code>canvas</code></dfn>
  attribute must return the <code>canvas</code> element that the
  context paints on.</p>


  <h6>The canvas state</h6>

  <p>Each context maintains a stack of drawing states. <dfn
  title="drawing state">Drawing states</dfn> consist of:</p>

  <ul class="brief">
   <li>The current transformation matrix.</li>
   <li>The current clip region.</li>
   <li>The current values of the following attributes: <code
   title="dom-context-2d-strokeStyle">strokeStyle</code>, <code
   title="dom-context-2d-fillStyle">fillStyle</code>, <code
   title="dom-context-2d-globalAlpha">globalAlpha</code>, <code
   title="dom-context-2d-lineWidth">lineWidth</code>, <code
   title="dom-context-2d-lineCap">lineCap</code>, <code
   title="dom-context-2d-lineJoin">lineJoin</code>, <code
   title="dom-context-2d-miterLimit">miterLimit</code>, <code
   title="dom-context-2d-shadowOffsetX">shadowOffsetX</code>, <code
   title="dom-context-2d-shadowOffsetY">shadowOffsetY</code>, <code
   title="dom-context-2d-shadowBlur">shadowBlur</code>, <code
   title="dom-context-2d-shadowColor">shadowColor</code>, <code
   title="dom-context-2d-globalCompositeOperation">globalCompositeOperation</code>.</li>
  </ul>

  <p class="note">The current path and the current bitmap are not part
  of the drawing state. The current path is persistent, and can only
  be reset using the <code
  title="dom-context-2d-beginPath">beginPath()</code> method. The
  current bitmap is <span title="concept-canvas-image">a property of
  the canvas</span><!-- XXX xref -->, not the context.</p>

  <p>The <dfn title="dom-context-2d-save"><code>save()</code></dfn>
  method pushes a copy of the current drawing state onto the drawing
  state stack.</p>

  <p>The <dfn
  title="dom-context-2d-restore"><code>restore()</code></dfn> method
  pops the top entry in the drawing state stack, and resets the
  drawing state it describes. If there is no saved state, the method
  does nothing.</p>


  <h6><dfn>Transformations</dfn></h6>

  <p>The transformation matrix is applied to all drawing operations
  prior to their being rendered. It is also applied when creating the
  clip region.</p> <!-- conformance criteria for actual drawing are
  described in "drawing model" below -->

  <p>When the context is created, the transformation matrix must
  initially be the identity transform. It may then be adjusted using
  the three transformation methods.</p>

  <p>The transformations must be performed in reverse order. For
  instance, if a scale transformation that doubles the width is
  applied, followed by a rotation transformation that rotates drawing
  operations by a quarter turn, and a rectangle twice as wide as it is
  tall is then drawn on the canvas, the actual result will be a
  square.</p>

  <p>The <dfn title="dom-context-2d-scale"><code>scale(<var
  title="">x</var>, <var title="">y</var>)</code></dfn> method must
  add the scaling transformation described by the arguments to the
  transformation matrix. The <var title="">x</var> argument represents
  the scale factor in the horizontal direction and the <var
  title="">y</var> argument represents the scale factor in the
  vertical direction. The factors are multiples.</p>

  <p>The <dfn title="dom-context-2d-rotate"><code>rotate(<var
  title="">angle</var>)</code></dfn> method must add the rotation
  transformation described by the argument to the transformation
  matrix. The <var title="">angle</var> argument represents a
  clockwise rotation angle expressed in radians.</p>

  <p>The <dfn title="dom-context-2d-translate"><code>translate(<var
  title="">x</var>, <var title="">y</var>)</code></dfn> method must
  add the translation transformation described by the arguments to the
  transformation matrix. The <var title="">x</var> argument represents
  the translation distance in the horizontal direction and the <var
  title="">y</var> argument represents the translation distance in the
  vertical direction. The arguments are in coordinate space units.</p>

  <p>The <dfn title="dom-context-2d-transform"><code>transform(<var
  title="">m11</var>, <var title="">m12</var>, <var
  title="">m21</var>, <var title="">m22</var>, <var title="">dx</var>,
  <var title="">dy</var>)</code></dfn> method must multiply the
  current transformation matrix with the matrix described by:</p>

  <table class="matrix">
   <tr>
    <td><var title="">m11</var></td>
    <td><var title="">m21</var></td>
    <td><var title="">dx</var></td>
   </tr>
   <tr>
    <td><var title="">m12</var></td>
    <td><var title="">m22</var></td>
    <td><var title="">dy</var></td>
   </tr>
   <tr>
    <td>0</td>
    <td>0</td>
    <td>1</td>
   </tr>
  </table>

  <p>The <dfn
  title="dom-context-2d-setTransform"><code>setTransform(<var
  title="">m11</var>, <var title="">m12</var>, <var
  title="">m21</var>, <var title="">m22</var>, <var title="">dx</var>,
  <var title="">dy</var>)</code></dfn> method must reset the current
  transform to the identity matrix, and then invoke the <code><span
  title="dom-context-2d-transform">transform</span>(<var
  title="">m11</var>, <var title="">m12</var>, <var
  title="">m21</var>, <var title="">m22</var>, <var title="">dx</var>,
  <var title="">dy</var>)</code> method with the same arguments.</p>


  <h6>Compositing</h6>

  <p>All drawing operations are affected by the global compositing
  attributes, <code
  title="dom-context-2d-globalAlpha">globalAlpha</code> and <code
  title="dom-context-2d-globalCompositeOperation">globalCompositeOperation</code>.</p>

  <!-- conformance criteria for painting are described in the "drawing
  model" section below -->

  <p>The <dfn
  title="dom-context-2d-globalAlpha"><code>globalAlpha</code></dfn>
  attribute gives an alpha value that is applied to shapes and images
  before they are composited onto the canvas. The value must be in the
  range from 0.0 (fully transparent) to 1.0 (no additional
  transparency). If an attempt is made to set the attribute to a value
  outside this range, the attribute must retain its previous
  value. When the context is created, the <code
  title="dom-context-2d-globalAlpha">globalAlpha</code> attribute must
  initially have the value 1.0.</p>

  <p>The <dfn
  title="dom-context-2d-globalCompositeOperation"><code>globalCompositeOperation</code></dfn>
  attribute sets how shapes and images are drawn onto the existing
  bitmap, once they have had <code
  title="dom-context-2d-globalAlpha">globalAlpha</code> and the
  current transformation matrix applied. It must be set to a value
  from the following list. In the descriptions below, the source image
  is the shape or image being rendered, and the destination image is
  the current state of the bitmap.</p>

  <p class="issue">The source-* descriptions below don't define what
  should happen with semi-transparent regions.</p>

  <dl>

   <dt><dfn title="gcop-source-atop"><code>source-atop</code></dfn></dt>

   <dd>Display the source image wherever both images are opaque.
   Display the destination image wherever the destination image is
   opaque but the source image is transparent. Display transparency
   elsewhere.</dd>

   <dt><dfn title="gcop-source-in"><code>source-in</code></dfn></dt>

   <dd>Display the source image wherever both the source image and
   destination image are opaque. Display transparency elsewhere.</dd>

   <dt><dfn title="gcop-source-out"><code>source-out</code></dfn></dt>

   <dd>Display the source image wherever the source image is opaque
   and the destination image is transparent. Display transparency
   elsewhere.</dd>

   <dt><dfn title="gcop-source-over"><code>source-over</code></dfn> (default)</dt>

   <dd>Display the source image wherever the source image is opaque.
   Display the destination image elsewhere.</dd>


   <dt><dfn title="gcop-destination-atop"><code>destination-atop</code></dfn></dt>

   <dd>Same as <code title="gcop-source-atop">source-atop</code> but
   using the destination image instead of the source image and vice
   versa.</dd>

   <dt><dfn title="gcop-destination-in"><code>destination-in</code></dfn></dt>

   <dd>Same as <code title="gcop-source-in">source-in</code> but using
   the destination image instead of the source image and vice
   versa.</dd>

   <dt><dfn title="gcop-destination-out"><code>destination-out</code></dfn></dt>

   <dd>Same as <code title="gcop-source-out">source-out</code> but
   using the destination image instead of the source image and vice
   versa.</dd>

   <dt><dfn title="gcop-destination-over"><code>destination-over</code></dfn></dt>

   <dd>Same as <code title="gcop-source-over">source-over</code> but
   using the destination image instead of the source image and vice
   versa.</dd>


   <dt><dfn title="gcop-darker"><code>darker</code></dfn></dt>

   <dd>Display the sum of the source image and destination images,
   with color values approaching 0 as a limit.</dd>

   <dt><dfn title="gcop-lighter"><code>lighter</code></dfn></dt>

   <dd>Display the sum of the source image and destination image,
   with color values approaching 1 as a limit.</dd>


   <dt><dfn title="gcop-copy"><code>copy</code></dfn></dt>

   <dd>Display the source image instead of the destination image.</dd>


   <dt><dfn title="gcop-xor"><code>xor</code></dfn></dt>

   <dd>Exclusive OR of the source and destination images.</dd>


   <dt><code><var title="">vendorName</var>-<var title="">operationName</var></code></dt>

   <dd>Vendor-specific extensions to the list of composition operators
   should use this syntax.</dd>

  </dl>

  <p>These values are all case-sensitive &mdash; they must be used
  exactly as shown. User agents must only recognise values that
  exactly match the values given above.</p>

  <p>On setting, if the user agent does not recognise the specified
  value, it must be ignored, leaving the value of <code
  title="dom-context-2d-globalCompositeOperation">globalCompositeOperation</code>
  unaffected.</p>

  <p>When the context is created, the <code
  title="dom-context-2d-globalCompositeOperation">globalCompositeOperation</code>
  attribute must initially have the value
  <code>source-over</code>.</p>


  <h6>Colors and styles</h6>

  <p>The <dfn
  title="dom-context-2d-strokeStyle"><code>strokeStyle</code></dfn>
  attribute represents the color or style to use for the lines around
  shapes, and the <dfn
  title="dom-context-2d-fillStyle"><code>fillStyle</code></dfn>
  attribute represents the color or style to use inside the
  shapes.</p>

  <p>Both attributes can be either strings,
  <code>CanvasGradient</code>s, or <code>CanvasPattern</code>s. On
  setting, strings should be parsed as CSS &lt;color&gt; values and
  the color assigned, and <code>CanvasGradient</code> and
  <code>CanvasPattern</code> objects must be assigned themselves. <a
  href="#refsCSS3COLOR">[CSS3COLOR]</a> If the value is a string but
  is not a valid color, or is neither a string, a
  <code>CanvasGradient</code>, nor a <code>CanvasPattern</code>, then
  it must be ignored, and the attribute must retain its previous
  value.</p>

  <p>On getting, if the value is a color, then: if it has alpha equal
  to 1.0, then the color must be returned as an uppercase six-digit
  hex value, prefixed with a "#" character (U+0023 NUMBER SIGN), with
  the first two digits representing the red component, the next two
  digits representing the green component, and the last two digits
  representing the blue component, the digits being in the range 0-9
  A-F (U+0030 to U+0039 and U+0041 to U+0046). If the value has alpha
  less than 1.0, then the value must instead be returned in the CSS
  <code title="">rgba()</code> functional-notation format: the literal
  string <code title="">rgba</code> (U+0072 U+0067 U+0062 U+0061)
  followed by a U+0028 LEFT PARENTHESIS, a base-ten integer in the
  range 0-255 representing the red component (using digits 0-9, U+0030
  to U+0039, in the shortest form possible), a literal U+002C COMMA
  and U+0020 SPACE, an integer for the green component, a comma and a
  space, an integer for the blue component, another comma and space, a
  U+0030 DIGIT ZERO, a U+002E FULL STOP (representing the decimal
  point), one or more digits in the range 0-9 (U+0030 to U+0039)
  representing the fractional part of the alpha value, and finally a
  U+0029 RIGHT PARENTHESIS.</p>

  <p>Otherwise, if it is not a color but a <code>CanvasGradient</code>
  or <code>CanvasPattern</code>, then an object supporting those
  interfaces must be returned. Such objects are opaque and therefore
  only useful for assigning to other attributes or for comparison to
  other gradients or patterns.</p>

  <p>When the context is created, the <code
  title="dom-context-2d-strokeStyle">strokeStyle</code> and <code
  title="dom-context-2d-fillStyle">fillStyle</code> attributes must
  initially have the string value <code title="">#000000</code>.</p>

  <p>There are two types of gradients, linear gradients and radial
  gradients, both represented by objects implementing the opaque
  <dfn><code>CanvasGradient</code></dfn> interface.</p>

  <p>Once a gradient has been created (see below), stops must be
  placed along it to define how the colors are distributed along the
  gradient. Between each such stop, the colors and the alpha component
  must be interpolated over the RGBA space to find the color to use at
  that offset. Immediately before the 0 offset and immediately after
  the 1 offset, transparent black stops are be assumed.</p>

  <p>The <dfn
  title="dom-canvasgradient-addColorStop"><code>addColorStop(<var
  title="">offset</var>, <var title="">color</var>)</code></dfn>
  method on the <code>CanvasGradient</code> interface adds a new stop
  to a gradient. If the <var title="">offset</var> is less than 0 or
  greater than 1 then an <code>INDEX_SIZE_ERR</code> exception must be
  raised. If the <var title="">color</var> cannot be parsed as a CSS
  color, then a <code>SYNTAX_ERR</code> exception must be raised.
  Otherwise, the gradient must be updated with the new stop
  information.</p>

  <p>The <dfn title="createLinearGradient"><code
  title="dom-context-2d-createLinearGradient">createLinearGradient(<var
  title="">x0</var>, <var title="">y0</var>, <var title="">x1</var>,
  <var title="">y1</var>)</code></dfn> method takes four arguments,
  representing the start point (<var title="">x0</var>, <var
  title="">y0</var>) and end point (<var title="">x1</var>, <var
  title="">y1</var>) of the gradient, in coordinate space units, and
  must return a linear <code>CanvasGradient</code> initialised with
  that line.</p>

  <p>Linear gradients must be rendered such that at the starting point
  on the canvas the color at offset 0 is used, that at the ending
  point the color at offset 1 is used, that all points on a line
  perpendicular to the line between the start and end points have the
  color at the point where those two lines cross (interpolation
  happening as described above), and that any points beyond the start
  or end points are a transparent black.</p>

  <p>The <dfn title="createRadialGradient"><code
  title="dom-context-2d-createRadialGradient">createRadialGradient(<var
  title="">x0</var>, <var title="">y0</var>, <var title="">r0</var>,
  <var title="">x1</var>, <var title="">y1</var>, <var
  title="">r1</var>)</code></dfn> method takes six arguments, the
  first three representing the start circle with origin (<var
  title="">x0</var>, <var title="">y0</var>) and radius <var
  title="">r0</var>, and the last three representing the end circle
  with origin (<var title="">x1</var>, <var title="">y1</var>) and
  radius <var title="">r1</var>. The values are in coordinate space
  units. The method must return a radial <code>CanvasGradient</code>
  initialised with those two circles.</p>

  <p>Radial gradients must be rendered such that a cone is created
  from the two circles, so that at the circumference of the starting
  circle the color at offset 0 is used, that at the circumference
  around the ending circle the color at offset 1 is used, that the
  circumference of a circle drawn a certain fraction of the way along
  the line between the two origins with a radius the same fraction of
  the way between the two radii has the color at that offset
  (interpolation happening as described above), that the end circle
  appear to be above the start circle when the end circle is not
  completely enclosed by the start circle, that the end circle be
  filled by the color at offset 1, and that any points not described
  by the gradient are a transparent black.</p>

  <p>If a gradient has no stops defined, then the gradient must be
  treated as a solid transparent black. Gradients are, naturally, only
  painted where the stroking or filling effect requires that they be
  drawn.</p>

  <p>Support for actually painting gradients is optional. Instead of
  painting the gradients, user agents may instead just paint the first
  stop's color. However, <code
  title="dom-context-2d-createLinearGradient">createLinearGradient()</code>
  and <code
  title="dom-context-2d-createRadialGradient">createRadialGradient()</code>
  must always return objects when passed valid arguments.</p>

  <p>Patterns are represented by objects implementing the opaque
  <dfn><code>CanvasPattern</code></dfn> interface.</p>

  <p>To create objects of this type, the <dfn
  title="createPattern"><code
  title="dom-context-2d-createPattern">createPattern(image,
  repetition)</code></dfn> method is used. The first argument gives
  the image to use as the pattern (either an
  <code>HTMLImageElement</code> or an <code>HTMLCanvasElement</code>).
  Modifying this image after calling the <code
  title="dom-context-2d-createPattern">createPattern()</code> method
  must not affect the pattern. The second argument must be a string
  with one of the following values: <code title="">repeat</code>,
  <code title="">repeat-x</code>, <code title="">repeat-y</code>,
  <code title="">no-repeat</code>. If the empty string or null is
  specified, <code title="">repeat</code> must be assumed. If an
  unrecognised value is given, then the user agent must raise a
  <code>SYNTAX_ERR</code> exception. User agents must recognise the
  four values described above exactly (e.g. they must not do case
  folding). The method must return a <code>CanvasPattern</code> object
  suitably initialised.</p>

  <p>The <var title="">image</var> argument must be an instance of an
  <code>HTMLImageElement</code> or <code>HTMLCanvasElement</code>. If
  the <var title="">image</var> is of the wrong type, the
  implementation must raise a <code>TYPE_MISMATCH_ERR</code>
  exception.</p>

  <p>Patterns must be painted so that the top left of the first image
  is anchored at the origin of the coordinate space, and images are
  then repeated horizontally to the left and right (if the
  <code>repeat-x</code> string was specified) or vertically up and
  down (if the <code>repeat-y</code> string was specified) or in all
  four directions all over the canvas (if the <code>repeat</code>
  string was specified). The images are not be scaled by this process;
  one CSS pixel of the image must be painted on one coordinate space
  unit. Of course, patterns must only actually painted where the
  stroking or filling effect requires that they be drawn, and are
  affected by the current transformation matrix.</p>

  <p>Support for patterns is optional. If the user agent doesn't
  support patterns, then <code
  title="dom-context-2d-createPattern">createPattern()</code> must
  return null.</p>


  <h6>Line styles</h6>

  <p>The <dfn
  title="dom-context-2d-lineWidth"><code>lineWidth</code></dfn>
  attribute gives the default width of lines, in coordinate space
  units. On setting, zero and negative values must be ignored, leaving
  the value unchanged.</p>

  <p>When the context is created, the <code
  title="dom-context-2d-lineWidth">lineWidth</code> attribute must
  initially have the value <code>1.0</code>.</p>

  <p>The <dfn
  title="dom-context-2d-lineCap"><code>lineCap</code></dfn> attribute
  defines the type of endings that UAs shall place on the end of
  lines. The three valid values are <code>butt</code>,
  <code>round</code>, and <code>square</code>. The <code>butt</code>
  value means that the end of each line is a flat edge perpendicular
  to the direction of the line. The <code>round</code> value means
  that a semi-circle with the diameter equal to the width of the line
  is then added on to the end of the line. The <code>square</code>
  value means that at the end of each line is a rectangle with the
  length of the line width and the width of half the line width,
  placed flat against the edge perpendicular to the direction of the
  line. On setting, any other value than the literal strings
  <code>butt</code>, <code>round</code>, and <code>square</code> must
  be ignored, leaving the value unchanged.</p>

  <p>When the context is created, the <code
  title="dom-context-2d-lineCap">lineCap</code> attribute must
  initially have the value <code>butt</code>.</p>

  <p>The <dfn
  title="dom-context-2d-lineJoin"><code>lineJoin</code></dfn>
  attribute defines the type of corners that that UAs will place where
  two lines meet. The three valid values are <code>round</code>,
  <code>bevel</code>, and <code>miter</code>.</p>

  <p>On setting, any other value than the literal strings
  <code>round</code>, <code>bevel</code> and <code>miter</code> must
  be ignored, leaving the value unchanged.</p>

  <p>When the context is created, the <code
  title="dom-context-2d-lineJoin">lineJoin</code> attribute must
  initially have the value <code>miter</code>.</p>

  <p>The <code>round</code> value means that a filled arc connecting
  the corners on the outside of the join, with the diameter equal to
  the line width, and the origin at the point where the inside edges
  of the lines touch, must be rendered at joins. The
  <code>bevel</code> value means that a filled triangle connecting
  those two corners with a straight line, the third point of the
  triangle being the point where the lines touch on the inside of the
  join, must be rendered at joins. The <code>miter</code> value means
  that a filled four- or five-sided polygon must be placed at the
  join, with two of the lines being the perpendicular edges of the
  joining lines, and the other two being continuations of the outside
  edges of the two joining lines, as long as required to intersect
  without going over the miter limit.</p>

  <p>The miter length is the distance from the point where the lines
  touch on the inside of the join to the intersection of the line
  edges on the outside of the join. The miter limit ratio is the
  maximum allowed ratio of the miter length to the line width. If the
  miter limit would be exceeded, then a fifth line must be added to
  the polygon, connecting the two outside lines, such that the
  distance from the inside point of the join to the point in the
  middle of this fifth line is the maximum allowed value for the miter
  length.</p>

  <p>The miter limit ratio can be explicitly set using the <dfn
  title="dom-context-2d-miterLimit"><code>miterLimit</code></dfn>
  attribute. On setting, zero and negative values must be ignored,
  leaving the value unchanged.</p>

  <p>When the context is created, the <code
  title="dom-context-2d-miterLimit">miterLimit</code> attribute must
  initially have the value <code>10.0</code>.</p>

  <!-- XXX this section doesn't say what these attributes return or
  what they do on setting. not a big deal; it's pretty obvious. but if
  anyone complains, we'll have to add it -->


  <h6><dfn>Shadows</dfn></h6>

  <p>All drawing operations are affected by the four global shadow
  attributes. Shadows form part of the source image during
  composition.</p>

  <p>The <dfn
  title="dom-context-2d-shadowColor"><code>shadowColor</code></dfn>
  attribute sets the color of the shadow.</p>

  <!-- XXX this section doesn't say what this attributes returns or
  what they do on setting. if anyone complains, we'll have to add
  it. shadowColor is a CSS Color attribute. -->

  <p>When the context is created, the <code
  title="dom-context-2d-shadowColor">shadowColor</code> attribute
  initially must be fully-transparent black.</p>

  <p>The <dfn
  title="dom-context-2d-shadowOffsetX"><code>shadowOffsetX</code></dfn>
  and <dfn
  title="dom-context-2d-shadowOffsetY"><code>shadowOffsetY</code></dfn>
  attributes specify the distance that the shadow will be offset in
  the positive horizontal and positive vertical distance
  respectively. Their values are in coordinate space units.</p>

  <!-- XXX we don't define getting/setting -->

  <p>When the context is created, the shadow offset attributes
  initially have the value <code>0</code>.</p>

  <p>The <dfn
  title="dom-context-2d-shadowBlur"><code>shadowBlur</code></dfn>
  attribute specifies the number of coordinate space units that the
  blurring is to cover. On setting, negative numbers must be ignored,
  leaving the attribute unmodified.</p>

  <!-- XXX we don't define getting/setting -->

  <p>When the context is created, the <code
  title="dom-context-2d-shadowBlur">shadowBlur</code> attribute must
  initially have the value <code>0</code>.</p>

  <p>Support for shadows is optional. When they are supported, then,
  when shadows are drawn, they must be rendered using the specified
  color, offset, and blur radius.</p>

  <!-- XXX we don't really define what that means -->


  <h6>Simple shapes (rectangles)</h6>

  <p>There are three methods that immediately draw rectangles to the
  bitmap. They each take four arguments; the first two give the <var
  title="">x</var> and <var title="">y</var> coordinates of the top
  left of the rectangle, and the second two give the width and height
  of the rectangle, respectively.</p>

  <p>Shapes are painted without affecting the current path, and are
  subject to <span title="dom-context-2d-">transformations</span>,
  <span title="shadows">shadow effects</span>, <span
  title="globalAlpha">global alpha</span>, <span title="clipping
  path">clipping paths</span>, and <span
  title="globalCompositeOperation">global composition
  operators</span>.</p>

  <p>Negative values for width and height must cause the
  implementation to raise an <code>INDEX_SIZE_ERR</code>
  exception.</p>

  <p>The <dfn
  title="dom-context-2d-clearRect"><code>clearRect()</code></dfn>
  method must clear the pixels in the specified rectangle to a fully
  transparent black, erasing any previous image. If either height or
  width are zero, this method has no effect.</p>

  <p>The <dfn
  title="dom-context-2d-fillRect"><code>fillRect()</code></dfn> method
  must paint the specified rectangular area using the <code
  title="dom-context-2d-fillStyle">fillStyle</code>. If either height
  or width are zero, this method has no effect.</p>

  <p>The <dfn
  title="dom-context-2d-strokeRect"><code>strokeRect()</code></dfn>
  method must draw a rectangular outline of the specified size using
  the <code title="dom-context-2d-strokeStyle">strokeStyle</code>,
  <code title="dom-context-2d-lineWidth">lineWidth</code>, <code
  title="dom-context-2d-lineJoin">lineJoin</code>, and (if
  appropriate) <code
  title="dom-context-2d-miterLimit">miterLimit</code>
  attributes. <span title="issue">What should happen with zero heights
  or widths?</span></p>


  <h6>Complex shapes (paths)</h6>

  <p>The context always has a current path. There is only one current
  path, it is not part of the <span title="dom-context-2d-">drawing
  state</span>.</p>

  <p>A <dfn>path</dfn> has a list of zero or more subpaths. Each
  subpath consists of a list of one or more points, connected by
  straight or curved lines, and a flag indicating whether the subpath
  is closed or not. A closed subpath is one where the last point of
  the subpath is connected to the first point of the subpath by a
  straight line. Subpaths with fewer than two points are ignored when
  painting the path.</p>

  <p>Initially, the context's path must have zero subpaths.</p>


  <p>The <dfn
  title="dom-context-2d-beginPath"><code>beginPath()</code></dfn>
  method must empty the list of subpaths so that the context once
  again has zero subpaths.</p>


  <p>The <dfn title="dom-context-2d-moveTo"><code>moveTo(<var
  title="">x</var>, <var title="">y</var>)</code></dfn> method must
  create a new subpath with the specified point as its first (and
  only) point.</p>


  <p>The <dfn
  title="dom-context-2d-closePath"><code>closePath()</code></dfn>
  method must do nothing if the context has no subpaths. Otherwise, it
  must mark the last subpath as closed, create a new subpath whose
  first point is the same as the previous subpath's first point, and
  finally add this new subpath to the path. (If the last subpath had
  more than one point in its list of points, then this is equivalent
  to adding a straight line connecting the last point back to the
  first point, thus "closing" the shape, and then repeating the last
  <code title="dom-context-2d-moveTo">moveTo()</code> call.)</p>


  <p>New points and the lines connecting them are added to subpaths
  using the methods described below. In all cases, the methods only
  modify the last subpath in the context's paths.</p>


  <p>The <dfn title="dom-context-2d-lineTo"><code>lineTo(<var
  title="">x</var>, <var title="">y</var>)</code></dfn> method must do
  nothing if the context has no subpaths. Otherwise, it must connect
  the last point in the subpath to the given point (<var
  title="">x</var>, <var title="">y</var>) using a straight line, and
  must then add the given point (<var title="">x</var>, <var
  title="">y</var>) to the subpath.</p>


  <p>The <dfn
  title="dom-context-2d-quadraticCurveTo"><code>quadraticCurveTo(<var
  title="">cpx</var>, <var title="">cpy</var>, <var title="">x</var>,
  <var title="">y</var>)</code></dfn> method must do nothing if the
  context has no subpaths. Otherwise it must connect the last point in
  the subpath to the given point (<var title="">x</var>, <var
  title="">y</var>) by a quadratic curve with control point (<var
  title="">cpx</var>, <var title="">cpy</var>), and must then add the
  given point (<var title="">x</var>, <var title="">y</var>) to the
  subpath.</p>


  <p>The <dfn
  title="dom-context-2d-bezierCurveTo"><code>bezierCurveTo(<var
  title="">cp1x</var>, <var title="">cp1y</var>, <var
  title="">cp2x</var>, <var title="">cp2y</var>, <var
  title="">x</var>, <var title="">y</var>)</code></dfn> method must do
  nothing if the context has no subpaths. Otherwise, it must connect
  the last point in the subpath to the given point (<var
  title="">x</var>, <var title="">y</var>) using a bezier curve with
  control points (<var title="">cp1x</var>, <var title="">cp1y</var>)
  and (<var title="">cp2x</var>, <var title="">cp2y</var>). Then, it
  must add the point (<var title="">x</var>, <var title="">y</var>) to
  the subpath.</p>


  <p>The <dfn title="dom-context-2d-arcTo"><code>arcTo(<var
  title="">x1</var>, <var title="">y1</var>, <var title="">x2</var>,
  <var title="">y2</var>, <var title="">radius</var>)</code></dfn>
  method must do nothing if the context has no subpaths. If the
  context <em>does</em> have a subpath, then the behaviour depends on
  the arguments and the last point in the subpath.</p>

  <p>Let the point (<var title="">x0</var>, <var title="">y0</var>) be
  the last point in the subpath. Let <var title="">The Arc</var> be
  the shortest arc given by circumference of the circle that has one
  point tangent to the line defined by the points (<var
  title="">x0</var>, <var title="">y0</var>) and (<var
  title="">x1</var>, <var title="">y1</var>), another point tangent to
  the line defined by the points (<var title="">x1</var>, <var
  title="">y1</var>) and (<var title="">x2</var>, <var
  title="">y2</var>), and that has radius <var
  title="">radius</var>. The points at which this circle touches these
  two lines are called the start and end tangent points
  respectively.</p>

  <p>If the point (<var title="">x2</var>, <var title="">y2</var>) is
  on the line defined by the points (<var title="">x0</var>, <var
  title="">y0</var>) and (<var title="">x1</var>, <var
  title="">y1</var>) then the method must do nothing, as no arc would
  satisfy the above constraints.</p>

  <p>Otherwise, the method must connect the point (<var
  title="">x0</var>, <var title="">y0</var>) to the start tangent
  point by a straight line, then connect the start tangent point to
  the end tangent point by <var title="">The Arc</var>, and finally
  add the start and end tangent points to the subpath.</p>

  <p>Negative or zero values for <var title="">radius</var> must cause
  the implementation to raise an <code>INDEX_SIZE_ERR</code>
  exception.</p>


  <p>The <dfn title="dom-context-2d-arc"><code>arc(<var
  title="">x</var>, <var title="">y</var>, <var title="">radius</var>,
  <var title="">startAngle</var>, <var title="">endAngle</var>, <var
  title="">anticlockwise</var>)</code></dfn> method draws an arc. If
  the context has any subpaths, then the method must add a straight
  line from the last point in the subpath to the start point of the
  arc. In any case, it must draw the arc between the start point of
  the arc and the end point of the arc, and add the start and end
  points of the arc to the subpath. The arc and its start and end
  points are defined as follows:</p>

  <p>Consider a circle that has its origin at (<var title="">x</var>,
  <var title="">y</var>) and that has radius <var
  title="">radius</var>. The points at <var title="">startAngle</var>
  and <var title="">endAngle</var> along the circle's circumference,
  measured in radians clockwise from the positive x-axis, are the
  start and end points respectively. The arc is the path along the
  circumference of this circle from the start point to the end point,
  going anti-clockwise if the <var title="">anticlockwise</var>
  argument is true, and clockwise otherwise.</p>

  <p>Negative or zero values for <var title="">radius</var> must cause
  the implementation to raise an <code>INDEX_SIZE_ERR</code>
  exception.</p>


  <p>The <dfn title="dom-context-2d-rect"><code>rect(<var
  title="">x</var>, <var title="">y</var>, <var title="">w</var>, <var
  title="">h</var>)</code></dfn> method must create a new subpath
  containing just the four points (<var title="">x</var>, <var
  title="">y</var>), (<var title="">x</var>+<var title="">w</var>,
  <var title="">y</var>), (<var title="">x</var>+<var
  title="">w</var>, <var title="">y</var>+<var title="">h</var>),
  (<var title="">x</var>, <var title="">y</var>+<var
  title="">h</var>), with those four points connected by straight
  lines, and must then mark the subpath as closed. It must then create
  a new subpath with the point (<var title="">x</var>, <var
  title="">y</var>) as the only point in the subpath.</p>

  <p>Negative values for <var title="">w</var> and <var
  title="">h</var> must cause the implementation to raise an
  <code>INDEX_SIZE_ERR</code> exception.</p>


  <p>The <dfn title="dom-context-2d-fill"><code>fill()</code></dfn>
  method must fill each subpath of the current path in turn, using
  <code title="dom-context-2d-fillStyle">fillStyle</code>, and using
  the non-zero winding number rule. Open subpaths must be implicitly
  closed when being filled (without affecting the actual
  subpaths).</p>

  <p>The <dfn
  title="dom-context-2d-stroke"><code>stroke()</code></dfn> method
  must stroke each subpath of the current path in turn, using the
  <code title="dom-context-2d-strokeStyle">strokeStyle</code>, <code
  title="dom-context-2d-lineWidth">lineWidth</code>, <code
  title="dom-context-2d-lineJoin">lineJoin</code>, and (if
  appropriate) <code
  title="dom-context-2d-miterLimit">miterLimit</code> attributes.</p>

  <p>Paths, when filled or stroked, must be painted without affecting
  the current path, and must be subject to
  <span>transformations</span>, <span title="shadows">shadow
  effects</span>, <span title="dom-context-2d-globalAlpha">global
  alpha</span>, <span title="clipping path">clipping paths</span>, and
  <span title="dom-context-2d-globalCompositeOperation">global
  composition operators</span>.</p>

  <p class="note">The transformation is applied to the path when it is
  drawn, not when the path is constructed. Thus, a single path can be
  constructed and then drawn according to different transformations
  without recreating the path.</p>


  <p>The <dfn title="dom-context-2d-clip"><code>clip()</code></dfn>
  method must create a new <dfn>clipping path</dfn> by calculating the
  intersection of the current clipping path and the area described by
  the current path (after applying the <span>current
  transformation</span>), using the non-zero winding number rule. Open
  subpaths must be implicitly closed when computing the clipping path,
  without affecting the actual subpaths.</p>

  <p>When the context is created, the initial clipping path is the
  rectangle with the top left corner at (0,0) and the width and height
  of the coordinate space.</p>


  <p>The <dfn
  title="dom-context-2d-isPointInPath"><code>isPointInPath(<var
  title="">x</var>, <var title="">y</var>)</code></dfn> method must
  return true if the point given by the <var title="">x</var> and <var
  title="">y</var> coordinates passed to the method, when treated as
  coordinates in the canvas' coordinate space unaffected by the
  current transformation, is within the area of the canvas that is
  inside the current path; and must return false otherwise.</p>



  <h6>Images</h6>

  <p>To draw images onto the canvas, the <dfn
  title="dom-context-2d-drawImage"><code>drawImage</code></dfn> method
  can be used.</p>

  <p>This method is overloaded with three variants: <code
  title="">drawImage(<var title="">image</var>, <var
  title="">dx</var>, <var title="">dy</var>)</code>, <code
  title="">drawImage(<var title="">image</var>, <var
  title="">dx</var>, <var title="">dy</var>, <var title="">dw</var>,
  <var title="">dh</var>)</code>, and <code title="">drawImage(<var
  title="">image</var>, <var title="">sx</var>, <var
  title="">sy</var>, <var title="">sw</var>, <var title="">sh</var>,
  <var title="">dx</var>, <var title="">dy</var>, <var
  title="">dw</var>, <var title="">dh</var>)</code>. (Actually it is
  overloaded with six; each of those three can take either an
  <code>HTMLImageElement</code> or an <code>HTMLCanvasElement</code>
  for the <var title="">image</var> argument.)  If not specified, the
  <var title="">dw</var> and <var title="">dh</var> arguments default
  to the values of <var title="">sw</var> and <var title="">sh</var>,
  interpreted such that one CSS pixel in the image is treated as one
  unit in the canvas coordinate space. If the <var title="">sx</var>,
  <var title="">sy</var>, <var title="">sw</var>, and <var
  title="">sh</var> arguments are omitted, they default to 0, 0, the
  image's intrinsic width in image pixels, and the image's intrinsic
  height in image pixels, respectively.</p>

  <p>The <var title="">image</var> argument must be an instance of an
  <code>HTMLImageElement</code> or <code>HTMLCanvasElement</code>. If
  the <var title="">image</var> is of the wrong type, the
  implementation must raise a <code>TYPE_MISMATCH_ERR</code>
  exception. If one of the <var title="">sy</var>, <var
  title="">sw</var>, <var title="">sw</var>, and <var
  title="">sh</var> arguments is outside the size of the image, or if
  one of the <var title="">dw</var> and <var title="">dh</var>
  arguments is negative, the implementation must raise an
  <code>INDEX_SIZE_ERR</code> exception.</p>

  <p>When <code title="dom-context-2d-drawImage">drawImage()</code> is
  invoked, the specified region of the image specified by the source
  rectangle (<var title="">sx</var>, <var title="">sy</var>, <var
  title="">sw</var>, <var title="">sh</var>) must be painted on the
  region of the canvas specified by the destination rectangle (<var
  title="">dx</var>, <var title="">dy</var>, <var title="">dw</var>,
  <var title="">dh</var>).</p>

  <p><img src="drawImage.png" alt=""></p> <!-- no alt="" text since
  the image is just repeating what was stated in the previous
  paragraph. -->

  <p>Images are painted without affecting the current path, and are
  subject to <span>transformations</span>, <span
  title="shadows">shadow effects</span>, <span
  title="dom-context-2d-globalAlpha">global alpha</span>, <span
  title="clipping path">clipping paths</span>, and <span
  title="dom-context-2d-globalCompositeOperation">global composition
  operators</span>.</p>

  <!-- XXX should somehow say that the image used is the actual image
  of the target element, not the rendered image (e.g. height/width
  attributes don't affect it -->


  <h6><dfn>Pixel manipulation</dfn></h6>

  <p>The <dfn
  title="dom-context-2d-getImageData"><code>getImageData(<var
  title="">sx</var>, <var title="">sy</var>, <var title="">sw</var>,
  <var title="">sh</var>)</code></dfn> method must return an
  <code>ImageData</code> object representing the underlying pixel data
  for the area of the canvas denoted by the rectangle which has one
  corner at the (<var title="">sx</var>, <var title="">sy</var>)
  coordinate, and that has width <var title="">sw</var> and height
  <var title="">sh</var>. Pixels outside the canvas must be returned
  as transparent black.</p>

  <p><code>ImageData</code> objects must be initialised so that their
  <dfn title="dom-imagedata-height"><code>height</code></dfn>
  attribute is set to <var title="">h</var>, the number of rows in the
  image data, their <dfn
  title="dom-imagedata-width"><code>width</code></dfn> attribute is
  set to <var title="">w</var>, the number of physical device pixels
  per row in the image data, and the <dfn
  title="dom-imagedata-data"><code>data</code></dfn> attribute is
  initialised to an array of <var title="">h</var>&times;<var
  title="">w</var>&times;4 integers. The pixels must be represented in
  this array in left-to-right order, row by row, starting at the top
  left, with each pixel's red, green, blue, and alpha components being
  given in that order. Each component of each device pixel represented
  in this array must be in the range 0..255, representing the 8 bit
  value for that component.</p>

  <p>The <dfn
  title="dom-context-2d-putImageData"><code>putImageData(<var
  title="">image</var>, <var title="">dx</var>, <var
  title="">dy</var>)</code></dfn> method must take the given
  <code>ImageData</code> structure, and draw it at the specified
  location <var title="">dx</var>,<var title="">dy</var> in the canvas
  coordinate space, mapping each pixel represented by the
  <code>ImageData</code> structure into one device pixel.</p>

  <p>The handling of pixel rounding when the specified coordinates do
  not exactly map to the device coordinate space is not defined by
  this specification, except that the following must result in no
  visible changes to the rendering:</p>

  <pre>context.putImageData(context.getImageData(x, y, w, h), x, y);</pre>

  <p>...for any value of <var title="">x</var> and <var
  title="">y</var>. In other words, while user agents may round the
  arguments of the two methods so that they map to device pixel
  boundaries, any rounding performed must be performed consistently
  for both the <code
  title="dom-context-2d-getImageData">getImageData()</code> and <code
  title="dom-context-2d-putImageData">putImageData()</code>
  operations.</p>

  <p>The current transformation matrix must not affect the <code
  title="dom-context-2d-getImageData">getImageData()</code> and <code
  title="dom-context-2d-putImageData">putImageData()</code>
  methods.</p>



  <h6>Drawing model</h6>

  <p>When a shape or image is painted, user agents must follow these
  steps, in the order given (or act as if they do):</p>

  <ol>

   <li>The coordinates are transformed by the current transformation
   matrix.</li>

   <li>The shape or image is rendered, creating image <var
   title="">A</var>, as described in the previous sections. For
   shapes, the current fill, stroke, and line styles must be
   honoured.</li>

   <li>The shadow is rendered from image <var title="">A</var>, using
   the current shadow styles, creating image <var
   title="">B</var>.</li>

   <li>Image <var title="">A</var> is composited over image <var
   title="">B</var> creating the source image.</li>

   <li>The source image has its alpha adjusted by <code
   title="dom-context-2d-globalAlpha">globalAlpha</code>.</li>

   <li>Within the clip region (as affected by the current
   transformation matrix), the source image is composited over the
   current canvas bitmap using the current composition operator.</li>

  </ol>


<!--
  <h4 id="3d">The 3D context</h4>

  <p class="big-issue">Well, one day.</p>
-->




  <h4>The <dfn><code>map</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLMapElement</dfn> : <span>HTMLElement</span> {
  readonly attribute <span>HTMLCollection</span> <span title="dom-map-areas">areas</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>map</code> element, in conjuction with any
  <code>area</code> element descendants, defines an <span>image
  map</span>.</p>

  <p>The <dfn title="dom-map-areas"><code>areas</code></dfn> attribute
  must return an <code>HTMLCollection</code> rooted at the
  <code>map</code> element, whose filter matches only
  <code>area</code> elements.</p>
  


  <h4>The <dfn><code>area</code></dfn> element</h4>

  <p><span>Strictly inline-level content</span>.</p>
  <!-- XXX as defined, the area element on its own isn't enough to
  satisfy "significant inline-level content" model. should it be? -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>strictly inline-level content</span> is allowed,
   but only as a descendant of a <code>map</code> element.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-area-alt">alt</code></dd>
   <dd><code title="attr-area-coords">coords</code></dd>
   <dd><code title="attr-area-shape">shape</code></dd>
   <dd><code title="attr-hyperlink-href">href</code></dd>
   <dd><code title="attr-hyperlink-rel">rel</code></dd>
   <dd><code title="attr-hyperlink-media">media</code></dd>
   <dd><code title="attr-hyperlink-hreflang">hreflang</code></dd>
   <dd><code title="attr-hyperlink-type">type</code></dd>
   <dd><code title="attr-hyperlink-ping">ping</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLAreaElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-area-alt">alt</span>;
           attribute DOMString <span title="dom-area-coords">coords</span>;
           attribute DOMString <span title="dom-area-shape">shape</span>;
           attribute DOMString <span title="dom-area-href">href</span>;
           attribute DOMString <span title="dom-area-rel">rel</span>;
  readonly attribute DOMTokenList <span title="dom-area-relList">relList</span>;
           attribute DOMString <span title="dom-area-media">media</span>;
           attribute DOMString <span title="dom-area-hreflang">hreflang</span>;
           attribute DOMString <span title="dom-area-type">type</span>;
           attribute DOMString <span title="dom-area-ping">ping</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>area</code> element represents either a hyperlink with
  some text and a corresponding area on an <span>image map</span>, or
  a dead area on an image map.</p>

  <p>If the <code>area</code> element has an <code
  title="attr-hyperlink-href">href</code> attribute, then the
  <code>area</code> element represents a <span>hyperlink</span>; the
  <dfn title="attr-area-alt"><code>alt</code></dfn> attribute, which
  must then be present, specifies the text.</p>

  <p>However, if the <code>area</code> element has no <code
  title="attr-hyperlink-href">href</code> attribute, then the area
  represented by the element cannot be selected, and the <code
  title="attr-area-alt">alt</code> attribute must be omitted.</p>

  <p>In both cases, the <code title="attr-area-shape">shape</code> and
  <code title="attr-area-coords">coords</code> attributes specify the
  area.</p>

  <p>The <dfn title="attr-area-shape"><code>shape</code></dfn>
  attribute is an <span>enumerated attribute</span>. The following
  table lists the keywords defined for this attribute. The states
  given in the first cell of the the rows with keywords give the
  states to which those keywords map. Some of the keywords are
  non-conforming, as noted in the last column.</p>

  <table>
   <thead>
    <tr>
     <th>State
     <th>Keywords
     <th>Notes
   <tbody>
    <tr>
     <td rowspan=2><dfn title="attr-area-shape-circle">Circle state</dfn>
     <td><code title="">circ</code>
     <td>Non-conforming
    <tr>
     <td><code title="">circle</code>
     <td>
    <tr>
     <td><dfn title="attr-area-shape-default">Default state</dfn>
     <td><code title="">default</code>
     <td>
    <tr>
     <td rowspan=2><dfn title="attr-area-shape-poly">Polygon state</dfn>
     <td><code title="">poly</code>
     <td>
    <tr>
     <td><code title="">polygon</code>
     <td>Non-conforming
    <tr>
     <td rowspan=2><dfn title="attr-area-shape-rect">Rectangle state</dfn>
     <td><code title="">rect</code>
     <td>
    <tr>
     <td><code title="">rectangle</code>
     <td>Non-conforming
  </table>

  <p>The attribute may be ommited. The <i>missing value default</i> is
  the <span title="attr-area-shape-rect">rectangle</span> state.</p>

  <p>The <dfn title="attr-area-coords"><code>coords</code></dfn>
  attribute must, if specified, contain a <span>valid list of
  integers</span>. This attribute gives the coordinates for the shape
  described by the <code title="attr-area-shape">shape</code>
  attribute. The processing for this attribute is described as part of
  the <span>image map</span> processing model.</p>

  <p>In the <span title="attr-area-shape-circle">circle state</span>,
  <code>area</code> elements must have a <code
  title="attr-area-coords">coords</code> attribute present, with three
  integers, the last of which must be non-negative. The first integer
  must be the distance in CSS pixels from the left edge of the image
  to the center of the circle, the second integer must be the distance
  in CSS pixels from the top edge of the image to the center of the
  circle, and the third integer must be the radius of the circle,
  again in CSS pixels.</p>

  <p>In the <span title="attr-area-shape-default">default state</span>
  state, <code>area</code> elements must not have a <code
  title="attr-area-coords">coords</code> attribute.</p>

  <p>In the <span title="attr-area-shape-poly">polygon state</span>,
  <code>area</code> elements must have a <code
  title="attr-area-coords">coords</code> attribute with at least six
  integers, and the number of integers must be even. Each pair of
  integers must represent a coordinate given as the distances from the
  left and the top of the image in CSS pixels respectively, and all
  the coordinates together must represent the points of the polygon,
  in order.</p>

  <p>In the <span title="attr-area-shape-rect">rectangle state</span>,
  <code>area</code> elements must have a <code
  title="attr-area-coords">coords</code> attribute with exactly four
  integers, the first of which must be less than the third, and the
  second of which must be less than the fourth. The four points must
  represent, respectively, the distance from the left edge of the
  image to the top left side of the rectangle, the distance from the
  top edge to the top side, the distance from the left edge to the
  right side, and the distance from the top edge to the bottom side,
  all in CSS pixels.</p>

  <p>When user agents allow users to <span title="following
  hyperlinks">follow hyperlinks</span> created using the
  <code>area</code> element, as described in the next section, the
  <code title="attr-hyperlink-href">href</code> and <code
  title="attr-hyperlink-ping">ping</code> attributes decide how the
  link is followed. The <code title="attr-hyperlink-rel">rel</code>,
  <code title="attr-hyperlink-media">media</code>, <code
  title="attr-hyperlink-hreflang">hreflang</code>, and <code
  title="attr-hyperlink-type">type</code> attributes may be used to
  indicate to the user the likely nature of the target resource before
  the user follows the link.</p>

  <p>The <code title="attr-hyperlink-ping">ping</code>, <code
  title="attr-hyperlink-rel">rel</code>, <code
  title="attr-hyperlink-media">media</code>, <code
  title="attr-hyperlink-hreflang">hreflang</code>, and <code
  title="attr-hyperlink-type">type</code> attributes must be omitted
  if the <code title="attr-hyperlink-href">href</code> attribute is
  not present.</p>

  <p>The <span>activation behavior</span> of <code>area</code>
  elements is to run the following steps:</p>

  <ol>

   <li>If the <code title="event-DOMActivate">DOMActivate</code> event
   in question is not <span
   title="concept-events-trusted">trusted</span> (i.e. a <code
   title="dom-click">click()</code> method call was the reason for the
   event being dispatched), and the <code>area</code> element's <code
   title="attr-area-target">target</code> attribute is <span
   class="big-issue">...</span> then raise an
   <code>INVALID_ACCESS_ERR</code> exception.</li>

   <li>Otherwise, the user agent must <span title="following
   hyperlinks">follow the hyperlink</span> defined by the
   <code>area</code> element, if any.</li>

  </ol>

  <p class="note">One way that a user agent can enable users to follow
  hyperlinks is by allowing <code>area</code> elements to be clicked,
  or focussed and activated by the keyboard. This <span
  title="interactive elements">will cause</span> the aforementioned
  <span>activation behavior</span> to be invoked.</p>

  <p>The DOM attributes <dfn
  title="dom-area-alt"><code>alt</code></dfn>, <dfn
  title="dom-area-coords"><code>coords</code></dfn>, <dfn
  title="dom-area-shape"><code>shape</code></dfn>, <dfn
  title="dom-area-href"><code>href</code></dfn>, <dfn
  title="dom-area-rel"><code>rel</code></dfn>, <dfn
  title="dom-area-media"><code>media</code></dfn>, <dfn
  title="dom-area-hreflang"><code>hreflang</code></dfn>, <dfn
  title="dom-area-type"><code>type</code></dfn>, and <dfn
  title="dom-area-ping"><code>ping</code></dfn> each must
  <span>reflect</span> the respective content attributes of the same
  name.</p>

  <p>The DOM attribute <dfn
  title="dom-area-rellist"><code>relList</code></dfn> must
  <span>reflect</span> the <code title="attr-hyperlink-rel">rel</code>
  content attribute.</p>



  <h4 id="image-maps">Image maps</h4>

  <!-- TESTS
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/smallcats%22%20usemap%3D%23a%20onclick%3Dw%28%27img%27%29%3E%0A%3Cmap%20name%3Da%3E%0A%20%3Carea%20onclick%3Dw%28%271%27%29%20coords%3D%270%25%200%25%20100%25%20100%25%27%20href%3Djavascript%3A%3E%0A%3C/map%3E
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A%3Cbody%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/smallcats%22%20usemap%3D%23a%20onclick%3Dw%28%27img%27%29%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/sample%22%20usemap%3D%23a%20onclick%3Dw%28%27img%27%29%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3Cmap%20name%3Da%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%20%3Carea%20onclick%3Dw%28%271%27%29%20coords%3D%270%200%2050%2050%27%20href%3Djavascript%3A%20onfocus%3D%22w%28document.activeElement.tagName%29%22%3E%0A%3C/map%3E%0A%3Cscript%3E%0A%20var%20x%20%3D%20document.getElementsByTagName%28%27img%27%29%5B0%5D%3B%0A%20x.parentNode.appendChild%28x%29%3B%0A%20document.getElementsByTagName%28%27area%27%29%5B0%5D.focus%28%29%3B%0A%3C/script%3E
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3Ex%3Cmap%3E%3Carea%20shape%3Dpolyg%20coords%3D%221%2C2%203%22%3E%3C/map%3E%0A%3Cscript%3Ex%20%3D%20document.getElementsByTagName%28%27area%27%29%5B0%5D%3B%20w%28x.shape%20+%20%27%20%27%20+%20x.coords%29%3C/script%3E
  http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0D%0A%3Cp%3E%3Cimg%20src%3D%22http%3A//hixie.ch/resources/images/astrophy/128%22%20usemap%3D%23a%3E%0D%0A%3Cmap%20name%3Da%3E%3Carea%20shape%3Dcirc%20coords%3D%2220%2C20%2C10%25%22%20href%3D%23%3E%3Carea%20shape%3Dcirc%20coords%3D%2220%2C20%2C10%22%20href%3D%23%3E%3C/map%3E%0D%0A%3Cscript%3Edocument.write%28document.getElementsByTagName%28%27area%27%29%5B0%5D.coords%29%3C/script%3E
  -->

  <p>An <dfn>image map</dfn> allows geometric areas on an image to be
  associated with <span title="hyperlink">hyperlinks</span>.</p>

  <p>An image, in the form of an <code>img</code> element or an
  <code>object</code> element representing an image, may be associated
  with an image map (in the form of a <code>map</code> element) by
  specifying a <dfn
  title="attr-hyperlink-usemap"><code>usemap</code></dfn> attribute on
  the <code>img</code> or <code>object</code> element. The <code
  title="attr-area-usemap">usemap</code> attribute, if specified, must
  be a <span>valid hashed ID reference</span> to a <code>map</code>
  element.</p>

  <p>If an <code>img</code> element or an <code>object</code> element
  representing an image has a <code
  title="attr-area-usemap">usemap</code> attribute specified, user
  agents must process it as follows:</p>

  <ol>

   <li><p>First, <span>rules for parsing a hashed ID reference</span>
   to a <code>map</code> element must be followed. This will return
   either an element (the <var title="">map</var>) or null.</p></li>

   <li><p>If that returned null, then abort these steps. The image is
   not associated with an image map after all.</p></li>

   <li><p>Otherwise, the user agent must collect all the
   <code>area</code> elements that are descendants of the <var
   title="">map</var>. Let those be the <var
   title="">areas</var>.</p></li>

  </ol>

  <p>Having obtained the list of <code>area</code> elements that form
  the image map (the <var title="">areas</var>), interactive user
  agents must process the list in one of two ways.</p>

  <p>If the user agent intends to show the text that the
  <code>img</code> element represents, then it must use the following
  steps.</p>

  <p class="note">In user agents that do not support images, or that
  have images disabled, <code>object</code> elements cannot represent
  images, and thus this section never applies (the fallback content is
  shown instead). The following steps therefore only apply to
  <code>img</code> elements.</p>

  <ol>

   <li><p>Remove all the <code>area</code> elements in <var
   title="">areas</var> that have no <code
   title="attr-hyperlink-href">href</code> attribute.</p></li>

   <li><p>Remove all the <code>area</code> elements in <var
   title="">areas</var> that have no <code
   title="attr-area-alt">alt</code> attribute, or whose <code
   title="attr-area-alt">alt</code> attribute's value is the empty
   string, <em>if</em> there is another <code>area</code> element in
   <var title="">areas</var> with the same value in the <code
   title="attr-hyperlink-href">href</code> attribute and with a
   non-empty <code title="attr-area-alt">alt</code> attribute.</li>

   <li><p>Each remaining <code>area</code> element in <var
   title="">areas</var> represents a <span>hyperlink</span>. Those
   hyperlinks should all be made available to the user in a manner
   associated with the text of the <code>img</code> element.</p>

   <p>In this context, user agents may represent <code>area</code> and
   <code>img</code> elements with no specified <code
   title="">alt</code> attributes, or whose <code title="">alt</code>
   attributes are the empty string or some other non-visible text, in
   a user-agent-defined fashion intended to indicate the lack of
   suitable author-provided text.</p></li>

  </ol>

  <p>If the user agent intends to show the image and allow interaction
  with the image to select hyperlinks, then the image must be
  associated with a set of layered shapes, taken from the
  <code>area</code> elements in <var title="">areas</var>, in reverse
  tree order (so the last specified <code>area</code> element in the
  <var title="">map</var> is the bottom-most shape, and the first
  element in the <var title="">map</var>, in tree order, is the
  top-most shape).</p>

  <p>Each <code>area</code> element in <var title="">areas</var> must
  be processed as follows to obtain a shape to layer onto the
  image:</p>

  <ol>

   <li><p>Find the state that the element's <code
   title="attr-area-shape">shape</code> attribute represents.</p></li>

   <li><p>Use the <span>rules for parsing a list of integers</span> to
   parse the element's <code title="attr-area-coords">coords</code>
   attribute, if it is present, and let the result be the <var
   title="">coords</var> list. If the attribute is absent, let the
   <var title="">coords</var> list be the empty list.</p></li>

   <li><p>If the number of items in the <var title="">coords</var>
   list is less than the minimum number given for the
   <code>area</code> element's current state, as per the following
   table, then the shape is empty; abort these steps.</p>
    <table>
     <thead>
      <tr>
       <th>State
       <th>Minimum number of items
     <tbody>
      <tr>
       <td><span title="attr-area-shape-circle">Circle state</span>
       <td>3
      <tr>
       <td><span title="attr-area-shape-default">Default state</span>
       <td>0
      <tr>
       <td><span title="attr-area-shape-poly">Polygon state</span>
       <td>6
      <tr>
       <td><span title="attr-area-shape-rect">Rectangle state</span>
       <td>4
    </table>
   </li>

   <li><p>Check for excess items in the <var title="">coords</var>
   list as per the entry in the following list corresponding to the
   <code title="attr-area-shape">shape</code> attribute's state:</p>
    <dl class="switch">
     <dt><span title="attr-area-shape-circle">Circle state</span></dt>
     <dd>Drop any items in the list beyond the third.</dd>
     <dt><span title="attr-area-shape-default">Default state</span></dt>
     <dd>Drop all items in the list.</dd>
     <dt><span title="attr-area-shape-poly">Polygon state</span></dt>
     <dd>Drop the last item if there's an odd number of items.</dd>
     <dt><span title="attr-area-shape-rect">Rectangle state</span></dt>
     <dd>Drop any items in the list beyond the fourth.</dd>
    </dl>
   </li>

   <li><p>If the <code title="attr-area-shape">shape</code> attribute
   represents the <span title="attr-area-shape-rect">rectangle
   state</span>, and the first number in the list is numerically less
   than the third number in the list, then swap those two numbers
   around.</p></li>

   <li><p>If the <code title="attr-area-shape">shape</code> attribute
   represents the <span title="attr-area-shape-rect">rectangle
   state</span>, and the second number in the list is numerically less
   than the fourth number in the list, then swap those two numbers
   around.</p></li>

   <li><p>If the <code title="attr-area-shape">shape</code> attribute
   represents the <span title="attr-area-shape-circle">circle
   state</span>, and the third number in the list is less than or
   equal to zero, then the shape is empty; abort these steps.</p></li>

   <li><p>Now, the shape represented by the element is the one
   described for the entry in the list below corresponding to the
   state of the <code title="attr-area-shape">shape</code>
   attribute:</p>

    <dl class="switch">

     <dt><span title="attr-area-shape-circle">Circle state</span></dt>
     <dd>
      <p>Let <var title="">x</var> be the first number in <var
      title="">coords</var>, <var title="">y</var> be the second
      number, and <var title="">r</var> be the third number.</p>
      <p>The shape is a circle whose center is <var title="">x</var>
      CSS pixels from the left edge of the image and <var
      title="">x</var> CSS pixels from the top edge of the image, and
      whose radius is <var title="">r</var> pixels.</p>
     </dd>

     <dt><span title="attr-area-shape-default">Default state</span></dt>
     <dd>
      <p>The shape is a rectangle that exactly covers the entire
      image.</p>
     </dd>

     <dt><span title="attr-area-shape-poly">Polygon state</span></dt>
     <dd>

      <p>Let <var title="">x<sub title=""><var
      title="">i</var></sub></var> be the <span>(2<var
      title="">i</var>)</span>th entry in <var title="">coords</var>,
      and <var title="">y<sub title=""><var
      title="">i</var></sub></var> be the <span>(2<var
      title="">i</var>+1)</span>th entry in <var title="">coords</var>
      (the first entry in <var title="">coords</var> being the one
      with index 0).</p>

      <p>Let <var title="">the coordinates</var> be (<var
      title="">x<sub title=""><var title="">i</var></sub></var>, <var
      title="">y<sub title=""><var title="">i</var></sub></var>),
      interpreted in CSS pixels measured from the top left of the
      image, for all integer values of <var title="">i</var> from 0 to
      <span>(<var title="">N</var>/2)-1</span>, where <var
      title="">N</var> is the number of items in <var
      title="">coords</var>.</p>

      <p>The shape is a polygon whose vertices are given by <var
      title="">the coordinates</var>, and whose interior is
      established using the even-odd rule. <a
      href="#refsGRAPHICS">[GRAPHICS]</a></p>

      <!-- If anyone has this book ("Computer Graphics: Principles and
           Practice in C"), please check page 34 or so and see if it
           makes any references to literature in the bibliographic
           section to define the "even-odd" rule for polygon filling
           and hit testing.
        <dd id="refsGRAPHICS">[GRAPHICS]</dd>
        <dd>(Non-normative) <cite>Computer Graphics: Principles and Practice in C</cite>, Second Edition, J. Foley, A. van Dam, S. Feiner, J. Hughes. Addison-Wesley, July 1995. ISBN 0-201-84840-6.</dd>
      -->

      <!--
        browsers implement the even-odd rule / even winding rule:
        http://software.hixie.ch/utilities/js/live-dom-viewer/?%3C%21DOCTYPE%20html%3E%0A%3Cimg%20usemap%3D%22%23x%22%20src%3D%22/resources/images/sample%22%3E%0A%3Cmap%20name%3D%22x%22%3E%0A%20%20%3Carea%20shape%3Dpolygon%20coords%3D%220%2C0%200%2C100%20100%2C100%20100%2C2%201%2C2%202%2C1%202%2C99%2099%2C99%2099%2C0%22%20href%3Da%3E%0A%3C/map%3E%0A
       -->

     </dd>

     <dt><span title="attr-area-shape-rect">Rectangle state</span></dt>

     <dd>

      <p>Let <var title="">x1</var> be the first number in <var
      title="">coords</var>, <var title="">y1</var> be the second
      number, <var title="">x2</var> be the third number, and <var
      title="">y2</var> be the fourth number.</p>

      <p>The shape is a rectangle whose top-left corner is given by
      the coordinate (<var title="">x1</var>, <var title="">y1</var>)
      and whose bottom right corner is given by the coordinate (<var
      title="">x2</var>, <var title="">y2</var>), those coordinates
      being interpreted as CSS pixels from the top left corner of the
      image.</p>

     </dd>

    </dl>
   </li>

  </ol>

  <p>Mouse clicks on an image associated with a set of layered shapes
  per the above algorithm must be dispatched to the top-most shape
  covering the point that the pointing device indicated (if any), and
  then, must be dispatched again (with a new <code>Event</code>
  object) to the image element itself. User agents may also allow
  individual <code>area</code> elements representing <span
  title="hyperlink">hyperlinks</span> to be selected and activated
  (e.g. using a keyboard); events from this are not also propagated to
  the image.</p>

  <p class="note">Because a <code>map</code> element (and its
  <code>area</code> elements) can be associated with multiple
  <code>img</code> elements, it is possible for an <code>area</code>
  element to correspond to multiple focusable areas of the
  document.</p>

  <p>Image maps are <em>live</em>; if the DOM is mutated, then the
  user agent must act as if it had rerun the algorithms for image
  maps.</p>


  <h3>Tabular data</h3>

  <h4>The <dfn><code>table</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  and <span title="structured inline-level elements">structured
  inline-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>structured inline-level elements</span> are allowed.</dd>
   <dt>Content model:</dt>
   <dd>In this order: optionally a <code>caption</code> element,
   followed by either zero or more <code>colgroup</code> elements,
   followed optionally by a <code>thead</code> element, followed
   optionally by a <code>tfoot</code> element, followed by either zero
   or more <code>tbody</code> elements <em>or</em> one or more
   <code>tr</code> elements, followed optionally by a
   <code>tfoot</code> element (but there can only be one
   <code>tfoot</code> element child in total).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLTableElement</dfn> : <span>HTMLElement</span> {
           attribute <span>HTMLTableCaptionElement</span> <span title="dom-table-caption">caption</span>;
  HTMLElement <span title="dom-table-createCaption">createCaption</span>();
  void <span title="dom-table-deleteCaption">deleteCaption</span>();
           attribute <span>HTMLTableSectionElement</span> <span title="dom-table-tHead">tHead</span>;
  HTMLElement <span title="dom-table-createTHead">createTHead</span>();
  void <span title="dom-table-deleteTHead">deleteTHead</span>();
           attribute <span>HTMLTableSectionElement</span> <span title="dom-table-tFoot">tFoot</span>;
  HTMLElement <span title="dom-table-createTFoot">createTFoot</span>();
  void <span title="dom-table-deleteTFoot">deleteTFoot</span>();
  readonly attribute <span>HTMLCollection</span> <span title="dom-table-tBodies">tBodies</span>;
  readonly attribute <span>HTMLCollection</span> <span title="dom-table-rows">rows</span>;
  HTMLElement <span title="dom-table-insertRow">insertRow</span>(in long index);
  void <span title="dom-table-deleteRow">deleteRow</span>(in long index);
};</pre>
   </dd>
  </dl>

  <p>The <code>table</code> element represents data with more than one
  dimension (a <span title="concept-table">table</span>).</p>

  <p>The children of a <code>table</code> element must be, in
  order:</p>

  <ol>

   <li><p>Zero or one <code>caption</code> elements.</p></li>

   <li><p>Zero or more <code>colgroup</code> elements.</p></li>

   <li><p>Zero or one <code>thead</code> elements.</p></li>

   <li><p>Zero or one <code>tfoot</code> elements, if the last element
   in the table is not a <code>tfoot</code> element.</p></li>

   <li><p>Either:</p>

    <ul>

     <li>Zero or more <code>tbody</code> elements, or</li>

     <li>One or more <code>tr</code> elements.</li>

    </ul>

   </li>

   <li><p>Zero or one <code>tfoot</code> element, if there are no
   other <code>tfoot</code> elements in the table.</p></li>

  </ol>

  <p>The <code>table</code> element takes part in the <span>table
  model</span>.</p>

  <p>The <dfn title="dom-table-caption"><code>caption</code></dfn>
  DOM attribute must return, on getting, the first <code>caption</code>
  element child of the <code>table</code> element. On setting, the
  first <code>caption</code> element child of the <code>table</code>
  element, if any, must be removed, and the new value must be inserted
  as the first node of the <code>table</code> element.</p>

  <p>The <dfn
  title="dom-table-createCaption"><code>createCaption()</code></dfn>
  method must return a new <code>caption</code> element.</p>

  <p>The <dfn
  title="dom-table-deleteCaption"><code>deleteCaption()</code></dfn>
  method must remove the first <code>caption</code> element child of
  the <code>table</code> element, if any.</p>

  <p>The <dfn title="dom-table-tHead"><code>tHead</code></dfn> DOM
  attribute must return, on getting, the first <code>thead</code>
  element child of the <code>table</code> element. On setting, the
  first <code>thead</code> element child of the <code>table</code>
  element, if any, must be removed, and the new value must be inserted
  immediately before the first element in the <code>table</code>
  element that is neither a <code>caption</code> element nor a
  <code>colgroup</code> element.</p>

  <p>The <dfn
  title="dom-table-createTHead"><code>createTHead()</code></dfn>
  method must return a new <code>thead</code> element.</p>

  <p>The <dfn
  title="dom-table-deleteTHead"><code>deleteTHead()</code></dfn>
  method must remove the first <code>thead</code> element child of the
  <code>table</code> element, if any.</p>

  <p>The <dfn title="dom-table-tFoot"><code>tFoot</code></dfn> DOM
  attribute must return, on getting, the first <code>tfoot</code>
  element child of the <code>table</code> element. On setting, the
  first <code>tfoot</code> element child of the <code>table</code>
  element, if any, must be removed, and the new value must be inserted
  immediately before the first element in the <code>table</code>
  element that is neither a <code>caption</code> element, a
  <code>colgroup</code> element, nor a <code>thead</code> element.</p>

  <p>The <dfn
  title="dom-table-createTFoot"><code>createTFoot()</code></dfn>
  method must return a new <code>tfoot</code> element.</p>

  <p>The <dfn
  title="dom-table-deleteTFoot"><code>deleteTFoot()</code></dfn>
  method must remove the first <code>tfoot</code> element child of the
  <code>table</code> element, if any.</p>

  <p>The <dfn title="dom-table-tBodies"><code>tBodies</code></dfn>
  attribute must return an <code>HTMLCollection</code> rooted at the
  <code>table</code> node, whose filter matches only
  <code>tbody</code> elements that are children.</p>

  <p>The <dfn title="dom-table-rows"><code>rows</code></dfn> attribute
  must return an <code>HTMLCollection</code> rooted at the
  <code>table</code> node, whose filter matches only <code>tr</code>
  elements that are either children of the <code>table</code> element,
  or children of <code>thead</code>, <code>tbody</code>, or
  <code>tfoot</code> elements that are themselves children of the
  <code>table</code> element. The elements in the collection must be
  ordered such that those elements whose parent is a
  <code>thead</code> are included first, in tree order, followed by
  those elements whose parent is either a <code>table</code> or
  <code>tbody</code> element, again in tree order, followed finally by
  those elements whose parent is a <code>tfoot</code> element, still
  in tree order.</p>

  <p>The behaviour of the <dfn
  title="dom-table-insertRow"><code>insertRow(<var
  title="">index</var>)</code></dfn> method depends on the state of
  the table. When it is called, the method must act as required by the
  first item in the following list of conditions that describes the
  state of the table and the <var title="">index</var> argument:</p>

  <dl class="switch">

   <dt>If <var title="">index</var> is less than -1 or greater than
   the number of elements in <code title="dom-table-rows">rows</code>
   collection:</dt>

   <dd>The method must raise an <code>INDEX_SIZE_ERR</code>
   exception.</dd>

   <dt>If the <code title="dom-table-rows">rows</code> collection has
   zero elements in it, and the <code>table</code> has no
   <code>tbody</code> elements in it:</dt>

   <dd>The method must create a <code>tbody</code> element, then
   create a <code>tr</code> element, then append the <code>tr</code>
   element to the <code>tbody</code> element, then append the
   <code>tbody</code> element to the <code>table</code> element, and
   finally return the <code>tr</code> element.</dd>

   <dt>If the <code title="dom-table-rows">rows</code> collection has
   zero elements in it:</dt>

   <dd>The method must create a <code>tr</code> element, append it to
   the last <code>tbody</code> element in the table, and return the
   <code>tr</code> element.</dd>

   <dt>If <var title="">index</var> is equal to -1 or equal to the
   number of items in <code title="dom-table-rows">rows</code>
   collection:</dt>

   <dd>The method must create a <code>tr</code> element, and append it
   to the parent of the last <code>tr</code> element in the <code
   title="dom-table-rows">rows</code> collection. Then, the newly
   created <code>tr</code> element must be returned.</dd>

   <dt>Otherwise:</dt>

   <dd>The method must create a <code>tr</code> element, insert it
   immediately before the <var title="">index</var>th <code>tr</code>
   element in the <code title="dom-table-rows">rows</code> collection,
   in the same parent, and finally must return the newly created
   <code>tr</code> element.</dd>

  </dl>

  <p>The <dfn title="dom-table-deleteRow"><code>deleteRow(<var
  title="">index</var>)</code></dfn> method must remove the <var
  title="">index</var>th element in the <code
  title="dom-table-rows">rows</code> collection from its parent. If
  <var title="">index</var> is less than zero or greater than or equal
  to the number of elements in the <code
  title="dom-table-rows">rows</code> collection, the method must
  instead raise an <code>INDEX_SIZE_ERR</code> exception.</p>


  <h4>The <dfn><code>caption</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the first element child of a <code>table</code> element.</dd>
   <dt>Content model:</dt>
   <dd><span title="significant inline content">Significant</span> <span>strictly inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>caption</code> element represents the title of the
  <code>table</code> that is its parent, if it has a parent and that
  is a <code>table</code> element.</p>

  <p>The <code>caption</code> element takes part in the <span>table
  model</span>.</p>


  <h4>The <dfn><code>colgroup</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>table</code> element, after any
   <code>caption</code> elements and before any <code>thead</code>,
   <code>tbody</code>, <code>tfoot</code>, and <code>tr</code>
   elements.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>col</code> elements.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-colgroup-span">span</code>, but only if the element contains no <code>col</code> elements</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLTableColElement</dfn> : <span>HTMLElement</span> {
           attribute unsigned long <span title="dom-colgroup-span">span</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>colgroup</code> element represents a <span
  title="concept-column-group">group</span> of one or more <span
  title="concept-column">columns</span> in the <code>table</code> that
  is its parent, if it has a parent and that is a <code>table</code>
  element.</p>

  <p>If the <code>colgroup</code> element contains no <code>col</code>
  elements, then the element may have a <dfn
  title="attr-colgroup-span"><code>span</code></dfn> content attribute
  specified, whose value must be a <span>valid non-negative
  integer</span> greater than zero. Its default value, which must be
  used if <span title="rules for parsing non-negative
  integers">parsing the attribute as a non-negative integer</span>
  returns either an error or zero, is 1.</p>

  <p>The <code>colgroup</code> element and its <code
  title="attr-colgroup-span">span</code> attribute take part in the
  <span>table model</span>.</p>

  <p>The <dfn title="dom-colgroup-span"><code>span</code></dfn> DOM
  attribute must <span>reflect</span> the content attribute of the
  same name, with the exception that on setting, if the new value is
  0, then an <code>INDEX_SIZE_ERR</code> exception must be raised.</p>


  <h4>The <dfn><code>col</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>colgroup</code> element that doesn't have
   a <code title="attr-col-span">span</code> attribute.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-col-span">span</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
    <p><code>HTMLTableColElement</code>, same as for
    <code>colgroup</code> elements. This interface defines one member,
    <code title="dom-col-span">span</code>.</p>
   </dd>
  </dl>

  <p>If a <code>col</code> element has a parent and that is a
  <code>colgroup</code> element that itself has a parent that is a
  <code>table</code> element, then the <code>col</code> element
  represents one or more <span title="concept-column">columns</span>
  in the <span title="concept-column-group">column group</span>
  represented by that <code>colgroup</code>.</p>

  <p>The element may have a <dfn
  title="attr-col-span"><code>span</code></dfn> content attribute
  specified, whose value must be a <span>valid non-negative
  integer</span> greater than zero. Its default value, which must be
  used if <span title="rules for parsing non-negative
  integers">parsing the attribute as a non-negative integer</span>
  returns either an error or zero, is 1.</p>

  <p>The <code>col</code> element and its <code
  title="attr-col-span">span</code> attribute take part in the
  <span>table model</span>.</p>

  <p>The <dfn title="dom-col-span"><code>span</code></dfn> DOM
  attribute must <span>reflect</span> the content attribute of the
  same name, with the exception that on setting, if the new value is
  0, then an <code>INDEX_SIZE_ERR</code> exception must be raised.</p>


  <h4>The <dfn><code>tbody</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>table</code> element, after any
   <code>caption</code>, <code>colgroup</code>, and
   <code>thead</code> elements, but only if there are no
   <code>tr</code> elements that are children of the
   <code>table</code> element.</dd>
   <dt>Content model:</dt>
   <dd>One or more <code>tr</code> elements</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
    <pre class="idl">interface <dfn>HTMLTableSectionElement</dfn> : <span>HTMLElement</span> {
  readonly attribute <span>HTMLCollection</span> <span title="dom-tbody-rows">rows</span>;
  <span>HTMLElement</span> <span title="dom-tbody-insertRow">insertRow</span>(in long index);
  void <span title="dom-tbody-deleteRow">deleteRow</span>(in long index);
};</pre>
    <p>The <code>HTMLTableSectionElement</code> interface is also
    used for <code>thead</code> and <code>tfoot</code> elements.</p>
   </dd>
  </dl>

  <p>The <code>tbody</code> element represents a <span
  title="concept-row-group">block</span> of <span
  title="concept-row">rows</span> that consist of a body of data for
  the parent <code>table</code> element, if the <code>tbody</code>
  element has a parent and it is a <code>table</code>.</p>

  <p>The <code>tbody</code> element takes part in the <span>table
  model</span>.</p>

  <p>The <dfn title="dom-tbody-rows"><code>rows</code></dfn> attribute
  must return an <code>HTMLCollection</code> rooted at the element,
  whose filter matches only <code>tr</code> elements that are children
  of the element.</p>

  <p>The <dfn title="dom-tbody-insertRow"><code>insertRow(<var
  title="">index</var>)</code></dfn> method must, when invoked on an
  element <var title="">table section</var>, act as follows:</p>

  <p>If <var title="">index</var> is less than -1 or greater than the
  number of elements in the <code title="dom-tbody-rows">rows</code>
  collection, the method must raise an <code>INDEX_SIZE_ERR</code>
  exception.</p>

  <p>If <var title="">index</var> is equal to -1 or equal to the
  number of items in the <code title="dom-tbody-rows">rows</code>
  collection, the method must create a <code>tr</code> element, append
  it to the element <var title="">table section</var>, and return the
  newly created <code>tr</code> element.</p>

  <p>Otherwise, the method must create a <code>tr</code> element,
  insert it as a child of the <var title="">table section</var>
  element, immediately before the <var title="">index</var>th
  <code>tr</code> element in the <code
  title="dom-tbody-rows">rows</code> collection, and finally must
  return the newly created <code>tr</code> element.</p>

  <p>The <dfn title="dom-tbody-deleteRow"><code>deleteRow(<var
  title="">index</var>)</code></dfn> method must remove the <var
  title="">index</var>th element in the <code
  title="dom-tbody-rows">rows</code> collection from its parent. If
  <var title="">index</var> is less than zero or greater than or equal
  to the number of elements in the <code
  title="dom-tbody-rows">rows</code> collection, the method must
  instead raise an <code>INDEX_SIZE_ERR</code> exception.</p>



  <h4>The <dfn><code>thead</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>table</code> element, after any
   <code>caption</code>, and <code>colgroup</code>
   elements and before any <code>tbody</code>, <code>tfoot</code>, and
   <code>tr</code> elements, but only if there are no other
   <code>thead</code> elements that are children of the
   <code>table</code> element.</dd>
   <dt>Content model:</dt>
   <dd>One or more <code>tr</code> elements</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd><code>HTMLTableSectionElement</code>, as defined for
   <code>tbody</code> elements.</dd>
  </dl>

  <p>The <code>thead</code> element represents the <span
  title="concept-row-group">block</span> of <span
  title="concept-row">rows</span> that consist of the column labels
  (headers) for the parent <code>table</code> element, if the
  <code>thead</code> element has a parent and it is a
  <code>table</code>.</p>

  <p>The <code>thead</code> element takes part in the <span>table
  model</span>.</p>


  <h4>The <dfn><code>tfoot</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>table</code> element, after any
   <code>caption</code>, <code>colgroup</code>, and <code>thead</code>
   elements and before any <code>tbody</code> and <code>tr</code>
   elements, but only if there are no other <code>tfoot</code>
   elements that are children of the <code>table</code> element.</dd>
   <dd>As a child of a <code>table</code> element, after any
   <code>caption</code>, <code>colgroup</code>, <code>thead</code>,
   <code>tbody</code>, and <code>tr</code> elements, but only if there
   are no other <code>tfoot</code> elements that are children of the
   <code>table</code> element.</dd>
   <dt>Content model:</dt>
   <dd>One or more <code>tr</code> elements</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd><code>HTMLTableSectionElement</code>, as defined for
   <code>tbody</code> elements.</dd>
  </dl>

  <p>The <code>tfoot</code> element represents the <span
  title="concept-row-group">block</span> of <span
  title="concept-row">rows</span> that consist of the column summaries
  (footers) for the parent <code>table</code> element, if the
  <code>tfoot</code> element has a parent and it is a
  <code>table</code>.</p>

  <p>The <code>tfoot</code> element takes part in the <span>table
  model</span>.</p>


  <h4>The <dfn><code>tr</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>thead</code> element.</dd>
   <dd>As a child of a <code>tbody</code> element.</dd>
   <dd>As a child of a <code>tfoot</code> element.</dd>
   <dd>As a child of a <code>table</code> element, after any
   <code>caption</code>, <code>colgroup</code>, and <code>thead</code>
   elements, but only if there are no <code>tbody</code> elements that
   are children of the <code>table</code> element.</dd>
   <dt>Content model:</dt>
   <dd>One or more <code>td</code> or <code>th</code> elements</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
    <pre class="idl">interface <dfn>HTMLTableRowElement</dfn> : <span>HTMLElement</span> {
  readonly attribute long <span title="dom-tr-rowIndex">rowIndex</span>;
  readonly attribute long <span title="dom-tr-sectionRowIndex">sectionRowIndex</span>;
  readonly attribute <span>HTMLCollection</span> <span title="dom-tr-cells">cells</span>;
  <span>HTMLElement</span> <span title="dom-tr-insertCell">insertCell</span>(in long index);
  void <span>deleteCell</span>(in long index);
};</pre>
   </dd>
  </dl>

  <p>The <code>tr</code> element represents a <span
  title="concept-row">row</span> of <span
  title="concept-cell">cells</span> in a <span
  title="concept-table">table</span>.</p>

  <p>The <code>tr</code> element takes part in the <span>table
  model</span>.</p>

  <p>The <dfn title="dom-tr-rowIndex"><code>rowIndex</code></dfn>
  element must, if the element has a parent <code>table</code>
  element, or a parent <code>tbody</code>, <code>thead</code>, or
  <code>tfoot</code> element and a <em>grandparent</em>
  <code>table</code> element, return the index of the <code>tr</code>
  element in that <code>table</code> element's <code
  title="dom-table-rows">rows</code> collection. If there is no such
  <code>table</code> element, then the attribute must return 0.</p>

  <p>The <dfn
  title="dom-tr-sectionRowIndex"><code>rowIndex</code></dfn> DOM
  attribute must, if the element has a parent <code>table</code>,
  <code>tbody</code>, <code>thead</code>, or <code>tfoot</code>
  element, return the index of the <code>tr</code> element in the
  parent element's <code title="">rows</code> collection (for tables,
  that's the <code title="dom-table-rows">rows</code> collection; for
  table sections, that's the <code title="dom-tbody-rows">rows</code>
  collection). If there is no such parent element, then the attribute
  must return 0.</p>

  <p>The <dfn title="dom-tr-cells"><code>cells</code></dfn> attribute
  must return an <code>HTMLCollection</code> rooted at the
  <code>tr</code> element, whose filter matches only <code>td</code>
  and <code>th</code> elements that are children of the
  <code>tr</code> element.</p>

  <p>The <dfn title="dom-tr-insertCell"><code>insertCell(<var
  title="">index</var>)</code></dfn> method must act as follows:</p>

  <p>If <var title="">index</var> is less than -1 or greater than the
  number of elements in the <code title="dom-tr-cells">cells</code>
  collection, the method must raise an <code>INDEX_SIZE_ERR</code>
  exception.</p>

  <p>If <var title="">index</var> is equal to -1 or equal to the
  number of items in <code title="dom-tr-cells">cells</code>
  collection, the method must create a <code>td</code> element, append
  it to the <code>tr</code> element, and return the newly created
  <code>td</code> element.</p>

  <p>Otherwise, the method must create a <code>td</code> element,
  insert it as a child of the <code>tr</code> element, immediately
  before the <var title="">index</var>th <code>td</code> or
  <code>th</code> element in the <code
  title="dom-tr-cells">cells</code> collection, and finally must
  return the newly created <code>td</code> element.</p>

  <p>The <dfn title="dom-tr-deleteCell"><code>deleteCell(<var
  title="">index</var>)</code></dfn> method must remove the <var
  title="">index</var>th element in the <code
  title="dom-tr-cells">cells</code> collection from its parent. If
  <var title="">index</var> is less than zero or greater than or equal
  to the number of elements in the <code
  title="dom-tr-cells">cells</code> collection, the method must
  instead raise an <code>INDEX_SIZE_ERR</code> exception.</p>


  <h4>The <dfn><code>td</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>tr</code> element.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-td-colspan">colspan</code></dd>
   <dd><code title="attr-td-rowspan">rowspan</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
    <pre class="idl">interface <dfn>HTMLTableCellElement</dfn> : <span>HTMLElement</span> {
           attribute long <span title="dom-td-colSpan">colSpan</span>;
           attribute long <span title="dom-td-rowSpan">rowSpan</span>;
  readonly attribute long <span title="dom-td-cellIndex">cellIndex</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>td</code> element represents a data <span
  title="concept-cell">cell</span> in a table.</p>

  <p>The <code>td</code> element may have a <dfn
  title="attr-td-colspan"><code>colspan</code></dfn> content attribute
  specified, whose value must be a <span>valid non-negative
  integer</span> greater than zero. Its default value, which must be
  used if <span title="rules for parsing non-negative
  integers">parsing the attribute as a non-negative integer</span>
  returns either an error or zero, is 1.</p>

  <p>The <code>td</code> element may also have a <dfn
  title="attr-td-rowspan"><code>rowspan</code></dfn> content attribute
  specified, whose value must be a <span>valid non-negative
  integer</span>. Its default value, which must be used if <span
  title="rules for parsing non-negative integers">parsing the
  attribute as a non-negative integer</span> returns an error, is also
  1.</p>

  <p>The <code>td</code> element and its <code
  title="attr-td-colspan">colspan</code> and <code
  title="attr-td-rowspan">rowspan</code> attributes take part in the
  <span>table model</span>.</p>

  <p>The <dfn title="dom-td-colspan"><code>colspan</code></dfn> DOM
  attribute must <span>reflect</span> the content attribute of the
  same name, with the exception that on setting, if the new value is
  0, then an <code>INDEX_SIZE_ERR</code> exception must be raised.</p>

  <p>The <dfn title="dom-td-rowspan"><code>rowspan</code></dfn> DOM
  attribute must <span>reflect</span> the content attribute of the
  same name.</p>

  <p>The <dfn title="dom-td-cellIndex"><code>cellIndex</code></dfn>
  DOM attribute must, if the element has a parent <code>tr</code>
  element, return the index of the cell's element in the parent
  element's <code title="dom-tr-cells">cells</code> collection. If
  there is no such parent element, then the attribute must return
  0.</p>


  <h4>The <dfn><code>th</code></dfn> element</h4>

  <!-- element has no special category -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As a child of a <code>tr</code> element.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-th-colspan">colspan</code></dd>
   <dd><code title="attr-th-rowspan">rowspan</code></dd>
   <dd><code title="attr-th-scope">scope</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
    <pre class="idl">interface <dfn>HTMLTableHeaderCellElement</dfn> : <span>HTMLTableCellElement</span> {
           attribute DOMString <span title="dom-th-scope">scope</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>th</code> element represents a header <span
  title="concept-cell">cell</span> in a table.</p>

  <p>The <code>th</code> element may have a <dfn
  title="attr-th-colspan"><code>colspan</code></dfn> content attribute
  specified, whose value must be a <span>valid non-negative
  integer</span> greater than zero. Its default value, which must be
  used if <span title="rules for parsing non-negative
  integers">parsing the attribute as a non-negative integer</span>
  returns either an error or zero, is 1.</p>

  <p>The <code>th</code> element may also have a <dfn
  title="attr-th-rowspan"><code>rowspan</code></dfn> content attribute
  specified, whose value must be a <span>valid non-negative
  integer</span>. Its default value, which must be used if <span
  title="rules for parsing non-negative integers">parsing the
  attribute as a non-negative integer</span> returns an error, is also
  1.</p>

  <p>The <code>th</code> element may have a <dfn
  title="attr-th-scope"><code>scope</code></dfn> content attribute
  specified. The <code title="attr-th-scope">scope</code> attribute is
  an <span>enumerated attribute</span> with five states, four of which
  have explicit keywords:</p>

  <dl>

   <dt>The <dfn title="attr-th-scope-row"><code>row</code></dfn>
   keyword, which maps to the <em>row</em> state</dt>

   <dd>The <em>row</em> state means the header cell applies to all the
   remaining cells in the row.</dd>

   <dt>The <dfn title="attr-th-scope-col"><code>col</code></dfn>
   keyword, which maps to the <em>column</em> state</dt>

   <dd>The <em>column</em> state means the header cell applies to all
   the remaining cells in the column.</dd>

   <dt>The <dfn
   title="attr-th-scope-rowgroup"><code>rowgroup</code></dfn> keyword,
   which maps to the <em>row group</em> state</dt>

   <dd>The <em>row group</em> state means the header cell applies to
   all the remaining cells in the row group.</dd>

   <dt>The <dfn
   title="attr-th-scope-colgroup"><code>colgroup</code></dfn> keyword,
   which maps to the <em>column group</em> state</dt>

   <dd>The <em>column group</em> state means the header cell applies
   to all the remaining cells in the column group.</dd>

   <dt>The <em>auto</em> state</dt>

   <dd>The <em>auto</em> state makes the header cell apply to a set of
   cells selected based on context.</dd>

  </dl>

  <p>The <code title="attr-th-scope">scope</code> attribute's
  <em>missing value default</em> is the <em>auto</em> state.</p>

  <p>The exact effect of these values is described in detail in the
  <span>algorithm for assigning header cells to data cells</span>,
  which user agents must apply to determine the relationships between
  data cells and header cells.</p>

  <p>The <code>th</code> element and its <code
  title="attr-th-colspan">colspan</code>, <code
  title="attr-th-rowspan">rowspan</code>, and <code
  title="attr-th-scope">scope</code> attributes take part in the
  <span>table model</span>.</p>

  <p>The <dfn title="dom-th-scope"><code>scope</code></dfn> DOM
  attribute must <span>reflect</span> the content attribute of the
  same name.</p>

  <p>The <code>HTMLTableHeaderCellElement</code> interface inherits
  from the <code>HTMLTableCellElement</code> interface and therefore
  also has the DOM attributes defined above in the <code>td</code>
  section.</p>


  <h4>Processing model</h4>

  <p>The various table elements and their content attributes together
  define the <dfn>table model</dfn>.</p>

  <p>A <dfn title="concept-table">table</dfn> consists of cells
  aligned on a two-dimensional grid of <dfn
  title="concept-slots">slots</dfn> with coordinates (<var
  title="">x</var>, <var title="">y</var>). The grid is finite, and is
  either empty or has one or more slots. If the grid has one or more
  slots, then the <var title="">x</var> coordinates are always in the
  range <span>1&nbsp;&le;&nbsp;<var
  title="">x</var>&nbsp;&le;&nbsp;<var title="">x<sub
  title="">max</sub></var></span>, and the <var title="">y</var>
  coordinates are always in the range <span>1&nbsp;&le;&nbsp;<var
  title="">y</var>&nbsp;&le;&nbsp;<var title="">y<sub
  title="">max</sub></var></span>. If one or both of <var
  title="">x<sub title="">max</sub></var> and <var title="">y<sub
  title="">max</sub></var> are zero, then the table is empty (has no
  slots). Tables correspond to <code>table</code> elements.</p>

  <p>A <dfn title="concept-cell">cell</dfn> is a set of slots anchored
  at a slot (<var title="">cell<sub title="">x</sub></var>, <var
  title="">cell<sub title="">y</sub></var>), and with a particular
  <var title="">width</var> and <var title="">height</var> such that
  the cell covers all the slots with coordinates (<var
  title="">x</var>, <var title="">y</var>) where <span><var
  title="">cell<sub title="">x</sub></var>&nbsp;&le;&nbsp;<var
  title="">x</var>&nbsp;&lt;&nbsp;<var title="">cell<sub
  title="">x</sub></var>+<var title="">width</var></span> and
  <span><var title="">cell<sub
  title="">y</sub></var>&nbsp;&le;&nbsp;<var
  title="">y</var>&nbsp;&lt;&nbsp;<var title="">cell<sub
  title="">y</sub></var>+<var title="">height</var></span>. Cell can
  either be <em>data cells</em> or <em>header cells</em>. Data cells
  correspond to <code>td</code> elements, and have zero or more
  associated header cells. Header cells correspond to <code>th</code>
  elements.</p>

  <p>A <dfn title="concept-row">row</dfn> is a complete set of slots
  from <span><var title="">x</var>=1</span> to <span><var
  title="">x</var>=<var title="">x<sub
  title="">max</sub></var></span>, for a particular value of <var
  title="">y</var>. Rows correspond to <code>tr</code> elements.</p>

  <p>A <dfn title="concept-column">column</dfn> is a complete set of
  slots from <span><var title="">y</var>=1</span> to <span><var
  title="">y</var>=<var title="">y<sub
  title="">max</sub></var></span>, for a particular value of <var
  title="">x</var>. Columns can correspond to <code>col</code>
  elements, but in the absense of <code>col</code> elements are
  implied.</p>

  <p>A <dfn title="concept-row-group">row group</dfn> is a set of
  <span title="concept-row">rows</span> anchored at a slot (1, <var
  title="">group<sub title="">y</sub></var>) with a particular <var
  title="">height</var> such that the row group covers all the slots
  with coordinates (<var title="">x</var>, <var title="">y</var>)
  where <span>1&nbsp;&le;&nbsp;<var
  title="">x</var>&nbsp;&lt;&nbsp;<var title="">x<sub
  title="">max</sub></var></span> and <span><var title="">group<sub
  title="">y</sub></var>&nbsp;&le;&nbsp;<var
  title="">y</var>&nbsp;&lt;&nbsp;<var title="">group<sub
  title="">y</sub></var>+<var title="">height</var></span>. Row groups
  correspond to <code>tbody</code>, <code>thead</code>, and
  <code>tfoot</code> elements. Not every row is necessarily in a row
  group.</p>

  <p>A <dfn title="concept-column-group">column group</dfn> is a set
  of <span title="concept-column">columns</span> anchored at a slot
  (<var title="">group<sub title="">x</sub></var>, 1) with a
  particular <var title="">width</var> such that the column group
  covers all the slots with coordinates (<var title="">x</var>, <var
  title="">y</var>) where <span><var title="">group<sub
  title="">x</sub></var>&nbsp;&le;&nbsp;<var
  title="">x</var>&nbsp;&lt;&nbsp;<var title="">group<sub
  title="">x</sub></var>+<var title="">width</var></span> and
  <span>1&nbsp;&le;&nbsp;<var title="">y</var>&nbsp;&lt;&nbsp;<var
  title="">y<sub title="">max</sub></var></span>. Column groups
  correspond to <code>colgroup</code> elements. Not every column is
  necessarily in a column group.</p>

  <p><span title="concept-row-group">Row groups</span> cannot overlap
  each other. Similarly, <span title="concept-column-group">column
  groups</span> cannot overlap each other.</p>

  <p>A <span title="concept-cell">cell</span> cannot cover slots that
  are from two or more <span title="concept-row-group">row
  groups</span>. It is, however, possible for a cell to be in multiple
  <span title="concept-column-group">column groups</span>. All the
  slots that form part of one cell are part of zero or one <span
  title="concept-row-group">row groups</span> and zero or more <span
  title="concept-column-group">column groups</span>.</p>

  <p>In addition to <span title="concept-cell">cells</span>, <span
  title="concept-column">columns</span>, <span
  title="concept-row">rows</span>, <span title="concept-row-group">row
  groups</span>, and <span title="concept-column-group">column
  groups</span>, <span title="concept-table">tables</span> can have a
  <code>caption</code> element associated with them. This gives the
  table a heading, or legend.</p>

  <p>A <dfn>table model error</dfn> is an error with the data
  represented by <code>table</code> elements and their
  descendants. Documents must not have table model errors.</p>


  <h5>Forming a table</h5>

  <p>To determine which elements correspond to which slots in a <span
  title="concept-table">table</span> associated with a
  <code>table</code> element, to determine the dimensions of the table
  (<var title="">x<sub title="">max</sub></var> and <var
  title="">y<sub title="">max</sub></var>), and to determine if there
  are any <span title="table model error">table model errors</span>,
  user agents must use the following algorithm:</p>

  <ol>

   <li>
    <p>Let <var title="">x<sub title="">max</sub></var> be zero.</p>
   </li>

   <li>
    <p>Let <var title="">y<sub title="">max</sub></var> be zero.</p>
   </li>

   <li>
    <p>Let <var title="">the table</var> be the <span
    title="concept-table">table</span> represented by the
    <code>table</code> element. The <var title="">x<sub
    title="">max</sub></var> and <var title="">y<sub
    title="">max</sub></var> variables give <var title="">the
    table</var>'s extent. <var title="">The table</var> is initially
    empty.</p>
   </li>

   <li>

    <p>If the <code>table</code> element has no table children, then
    return <var title="">the table</var> (which will be empty), and
    abort these steps.</p>

   </li>

   <li>

    <p>Let the <var title="">current element</var> be the first
    element child of the <code>table</code> element.</p>

    <p>If a step in this algorithm ever requires the <var
    title="">current element</var> to be advanced to the next child of
    the <code>table</code> when there is no such next child, then the
    algorithm must be aborted at that point and the algorithm must
    return <var title="">the table</var>.</p>

   </li>

   <li>

    <p>While the <var title="">current element</var> is not one of the
    following elements, advance the <var title="">current
    element</var> to the next child of the <code>table</code>:</p>

    <ul class="brief">
     <li><code>caption</code></li>
     <li><code>colgroup</code></li>
     <li><code>thead</code></li>
     <li><code>tbody</code></li>
     <li><code>tfoot</code></li>
     <li><code>tr</code></li>
    </ul>

   </li>

   <li>

    <p>If the <var title="">current element</var> is a
    <code>caption</code>, then that is the <code>caption</code>
    element associated with <var title="">the table</var>. Otherwise,
    it has no associated <code>caption</code> element.</p>

   </li>

   <li>

    <p>If the <var title="">current element</var> is a
    <code>caption</code>, then while the <var title="">current
    element</var> is not one of the following elements, advance the
    <var title="">current element</var> to the next child of the
    <code>table</code>:</p>

    <ul class="brief">
     <li><code>colgroup</code></li>
     <li><code>thead</code></li>
     <li><code>tbody</code></li>
     <li><code>tfoot</code></li>
     <li><code>tr</code></li>
    </ul>

    <p>(Otherwise, the <var title="">current element</var> will
    already be one of those elements.)</p>

   </li>

   <li>

    <p>If the <var title="">current element</var> is a
    <code>colgroup</code>, follow these substeps:</p>

    <ol>

     <li>

      <p>Let <var title="">next column</var> be 1.</p>

     </li>

     <li>

      <p><em>Column groups.</em> Process the <var title="">current
      element</var> according to the appropriate one of the following
      two cases:</p>

      <dl class="switch">

       <dt>If the <var title="">current element</var> has any
       <code>col</code> element children</dt>

       <dd>

        <p>Follow these steps:</p>

        <ol>

         <li>

          <p>Let <var title="">x<sub title="">start</sub></var> have
          the value <span><var title="">x<sub
          title="">max</sub></var>+1</span>.</p>

         </li>

         <li>

          <p>Let the <var title="">current column</var> be the first
          <code>col</code> element child of the <code>colgroup</code>
          element.</p>

         </li>

         <li>

          <p><em>Columns.</em> If the <var title="">current
          column</var> <code>col</code> element has a <code
          title="attr-col-span">span</code> attribute, then parse its
          value using the <span>rules for parsing non-negative
          integers</span>.</p>

          <p>If the result of parsing the value is not an error or
          zero, then let <var title="">span</var> be that value.</p>

          <p>Otherwise, if the <code>col</code> element has no <code
          title="attr-col-span">span</code> attribute, or if trying to
          parse the attribute's value resulted in an error, then let
          <var title="">span</var> be 1.</p>

         </li>

         <li>

          <p>Increase <var title="">x<sub title="">max</sub></var> by
          <var title="">span</var>.</p>

         </li>

         <li>

          <p>Let the last <var title="">span</var> <span
          title="concept-column">columns</span> in <var title="">the
          table</var> correspond to the <var title="">current
          column</var> <code>col</code> element.</p>

         </li>

         <li>

          <p>If <var title="">current column</var> is not the last
          <code>col</code> element child of the <code>colgroup</code>
          element, then let the <var title="">current column</var> be
          the next <code>col</code> element child of the
          <code>colgroup</code> element, and return to the third step
          of this innermost group of steps (columns).</p>

         </li>

         <li>

          <p>Let all the last <span
          title="concept-column">columns</span> in <var title="">the
          table</var> from <span>x=<var title="">x<sub
          title="">start</sub></var></span> to <span>x=<var
          title="">x<sub title="">max</sub></var></span> form a new
          <span title="concept-column-group">column group</span>,
          anchored at the slot (<var title="">x<sub
          title="">start</sub></var>, 1), with width <var
          title="">x<sub title="">max</sub></var>-<var title="">x<sub
          title="">start</sub></var>-1, corresponding to the
          <code>colgroup</code> element.</p>

         </li>

        </ol>

       </dd>


       <dt>If the <var title="">current element</var> has no
       <code>col</code> element children</dt>

       <dd>

        <ol>

         <li>

          <p>If the <code>colgroup</code> element has a <code
          title="attr-colgroup-span">span</code> attribute, then parse
          its value using the <span>rules for parsing non-negative
          integers</span>.</p>

          <p>If the result of parsing the value is not an error or
          zero, then let <var title="">span</var> be that value.</p>

          <p>Otherwise, if the <code>colgroup</code> element has no
          <code title="attr-col-span">span</code> attribute, or if
          trying to parse the attribute's value resulted in an error,
          then let <var title="">span</var> be 1.</p>

         </li>

         <li>

          <p>Increase <var title="">x<sub title="">max</sub></var> by
          <var title="">span</var>.</p>

         </li>

         <li>

          <p>Let the last <var title="">span</var> <span
          title="concept-column">columns</span> in <var title="">the
          table</var> form a new <span
          title="concept-column-group">column group</span>, anchored
          at the slot (<var title="">x<sub
          title="">max</sub></var>-<var title="">span</var>+1, 1),
          with width <var title="">span</var>, corresponding to the
          <code>colgroup</code> element.</p>

         </li>

        </ol>

       </dd>

      </dl>

     </li>

     <li>

      <p>Advance the <var title="">current element</var> to the next
      child of the <code>table</code>.</p>

     </li>

     <li>

      <p>While the <var title="">current element</var> is not one of
      the following elements, advance the <var title="">current
      element</var> to the next child of the <code>table</code>:</p>

      <ul class="brief">
       <li><code>colgroup</code></li>
       <li><code>thead</code></li>
       <li><code>tbody</code></li>
       <li><code>tfoot</code></li>
       <li><code>tr</code></li>
      </ul>

     </li>

     <li>

      <p>If the <var title="">current element</var> is a
      <code>colgroup</code> element, jump to step 2 in these substeps
      (column groups).</p>

     </li>

    </ol>

   </li>

   <li>

    <p>Let <var title="">y<sub title="">current</sub></var> be
    zero. When the algorithm is aborted, if <var title="">y<sub
    title="">current</sub></var> does not equal <var title="">y<sub
    title="">max</sub></var>, then that is a <span>table model
    error</span>.</p>

   </li>

   <li>

    <p>Let the <var title="">list of downward-growing cells</var> be
    an empty list.</p>

   </li>

   <li>

    <p><em>Rows.</em> While the <var title="">current element</var> is
    not one of the following elements, advance the <var
    title="">current element</var> to the next child of the
    <code>table</code>:</p>

    <ul class="brief">
     <li><code>thead</code></li>
     <li><code>tbody</code></li>
     <li><code>tfoot</code></li>
     <li><code>tr</code></li>
    </ul>

   </li>

   <li>

    <p>If the <var title="">current element</var> is a
    <code>tr</code>, then run the <span>algorithm for processing
    rows</span> (defined below), then return to the previous step
    (rows).</p>

   </li>

   <li>

    <p>Otherwise, run the <span>algorithm for ending a row
    group</span>.</p>

   </li>

   <li>

    <p>Let <var title="">y<sub title="">start</sub></var> have the
    value <span><var title="">y<sub
    title="">max</sub></var>+1</span>.</p>

   </li>

   <li>

    <p>For each <code>tr</code> element that is a child of the <var
    title="">current element</var>, in tree order, run the
    <span>algorithm for processing rows</span> (defined below).</p>

   </li>

   <li>

    <!-- if we added any rows, make them part of a row group -->
    <p>If <span><var title="">y<sub
    title="">max</sub></var>&nbsp;&ge;&nbsp;<var title="">y<sub
    title="">start</sub></var></span>, then let all the last <span
    title="concept-row">rows</span> in <var title="">the table</var>
    from <span>y=<var title="">y<sub title="">start</sub></var></span>
    to <span>y=<var title="">y<sub title="">max</sub></var></span>
    form a new <span title="concept-row-group">row group</span>,
    anchored at the slot with coordinate (1, <var title="">y<sub
    title="">start</sub></var>), with height <var title="">y<sub
    title="">max</sub></var>-<var title="">y<sub
    title="">start</sub></var>+1, corresponding to the <var
    title="">current element</var>.</p>

   </li>

   <li>

    <p>Run the <span>algorithm for ending a row group</span>
    again.</p>

   </li>

   <li>

    <p>Return to step 12 (rows).</p>

   </li>

  </ol>

  <p>The <dfn>algorithm for ending a row group</dfn>, which is invoked
  by the set of steps above when starting and eding a block of rows,
  is:</p>

  <ol>

   <li>

    <p>If <var title="">y<sub title="">current</sub></var> is less
    than <var title="">y<sub title="">max</sub></var>, then this is a
    <span>table model error</span>.</p>

   </li>

   <li>

    <p>While <var title="">y<sub title="">current</sub></var> is less
    than <var title="">y<sub title="">max</sub></var>, follow these
    steps:</p>

    <ol>

     <li>

      <p>Increase <var title="">y<sub title="">current</sub></var> by
      1.</p>

     </li>

     <li>

      <p>Run the <span>algorithm for growing downward-growing
      cells</span>.</p>

     </li>

    </ol>

   </li>

   <li>

    <p>Empty the <var title="">list of downward-growing
    cells</var>.</p>

   </li>

  </ol>

  <p>The <dfn>algorithm for processing rows</dfn>, which is invoked by
  the set of steps above for processing <code>tr</code> elements,
  is:</p>

  <ol>

   <li>

    <p>Increase <var title="">y<sub title="">current</sub></var> by
    1.</p>
    <!-- ymax is increased below once we know cell dimensions -->

   </li>

   <li>

    <p>Run the <span>algorithm for growing downward-growing
    cells</span>.</p>

   </li>

   <li>

    <p>Let <var title="">x<sub title="">current</sub></var> be 1.</p>
    <!-- xmax is increased below once we know cell dimensions -->

   </li>

   <li>

    <p>If the <code>tr</code> element being processed contains no
    <code>td</code> or <code>th</code> elements, then abort this set
    of steps and return to the algorithm above.</p>

   </li>

   <li>

    <p>Let <var title="">current cell</var> be the first
    <code>td</code> or <code>th</code> element in the <code>tr</code>
    element being processed.</p>

   </li>

   <li>

    <p><em>Cells.</em> While <var title="">x<sub
    title="">current</sub></var> is less than or equal to <var
    title="">x<sub title="">max</sub></var> and the slot with
    coordinate (<var title="">x<sub title="">current</sub></var>, <var
    title="">y<sub title="">current</sub></var>) already has a cell
    assigned to it, increase <var title="">x<sub
    title="">current</sub></var> by 1.</p>

   </li>

   <li>

    <p>If <var title="">x<sub title="">current</sub></var> is greater
    than <var title="">x<sub title="">max</sub></var>, increase <var
    title="">x<sub title="">max</sub></var> by 1 (which will make them
    equal).</p>

   </li>

   <li>

    <p>If the <var title="">current cell</var> has a <code
    title="">colspan</code> attribute, then <span title="rules for
    parsing non-negative integer values">parse that attribute's
    value</span>, and let <var title="">colspan</var> be the result.</p>

    <p>If parsing that value failed, or returned zero, or if the
    attribute is absent, then let <var title="">colspan</var> be 1,
    instead.</p>

   </li>

   <li>

    <p>If the <var title="">current cell</var> has a <code
    title="">rowspan</code> attribute, then <span title="rules for
    parsing non-negative integer values">parse that attribute's
    value</span>, and let <var title="">rowspan</var> be the result.</p>

    <p>If parsing that value failed or if the attribute is absent,
    then let <var title="">rowspan</var> be 1, instead.</p>

   </li>

   <li>

    <p>If <var title="">rowspan</var> is zero, then let <var
    title="">cell grows downward</var> be true, and set <var
    title="">rowspan</var> to 1. Otherwise, let <var title="">cell
    grows downward</var> be false.</p>

   </li>

   <li>

    <p>If <span><var title="">x<sub
    title="">max</sub></var>&nbsp;&lt;&nbsp;<var title="">x<sub
    title="">current</sub></var>+<var title="">colspan</var>-1</span>,
    then let <var title="">x<sub title="">max</sub></var> be <var
    title="">x<sub title="">current</sub></var>+<var
    title="">colspan</var>-1.</p>

   </li>

   <li>

    <p>If <span><var title="">y<sub
    title="">max</sub></var>&nbsp;&lt;&nbsp;<var title="">y<sub
    title="">current</sub></var>+<var title="">rowspan</var>-1</span>,
    then let <var title="">y<sub title="">max</sub></var> be <var
    title="">y<sub title="">current</sub></var>+<var
    title="">rowspan</var>-1.</p>

   </li>

   <li>

    <p>Let the slots with coordinates (<var title="">x</var>, <var
    title="">y</var>) such that <span><var title="">x<sub
    title="">current</sub></var>&nbsp;&le;&nbsp;<var
    title="">x</var>&nbsp;&lt;&nbsp;<var title="">x<sub
    title="">current</sub></var>+<var title="">colspan</var></span>
    and <span><var title="">y<sub
    title="">current</sub></var>&nbsp;&le;&nbsp;<var
    title="">y</var>&nbsp;&lt;&nbsp;<var title="">y<sub
    title="">current</sub></var>+<var title="">rowspan</var></span> be
    covered by a new <span title="concept-cell">cell</span> <var
    title="">c</var>, anchored at (<var title="">x<sub
    title="">current</sub></var>, <var title="">y<sub
    title="">current</sub></var>), which has width <var
    title="">colspan</var> and height <var title="">rowspan</var>,
    corresponding to the <var title="">current cell</var> element.</p>

    <p>If the <var title="">current cell</var> element is a
    <code>th</code> element, let this new cell <var title="">c</var>
    be a header cell; otherwise, let it be a data cell. To establish
    what header cells apply to a data cell, use the <span>algorithm
    for assigning header cells to data cells</span> described in the
    next section.</p>

    <p>If any of the slots involved already had a <span
    title="concept-cell">cell</span> covering them, then this is a
    <span>table model error</span>. Those slots now have two cells
    overlapping.</p>

   </li>

   <li>

    <p>If <var title="">cell grows downward</var> is true, then add
    the tuple {<var title="">c</var>, <var title="">x<sub
    title="">current</sub></var>, <var title="">colspan</var>} to the
    <var title="">list of downward-growing cells</var>.</p>

   </li>

   <li>

    <p>Increase <var title="">x<sub title="">current</sub></var> by
    <var title="">colspan</var>.</p>

   </li>

   <li>

    <p>If <var title="">current cell</var> is the last <code>td</code>
    or <code>th</code> element in the <code>tr</code> element being
    processed, then abort this set of steps and return to the
    algorithm above.</p>

   </li>

   <li>

    <p>Let <var title="">current cell</var> be the next
    <code>td</code> or <code>th</code> element in the <code>tr</code>
    element being processed.</p>

   </li>

   <li>

    <p>Return to step 5 (cells).</p>

   </li>

  </ol>

  <p>The <dfn>algorithm for growing downward-growing cells</dfn>, used
  when adding a new row, is as follows:</p>

  <ol>

   <li>

    <p>If the <var title="">list of downward-growing cells</var> is
    empty, do nothing. Abort these steps; return to the step that
    invoked this algorithm.</p>

   </li>

   <li>

    <p>Otherwise, if <var title="">y<sub title="">max</sub></var> is
    less than <var title="">y<sub title="">current</sub></var>, then
    increase <var title="">y<sub title="">max</sub></var> by 1 (this
    will make it equal to <var title="">y<sub
    title="">current</sub></var>).</p>

   </li>

   <li>

    <p>For each {<var title="">cell</var>, <var title="">cell<sub
    title="">x</sub></var>, <var title="">width</var>} tuple in the
    <var title="">list of downward-growing cells</var>, extend the
    <span title="concept-cell">cell</span> <var title="">cell</var> so
    that it also covers the slots with coordinates (<var
    title="">x</var>, <var title="">y<sub
    title="">current</sub></var>), where <span><var title="">cell<sub
    title="">x</sub></var>&nbsp;&le;&nbsp;<var
    title="">x</var>&nbsp;&lt;&nbsp;<var title="">cell<sub
    title="">x</sub></var>+<var title="">width</var>-1</span>.</p>

   </li>

  </ol>

  <p>If, after establishing which elements correspond to which slots,
  there exists a <span title="concept-column">column</span> in the
  <span title="concept-table">table</span> containing only <span
  title="concept-slot">slots</span> that do not have a <span
  title="concept-cell">cell</span> anchored to them, then this is a
  <span>table model error</span>.</p>


  <h5 id="header-and-data-cell-semantics">Forming relationships between data cells and header cells</h5>

  <p>Each data cell can be assigned zero or more header cells. The
  <dfn>algorithm for assigning header cells to data cells</dfn> is as
  follows.</p>

  <p>For each header cell in the table, in <span>tree
  order</span>:</p>

  <ol>

   <li>

    <p>Let (<var title="">header<sub title="">x</sub></var>, <var
    title="">header<sub title="">y</sub></var>) be the coordinate of
    the slot to which the header cell is anchored.</p>

   </li>

   <li>

    <p>Examine the <code title="attr-th-scope">scope</code> attribute
    of the <code>th</code> element corresponding to the header cell,
    and, based on its state, apply the appropriate substep:</p>

    <dl class="switch">

     <dt>If it is in the <em title="attr-th-scope-row">row</em> state</dt>

     <dd>

      <p>Assign the header cell to any data cells anchored at slots
      with coordinates (<var title="">data<sub title="">x</sub></var>,
      <var title="">data<sub title="">y</sub></var>) where <span><var
      title="">header<sub title="">x</sub></var>&nbsp;&lt;&nbsp;<var
      title="">data<sub title="">x</sub></var>&nbsp;&le;&nbsp;<var
      title="">x<sub title="">max</sub></var></span> and <span><var
      title="">data<sub title="">y</sub></var>&nbsp;=&nbsp;<var
      title="">header<sub title="">y</sub></var></span>.</p>

     </dd>

     <dt>If it is in the <em title="attr-th-scope-col">column</em> state</dt>

     <dd>

      <p>Assign the header cell to any data cells anchored at slots
      with coordinates (<var title="">data<sub title="">x</sub></var>,
      <var title="">data<sub title="">y</sub></var>) where <span><var
      title="">data<sub title="">x</sub></var>&nbsp;=&nbsp;<var
      title="">header<sub title="">x</sub></var></span> and <span><var
      title="">header<sub title="">y</sub></var>&nbsp;&lt;&nbsp;<var
      title="">data<sub title="">y</sub></var>&nbsp;&le;&nbsp;<var
      title="">y<sub title="">max</sub></var></span>.</p>

     </dd>

     <dt>If it is in the <em title="attr-th-scope-rowgroup">row group</em> state</dt>

     <dd>

      <p>If the header cell is not in a <span
      title="concept-row-group">row group</span>, then don't assign
      the header cell to any data cells.</p>

      <p>Otherwise, let (1, <var title="">group<sub
      title="">y</sub></var>) be the slot at which the row group is
      anchored, let <var title="">height</var> be the number of rows
      in the row group, and assign the header cell to any data cells
      anchored at slots with coordinates (<var title="">data<sub
      title="">x</sub></var>, <var title="">data<sub
      title="">y</sub></var>) where <span><var title="">header<sub
      title="">x</sub></var>&nbsp;&le;&nbsp;<var title="">data<sub
      title="">x</sub></var>&nbsp;&le;&nbsp;<var title="">x<sub
      title="">max</sub></var></span> and <span><var
      title="">header<sub title="">y</sub></var>&nbsp;&le;&nbsp;<var
      title="">data<sub title="">y</sub></var>&nbsp;&lt;&nbsp;<var
      title="">group<sub title="">y</sub></var>+<var
      title="">height</var></span>.</p>

     </dd>

     <dt>If it is in the <em title="attr-th-scope-colgroup">column group</em> state</dt>

     <dd>

      <p>If the header cell is not in a <span
      title="concept-column-group">column group</span>, then don't
      assign the header cell to any data cells.</p>

      <p>Otherwise, let (<var title="">group<sub
      title="">x</sub></var>, 1) be the slot at which the column group
      is anchored, let <var title="">width</var> be the number of
      columns in the column group, and assign the header cell to any
      data cells anchored at slots with coordinates (<var
      title="">data<sub title="">x</sub></var>, <var title="">data<sub
      title="">y</sub></var>) where <span><var title="">header<sub
      title="">x</sub></var>&nbsp;&le;&nbsp;<var title="">data<sub
      title="">x</sub></var>&nbsp;&lt;&nbsp;<var title="">group<sub
      title="">x</sub></var>+<var title="">width</var></span> and
      <span><var title="">header<sub
      title="">y</sub></var>&nbsp;&le;&nbsp;<var title="">data<sub
      title="">y</sub></var>&nbsp;&le;&nbsp;<var title="">y<sub
      title="">max</sub></var></span>.</p>

     </dd>

     <dt>Otherwise, it is in the <em title="">auto</em> state</dt>

     <dd>

      <p>If the header cell is not in the first row of the table, or
      not in the first cell of a row, then don't assign the header
      cell to any data cells.</p>

      <p>Otherwise, if the header cell is in the first row of the
      table, assign the header cell to any data cells anchored at
      slots with coordinates (<var title="">data<sub
      title="">x</sub></var>, <var title="">data<sub
      title="">y</sub></var>) where <span><var title="">data<sub
      title="">x</sub></var>&nbsp;=&nbsp;<var title="">header<sub
      title="">x</sub></var></span> and <span><var title="">header<sub
      title="">y</sub></var>&nbsp;&lt;&nbsp;<var title="">data<sub
      title="">y</sub></var>&nbsp;&le;&nbsp;<var title="">y<sub
      title="">max</sub></var></span>.</p>

      <p>Otherwise, the header cell is in the first column of the
      table; assign the header cell to any data cells anchored at
      slots with coordinates (<var title="">data<sub
      title="">x</sub></var>, <var title="">data<sub
      title="">y</sub></var>) where <span><var title="">header<sub
      title="">x</sub></var>&nbsp;&lt;&nbsp;<var title="">data<sub
      title="">x</sub></var>&nbsp;&le;&nbsp;<var title="">x<sub
      title="">max</sub></var></span> and <span><var title="">data<sub
      title="">y</sub></var>&nbsp;=&nbsp;<var title="">header<sub
      title="">y</sub></var></span>.</p>

     </dd>

    </dl>

   </li>

  </ol>



  <h3 id="forms">Forms</h3>
  <!-- XXXX everything in WF2 -->

  <p class="big-issue">This section will contain definitions of the
  <code>form</code> element and so forth.</p>

  <p class="big-issue">This section will be a rewrite of the HTML4
  Forms and Web Forms 2.0 specifications, with hopefully no normative
  changes.</p>

  <!-- From HTML4: BUTTON FIELDSET FORM INPUT LABEL OPTGROUP OPTION
  SELECT TEXTAREA -->

  <h4>The <code>form</code> element</h4>

  <h4>The <code>fieldset</code> element</h4>

  <h4>The <code>input</code> element</h4>

  <h4>The <code>button</code> element</h4>

  <h4>The <code>label</code> element</h4>

  <h4>The <code>select</code> element</h4>

  <h4>The <code>datalist</code> element</h4>

  <h4>The <code>optgroup</code> element</h4>

  <h4>The <code>option</code> element</h4>

  <h4>The <code>textarea</code> element</h4>

  <h4>The <code>output</code> element</h4>

  <h4>Processing model</h4>

  <p class="big-issue">See <a href="http://www.whatwg.org/specs/web-forms/current-work/#extend-form-controls">WF2</a> for now</p>

  <h5>Form submission</h5>

  <p class="big-issue">See <a href="http://www.whatwg.org/specs/web-forms/current-work/#form-submission">WF2</a> for now</p>



  <h3>Scripting</h3>

  <h4 id="script">The <dfn><code>script</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  <span>strictly inline-level content</span>, and <span
  title="metadata elements">metadata element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element.</dd>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>inline-level content</span> is expected.</dd>
   <dt>Content model:</dt>
   <dd>If there is no <code title="attr-script-src">src</code>
   attribute, depends on the value of the <code
   title="attr-script-type">type</code> attribute.</dd>
   <dd>If there <em>is</em> a <code title="attr-script-src">src</code>
   attribute, the element must be empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-script-src">src</code></dd>
   <dd><code title="attr-script-defer">defer</code> (if the <code title="attr-script-src">src</code> attribute is present)</dd>
   <dd><code title="attr-script-async">async</code> (if the <code title="attr-script-src">src</code> attribute is present)</dd>
   <dd><code title="attr-script-type">type</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLScriptElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <code title="dom-script-src">src</code>;
           attribute boolean <code title="dom-script-defer">defer</code>;
           attribute boolean <code title="dom-script-async">async</code>;
           attribute DOMString <code title="dom-script-type">type</code>;
           attribute DOMString <code title="dom-script-text">text</code>;
};</pre>
   </dd>
  </dl>

  <p>The <code>script</code> element allows authors to include dynamic
  script in their documents.</p>

  <p>When the <dfn title="attr-script-src"><code>src</code></dfn>
  attribute is set, the <code>script</code> element refers to an
  external file. The value of the attribute must be a URI (or
  IRI).</p>

  <p>If the <code title="attr-script-src">src</code> attribute is not
  set, then the script is given by the contents of the element.</p>

  <p>The language of the script is given by the <dfn
  title="attr-script-type"><code>type</code></dfn> attribute. The
  value must be a valid MIME type, optionally with parameters. <a
  href="#refsRFC2046">[RFC2046]</a></p>

  <p>The <dfn title="attr-script-defer"><code>defer</code></dfn> and
  <dfn title="attr-script-async"><code>async</code></dfn> attributes
  are <span title="boolean attribute">boolean attributes</span> that
  indicate how the script should be executed.</p>

  <p>There are three possible modes that can be selected using these
  attributes. If the <code title="attr-script-defer">defer</code>
  attribute is present, then the script is executed when the page has
  finished parsing. If the <code
  title="attr-script-defer">defer</code> attribute is not present but
  the <code title="attr-script-async">async</code> attribute is
  present, then the script will be executed asynchronously, as soon as
  it is available. If neither attribute is present, then the script is
  downloaded and executed immediately, before the user agent continues
  parsing the page. The exact processing details for these attributes
  is described below.</p>

  <p>Changing the <code title="attr-script-src">src</code>, <code
  title="attr-script-type">type</code>, <code
  title="attr-script-defer">defer</code> and <code
  title="attr-script-async">async</code> attributes dynamically has no
  direct effect; these attribute are only used at specific times
  described below (namely, when the element is inserted into the
  document).</p>

  <p><code>script</code> elements have two associated pieces of
  metadata. The first is a flag indicating whether or not the script
  block has been <dfn>"already executed"</dfn>. Initially,
  <code>script</code> elements must have this flag unset (script
  blocks, when created, are not "already executed"). When a
  <code>script</code> element is cloned, the "already executed" flag,
  if set, must be propagated to the clone when it is created. The
  second is a flag indicating whether the element was
  <dfn>"parser-inserted"</dfn>. This flag is set by the <span>HTML
  parser</span> and is used to handle <code
  title="dom-document-write-HTML">document.write()</code> calls.</p>

  <p><dfn title="running a script">Running a script</dfn>: when a
  script block is <span>inserted into a document</span>, the user
  agent must act as follows:</p>

  <ol>

   <li>

    <p class="big-issue">How to handle the <code
    title="attr-script-type">type</code> and <code
    title="attr-script-language">language</code> attributes should be
    defined here, probably with reference to the next section.</p>

   </li>

   <li>

    <p>If <span>scripting is disabled</span>, or if the user agent
    does not support the scripting language in question, or if the
    <code>Document</code> has <code
    title="dom-document-designMode">designMode</code> enabled, or if
    the <code>script</code> element has its <span>"already
    executed"</span> flag set, then the user agent must abort these
    steps at this point. The script is not executed.</p>

   </li>

   <li>

    <p>The user agent must set the element's <span>"already
    executed"</span> flag.</p>

   </li>

   <li>

    <p>If the element has a <code title="attr-script-src">src</code>
    attribute, then a load for the specified content must be
    started.</p>

    <p class="note">Later, once the load has completed, the user agent
    will have to complete <span title="when a script completes
    loading">the steps described below</span>.</p>

    <p>For performance reasons, user agents may start loading the
    script as soon as the attribute is set, instead, in the hope that
    the element will be inserted into the document. Either way, once
    the element is inserted into the document, the load must have
    started. If the UA performs such prefetching, but the element is
    never inserted in the document, or the <code
    title="attr-script-src">src</code> attribute is dynamically
    changed, then the user agent will not execute the script, and the
    load will have been effectively wasted.</p>

   </li>

   <li>

    <p>Then, the first of the following options that describes the
    situation must be followed:</p>

    <dl class="switch">

     <dt>If the document is still being parsed, and the element
     has a <code title="attr-script-defer">defer</code> attribute</dt>

     <dd>The element must be added to the end of the <span>list of
     scripts that will execute when the document has finished
     parsing</span>. The user agent must begin <span title="when a
     script completes loading">the next set of steps</span> when the
     script is ready.
 
     <span class="big-issue">This isn't compatible with IE for inline
     deferred scripts, but then what IE does is pretty hard to pin down
     exactly. Do we want to keep this like it is? Be more compatible?</span>
     <!--XXX  
     http://www.websiteoptimization.com/speed/tweak/defer/test/
     internal deferred scripts execute before any external scripts execute, or before the LOAD if there are none
     external deferred scripts execute before the LOAD
     -->

     </dd>


     <dt>If the element has an <code
     title="attr-script-async">async</code> attribute and a <code
     title="attr-script-src">src</code> attribute</dt>

     <dd>The element must be added to the end of the <span>list of
     scripts that will execute asynchronously</span>. The user agent
     must jump to <span title="when a script completes loading">the
     next set of steps</span> once the script is ready.</dd>


     <dt>If the element has an <code
     title="attr-script-async">async</code> attribute but no <code
     title="attr-script-src">src</code> attribute, and the <span>list
     of scripts that will execute asynchronously</span> is not
     empty</dt>

     <dd>The element must be added to the end of the <span>list of
     scripts that will execute asynchronously</span>.</dd>


     <dt>If the element has a <code title="attr-script-src">src</code>
     attribute and has been flagged as
     <span>"parser-inserted"</span></dt>

     <dd>The element is <span>the script that will execute as soon as
     the parser resumes</span>. (There can only be one such script at
     a time.)</dd>


     <dt>If the element has a <code title="attr-script-src">src</code>
     attribute</dt>

     <dd>The element must be added to the end of the <span>list of
     scripts that will execute as soon as possible</span>. The user
     agent must jump to <span title="when a script completes
     loading">the next set of steps</span> when the script is
     ready.</dd>


     <dt>Otherwise</dt>

     <dd>The user agent must immediately <span title="executing a
     script block">execute the script</span>, even if other scripts
     are already executing.</dd>

    </dl>

   </li>

  </ol>


  <p><dfn title="when a script completes loading">When a script
  completes loading</dfn>: If a script whose element was added to one
  of the lists mentioned above completes loading while the document is
  still being parsed, then the parser handles it. Otherwise, when a
  script completes loading, the UA must follow the following steps as
  soon as as any other scripts that may be executing have finished
  executing:</p>

  <dl class="switch">

   <dt>If the script's element was added to the <dfn>list of scripts
   that will execute when the document has finished parsing</dfn>:</dt>

   <dd>

    <ol>

     <li>

      <p>If the script's element is not the first element in the list,
      then do nothing yet. Stop going through these steps.</p>

     </li>

     <li>

      <p>Otherwise, <span title="executing a script block">execute the
      script</span> (that is, the script associated with the first
      element in the list).</p>

     </li>

     <li>

      <p>Remove the script's element from the list (i.e. shift out the
      first entry in the list).</p>

     </li>

     <li>

      <p>If there are any more entries in the list, and if the script
      associated with the element that is now the first in the list is
      already loaded, then jump back to step two to execute it.</p>

     </li>

    </ol>

   </dd>

   <dt>If the script's element was added to the <dfn>list of scripts
   that will execute asynchronously</dfn>:</dt>

   <dd>

    <ol>

     <li>

      <p>If the script is not the first element in the list, then do
      nothing yet. Stop going through these steps.</p>

     </li>

     <li>

      <p><span title="executing a script block">Execute the
      script</span> (the script associated with the first element in
      the list).</p>

     </li>

     <li>

      <p>Remove the script's element from the list (i.e. shift out the
      first entry in the list).</p>

     </li>

     <li>

      <p>If there are any more scripts in the list, and the element
      now at the head of the list had no <code
      title="attr-script-src">src</code> attribute when it was added
      to the list, or had one, but its associated script has finished
      loading, then jump back to step two to execute the script
      associated with this element.</p>

     </li>

    </ol>

   </dd>

   <dt>If the script's element was added to the <dfn>list of scripts
   that will execute as soon as possible</dfn>:</dt>

   <dd>

    <ol>

     <li>

      <p><span title="executing a script block">Execute the
      script</span>.</p>

     </li>

     <li>

      <p>Remove the script's element from the list.</p>

     </li>

    </ol>

   </dd>

   <dt>If the script is <dfn>the script that will execute as soon as
   the parser resumes</dfn>:</dt>

   <dd>

    <p>The script will be handled <a
    href="#scriptTagParserResumes">when the parser resumes</a>
    (amazingly enough).</p>

   </dd>

  </dl>

  <p>The download of an external script must <span>delay the <code
  title="event-load">load</code> event</span>.</p>

  <p><dfn title="executing a script block">Executing a script
  block</dfn>: If the load resulted in an error (for example a DNS
  error, or an HTTP 404 error), then executing the script must just
  consist of <span title="fire an error event">firing an <code
  title="event-error">error</code> event</span> at the element.</p>

  <p>If the load was successful, then first the user agent must
  <span>fire a <code title="event-load">load</code> event</span> at
  the element, and then, if <span>scripting is enabled</span> and the
  <code>Document</code> does not have <code
  title="dom-document-designMode">designMode</code> enabled, the user
  agent must run the script according to the semantics of the relevant
  scripting language defines.</p>

  <p>If the script is from an external file, then that file must be
  used as the file to execute.</p>

  <p>If the script is inline, then, for scripting languages that
  consist of pure text, user agents must use the value of the DOM
  <code title="dom-script-text">text</code> attribute (defined below)
  as the script to execute, and for XML-based scripting languages,
  user agents must use all the child nodes of the <code>script</code>
  element as the script to execute.</p>

  <p>In any case, the user agent must execute the script according to
  the semantics of the relevant language specification, as determined
  by the <code title="attr-script-type">type</code> and <code
  title="attr-script-language">language</code> attributes on the
  <code>script</code> element when the element was inserted into the
  document, as described above.</p>

  <p class="big-issue"> Have to define that the script executes in
  context of <span>global scope</span>, scripting context, browsing
  context, etc.</p>

  <p class="note">The element's attributes' values might have changed
  between when the element was inserted into the document and when the
  script has finished loading, as may its other attributes; similarly,
  the element itself might have been taken back out of the DOM, or had
  other changes made. These changes do not in any way affect the above
  steps; only the values of the attributes at the time the
  <code>script</code> element is first inserted into the document
  matter.</p>

  <p>The DOM attributes <dfn
  title="dom-script-src"><code>src</code></dfn>, <dfn
  title="dom-script-type"><code>type</code></dfn>, <dfn
  title="dom-script-defer"><code>defer</code></dfn>, <dfn
  title="dom-script-async"><code>async</code></dfn>, each must
  <span>reflect</span> the respective content attributes of the same
  name.</p>

  <p>The DOM attribute <dfn
  title="dom-script-text"><code>text</code></dfn> must return a
  concatenation of the contents of all the <span title="text
  node">text nodes</span> that are direct children of the
  <code>script</code> element (ignoring any other nodes such as
  comments or elements), in tree order. On setting, it must act the
  same way as the <code>textContent</code> DOM attribute.</p>


  <h5>Script languages</h5>

  <p>The following lists some MIME types and the languages to which
  they refer:</p>

  <dl>

   <dt><code>text/javascript</code></dt>
   <dd>ECMAScript. <a href="#refsECMA262">[ECMA262]</a></dd>

   <dt><code>text/javascript;e4x=1</code></dt>
   <dd>ECMAScript with ECMAScript for XML. <a href="#refsECMA357">[ECMA357]</a></dd>

  </dl>

  <p>User agents may support other MIME types and other languages.</p>

  <p>When examining types to determine if they support the language,
  user agents must not ignore unknown MIME parameters &mdash; types
  with unknown parameters must be assumed to be unsupported.</p>



  <h4>The <dfn><code>noscript</code></dfn> element</h4>

  <p>When <span>scripting is disabled</span>: <span>transparent</span>
  <span title="block-level elements">block-level element</span>, and
  <span>transparent</span> <span>strictly inline-level
  content</span>.</p>

  <p>When <span>scripting is enabled</span>: <span title="block-level
  elements">block-level element</span>, and <span>strictly
  inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element of an <span title=">HTML documents">HTML document</span>, if there are no ancestor <code>noscript</code> elements.</dd>
   <dd>Where <span>block-level elements</span> are expected in <span>HTML documents</span>, if there are no ancestor <code>noscript</code> elements.</dd>
   <dd>Where <span>inline-level content</span> is expected in <span>HTML documents</span>, if there are no ancestor <code>noscript</code> elements.</dd>
   <dt>Content model:</dt>
   <dd>When <span>scripting is disabled</span>: <span>transparent</span>, but there must be no <code>noscript</code> element descendants.</dd>
   <dd>When <span>scripting is enabled</span>: Text that conforms to the requirements given in the prose.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>noscript</code> element does not represent anything. It
  is used to present different markup to user agents that support
  scripting and those that don't support scripting, by affecting how
  the document is parsed.</p>

  <p>The <code>noscript</code> element must not be used in <span>XML
  documents</span>.</p>

  <p>When used in <span>HTML documents</span>, the allowed content
  model depends on whether scripting is enabled or not.</p>

  <p>If <span>scripting is disabled</span>, then the content model of
  a <code>noscript</code> element is <span>transparent</span>, with
  the additional restriction that a <code>noscript</code> element must
  not have a <code>noscript</code> element as an ancestor (that is,
  <code>noscript</code> can't be nested).</p>

  <p>If <span>scripting is enabled</span>, then the content model of a
  <code>noscript</code> element is text, except that the text must be
  such that running the following algorithm results in a conforming
  document with no <code>noscript</code> elements and no
  <code>script</code> elements, and such that no step in the algorithm
  causes an <span>HTML parser</span> to flag a <span>parse
  error</span>:</p>

  <ol>

   <li>Remove every <code>script</code> element from the
   document.</li>

   <li>Make a list of every <code>noscript</code> element in the
   document. For every <code>noscript</code> element in that list,
   perform the following steps:

    <ol>

     <li>Let the <var title="">parent element</var> be the parent
     element of the <code>noscript</code> element.</li>

     <li>Take all the children of the <var title="">parent element</var>
     that come before the <code>noscript</code> element, and call these
     elements <var title="">the before children</var>.</li>

     <li>Take all the children of the <var title="">parent element</var>
     that come <em>after</em> the <code>noscript</code> element, and
     call these elements <var title="">the after children</var>.</li>

     <li>Let <var title="">s</var> be the concatenation of all the
     <span>text node</span> children of the <code>noscript</code>
     element.</li>

     <li>Set the <code title="dom-innerHTML-HTML">innerHTML</code>
     attribute of the <var title="">parent element</var> to the value
     of <var title="">s</var>. (This, as a side-effect, causes the
     <code>noscript</code> element to be removed from the
     document.)</li>

     <li>Insert <var title="">the before children</var> at the start of
     the <var title="">parent element</var>, preserving their original
     relative order.</li>

     <li>Insert <var title="">the after children</var> at the end of the
     <var title="">parent element</var>, preserving their original
     relative order.</li>

    </ol>

   </li>

  </ol>

  <p>The <code>noscript</code> element has no other requirements. In
  particular, children of the <code>noscript</code> element are not
  exempt from form submission, scripting, and so forth, even when
  scripting is enabled.</p>

  <p class="note">All these contortions are required because, for
  historical reasons, the <code>noscript</code> element causes the
  <span>HTML parser</span> to act differently based on whether
  scripting is enabled or not. The element is not allowed in XML,
  because in XML the parser is not affected by such state, and thus
  the element would not have the desired effect.</p>


  <h4>The <dfn><code>event-source</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  <span>strictly inline-level content</span>, and <span
  title="metadata elements">metadata element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element.</dd>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>inline-level content</span> is expected.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-event-source-src">src</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLEventSourceElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-event-source-src">src</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>event-source</code> element represents a target for
  events generated by a remote server.</p>

  <p>The <dfn title="attr-event-source-src"><code>src</code></dfn>
  attribute, if specified, must give a URI (or IRI) pointing to a
  resource that uses the <code>application/x-dom-event-stream</code>
  format.</p>

  <p>When the element is inserted into the document, if it has the
  <code title="attr-event-source-src">src</code> attribute specified,
  the user agent must act as if the <code
  title="dom-remoteEventTarget-addEventSource">addEventSource()</code>
  method on the <code>event-source</code> element had been invoked
  with the URI resulting from resolving the <code
  title="attr-event-source-src">src</code> attribute's value to an
  absolute URI.</p>

  <p>While the element is in a document, if its <code
  title="attr-event-source-src">src</code> attribute is mutated, the
  user agent must act as if first the <code
  title="dom-remoteEventTarget-removeEventSource">removeEventSource()</code>
  method on the <code>event-source</code> element had been invoked
  with the URI resulting from resolving the old value of the attribute
  to an absolute URI, and then as if the <code
  title="dom-remoteEventTarget-addEventSource">addEventSource()</code>
  method on the element had been invoked with the URI resulting from
  resolving the <em>new</em> value of the <code
  title="attr-event-source-src">src</code> attribute to an absolute
  URI.</p>

  <p>When the element is removed from the document, if it has the
  <code title="attr-event-source-src">src</code> attribute specified,
  the user agent must act as if the <code
  title="dom-remoteEventTarget-removeEventSource">removeEventSource()</code>
  method on the <code>event-source</code> element had been invoked
  with the URI resulting from resolving the <code
  title="attr-event-source-src">src</code> attribute's value to an
  absolute URI.</p>

  <p>There can be more than one <code>event-source</code> element per
  document, but authors should take care to avoid opening multiple
  connections to the same server as HTTP recommends a limit to the
  number of simultaneous connections that a user agent can open per
  server.</p>

  <!-- XXX should we make 'load', 'error', 'abort' events fire on this
  element? -->

  <p>The <dfn title="dom-event-source-src"><code>src</code></dfn> DOM
  attribute must reflect the content attribute of the same name.</p>



  <h3>Interactive elements</h3>

  <h4>The <dfn><code>details</code></dfn> element</h4>

  <p><span title="interactive elements">Interactive</span>,
     <span title="block-level elements">block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>One <code>legend</code> element followed by either one or more
   <span>block-level elements</span> or <span>inline-level
   content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-details-open">open</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLDetailsElement</dfn> : <span>HTMLElement</span> {
  attribute boolean <span title="dom-details-open">open</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>details</code> element represents additional
  information or controls which the user can obtain on demand.</p>

  <p>The first element child of a <code>details</code> element, if it
  is a <code>legend</code> element, represents the summary of the
  details.</p>

  <p>If the first element is not a <code>legend</code> element, the
  UA should provide its own legend (e.g. "Details").</p>

  <p>The <dfn title="attr-details-open"><code>open</code></dfn>
  content attribute is a <span>boolean attribute</span>. If present,
  it indicates that the details should be shown to the user. If the
  attribute is absent, the details should not be shown.</p>

  <p>If the attribute is removed, then the details should be
  hidden. If the attribute is added, the details should be shown.</p>

  <p>The user should be able to request that the details be shown or
  hidden.</p>

  <p>The <dfn title="dom-details-open"><code>open</code></dfn>
  attribute must <span>reflect</span> the <code
  title="attr-details-open">open</code> content attribute.</p>

<!--
http://mail.gnome.org/archives/usability/2006-June/msg00015.html
http://developer.apple.com/documentation/UserExperience/Conceptual/OSXHIGuidelines/XHIGControls/chapter_18_section_7.html
https://www.google.com/base/settings
-->

  <p class="big-issue">Rendering will be described in the Rendering
  section in due course. Basically CSS :open and :closed match the
  element, it's a block-level element by default, and when it matches
  :closed it renders as if it had an XBL binding attached to it whose
  template was just <code>&lt;template>&#x25B6;&lt;content
  includes="legend:first-child"&gt;Details&lt;/content>&lt;/template></code>,
  and when it's :open it acts as if it had an XBL binding attached to
  it whose template was just <code>&lt;template>&#x25BC;&lt;content
  includes="legend:first-child"&gt;Details&lt;/content>&lt;content/>&lt;/template></code>
  or some such.</p>

  <p class="big-issue">Clicking the legend would make it open/close
  (and would change the content attribute). Question: Do we want the
  content attribute to reflect the actual state like this? I think we
  do, the DOM not reflecting state has been a pain in the neck
  before. But is it semantically ok?</p>



  <h4 id="datagrid">The <dfn><code>datagrid</code></dfn> element</h4>

  <p><span title="interactive elements">Interactive</span>,
  <span title="block-level elements">block-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected, if
   there are no ancestor <span>interactive elements</span>.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <span>block-level elements</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-datagrid-multiple">multiple</code></dd>
   <dd><code title="attr-datagrid-disabled">disabled</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLDataGridElement</dfn> : <span>HTMLElement</span> {
           attribute <span>DataGridDataProvider</span> <span title="dom-datagrid-data">data</span>;
  readonly attribute <span>DataGridSelection</span> <span title="dom-datagrid-selection">selection</span>;
           attribute boolean <span title="dom-datagrid-multiple">multiple</span>;
           attribute boolean <span title="dom-datagrid-disabled">disabled</span>;
  void <span title="dom-datagrid-updateEverything">updateEverything</span>();
  void <span title="dom-datagrid-updateRowsChanged">updateRowsChanged</span>(in <span>RowSpecification</span> row, in unsigned long count);
  void <span title="dom-datagrid-updateRowsInserted">updateRowsInserted</span>(in <span>RowSpecification</span> row, in unsigned long count);
  void <span title="dom-datagrid-updateRowsRemoved">updateRowsRemoved</span>(in <span>RowSpecification</span> row, in unsigned long count);
  void <span title="dom-datagrid-updateRowChanged">updateRowChanged</span>(in <span>RowSpecification</span> row);
  void <span title="dom-datagrid-updateColumnChanged">updateColumnChanged</span>(in unsigned long column);
  void <span title="dom-datagrid-updateCellChanged">updateCellChanged</span>(in <span>RowSpecification</span> row, in unsigned long column);
};</pre>
   </dd>
  </dl>

  <p class="big-issue">One possible thing to be added is a way to
  detect when a row/selection has been deleted, activated, etc, by the
  user (delete key, enter key, etc).</p> <!-- XXXPA -->

  <p class="big-issue">This element is defined as interactive, which
  means it can't contain other interactive elements, despite the fact
  that we expect it to work with other interactive elements e.g.
  checkboxes and input fields. It should be called something like a
  Leaf Interactive Element or something, which counts for ancestors
  looking in and not descendants looking out.</p>

  <p>The <code>datagrid</code> element represents an interactive
  representation of tree, list, or tabular data.</p>

  <p>The data being presented can come either from the content, as
  elements given as children of the <code>datagrid</code> element, or
  from a scripted data provider given by the <code
  title="dom-datagrid-data">data</code> DOM attribute.</p>

  <p>The <code title="attr-datagrid-multiple">multiple</code> and
  <code title="attr-datagrid-disabled">disabled</code> attributes are
  <span title="boolean attribute">boolean attributes</span>. Their
  effects are described in the processing model sections below.</p>

  <p>The <dfn
  title="dom-datagrid-multiple"><code>multiple</code></dfn> and <dfn
  title="dom-datagrid-disabled"><code>disabled</code></dfn> DOM
  attributes must <span>reflect</span> the <code
  title="attr-datagrid-multiple">multiple</code> and <code
  title="attr-datagrid-disabled">disabled</code> content attributes
  respectively.</p>


  <h5>The <code>datagrid</code> data model</h5>

  <p><em>This section is non-normative.</em></p>

  <p>In the <code>datagrid</code> data model, data is structured as a
  set of rows representing a tree, each row being split into a number
  of columns. The columns are always present in the data model,
  although individual columns may be hidden in the presentation.</p>

  <p>Each row can have child rows. Child rows may be hidden or
  shown, by closing or opening (respectively) the parent row.</p>

  <p>Rows are referred to by the path along the tree that one would
  take to reach the row, using zero-based indices. Thus, the first row
  of a list is row "0", the second row is row "1"; the first child row
  of the first row is row "0,0", the second child row of the first row
  is row "0,1"; the fourth child of the seventh child of the third
  child of the tenth row is "9,2,6,3", etc.</p>

  <p>The columns can have captions. Those captions are not considered
  a row in their own right, they are obtained separately.</p>

  <p>Selection of data in a <code>datagrid</code> operates at the row
  level. If the <code title="attr-datagrid-multiple">multiple</code>
  attribute is present, multiple rows can be selected at once,
  otherwise the user can only select one row at a time.</p>

  <p>The <code>datagrid</code> element can be disabled entirely by
  setting the <code title="attr-datagrid-disabled">disabled</code>
  attribute.</p>
<!--XXXDND
  <p class="big-issue">selection draggable [normative definitions are
  in the interactive part below]</p>
-->

  <p>Columns, rows, and cells can each have specific flags, known as
  classes, applied to them by the data provider. These classes <a
  href="#datagridClassSummary">affect the functionality</a> of the
  <code>datagrid</code> element, and are also <a
  href="#datagridPseudos">passed to the style system</a>. They are
  similar in concept to the <code title="attr-class">class</code>
  attribute, except that they are not specified on elements but are
  given by scripted data providers.</p> <!-- XXX check xrefs -->


  <h5>How rows are identified</h5>

  <p>The chains of numbers that give a row's path, or identifier, are
  represented by objects that implement the
  <span>RowSpecification</span> interface.</p>

  <pre class="idl">interface <dfn>RowSpecification</dfn> {
  // binding-specific interface
};</pre>

  <p>In ECMAScript, two classes of objects are said to implement this
  interface: Numbers representing non-negative integers, and
  homogeneous arrays of Numbers representing non-negative
  integers. Thus, <code>[1,0,9]</code> is a
  <span>RowSpecification</span>, as is <code>1</code> on its
  own. However, <code>[1,0.2,9]</code> is not a
  <span>RowSpecification</span> object, since its second value is not
  an integer.</p>

  <p>User agents must always represent <span>RowSpecification</span>s
  in ECMAScript by using arrays, even if the path only has one
  number.</p>

  <p>The root of the tree is represented by the empty path; in
  ECMAScript, this is the empty array (<code>[]</code>). Only the
  <code title="dom-provider-getRowCount">getRowCount()</code> and
  <code
  title="dom-provider-getChildAtPosition">GetChildAtPosition()</code>
  methods ever get called with the empty path.</p>


  <h5>The data provider interface</h5>

  <p><em>The conformance criteria in this section apply to any
  implementation of the <code>DataGridDataProvider</code>, including
  (and most commonly) the content author's implementation(s).</em></p>

  <pre class="idl">// To be implemented by Web authors as a JS object
interface <dfn>DataGridDataProvider</dfn> {
  void <span title="dom-provider-initialize">initialize</span>(in HTMLDataGridElement datagrid);
  unsigned long <span title="dom-provider-getRowCount">getRowCount</span>(in <span>RowSpecification</span> row);
  unsigned long <span title="dom-provider-getChildAtPosition">getChildAtPosition</span>(in <span>RowSpecification</span> parentRow, in unsigned long position);
  unsigned long <span title="dom-provider-getColumnCount">getColumnCount</span>();
  DOMString <span title="dom-provider-getCaptionText">getCaptionText</span>(in unsigned long column);
  void <span title="dom-provider-getCaptionClasses">getCaptionClasses</span>(in unsigned long column, in DOMTokenList classes);
  DOMString <span title="dom-provider-getRowImage">getRowImage</span>(in <span>RowSpecification</span> row);
  <span>HTMLMenuElement</span> <span title="dom-provider-getRowMenu">getRowMenu</span>(in <span>RowSpecification</span> row);
  void <span title="dom-provider-getRowClasses">getRowClasses</span>(in <span>RowSpecification</span> row, in DOMTokenList classes);
  DOMString <span title="dom-provider-getCellData">getCellData</span>(in <span>RowSpecification</span> row, in unsigned long column);
  void <span title="dom-provider-getCellClasses">getCellClasses</span>(in <span>RowSpecification</span> row, in unsigned long column, in DOMTokenList classes);
<!--XXXDND
  boolean <span title="dom-provider-canDrop">canDrop</span>(in <span>RowSpecification</span> row, in <span>RowSpecification</span> position, data);
  boolean <span title="dom-provider-dropped">dropped</span>(in <span>RowSpecification</span> row, in <span>RowSpecification</span> position, data);
-->  void <span title="dom-provider-toggleColumnSortState">toggleColumnSortState</span>(in unsigned long column);
  void <span title="dom-provider-setCellCheckedState">setCellCheckedState</span>(in <span>RowSpecification</span> row, in unsigned long column, in long state);
  void <span title="dom-provider-cycleCell">cycleCell</span>(in <span>RowSpecification</span> row, in unsigned long column);
  void <span title="dom-provider-editCell">editCell</span>(in <span>RowSpecification</span> row, in unsigned long column, in DOMString data);
<!--XXXPA
  void <span title="dom-provider-performAction">performAction</span>(in DOMString action); // required if .performAction() is ever invoked on the datagrid
  void <span title="dom-provider-performActionOnRow">performActionOnRow</span>(in <span>RowSpecification</span> row, in DOMString action); // required if getRowClasses ever includes 'deletable' or if <span title="dom-provider-.performActionOnRow">.performActionOnRow</span>() is ever invoked on the datagrid
  void <span title="dom-provider-performActionOnCell">performActionOnCell</span>(in <span>RowSpecification</span> row, in unsigned long column, in DOMString action); // required if .performActionOnCell() is ever invoked on the datagrid
-->};</pre>
<!-- based on http://lxr.mozilla.org/seamonkey/source/layout/xul/base/src/tree/public/nsITreeView.idl -->

  <p>The <code>DataGridDataProvider</code> interface represents the
  interface that objects must implement to be used as custom data
  views for <code>datagrid</code> elements.</p>

  <p>Not all the methods are required. The minimum number of methods
  that must be implemented in a useful view is two: the <code
  title="dom-provider-getRowCount">getRowCount()</code> and <code
  title="dom-provider-getCellData">getCellData()</code> methods.</p>

  <p>Once the object is written, it must be hooked up to the
  <code>datagrid</code> using the <dfn
  title="dom-datagrid-data"><code>data</code></dfn> DOM attribute.</p>

  <p>The following methods may be usefully implemented:</p>

  <dl>

   <dt><dfn title="dom-provider-initialize"><code>initialize(<var title="">datagrid</var>)</code></dfn></dt>

   <dd>Called by the <code>datagrid</code> element (the one given by
   the <var title="">datagrid</var> argument) after it has first
   populated itself. This would typically be used to set the initial
   selection of the <code>datagrid</code> element when it is first
   loaded. The data provider could also use this method call to
   register a <code title="event-select">select</code> event handler
   on the <code>datagrid</code> in order to monitor selection
   changes.</dd>

   <dt><dfn title="dom-provider-getRowCount"><code>getRowCount(<var title="">row</var>)</code></dfn></dt>

   <dd>Must return the number of rows that are children of the
   specified <var title="">row</var>, including rows that are
   off-screen. If <var title="">row</var> is empty, then the number of
   rows at the top level must be returned. If the value that this
   method would return for a given <var title="">row</var> changes,
   the relevant update methods on the <code>datagrid</code> must be
   called first. Otherwise, this method must always return the same
   number. For a list (as opposed to a tree), this method must return
   0 whenever it is called with a <var title="">row</var> identifier
   that is not empty.</dd>

   <dt><dfn title="dom-provider-getChildAtPosition"><code>getChildAtPosition(<var title="">parentRow</var>, <var title="">position</var>)</code></dfn></dt>

   <dd>Must return the index of the row that is a child of <var
   title="">parentRow</var> and that is to be positioned as the <var
   title="">position</var>th row under <var title="">parentRow</var>
   when rendering the children of <var title="">parentRow</var>. If
   <var title="">parentRow</var> is empty, then <var
   title="">position</var> refers to the <var
   title="">position</var>th row at the top level of the data
   grid. May be omitted if the rows are always to be sorted in the
   natural order. (The natural order is the one where the method
   always returns <var title="">position</var>.) For a given <var
   title="">parentRow</var>, this method must never return the same
   value for different values of <var title="">position</var>. The
   returned value <var title="">x</var> must be in the range
   0&nbsp;&le;&nbsp;<var title="">x</var>&nbsp;&lt;&nbsp;<var
   title="">n</var>, where <var title="">n</var> is the value returned
   by <code title="dom-provider-getRowCount">getRowCount(<var
   title="">parentRow</var>)</code>.</dd>

   <dt><dfn title="dom-provider-getColumnCount"><code>getColumnCount()</code></dfn></dt>

   <dd>Must return the number of columns currently in the data model
   (including columns that might be hidden). May be omitted if there
   is only one column. If the value that this method would return
   changes, the <code>datagrid</code>'s <code
   title="dom-datagrid-updateEverything">updateEverything()</code>
   method must be called.</dd>

   <dt><dfn title="dom-provider-getCaptionText"><code>getCaptionText(<var title="">column</var>)</code></dfn></dt>

   <dd>Must return the caption, or label, for column <var
   title="">column</var>. May be omitted if the columns have no
   captions. If the value that this method would return changes, the
   <code>datagrid</code>'s <code
   title="dom-datagrid-updateColumnChanged">updateColumnChanged()</code>
   method must be called with the appropriate column index.</dd>

   <dt><dfn title="dom-provider-getCaptionClasses"><code>getCaptionClasses(<var title="">column</var>, <var title="">classes</var>)</code></dfn></dt>

   <dd>Must add the classes that apply to column <var
   title="">column</var> to the <var title="">classes</var> object.
   May be omitted if the columns have no special classes. If the
   classes that this method would add changes, the
   <code>datagrid</code>'s <code
   title="dom-datagrid-updateColumnChanged">updateColumnChanged()</code>
   method must be called with the appropriate column index. Some
   classes have <a href="#datagridClassSummary">predefined
   meanings</a>.</dd>

   <dt><dfn title="dom-provider-getRowImage"><code>getRowImage(<var title="">row</var>)</code></dfn></dt>

   <dd>Must return a URI to an image that represents row <var
   title="">row</var>, or the empty string if there is no applicable
   image. May be omitted if no rows have associated images. If the
   value that this method would return changes, the
   <code>datagrid</code>'s update methods must be called to update the
   row in question.</dd>

   <dt><dfn title="dom-provider-getRowMenu"><code>getRowMenu(<var title="">row</var>)</code></dfn></dt>

   <dd>Must return an <code>HTMLMenuElement</code> object that is to
   be used as a context menu for row <var title="">row</var>, or null
   if there is no particular context menu. May be omitted if none of
   the rows have a special context menu. As this method is called
   immediately before showing the menu in question, no precautions
   need to be taken if the return value of this method changes.</dd>

   <dt><dfn title="dom-provider-getRowClasses"><code>getRowClasses(<var title="">row</var>, <var title="">classes</var>)</code></dfn></dt>

   <dd>Must add the classes that apply to row <var title="">row</var>
   to the <var title="">classes</var> object. May be omitted if the
   rows have no special classes. If the classes that this method would
   add changes, the <code>datagrid</code>'s update methods must be
   called to update the row in question. Some classes have <a
   href="#datagridClassSummary">predefined meanings</a>.</dd>

   <dt><dfn title="dom-provider-getCellData"><code>getCellData(<var title="">row</var>, <var title="">column</var>)</code></dfn></dt>

   <dd>Must return the value of the cell on row <var
   title="">row</var> in column <var title="">column</var>. For text
   cells, this must be the text to show for that cell. For <span
   title="datagrid-cell-class-progress">progress bar cells</span>,
   this must be either a floating point number in the range 0.0 to 1.0
   (converted to a string representation<!-- XXX this isn't
   technically enough to define what the author must be doing here,
   but let's let that slide until someone notices -->), indicating the
   fraction of the progress bar to show as full (1.0 meaning
   complete), or the empty string, indicating an indeterminate
   progress bar. If the value that this method would return changes,
   the <code>datagrid</code>'s update methods must be called to update
   the rows that changed. If only one cell changed, the <code
   title="dom-datagrid-updateCellChanged">updateCellChanged()</code>
   method may be used.</dd>

   <dt><dfn title="dom-provider-getCellClasses"><code>getCellClasses(<var title="">row</var>, <var title="">column</var>, <var title="">classes</var>)</code></dfn></dt>

   <dd>Must add the classes that apply to the cell on row <var
   title="">row</var> in column <var title="">column</var> to the <var
   title="">classes</var> object. May be omitted if the cells have no
   special classes. If the classes that this method would add changes,
   the <code>datagrid</code>'s update methods must be called to update
   the rows or cells in question. Some classes have <a
   href="#datagridClassSummary">predefined meanings</a>.</dd>

   <dt><dfn title="dom-provider-toggleColumnSortState"><code>toggleColumnSortState(<var title="">column</var>)</code></dfn></dt>

   <dd>Called by the <code>datagrid</code> when the user tries to sort
   the data using a particular column <var title="">column</var>. The
   data provider must update its state so that the <code
   title="dom-provider-getChildAtPosition">GetChildAtPosition()</code>
   method returns the new order, and the classes of the columns
   returned by <code
   title="dom-provider-getCaptionClasses">getCaptionClasses()</code>
   represent the new sort status. There is no need to tell the
   <code>datagrid</code> that it the data has changed, as the
   <code>datagrid</code> automatically assumes that the entire data
   model will need updating.</dd>

   <dt><dfn title="dom-provider-setCellCheckedState"><code>setCellCheckedState(<var title="">row</var>, <var title="">column</var>, <var title="">state</var>)</code></dfn></dt>

   <dd>Called by the <code>datagrid</code> when the user changes the
   state of a checkbox cell on row <var title="">row</var>, column
   <var title="">column</var>. The checkbox should be toggled to the
   state given by <var title="">state</var>, which is a positive
   integer (1) if the checkbox is to be checked, zero (0) if it is to
   be unchecked, and a negative number (-1) if it is to be set to the
   indeterminate state. There is no need to tell the
   <code>datagrid</code> that the cell has changed, as the
   <code>datagrid</code> automatically assumes that the given cell
   will need updating.</dd>

   <dt><dfn title="dom-provider-cycleCell"><code>cycleCell(<var title="">row</var>, <var title="">column</var>)</code></dfn></dt>

   <dd>Called by the <code>datagrid</code> when the user changes the
   state of a cyclable cell on row <var title="">row</var>, column
   <var title="">column</var>. The data provider should change the
   state of the cell to the new state, as appropriate. There is no
   need to tell the <code>datagrid</code> that the cell has
   changed, as the <code>datagrid</code> automatically assumes that
   the given cell will need updating.</dd>

   <dt><dfn title="dom-provider-editCell"><code>editCell(<var title="">row</var>, <var title="">column</var>, <var title="">data</var>)</code></dfn></dt>

   <dd>Called by the <code>datagrid</code> when the user edits the
   cell on row <var title="">row</var>, column <var
   title="">column</var>. The new value of the cell is given by <var
   title="">data</var>. The data provider should update the cell
   accordingly. There is no need to tell the <code>datagrid</code>
   that the cell has changed, as the <code>datagrid</code>
   automatically assumes that the given cell will need updating.</dd>

<!--XXXPA
  void performAction(in DOMString action); // required if .performAction() is ever invoked on the datagrid
  void performActionOnRow(in <span>RowSpecification</span> row, in DOMString action); // required if getRowClasses ever includes 'deletable' or if .performActionOnRow() is ever invoked on the datagrid
  void performActionOnCell(in <span>RowSpecification</span> row, in unsigned long column, in DOMString action); // required if .performActionOnCell() is ever invoked on the datagrid
-->

  </dl>

  <p>The following classes (for rows, columns, and cells) may be
  usefully used in conjunction with this interface:</p>

  <table id="datagridClassSummary">
   <tr>
    <th>Class name</th>
    <th>Applies to</th>
    <th>Description</th>
   </tr>

   <tr>
    <td><!--checked--><dfn title="datagrid-cell-class-checked"><code>checked</code></dfn></td>
    <td>Cells</td>
    <td>The cell has a checkbox and it is checked. (The <code
    title="datagrid-cell-class-cyclable">cyclable</code> and <code
    title="datagrid-cell-class-progress">progress</code> classes
    override this, though.)</td>
   </tr>

   <tr>
    <td><!--cyclable--><dfn title="datagrid-cell-class-cyclable"><code>cyclable</code></dfn></td>
    <td>Cells</td>
    <td>The cell can be cycled through multiple values. (The <code
    title="datagrid-cell-class-progress">progress</code> class
    overrides this, though.)</td>
   </tr>

   <tr>
    <td><!--editable--><dfn title="datagrid-cell-class-editable"><code>editable</code></dfn></td>
    <td>Cells</td>
    <td>The cell can be edited. (The <code
    title="datagrid-cell-class-cyclable">cyclable</code>, <code
    title="datagrid-cell-class-progress">progress</code>, <code
    title="datagrid-cell-class-checked">checked</code>, <code
    title="datagrid-cell-class-checked">unchecked</code> and <code
    title="datagrid-cell-class-checked">indeterminate</code> classes
    override this, though.)</td>
   </tr>

   <tr>
    <td><!--header--><dfn title="datagrid-row-class-header"><code>header</code></dfn></td>
    <td>Rows</td>
    <td>The row is a heading, not a data row.</td>
   </tr>

   <tr>
    <td><!--indeterminate--><dfn title="datagrid-cell-class-indeterminate"><code>indeterminate</code></dfn></td>
    <td>Cells</td>
    <td>The cell has a checkbox, and it can be set to an indeterminate
    state. If neither the <code
    title="datagrid-cell-class-checked">checked</code> nor <code
    title="datagrid-cell-class-checked">unchecked</code> classes are
    present, then the checkbox is in that state, too. (The <code
    title="datagrid-cell-class-cyclable">cyclable</code> and <code
    title="datagrid-cell-class-progress">progress</code> classes
    override this, though.)</td>
   </tr>

   <tr>
    <td><!--initially-hidden--><dfn title="datagrid-column-class-initially-hidden"><code>initially-hidden</code></dfn></td>
    <td>Columns</td>
    <td>The column will not be shown when the <code>datagrid</code> is
    initially rendered. If this class is not present on the column
    when the <code>datagrid</code> is initially rendered, the column
    will be visible if space allows.</td>
   </tr>

   <tr>
    <td><!--initially-closed--><dfn title="datagrid-row-class-initially-closed"><code>initially-closed</code></dfn></td>
    <td>Rows</td>
    <td>The row will be closed when the <code>datagrid</code> is
    initially rendered. If neither this class nor the <code
    title="datagrid-row-class-initially-open">initially-open</code>
    class is present on the row when the <code>datagrid</code> is
    initially rendered, the initial state will depend on platform
    conventions.</td>
   </tr>

   <tr>
    <td><!--initially-open--><dfn title="datagrid-row-class-initially-open"><code>initially-open</code></dfn></td>
    <td>Rows</td>
    <td>The row will be opened when the <code>datagrid</code> is
    initially rendered. If neither this class nor the <code
    title="datagrid-row-class-initially-closed">initially-closed</code>
    class is present on the row when the <code>datagrid</code> is
    initially rendered, the initial state will depend on platform
    conventions.</td>
   </tr>

   <tr>
    <td><!--progress--><dfn title="datagrid-cell-class-progress"><code>progress</code></dfn></td>
    <td>Cells</td>
    <td>The cell is a progress bar.</td>
   </tr>

   <tr>
    <td><!--reversed--><dfn title="datagrid-column-class-reversed"><code>reversed</code></dfn></td>
    <td>Columns</td>
    <td>If the cell is sorted, the sort direction is descending,
    instead of ascending.</td>
   </tr>

   <tr>
    <td><!--selectable-separator--><dfn title="datagrid-row-class-selectable-separator"><code>selectable-separator</code></dfn></td>
    <td>Rows</td>
    <td>The row is a normal, selectable, data row, except that instead
    of having data, it only has a separator. (The <code
    title="datagrid-row-class-header">header</code> and <code
    title="datagrid-row-class-separator">separator</code> classes
    override this, though.)</td>
   </tr>

   <tr>
    <td><!--separator--><dfn title="datagrid-row-class-separator"><code>separator</code></dfn></td>
    <td>Rows</td>
    <td>The row is a separator row, not a data row. (The <code
    title="datagrid-row-class-header">header</code> class
    overrides this, though.)</td>
   </tr>

   <tr>
    <td><!--sortable--><dfn title="datagrid-column-class-sortable"><code>sortable</code></dfn></td>
    <td>Columns</td>
    <td>The data can be sorted by this column.</td>
   </tr>

   <tr>
    <td><!--sorted--><dfn title="datagrid-column-class-sorted"><code>sorted</code></dfn></td>
    <td>Columns</td>
    <td>The data is sorted by this column. Unless the <code
    title="datagrid-column-class-reversed">reversed</code> class is
    also present, the sort direction is ascending.</td>
   </tr>

   <tr>
    <td><!--unchecked--><dfn title="datagrid-cell-class-unchecked"><code>unchecked</code></dfn></td>
    <td>Cells</td>
    <td>The cell has a checkbox and, unless the <code
    title="datagrid-cell-class-checked">checked</code> class is
    present as well, it is unchecked. (The <code
    title="datagrid-cell-class-cyclable">cyclable</code> and <code
    title="datagrid-cell-class-progress">progress</code> classes
    override this, though.)</td>
   </tr>

<!--XXXPA
   <tr>
    <td><!- -deletable- -><dfn title="datagrid-row-class-deletable"><code>deletable</code></dfn></td>
    <td>Rows</td>
    <td></td>
   </tr>
-->

  </table>


  <h5>The default data provider</h5>

  <p>The user agent must supply a default data provider for the case
  where the <code>datagrid</code>'s <code
  title="dom-datagrid-data">data</code> attribute is null. It must act
  as described in this section.</p>

  <p>The behaviour of the default data provider depends on the nature
  of the first element child of the <code>datagrid</code>.</p>

  <dl class="switch">

   <dt>While the first element child is a <code>table</code></dt>

   <dd>

    <p><strong><code
    title="dom-provider-getRowCount">getRowCount(<var title="">row</var>)</code></strong>:
    The number of rows returned by the default data provider for the
    root of the tree (when <var title="">row</var> is empty) must be the total number of <code>tr</code> elements
    that are children of <code>tbody</code> elements that are children
    of the <code>table</code>, if there are any such child
    <code>tbody</code> elements. If there are no such
    <code>tbody</code> elements then the number of rows returned for
    the root must be the number of <code>tr</code> elements that are
    children of the <code>table</code>.</p>

    <p>When <var title="">row</var> is not empty, the number of rows
    returned must be zero.</p>

    <p class="note">The <code>table</code>-based default data provider
    cannot represent a tree.</p>

    <p class="note">Rows in <code>thead</code> elements do not
    contribute to the number of rows returned, although they do affect
    the columns and column captions. Rows in <code>tfoot</code>
    elements are <span title="ignore">ignored</span> completely by
    this algorithm.</p>

    <p id="defaultDataProviderTableMapper"><strong><code
    title="dom-provider-getChildAtPosition">getChildAtPosition(<var
    title="">row</var>, <var title="">i</var>)</code></strong>: The
    default data provider must return the mapping appropriate to the
    <a href="#defaultDataProviderTableSort">current sort
    order</a>.</p>

    <p><strong><code
    title="dom-provider-getColumnCount">getColumnCount()</code></strong>:
    The number of columns returned must be the number of
    <code>td</code> element children in the first <code>tr</code>
    element child of the first <code>tbody</code> element child of the
    <code>table</code>, if there are any such <code>tbody</code>
    elements. If there are no such <code>tbody</code> elements, then
    it must be the number of <code>td</code> element children in the
    first <code>tr</code> element child of the <code>table</code>, if
    any, or otherwise 1. If the number that would be returned by these
    rules is 0, then 1 must be returned instead.</p>

    <p><strong><code
    title="dom-provider-getCaptionText">getCaptionText(<var
    title="">i</var>)</code></strong>: If the <code>table</code> has
    no <code>thead</code> element child, or if its first
    <code>thead</code> element child has no <code>tr</code> element
    child, the default data provider must return the empty string for
    all captions. Otherwise, the value of the <code>textContent</code>
    attribute of the <var title="">i</var>th <code>th</code> element
    child of the first <code>tr</code> element child of the first
    <code>thead</code> element child of the <code>table</code> element
    must be returned. If there is no such <code>th</code> element, the
    empty string must be returned.</p>

    <p><strong><code
    title="dom-provider-getCaptionClasses">getCaptionClasses(<var
    title="">i</var>, <var title="">classes</var>)</code></strong>: If
    the <code>table</code> has no <code>thead</code> element child, or
    if its first <code>thead</code> element child has no
    <code>tr</code> element child, the default data provider must not
    add any classes for any of the captions. Otherwise, each class
    in the <code title="attr-class">class</code> attribute of the <var
    title="">i</var>th <code>th</code> element child of the first
    <code>tr</code> element child of the first <code>thead</code>
    element child of the <code>table</code> element must be added to
    the <var title="">classes</var>. If there is no such
    <code>th</code> element, no classes must be added. The user agent
    must then:</p>

    <ol>

     <li>Remove the <code
     title="datagrid-column-class-sorted">sorted</code> and <code
     title="datagrid-column-class-reversed">reversed</code>
     classes.</li>

     <li>If the <code>table</code> element has a <code
     title="attr-class">class</code> attribute that includes the <code
     title="">sortable</code> class, add the <code
     title="datagrid-column-class-sortable">sortable</code>
     class.</li>

     <li>If the column is the one currently being used to
     sort the data, add the <code
     title="datagrid-column-class-sorted">sorted</code> class.</li>

     <li>If the column is the one currently being used to sort the
     data, and it is sorted in descending order, add the <code
     title="datagrid-column-class-reversed">reversed</code> class as
     well.</li>

    </ol>

    <p>The various row- and cell- related methods operate relative to
    a particular element, the element of the row or cell specified by
    their arguments.</p>

    <p><strong>For rows</strong>: Since the default data provider for
    a <code>table</code> always returns 0 as the number of children
    for any row other than the root, the path to the row passed to
    these methods will always consist of a single number. In the prose
    below, this number is referred to as <var title="">i</var>.</p>

    <p>If the <code>table</code> has <code>tbody</code> element
    children, the element for the <var title="">i</var>th row is the
    <var title="">i</var>th <code>tr</code> element that is a child of
    a <code>tbody</code> element that is a child of the
    <code>table</code> element. If the <code>table</code> does not
    have <code>tbody</code> element children, then the element for the
    <var title="">i</var>th real row is the <var title="">i</var>th
    <code>tr</code> element that is a child of the <code>table</code>
    element.</p>

    <p><strong>For cells</strong>: Given a row and its element, the
    row's <var title="">i</var>th cell's element is the <var
    title="">i</var>th <code>td</code> element child of the row
    element.</p>

    <p class="note">The <code>colspan</code> and <code>rowspan</code>
    attributes are <span title="ignore">ignored</span> by this
    algorithm.</p>

    <p><strong><code title="dom-provider-getRowImage">getRowImage(<var
    title="">i</var>)</code></strong>: If the row's first cell's
    element has an <code>img</code> element child, then the URI of the
    row's image is the URI of the first <code>img</code> element child
    of the row's first cell's element. Otherwise, the URI of the row's
    image is the empty string.</p><!-- XXX well. that sentence could
    have gone better, that's for sure. -->

    <p><strong><code title="dom-provider-getRowMenu">getRowMenu(<var
    title="">i</var>)</code></strong>: If the row's first cell's
    element has a <code>menu</code> element child, then the row's menu
    is the first <code>menu</code> element child of the row's first
    cell's element. Otherwise, the row has no menu.</p>

    <p><strong><code
    title="dom-provider-getRowClasses">getRowClasses(<var
    title="">i</var>, <var title="">classes</var>)</code></strong>:
    The default data provider must never add a class to the row's
    classes.</p>

    <p id="defaultDataProviderTableSort"><strong><code
    title="dom-provider-toggleColumnSortState">toggleColumnSortState(<var
    title="">i</var>)</code></strong>: If the data is already being
    sorted on the given column, then the user agent must change the
    current sort mapping to be the inverse of the current sort
    mapping; if the sort order was ascending before, it is now
    descending, otherwise it is now ascending. Otherwise, if the
    current sort column is another column, or the data model is
    currently not sorted, the user agent must create a new mapping,
    which maps rows in the data model to rows in the DOM so that the
    rows in the data model are sorted by the specified column, in
    ascending order. (Which sort comparison operator to use is left up
    to the UA to decide.)</p>

    <p>When the sort mapping is changed, the values returned by the
    <code
    title="dom-provider-getChildAtPosition">getChildAtPosition()</code>
    method for the default data provider <a
    href="#defaultDataProviderTableMapper">will change
    appropriately</a>.</p>

    <p><strong><code title="dom-provider-getCellData">getCellData(<var
    title="">i</var>, <var title="">j</var>)</code>, <code
    title="dom-provider-getCellClasses">getCellClasses(<var
    title="">i</var>, <var title="">j</var>, <var
    title="">classes</var>)</code>, <code
    title="dom-provider-setCellCheckedState">getCellCheckedState(<var
    title="">i</var>, <var title="">j</var>, <var
    title="">state</var>)</code>, <code
    title="dom-provider-cycleCell">cycleCell(<var title="">i</var>,
    <var title="">j</var>)</code>, and <code
    title="dom-provider-editCell">editCell(<var title="">i</var>,
    <var title="">j</var>, <var title="">data</var>)</code></strong>:
    See <a href="#commonDefaultDataGridMethodDefinitions">the common
    definitions below</a>.</p>

    <p>The data provider must call the <code>datagrid</code>'s update
    methods appropriately whenever the descendants of the
    <code>datagrid</code> mutate. For example, if a <code>tr</code> is
    removed, then the <code
    title="dom-datagrid-updateRowsRemoved">updateRowsRemoved()</code>
    methods would probably need to be invoked, and any change to a
    cell or its descendants must cause the cell to be updated. If the
    <code>table</code> element stops being the first child of the
    <code>datagrid</code>, then the data provider must call the <code
    title="dom-datagrid-updateEverything">updateEverything()</code>
    method on the <code>datagrid</code>. Any change to a cell that is
    in the column that the data provider is currently using as its
    sort column must also cause the sort to be reperformed, with a
    call to <code
    title="dom-datagrid-updateEverything">updateEverything()</code> if
    the change did affect the sort order.</p>

   </dd>


   <dt>While the first element child is a <code>select</code></dt>

   <dd>

    <p>The default data provider must return 1 for the column count,
    the empty string for the column's caption, and must not add any
    classes to the column's classes.</p>

    <p>For the rows, assume the existence of a node filter view of the
    descendants of the first <code>select</code> element child of the
    <code>datagrid</code> element, that skips all nodes other than
    <code>optgroup</code> and <code>option</code> elements, as well as
    any descendents of any <code>option</code> elements.</p>

    <p>Given a path <var title="">row</var>, the corresponding element
    is the one obtained by drilling into the view, taking the child
    given by the path each time.</p>

    <div class="example">

     <p>Given the following XML markup:</p>

     <pre>&lt;datagrid>
 &lt;select>
  &lt;!-- the options and optgroups have had their labels and values removed
       to make the underlying structure clearer -->
  &lt;optgroup>
   &lt;option/>
   &lt;option/>
  &lt;/optgroup>
  &lt;optgroup>
   &lt;option/>
   &lt;optgroup id="a">
    &lt;option/>
    &lt;option/>
    &lt;bogus/>
    &lt;option id="b"/>
   &lt;/optgroup>
   &lt;option/>
  &lt;/optgroup>
 &lt;/select>
&lt;/datagrid></pre>

     <p>The path "1,1,2" would select the element with ID "b". In the
     filtered view, the text nodes, comment nodes, and bogus elements
     are ignored; so for instance, the element with ID "a" (path
     "1,1") has only 3 child nodes in the view.</p>

    </div>

    <p><code title="dom-provider-getRowCount">getRowCount(<var
    title="">row</var>)</code> must drill through the view to find the
    element corresponding to the method's argument, and return the
    number of child nodes in the filtered view that the corresponding
    element has. (If the <var title="">row</var> is empty, the
    corresponding element is the <code>select</code> element at the
    root of the filtered view.)</p>

    <p><code
    title="dom-provider-getChildAtPosition">getChildAtPosition(<var
    title="">row</var>, <var title="">position</var>)</code> must
    return <var title="">position</var>. (The <code>select</code>
    default data provider does not support sorting the data grid.)</p>

    <p><code title="dom-provider-getRowImage">getRowImage(<var
    title="">i</var>)</code> must return the empty string, <code
    title="dom-provider-getRowMenu">getRowMenu(<var
    title="">i</var>)</code> must return null.</p>

    <p><code title="dom-provider-getRowClasses">getRowClasses(<var
    title="">row</var>, <var title="">classes</var>)</code> must add the
    classes from the following list to <var title="">classes</var>
    when their condition is met:</p>

    <ul>

     <li>If the <var title="">row</var>'s corresponding element is an
     <code>optgroup</code> element: <code
     title="datagrid-row-class-header">header</code></li>

     <li>If the <var title="">row</var>'s corresponding element
     contains other elements that are also in the view, and the
     element's <code title="attr-class">class</code> attribute
     contains the <code title="">closed</code> class: <code
     title="datagrid-row-class-initially-closed">initially-closed</code></li>

     <li>If the <var title="">row</var>'s corresponding element
     contains other elements that are also in the view, and the
     element's <code title="attr-class">class</code> attribute
     contains the <code title="">open</code> class: <code
     title="datagrid-row-class-initially-open">initially-open</code></li>

    </ul>

    <p>The <code title="dom-provider-getCellData">getCellData(<var
    title="">row</var>, <var title="">cell</var>)</code> method must
    return the value of the <code
    title="attr-optgroup-label">label</code> attribute if the <var
    title="">row</var>'s corresponding element is an
    <code>optgroup</code> element, otherwise, if the <var
    title="">row</var>'s corresponding element is an
    <code>option</code>element, its <code
    title="attr-option-label">label</code> attribute if it has one,
    otherwise the value of its <code>textContent</code> DOM
    attribute.</p>

    <p>The <code
    title="dom-provider-getCellClasses">getCellClasses(<var
    title="">row</var>, <var title="">cell</var>, <var
    title="">classes</var>)</code> method must add no classes.</p>

    <p class="big-issue"><!-- select-provider-selection
    XXX-->autoselect some rows when initialised, reflect the selection
    in the select, reflect the multiple attribute somehow.</p>

    <p>The data provider must call the <code>datagrid</code>'s update
    methods appropriately whenever the descendants of the
    <code>datagrid</code> mutate.</p>

   </dd>


   <dt>While the first element child is another element</dt>

   <dd>

    <p>The default data provider must return 1 for the column count,
    the empty string for the column's caption, and must not add any
    classes to the column's classes.</p>

    <p>For the rows, assume the existence of a node filter view of the
    descendants of the <code>datagrid</code> that skips all nodes
    other than <code>li</code>, <code>h1</code>-<code>h6</code>, and
    <code>hr</code> elements, and skips any descendants of
    <code>menu</code> elements.</p>

    <p>Given this view, each element in the view represents a row in
    the data model. The element corresponding to a path <var
    title="">row</var> is the one obtained by drilling into the view,
    taking the child given by the path each time. The element of the
    row of a particular method call is the element given by drilling
    into the view along the path given by the method's arguments.</p>

    <p><code title="dom-provider-getRowCount">getRowCount(<var
    title="">row</var>)</code> must return the number of child
    elements in this view for the given row, or the number of elements
    at the root of the view if the <var title="">row</var> is
    empty.</p>

    <div class="example">

     <p>In the following example, the elements are identified by the
     paths given by their child text nodes:</p>

     <pre>&lt;datagrid>
 &lt;ol>
  &lt;li> row 0 &lt;/li>
  &lt;li> row 1
   &lt;ol>
    &lt;li> row 1,0 &lt;/li>
   &lt;/ol>
  &lt;/li>
  &lt;li> row 2 &lt;/li>
 &lt;/ol>
&lt;/datagrid></pre>

     <p>In this example, only the <code>li</code> elements actually
     appear in the data grid; the <code>ol</code> element does not
     affect the data grid's processing model.</p>

    </div>

    <p><code
    title="dom-provider-getChildAtPosition">getChildAtPosition(<var
    title="">row</var>, <var title="">position</var>)</code> must
    return <var title="">position</var>. (The generic default data
    provider does not support sorting the data grid.)</p>

    <p><code title="dom-provider-getRowImage">getRowImage(<var
    title="">i</var>)</code> must return the URI of the image given by
    the first <code>img</code> element descendant (in the real DOM) of
    the row's element, that is not also a descendant of another
    element in the filtered view that is a descendant of the row's
    element.</p>

    <div class="example">

     <p>In the following example, the row with path "1,0" returns
     "http://example.com/a" as its image URI, and the other rows
     (including the row with path "1") return the empty string:</p>

     <pre>&lt;datagrid>
 &lt;ol>
  &lt;li> row 0 &lt;/li>
  &lt;li> row 1
   &lt;ol>
    &lt;li> row 1,0 &lt;img src="http://example.com/a" alt=""> &lt;/li>
   &lt;/ol>
  &lt;/li>
  &lt;li> row 2 &lt;/li>
 &lt;/ol>
&lt;/datagrid></pre>

    </div>

    <p><code title="dom-provider-getRowMenu">getRowMenu(<var
    title="">i</var>)</code> must return the first <code>menu</code>
    element descendant (in the real DOM) of the row's element, that is
    not also a descendant of another element in the filtered view that
    is a decsendant of the row's element. (This is analogous to the
    image case above.)</p>

    <p><code title="dom-provider-getRowClasses">getRowClasses(<var
    title="">i</var>, <var title="">classes</var>)</code> must add the
    classes from the following list to <var title="">classes</var>
    when their condition is met:</p>

    <ul>

     <li>If the row's element contains other elements that are also in
     the view, and the element's <code title="attr-class">class</code>
     attribute contains the <code title="">closed</code> class: <code
     title="datagrid-row-class-initially-closed">initially-closed</code></li>

     <li>If the row's element contains other elements that are also in
     the view, and the element's <code title="attr-class">class</code>
     attribute contains the <code title="">open</code> class: <code
     title="datagrid-row-class-initially-open">initially-open</code></li>

     <li>If the row's element is an <code>h1</code>-<code>h6</code>
     element: <code
     title="datagrid-row-class-header">header</code></li>

     <li>If the row's element is an <code>hr</code> element: <code
     title="datagrid-row-class-separator">separator</code></li> <!--
     XXX no way to get selectable-separator -->

    </ul>

    <p>The <code title="dom-provider-getCellData">getCellData(<var
    title="">i</var>, <var title="">j</var>)</code>, <code
    title="dom-provider-getCellClasses">getCellClasses(<var
    title="">i</var>, <var title="">j</var>, <var
    title="">classes</var>)</code>, <code
    title="dom-provider-setCellCheckedState">getCellCheckedState(<var
    title="">i</var>, <var title="">j</var>, <var
    title="">state</var>)</code>, <code
    title="dom-provider-cycleCell">cycleCell(<var title="">i</var>,
    <var title="">j</var>)</code>, and <code
    title="dom-provider-editCell">editCell(<var title="">i</var>, <var
    title="">j</var>, <var title="">data</var>)</code> methods must
    act as described in <a
    href="#commonDefaultDataGridMethodDefinitions">the common
    definitions below</a>, treating the row's element as being the
    cell's element.</p>

    <p class="big-issue" id="generic-provider-selection">selection
    handling?</p>

    <p>The data provider must call the <code>datagrid</code>'s update
    methods appropriately whenever the descendants of the
    <code>datagrid</code> mutate.</p>

   </dd>


   <dt>Otherwise, while there is no element child</dt>

   <dd>

    <p>The data provider must return 0 for the number of rows, 1 for
    the number of columns, the empty string for the first column's
    caption, and must add no classes when asked for that column's
    classes. If the <code>datagrid</code>'s child list changes such
    that there is a first element child, then the data provider must
    call the <code
    title="dom-datagrid-updateEverything">updateEverything()</code>
    method on the <code>datagrid</code>.</p>

   </dd>

  </dl>

  <h6 id="commonDefaultDataGridMethodDefinitions">Common default data
  provider method definitions for cells</h6>

  <p>These definitions are used for the cell-specific methods of the
  default data providers (other than in the <code>select</code> case).
  How they behave is based on the contents of an element that
  represents the cell given by their first two arguments. Which
  element that is is defined in the previous section.</p>

  <dl>

   <dt>Cyclable cells</dt>

   <dd>

    <p>If the first element child of a cell's element is a
    <code>select</code> element that has a no <code
    title="attr-select-multiple">multiple</code> attribute and has at
    least one <code>option</code> element descendent, then the cell
    acts as a cyclable cell.</p>

    <p>The "current" <code>option</code> element is the selected
    <code>option</code> element, or the first <code>option</code>
    element if none is selected.</p>

    <p>The <code title="dom-provider-getCellData">getCellData()</code>
    method must return the <code>textContent</code> of the current
    <code>option</code> element (the <code
    title="attr-option-label">label</code> attribute is <span
    title="ignore">ignored</span> in this context as the
    <code>optgroup</code>s are not displayed).</p>

    <p>The <code
    title="dom-provider-getCellClasses">getCellClasses()</code> method
    must add the <code
    title="datagrid-cell-class-cyclable">cyclable</code> class and
    then all the classes of the current <code>option</code>
    element.</p>

    <p>The <code title="dom-provider-cycleCell">cycleCell()</code>
    method must change the selection of the <code>select</code>
    element such that the next <code>option</code> element after the
    current <code>option</code> element is the only one that is
    selected (in <span>tree order</span>). If the current <code>option</code>
    element is the last <code>option</code> element descendent of the
    <code>select</code>, then the first <code>option</code> element
    descendent must be selected instead.</p>

    <p>The <code
    title="dom-provider-setCellCheckedState">setCellCheckedState()</code>
    and <code title="dom-provider-editCell">editCell()</code> methods
    must do nothing.</p>

   </dd>

   <dt>Progress bar cells</dt>

   <dd>

    <p>If the first element child of a cell's element is a
    <code>progress</code> element, then the cell acts as a progress
    bar cell.</p>

    <p>The <code title="dom-provider-getCellData">getCellData()</code>
    method must return the value returned by the <code>progress</code>
    element's <code title="dom-progress-position">position</code> DOM
    attribute.</p>

    <p>The <code
    title="dom-provider-getCellClasses">getCellClasses()</code> method
    must add the <code
    title="datagrid-cell-class-progress">progress</code> class.</p>

    <p>The <code
    title="dom-provider-setCellCheckedState">setCellCheckedState()</code>,
    <code title="dom-provider-cycleCell">cycleCell()</code>, and
    <code title="dom-provider-editCell">editCell()</code> methods must
    do nothing.</p>

   </dd>

   <dt>Checkbox cells</dt>

   <dd>

    <p>If the first element child of a cell's element is an
    <code>input</code> element that has a <code
    title="attr-input-type">type</code> attribute with the value <code
    title="">checkbox</code>, then the cell acts as a check box
    cell.</p>

    <p>The <code title="dom-provider-getCellData">getCellData()</code>
    method must return the <code>textContent</code> of the cell
    element.</p>

    <p>The <code
    title="dom-provider-getCellClasses">getCellClasses()</code> method
    must add the <code
    title="datagrid-cell-class-checked">checked</code> class if the
    <code>input</code> element is <span
    title="dom-input-checked">checked</span>, and the <code
    title="datagrid-cell-class-unchecked">unchecked</code> class
    otherwise.</p>

    <p>The <code
    title="dom-provider-setCellCheckedState">setCellCheckedState()</code>
    method must set the <code>input</code> element's checkbox <span
    title="dom-input-checked">state</span> to checked if the method's
    third argument is 1, and to unchecked otherwise.</p>

    <p>The <code title="dom-provider-cycleCell">cycleCell()</code> and
    <code title="dom-provider-editCell">editCell()</code> methods must
    do nothing.</p>

   </dd>

   <dt>Editable cells</dt>

   <dd>

    <p>If the first element child of a cell's element is an
    <code>input</code> element that has a <code
    title="attr-input-type">type</code> attribute with the value <code
    title="">text</code> or that has no <code
    title="attr-input-type">type</code> attribute at all, then the
    cell acts as an editable cell.</p>

    <p>The <code title="dom-provider-getCellData">getCellData()</code>
    method must return the <code title="dom-input-value">value</code>
    of the <code>input</code> element.</p>

    <p>The <code
    title="dom-provider-getCellClasses">getCellClasses()</code> method
    must add the <code
    title="datagrid-cell-class-editable">editable</code> class.</p>

    <p>The <code title="dom-provider-editCell">editCell()</code>
    method must set the <code>input</code> element's <code
    title="dom-input-value">value</code> DOM attribute to the value of
    the third argument to the method.</p>

    <p>The <code
    title="dom-provider-setCellCheckedState">setCellCheckedState()</code>
    and <code title="dom-provider-cycleCell">cycleCell()</code>
    methods must do nothing.</p>

   </dd>

  </dl>

  <!-- XXX Calculated cells, like in spreadsheets? -->


  <h5>Populating the <code>datagrid</code> element</h5>

  <p>A <code>datagrid</code> must be disabled until its end tag has
  been parsed (in the case of a <code>datagrid</code> element in the
  original document markup) or until it has been inserted into the
  document (in the case of a dynamically created element). After that
  point, the element must fire a single <code
  title="event-load">load</code> event at itself, which doesn't bubble
  and cannot be canceled.</p>

  <p class="big-issue">The end-tag parsing thing should be moved to
  the parsing section.</p>

  <p>The <code>datagrid</code> must then populate itself using the
  data provided by the data provider assigned to the <code
  title="dom-datagrid-data">data</code> DOM attribute. After the view
  is populated (using the methods described below), the
  <code>datagrid</code> must invoke the <code
  title="dom-provider-initialize">initialize()</code> method on the
  data provider specified by the <code
  title="dom-datagrid-data">data</code> attribute, passing itself (the
  <code>HTMLDataGridElement</code> object) as the only argument.</p>

  <p>When the <code title="dom-datagrid-data">data</code> attribute is
  null, the <code>datagrid</code> must use the default data provider
  described in the previous section.</p>

  <p>To obtain data from the data provider, the element must invoke
  methods on the data provider object in the following ways:</p>

  <dl>

   <dt>To determine the total number of columns</dt>

   <dd>Invoke the <code
   title="dom-provider-getColumnCount">getColumnCount()</code> method
   with no arguments. The return value is the number of columns. If
   the return value is zero or negative, not an integer, or simply not
   a numeric type, or if the method is not defined, then 1 must be
   used instead.</dd>

   <dt>To get the captions to use for the columns</dt>

   <dd>Invoke the <code
   title="dom-provider-getCaptionText">getCaptionText()</code> method
   with the index of the column in question. The index <var
   title="">i</var> must be in the range 0 &le; <var title="">i</var>
   &lt; <var title="">N</var>, where <var title="">N</var> is the
   total number of columns. The return value is the string to use when
   referring to that column. If the method returns null or the empty
   string, the column has no caption. If the method is not defined,
   then none of the columns have any captions.</dd>

   <dt>To establish what classes apply to a column</dt>

   <dd>Invoke the <code
   title="dom-provider-getCaptionClasses">getCaptionClasses()</code>
   method with the index of the column in question, and an object
   implementing the <code>DOMTokenList</code> interface, associated
   with an anonymous empty string. The index <var title="">i</var>
   must be in the range 0 &le; <var title="">i</var> &lt; <var
   title="">N</var>, where <var title="">N</var> is the total number
   of columns. The tokens contained in the string underlying
   <code>DOMTokenList</code> object when the method returns represent
   the classes that apply to the given column. If the method is not
   defined, no classes apply to the column.</dd>

   <dt>To establish whether a column should be initially included in
   the visible columns</dt>

   <dd>Check whether the <code
   title="datagrid-column-class-initially-hidden">initially-hidden</code>
   class applies to the column. If it does, then the column should not
   be initially included; if it does not, then the column should be
   initially included.</dd>

   <dt id="columnType2">To establish whether the data can be sorted
   relative to a particular column</dt>

   <dd>Check whether the <code
   title="datagrid-column-class-sortable">sortable</code> class
   applies to the column. If it does, then the user should be able to
   ask the UA to display the data sorted by that column; if it does
   not, then the user agent must not allow the user to ask for the
   data to be sorted by that column.</dd>

   <dt>To establish if a column is a sorted column</dt>

   <dd>If the user agent can handle multiple columns being marked as
   sorted simultaneously: Check whether the <code
   title="datagrid-column-class-sorted">sorted</code> class applies to
   the column. If it does, then that column is the sorted column,
   otherwise it is not.</dd>

   <dd>If the user agent can only handle one column being marked as
   sorted at a time: Check each column in turn, starting with the
   first one, to see whether the <code
   title="datagrid-column-class-sorted">sorted</code> class applies to
   that column. The first column that has that class, if any, is the
   sorted column. If none of the columns have that class, there is no
   sorted column.</dd>

   <dt>To establish the sort direction of a sorted column</dt>

   <dd>Check whether the <code
   title="datagrid-column-class-reversed">reversed</code> class
   applies to the column. If it does, then the sort direction is
   descending (down; first rows have the highest values), otherwise it
   is ascending (up; first rows have the lowest values).</dd>

   <dt>To determine the total number of rows</dt>

   <dd>Determine the number of rows for the root of the data grid, and
   determine the number of child rows for each open row. The total
   number of rows is the sum of all these numbers.</dd>

   <dt>To determine the number of rows for the root of the data grid</dt>

   <dd>Invoke the <code
   title="dom-provider-getRowCount">getRowCount()</code> method with a
   <code>RowSpecification</code> object representing the empty path as
   its only argument. The return value is the number of rows at the
   top level of the data grid. If the return value of the method is
   negative, not an integer, or simply not a numeric type, or if the
   method is not defined, then zero must be used instead.</dd>

   <dt>To determine the number of child rows for a row</dt>

   <dd>Invoke the <code
   title="dom-provider-getRowCount">getRowCount()</code> method with a
   <code>RowSpecification</code> object representing the path to the
   row in question. The return value is the number of child rows for
   the given row. If the return value of the method is negative, not
   an integer, or simply not a numeric type, or if the method is not
   defined, then zero must be used instead.</dd>

   <dt>To determine what order to render rows in</dt>

   <dd>

    <p>Invoke the <code
    title="dom-provider-getChildAtPosition">getChildAtPosition()</code>
    method with a <code>RowSpecification</code> object representing
    the path to the parent of the rows that are being rendered as the
    first argument, and the position that is being rendered as the
    second argument. The return value is the index of the row to
    render in that position.</p>

    <div class="example">

     <p>If the rows are:</p>

     <ol>
      <li> Row "0"
       <ol>
        <li> Row "0,0"
        <li> Row "0,1"
       </ol>
      </li>
      <li> Row "1"
       <ol>
        <li> Row "1,0"
        <li> Row "1,1"
       </ol>
      </li>
     </ol>

     <p>...and the <code
    title="dom-provider-getChildAtPosition">getChildAtPosition()</code>
    method is implemented as follows:</p>

    <pre>function getChildAtPosition(parent, child) {
  // always return the reverse order
  return getRowCount(parent)-child-1;
}</pre>

     <p>...then the rendering would actually be:</p>

     <ol>
      <li> Row "1"
       <ol>
        <li> Row "1,1"
        <li> Row "1,0"
       </ol>
      </li>
      <li> Row "0"
       <ol>
        <li> Row "0,1"
        <li> Row "0,0"
       </ol>
      </li>
     </ol>

    </div>

    <p>If the return value of the method is negative, larger than the
    number of rows that the <code
    title="dom-provider-getRowCount">getRowCount()</code> method
    reported for that parent, not an integer, or simply not a numeric
    type, then the entire data grid should be disabled. Similarly, if
    the method returns the same value for two or more different values
    for the second argument (with the same first argument, and
    assuming that the data grid hasn't had relevant update methods
    invoked in the meantime), then the data grid should be
    disabled. Instead of disabling the data grid, the user agent may
    act as if the <code
    title="dom-provider-getChildAtPosition">getChildAtPosition()</code>
    method was not defined on the data provider (thus disabling
    sorting for that data grid, but still letting the user interact
    with the data). If the method is not defined, then the return
    value must be assumed to be the same as the second argument (an
    indentity transform; the data is rendered in its natural
    order).</p>

   </dd>

   <dt>To establish what classes apply to a row</dt>

   <dd>Invoke the <code
   title="dom-provider-getRowClasses">getRowClasses()</code> method
   with a <code>RowSpecification</code> object representing the row in
   question, and a <code>DOMTokenList</code> associated with an empty
   string. The tokens contained in the <code>DOMTokenList</code>
   object's underlying string when the method returns represent the
   classes that apply to the row in question. If the method is not
   defined, no classes apply to the row.</dd>

   <dt>To establish whether a row is a data row or a special row</dt>

   <dd>Examine the classes that apply to the row. If the <code
   title="datagrid-row-class-header">header</code> class applies to
   the row, then it is not a data row, it is a subheading. The data
   from the first cell of the row is the text of the subheading, the
   rest of the cells must be ignored. Otherwise, if the <code
   title="datagrid-row-class-separator">separator</code> class applies
   to the row, then in the place of the row, a separator should be
   shown. Otherwise, if the <code
   title="datagrid-row-class-selectable-separator">selectable-separator</code>
   class applies to the row, then the row should be a data row, but
   represented as a separator. (The difference between a <code
   title="datagrid-row-class-separator">separator</code> and a <code
   title="datagrid-row-class-selectable-separator">selectable-separator</code>
   is that the former is not an item that can be actually selected,
   whereas the second can be selected and thus has a context menu that
   applies to it, and so forth.) For both kinds of separator rows, the
   data of the rows' cells must all be ignored. If none of those three
   classes apply then the row is a simple data row.</dd>

   <dt id="rowType1">To establish whether a row is openable</dt>

   <dd>Determine the number of child rows for that row. If there are
   one or more child rows, then the row is openable.</dd>

   <dt>To establish whether a row should be initially open or closed</dt>

   <dd>If <a href="#rowType1">the row is openable</a>, examine the
   classes that apply to the row. If the <code
   title="datagrid-row-class-initially-open">initially-open</code>
   class applies to the row, then it should be initially
   open. Otherwise, if the <code
   title="datagrid-row-class-initially-closed">initially-closed</code>
   class applies to the row, then it must be initially
   closed. Otherwise, if neither class applies to the row, or if the
   row is not openable, then the initial state of the row is entirely
   up to the UA.</dd>

<!-- XXXPA
   <dt>To establish whether a row is deletable</dt>

   <dd>Check whether the <code
   title="datagrid-row-class-deletable">deletable</code> class applies
   to the row. If it does, the row is deletable, and interactive user
   agents should provide a way for the user to request that the row be
   deleted. (See the <code
   title="dom-provider-performActionOnRow">performActionOnRow()</code>
   method for more details.) Otherwise, the user agent should not
   provide the user with a method for requesting that the row be
   deleted.</dd>
-->
   <dt>To obtain a URI to an image representing a row</dt>

   <dd>Invoke the <code
   title="dom-provider-getRowImage">getRowImage()</code> method with a
   <code>RowSpecification</code> object representing the row in
   question. The return value is a string representing a URI (or IRI)
   to an image. Relative URIs must be interpreted relative to the
   <code>datagrid</code>'s base URI. If the method returns the empty
   string, null, or if the method is not defined, then the row has no
   associated image.</dd>

   <dt>To obtain a context menu appropriate for a particular row</dt>

   <dd>Invoke the <code
   title="dom-provider-getRowMenu">getRowMenu()</code> method with a
   <code>RowSpecification</code> object representing the row in
   question. The return value is a reference to an object implementing
   the <code>HTMLMenuElement</code> interface, i.e. a
   <code>menu</code> element DOM node. (This element must then be
   interpreted as described in the section on context menus to obtain
   the actual context menu to use.<!-- XXXX update once menu section
   works; with xrefs -->) If the method returns something that is not
   an <code>HTMLMenuElement</code>, or if the method is not defined,
   then the row has no associated context menu. User agents may
   provide their own default context menu, and may add items to the
   author-provided context menu. For example, such a menu could allow
   the user to change the presentation of the <code>datagrid</code>
   element.</dd>

   <dt>To establish the value of a particular cell</dt>

   <dd>Invoke the <code
   title="dom-provider-getCellData">getCellData()</code> method with
   the first argument being a <code>RowSpecification</code> object
   representing the row of the cell in question and the second
   argument being the index of the cell's column. The second argument
   must be a non-negative integer less than the total number of
   columns. The return value is the value of the cell. If the return
   value is null or the empty string, or if the method is not defined,
   then the cell has no data. (For progress bar cells, the cell's
   value must be further interpreted, as described below.)</dd>

   <dt>To establish what classes apply to a cell</dt>

   <dd>Invoke the <code
   title="dom-provider-getCellClasses">getCellClasses()</code> method
   with the first argument being a <code>RowSpecification</code>
   object representing the row of the cell in question, the second
   argument being the index of the cell's column, and the third being
   an object implementing the <code>DOMTokenList</code> interface,
   associated with an empty string. The second argument must be a
   non-negative integer less than the total number of columns. The
   tokens contained in the <code>DOMTokenList</code> object's
   underlying string when the method returns represent the classes
   that apply to that cell. If the method is not defined, no classes
   apply to the cell.</dd>

   <dt id="cellType1">To establish how the type of a cell</dt>

   <dd>Examine the classes that apply to the cell. If the <code
   title="datagrid-cell-class-progress">progress</code> class applies
   to the cell, it is a progress bar. Otherwise, if the <code
   title="datagrid-cell-class-cyclable">cyclable</code> class applies
   to the cell, it is a cycling cell whose value can be cycled between
   multiple states. Otherwise, none of these classes apply, and the
   cell is a simple text cell.</dd>

   <dt>To establish the value of a progress bar cell</dt>

   <dd>If the value <var title="">x</var> of the cell is a string that
   can be <span title="rules for parsing floating point number
   values">converted to a floating-point number</span> in the range
   0.0&nbsp;&le;&nbsp;<var title="">x</var>&nbsp;&le;&nbsp;1.0, then
   the progress bar has that value (0.0 means no progress, 1.0 means
   complete). Otherwise, the progress bar is an indeterminate progress
   bar.</dd>

   <dt id="cellType2">To establish how a simple text cell should be presented</dt>

   <dd>Check whether one of the <code
   title="datagrid-cell-class-checked">checked</code>, <code
   title="datagrid-cell-class-unchecked">unchecked</code>, or <code
   title="datagrid-cell-class-indeterminate">indeterminate</code>
   classes applies to the cell. If any of these are present, then the
   cell has a checkbox, otherwise none are present and the cell does
   not have a checkbox. If the cell has no checkbox, check whether the
   <code title="datagrid-cell-class-editable">editable</code> class
   applies to the cell. If it does, then the cell value is editable,
   otherwise the cell value is static.</dd>

   <dt>To establish the state of a cell's checkbox, if it has one</dt>

   <dd>Check whether the <code
   title="datagrid-cell-class-checked">checked</code> class applies to
   the cell. If it does, the cell is checked. Otherwise, check whether
   the <code title="datagrid-cell-class-unchecked">unchecked</code>
   class applies to the cell. If it does, the cell is unchecked.
   Otherwise, the <code
   title="datagrid-cell-class-indeterminate">indeterminate</code>
   class appplies to the cell and the cell's checkbox is in an
   indeterminate state. When the <code
   title="datagrid-cell-class-indeterminate">indeterminate</code>
   class appplies to the cell, the checkbox is a tristate checkbox,
   and the user can set it to the indeterminate state. Otherwise, only
   the <code title="datagrid-cell-class-checked">checked</code> and/or
   <code title="datagrid-cell-class-unchecked">unchecked</code>
   classes apply to the cell, and the cell can only be toggled betwen
   those two states.</dd>

  </dl>

  <p>If the data provider ever raises an exception while the
  <code>datagrid</code> is invoking one of its methods, the
  <code>datagrid</code> must act, for the purposes of that particular
  method call, as if the relevant method had not been defined.</p>

  <p>A <code>RowSpecification</code> object <var title="">p</var> with
  <var title="">n</var> path components passed to a method of the data
  provider must fulfill the constraint <span>0&nbsp;&le;&nbsp;<var
  title="">p<sub title=""><var
  title="">i</var></sub></var>&nbsp;&lt;&nbsp;<var
  title="">m</var>-1</span> for all integer values of <var
  title="">i</var> in the range <span>0&nbsp;&le;&nbsp;<var
  title="">i</var>&nbsp;&lt;&nbsp;<var title="">n</var>-1</span>,
  where <var title="">m</var> is the value that was last returned by
  the <code title="dom-provider-getRowCount">getRowCount()</code>
  method when it was passed the <code>RowSpecification</code> object
  <var title="">q</var> with <span><var title="">i</var>-1</span>
  items, where <span><var title="">p<sub title=""><var
  title="">i</var></sub></var>&nbsp;=&nbsp;<var title="">q<sub
  title=""><var title="">i</var></sub></var></span> for all integer
  values of <var title="">i</var> in the range
  <span>0&nbsp;&le;&nbsp;<var title="">i</var>&nbsp;&lt;&nbsp;<var
  title="">n</var>-1</span>, with any changes implied by the update
  methods taken into account.</p>

  <p id="inconsistentDataProvider">The data model is considered
  stable: user agents may assume that subsequent calls to the data
  provider methods will return the same data, until one of the update
  methods is called on the <code>datagrid</code> element. If a user
  agent is returned inconsistent data, for example if the number of
  rows returned by <code
  title="dom-provider-getRowCount">getRowCount()</code> varies in ways
  that do not match the calls made to the update methods, the user
  agent may disable the <code>datagrid</code>. User agents that do not
  disable the <code>datagrid</code> in inconsistent cases must honour
  the most recently returned values.</p>

  <p>User agents may cache returned values so that the data provider
  is never asked for data that could contradict earlier data. User
  agents must not cache the return value of the <code
  title="dom-provider-getRowMenu">getRowMenu</code> method.</p>

  <p>The exact algorithm used to populate the data grid is not defined
  here, since it will differ based on the presentation used. However,
  the behaviour of user agents must be consistent with the
  descriptions above. For example, it would be non-conformant for a
  user agent to make cells have both a checkbox and be editable, as
  the descriptions above state that cells that have a checkbox cannot
  be edited.</p> <!-- XXX speaking of which, do we actually want that
  limitation? -->


  <h5>Updating the <code>datagrid</code></h5>

  <p>Whenever the <code title="dom-datagrid-data">data</code>
  attribute is set to a new value, the <code>datagrid</code> must
  clear the current selection, remove all the displayed rows, and plan
  to repopulate itself using the information from the new data
  provider at the earliest opportunity.</p>

  <p>There are a number of update methods that can be invoked on the
  <code>datagrid</code> element to cause it to refresh itself in
  slightly less drastic ways:</p>

  <p>When the <dfn
  title="dom-datagrid-updateEverything"><code>updateEverything()</code></dfn>
  method is called, the user agent must repopulate the entire
  <code>datagrid</code>. If the number of rows decreased, the
  selection must be updated appropriately. If the number of rows
  increased, the new rows should be left unselected.</p>

  <p>When the <dfn
  title="dom-datagrid-updateRowsChanged"><code>updateRowsChanged(<var
  title="">row</var>, <var title="">count</var>)</code></dfn> method
  is called, the user agent must refresh the rendering of the rows
  starting from the row specified by <var title="">row</var>, and
  including the <var title="">count</var> next siblings of the row (or
  as many next siblings as it has, if that is less than <var
  title="">count</var>), including all descendant rows.</p>

  <p>When the <dfn
  title="dom-datagrid-updateRowsInserted"><code>updateRowsInserted(<var
  title="">row</var>, <var title="">count</var>)</code></dfn> method
  is called, the user agent must assume that <var title="">count</var>
  new rows have been inserted, such that the first new row is
  indentified by <var title="">row</var>. The user agent must update
  its rendering and the selection accordingly. The new rows should not
  be selected.</p>

  <p>When the <dfn
  title="dom-datagrid-updateRowsRemoved"><code>updateRowsRemoved(<var
  title="">row</var>, <var title="">count</var>)</code></dfn> method
  is called, the user agent must assume that <var title="">count</var>
  rows have been removed starting from the row that used to be
  identifier by <var title="">row</var>.  The user agent must update
  its rendering and the selection accordingly.</p>

  <p>The <dfn
  title="dom-datagrid-updateRowChanged"><code>updateRowChanged(<var
  title="">row</var>)</code></dfn> method must be exactly equivalent
  to calling <code
  title="dom-datagrid-updateRowsChanged">updateRowsChanged(<var
  title="">row</var>, 1)</code>.</p>

  <p>When the <dfn
  title="dom-datagrid-updateColumnChanged"><code>updateColumnChanged(<var
  title="">column</var>)</code></dfn> method is called, the user agent
  must refresh the rendering of the specified column <var
  title="">column</var>, for all rows.</p>

  <p>When the <dfn
  title="dom-datagrid-updateCellChanged"><code>updateCellChanged(<var
  title="">row</var>, <var title="">column</var>)</code></dfn> method
  is called, the user agent must refresh the rendering of the cell on
  row <var title="">row</var>, in column <var
  title="">column</var>.</p>

  <p>Any effects the update methods have on the
  <code>datagrid</code>'s selection is not considered a change to the
  selection, and must therefore not fire the <code
  title="event-select">select</code> event.</p>

  <p>These update methods should only be called by the data provider,
  or code acting on behalf of the data provider. In particular,
  calling the <code
  title="dom-datagrid-updateRowsInserted">updateRowsInserted()</code>
  and <code
  title="dom-datagrid-updateRowsRemoved">updateRowsRemoved()</code>
  methods without actually inserting or removing rows from the data
  provider is <a href="#inconsistentDataProvider">likely to result in
  inconsistent renderings</a>, and the user agent is likely to disable
  the data grid.</p>


  <h5>Requirements for interactive user agents</h5>

  <p><em>This section only applies to interactive user agents.</em></p>

  <p>If the <code>datagrid</code> element has a <dfn
  title="attr-datagrid-disabled"><code>disabled</code></dfn>
  attribute, then the user agent must disable the
  <code>datagrid</code>, preventing the user from interacting with it.
  The <code>datagrid</code> element should still continue to update
  itself when the data provider signals changes to the data, though.
  Obviously, conformance requirements stating that
  <code>datagrid</code> elements must react to users in particular
  ways do not apply when one is disabled.</p>

  <p>If <a href="#rowType1">a row is openable</a>, then the user
  should be able to toggle its open/closed state. When a row's
  open/closed state changes, the user agent must update the rendering
  to match the new state.</p>

  <p>If a cell is a cell whose value <a href="#cellType1">can be
  cycled between multiple states</a>, then the user must be able to
  activate the cell to cycle its value. When the user activates this
  "cycling" behaviour of a cell, then the <code>datagrid</code> must
  invoke the data provider's <code
  title="dom-provider-cycleCell">cycleCell()</code> method, with a
  <code>RowSpecification</code> object representing the cell's row as
  the first argument and the cell's column index as the second. The
  <code>datagrid</code> must act as if the <code>datagrid</code>'s
  <code
  title="dom-datagrid-updateCellChanged">updateCellChanged()</code>
  method had been invoked with those same arguments immediately before
  the provider's method was invoked.</p>

  <p>When a cell <a href="#cellType2">has a checkbox</a>, the user
  must be able to set the checkbox's state. When the user changes the
  state of a checkbox in such a cell, the <code>datagrid</code> must
  invoke the data provider's <code
  title="dom-provider-setCellCheckedState">setCellCheckedState()</code>
  method, with a <code>RowSpecification</code> object representing the
  cell's row as the first argument, the cell's column index as the
  second, and the checkbox's new state as the third. The state should
  be represented by the number 1 if the new state is checked, 0 if the
  new state is unchecked, and -1 if the new state is indeterminate
  (which must only be possible if the cell has the <code
  title="datagrid-cell-class-indeterminate">indeterminate</code> class
  set). The <code>datagrid</code> must act as if the
  <code>datagrid</code>'s <code
  title="dom-datagrid-updateCellChanged">updateCellChanged()</code>
  method had been invoked, specifying the same cell, immediately
  before the provider's method was invoked.</p>

  <p>If a cell <a href="#cellType2">is editable</a>, the user must be
  able to edit the data for that cell, and doing so must cause the
  user agent to invoke the <code
  title="dom-provider-editCell">editCell()</code> method of the data
  provider with three arguments: a <code>RowSpecification</code>
  object representing the cell's row, the cell's column's index, and
  the new text entered by the user. The user agent must act as if the
  <code
  title="dom-datagrid-updateCellChanged">updateCellChanged()</code>
  method had been invoked, with the same row and column specified,
  immediately before the provider's method was invoked.</p>

  <!-- XXXPA <p class="big-issue">define actions (performAction(), etc)</p> -->

  <h5>The selection</h5>

  <p><em>This section only applies to interactive user agents. For
  other user agents, the <code
  title="dom-datagrid-selection">selection</code> attribute must
  return null.</em></p>

  <pre class="idl">interface <dfn>DataGridSelection</dfn> {
  readonly attribute unsigned long <span title="dom-DataGridSelection-count">length</span>;
  <span>RowSpecification</span> <span title="dom-DataGridSelection-">item</span>(in unsigned long index);
  boolean <span title="dom-DataGridSelection-isSelected">isSelected</span>(in <span>RowSpecification</span> row);
  void <span title="dom-DataGridSelection-setSelected">setSelected</span>(in <span>RowSpecification</span> row, in boolean selected);
<!--  void <span title="dom-DataGridSelection-addRange">addRange</span>(in <span>RowSpecification</span> first, in <span>RowSpecification</span> last);
  void <span title="dom-DataGridSelection-removeRange">removeRange</span>(in <span>RowSpecification</span> first, in <span>RowSpecification</span> last);
XXX selection ranges -->
  void <span title="dom-DataGridSelection-selectAll">selectAll</span>();
  void <span title="dom-DataGridSelection-invert">invert</span>();
  void <span title="dom-DataGridSelection-clear">clear</span>();
};</pre>

  <p>Each <code>datagrid</code> element must keep track of which rows
  are currently selected. Initially no rows are selected, but this can
  be changed via the methods described in this section. <!--XXX
  select-provider-selection The default data provider, for instance,
  changes which rows are selected when it is first initialised.--></p>

  <p>The selection of a <code>datagrid</code> is represented by its
  <dfn title="dom-datagrid-selection"><code>selection</code></dfn> DOM
  attribute, which must be a <code>DataGridSelection</code> object.</p>

  <p><code>DataGridSelection</code> objects represent the rows in the
  selection. In the selection the rows must be ordered in the natural
  order of the data provider (and not, e.g., the rendered order). Rows
  that are not rendered because one of their ancestors is closed must
  share the same selection state as their nearest rendered
  ancestor. Such rows are not considered part of the selection for the
  purposes of iterating over the selection.</p>

  <p class="note">This selection API doesn't allow for hidden rows to
  be selected because it is trivial to create a data provider that has
  infinite depth, which would then require the selection to be
  infinite if every row, including every hidden row, was selected.</p>

  <p>The <dfn
  title="dom-DataGridSelection-length"><code>length</code></dfn>
  attribute must return the number of rows currently present in the
  selection. The <dfn
  title="dom-DataGridSelection-item"><code>item(<var
  title="">index</var>)</code></dfn> method must return the <var
  title="">index</var>th row in the selection. If the argument is out
  of range (less than zero or greater than the number of selected rows
  minus one), then it must raise an <code>INDEX_SIZE_ERR</code>
  exception. <a href="#refsDOM3CORE">[DOM3CORE]</a></p>

  <p>The <dfn
  title="dom-DataGridSelection-isSelected"><code>isSelected()</code></dfn>
  method must return the selected state of the row specified by its
  argument. If the specified row exists and is selected, it must
  return true, otherwise it must return false.</p>

  <p>The <dfn
  title="dom-DataGridSelection-setSelected"><code>setSelected()</code></dfn>
  method takes two arguments, <var title="">row</var> and <var
  title="">selected</var>. When invoked, it must set the selection
  state of row <var title="">row</var> to selected if <var
  title="">selected</var> is true, and unselected if it is false. If
  <var title="">row</var> is not a row in the data grid, the method
  must raise an <code>INDEX_SIZE_ERR</code> exception. If the
  specified row is not rendered because one of its ancestors is
  closed, the method must do nothing.</p>

  <p>The <dfn
  title="dom-DataGridSelection-selectAll"><code>selectAll()</code></dfn>
  method must mark all the rows in the data grid as selected. After a
  call to <code
  title="dom-DataGridSelection-selectAll">selectAll()</code>, the
  <code title="dom-DataGridSelection-length">length</code> attribute
  will return the number of rows in the data grid, not counting
  children of closed rows.</p>

  <p>The <dfn
  title="dom-DataGridSelection-invert"><code>invert()</code></dfn>
  method must cause all the rows in the selection that were marked as
  selected to now be marked as not selected, and vice versa.</p>

  <p>The <dfn
  title="dom-DataGridSelection-clear"><code>clear()</code></dfn>
  method must mark all the rows in the data grid to be marked as not
  selected.  After a call to <code
  title="dom-DataGridSelection-clear">clear()</code>, the <code
  title="dom-DataGridSelection-length">length</code> attribute will
  return zero.</p>

  <p>If the <code>datagrid</code> element has a <dfn
  title="attr-datagrid-multiple"><code>multiple</code></dfn>
  attribute, then the user must be able to select any number of rows
  (zero or more). If the attribute is not present, then the user must
  only be able to select a single row at a time, and selecting another
  one must unselect all the other rows.</p>

  <p class="note">This only applies to the user. Scripts can select
  multiple rows even when the <code
  title="attr-datagrid-multiple">multiple</code> attribute is
  absent.</p>

  <p>Whenever the selection of a <code>datagrid</code> changes,
  whether due to the user interacting with the element, or as a result
  of calls to methods of the <code
  title="dom-datagrid-selection">selection</code> object, a <dfn
  title="event-select"><code>select</code></dfn><!-- XXX check if we
  really should be DFNing this here. It's a DOM3 Core event. What's
  our story going to be regarding events and defining them? --> event
  that bubbles but is not cancelable must be fired on the
  <code>datagrid</code> element. If changes are made to the selection
  via calls to the object's methods during the execution of a
  script<!-- XXX should xref to a better explanation -->, then the
  <code title="event-select">select</code> events must be coalesced
  into one, which must then be fired<!--XXX xref again--> when the
  script execution has completed<!-- XXX xref -->.</p>

  <p class="note">The <code>DataGridSelection</code> interface has no
  relation to the <code>Selection</code> interface.</p>


  <h5>Columns and captions</h5>

  <p><em>This section only applies to interactive user agents.</em></p>

  <p>Each <code>datagrid</code> element must keep track of which
  columns are currently being rendered. User agents should initially
  show all the columns except those with the <code
  title="datagrid-column-class-initially-hidden">initially-hidden</code>
  class, but may allow users to hide or show columns. User agents
  should initially display the columns in the order given by the data
  provider, but may allow this order to be changed by the user.</p>

  <p>If columns are not being used, as might be the case if the data
  grid is being presented in an icon view, or if an overview of data
  is being read in an aural context, then the text of the first column
  of each row should be used to represent the row.</p>

  <p>If none of the columns have any captions (i.e. if the data
  provider does not provide a <code
  title="dom-provider-getCaptionText">getCaptionText()</code> method),
  then user agents may avoid showing the column headers at all. This
  may prevent the user from performing actions on the columns (such as
  reordering them, changing the sort column, and so on).</p>

  <p class="note">Whatever the order used for rendering, and
  irrespective of what columns are being shown or hidden, the "first
  column" as referred to in this specification is always the column
  with index zero, and the "last column" is always the column with the
  index one less than the value returned by the <code
  title="dom-provider-getcolumnCount">getColumnCount()</code> method
  of the data provider.</p>

  <p>If <a href="#columnType2">a column is sortable</a>, then the user
  must be able to invoke it to sort the data. When the user does so,
  then the <code>datagrid</code> must invoke the data provider's <code
  title="dom-provider-toggleColumnSortState">toggleColumnSortState()</code>
  method, with the column's index as the only argument. The
  <code>datagrid</code> must <em>then</em> act as if the
  <code>datagrid</code>'s <code
  title="dom-datagrid-updateEverything">updateEverything()</code>
  method had been invoked.</p>

<!--XXXDND
  <h5>Drag and drop in <code>datagrid</code>s</h5>

  <p><em>This section only applies to interactive user agents.</p>

  <p class="big-issue">define drag and drop in datagrids; selectiondraggable, etc.</p>
-->

  <h4>The <dfn><code>command</code></dfn> element</h4>

  <p><span title="metadata elements">Metadata element</span>, and
  <span>strictly inline-level content</span>.</p> <!-- XXX we sure we
  want it to be metadata? -->

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>In a <code>head</code> element.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd>Empty.</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-command-type">type</code></dd>
   <dd><code title="attr-command-label">label</code></dd>
   <dd><code title="attr-command-icon">icon</code></dd>
   <dd><code title="attr-command-hidden">hidden</code></dd>
   <dd><code title="attr-command-disabled">disabled</code></dd>
   <dd><code title="attr-command-checked">checked</code></dd>
   <dd><code title="attr-command-radiogroup">radiogroup</code></dd>
   <dd><code title="attr-command-default">default</code></dd>
   <dd>Also, the <code title="attr-command-title">title</code> attribute has special semantics on this element.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLCommandElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-command-type">type</span>;
           attribute DOMString <span title="dom-command-label">label</span>;
           attribute DOMString <span title="dom-command-icon">icon</span>;
           attribute boolean <span title="dom-command-hidden">hidden</span>;
           attribute boolean <span title="dom-command-disabled">disabled</span>;
           attribute boolean <span title="dom-command-checked">checked</span>;
           attribute DOMString <span title="dom-command-radiogroup">radiogroup</span>;
           attribute boolean <span title="dom-command-default">default</span>;
 void <span title="dom-command-click">click</span>(); // shadows <code>HTMLElement</code>.<code title="dom-click">click()</code>
};</pre>
    <p>The <code title="command-ro">Command</code> interface must also be implemented by
    this element.</p>
   </dd>
  </dl>

  <p>The <code>command</code> element represents a command that the user
  can invoke.</p>

  <p>The <dfn title="attr-command-type"><code>type</code></dfn>
  attribute indicates the kind of command: either a normal command
  with an associated action, or a state or option that can be toggled,
  or a selection of one item from a list of items.</p>

  <p>The attribute's value must be either "<code
  title="">command</code>", "<code title="">checkbox</code>", or
  "<code title="">radio</code>", denoting each of these three types of
  commands respectively. The attribute may also be omitted if the
  element is to represent the first of these types, a simple
  command.</p>

  <p>The <dfn title="attr-command-label"><code>label</code></dfn>
  attribute gives the name of the command, as shown to the user.</p>

  <p>The <dfn title="attr-command-title"><code>title</code></dfn>
  attribute gives a hint describing the command, which might be shown
  to the user to help him.</p>

  <p>The <dfn title="attr-command-icon"><code>icon</code></dfn>
  attribute gives a picture that represents the command. If the
  attribute is specified, the attribute's value must contain a URI (or
  IRI).</p>

  <p>The <dfn title="attr-command-hidden"><code>hidden</code></dfn>
  attribute is a <span>boolean attribute</span> that, if present,
  indicates that the command is not relevant and is to be hidden.</p>

  <p>The <dfn
  title="attr-command-disabled"><code>disabled</code></dfn> attribute
  is a <span>boolean attribute</span> that, if present, indicates that
  the command is not available in the current state.</p>

  <p class="note">The distinction between <span
  title="command-facet-DisabledState">Disabled State</span> and <span
  title="command-facet-HiddenState">Hidden State</span> is subtle. A
  command should be Disabled if, in the same context, it could be
  enabled if only certain aspects of the situation were changed. A
  command should be marked as Hidden if, in that situation, the
  command will never be enabled. For example, in the context menu for
  a water faucet, the command "open" might be Disabled if the faucet
  is already open, but the command "eat" would be marked Hidden since
  the faucet could never be eaten.</p>

  <p>The <dfn title="attr-command-checked"><code>checked</code></dfn>
  attribute is a <span>boolean attribute</span> that, if present,
  indicates that the command is selected.</p>

  <p>The <dfn
  title="attr-command-radiogroup"><code>radiogroup</code></dfn>
  attribute gives the name of the group of commands that will be
  toggled when the command itself is toggled, for commands whose <code
  title="attr-command-type">type</code> attribute has the value "<code
  title="">radio</code>". The scope of the name is the child list of
  the parent element.</p>

  <p>If the <code>command</code> element is used when <span
  title="menu generation">generating</span> a <span>context
  menu</span>, then the <dfn
  title="attr-command-default"><code>default</code></dfn> attribute
  indicates, if present, that the command is the one that would have
  been invoked if the user had directly activated the menu's subject
  instead of using its context menu. The <code
  title="attr-command-default">default</code> attribute is a
  <span>boolean attribute</span>.</p>

  <div class="example">

   <p class="big-issue">Need an example that shows an element that, if
   double-clicked, invokes an action, but that also has a context
   menu, showing the various <code>command</code> attributes off, and
   that has a default command.</p>

  </div>

  <p>The <dfn title="dom-command-type"><code>type</code></dfn>, <dfn
  title="dom-command-label"><code>label</code></dfn>, <dfn
  title="dom-command-icon"><code>icon</code></dfn>, <dfn
  title="dom-command-hidden"><code>hidden</code></dfn>, <dfn
  title="dom-command-disabled"><code>disabled</code></dfn>, <dfn
  title="dom-command-checked"><code>checked</code></dfn>, <dfn
  title="dom-command-radiogroup"><code>radiogroup</code></dfn>, and  <dfn
  title="dom-command-default"><code>default</code></dfn> DOM
  attributes must <span>reflect</span> their respective namesake
  content attributes.</p>

  <p>The <dfn title="dom-command-click"><code>click()</code></dfn>
  method's behaviour depends on the value of the <code
  title="attr-command-type">type</code> attribute of the element, as
  follows:</p>

  <dl class="switch">

   <dt>If the <code title="attr-command-type">type</code> attribute
   has the value <code title="">checkbox</code></dt>

   <dd><p>If the element has a <code
   title="attr-command-checked">checked</code> attribute, the UA must
   remove that attribute. Otherwise, the UA must add a <code
   title="attr-command-checked">checked</code> attribute, with the
   literal value <code title="">checked</code>. The UA must then
   <span>fire a <code title="">click</code> event</span> at the
   element.</p></dd>


   <dt>If the <code title="attr-command-type">type</code> attribute
   has the value <code title="">radio</code></dt>

   <dd><p>If the element has a parent, then the UA must walk the list
   of child nodes of that parent element, and for each node that is a
   <code>command</code> element, if that element has a <code
   title="attr-command-radiogroup">radiogroup</code> attribute whose
   value exactly matches the current element's (treating missing <code
   title="attr-command-radiogroup">radiogroup</code> attributes as if
   they were the empty string), and has a <code
   title="attr-command-checked">checked</code> attribute, must remove
   that attribute and <span>fire a <code title="">click</code>
   event</span> at the element.</p>

   <p>Then, the element's <code
   title="attr-command-checked">checked</code> attribute attribute
   must be set to the literal value <code title="">checked</code> and
   a <span title="file a click event"><code title="">click</code>
   event must be fired</span> at the element.</p></dd>


   <dt>Otherwise</dt>

   <dd><p>The UA must <span>fire a <code title="">click</code>
   event</span> at the element.</p></dd>

  </dl>

  <p class="note">Firing a synthetic <code
  title="event-click">click</code> event at the element does not cause
  any of the actions described above to happen.</p>

  <p class="big-issue"> should change all the above so it actually is
  just trigged by a click event, then we could remove the shadowing
  click() method and rely on actual events. </p>

  <p class="big-issue">Need to define the command="" attribute</p>

  <p class="note"><code>command</code> elements are not rendered
  unless they <span title="menu">form part of a menu</span>.</p>


  <h4 id="menus">The <dfn><code>menu</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level element</span>,
  and <span title="structured inline-level elements">structured
  inline-level element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dd>Where <span>structured inline-level elements</span> are allowed.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>li</code> elements, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd><code title="attr-menu-type">type</code></dd>
   <dd><code title="attr-menu-label">label</code></dd>
   <dd><code title="attr-menu-autosubmit">autosubmit</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLCommandElement</dfn> : <span>HTMLElement</span> {
           attribute DOMString <span title="dom-menu-type">type</span>;
           attribute DOMString <span title="dom-menu-label">label</span>;
           attribute boolean <span title="dom-menu-autosubmit">autosubmit</span>;
};</pre>
  </dl>

  <p>The <code>menu</code> element represents a list of commands.</p>

  <p>The <dfn title="attr-menu-type"><code>type</code></dfn> attribute
  indicates the kind of menu. It must have either the value <code
  title="">popup</code> (to declare a context menu) or the value <code
  title="">toolbar</code> (to define a tool bar). The attribute may
  also be omitted, to indicate that the element is merely a list of
  commands that is neither declaring a context menu nor defining a
  tool bar.</p>

  <p>If a <code>menu</code> element has a <code
  title="attr-menu-type">type</code> attribute with the value <code
  title="">popup</code>, then it represents the commands of a context
  menu, and the user can only interact with the commands if that
  context menu is activated.</p>

  <p>If a <code>menu</code> element has a <code
  title="attr-menu-type">type</code> attribute with the value <code
  title="">toolbar</code>, then it represents a list of active
  commands that the user can immediately interact with.</p>

  <p>Otherwise, if a <code>menu</code> element has no <code
  title="attr-menu-type">type</code> attribute, or if has a <code
  title="attr-menu-type">type</code> attribute with a value other than
  <code title="">popup</code> or <code title="">toolbar</code>, then
  it either represents an unordered list of items (each represented by
  an <code>li</code> element), each of which represents a command that
  the user may perform or activate, or, if the element has no
  <code>li</code> element children, a <span>paragraph</span>
  describing available commands.</p>

  <p>The <dfn title="attr-menu-label"><code>label</code></dfn>
  attribute gives the label of the menu. It is used by user agents to
  display nested menus in the UI. For example, a context menu
  containing another menu would use the nested menu's <code
  title="attr-menu-label">label</code> attribute for the submenu's
  menu label.</p>

  <p>The <dfn
  title="attr-menu-autosubmit"><code>autosubmit</code></dfn> attribute
  is a <span>boolean attribute</span> that, if present, indicates that
  selections made to form controls in this menu are to result in the
  control's form being immediately submitted.</p>

  <p>If a <code title="event-change">change</code> event bubbles
  through a <code>menu</code> element, then, in addition to any other
  default action that that event might have, the UA must act as if the
  following was an additional default action for that event: if (when
  it comes time to execute the default action) the <code>menu</code>
  element has an <code title="attr-menu-autosubmit">autosubmit</code>
  attribute, and the target of the event is an <code>input</code>
  element, and that element has a <code
  title="attr-input-type">type</code> attribute whose value is either
  <code title="">radio</code> or <code title="">checkbox</code>, and
  the <code>input</code> element in question has a non-null <code
  title="dom-input-form">form</code> DOM attribute, then the UA must
  invoke the <code title="dom-form-submit">submit()</code> method of
  the <code>form</code> element indicated by that DOM attribute.</p>



  <h5 id="menus-intro">Introduction</h5>

  <p><em>This section is non-normative.</em></p>

  <p class="big-issue">...</p>

<!--


  <pre>&lt;menu type="commands"&gt;
 &lt;li&gt;
  &lt;menu label="File"&gt;
   &lt;button type="button" onclick="fnew()"&gt;New...&lt;/button&gt;
   &lt;button type="button" onclick="fopen()"&gt;Open...&lt;/button&gt;
   &lt;button type="button" onclick="fsave()" id="save"&gt;Save&lt;/button&gt;
   &lt;button type="button" onclick="fsaveas()"&gt;Save as...&lt;/button&gt;
  &lt;/menu&gt;
 &lt;/li&gt;
 &lt;li&gt;
  &lt;menu label="Edit"&gt;
   &lt;button type="button" onclick="ecopy()"&gt;Copy&lt;/button&gt;
   &lt;button type="button" onclick="ecut()"&gt;Cut&lt;/button&gt;
   &lt;button type="button" onclick="epaste()"&gt;Paste&lt;/button&gt;
  &lt;/menu&gt;
 &lt;/li&gt;
 &lt;li&gt;
  &lt;menu label="Help"&gt;
   &lt;li&gt;&lt;a href="help.html"&gt;Help&lt;/a&gt;&lt;/li&gt;
   &lt;li&gt;&lt;a href="about.html"&gt;About&lt;/a&gt;&lt;/li&gt;
  &lt;/menu&gt;
 &lt;/li&gt;
&lt;/menubar&gt;

...

&lt;input command="save"/&gt; &lt;!- - This will act exactly like the
                             Save button above, including reflecting
                             its <code>disabled</code> state dynamically - -&gt;

</pre>

  <p>Here's some markup that falls back on the traditional abuse of
  the <code>select</code> element as a navigation menu, but which is
  implemented as a semi-correct menu using the new techniques of this
  document:</p>

<pre>&lt;form action="redirect.cgi"&gt;
 &lt;menu type="commands"&gt;
  &lt;label for="goto"&gt;Go to...&lt;/label&gt;
  &lt;menu label="Go"&gt;
   &lt;select id="goto"
           onchange="if (this.options[this.selectedIndex].value)
                     window.location = this.options[this.selectedIndex].value"&gt;
    &lt;option value="" selected="selected"&gt; Select site: &lt;/option&gt;
    &lt;option value="http://www.apple.com/"&gt; Apple &lt;/option&gt;
    &lt;option value="http://www.mozilla.org/"&gt; Mozilla &lt;/option&gt;
    &lt;option value="http://www.opera.com/"&gt; Opera &lt;/option&gt;
   &lt;/select&gt;
   &lt;span&gt;&lt;input type="submit" value="Go"&gt;&lt;/span&gt;
  &lt;/menu&gt;
 &lt;/menubar&gt;
&lt;/form&gt;</pre>

<form ...>
 <menu type="toolbar" autosubmit>
  <li>
   <select name="foo" onchange="form.submit()">
     ...
   </select>
   <button>Go</button>
  </li>
  <li>
   <select name="bar" onchange="form.submit()">
     ...
   </select>
   <button>Go</button>
  </li>
 </menu>
</form>

<form ...>
 <menu type="toolbar" autosubmit>
  <menu label="Foo">
   <select name="foo" onchange="form.submit()">
     ...
   </select>
   <button>Go</button>
  </menu>
  <menu label="Bar">
   <select name="bar" onchange="form.submit()">
     ...
   </select>
   <button>Go</button>
  </menu>
 </menu>
</form>

-->


  <h5><dfn>Building menus</dfn></h5>

  <p>A menu consists of a list of zero or more of the following
  components:</p>

  <ul class="brief">
   <li><span title="concept-command">Commands</span>, which can be marked as default commands</li>
   <li>Separators</li>
   <li>Other menus (which allows the list to be nested)</li>
  </ul>

  <p>The list corresponding to a particular <code>menu</code> element
  is built by iterating over its child nodes. For each child node in
  <span>tree order</span>, the required behaviour depends on what the
  node is, as follows:</p>

  <dl class="switch">

   <dt>An element that <span title="concept-command">defines a command</span></dt>

   <dd>Append the command to the menu. If the element is a
   <code>command</code> element with a <code
   title="attr-command-default">default</code> attribute, mark the
   command as being a default command.</dd>


   <dt>An <code>hr</code> element</dt>
   <dt>An <code>option</code> element that has a <code
   title="attr-option-value">value</code> attribute set to the empty
   string, and has a <code
   title="attr-option-disabled">disabled</code> attribute, and whose
   <code>textContent</code> consists of a string of one or more
   hyphens (U+002D HYPHEN-MINUS)</dt>

   <dd>Append a separator to the menu.</dd>


   <dt>An <code>li</code> element</dt>

   <dd>Iterate over the children of the <code>li</code> element.</dd>


   <dt>A <code>menu</code> element with no <code title="attr-menu-label">label</code> attribute</dt>
   <dt>A <code>select</code> element</dt>

   <dd>Append a separator to the menu, then iterate over the children
   of the <code>menu</code> or <code>select</code> element, then
   append another separator.</dd>


   <dt>A <code>menu</code> element with a <code title="attr-menu-label">label</code> attribute</dt>
   <dt>An <code>optgroup</code> element</dt>

   <dd>Append a submenu to the menu, using the value of the element's
   <code title="">label</code> attribute as the label of the menu. The
   submenu must be constructed by taking the element and creating a
   new menu for it using the complete process described in this
   section.</dd>


   <dt>Any other node</dt>

   <dd><span>Ignore</span> the node.</dd>

  </dl>

  <p>Once all the nodes have been processed as described above, the
  user agent must the post-process the menu as follows:</p>

  <ol>

   <li>Any menu item with no label, or whose label is the empty string, must be removed.</li>

   <li>Any sequence of two or more separators in a row must be collapsed to a single separator.</li>

   <li>Any separator at the start or end of the menu must be removed.</li>

  </ol>


  <h5><dfn>Context menus</dfn></h5>

  <p>The <dfn title="attr-contextmenu"><code>contextmenu</code></dfn>
  attribute gives the element's <span title="context menus">context
  menu</span>. The value must be the ID of a <code>menu</code> element
  in the DOM. If the node that would be obtained by the invoking the
  <code>getElementById()</code> method using the attribute's value as
  the only argument is null or not a <code>menu</code> element, then
  the element has no assigned context menu. Otherwise, the element's
  assigned context menu is the element so identified.</p>

  <p>When an element's context menu is requested (e.g. by the user
  right-clicking the element, or pressing a context menu key), the UA
  must <span>fire a <code title="">contextmenu</code> event</span> on
  the element for which the menu was requested.</p>

  <p class="note">Typically, therefore, the firing of the <code
  title="event-contextmenu">contextmenu</code> event will be the
  default action of a <code title="mouseup">mouseup</code> or <code
  title="event-keyup">keyup</code> event. The exact sequence of events
  is UA-dependent, as it will vary based on platform conventions.</p>

  <p>The default action of the <code
  title="event-contextmenu">contextmenu</code> event depends on
  whether the element has a context menu assigned (using the <code
  title="attr-contextmenu">contextmenu</code> attribute) or not. If it
  does not, the default action must be for the user agent to show its
  default context menu, if it has one.</p>

  <p>If the element <em>does</em> have a context menu assigned, then
  the user agent must <span>fire a <code title="">show</code>
  event</span> on the relevant <code>menu</code> element.</p>

  <p>The default action of <em>this</em> event is that the user agent
  must show a context menu <span title="building menus">built</span>
  from the <code>menu</code> element.</p>

  <p>The user agent may also provide access to its default context
  menu, if any, with the context menu shown. For example, it could
  merge the menu items from the two menus together, or provide the
  page's context menu as a submenu of the default menu.</p>

  <p>If the user dismisses the menu without making a selection,
  nothing in particular happens.</p>

  <p>If the user selects a menu item that represents a <span
  title="concept-commands">command</span>, then the UA must invoke
  that command's <span title="command-facet-Action">Action</span>.</p>

  <p>Context menus must not, while being shown, reflect changes in the
  DOM; they are constructed as the default action of the <code
  title="event-show">show</code> event and must remain like that until
  dismissed.</p>

  <p>User agents may provide means for bypassing the context menu
  processing model, ensuring that the user can always access the UA's
  default context menus. For example, the user agent could handle
  right-clicks that have the Shift key depressed in such a way that it
  does not fire the <code title="event-contextmenu">contextmenu</code>
  event and instead always shows the default context menu.</p>

  <p>The <dfn title="dom-contextMenu"><code>contextMenu</code></dfn>
  attribute must <span>reflect</span> the <code
  title="attr-contextmenu">contextmenu</code> content attribute.</p>


  <h5><dfn>Toolbars</dfn></h5>

  <p>Toolbars are a kind of menu that is always visible.</p>

  <p>When a <code>menu</code> element has a <code
  title="attr-menu-type">type</code> attribute with the value <code
  title="">toolbar</code>, then the user agent must <span
  title="building menus">build</span> the menu for that
  <code>menu</code> element and <span
  title="render-toolbar">render</span><!-- XXX xref --> it in the
  document in a position appropriate for that <code>menu</code>
  element.</p>

  <p>The user agent must reflect changes made to the
  <code>menu</code>'s DOM immediately in the UI.</p>



  <h3>Miscellaneous elements</h3>

  <h4>The <dfn><code>legend</code></dfn> element</h4>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>As the first child of a <code>fieldset</code> element.</dd>
   <dd>As the first child of a <code>details</code> element.</dd>
   <dd>As a child of a <code>figure</code> element, if there are no other <code>legend</code> element children of that element.</dd>
   <dt>Content model:</dt>
   <dd>If used as a child of a <code>fieldset</code> or <code>details</code> element: <span title="significant inline content">significant</span> <span>strictly inline-level content</span></dd>
   <dd>If used as a child of a <code>figure</code> element: <span>inline-level content</span>.</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>legend</code> element represents a title or explanatory
  caption for the rest of the contents of the <code>legend</code>
  element's parent element.</p>


  <h4>The <dfn><code>div</code></dfn> element</h4>

  <p><span title="block-level elements">Block-level
  element</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level elements</span> are expected.</dd>
   <dt>Content model:</dt>
   <dd>Zero or more <code>style</code> elements, followed by either
   zero or more <span>block-level elements</span>, or
   <span>inline-level content</span> (but not both).</dd>
   <dt>Element-specific attributes:</dt>
   <dd>None.</dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd><code title="class-error">error</code>, <code
   title="class-example">example</code>, <code
   title="class-issue">issue</code>, <code
   title="class-note">note</code>, <code
   title="class-search">search</code>, <code
   title="class-warning">warning</code></dd>
   <dt>DOM interface:</dt>
   <dd>No difference from <code>HTMLElement</code>.</dd>
  </dl>

  <p>The <code>div</code> element represents nothing at all. It can be
  used with the <code title="attr-class">class</code>, <code
  title="attr-lang">lang</code>/<code
  title="attr-xml-lang">xml:lang</code>, and <code
  title="attr-title">title</code> attributes to mark up semantics
  common to a group of consecutive elements.</p>



  <h2 id="processing-models">Processing models</h2>

  <h3>Navigating across documents</h3>

  <p><em>This section only applies to Web browsers.</em></p>
  <!-- XXX or should it? should conformance checkers do the whole content-type sniffing thing? -->

  <p>Certain actions cause the <span>browsing context</span> to
  <dfn>navigate</dfn>. For example, <span title="following
  hyperlinks">following a hyperlink</span>, <span title="">form
  submission</span>, and the <code
  title="dom-window-open">window.open()</code> and <code
  title="dom-location-assign">location.assign()</code> methods can all
  cause a browsing context to navigate. A user agent may also provide
  various ways for the user to explicitly cause a browsing context to
  navigate.</p>

  <p>When a browsing context is navigated, the user agent must follow
  the following steps:</p>

  <ol>

   <li><p>Cancel any existing attempt to navigate the browsing context
   to a new URI.</p></li>

   <li><p>If the new resource is the same as the current resource, but
   a fragment identifier has been specified, then <span
   title="navigate-fragid">scroll the document to the specified
   element</span> and abort these steps.</p></li>

   <li><p>If the new resource is to be handled by displaying some sort
   of inline content, e.g. an error message because the specified
   scheme is not one of the supported protocols, or an inline prompt
   to allow the user to select <span
   title="dom-navigator-registerProtocolHandler">a registered
   handler</span> for the given scheme, then <span title="display a
   user agent page inline">display the inline content</span> and abort
   these steps.</p></li>

   <li><p>If the new resource is to be handled using a mechanism that
   does not affect the browsing context, then abort these steps and
   proceed with that mechanism instead.</p></li>

   <li><p>Start fetching the specified resource, as appropriate
   (e.g. performing an HTTP GET or POST operation, or reading the file
   from disk, or executing script in the case of a <span
   title="javascript protocol"><code title="">javascript:</code>
   URI</span>). If this results in a redirect, return to step 2 with
   the new resource.</p></li>

   <li><p>Wait for one or more bytes to be available or for the user
   agent to establish that the resource in question is empty. During
   this time, the user agent may allow the user to cancel this
   navigation attempt or start other navigation attempts.</p></li>

   <li><p>If the document's out-of-band metadata (e.g. HTTP headers),
   not counting any type information (such as the Content-Type HTTP
   header), requires some sort of processing that will not affect the
   browsing context, then perform that processing and abort these
   steps.</p>

   <div class="note">
    <p>Such processing might be triggered by, amongst other things, the
    following:</p>
    <ul class="brief">
     <li>HTTP status codes (e.g. 204 No Content or 205 Reset Content)</li>
     <li>HTTP Content-Disposition headers</li>
     <li>Network errors</li>
    </ul>
   </div>
   </li>

   <li><p>Let <var title="">type</var> be <span title="Content-Type
   sniffing">the sniffed type of the resource</span>.</p></li>

   <li><p>If the user agent has been configured to process resources
   of the given <var title="">type</var> using some mechanism other
   than native rendering, then skip this step. Otherwise, if the <var
   title="">type</var> is one of the following types, jump to the
   appropriate entry in the following list, and process the resource
   as described there:</p>
   <dl class="switch">

    <dt>"text/html"</dt>
    <dd>Follow the steps given in the <span title="navigate-html">HTML
    document</span> section, and abort these steps.</dd>

    <dt>Any type ending in "+xml"</dt>
    <dt>"application/xml"</dt>
    <dt>"text/xml"</dt>
    <dd>Follow the steps given in the <span title="navigate-xml">XML
    document</span> section. If that section determines that the
    content is <em>not</em> to be displayed as a generic XML document,
    then proceed to the next step in this overall set of
    steps. Otherwise, abort these steps.</dd>

    <dt>"text/plain"</dt>
    <dd>Follow the steps given in the <span
    title="navigate-text">plain text file</span> section, and abort
    these steps.</dd>

   </dl>
   </li>

   <li><p>If, given <var title="">type</var>, the new resource is to
   be handled by displaying some sort of inline content, e.g. a native
   rendering of the content, a full-page plugin, an error message
   because the specified type is not supported, or an inline prompt to
   allow the user to select <span
   title="dom-navigator-registerContentHandler">a registered
   handler</span> for the given type, then <span title="display a user
   agent page inline">display the inline content</span> and abort
   these steps.</p></li>

   <li><p>Otherwise, the document's <var title="">type</var> is such
   that the resource will not affect the browsing context,
   e.g. because the resource is to be handed to an external
   application. Process the resource appropriately.</p>

  </ol>

  <p>Some of the sections below, to which the above algorithm defers
  in certain cases, require the user agent to <dfn>update the session
  history with the new page</dfn>. When a user agent is required to do
  this, it must follows these steps. From the point of view of any
  script, these steps must occur atomically.</p>

  <ol>

   <li><p>If appropriate, update the <span>current entry</span> in the
   <span>browsing context</span>'s <code>Document</code> object's
   <code>History</code> object to reflect any state that the user
   agent wishes to persist.</p>
   <p class="example">For example, some user agents might want to
   persist the scroll position, or the values of form controls.</p>
   </li>

   <li><p>Remove all the entries after the <span>current entry</span>
   in the <span>browsing context</span>'s <code>Document</code>
   object's <code>History</code> object.</p> <p class="note">This <a
   href="#history-notes">doesn't necessarily have to affect</a><!--XXX
   change to auto-xref?--> the user agent's user interface.</p> </li>

   <li><p>Append a new entry at the end of the <code>History</code>
   object representing the new resource and its <code>Document</code>
   object and related state.</p></li>

   <li><p><span>Traverse the history</span> to the new entry.</p></li>

   <li><p>If the navigation was initiated by the <code
   title="dom-location-replace">replace()</code> method, remove the
   entry that was the <span>current entry</span> before the method
   call (thus simply causing the previous page to be replaced by the
   new one).</p></li>

  </ol>


  <h4 id="content-type-sniffing">Determining the type of a new resource in a browsing context</h4>

  <p class="warning">It is imperative that the rules in this section
  be followed exactly. When two user agents use different heuristics
  for content type detection, security problems can occur. For
  example, if a server believes a contributed file to be an image (and
  thus benign), but a Web browser believes the content to be HTML (and
  thus capable of executing script), the end user can be exposed to
  malicious content, making the user vulnerable to cookie theft
  attacks and other cross-site scripting attacks.</p>

  <p>The <dfn title="Content-Type sniffing">sniffed type of a
  resource</dfn> must be found as follows:</p>

  <ol>

   <li><p>If the resource was fetched over an HTTP protocol, and there
   is no HTTP Content-Encoding header, but there is an HTTP
   Content-Type header and it has a value whose bytes exactly match
   one of the following three lines:</p>

    <table>
     <thead>
      <tr>
       <th>Bytes in Hexadecimal
       <th>Textual representation
     <tbody>
      <tr> <!-- Old Apache default -->
       <td>74 65 78 74 2f 70 6c 61 69 6e
       <td><code title="">text/plain</code>
      <tr> <!-- Modern Apache default -->
       <td>74 65 78 74 2f 70 6c 61 69 6e 3b 20 63 68 61 72 73 65 74 3d 49 53 4f 2d 38 38 35 39 2d 31
       <td><code title="">text/plain;&nbsp;charset=ISO-8859-1</code>
      <tr> <!-- Debian's arbitrarily different Modern Apache default -->
       <td>74 65 78 74 2f 70 6c 61 69 6e 3b 20 63 68 61 72 73 65 74 3d 69 73 6f 2d 38 38 35 39 2d 31
       <td><code title="">text/plain;&nbsp;charset=iso-8859-1</code>
    </table>

    <p>...then jump to the <em title="content-type sniffing: text or
    binary">text or binary</em> section below.</p>

   </li>

   <li><p>Let <var title="">official type</var> be the type given by
   the <span>Content-Type metadata</span> for the resource (in
   lowercase<!-- XXX ASCII case folding -->, ignoring any
   parameters). If there is no such type, jump to the <em
   title="content-type sniffing: unknown type">unknown type</em> step
   below.</p></li>

   <li><p>If <var title="">official type</var> ends in "+xml", or if
   it is either "text/xml" or "application/xml", then the the sniffed
   type of the resource is <var title="">official type</var>; return
   that and abort these steps.</p></li> <!-- we don't want
   image/svg+xml going through the next step -->

   <li><p>If <var title="">official type</var> is an image type
   supported by the user agent (e.g. "image/png", "image/gif",
   "image/jpeg", etc), then jump to the <em title="content-type
   sniffing: image">images</em> section below.</p></li>

   <li><p>If <var title="">official type</var> is "text/html", then
   jump to the <em title="content-type sniffing: feed or html">feed or
   HTML</em> section below.</p></li>

   <li><p>Otherwise, the sniffed type of the resource is <var
   title="">official type</var>.</p></li>

  </ol>


  <h5><dfn>Content-Type sniffing: text or binary</dfn></h5>

  <ol>

   <li><p>The user agent may wait for 512 or more bytes of the resource
   to be available.</p></li>

   <li><p>Let <var title="">n</var> be the smaller of either 512 or
   the number of bytes already available.</p></li>

   <li><p>If <var title="">n</var> is 4 or more, and the first bytes
   of the file match one of the following byte sets:</p>

    <table>
     <thead>
      <tr>
       <th>Bytes in Hexadecimal
       <th>Description
     <tbody>
      <tr>
       <td>FE FF
       <td>UTF-16BE BOM <!-- followed by a character --> or UTF-32LE BOM
      <tr>
       <td>FF FE
       <td>UTF-16LE BOM <!-- followed by a character -->
      <tr>
       <td>00 00 FE FF
       <td>UTF-32BE BOM
<!-- this one is redundant with the one above
      <tr>
       <td>FF FE 00 00
       <td>UTF-32LE BOM
-->
      <tr>
       <td>EF BB BF
       <td>UTF-8 BOM <!-- followed by a character, or the first byte of a multiple character sequence -->
<!-- nobody uses this
      <tr>
       <td>DD 73 66 73
       <td>UTF-EBCDIC BOM
-->
    </table>

   <p>...then the sniffed type of the resource is "text/plain".</p></li>

   <li><p>Otherwise, if any of the first <var title="">n</var> bytes
   of the resource are in one of the following byte ranges:</p>

    <!-- This byte list is based on RFC 2046 Section 4.1.2. Characters
    in the range 0x00-0X1F, with the exception of 0x09 - 0x0D (ASCII
    for TAB, LF, VT, FF, and CR), and character 0x1B (reportedly used
    by some encodings as a shift escape), are invalid. Thus, if we see
    them, we assume it's not text. -->

    <ul class="brief">
     <li> 0x00 - 0x08 </li>
     <li> 0x0E - 0x1A </li>
     <li> 0x1C - 0x1F </li>
    </ul>

   <p>...then the sniffed type of the resource is
   "application/octet-stream".</p></li>

   <li><p>Otherwise, the sniffed type of the resource is
   "text/plain".</p></li>

  </ol>


  <h5><dfn>Content-Type sniffing: unknown type</dfn></h5>

  <ol>

   <li><p>The user agent may wait for 512 or more bytes of the
   resource to be available.</p></li>

   <li><p>Let <var title="">stream length</var> be the smaller of
   either 512 or the number of bytes already available.</p></li>

   <li><p>For each row in the table below:</p>

    <ol>

     <li>Let <var title="">pattern length</var> be the length of the
     pattern (number of bytes described by the cell in the second
     column of the row).</li>

     <li>If <var title="">pattern length</var> is smaller than <var
     title="">stream length</var> then skip this row.</li>

     <li>Apply the "and" operator to the first <var title="">pattern
     length</var> bytes of the resource and the given mask (the bytes
     in the cell of first column of that row), and let the result be
     the <var title="">data</var>.</li>

     <li>If the bytes of the <var title="">data</var> matches the
     given pattern bytes exactly, then the sniffed type of the
     resource is the type given in the cell of the third column in
     that row; abort these steps.</li>

    </ol>

   </li>

   <li><p>As a last-ditch effort, jump to the <span
   title="content-type sniffing: text or binary">text or binary</span>
   section.</p></li>

  </ol>

  <table>
   <thead>
    <tr>
     <th colspan="2">Bytes in Hexadecimal
     <th rowspan="2">Sniffed type
     <th rowspan="2">Comment
    <tr>
     <th>Mask
     <th>Pattern
   <tbody>
    <tr>
     <td>FF FF DF DF DF DF DF DF DF FF DF DF DF DF
     <td>3C 31 44 4F 43 54 59 50 45 20 48 54 4D 4C <!-- "<!DOCTYPE HTML" -->
     <td>text/html
     <td>The string "<code title="">&lt;!DOCTYPE HTML</code>" in US-ASCII or compatible encodings, case-insensitively.
    <tr>
     <td>FF DF DF DF DF
     <td>3C 48 54 4D 4C <!-- "<HTML" -->
     <td>text/html
     <td>The string "<code title="">&lt;HTML</code>" in US-ASCII or compatible encodings, case-insensitively.
    <tr>
     <td>FF FF FF FF FF
     <td>25 50 44 46 2D <!-- "%PDF-" (from http://lxr.mozilla.org/seamonkey/source/netwerk/streamconv/converters/nsUnknownDecoder.cpp#321) -->
     <td>application/pdf
     <td>The string "<code title="">%PDF-</code>", the PDF signature.
    <tr>
     <td>FF FF FF FF FF FF FF FF FF FF FF
     <td>25 21 50 53 2D 41 64 6F 62 65 2D <!-- "%!PS-Adobe-" (from http://lxr.mozilla.org/seamonkey/source/netwerk/streamconv/converters/nsUnknownDecoder.cpp#321) -->
     <td>application/postscript
     <td>The string "<code title="">%!PS-Adobe-</code>", the PostScript signature.

   <!-- copied from the section below -->
   <tbody>
    <tr>
     <td>FF FF FF FF FF FF
     <td>47 49 46 38 37 61 <!-- GIF87a -->
     <td>image/gif
     <td>The string "<code title="">GIF87a</code>", a GIF signature.
    <tr>
     <td>FF FF FF FF FF FF
     <td>47 49 46 38 39 61 <!-- GIF89a -->
     <td>image/gif
     <td>The string "<code title="">GIF89a</code>", a GIF signature.
    <tr>
     <td>FF FF FF FF FF FF FF FF
     <td>89 50 4E 47 0D 0A 1A 0A <!-- [TAB]PNG[CR][LF][EOF][LF]; 137 80 78 71 13 10 26 10 -->
     <td>image/png
     <td>The PNG signature.
    <tr>
     <td>FF FF FF
     <td>FF D8 FF <!-- SOI marker followed by the first byte of another marker -->
     <td>image/jpeg
     <td>A JPEG SOI marker followed by the first byte of another marker.
  </table>

  <p>User agents may support further types if desired, by implicitly
  adding to the above table. However, user agents should not use any
  other patterns for types already mentioned in the table above, as
  this could then be used for privilege escalation (where, e.g., a
  server uses the above table to determine that content is not HTML
  and thus safe from XSS attacks, but then a user agent detects it as
  HTML anyway and allows script to execute).</p>


  <h5><dfn>Content-Type sniffing: image</dfn></h5>

  <p>If the first bytes of the file match one of the byte sequences in
  the first columns of the following table, then the sniffed type of
  the resource is the type given in the corresponding cell in the
  second column on the same row:</p>

  <table>
   <thead>
    <tr>
     <th>Bytes in Hexadecimal
     <th>Sniffed type
     <th>Comment

   <!-- update the table above if you change this! -->
   <tbody>
    <tr>
     <td>47 49 46 38 37 61 <!-- GIF87a -->
     <td>image/gif
     <td>The string "<code title="">GIF87a</code>", a GIF signature.
    <tr>
     <td>47 49 46 38 39 61 <!-- GIF89a -->
     <td>image/gif
     <td>The string "<code title="">GIF89a</code>", a GIF signature.
    <tr>
     <td>89 50 4E 47 0D 0A 1A 0A <!-- [TAB]PNG[CR][LF][EOF][LF]; 137 80 78 71 13 10 26 10 -->
     <td>image/png
     <td>The PNG signature.
    <tr>
     <td>FF D8 FF <!-- SOI marker followed by the first byte of another marker -->
     <td>image/jpeg
     <td>A JPEG SOI marker followed by the first byte of another marker.
  </table>

  <p>User agents must ignore any rows for image types that they do not
  support.</p>

  <p>Otherwise, the <i>sniffed type</i> of the resource is the same as
  its <var title="">official type</var>.</p>


  <h5><dfn>Content-Type sniffing: feed or HTML</dfn></h5>
  <!-- mostly based on:
   http://blogs.msdn.com/rssteam/articles/PublishersGuide.aspx
   http://lxr.mozilla.org/seamonkey/source/browser/components/feeds/src/nsFeedSniffer.cpp#192
   http://lxr.mozilla.org/seamonkey/source/browser/components/feeds/src/nsFeedSniffer.cpp#127
  -->

  <ol>

   <li><p>The user agent may wait for 512 or more bytes of the
   resource to be available.</p></li>

   <li><p>Let <var title="">s</var> be the stream of bytes, and let
   <span><var title="">s</var>[<var title="">i</var>]</span> represent
   the byte in <var title="">s</var> with position <var
   title="">i</var>, treating <var title="">s</var> as zero-indexed
   (so the first byte is at <span><var
   title="">i</var>=0</span>).</p></li>

   <li><p>If at any point this algorithm requires the user agent to
   determine the value of a byte in <var title="">s</var> which is not
   yet available, or which is past the first 512 bytes of the
   resource, or which is beyond the end of the resource, the user
   agent must stop this algorithm, and assume that the sniffed type of
   the resource is "text/html".</p>

   <p class="note">User agents are allowed, by the first step of this
   algorithm, to wait until the first 512 bytes of the resource are
   available.</p></li>

   <li><p>Initialise <var title="">pos</var> to 0.</p></li>

   <li><p>Examine <span><var title="">s</var>[<var
   title="">pos</var>]</span>.</p>

   <dl class="switch">

    <!-- skip whitespace (S token as defined in XML 1.0 section 2.3; production [3] -->
    <dt>If it is 0x09 (ASCII tab), 0x20 (ASCII space), 0x0A (ASCII LF), or 0x0D (ASCII CR)</dt>
    <dd>Increase <var title="">pos</var> by 1 and repeat this step.</dd>

    <dt>If it is 0x3C (ASCII "<code title="">&lt;</code>")</dt>
    <dd>Increase <var title="">pos</var> by 1 and go to the next step.</dd>

    <dt>If it is anything else</dt>
    <dd>The sniffed type of the resource is "text/html". Abort these
    steps.</dd>

   </dl>

   </li>

   <li><p>If the bytes with positions <var title="">pos</var> to
   <span><var title="">pos</var>+2</span> in <var title="">s</var> are
   exactly equal to 0x21, 0x2D, 0x2D respectively (ASCII for "<code
   title="">!--</code>"), then:</p>

    <ol>

     <li>Increase <var title="">pos</var> by 3.</li> <!-- skips past the " ! - - " -->

     <li>If the bytes with positions <span><var
     title="">pos</var></span> to <span><var
     title="">pos</var>+2</span> in <var title="">s</var> are exactly
     equal to 0x2D, 0x2D, 0x3E respectively (ASCII for "<code
     title="">--&gt;</code>"), then increase <var title="">pos</var>
     by 3 and jump back to the previous step (step 6) in the overall
     algorithm in this section.</li>

     <li>Otherwise, increase <var title="">pos</var> by 1.</li>

     <li>Otherwise, return to step 2 in these substeps.</li>

    </ol>

   </li>

   <li><p>If <span><var title="">s</var>[<var
   title="">pos</var>]</span> is 0x21 (ASCII "<code
   title="">!</code>"):</p>

    <!-- this skips past a DOCTYPE if there is one. It is brain-dead
    because we don't have to be clever to parse the Atom and RSS x.y
    DOCTYPEs, as they don't do anything clever like have internal
    subsets of quoted ">" characters. If this fails, then that's ok,
    we'll treat it as HTML which is fine since we know it's not a feed
    in that case. -->

    <ol>

     <li>Increase <var title="">pos</var> by 1.</li>

     <li>If <span><var title="">s</var>[<var
     title="">pos</var>]</span> equal 0x3E, then increase <var
     title="">pos</var> by 1 and jump back to step 6 in the overall
     algorithm in this section.</li>

     <li>Otherwise, return to step 1 in these substeps.</li>

    </ol>

   </li>

   <li><p>If <span><var title="">s</var>[<var
   title="">pos</var>]</span> is 0x3F (ASCII "<code
   title="">?</code>"):</p>

    <ol>

     <li>Increase <var title="">pos</var> by 1.</li>

     <li>If <span><var title="">s</var>[<var
     title="">pos</var>]</span> and <span><var title="">s</var>[<var
     title="">pos</var>+1]</span> equal 0x3F and 0x3E respectively,
     then increase <var title="">pos</var> by 1 and jump back to
     step 6 in the overall algorithm in this section.</li>

     <li>Otherwise, return to step 1 in these substeps.</li>

    </ol>

   </li>

   <li><p>Otherwise, if the bytes in <var title="">s</var> starting at
   <var title="">pos</var> match any of the sequences of bytes in the
   first column of the following table, then the user agent must
   follow the steps given in the corresponding cell in the second
   column of the same row.</p>

    <table>
     <thead>
      <tr>
       <th>Bytes in Hexadecimal
       <th>Requirement
       <th>Comment

     <tbody>
      <tr>
       <td>72 73 73
       <td>The sniffed type of the resource is "application/rss+xml"; abort these steps
       <td>The three ASCII characters "<code title="">rss</code>"
      <tr>
       <td>66 65 65 64
       <td>The sniffed type of the resource is "application/atom+xml"; abort these steps
       <td>The four ASCII characters "<code title="">feed</code>"
      <tr>
       <td>72 64 66 3A 52 44 46
       <td>Continue to the next step in this algorithm
       <td>The ASCII characters "<code title="">rdf:RDF</code>"
    </table>

    <p>If none of the byte sequences above match the bytes in <var
    title="">s</var> starting at <var title="">pos</var>, then the
    sniffed type of the resource is "text/html". Abort these
    steps.</p>

   </li>

   <li><p class="big-issue">If, before the next ">", you find two
   xmlns* attributes with http://www.w3.org/1999/02/22-rdf-syntax-ns#
   and http://purl.org/rss/1.0/ as the namespaces, then the sniffed
   type of the resource is "application/rss+xml", abort these
   steps. (maybe we only need to check for http://purl.org/rss/1.0/
   actually)</p></li>

   <li><p>Otherwise, the sniffed type of the resource is
   "text/html".</p></li>

  </ol>

  <p class="note">For efficiency reaons, implementations may wish to
  implement this algorithm and the algorithm for detecting the
  character encoding of HTML documents in parallel.</p>


  <h4 id="read-html"><dfn title="navigate-html">Page load processing model for HTML files</dfn></h4>

  <p>When an HTML document is to be loaded in a <span>browsing
  context</span>, the user agent must create a <code>Document</code>
  object, mark it as being an <span>HTML document</span>, create an
  <span>HTML parser</span>, associate it with the document, and begin
  to use the bytes provided for the document as the <span>input
  stream</span> for that parser.</p>

  <p class="note">The <span>input stream</span> converts bytes into
  characters for use in the <span>tokeniser</span>. This process
  relies, in part, on character encoding information found in the real
  <span>Content-Type metadata</span> of the resource; the "sniffed
  type" is not used for this purpose.</p>

  <!-- next two paragraphs are nearly identical to the navigate-text
  section, keep them in sync -->

  <p>When no more bytes are available, an EOF character is implied,
  which eventually causes a <code title="event-load">load</code> event
  to be fired.</p>

  <p>After creating the <code>Document</code> object, but potentially
  before the page has finished parsing, the user agent must
  <span>update the session history with the new page</span>.</p>


  <h4 id="read-xml"><dfn title="navigate-xml">Page load processing model for XML files</dfn></h4>

  <p>When faced with displaying an XML file inline, user agents must
  first create a <code>Document</code> object, following the
  requirements of the XML and Namespaces in XML recommendations, RFC
  3023, DOM3 Core, and other relevant specifications. <a
  href="#refsXML">[XML]</a> <a href="#refsXMLNS">[XMLNS]</a> <a
  href="#refsRFC3023">[RFC3023]</a> <a
  href="#refsDOM3CORE">[DOM3CORE]</a></p>

  <p>The actual HTTP headers and other metadata, not the headers as
  mutated or implied by the algorithms given in this specification,
  are the ones that must be used when determining the character
  encoding according to the rules given in the above
  specifications.</p>

  <p>User agents may examine the namespace of the root
  <code>Element</code> node of this <code>Document</code> object to
  perform namespace-based dispatch to alternative processing tools,
  e.g. determining that the content is actually a syndication feed and
  passing it to a feed handler. If such processing is to take place,
  abort the steps in this section, and jump to step 10 in the
  <span>navigate</span> steps above.</p>

  <p>Otherwise, then, with the newly created <code>Document</code>,
  the user agents must <span>update the session history with the new
  page</span>. User agents may do this before the complete document
  has been parsed (thus achieving <i>incremental rendering</i>).</p>

  <p>Error messages from the parse process (e.g. namespace
  well-formedness errors) may be reported inline by mutating the
  <code>Document</code>.</p>


  <h4 id="read-text"><dfn title="navigate-text">Page load processing model for text files</dfn></h4>

  <p>When a plain text document is to be loaded in a <span>browsing
  context</span>, the user agent should create a <code>Document</code>
  object, mark it as being an <span>HTML document</span>, create an
  <span>HTML parser</span>, associate it with the document, act as if
  the tokeniser had emitted a start tag token with the tag name "pre",
  set the <span>tokenisation</span> stage's <span>content model
  flag</span> to <i>PLAINTEXT</i>, and begin to pass the stream of
  characters in the plain text document to that tokeniser.</p>

  <p>The rules for how to convert the bytes of the plain text document
  into actual characters are defined in RFC 2046, RFC 2646, and
  subsequent versions thereof. <a href="#refsRFC2046">[RFC2046]</a> <a
  href="#refsRFC2046">[RFC2646]</a></p>

  <!-- next two paragraphs are nearly identical to the navigate-html
  section, keep them in sync -->

  <p>When no more character are available, an EOF character is
  implied, which eventually causes a <code
  title="event-load">load</code> event to be fired.</p>

  <p>After creating the <code>Document</code> object, but potentially
  before the page has finished parsing, the user agent must
  <span>update the session history with the new page</span>.</p>


  <h4 id="scroll-to-fragid"><dfn title="navigate-fragid">Scrolling to a fragment identifier</dfn></h4>

  <p>When a user agent is supposed to scroll to a particular element,
  it may change the scrolling position of the document as desired, or
  perform any other relevant action.</p>

  <p class="big-issue">how to get a "particular element" from a frag
  id -- id="", name="", XPointer, etc; missing IDs (e.g. the infamous
  "#top")</p>

  <p>Then, the user agent must <span>update the session history with
  the new page</span>, where "the new page" has the same
  <code>Document</code> as before, but potentially has a different
  scroll position.</p>


  <h4 id="non-DOM-inline-content">Displaying inline content that doesn't have a DOM</h4>

  <p class="big-issue"><dfn>display a user agent page inline</dfn>, update history object</p>


  <h4 id="content-type"><dfn title="Content-Type">Content-Type metadata</dfn></h4>

  <!-- "explicit Content-Type metadata associated with the resource" -->
  <!-- "the resource's type information" -->

  <p class="big-issue">This is a placeholder section for some text
  that will define exactly how to handle Content-Type headers for
  top-level browsing contexts, for &lt;img>, &lt;embed>, &lt;object>,
  etc; and will cover things like the fact that on some operating
  systems the extension of a URI determines the Content-Type for
  file:// content, or something.</p>


  <h4 id="javascript-protocol"><dfn title="javascript protocol">The <code title="">javascript:</code> protocol</dfn></h4>

  <p class="big-issue">Must define the interaction of navigation with
  document.write() pages (done?) and navigating to javascript:
  URIs.</p>

  <!-- XXX see below for another javascript: section -->



  <h3 id="scripting">Scripting</h3>

  <div class="big-issue">

   <p>Here are some of the things I think we should list:</p>

   <ul>

    <li>onload/onunload events</li>

    <li>alert() blocks scripts, even those on timeouts or
    readystatechange events</li>

   </ul>

   <!-- XXX what about event handlers on elements in document A
   referring to methods in document A when browsing context holding
   document A is moved to document B? Same with executing javascript:
   URIs on elements from doc A in that situation -->

  </div>


  <h4>Running executable code</h4>

  <p>Various mechanisms can cause author-provided executable code to
  run in the context of a document. These mechanisms include, but are
  probably not limited to:</p>

  <ul>

   <li>Processing of <code>script</code> elements.</li>

   <li>Processing of inline <code
   title="javascript-scheme">javascript:</code> URIs (e.g. the <code
   title="attr-img-src">src</code> attribute of <code>img</code>
   elements, or an <code title="">@import</code> rule in a CSS
   <code>style</code> element block).</li>

   <li>Event handlers, whether registered through the DOM using <code
   title="">addEventListener()</code>, by explicit <span>event handler
   content attributes</span>, by <span>event handler DOM
   attributes</span>, or otherwise.</li>

   <li>Processing of technologies like XBL or SVG that have their own
   scripting features.</li>

  </ul>

  <p>User agents may provide a mechanism to enable or disable the
  execution of author-provided code. When the user agent is configured
  such that author-provided code does not execute, or if the user
  agent is implemented so as to never execute author-provided code, it
  is said that <dfn>scripting is disabled</dfn>. When author-provided
  code <em>does</em> execute, <dfn>scripting is enabled</dfn>. A user
  agent with scripting disabled is a <span title="User agents with no
  scripting support">user agent with no scripting support</span> for
  the purposes of conformance.</p>


  <h4>Scripting contexts</h4>

  <p>Each <code>Document</code> in a <span>browsing context</span> has
  an associated <dfn>scripting context</dfn>.</p>


  <h4>Threads</h4>

  <p>Each <span>scripting context</span> is defined as having a list
  of zero or more <dfn>reachable scripting contexts</dfn>. These
  are:</p>

  <ul>

   <li>All the <span title="scripting context">scripting
   contexts</span> of all the <code>Document</code>s in each nested
   <span>browsing context</span> inside the scripting context's
   <code>Document</code>.</li>

   <li>The <span>scripting context</span> of the <code>Document</code>
   that contains the <code>Document</code>'s <span>browsing
   context</span>.</li>

   <li>All the <span title="scripting context">scripting
   contexts</span> of all the <code>Document</code>s associated with
   any <span title="top-level browsing context">top-level browsing
   contexts</span> that were opened from a <code>Document</code>
   associated with the <span>scripting context</span>'s
   <code>Document</code>'s <span>browsing context</span>.</li>

   <li>All the <span title="scripting context">scripting
   contexts</span> of all the <code>Document</code>s associated with
   the <span title="top-level browsing context">top-level browsing
   contexts</span> of the <span>browsing context</span> of the
   <code>WindowHTML</code> object returned by the <span>scripting
   context</span>'s <code>Document</code>'s <code>WindowHTML</code>'s
   <code title="dom-opener">opener</code> attribute.</li>

  </ul>

  <p>The transitive closure of all the <span title="scripting
  context">scripting contexts</span> that are <span>reachable
  scripting contexts</span> consists of a <dfn>unit of related
  scripting contexts</dfn>.</p>

  <p>All the executable code in a <span>unit of related scripting
  contexts</span> must execute on a single conceptual thread. While a
  script is executing, no other scripts in that <span>unit of related
  scripting contexts</span> must be started.</p>

  <p>Events fired by the user agent in response to user actions must
  be queued, as must the execution of any timers. There must be only
  one queue per <span>unit of related scripting contexts</span>. When
  no script in the <span>unit of related scripting contexts</span> is
  executing, the oldest entry in the queue must be processed, either
  by firing the appropriate event, or by executing the relevant timer
  callback code.</p>



  <h4 id="scripting-security">The security model</h4>

<!-- https://bugzilla.mozilla.org/show_bug.cgi?id=346659 -->

  <p><em>Web browser vendors should implement this security model, to
  provide Web authors with a consistent development environment that
  is interoperable across different implementations. However,
  implementors may use any other model if desired.</em></p>

  <p>The security model for Web browsers has grown organically with
  the development of the Web, and as such is somewhat unique.</p>

  <p>Access to resources and APIs is granted or denied to Web content
  (scripts, elements, etc) based on the content's
  <dfn>origin</dfn>. For historical reasons, the mechanism for
  determining the <em>origin</em> of a particular piece of content
  depends on the nature of the content.</p>

  <p class="big-issue">...</p>
<!--
 XXX this is a very confused section, so I've commented it out

  <p>For <code>Document</code>s:</p>

  <dl class="switch">

   <dt>If it was served over the network using HTTP, HTTPS, FTP, or
   another protocol whose scheme contains a <em>host authority
   component</em>:</dt>

   <dd>

    <p>The resource's origin consists of the scheme, host, and port
    parts of the resource's full URI.</p>

    <p class="example">For example, if a Web page has the address
    <code>https://www.example.com/demo.html</code>, the origin
    consists of the tuple "https", "www.example.com", and "443".</p>

   </dd>

   <dt>If it was created by script...</dt>

   <dd>

    <p>The resource's origin consists of the scheme, host, and port
    parts of the resource's full URI.</p>

    <p class="example">For example, if a Web page has the address
    <code>https://www.example.com/demo.html</code>, the origin
    consists of the tuple "https", "www.example.com", and "443".</p>

   </dd>


   <dt>A document resource (a <code>Document</code>) that was served
   over the network using HTTP, HTTPS, FTP, or another protocol whose
   scheme contains a <em>host authority component</em>:</dt>

   <dd>

    <p>The resource's origin consists of the scheme, host, and port
    parts of the resource's full URI.</p>

    <p class="example">For example, if a Web page has the address
    <code>https://www.example.com/demo.html</code>, the origin
    consists of the tuple "https", "www.example.com", and "443".</p>

   </dd>

   <dt>If the content was generated by script:</dt>

   <dd>The content shares the same origin as the script itself.</dd>

   <dt>If the content was generated by 

  </dl>


   what other kinds of content do we care about the origin of?
   images, for the purpose of <canvas>?
   Window objects?
-->

  <p>The <dfn title="document's domain">domain of a
  <code>Document</code> object</dfn> is the domain given by the
  <code>hostname</code> attribute of the <code>Location</code> object
  returned by the <code>Document</code> object's <code
  title="dom-document-location">location</code> attribute, <em>if</em>
  that <code>hostname</code> attribute is not the empty string. <span
  class="big-issue">If it is, the domain of the document is
  UA-defined. For now.</span> <!-- XXX data: and javascript: URIs
  should be relative to the spawning <code>Document</code>, but we
  need to make sure that's a defined concept first. --> <span
  class="big-issue">Need to be more correct about where .location is
  defined. It's not actually on Document.</span></p>

  <p>The <dfn title="script's domain">domain of a script</dfn> is the
  <span title="document's domain">domain of the <code>Document</code>
  object</span> that is returned by the <code
  title="dom-document">document</code> attribute of the script's
  primary <code>Window</code> object (in UAs that implement
  ECMAScript, that is the <span>global scope</span> object).</p> <!--
  scripting context? -->

  <p><dfn>The string representing the script's domain in IDNA
  format</dfn> is obtained as follows: take the <span>script's
  domain</span> and apply the IDNA ToASCII algorithm and then the IDNA
  ToUnicode algorithm to each component of the domain name (with both
  the AllowUnassigned and UseSTD3ASCIIRules flags set both times). <a
  href="#refsRFC3490">[RFC3490]</a> If ToASCII fails to convert one of
  the components of the string, e.g. because it is too long or because
  it contains invalid characters, then the string representing the
  script's domain in IDNA format cannot be obtained. (ToUnicode is
  defined to never fail.)</p>

  <p class="big-issue">This section is <em>so</em> not complete.</p>

  <p class="big-issue">Define <dfn>security exception</dfn>.</p>


  <h4><code>javascript:</code> URIs</h4>

  <p class="big-issue">What's the scripting context for javascript:
  URIs in &lt;img src>, &lt;iframe src>, &lt;location.href>, &lt;a
  href>, @import, background-image, etc?</p>

  <!--XXX don't execute them when <span>scripting is disabled</span>
  or when the <code>Document</code> has <code
  title="dom-document-designMode">designMode</code> enabled -->

  <!-- XXX see above for another javascript: section -->


  <h4 id="runtime-script-errors">Runtime script errors</h4>

  <p>Whenever a runtime script error occurs in one of the scripts
  associated with the document, the value of the
  <dfn><code>onerror</code></dfn> attribute of the <code>window</code>
  object (defined on the <code>WindowHTML</code> interface of that
  object), must be processed, as follows:</p>

  <dl class="switch">

   <dt>If the value is a function</dt>

   <dd>

    <p>The function referenced by the <code>onerror</code> attribute
    must be invoked with three arguments, before notifying the user of
    the error.</p>

    <p>The three arguments passed to the function are all
    <code>DOMString</code>s; the first must give the message that the
    UA is considering reporting, the second must give the URI to the
    resource in which the error occured, and the third must give the
    line number in that resource on which the error occured.</p>

    <p>If the function returns false, then the error should not be
    reported to the user. Otherwise, if the function returns another
    value (or does not return at all), the error should be reported to
    the user.</p>

    <p>Any exceptions thrown or errors caused by this function must be
    reported to the user immediately after the error that the function
    was called for, without calling the function again.</p>

   </dd>

   <dt>If the value is <code>null</code></dt>

   <dd>

    <p>The error should not reported to the user.</p>

   </dd>

   <dt>If the value is anything else</dt>

   <dd>

    <p>The error should be reported to the user.</p>

   </dd>

  </dl>

  <p>The initial value of <code>onerror</code> must be
  <code>undefined</code>.</p>



  <h4>Events</h4>

  <h5 id="event-handler-attributes">Event handler attributes</h5>

  <p><span>HTML elements</span> can have <dfn>event handler
  attributes</dfn> specified. These act as bubbling event listeners
  for the element on which they are specified.</p>

  <p>Each event handler attribute has two parts, an <span title="event
  handler content attributes">event handler content attribute</span>
  and an <span title="event handler DOM attributes">event handler DOM
  attribute</span>. Event handler attributes must initially be set to
  null. When their value changes (through the changing of their event
  handler content attribute or their event handler DOM attribute),
  they will either be null, or have an <code>EventListener</code>
  object assigned to them.</p>

  <p id="js-function-listener">In the ECMAScript DOM binding, the
  ECMAScript native <code>Function</code> type must implement the
  <code>EventListener</code> interface such that invoking the
  <code>handleEvent()</code> method of that interface on the object
  from another language binding invokes the function itself, with the
  <code>event</code> argument as its only argument. In the ECMAScript
  binding itself, however, the <code>handleEvent()</code> method of
  the interface is not directly accessible on <code>Function</code>
  objects. Such functions, when invoked, must be called in the
  <span>global scope</span><!-- XXX which global scope? should this be
  scripting context? -->. If the function returns false, the event's
  <code>preventDefault()</code> method must then invoked. Exception:
  for historical reasons, for the HTML <code>mouseover</code> event,
  the <code>preventDefault()</code> method must be called when the
  function returns true instead.</p>

  <p><dfn>Event handler content attributes</dfn>, when specified, must
  contain valid ECMAScript code matching the ECMAScript <code
  title="">FunctionBody</code> production. <a
  href="#refsECMA262">[ECMA262]</a></p>

  <p>When an event handler content attribute is set, its new value
  must be interpreted as the body of an anonymous function with a
  single argument called <code>event</code>, with the new function's
  scope chain being linked from the activation object of the handler,
  to the element, to the element's <code>form</code> element if it is
  a form control, to the <code>Document</code> object, to the
  <span>global scope</span>. The function's <code>this</code>
  parameter must be the <code>Element</code> object representing the
  element. The resulting function must then be set as the value of the
  corresponding event handler attribute, and the new value must be set
  as the value of the content attribute. If the given function body
  fails to compile, then the corresponding event handler attribute
  must be set to null instead (the content attribute must still be
  updated to the new value, though).</p>

  <p class="note">See ECMA262 Edition 3, sections 10.1.6 and 10.2.3,
  for more details on activation objects. <a
  href="#refsECMA262">[ECMA262]</a></p>

  <p class="issue">How do we allow non-JS event handlers?</p>

  <p><dfn>Event handler DOM attributes</dfn>, on setting, must set the
  corresponding event handler attribute to their new value, and on
  getting, must return whatever the current value of the corresponding
  event handler attribute is (possibly null).</p>

  <p>The following are the event handler attributes that must be
  supported by all <span>HTML elements</span>, as both content
  attributes and DOM attributes:</p>

  <dl>

   <dt><dfn title="handler-onabort"><code>onabort</code></dfn></dt>

   <dd>Must be invoked whenever an <code
   title="event-abort">abort</code> event is targeted at or bubbles
   through the element.</dd>

<!--
   <dt><dfn title="handler-onbeforecopy"><code>onbeforecopy</code></dfn></dt> --><!-- widely used --><!--

   <dd>Must be invoked whenever a <code
   title="event-beforecopy">beforecopy</code> event is targeted at or bubbles
   through the element.</dd>
-->

   <dt><dfn title="handler-onbeforeunload"><code>onbeforeunload</code></dfn></dt>

   <dd>Must be invoked whenever a <code
   title="event-beforeunload">beforeunload</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onblur"><code>onblur</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-blur">blur</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onchange"><code>onchange</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-change">change</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onclick"><code>onclick</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-click">click</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-oncontextmenu"><code>oncontextmenu</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-contextmenu">contextmenu</code> event is targeted at or bubbles
   through the element.</dd>

<!--
   <dt><dfn title="handler-oncopy"><code>oncopy</code></dfn></dt> --><!-- widely used --><!--

   <dd>Must be invoked whenever a <code
   title="event-copy">copy</code> event is targeted at or bubbles
   through the element.</dd>
-->

   <dt><dfn title="handler-ondblclick"><code>ondblclick</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-dblclick">dblclick</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-ondrag"><code>ondrag</code></dfn></dt>

   <dd>Must be invoked whenever a <code
   title="event-drag">drag</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-ondragend"><code>ondragend</code></dfn></dt>

   <dd>Must be invoked whenever a <code
   title="event-dragend">dragend</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-ondragenter"><code>ondragenter</code></dfn></dt>

   <dd>Must be invoked whenever a <code
   title="event-dragenter">dragenter</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-ondragleave"><code>ondragleave</code></dfn></dt>

   <dd>Must be invoked whenever a <code
   title="event-dragleave">dragleave</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-ondragover"><code>ondragover</code></dfn></dt>

   <dd>Must be invoked whenever a <code
   title="event-dragover">dragover</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-ondragstart"><code>ondragstart</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-dragstart">dragstart</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-ondrop"><code>ondrop</code></dfn></dt>

   <dd>Must be invoked whenever a <code
   title="event-drop">drop</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onerror"><code>onerror</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever an <code
   title="event-error">error</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onfocus"><code>onfocus</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-focus">focus</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onkeydown"><code>onkeydown</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-keydown">keydown</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onkeypress"><code>onkeypress</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-keypress">keypress</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onkeyup"><code>onkeyup</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-keyup">keyup</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onload"><code>onload</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-load">load</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onmessage"><code>onmessage</code></dfn></dt> <!-- introduced for <event-source> -->

   <dd>Must be invoked whenever a <code
   title="event-message">message</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onmousedown"><code>onmousedown</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-mousedown">mousedown</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onmousemove"><code>onmousemove</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-mousemove">mousemove</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onmouseout"><code>onmouseout</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-mouseout">mouseout</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onmouseover"><code>onmouseover</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-mouseover">mouseover</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onmouseup"><code>onmouseup</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-mouseup">mouseup</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onmousewheel"><code>onmousewheel</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-mousewheel">mousewheel</code> event is targeted at or bubbles
   through the element.</dd>

<!--
   <dt><dfn title="handler-onpaste"><code>onpaste</code></dfn></dt> --><!-- widely used --><!--

   <dd>Must be invoked whenever a <code
   title="event-paste">paste</code> event is targeted at or bubbles
   through the element.</dd>
-->

   <dt><dfn title="handler-onresize"><code>onresize</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-resize">resize</code> event is targeted at or bubbles
   through the element.</dd> <!-- XXX should define when it fires -->

   <dt><dfn title="handler-onscroll"><code>onscroll</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-scroll">scroll</code> event is targeted at or bubbles
   through the element.</dd> <!-- XXX should define when it fires -->

   <dt><dfn title="handler-onselect"><code>onselect</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-select">select</code> event is targeted at or bubbles
   through the element.</dd> <!-- XXX should define when it fires -->

<!--XXX
   <dt><dfn title="handler-onselectstart"><code>onselectstart</code></dfn></dt> --><!-- widely used --><!--

   <dd>Must be invoked whenever a <code
   title="event-selectstart">selectstart</code> event is targeted at or bubbles
   through the element.</dd>
--> <!-- XXX should define when it fires -->

   <dt><dfn title="handler-onsubmit"><code>onsubmit</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever a <code
   title="event-submit">submit</code> event is targeted at or bubbles
   through the element.</dd>

   <dt><dfn title="handler-onunload"><code>onunload</code></dfn></dt> <!-- widely used -->

   <dd>Must be invoked whenever an <code
   title="event-unload">unload</code> event is targeted at or bubbles
   through the element.</dd> <!-- XXX need to fire this -->


  </dl>

  <p>When <span>scripting is disabled</span>, event handler attributes
  must do nothing.</p>

  <p>When <span>scripting is enabled</span>, all event handler
  attributes on an element, whether set to null or to a function, must
  be registered as event listeners on the element, as if the <code
  title="dom-EventTarget-addEventListenerNS">addEventListenerNS()</code>
  method on the <code>Element</code> object's <code>EventTarget</code>
  interface had been invoked when the element was created, with the
  event type (<code title="dom-event-type">type</code> argument) equal
  to the type described for the event handler attribute in the list
  above, the namespace (<code
  title="dom-event-namespaceURI">namespaceURI</code> argument) set to
  null, the listener set to be a target and bubbling phase listener
  (<code title="dom-event-useCapture">useCapture</code> argument set
  to false), the event group set to the default group (<code
  title="dom-event-evtGroup">evtGroup</code> argument set to null),
  and the event listener itself (<code
  title="dom-event-listener">listener</code> argument) set to do
  nothing while the event handler attribute is null, and set to invoke
  the function associated with the event handler attribute
  otherwise.</p>


  <h5>Event firing</h5>

  <p class="big-issue">maybe _this_ should be moved higher up
  (terminology? conformance? DOM?)</p>

  <p>Certain operations and methods are defined as firing events on
  elements. For example, the <code title="dom-click">click()</code>
  method on the <code>HTMLElement</code> interface is defined as
  firing a <code title="event-click">click</code> event on the
  element.  <a href="#refsDOM3EVENTS">[DOM3EVENTS]</a></p>

  <p><dfn title="fire a click event">Firing a <code
  title="event-click">click</code> event</dfn> means that a <a
  href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#event-click"><code>click</code></a>
  event with no
  namespace, which bubbles and is cancelable, and which uses the
  <code>MouseEvent</code> interface, must be dispatched at the given
  element. The event object must have its <code
  title="">screenX</code>, <code title="">screenY</code>, <code
  title="">clientX</code>, <code title="">clientY</code>, and <code
  title="">button</code> attributes set to 0, its <code
  title="">ctrlKey</code>, <code title="">shiftKey</code>, <code
  title="">altKey</code>, and <code title="">metaKey</code> attributes
  set according to the current state of the key input device, if any
  (false for any keys that are not available), its <code
  title="">detail</code> attribute set to 1, and its <code
  title="">relatedTarget</code> attribute set to null. The <code
  title="">getModifierState()</code> method on the object must return
  values appropriately describing the state of the key input device at
  the time the event is created.</p>

  <p><dfn title="fire a change event">Firing a <code
  title="event-change">change</code> event</dfn> means that a <a
  href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#event-change"><code>change</code></a>
  event with no namespace, which bubbles but is not cancelable, and
  which uses the <code>Event</code> interface, must be dispatched at
  the given element. The event object must have its <code
  title="">detail</code> attribute set to 0.</p>

  <p><dfn title="fire a contextmenu event">Firing a <code
  title="event-contextmenu">contextmenu</code> event</dfn> means that
  a <code title="event-contextmenu">contextmenu</code> event with no
  namespace, which bubbles and is cancelable, and which uses the
  <code>Event</code> interface, must be dispatched at the given
  element. The event object must have its <code title="">detail</code>
  attribute set to 0.</p>

  <p><dfn title="fire a simple event">Firing a simple event called
  <var title="">e</var></dfn> means that an event with the name <var
  title="">e</var>, with no namespace, which does not bubble but is
  cancelable, and which uses the <code>Event</code> interface, must be
  dispatched at the given element.</p>

  <p><dfn title="fire a show event">Firing a <code
  title="event-show">show</code> event</dfn> means <span title="fire a
  simple event">firing a simple event called <code
  title="event-show">show</code></span>. <dfn title="fire a load
  event">Firing a <code title="event-load">load</code> event</dfn>
  means <span title="fire a simple event">firing a simple event called
  <code title="event-load">load</code></span>. <!--<dfn title="fire a
  DOMContentLoaded event">Firing a <code
  title="event-DOMContentLoaded">DOMContentLoaded</code> event</dfn>
  means <span title="fire a simple event">firing a simple event called
  <code
  title="event-DOMContentLoaded">DOMContentLoaded</code></span>.-->
  <dfn title="fire an error event">Firing an <code
  title="event-error">error</code> event</dfn> means <span title="fire
  a simple event">firing a simple event called <code
  title="event-error">error</code></span>.</p>

  <!-- XXX need to define the dispatching of DOMActivate -->

  <p>The default action of these event is to do nothing unless
  otherwise stated.</p>

  <p class="big-issue">If you dispatch a custom "click" event at an
  element that would normally have default actions, should they get
  triggered? If so, we need to go through the entire spec and make
  sure that any default actions are defined in terms of <em>any</em>
  event of the right type on that element, not those that are
  dispatched in expected ways.</p>



  <h3 id="links">Links</h3>


  <h4>Hyperlink elements</h4>

  <p>The <code>a</code>, <code>area</code>, and <code>link</code>
  elements can, in certain situations described in the definitions of
  those elements, represent <dfn
  title="hyperlink">hyperlinks</dfn>.</p>

  <p>The <dfn title="attr-hyperlink-href"><code>href</code></dfn>
  attribute on a hyperlink element must have a value that is a URI (or
  IRI). This URI is the <em>destination resource</em> of the
  hyperlink.</p>

  <div class="note">

   <p>The <code title="">href</code> attribute on <code>a</code> and
   <code>area</code> elements is not required; when those elements do
   not have <code title="">href</code> attributes they do not
   represent hyperlinks.</p>

   <p>The <code title="attr-link-href">href</code> attribute on the
   <code>link</code> element <em>is</em> required, but whether a
   <code>link</code> element represents a hyperlink or not depends on
   the value of the <code title="attr-link-rel">rel</code> attribute
   of that element.</p>

  </div>

  <p>For <code>a</code> and <code>area</code> elements that represent
  hyperlinks, the relationship between the document containing the
  hyperlink and the destination resource indicated by the hyperlink is
  given by the value of the element's <dfn
  title="attr-hyperlink-rel"><code>rel</code></dfn> attribute, which
  is an <span>unordered set of space-separated tokens</span>. The <a
  href="#linkTypes">allowed values and their meanings</a> are defined
  below. The <code title="attr-hyperlink-rel">rel</code> attribute has
  no default value. If the attribute is omitted or if none of the
  values in the attribute are recognised by the UA, then the document
  has no particular relationship with the destination resource other
  than there being a hyperlink between the two.</p>

  <p>The <dfn title="attr-hyperlink-media"><code>media</code></dfn>
  attribute describes for which media the target document was
  designed. It is purely advisory. The value must be a valid media
  query. <a href="#refsMQ">[MQ]</a> The default, if the <code
  title="attr-hyperlink-media">media</code> attribute is omitted or
  has an invalid value, is <code>all</code>.</p>

  <p>The <dfn
  title="attr-hyperlink-hreflang"><code>hreflang</code></dfn>
  attribute on hyperlink elements, if present, gives the language of
  the linked resource. It is purely advisory. The value must be a
  valid RFC 3066 language code. <a href="#refsRFC3066">[RFC3066]</a>
  User agents must not consider this attribute authoritative &mdash;
  upon fetching the resource, user agents must only use language
  information associated with the resource to determine its language,
  not metadata included in the link to the resource.</p>

  <p>The <dfn title="attr-hyperlink-type"><code>type</code></dfn>
  attribute, if present, gives the MIME type of the linked
  resource. It is purely advisory. The value must be a valid MIME
  type, optionally with parameters. <a
  href="#refsRFC2046">[RFC2046]</a> User agents must not consider the
  <code title="attr-hyperlink-type">type</code> attribute
  authoritative &mdash; upon fetching the resource, user agents must
  only use <span title="Content-Type">the Content-Type information
  associated with the resource</span> to determine its type, not
  metadata included in the link to the resource.</p>

  <p>The <dfn id="ping"
  title="attr-hyperlink-ping"><code>ping</code></dfn> attribute, if
  present, gives the URIs of the resources that are interested in
  being notified if the user follows the hyperlink. The value must be
  a space separated list of one or more URIs (or IRIs). The value is
  used by the user agent when <span>following hyperlinks</span>.</p>



  <h4><dfn>Following hyperlinks</dfn></h4>

  <p>When a user <em>follows a hyperlink</em>, the user agent must
  <span>navigate</span> a <span>browsing context</span> to the URI
  specified by the <code title="attr-hyperlink-href">href</code>
  attribute of that hyperlink. In the case of server-side image maps,
  there will be a <var title="">hyperlink suffix</var> defined. In
  that case, instead of navigating to the URI specified by the <code
  title="attr-hyperlink-href">href</code> attribute, the user agent
  must instead navigate to the URI specified by the <code
  title="attr-hyperlink-href">href</code> attribute with the value of
  the <var title="">hyperlink suffix</var> appended on the end
  (regardless of whether the resulting URI is valid or not).</p>

  <p>If the user indicated a specific browsing context when following
  the hyperlink, or if the user agent is configured to follow
  hyperlinks by navigating a particular browsing context, then that is
  the browsing context that must be navigated.</p>

  <p>Otherwise, if the hyperlink element has a <code
  title="attr-hyperlink-target">target</code> attribute, then the
  browsing context that is navigated must be chosen as follows:</p>

  <ol class="big-issue">
   <li> ... </li>
  </ol>

  <p>Otherwise, the browsing context that must be navigated is the
  same browsing context as the one which the hyperlink element itself
  is in.</p>



  <h5>Hyperlink auditing</h5>

  <p>If an <code>a</code> or <code>area</code> hyperlink element has a
  <code title="attr-hyperlink-ping">ping</code> attribute and the user
  follows the hyperlink, the user agent must take the <code
  title="attr-hyperlink-ping">ping</code> attribute's value, strip
  leading and trailing <span title="space character">spaces</span>,
  split the value on sequences of spaces, treat each resulting part as
  a URI (resolving relative URIs according to element's base URI) and
  then should send a request to each of the resulting URIs. This may
  be done in parallel with the primary request, and is independent of
  the result of that request.</p>

  <p>User agents should allow the user to adjust this behaviour, for
  example in conjunction with a setting that disables the sending of
  HTTP Referrer headers. Based on the user's preferences, UAs may
  either <span>ignore</span> the <code title="attr-hyperlink-ping">ping</code>
  attribute altogether, or selectively ignore URIs in the list
  (e.g. ignoring any third-party URIs).</p>

  <p>For URIs that are HTTP URIs, the requests must be performed using
  the POST method (with an empty entity body in the request). User
  agents must ignore any entity bodies returned in the responses, but
  must, unless otherwise specified by the user, honour the HTTP
  headers &mdash; in particular, HTTP cookie headers. <a
  href="#refsRFC2965">[RFC2965]</a></p>

  <p class="note">To save bandwidth, implementors might wish to
  consider omitting optional headers such as <code>Accept</code> from
  these requests.</p>

  <p>When the <code title="attr-hyperlink-ping">ping</code> attribute is
  present, user agents should clearly indicate to the user that
  following the hyperlink will also cause secondary requests to be
  sent in the background, possibly including listing the actual target
  URIs.</p>

  <div class="note">

   <p>The <code title="attr-hyperlink-ping">ping</code> attribute is redundant
   with pre-existing technologies like HTTP redirects and JavaScript
   in allowing Web pages to track which off-site links are most
   popular or allowing advertisers to track click-through rates.</p>

   <p>However, the <code title="attr-hyperlink-ping">ping</code> attribute
   provides these advantages to the user over those alternatives:</p>

   <ul>

    <li>It allows the user to see the final target URI
    unobscured.</li>

    <li>It allows the UA to inform the user about the out-of-band
    notifications.</li>

    <li>It allows the paranoid user to disable the notifications
    without losing the underlying link functionality.</li>

    <li>It allows the UA to optimise the use of available network
    bandwidth so that the target page loads faster.</li>

   </ul>
  
   <p>Thus, while it is possible to track users without this feature,
   authors are encouraged to use the <code
   title="attr-hyperlink-ping">ping</code> attribute so that the user agent
   can improve <!-- XXX optimise? --> the user experience.</p> <!--
   XXX need a better way to end that sentence. It's what I mean, but
   it sounds kooky. -->

  </div>



  <h4 id="linkTypes">Link types</h4>

  <p>The following table summarises the link types that are defined by
  this specification. This table is non-normative; the actual
  definitions for the link types are given in the next few
  sections.</p>

  <p>In this section, the term <em>referenced document</em> refers to
  the resource identified by the element representing the link, and
  the term <em>current document</em> refers to the resource within
  which the element representing the link finds itself.</p>

  <p>To determine which link types apply to a <code>link</code>,
  <code>a</code>, or <code>area</code> element, the element's <code
  title="">rel</code> attribute must be <span title="split a string on
  spaces">split on spaces</span>. The resulting tokens are the link
  types that apply to that element.</p>

  <table>
   <thead>
    <tr>
     <th rowspan="2">Link type</th>
     <th colspan="2">Effect on...</th>
     <th rowspan="2">Brief description</th>
    </tr>
    <tr>
     <th><code>link</code></th>
     <th><code>a</code> and <code>area</code></th>
    </tr>
   </thead>
   <tbody>

    <tr>
     <td><code title="rel-alternate">alternate</code></td> <!-- second most used <link rel> value -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Gives alternate representations of the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-archives">archives</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Provides a link to a collection of records, documents, or other materials of historical interest.</td>
    </tr>

    <tr>
     <td><code title="rel-author">author</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Gives a link to the current document's author.</td>
    </tr>

    <tr>
     <td><code title="rel-bookmark">bookmark</code></td> <!-- fourth most used <a rel> value -->
     <td><em>not allowed</em></td>
     <td><span>Hyperlink</span></td>
     <td>Gives the permalink for the nearest ancestor section.</td>
    </tr>

    <tr>
     <td><code title="rel-contact">contact</code></td> <!-- 8th most used <a rel> value -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Gives a link to contact information for the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-external">external</code></td> <!-- fifth and sixth most used <a rel> value (sixth is "external nofollow") -->
     <td><em>not allowed</em></td>
     <td><span>Hyperlink</span></td>
     <td>Indicates that the referenced document is not part of the same site as the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-feed">feed</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Gives the address of a syndication feed for the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-first">first</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Indicates that the current document is a part of a series, and that the first document in the series is the referenced document.</td>
    </tr>

    <tr>
     <td><code title="rel-help">help</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Provides a link to context-sensitive help.</td>
    </tr>

    <tr>
     <td><code title="rel-icon">icon</code></td> <!-- link rel="shortcut icon" and its ilk are the fourth, sixth, and ninth most used values -->
     <td><span title="external resource link">External Resource</span></td>
     <td><em>not allowed</em></td>
     <td>Imports an icon to represent the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-index">index</code></td> <!-- used more than "top" and "contents" on <link> (though on <a>, "contents" wins) -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Gives a link to the document that provides a table of contents or index listing the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-last">last</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Indicates that the current document is a part of a series, and that the last document in the series is the referenced document.</td>
    </tr>

    <tr>
     <td><code title="rel-license">license</code></td> <!-- seventh most used <a rel> value -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Indicates that the current document is covered by the copyright license described by the referenced document.</td>
    </tr>

    <tr>
     <td><code title="rel-next">next</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Indicates that the current document is a part of a series, and that the next document in the series is the referenced document.</td>
    </tr>

    <tr>
     <td><code title="rel-nofollow">nofollow</code></td> <!-- most used <a rel> value (and sixth most used is "external nofollow") -->
     <td><em>not allowed</em></td>
     <td><span>Hyperlink</span></td>
     <td>Indicates that the current document's original author or publisher does not endorse the referenced document.</td>
    </tr>

    <tr>
     <td><code title="rel-pingback">pingback</code></td>
     <td><span title="external resource link">External Resource</span></td>
     <td><em>not allowed</em></td>
     <td>Gives the address of the pingback server that handles pingbacks to the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-prefetch">prefetch</code></td>
     <td><span title="external resource link">External Resource</span></td>
     <td><em>not allowed</em></td>
     <td>Specifies that the target resource should be pre-emptively cached.</td>
    </tr>

    <tr>
     <td><code title="rel-prev">prev</code></td> <!-- prev is used more than previous -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Indicates that the current document is a part of a series, and that the previous document in the series is the referenced document.</td>
    </tr>

    <tr>
     <td><code title="rel-search">search</code></td> <!-- used quite a bit -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Gives a link to a resource that can be used to search through the current document and its related pages.</td>
    </tr>

    <tr>
     <td><code title="rel-stylesheet">stylesheet</code></td> <!-- most commonly used <link rel> value, variants came in 7th, 8th, 12th, 17th... -->
     <td><span title="external resource link">External Resource</span></td>
     <td><em>not allowed</em></td>
     <td>Imports a stylesheet.</td>
    </tr>

    <tr>
     <td><code title="rel-sidebar">sidebar</code></td> <!-- used quite a bit -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Specifies that the referenced document, if retrieved, is intended to be shown in the browser's sidebar (if it has one).</td>
    </tr>

    <tr>
     <td><code title="rel-tag">tag</code></td> <!-- second and third most used <a rel> value (third is technically "category tag"). -->
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Gives a tag (identified by the given address) that applies to the current document.</td>
    </tr>

    <tr>
     <td><code title="rel-up">up</code></td>
     <td><span title="hyperlink link">Hyperlink</span></td>
     <td><span>Hyperlink</span></td>
     <td>Provides a link to a document giving the context for the current document.</td>
    </tr>

   </tbody>
  </table>

  <p>Some of the types described below list synonyms for these
  values. These are to be handled as specified by user agents, but
  must not be used in documents.</p>


  <!--XXX

  issues for rel="", etc:
   rel="alternate stylesheet"
   rel="script"
   rel="related" // see also
   which relationship combinations are allowed
   what multiple values might mean (multiple <a rel="top"> in the same document)
   http://www.euronet.nl/~tekelenb/WWW/LINK/
   http://shift.freezope.org/konq_rellinks/development_html
   http://hixie.ch/specs/html/link/001
   http://hixie.ch/specs/html/link/002
   http://www.hixie.ch/specs/html/metadata
   what UAs are supposed to do with this
   do something about http://microformats.org/wiki/rel-enclosure

mpt says:
> "As with <a> elements, when <link> elements that use these relationships    
> are present, UAs should render them. As with <a> elements, when <link>
> elements that use these relationships do not exist, UAs should not
> render them. UAs should not make <link> rendering any easier to hide
> than <a> rendering."
  
    -->


  <h5>Link type "<dfn title="rel-alternate"><code>alternate</code></dfn>"</h5>

  <p>The <code title="rel-alternate">alternate</code> keyword may be
  used with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, if the <code
  title="attr-link-rel">rel</code> attribute does not also contain the
  keyword <code title="rel-stylesheet">stylesheet</code>, it creates a
  <span title="hyperlink link">hyperlink</span>; but if it
  <em>does</em> also contains the keyword <code
  title="rel-stylesheet">stylesheet</code>, the <code
  title="rel-alternate">alternate</code> keyword instead modifies the
  meaning of the <code title="rel-stylesheet">stylesheet</code>
  keyword in the way described for that keyword, and the rest of this
  subsection doesn't apply.</p>

  <p>The <code title="rel-alternate">alternate</code> keyword
  indicates that the referenced document is an alternate
  representation of the current document.</p>

  <p>The nature of the referenced document is given by the <code
  title="attr-hyperlink-media">media</code>, <code
  title="attr-hyperlink-hreflang">hreflang</code>, and <code
  title="attr-hyperlink-type">type</code> attributes.</p>

  <p>If the <code title="rel-alternate">alternate</code> keyword is
  used with the <code title="attr-hyperlink-media">media</code>
  attribute, it indicates that the referenced document is intended for use
  with the media specified.</p>

  <p>If the <code title="rel-alternate">alternate</code> keyword is
  used with the <code title="attr-hyperlink-hreflang">hreflang</code>
  attribute, and that attribute's value differs from the <span>root
  element</span>'s <span>language</span>, it indicates that the
  referenced document is a translation.</p>

  <p>If the <code title="rel-alternate">alternate</code> keyword is
  used with the <code title="attr-hyperlink-type">type</code>
  attribute, it indicates that the referenced document is a
  reformulation of the current document in the specified format.</p>

  <p>The <code title="attr-hyperlink-media">media</code>, <code
  title="attr-hyperlink-hreflang">hreflang</code>, and <code
  title="attr-hyperlink-type">type</code> attributes can be combined
  when specified with the <code title="rel-alternate">alternate</code>
  keyword.</p>

  <div class="example">

   <p>For example, the following link is a French translation that
   uses the PDF format:</p>

   <pre>&lt;link rel=alternate type=application/pdf hreflang=fr href=manual-fr></pre>

  </div>

  <p>If the <code title="rel-alternate">alternate</code> keyword is
  used with the <code title="attr-hyperlink-type">type</code>
  attribute set to the value <code title="">application/rss+xml</code>
  or the value <code title="">application/atom+xml</code>, then the
  user agent must treat the link as it would if it had the <code
  title="rel-feed">feed</code> keyword specified as well.</p>

  <p>The <code title="rel-alternate">alternate</code> link
  relationship is transitive &mdash; that is, if a document links to
  two other documents with the link type "<code
  title="rel-alternate">alternate</code>", then, in addition to
  implying that those documents are alternative representations of the
  first document, it is also implying that those two documents are
  alternative representations of each other.</p>


  <h5>Link type "<dfn title="rel-archives"><code>archives</code></dfn>"</h5>

  <p>The <code title="rel-archives">archives</code> keyword may be
  used with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-archives">archives</code> keyword indicates
  that the referenced document describes a collection of records,
  documents, or other materials of historical interest.</p>

  <p class="example">A blog's index page could link to an index of the
  blog's past posts with <code title="">rel="archives"</code>.</p>

  <p><strong>Synonyms</strong>: For historical reasons, user agents
  must also treat the keyword "<code title="">archive</code>" like the
  <code title="rel-archives">archives</code> keyword.</p>


  <h5>Link type "<dfn title="rel-author"><code>author</code></dfn>"</h5>

  <p>The <code title="rel-author">author</code> keyword may be
  used with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>For <code>a</code> and <code>area</code> elements, the <code
  title="rel-author">author</code> keyword indicates that the
  referenced document provides further information about the author of
  the section that the element defining the hyperlink <a
  href="#applyToSection">applies</a> to.</p>

  <p>For <code>link</code> elements, the <code
  title="rel-author">author</code> keyword indicates that the
  referenced document provides further information about the author
  for the page as a whole.</p>

  <p class="note">The "referenced document" can be, and often is, a
  <code title="">mailto:</code> URI giving the e-mail address of the
  author. <a href="#refsMAILTO">[MAILTO]</a></p>

  <p><strong>Synonyms</strong>: For historical reasons, user agents
  must also treat <code>link</code>, <code>a</code>, and
  <code>area</code> elements that have a <code title="">rev</code>
  attribute with the value "<code>made</code>" as having the <code
  title="rel-author">author</code> keyword specified as a link
  relationship.</p>


  <h5>Link type "<dfn title="rel-bookmark"><code>bookmark</code></dfn>"</h5>

  <p>The <code title="rel-bookmark">bookmark</code> keyword may be
  used with <code>a</code> and <code>area</code> elements.</p>

  <p>The <code title="rel-bookmark">bookmark</code> keyword gives a
  permalink for the nearest ancestor <code>article</code> element of
  the linking element in question, or of <a
  href="#associatedSection">the section the linking element is most
  closely associated with</a>, if there are no ancestor
  <code>article</code> elements.</p>

  <div class="example">
   <p>The following snippet has three permalinks. A user agent could
   determine which permalink applies to which part of the spec by
   looking at where the permalinks are given.</p>
   <pre> ...
 &lt;body>
  &lt;h1>Example of permalinks&lt;/h1>
  &lt;div id="a">
   &lt;h2>First example&lt;/h2>
   &lt;p>&lt;a href="a.html" rel="bookmark">This&lt;/a> permalink applies to
   only the content from the first H2 to the second H2. The DIV isn't
   exactly that section, but it roughly corresponds to it.&lt;/p>
  &lt;/div>
  &lt;h2>Second example&lt;/h2>
  &lt;article id="b">
   &lt;p>&lt;a href="b.html" rel="bookmark">This&lt;/a> permalink applies to
   the outer ARTICLE element (which could be, e.g., a blog post).&lt;/p>
   &lt;article id="c">
    &lt;p>&lt;a href="c.html" rel="bookmark">This&lt;/a> permalink applies to
    the inner ARTICLE element (which could be, e.g., a blog comment).&lt;/p>
   &lt;/article>
  &lt;/article>
 &lt;/body>
 ...</pre>
  </div>


  <h5>Link type "<dfn title="rel-contact"><code>contact</code></dfn>"</h5>

  <p>The <code title="rel-contact">contact</code> keyword may be used
  with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>For <code>a</code> and <code>area</code> elements, the <code
  title="rel-contact">contact</code> keyword indicates that the
  referenced document provides further contact information for the
  section that the element defining the hyperlink <a
  href="#applyToSection">applies</a> to.</p>

  <p>User agents must treat any hyperlink in an <code>address</code>
  element as having the <code title="rel-contact">contact</code> link
  type specified.</p>

  <p>For <code>link</code> elements, the <code
  title="rel-contact">contact</code> keyword indicates that the
  referenced document provides further contact information for the
  page as a whole.</p>


  <h5>Link type "<dfn title="rel-external"><code>external</code></dfn>"</h5>

  <p>The <code title="rel-external">external</code> keyword may be
  used with <code>a</code> and <code>area</code> elements.</p>

  <p>The <code title="rel-external">external</code> keyword indicates
  that the link is leading to a document that is not part of the site
  that the current document forms a part of.</p>


  <h5>Link type "<dfn title="rel-feed"><code>feed</code></dfn>"</h5>

  <p>The <code title="rel-feed">feed</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-feed">feed</code> keyword indicates that the
  referenced document is a syndication feed. If the <code
  title="rel-alternate">alternate</code> link type is also specified,
  then the feed is specifically the feed for the current document;
  otherwise, the feed is just a syndication feed, not necessarily
  associated with a particular Web page.</p>

  <p>The first <code>link</code>, <code>a</code>, or <code>area</code>
  element in the document (in tree order) that creates a hyperlink
  with the link type <code title="rel-feed">feed</code> must be
  treated as the default syndication feed for the purposes of feed
  autodiscovery.</p>

  <p class="note">The <code title="rel-feed">feed</code> keyword is
  implied by the <code title="rel-alternate">alternate</code> link
  type in certain cases (q.v.).</p>

  <div class="example">
   <p>The following two <code>link</code> elements are equivalent:
   both give the syndication feed for the current page:</p>
   <pre>&lt;link rel="alternate" type="application/atom+xml" href="data.xml"></pre>
   <pre>&lt;link rel="feed alternate" href="data.xml"></pre>
   <p>The following extract offers various different syndication
   feeds:</p>
   <pre> &lt;p>You can access the planets database using Atom feeds:&lt;/p>
 &lt;ul>
  &lt;li>&lt;a href="recently-visited-planets.xml" rel="feed">Recently Visited Planets&lt;/a>&lt;/li>
  &lt;li>&lt;a href="known-bad-planets.xml" rel="feed">Known Bad Planets&lt;/a>&lt;/li>
  &lt;li>&lt;a href="unexplored-planets.xml" rel="feed">Unexplored Planets&lt;/a>&lt;/li>
 &lt;/ul></pre>
  </div>


  <h5>Link type "<dfn title="rel-help"><code>help</code></dfn>"</h5>

  <p>The <code title="rel-help">help</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>For <code>a</code> and <code>area</code> elements, the <code
  title="rel-help">help</code> keyword indicates that the referenced
  document provides further help information for the parent of the
  element defining the hyperlink, and its children.</p>

  <div class="example">

   <p>In the following example, the form control has associated
   context-sensitive help. The user agent could use this information,
   for example, displaying the referenced document if the user presses
   the "Help" or "F1" key.</p>

   <pre> &lt;p>&lt;label> Topic: &lt;input name=topic> &lt;a href="help/topic.html" rel="help">(Help)&lt;/a>&lt;/label>&lt;/p></pre>

  </div>

  <p>For <code>link</code> elements, the <code
  title="rel-help">help</code> keyword indicates that the referenced
  document provides help for the page as a whole.</p>


  <h5>Link type "<dfn title="rel-icon"><code>icon</code></dfn>"</h5>

  <p>The <code title="rel-icon">icon</code> keyword may be used with
  <code>link</code> elements, for which it creates an <span
  title="external resource link">external resource link</span>.</p>

  <p>The specified resource is an icon representing the page or site,
  and should be used by the user agent when representing the page in
  the user interface.</p>

  <p>Icons could be auditory icons, visual icons, or other kinds of
  icons. If multiple icons are provided, the user agent must select
  the most appropriate icon according to the <code
  title="attr-link-media">media</code> attribute.</p>


  <h5>Link type "<dfn title="rel-license"><code>license</code></dfn>"</h5>

  <p>The <code title="rel-license">license</code> keyword may be used
  with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-license">license</code> keyword indicates
  that the referenced document provides the copyright license terms
  under which the current document is provided.</p>

  <p><strong>Synonyms</strong>: For historical reasons, user agents
  must also treat the keyword "<code title="">copyright</code>" like
  the <code title="rel-license">license</code> keyword.</p>


  <h5>Link type "<dfn title="rel-nofollow"><code>nofollow</code></dfn>"</h5>

  <p>The <code title="rel-nofollow">nofollow</code> keyword may be
  used with <code>a</code> and <code>area</code> elements.</p>

  <p>The <code title="rel-nofollow">nofollow</code> keyword indicates
  that the link is not endorsed by the original author or publisher of
  the page.</p>


  <h5>Link type "<dfn title="rel-pingback"><code>pingback</code></dfn>"</h5>

  <p>The <code title="rel-pingback">pingback</code> keyword may be
  used with <code>link</code> elements, for which it creates an <span
  title="external resource link">external resource link</span>.</p>

  <p>For the semantics of the <code
  title="rel-pingback">pingback</code> keyword, see the Pingback 1.0
  specification. <a href="#refsPINGBACK">[PINGBACK]</a></p>


  <h5>Link type "<dfn title="rel-prefetch"><code>prefetch</code></dfn>"</h5>

  <p>The <code title="rel-prefetch">prefetch</code> keyword may be
  used with <code>link</code> elements, for which it creates an <span
  title="external resource link">external resource link</span>.</p>

  <p>The <code title="rel-prefetch">prefetch</code> keyword indicates
  that preemptively fetching and caching the specified resource is
  likely to be beneficial, as it is highly likely that the user will
  require this resource.</p>


  <h5>Link type "<dfn title="rel-search"><code>search</code></dfn>"</h5>

  <p>The <code title="rel-search">search</code> keyword may be used
  with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-search">search</code> keyword indicates that
  the referenced document provides an interface specifically for
  searching the document and its related resources.</p>

  <p class="note">OpenSearch description documents can be used with
  <code>link</code> elements and the <code
  title="rel-search">search</code> link type to enable user agents to
  autodiscover search interfaces.</p>


  <h5>Link type "<dfn title="rel-stylesheet"><code>stylesheet</code></dfn>"</h5>

  <p>The <code title="rel-stylesheet">stylesheet</code> keyword may be
  used with <code>link</code> elements, for which it creates an <span
  title="external resource link">external resource link</span> that
  contributes to the <span>styling processing model</span>.</p>

  <p>The specified resource is a resource that describes how to
  present the document. Exactly how the resource is to be processed
  depends on the actual type of the resource.</p>

  <p>If the <code title="rel-alternate">alternate</code> keyword is
  also specified on the <code>link</code> element, then the link is an
  alternative stylesheet.</p>


  <h5>Link type "<dfn title="rel-sidebar"><code>sidebar</code></dfn>"</h5>

  <p>The <code title="rel-sidebar">sidebar</code> keyword may be used
  with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-sidebar">sidebar</code> keyword indicates
  that the referenced document, if retrieved, is intended to be shown
  in a secondary browsing context (if possible), instead of in the
  current browsing context.</p>


  <h5>Link type "<dfn title="rel-tag"><code>tag</code></dfn>"</h5>

  <p>The <code title="rel-tag">tag</code> keyword may be used
  with <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-tag">tag</code> keyword indicates that the
  <em>tag</em> that the referenced document represents applies to the
  current document.</p>


  <h5>Hierarchical link types</h5>

  <p>Some documents form part of a hierarchical structure of
  documents.</p>

  <p>A hierarchical structure of documents is one where each document
  can have various subdocuments. A subdocument is said to be a
  <em>child</em> of the document it is a subdocument of. The document
  of which it is a subdocument is said to be its <em>parent</em>. The
  children of a document have a relative order; the subdocument that
  precedes another is its <em>previous sibling</em>, and the one that
  follows it is its <em>next sibling</em>. A document with no parent
  forms the top of the hierarchy.</p>


  <h6>Link type "<dfn title="rel-first"><code>first</code></dfn>"</h6>

  <p>The <code title="rel-first">first</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-first">first</code> keyword indicates that
  the document is part of a hierarchical structure, and that the link
  is leading to the document that is the first child of the current
  document's parent document.</p>

  <p><strong>Synonyms</strong>: For historical reasons, user agents
  must also treat the keywords "<code title="">begin</code>" and
  "<code title="">start</code>" like the <code
  title="rel-first">first</code> keyword.</p>


  <h6>Link type "<dfn title="rel-index"><code>index</code></dfn>"</h6>

  <p>The <code title="rel-index">index</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-index">index</code> keyword indicates that
  the document is part of a hierarchical structure, and that the link
  is leading to the document that is the top of the hierarchy.</p>

  <p><strong>Synonyms</strong>: For historical reasons, user agents
  must also treat the keywords "<code title="">top</code>", "<code
  title="">contents</code>", and "<code title="">toc</code>" like the
  <code title="rel-index">index</code> keyword.</p>


  <h6>Link type "<dfn title="rel-last"><code>last</code></dfn>"</h6>

  <p>The <code title="rel-last">last</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-last">last</code> keyword indicates that
  the document is part of a hierarchical structure, and that the link
  is leading to the document that is the last child of the current
  document's parent document.</p>

  <p><strong>Synonyms</strong>: For historical reasons, user agents
  must also treat the keyword "<code title="">end</code>" like the
  <code title="rel-last">last</code> keyword.</p>


  <h6>Link type "<dfn title="rel-next"><code>next</code></dfn>"</h6>

  <p>The <code title="rel-next">next</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-next">next</code> keyword indicates that the
  document is part of a hierarchical structure, and that the link is
  leading to the document that is the next sibling of the current
  document.</p>


  <h6>Link type "<dfn title="rel-prev"><code>prev</code></dfn>"</h6>

  <p>The <code title="rel-prev">prev</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-prev">prev</code> keyword indicates that the
  document is part of a hierarchical structure, and that the link is
  leading to the document that is the previous sibling of the current
  document.</p>

  <p><strong>Synonyms</strong>: For historical reasons, user agents
  must also treat the keyword "<code title="">previous</code>" like
  the <code title="rel-prev">prev</code> keyword.</p>


  <h6>Link type "<dfn title="rel-up"><code>up</code></dfn>"</h6>

  <p>The <code title="rel-up">up</code> keyword may be used with
  <code>link</code>, <code>a</code>, and <code>area</code>
  elements. For <code>link</code> elements, it creates a <span
  title="hyperlink link">hyperlink</span>.</p>

  <p>The <code title="rel-up">up</code> keyword indicates that the
  document is part of a hierarchical structure, and that the link is
  leading to the document that is the parent of the current
  document.</p>

  <!-- idea: rel="up" vs rel="up up" vs rel="up up up top"
    this would allow you to do breadcrumbs:
     <nav>
      <p>
       <a href="/" rel="top up up up">Main</a> &gt;
       <a href="/products/" rel="up up">Products</a> &gt;
       <a href="/products/dishwashers" rel="up">Dishwashers</a> &gt;
       Second hand
      </p>
     </nav>
   -->


  <h5>Other link types</h5>

  <p>Other than the types defined above, only types defined as
  extensions in the <a
  href="http://wiki.whatwg.org/wiki/RelExtensions">WHATWG Wiki
  RelExtensions page</a> may be used with the <code
  title="">rel</code> attribute on <code>link</code>, <code>a</code>,
  and <code>area</code> elements. <a
  href="#refsWHATWGWIKI">[WHATWGWIKI]</a></p>

  <p>Anyone is free to edit the WHATWG Wiki RelExtensions page at any
  time to add a type. Extension types must be specified with the
  following information:</p>

  <dl>

   <dt>Keyword</dt>

   <dd><p>The actual value being defined. The value should not be
   confusingly similar to any other defined value (e.g. differing only
   in case).</p></dd>


   <dt>Effect on... <code>link</code></dt>

   <dd>

    <p>One of the following:</p>

    <dl>

     <dt>not allowed</dt>

     <dd>The keyword is not allowed to be specified on
     <code>link</code> elements.</dd>

     <dt>Hyperlink</dt>

     <dd>The keyword may be specified on a <code>link</code> element;
     it creates a <span title="hyperlink link">hyperlink
     link</span>.</dd>

     <dt>External Resource</dt>

     <dd>The keyword may be specified on a <code>link</code> element;
     it creates a <span title="external resource link">external
     resource link</span>.</dd>

    </dl>

   </dd>


   <dt>Effect on... <code>a</code> and <code>area</code></dt>

   <dd>

    <p>One of the following:</p>

    <dl>

     <dt>not allowed</dt>

     <dd>The keyword is not allowed to be specified on <code>a</code>
     and <code>area</code> elements.</dd>

     <dt>Hyperlink</dt>

     <dd>The keyword may be specified on <code>a</code> and
     <code>area</code> elements; it creates a <span
     title="hyperlink">hyperlink</span>.</dd>

    </dl>

   </dd>


   <dt>Brief description</dt>

   <dd><p>A short description of what the keyword's meaning is.</p></dd>


   <dt>Link to more details</dt>

   <dd><p>A link to a more detailed description of the keyword's
   semantics and requirements. It could be another page on the Wiki,
   or a link to an external page.</p></dd>


   <dt>Synonyms</dt>

   <dd><p>A list of other keyword values that have exactly the same
   processing requirements. Authors must not use the values defined to
   be synonyms, they are only intended to allow user agents to support
   legacy content.</p></dd>


   <dt>Status</dt>

   <dd>

    <p>One of the following:</p>

    <dl>

     <dt>Proposal</dt>

     <dd>The keyword has not received wide peer review and
     approval. It is included for completeness because pages use the
     keyword. Pages should not use the keyword.</dd>

     <dt>Accepted</dt>

     <dd>The keyword has received wide peer review and approval. It
     has a specification that unambiguously defines how to handle
     pages that use the keyword, including when they use them in
     incorrect ways. Pages may use the keyword.</dd>

     <dt>Rejected</dt>

     <dd>The keyword has received wide peer review and it has been
     found to have significant problems. Pages must not use the
     keyword. When a keyword has this status, the "Effect
     on... <code>link</code>" and "Effect on... <code>a</code> and
     <code>area</code>" information should be set to "not
     allowed".</dd>

    </dl>

    <p>If a keyword is added with the "proposal" status and found to
    be redundant with existing values, it should be removed and listed
    as a synonym for the existing value. If a keyword is added with
    the "proposal" status and found to be harmful, then it should be
    changed to "rejected" status, and its "Effect on..." information
    should be changed accordingly.</p>

   </dd>

  </dl>

  <p>Conformance checkers must use the information given on the WHATWG
  Wiki RelExtensions page to establish if a value not explicitly
  defined in this specification is allowed or not. When an author uses
  a new type not defined by either this specification or the Wiki
  page, conformance checkers should offer to add the value to the
  Wiki, with the details described above, with the "proposal"
  status.</p>

  <p>This specification does not define how new values will get
  approved. It is expected that the Wiki will have a community that
  addresses this.</p>



  <h3 id="styling"><dfn title="styling processing model">Styling</dfn></h3>

  <p>The <code>link</code> and <code>style</code> elements can provide
  styling information for the user agent to use when rendering the
  document. The DOM Styling specification specifies what styling
  information is to be used by the user agent and how it is to be
  used. <a href="#refsCSSOM">[CSSOM]</a></p>

  <p>The <code>style</code> and <code>link</code> elements implement
  the <code>LinkStyle</code> interface. <a
  href="#refsCSSOM">[CSSOM]</a></p>

  <p>For <code>style</code> elements, if the user agent does not
  support the specified styling language, then the <code
  title="dom-LinkStyle-sheet">sheet</code> attribute of the element's
  <code>LinkStyle</code> interface must return null. Similarly,
  <code>link</code> elements that do not represent <span
  title="rel-stylesheet">external resource links that contribute to
  the styling processing model</span> (i.e. that do not have a <code
  title="rel-stylesheet">stylesheet</code> keyword in their <code
  title="attr-link-rel">rel</code> attribute), and <code>link</code>
  elements whose specified resource has not yet been downloaded, or is
  not in a supported styling language, must have their
  <code>LinkStyle</code> interface's <code
  title="dom-LinkStyle-sheet">sheet</code> attribute return null.</p>

  <p>Otherwise, the <code>LinkStyle</code> interface's <code
  title="dom-LinkStyle-sheet">sheet</code> attribute must return a
  <code>StyleSheet</code> object with the attributes implemented as
  follows: <a href="#refsCSSOM">[CSSOM]</a></p>

  <dl>

   <dt>The content type (<code title="dom-stylesheet-type">type</code> DOM attribute)</dt>

   <dd><p>The content type must be the same as the style's specified
   type. For <code>style</code> elements, this is the same as the
   <code title="attr-style-type">type</code> content attribute's
   value, or <code title="">text/css</code> if that is omitted. For
   <code>link</code> elements, this is the <span
   title="Content-Type">Content-Type metadata of the specified
   resource</span>.</p></dd>

   <dt>The location (<code title="dom-stylesheet-href">href</code> DOM attribute)</dt>

   <dd><p>For <code>link</code> elements, the location must be the URI
   given by the element's <code title="attr-link-href">href</code>
   content attribute. For <code>style</code> elements, there is no
   location.</p></dd>

   <dt>The intended destination media for style information (<code title="dom-stylesheet-media">media</code> DOM attribute)</dt>

   <dd><p>The media must be the same as the value of the element's
   <code title="">media</code> content attribute.</p></dd>

   <dt>The style sheet title (<code title="dom-stylesheet-title">title</code> DOM attribute)</dt>

   <dd><p>The title must be the same as the value of the element's
   <code title="">title</code> content attribute. If the attribute is
   absent, then the style sheet does not have a title. The title is
   used for defining <dfn>alternative style sheet sets</dfn>.</p></dd>

  </dl>

  <p>The <dfn
  title="dom-LinkStyle-disabled"><code>disabled</code></dfn> DOM
  attribute on <code>link</code> and <code>style</code> elements must
  return false and do nothing on setting, if the <code
  title="dom-linkstyle-sheet">sheet</code> attribute of their
  <code>LinkStyle</code> interface is null. Otherwise, it must return
  the value of the <code>StyleSheet</code> interface's <code
  title="dom-stylesheet-disabled">disabled</code> attribute on
  getting, and forward the new value to that same attribute on
  setting.</p>

  <!-- <p class="big-issue">Need more here - defining preferred
  stylesheets, alternative stylesheets, persistent stylesheets, ordering
  of stylesheets, dynamic additions/removals, how it maps to
  .styleSheets, HTTP Link: headers, and the stuff about the alternative
  stylesheet API.</p> XXX that will all be covered by Anne's spec -->


  <h3 id="commands">Commands</h3>

  <p>A <dfn title="concept-command">command</dfn> is the abstraction
  behind menu items, buttons, and links. Once a command is defined,
  other parts of the interface can refer to the same command, allowing
  many access points to a single feature to share aspects such as the
  disabled state.</p>

  <p id="facets">Commands are defined to have the following
  <em>facets</em>:</p>

  <dl>

   <dt><dfn title="command-facet-Type">Type</dfn></dt>

   <dd>The kind of command: "command", meaning it is a normal command;
   "radio", meaning that triggering the command will, amongst other
   things, set the <span title="command-facet-CheckedState">Checked
   State</span> to true (and probably uncheck some other commands); or
   "checkbox", meaning that triggering the command will, amongst other
   things, toggle the value of the <span
   title="command-facet-CheckedState">Checked State</span>.</dd>

   <dt><dfn title="command-facet-ID">ID</dfn></dt>

   <dd>The name of the command, for referring to the command from the
   markup or from script. If a command has no ID, it is an
   <dfn>anonymous command</dfn>.</dd>

   <dt><dfn title="command-facet-Label">Label</dfn></dt>

   <dd>The name of the command as seen by the user.</dd>

   <dt><dfn title="command-facet-Hint">Hint</dfn></dt>

   <dd>A helpful or descriptive string that can be shown to the
   user.</dd>

   <dt><dfn title="command-facet-Icon">Icon</dfn></dt>

   <dd>A graphical image that represents the action.</dd>

   <dt><dfn title="command-facet-HiddenState">Hidden State</dfn></dt>

   <dd>Whether the command is hidden or not (basically, whether it
   should be shown in menus).</dd>

   <dt><dfn title="command-facet-DisabledState">Disabled State</dfn></dt>

   <dd>Whether the command can be triggered or not. If the <span
   title="command-facet-HiddenState">Hidden State</span> is true
   (hidden) then the <span
   title="command-facet-DisabledState">Disabled State</span> will be
   true (disabled) regardless. <span class="issue">We could make this
   into a string value that acts as a Hint for why the command is
   disabled.</span></dd>

   <dt><dfn title="command-facet-CheckedState">Checked State</dfn></dt>

   <dd>Whether the command is checked or not.</dd>

   <dt><dfn title="command-facet-Action">Action</dfn></dt>

   <dd>The actual effect that triggering the command will have. This
   could be a scripted event handler, a URI to which to navigate, or a
   form submission.</dd>

   <dt><dfn title="command-facet-Triggers">Triggers</dfn></dt>

   <dd>The list of elements that can trigger the command. The element
   defining a command is always in the list of elements that can
   trigger the command. For anonymous commands, only the element
   defining the command is on the list, since other elements have no
   way to refer to it.</dd>

  </dl>

  <p>Commands are represented by elements in the DOM. Any element that
  can define a command also implements the <code title="command-ro">Command</code>
  interface:</p>

  <pre class="idl">interface <dfn title="command-ro">Command</dfn> {<!--
 NOTE: to avoid clashing with the HTMLCommandElement interface's names,
       the members of this interface use cross-references with the title
       dom-command-ro-foo (note the "ro", which stands for "readonly").
-->
  readonly attribute DOMString <span title="dom-command-ro-commandType">commandType</span>;          
  readonly attribute DOMString <span title="dom-command-ro-id">id</span>;
  readonly attribute DOMString <span title="dom-command-ro-label">label</span>;
  readonly attribute DOMString <span title="dom-command-ro-title">title</span>;
  readonly attribute DOMString <span title="dom-command-ro-icon">icon</span>;
  readonly attribute boolean <span title="dom-command-ro-hidden">hidden</span>;
  readonly attribute boolean <span title="dom-command-ro-disabled">disabled</span>;              
  readonly attribute boolean <span title="dom-command-ro-checked">checked</span>;              
  void <span title="dom-command-ro-click">click</span>();
  readonly attribute <span>HTMLCollection</span> <span title="dom-command-ro-triggers">triggers</span>;
  readonly attribute <span>Command</span> <span title="dom-command-ro-command">command</span>;
};</pre>

  <p>The <code title="command-ro">Command</code> interface is implemented by any element
  capable of defining a command. (If an element can define a command,
  its definition will list this interface explicitly.) All the
  attributes of the <code title="command-ro">Command</code> interface are
  read-only. Elements implementing this interface may implement other
  interfaces that have attributes with identical names but that are
  mutable; in bindings that simply flatten all supported interfaces on
  the object, the mutable attributes must shadow the readonly
  attributes defined in the <code title="command-ro">Command</code> interface.</p>

  <p>The <dfn
  title="dom-command-ro-commandType"><code>commandType</code></dfn>
  attribute must return a string whose value is either "<code
  title="">command</code>", "<code title="">radio</code>", or "<code
  title="">checked</code>", depending on whether the <span
  title="command-facet-Type">Type</span> of the command defined by the
  element is "command", "radio", or "checked" respectively. If the
  element does not define a command, it must return null.</p>

  <p>The <dfn title="dom-command-ro-id"><code>id</code></dfn> attribute
  must return the command's <span title="command-facet-ID">ID</span>,
  or null if the element does not define a command or defines an
  <span>anonymous command</span>. This attribute will be shadowed by
  the <code title="dom-id">id</code> DOM attribute on the
  <code>HTMLElement</code> interface.</p>

  <p>The <dfn title="dom-command-ro-label"><code>label</code></dfn>
  attribute must return the command's <span
  title="command-facet-Label">Label</span>, or null if the element
  does not define a command or does not specify a <span
  title="command-facet-Label">Label</span>. This attribute will be
  shadowed by the <code title="">label</code> DOM attribute on
  <code>option</code> and <code>command</code> elements.</p>

  <p>The <dfn title="dom-command-ro-title"><code>title</code></dfn>
  attribute must return the command's <span
  title="command-facet-Hint">Hint</span>, or null if the element does
  not define a command or does not specify a <span
  title="command-facet-Hint">Hint</span>. This attribute will be
  shadowed by the <code title="dom-title">title</code> DOM attribute
  on the <code>HTMLElement</code> interface.</p>

  <p>The <dfn title="dom-command-ro-icon"><code>icon</code></dfn>
  attribute must return an absolute URI to the command's <span
  title="command-facet-Icon">Icon</span>. If the element does not
  specify an icon, or if the element does not define a command, then
  the attribute must return null. This attribute will be shadowed by
  the <code title="dom-command-icon">icon</code> DOM attribute on
  <code>command</code> elements.</p>

  <p>The <dfn title="dom-command-ro-hidden"><code>hidden</code></dfn>
  attribute must return true if the command's <span
  title="command-facet-HiddenState">Hidden State</span> is that the
  command is hidden, and false if it is that the command is not
  hidden. If the element does not define a command, the attribute must
  return false. This attribute will be shadowed by the <code
  title="dom-command-hidden">hidden</code> DOM attribute on
  <code>command</code> elements.</p>

  <p>The <dfn
  title="dom-command-ro-disabled"><code>disabled</code></dfn>
  attribute must return true if the command's <span
  title="command-facet-DisabledState">Disabled State</span> is that
  the command is disabled, and false if the command is not
  disabled. This attribute is not affected by the command's <span
  title="command-facet-HiddenState">Hidden State</span>. If the
  element does not define a command, the attribute must return
  false. This attribute will be shadowed by the <code
  title="">disabled</code> attribute on <code>button</code>,
  <code>input</code>, <code>option</code>, and <code>command</code>
  elements.</p>

  <p>The <dfn
  title="dom-command-ro-checked"><code>checked</code></dfn> attribute
  must return true if the command's <span
  title="command-facet-CheckedState">Checked State</span> is that the
  command is checked, and false if it is that the command is not
  checked. If the element does not define a command, the attribute
  must return false. This attribute will be shadowed by the <code
  title="">checked</code> attribute on <code>input</code> and
  <code>command</code> elements.</p>

  <p>The <dfn title="dom-command-ro-click"><code>click()</code></dfn>
  method must trigger the <span
  title="command-facet-Action">Action</span> for the command. If the
  element does not define a command, this method must do nothing. This
  method will be shadowed by the <code
  title="dom-click">click()</code> method on HTML elements, and is
  included only for completeness.</p>

  <p>The <dfn
  title="dom-command-ro-triggers"><code>triggers</code></dfn>
  attribute must return a list containing the elements that can
  trigger the command (the command's <span
  title="command-facet-Triggers">Triggers</span>). The list must be
  <span>live</span>. While the element does not define a command, the
  list must be empty.</p>

  <p>The <dfn
  title="dom-document-commands"><code>commands</code></dfn> attribute
  of the document's <code>HTMLDocument</code> interface must return an
  <code>HTMLCollection</code> rooted at the <code>Document</code>
  node, whose filter matches only elements that define commands and
  have IDs.</p>

  <p>The following elements can define commands: <code
  title="a-command">a</code>, <code
  title="button-command">button</code>, <code
  title="input-command">input</code>, <code
  title="option-command">option</code>, <code
  title="command-element">command</code>.</p>


  <h4><dfn title="a-command">Using the <code>a</code> element to define a command</dfn></h4>

  <p>An <code>a</code> element with an <code
  title="attr-hyperlink-href">href</code> attribute <span
  title="concept-command">defines a command</span>.</p>

  <p>The <span title="command-facet-Type">Type</span> of the command
  is "command".</p>

  <p>The <span title="command-facet-ID">ID</span> of the command is
  the value of the <code title="attr-id">id</code> attribute of the
  element, if the attribute is present and not empty. Otherwise the
  command is an <span>anonymous command</span>.</p>

  <p>The <span title="command-facet-Label">Label</span> of the command
  is the string given by the element's <code>textContent</code> DOM
  attribute.</p>

  <p>The <span title="command-facet-Hint">Hint</span> of the command
  is the value of the <code title="attr-title">title</code> attribute
  of the <code>a</code> element. If the attribute is not present, the
  <span title="command-facet-Hint">Hint</span> is the empty
  string.</p>

  <p>The <span title="command-facet-Icon">Icon</span> of the command
  is the absolute URI of the first image in the element. Specifically,
  in a depth-first search of the children of the element, the first
  element that is <!--either an--> <code>img</code> element with a
  <code>src</code> attribute<!--, or an <code>object</code> element
  with a <code>data</code> attribute, or, if the UA supports SVG, an
  <code>svg</code> element in the SVG namespace with a valid <code
  title="">id</code> attribute,--> is the one that is used as the
  image. <!--If it is an <code>img</code> element then--> The URI must
  be taken from the element's <code>src</code> attribute. <!--If it is
  an <code>object</code> element then the URI is taken from the
  <code>data</code> attribute. --> Relative URIs must be resolved
  relative to the base URI of the image element. <!-- If it is an
  <code>svg</code> element then the URI is formed by taking the URI of
  the document and appending a "#" (U+0023 NUMBER SIGN) and the ID of
  the element.--> If no image is found, then the Icon facet is left
  blank.</p>

  <p>The <span title="command-facet-HiddenState">Hidden State</span>
  and <span title="command-facet-DisabledState">Disabled State</span>
  facets of the command are always false. (The command is always
  enabled.)</p>

  <p>The <span title="command-facet-CheckedState">Checked State</span>
  of the command is always false. (The command is never checked.)</p>

  <p>The <span title="command-facet-Action">Action</span> of the
  command is to <span title="fire a click event">fire a <code
  title="">click</code> event</span> at the element.</p>


  <h4><dfn title="button-command">Using the <code>button</code> element to define a command</dfn></h4>

  <p>A <code>button</code> element always <span
  title="concept-command">defines a command</span>.</p>

  <p>The <span title="command-facet-Type">Type</span>, <span
  title="command-facet-ID">ID</span>, <span
  title="command-facet-Label">Label</span>, <span
  title="command-facet-Hint">Hint</span>, <span
  title="command-facet-Icon">Icon</span>, <span
  title="command-facet-HiddenState">Hidden State</span>, <span
  title="command-facet-CheckedState">Checked State</span>, and <span
  title="command-facet-Action">Action</span> facets of the command are
  determined <span title="a-command">as for <code>a</code>
  elements</span> (see the previous section).</p>

  <p>The <span title="command-facet-DisabledState">Disabled
  State</span> of the command mirrors the disabled state of the
  button. Typically this is given by the element's <code
  title="attr-button-disabled">disabled</code> attribute, but certain
  button types become disabled at other times too (for example, the
  <code>move-up</code> button type is disabled when it would have no
  effect).</p>


  <h4><dfn title="input-command">Using the <code>input</code> element to define a command</dfn></h4>

  <p>An <code>input</code> element whose <code
  title="attr-input-type">type</code> attribute is one of
  <code>submit</code>, <code>reset</code>, <code>button</code>,
  <code>radio</code>, <code>checkbox</code>, <code>move-up</code>,
  <code>move-down</code>, <code>add</code>, and <code>remove</code>
  <span title="concept-command">defines a command</span>.</p>

  <p>The <span title="command-facet-Type">Type</span> of the command
  is "radio" if the <code title="attr-input-type">type</code>
  attribute has the value <code>radio</code>, "checkbox" if the
  <code>type</code> attribute has the value <code>checkbox</code>, and
  "command" otherwise.</p>

  <p>The <span title="command-facet-ID">ID</span> of the command is
  the value of the <code title="attr-id">id</code> attribute of the
  element, if the attribute is present and not empty. Otherwise the
  command is an <span>anonymous command</span>.</p>

  <p>The <span title="command-facet-Label">Label</span> of the command
  depends on the Type of the command:</p>

  <p>If the <span title="command-facet-Type">Type</span> is "command",
  then it is the string given by the <code
  title="attr-input-value">value</code> attribute, if any, and a
  <span>UA-dependent value</span><!-- XXX xref--> that the UA uses to
  label the button itself if the attribute is absent.</p>

  <p>Otherwise, the <span title="command-facet-Type">Type</span> is
  "radio" or "checkbox". If the element has a <code>label</code>
  element associated with it, the <code>textContent</code> of the
  first such element is the <span
  title="command-facet-Label">Label</span> (in DOM terms, this the
  string given by
  <code><var title="">element</var>.labels[0].textContent</code>).  Otherwise,
  the value of the <code>value</code> attribute, if present, is the
  <span title="command-facet-Label">Label</span>. Otherwise, the <span
  title="command-facet-Label">Label</span> is the empty string.</p>

  <p>The <span title="command-facet-Hint">Hint</span> of the command
  is the value of the <code title="attr-title">title</code> attribute
  of the <code>input</code> element. If the attribute is not present, the
  <span title="command-facet-Hint">Hint</span> is the empty
  string.</p>

  <p>There is no <span title="command-facet-Icon">Icon</span> for the
  command.</p>

  <p>The <span title="command-facet-HiddenState">Hidden State</span>
  of the command is always false. (The command is never hidden.)</p>

  <p>The <span title="command-facet-DisabledState">Disabled
  State</span> of the command mirrors the disabled state of the
  control. Typically this is given by the element's <code
  title="attr-input-disabled">disabled</code> attribute, but certain
  input types become disabled at other times too (for example, the
  <code>move-up</code> input type is disabled when it would have no
  effect).</p>

  <p>The <span title="command-facet-CheckedState">Checked State</span>
  of the command is true if the command is of <span
  title="command-facet-Type">Type</span> "radio" or "checkbox" and the
  element has a <code title="attr-input-checked">checked</code>
  attribute, and false otherwise.</p>

  <p>The <span title="command-facet-Action">Action</span> of the
  command is to <span title="fire a click event">fire a <code
  title="">click</code> event</span> at the element.</p> <!-- XXX this
  is probably wrong for radio and checkbox types, depending on how we
  define <input>. -->


  <h4><dfn title="option-command">Using the <code>option</code> element to define a command</dfn></h4>

  <p>An <code>option</code> element with an ancestor
  <code>select</code> element and either no <code
  title="attr-option-value">value</code> attribute or a <code
  title="attr-option-value">value</code> attribute that is not the
  empty string <span title="concept-command">defines a
  command</span>.</p>

  <p>The <span title="command-facet-Type">Type</span> of the command
  is "radio" if the <code>option</code>'s nearest ancestor
  <code>select</code> element has no <code
  title="attr-select-multiple">multiple</code> attribute, and
  "checkbox" if it does.</p>

  <p>The <span title="command-facet-ID">ID</span> of the command is
  the value of the <code title="attr-id">id</code> attribute of the
  element, if the attribute is present and not empty. Otherwise the
  command is an <span>anonymous command</span>.</p>

  <p>The <span title="command-facet-Label">Label</span> of the command
  is the value of the <code>option</code> element's <code
  title="attr-option-label">label</code> attribute, if there is one,
  or the value of the <code>option</code> element's
  <code>textContent</code> DOM attribute if it doesn't.</p>

  <p>The <span title="command-facet-Hint">Hint</span> of the command
  is the string given by the element's <code
  title="attr-title">title</code> attribute, if any, and the empty
  string if the attribute is absent.</p>

  <p>There is no <span title="command-facet-Icon">Icon</span> for the
  command.</p>

  <p>The <span title="command-facet-HiddenState">Hidden State</span>
  of the command is always false. (The command is never hidden.)</p>

  <p>The <span title="command-facet-DisabledState">Disabled
  State</span> of the command is true (disabled) if the element has a
  <code title="attr-option-disabled">disabled</code> attribute, and
  false otherwise.</p>

  <p>The <span title="command-facet-CheckedState">Checked State</span>
  of the command is true (checked) if the element's <code
  title="dom-option-selected">selected</code> DOM attribute is true,
  and false otherwise.</p>

  <p>The <span title="command-facet-Action">Action</span> of the
  command depends on its <span
  title="command-facet-Type">Type</span>. If the command is of <span
  title="command-facet-Type">Type</span> "radio" then this must set
  the <code title="dom-option-selected">selected</code> DOM attribute
  of the <code>option</code> element to true, otherwise it must toggle
  the state of the <code title="dom-option-selected">selected</code>
  DOM attribute (set it to true if it is false and vice versa). Then
  <span title="fire a change event">a <code title="">change</code>
  event must be fired</span> on the <code>option</code> element's
  nearest ancestor <code>select</code> element (if there is one), as
  if the selection had been changed directly.</p>


  <h4>Using the <dfn
  title="command-element"><code>command</code></dfn> element to define
  a command</h4>

  <p>A <code>command</code> element <span
  title="concept-command">defines a command</span>.</p>

  <p>The <span title="command-facet-Type">Type</span> of the command
  is "radio" if the <code>command</code>'s <code
  title="attr-command-type">type</code> attribute is
  "<code>radio</code>", "checkbox" if the attribute's value is
  "<code>checkbox</code>", and "command" otherwise.</p>

  <p>The <span title="command-facet-ID">ID</span> of the command is
  the value of the <code title="attr-id">id</code> attribute of the
  element, if the attribute is present and not empty. Otherwise the
  command is an <span>anonymous command</span>.</p>

  <p>The <span title="command-facet-Label">Label</span> of the command
  is the value of the element's <code
  title="attr-command-label">label</code> attribute, if there is one,
  or the empty string if it doesn't.</p>

  <p>The <span title="command-facet-Hint">Hint</span> of the command
  is the string given by the element's <code
  title="attr-command-title">title</code> attribute, if any, and the
  empty string if the attribute is absent.</p>

  <p>The <span title="command-facet-Icon">Icon</span> for the command
  is the absolute URI resulting from resolving the value of the
  element's <code title="attr-command-icon">icon</code> attribute as a
  URI relative to the element's base URI. If the element has no <code
  title="attr-command-icon">icon</code> attribute then the command has
  no <span title="command-facet-Icon">Icon</span>.</p>

  <p>The <span title="command-facet-HiddenState">Hidden State</span>
  of the command is true (hidden) if the element has a <code
  title="attr-command-hidden">hidden</code> attribute, and false
  otherwise.</p>

  <p>The <span title="command-facet-DisabledState">Disabled
  State</span> of the command is true (disabled) if the element has
  either a <code title="attr-command-disabled">disabled</code>
  attribute or a <code title="attr-command-hidden">hidden</code>
  attribute (or both), and false otherwise.</p>

  <p>The <span title="command-facet-CheckedState">Checked State</span>
  of the command is true (checked) if the element has a <code
  title="attr-command-checked">checked</code> attribute, and false
  otherwise.</p>

  <p>The <span title="command-facet-Action">Action</span> of the
  command is to invoke the behaviour described in the definition of
  the <code title="dom-command-click">click()</code> method of the
  <code>HTMLCommandElement</code> interface.</p> <!-- XXX update to
  point to dom-click when we remove dom-command-click -->


  <h3 id="repetition-templates">Repetition templates</h3>

  <p class="big-issue">See <a href="http://whatwg.org/specs/web-forms/current-work/#repeatingFormControls">WF2</a> for now</p>





  <h2 id="apis">The browser environment</h2>

  <p>This section describes a set of APIs that allow authors to make
  their documents and applications interact with the user agent,
  integrating with native features such as the navigation history,
  drag-and-drop, undo/redo, and selections.</p>

  <h3>The <dfn>global scope</dfn></h3>

  <p>Many of the APIs are part of the <code>WindowHTML</code>
  interface. The <code>WindowHTML</code> interface must be obtainable
  from the <code>Window</code> object using binding-specific casting
  methods. <a href="#refsWINDOW">[WINDOW]</a></p>

  <pre class="idl">interface <dfn>WindowHTML</dfn> {

  // defined in this section
  readonly attribute <span>History</span> <span title="dom-history">history</span>;
  readonly attribute <span>ClientInformation</span> <span title="dom-navigator">navigator</span>; <!-- XXX IE6 also has window.clientInformation pointing to this same object -->
  readonly attribute <span>UndoManager</span> <span title="dom-undoManager">undoManager</span>;
  <span>Selection</span> <span title="dom-getSelection">getSelection</span>();
  readonly attribute <span>Storage</span> <span title="dom-sessionStorage">sessionStorage</span>;
  readonly attribute <span>StorageList</span> <span title="dom-globalStorage">globalStorage</span>;

  // defined in other sections
           attribute <span title="dom-Object">Object</span> <span>onerror</span>;

  // more...<!-- XXX constructors -->
};</pre>

 <!-- XXX XMLHttpRequest, Image, Audio, confirm, prompt, alert, ...
          http://msdn.microsoft.com/workshop/author/dhtml/reference/objects/obj_window.asp
          http://www.mozilla.org/docs/dom/domref/dom_window_ref.html
          http://lxr.mozilla.org/mozilla/source/dom/public/idl/base/nsIDOMWindow.idl
   -->

  <p>The <code>WindowHTML</code> object must provide the following
  constructors:</p>

  <dl>

   <dt><dfn title="dom-audio"><code>Audio()</code></dfn></dt>

   <dd><p>Constructs an <code>Audio</code> object.</p></dd>

   <dt><dfn title="dom-image"><code>Image()</code></dfn></dt>
   <dt><dfn title="dom-image-w"><code>Image(in unsigned long <var title="">w</var>)</code></dfn></dt>
   <dt><dfn title="dom-image-wh"><code>Image(in unsigned long <var title="">w</var>, in unsigned long <var title="">h</var>)</code></dfn></dt>

   <dd><p>Constructs an <code>HTMLImageElement</code> object (a new
   <code>img</code> element). If the <var title="">h</var> argument is
   present, the new object's <code
   title="attr-img-height">height</code> content attribute must be set
   to <var title="">h</var>. If the <var title="">w</var> argument is
   present, the new object's <code title="attr-img-width">width</code>
   content attribute must be set to <var title="">w</var>.</p></dd>

   <dt><dfn title="dom-option"><code>Option()</code></dfn></dt>
   <dt><dfn title="dom-option-n"><code>Option(in DOMString <var title="">name</var>)</code></dfn></dt>
   <dt><dfn title="dom-option-nv"><code>Option(in DOMString <var title="">name</var>, in DOMString <var title="">value</var>)</code></dfn></dt>

   <dd><p>Constructs an <code>HTMLOptionElement</code> object (a new
   <code>option</code> element). <span class="big-issue">need to
   define argument processing</span></p></dd>

  </dl>


  <h3 id="history">Session history and navigation</h3>

  <h4>The <dfn>session history</dfn> of browsing contexts</h4>

  <!-- XXX would be nice to have an intro paragraph that DFNed session
  history instead of having the header do it -->

  <p><code>History</code> objects provide a representation of the
  pages in the session history of their <code>Window</code> object's
  <span>browsing context</span>. Each browsing context
  (<code>frame</code>, <code>iframe</code>, etc) has a distinct
  session history.</p> <!-- conf crit for that last statement is in
  the bit that defines browsing context -->

  <p>Each <code>Document</code> object in a browsing context's session
  history is associated with a unique instance of the
  <code>History</code> object, although they all must model the same
  underlying session history.</p>

  <p>The <dfn title="dom-history"><code>history</code></dfn> attribute
  of the <code>WindowHTML</code> interface must return the object
  implementing the <code>History</code> interface for that
  <code>WindowHTML</code> object's associated <code>Document</code>
  object.</p>

  <p><code>History</code> objects represent their <span>browsing
  context</span>'s session history as a flat list of URIs and
  <span title="state object">state objects</span>. (This does not imply
  that the UI need be linear. See the <a href="#history-notes">notes
  below</a>.)

  <p>Typically, the history list will consist of only URIs. However, a
  page can <span title="dom-history-pushState">add</span> <dfn
  title="state object">state objects</dfn> between its entry in the
  session history and the next ("forward") entry. These are then <span
  title="event-popstate">returned to the script</span> when the user
  (or script) goes back in the history, thus enabling authors to use
  the "navigation" metaphor even in one-page applications.</p>

  <p>Entries that consist of <span title="state object">state
  objects</span> share the same <code>Document</code> as the entry for
  the URI itself. Contiguous entries that differ just by fragment
  identifier must also share the same <code>Document</code>.</p>

  <p class="note">All entries that share the same
  <code>Document</code> (and that are therefore merely different
  states of one particular document) are contiguous by definition.</p>

  <p>At any point, one of the entries in the session history is the
  <dfn>current entry</dfn>. This is the entry representing the page in
  this <span>browsing context</span> that is considered the "current"
  page by the UA. The <span>current entry</span> is usually an entry
  for the <span title="dom-location-href">location</span> of the
  <code>Document</code>. However, it can also be one of the entries
  for <span title="state object">state objects</span> added to the
  history by that document.</p>

  <p>When the browser's navigation model differs significantly from
  the sequential model represented by the <code>History</code>
  interface, for example if separate <code>Document</code> objects in
  the session history are all simulatenously displayed and active,
  then the <span>current entry</span> could even be an entry unrelated
  to the <code>History</code> object's own <code>Document</code>
  object. If, when a method is invoked on a <code>History</code>
  object, the <span>current entry</span> for that <span>browsing
  context</span>'s session history has a different
  <code>Document</code> object than the <code>History</code> object's
  own <code>Document</code> object, then the user agent must raise a
  <code>NO_MODIFICATION_ALLOWED_ERR</code> DOM exception.  (This can
  only happen if scripts are allowed to run in documents that are not
  the current document. Typically, however, user agents only allow
  scripts from the <span>current entry</span> to execute.)</p>

  <p>User agents may <dfn>discard</dfn> the DOMs of entries other than
  the <span>current entry</span>, reloading the pages afresh when the
  user or script navigates back to such pages. This specification does
  not specify when user agents should discard pages' DOMs and when
  they should cache them. See the section on the <code
  title="event-load">load</code> and <code
  title="event-unload">unload</code> events for more details.</p> <!--
  XXX crossref! -->

  <p>Entries that have had their DOM discarded must, for the purposes
  of the algorithms given below, act as if they had not. When the user
  or script navigates back or forwards to a page which has no
  in-memory DOM objects, any other entries that shared the same
  <code>Document</code> object with it must share the new object as
  well.</p>

  <p>When a user agent discards the DOM from an entry in the session
  history, it must also discard all the entries from the first state
  object entry for that <code>Document</code> object up to and
  including the last entry for that <code>Document</code> object
  (including any non-state-object entries in that range, such as
  entries where the user navigated using fragment identifiers). These
  entries are not recreated if the user or script navigates back to
  the page. If there are no state object entries for that
  <code>Document</code> object then no entries are removed.</p>

  <h4>The <code>History</code> interface</h4>

  <pre class="idl">interface <dfn>History</dfn> {
  readonly attribute long <span title="dom-history-length">length</span>;
<!--  DOMString <span title="dom-history-item">item</span>(in unsigned long index);
  readonly attribute DOMString <span title="dom-history-current">current</span>;
  readonly attribute DOMString <span title="dom-history-previous">previous</span>;
  readonly attribute DOMString <span title="dom-history-next">next</span>;
-->  void <span title="dom-history-go">go</span>(in long delta);
  void <span title="dom-history-go-0">go</span>();
  void <span title="dom-history-back">back</span>();
  void <span title="dom-history-forward">forward</span>();
  void <span title="dom-history-pushState">pushState</span>(in DOMObject data);
  void <span title="dom-history-clearState">clearState</span>();
};</pre>

  <p>The <dfn title="dom-history-length"><code>length</code></dfn>
  attribute of the <code>History</code> interface must return the
  number of entries in this session history.</p>

  <p>The actual entries are not accessible from script.</p>

<!--
  <p>The <dfn
  title="dom-history-item"><code>item(<var title="">index</var>)</code></dfn>
  function must raise a <span>security exception</span>.</p>

  <p>In the ECMAScript DOM binding, objects implementing this interface
  must support being dereferenced using square bracket notation (e.g.
  <code>history[1]</code>). Dereferencing with an integer index must
  be treated as equivalent to invoking the <code>item()</code> method
  with that index.</p>
-->

  <p>The <dfn
  title="dom-history-go"><code>go(<var title="">delta</var>)</code></dfn>
  method causes the UA to move the number of steps specified by
  <var title="">delta</var> in the session history.</p>

  <p>If the index of the <span>current entry</span> plus
  <var title="">delta</var> is less than zero or greater than or equal to the
  <span title="dom-history-length">number of items in the session
  history</span>, then the user agent must do nothing.</p>

  <p>If the <var title="">delta</var> is zero, then the user agent must act as
  if the <code title="dom-location-reload">location.reload()</code>
  method was called instead.</p>

  <p>Otherwise, the user agent must cause the current <span>browsing
  context</span> to <span>traverse the history</span> to the specified
  entry, as described below. The specified entry is the one whose
  index equals the index of the <span>current entry</span> plus <var
  title="">delta</var>.</p>

  <p>When a user agent is required to <dfn>traverse the history</dfn>
  to an entry <var title="">target</var>, the user agent must act as
  follows:</p>

  <ol>

   <li><p>If there are any entries with state objects between the
   <span>current entry</span> and the <var title="">target</var> entry
   (not inclusive), then the user agent must iterate through every
   entry between the current entry and the <var title="">target</var>
   entry, starting with the entry closest to the current entry, and
   ending with the one closest to the <var title="">target</var>
   entry. For each entry, if the entry is a state object, the user
   agent must <span>activate the state object</span>.</p></li>

   <li><p>If the specified entry has a different <code>Document</code>
   object than the <span>current entry</span> then the user agent must
   make that <code>Document</code> object the user's "current" one for
   that <span>browsing context</span>, and must update the browsing
   context's <code>Window</code> object so that any properties that
   were added while the current entry's <code>Document</code> was
   active are removed, and any properties that were added while the
   <var title="">target</var> entry's <code>Document</code> was active
   are added back. (If the <var title="">target</var> entry is new, as
   it is if the user agent should <span
   title="navigate">navigated</span> to it, then there are no such new
   properties.) The user agent must also update the current <span
   title="dom-location">location</span> object to the new
   location.</p></li>

   <li><p>If the specified entry is a state object, the user agent
   must <span title="activate the state object">activate that state
   object</span>.</p></li>

   <li><p>User agents may also update other aspects of the document
   view when the location changes in this way, for instance the scroll
   position, values of form fields, etc.</p></li>

  </ol>

  <p class="big-issue">how does the changing of the global attributes
  affect .watch() when seen from other Windows?</p>

  <p>When the user navigates through a <span>browsing context</span>,
  e.g. using a browser's back and forward buttons, the user agent must
  translate this action into the equivalent invocations of the <code
  title="dom-history-go">history.go(<var title="">delta</var>)</code>
  method on the various affected <code
  title="dom-window">window</code> objects.</p>

  <p>Some of the other members of the <code>History</code> interface
  are defined in terms of the <code
  title="dom-history-go">go()</code><!-- and <code
  title="dom-history-item">item()</code>--> method<!--s-->, as
  follows:</p>

  <table>
   <tr>
    <th>Member</th>
    <th>Definition</th>
   </tr>
<!--
   <tr>
    <td><dfn title="dom-history-current"><code>current</code></dfn></td>
    <td>Must return the same as <code title="dom-history-item">item(<var>current entry</var>)</code></td>
   </tr>
   <tr>
    <td><dfn title="dom-history-previous"><code>previous</code></dfn></td>
    <td>Must return the same as <code title="dom-history-item">item(<var>current entry</var>-1)</code></td>
   </tr>
   <tr>
    <td><dfn title="dom-history-next"><code>next</code></dfn></td>
    <td>Must return the same as <code title="dom-history-item">item(<var>current entry</var>+1)</code></td>
   </tr>
-->
   <tr>
    <td><dfn title="dom-history-go-0"><code>go()</code></dfn></td>
    <td>Must do the same as <code title="dom-history-go">go(0)</code></td>
   </tr>
   <tr>
    <td><dfn title="dom-history-back"><code>back()</code></dfn></td>
    <td>Must do the same as <code title="dom-history-go">go(-1)</code></td>
   </tr>
   <tr>
    <td><dfn title="dom-history-forward"><code>forward()</code></dfn></td>
    <td>Must do the same as <code title="dom-history-go">go(1)</code></td>
   </tr>
  </table>
 
  <p>The <dfn title="dom-history-pushState"><code>pushState(<var
  title="">data</var>)</code></dfn> method adds a state object to the
  history.</p>

  <p>When this method is invoked, the user agent must first remove
  from the session history any entries for that <code>Document</code>
  from the entry after the <span>current entry</span> up to the last
  entry in the session history that references the same
  <code>Document</code> object, if any. If the <span>current
  entry</span> is the last entry in the session history, or if there
  are no entries after the <span>current entry</span> that reference
  the same <code>Document</code> object, then no entries are
  removed.</p>

  <p>Then, the user agent must add a state object entry to the session
  history, after the <span>current entry</span>, with the specified
  <var title="">data</var> as the state object.</p>

  <p>Finally, the user agent must update the <span>current
  entry</span> to be the this newly added entry.</p>

  <p class="big-issue">There has been a suggestion that pushState()
  should take a URI and a string; the URI to allow for the page to be
  bookmarked, and the string to allow the UA to give the page a
  meaningful title in the history state, if it shows history
  state.</p> <!-- XXX could have four variants of pushState to allow
  with/without URI and with/without title. Or maybe URI only makes
  sense if there is a title. -->

  <p>User agents may limit the number of state objects added to the
  session history per page. If a page hits the UA-defined limit, user
  agents must remove the entry immediately after the first entry for
  that <code>Document</code> object in the session history after
  having added the new entry. (Thus the state history acts as a FIFO
  buffer for eviction, but as a LIFO buffer for navigation.)</p>

  <p>The <dfn
  title="dom-history-clearState"><code>clearState()</code></dfn>
  method removes all the state objects for the <code>Document</code>
  object from the session history.</p>

  <p>When this method is invoked, the user agent must remove from the
  session history all the entries from the first state object entry
  for that <code>Document</code> object up to the last entry that
  references that same <code>Document</code> object, if any.</p>

  <p>Then, if the <span>current entry</span> was removed in the
  previous step, the <span>current entry</span> must be set to the
  last entry for that <code>Document</code> object in the session
  history.</p>

  <h4><dfn title="activate the state object">Activating state objects</dfn></h4>

  <p>When a state object in the session history is activated (which
  happens in the cases described above), the user agent must fire a
  <dfn title="event-popstate"><code>popstate</code></dfn> event in no
  namespace on the <span>the body element</span> using the
  <code>PopStateEvent</code> interface, with the state object in the
  <code title="dom-PopStateEvent-state">state</code> attribute. This
  event bubbles but is not cancelable and has no default action.</p>

  <!-- XXX onpopstate should be defined somewhere -->

  <pre class="idl">interface <dfn>PopStateEvent</dfn> : Event {
  readonly attribute DOMObject <span title="dom-PopStateEvent-state">state</span>;
  void <span title="dom-PopStateEvent-initPopStateEvent">initPopStateEvent</span>(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMObject statetArg);
  void <span title="dom-PopStateEvent-initPopStateEventNS">initPopStateEventNS</span>(in DOMString namespaceURIArg, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMObject stateArg);
};</pre>

  <p>The <dfn
  title="dom-PopStateEvent-initPopStateEvent"><code>initPopStateEvent()</code></dfn>
  and <dfn
  title="dom-PopStateEvent-initPopStateEventNS"><code>initPopStateEventNS()</code></dfn>
  methods must initialise the event in a manner analogous to the
  similarly-named methods in the DOM3 Events interfaces. <a
  href="#refsDOM3Events">[DOM3EVENTS]</a></p>

  <p>The <dfn title="dom-PopStateEvent-state"><code>state</code></dfn>
  attribute represents the context information for the event.</p>

  <p class="big-issue">Should we coalesce these events if they occur
  while the page is away? (e.g. during traversal -- see above)</p>


  <h4>The <code>Location</code> interface</h4>

  <p>The <dfn title="dom-location"><code>location</code></dfn>
  attribute of the <code>WindowHTML</code> interface must return an
  object implementing the <code>Location</code> interface.</p>

  <p>For historical reasons, the <dfn
  title="dom-document-location"><code>location</code></dfn> attribute
  of the <code>HTMLDocument</code> interface must return the same
  object as the <code title="dom-location">location</code> attribute
  on its associated <code>WindowHTML</code> object.</p>

  <p><code>Location</code> objects provide a representation of the URI
  of their document, and allow the <span>current entry</span> of the
  <span>browsing context</span>'s session history to be changed, by
  adding or replacing entries in the <code
  title="dom-history">history</code> object.</p>

  <pre class="idl">interface <dfn>Location</dfn> {
  readonly attribute DOMString <span title="dom-location-hash">hash</span>;
  readonly attribute DOMString <span title="dom-location-host">host</span>;
  readonly attribute DOMString <span title="dom-location-hostname">hostname</span>;
  readonly attribute DOMString <span title="dom-location-href">href</span>;
  readonly attribute DOMString <span title="dom-location-pathname">pathname</span>;
  readonly attribute DOMString <span title="dom-location-port">port</span>;
  readonly attribute DOMString <span title="dom-location-protocol">protocol</span>;
  readonly attribute DOMString <span title="dom-location-search">search</span>; <!-- blame brendan for these "innovative" names -->
  void <span title="dom-location-assign">assign</span>(in DOMString url);
  void <span title="dom-location-replace">replace</span>(in DOMString url);
  void <span title="dom-location-reload">reload</span>();
};</pre>

  <p>In the ECMAScript DOM binding, objects implementing this
  interface must stringify to the same value as the <code
  title="dom-location-href">href</code> attribute.</p>

  <p id="settingLocation">In the ECMAScript DOM binding, the <code
  title="">location</code> members of the <code>HTMLDocument</code>
  and <code>WindowHTML</code> interfaces behave as if they had a
  setter: user agents must treats attempts to set these <code
  title="">location</code> attribute as attempts at setting the <code
  title="dom-location-href">href</code> attribute of the relevant
  <code>Location</code> object instead.</p>

  <p>The <dfn title="dom-location-href"><code>href</code></dfn>
  attribute returns the address of the page represented by the
  associated <code>Document</code> object, as an absolute IRI
  reference.</p>

  <p>On setting, <!--XXX Mozilla does this, but IE doesn't. What
  should we do?: the behaviour depends on the context in which the
  script that set the attribute is running. If the script ran as the
  direct result of the execution of a <code>script</code> element in
  the document represented by the <code>Location</code> object's
  associated <code>Document</code> object, then the user agent must
  act as if the <code title="dom-location-replace">replace()</code>
  method had been called with the new value as its
  argument. Otherwise,--> the user agent must act as if the <code
  title="dom-location-assign">assign()</code> method had been called
  with the new value as its argument.</p><!-- XXX may wish to allow
  replace instead as a UI improvement -->

  <p>When the <dfn title="dom-location-assign"><code>assign(<var
  title="">url</var>)</code></dfn> method is invoked, the UA must
  <span>navigate</span> to the specified <var title="">url</var>.</p>

  <p>When the <dfn title="dom-location-replace"><code>replace(<var
  title="">url</var>)</code></dfn> method is invoked, the UA must
  <span>navigate</span> to the specified <var
  title="">url</var>. However, the navigation being initiated by the
  <code title="dom-location-replace">replace()</code> method causes
  one of the steps in the navigation processing model to be slightly
  different.</p>

  <p>Relative <var title="">url</var> arguments for <code
  title="dom-location-assign">assign()</code> and <code
  title="dom-location-replace">replace()</code> must be resolved
  relative to the base URI of the script that made the method
  call.</p> <!-- XXX what about if the base URI is data: or
  javascript: or about: or something else without a way to resolve
  base URIs? -->

  <p class="big-issue">The component parts and .reload() are yet to be
  defined. If anyone can come up with a decent definition, let me
  know.</p>

<!--
  http://www.hixie.ch/tests/adhoc/dom/level0/location/components/
  http://lxr.mozilla.org/seamonkey/source/dom/src/base/nsLocation.cpp
  http://wp.netscape.com/eng/mozilla/3.0/handbook/javascript/ref_h-l.htm#84722
  <dfn title="dom-location-protocol"><code>protocol</code></dfn>
  <dfn title="dom-location-host"><code>host</code></dfn> ( host name and port )
  <dfn title="dom-location-port"><code>port</code></dfn> ( just port )
  <dfn title="dom-location-hostname"><code>hostname</code></dfn> ( just host name )
  <dfn title="dom-location-pathname"><code>pathname</code></dfn>
  <dfn title="dom-location-search"><code>search</code></dfn>
  <dfn title="dom-location-hash"><code>hash</code></dfn>
-->

<!--
  <dfn title="dom-location-reload"><code>reload()</code></dfn>
  reload during resize event:
  redisplay the current page (without reloading it). This
  theoretically would have no effect but in practice can be useful to
  work around rendering bugs.

reload on shared Document updates all of them

user reload must be equivalent to .reload()
-->


  <h4 id="history-notes">Implementation notes for session history</h4>

  <p><em>This section is non-normative.</em></p>

  <p>The <code>History</code> interface is not meant to place
  restrictions on how implementations represent the session history to
  the user.</p>

  <p>For example, session history could be implemented in a tree-like
  manner, with each page having multiple "forward" pages. This
  specification doesn't define how the linear list of pages in the
  <code title="dom-history">history</code> object are derived from the
  actual session history as seen from the user's perspective.</p>

  <p>Similarly, a page containing two <code>iframe</code>s has a <code
  title="dom-history">history</code> object distinct from the
  <code>iframe</code>s' <code title="dom-history">history</code>
  objects, despite the fact that typical Web browsers present the user
  with just one "Back" button, with a session history that interleaves
  the navigation of the two inner frames and the outer page.</p>

  <p><strong>Security:</strong> It is suggested that to avoid letting
  a page "hijack" the history navigation facilities of a UA by abusing
  <code title="dom-history-pushState">pushState()</code>, the UA
  provide the user with a way to jump back to the previous page
  (rather than just going back to the previous state). For example,
  the back button could have a drop down showing just the pages in the
  session history, and not showing any of the states. Similarly, an
  aural browser could have two "back" commands, one that goes back to
  the previous state, and one that jumps straight back to the previous
  page.</p>

  <p>In addition, a user agent could ignore calls to <code
  title="dom-history-pushState">pushState()</code> that are invoked on
  a timer, or from event handlers that do not represent a clear user
  action, or that are invoked in rapid succession.</p>



  <h3>Browser state</h3>

  <p>The <dfn title="dom-navigator"><code>navigator</code></dfn>
  attribute of the <code>WindowHTML</code> interface must return an
  instance of the <code>ClientInformation</code> interface, which
  represents the identity and state of the user agent (the client),
  and allows Web pages to register themselves as potential protocol
  and content handlers:</p>

  <pre class="idl">interface <dfn>ClientInformation</dfn> {
  readonly attribute boolean <span title="dom-navigator-onLine">onLine</span>;
  void <span title="dom-navigator-registerProtocolHandler">registerProtocolHandler</span>(in DOMString protocol, in DOMString uri, in DOMString title);
  void <span title="dom-navigator-registerContentHandler">registerContentHandler</span>(in DOMString mimeType, in DOMString uri, in DOMString title);
<!-- XXX there are other attributes! -->};</pre>
<!-- also, see window.external.AddSearchProvider() and similar DOM APIs from IE -->

  <h4 id="offline">Offline Web applications</h4>

  <p>The <dfn
  title="dom-navigator-onLine"><code>navigator.onLine</code></dfn>
  attribute must return false if the user agent will not contact the
  network when the user follows links or when a script requests a
  remote page (or knows that such an attempt would fail), and must
  return true otherwise.</p>

  <p>The <dfn title="event-offline"><code>offline</code></dfn> event
  must be fired when the value of the <code
  title="dom-navigator-onLine">navigator.onLine</code> attribute of
  the <code>WindowHTML</code> changes from true to false.</p>

  <p>The <dfn title="event-online"><code>online</code></dfn> event
  must be fired when the value of the <code
  title="dom-navigator-onLine">navigator.onLine</code> attribute of
  the <code>WindowHTML</code> changes from false to true.</p>

  <p>These events are in no namespace, do bubble, are not cancelable,
  have no default action, and use the normal <code>Event</code>
  interface. They must be fired on <span>the body element</span>. (As
  the events bubble, they will reach the <code>WindowHTML</code>
  object.)</p>

  <!-- XXX ononline onoffline need to be defined -->

  <h4 id="custom-handlers">Custom protocol and content handlers</h4>

  <p>The <dfn
  title="dom-navigator-registerProtocolHandler"><code>registerProtocolHandler()</code></dfn>
  method allows Web sites to register themselves as possible handlers
  for particular protocols. For example, an online fax service could
  register itself as a handler of the <code>fax:</code> protocol (<a
  href="#refsRFC2806">[RFC2806]</a>), so that if the user clicks on
  such a link, he is given the opportunity to use that Web
  site. Analogously, the <dfn
  title="dom-navigator-registerContentHandler"><code>registerContentHandler()</code></dfn>
  method allows Web sites to register themselves as possible handlers
  for content in a particular MIME type. For example, the same online
  fax service could register itself as a handler for
  <code>image/g3fax</code> files (<a
  href="#refsRFC1494">[RFC1494]</a>), so that if the user has no
  native application capable of handling G3 Facsimile byte streams,
  his Web browser can instead suggest he use that site to view the
  image.</p>

  <p>User agents may, within the constraints described in this
  section, do whatever they like when the methods are called. A UA
  could, for instance, prompt the user and offer the user the
  opportunity to add the site to a shortlist of handlers, or make the
  handlers his default, or cancel the request. UAs could provide such
  a UI through modal UI or through a non-modal transient notification
  interface. UAs could also simply silently collect the information,
  providing it only when relevant to the user.</p>

  <p>There is <a href="#sample-handler-impl">an example of how these
  methods could be presented to the user</a> below.</p>

  <p>The arguments to the methods have the following meanings:</p>

  <dl>

   <dt><var title="">protocol</var> (<code title="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code> only)</dt>

   <dd>

    <p>A scheme, such as <code>ftp</code> or <code>fax</code>. The
    scheme must be treated case-insensitively by user agents for the
    purposes of comparing with the scheme part of URIs that they
    consider against the list of registered handlers.</p>

    <p>The <var title="">protocol</var> value, if it contains a colon (as in
    "<code>ftp:</code>"), will never match anything, since schemes
    don't contain colons.</p>

   </dd>

   <dt><var title="">mimeType</var> (<code title="dom-navigator-registerContentHandler">registerContentHandler()</code> only)</dt>

   <dd>

    <p>A MIME type, such as <code>model/vrml</code> or
    <code>text/richtext</code>. The MIME type must be treated
    case-insensitively by user agents for the purposes of comparing
    with MIME types of documents that they consider against the list
    of registered handlers.</p>

    <p>User agents must compare the given values only to the MIME
    type/subtype parts of content types, not to the complete type
    including parameters. Thus, if <var title="">mimeType</var> values
    passed to this method include characters such as commas or
    whitespace, or include MIME parameters, then the handler being
    registered will never be used.</p>

   </dd>

   <dt><var title="">uri</var></dt>

   <dd>

    <p>The URI of the page that will handle the requests. When the
    user agent uses this URI, it must replace the first occurrence of
    the exact literal string "<code>%s</code>" with an escaped version
    of the URI of the content in question (as defined below), and then
    fetch the resulting URI using the GET method (or equivalent for
    non-HTTP URIs).</p>

    <p>To get the escaped version of the URI, first, the domain part
    of the URI (if any) must be converted to its punycode
    representation, and then, every character in the URI that is not
    in the ranges given in the next paragraph must be replaced by its
    UTF-8 byte representation, each byte being represented by a U+0025
    (%) character and two digits in the range U+0030 (0) to U+0039 (9)
    and U+0041 (A) to U+0046 (F) giving the hexadecimal representation
    of the byte.</p>

    <p>The ranges of characters that must not be escaped are: U+002D
    (-), U+002E (.), U+0030 (0) to U+0039 (9), U+0041 (A) to U+005A
    (Z), U+005F (_), U+0061 (a) to U+007A (z), and U+007E (~).</p>

    <!-- XXX move that to a common algorithms section if any other
    part of the spec needs it -->

    <div class="example">

     <p>If the user had visited a site that made the following call:</p>

     <pre>navigator.registerContentHandler('application/x-soup', 'http://example.com/soup?url=%s', 'SoupWeb&trade;')</pre>

     <p>...and then clicked on a link such as:</p>

     <pre>&lt;a href="http://www.example.net/chickenk&#xEF;wi.soup">Download our Chicken Kiwi soup!&lt;/a></pre>

     <p>...then, assuming this <code>chickenkiwi.soup</code> file was
     served with the MIME type <code>application/x-soup</code>, the UA
     might instead navigate to the following URI:</p>

     <pre>http://example.com/soup?url=http%3A%2F%2Fwww.example.net%2Fchickenk%C3%AFwi.soup</pre>

     <p>This site could then fetch the <code>chickenkiwi.soup</code>
     file and do whatever it is that it does with soup (synthesise it
     and ship it to the user, or whatever).</p>

    </div>

   </dd>

   <dt><var title="">title</var></dt>

   <dd>

    <p>A descriptive title of the handler, which the UA might use to
    remind the user what the site in question is.</p>

   </dd>

  </dl>

  <p>User agents should raise <span title="security
  exception">security exceptions</span> if the methods are called with
  <var title="">protocol</var> or <var title="">mimeType</var> values
  that the UA deems to be "privileged". For example, a site attempting
  to register a handler for <code>http</code> URIs or
  <code>text/html</code> content in a Web browser would likely cause
  an exception to be raised.</p>

  <p>User agents must raise a <code>SYNTAX_ERR</code> exception if the
  <var title="">uri</var> argument passed to one of these methods does
  not contain the exact literal string "<code>%s</code>".</p>

  <p>User agents must not raise any other exceptions (other than
  binding-specific exceptions, such as for an incorrect number of
  arguments in an ECMAScript implementation).</p>

  <p>This section does not define how the pages registered by these
  methods are used, beyond the requirements on how to process the
  <var title="">uri</var> value (see above). To some extent, the <span
  title="navigating across documents">processing model for navigating
  across documents</span> defines some cases where these methods are
  relevant, but in general UAs may use this information wherever they
  would otherwise consider handing content to native plugins or helper
  applications.</p>

  <p>UAs must not use registered content handlers to handle content
  that was returned as part of a non-GET transaction (or rather, as
  part of any non-idempotent transaction), as the remote site would
  not be able to fetch the same data.</p>


  <h5>Security and privacy</h5>

  <p>These mechanisms can introduce a number of concerns, in
  particular privacy concerns.</p>

  <p><strong>Hijacking all Web usage.</strong> User agents should not
  allow protocols that are key to its normal operation, such as
  <code>http</code> or <code>https</code>, to be rerouted through
  third-party sites. This would allow a user's activities to be
  trivially tracked, and would allow user information, even in secure
  connections, to be collected.</p>

  <p><strong>Hijacking defaults.</strong> It is strongly recommended
  that user agents do not automatically change any defaults, as this
  could lead the user to send data to remote hosts that the user is
  not expecting. New handlers registering themselves should never
  automatically cause those sites to be used.</p>

  <p><strong>Registration spamming.</strong> User agents should
  consider the possibility that a site will attempt to register a
  large number of handlers, possibly from multiple domains (e.g. by
  redirecting through a series of pages each on a different domain,
  and each registering a handler for <code>video/mpeg</code> &mdash;
  analogous practices abusing other Web browser features have been
  used by pornography Web sites for many years). User agents should
  gracefully handle such hostile attempts, protecting the user.</p>

  <p><strong>Misleading titles.</strong> User agents should not rely
  wholy on the <var title="">title</var> argument to the methods when
  presenting the registered handlers to the user, since sites could
  easily lie. For example, a site <code>hostile.example.net</code>
  could claim that it was registering the "Cuddly Bear Happy Content
  Handler". User agents should therefore use the handler's domain in
  any UI along with any title.</p>

  <p><strong>Hostile handler metadata.</strong> User agents should
  protect against typical attacks against strings embedded in their
  interface, for example ensuring that markup or escape characters in
  such strings are not executed, that null bytes are properly handled,
  that over-long strings do not cause crashes or buffer overruns, and
  so forth.</p>

  <p><strong>Leaking Intranet URIs.</strong> The mechanism described
  in this section can result in secret Intranet URIs being leaked, in
  the following manner:</p>

  <ol>

   <li>The user registers a third-party content handler as the default
   handler for a content type.</li>

   <li>The user then browses his corporate Intranet site and accesses
   a document that uses that content type.</li>

   <li>The user agent contacts the third party and hands the third
   party the URI to the Intranet content.</li>

  </ol>

  <p>No actual confidential file data is leaked in this manner, but
  the URIs themselves could contain confidential information. For
  example, the URI could be
  <code>https://www.corp.example.com/upcoming-aquisitions/samples.egf</code>,
  which might tell the third party that Example Corporation is
  intending to merge with Samples LLC. Implementors might wish to
  consider allowing administrators to disable this feature for certain
  subdomains, content types, or protocols.</p>

  <p><strong>Leaking secure URIs.</strong> User agents should not send
  HTTPS URIs to third-party sites registered as content handlers, in
  the same way that user agents do not send <code>Referer</code>
  headers from secure sites to third-party sites.</p>

  <p><strong>Leaking credentials.</strong> User agents must never send
  username or password information in the URIs that are escaped and
  included sent to the handler sites. User agents may even avoid
  attempting to pass to Web-based handlers the URIs of resources
  that are known to require authentication to access, as such sites
  would be unable to access the resources in question without
  prompting the user for credentials themselves (a practice that would
  require the user to know whether to trust the third-party handler, a
  decision many users are unable to make or even understand).</p>


  <h5 id="sample-handler-impl">Sample user interface</h5>

  <p><em>This section is non-normative.</em></p>

  <p>A simple implementation of this feature for a desktop Web browser
  might work as follows.</p>

  <p>The <code
  title="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code>
  method could display a modal dialog box:</p>

  <pre>||[ Protocol Handler Registration ]|||||||||||||||||||||||||||
|                                                            |
| This Web page:                                             |
|                                                            |
|    Kittens at work                                         |
|    http://kittens.example.org/                             |
|                                                            |
| ...would like permission to handle the protocol "x-meow:"  |
| using the following Web-based application:                 |
|                                                            |
|    Kittens-at-work displayer                               |
|    http://kittens.example.org/?show=%s                     |
|                                                            |
| Do you trust the administrators of the "kittens.example.   |
| org" domain?                                               |
|                                                            |
|              ( Trust kittens.example.org )  (( Cancel ))   |
|____________________________________________________________|</pre>

  <p>...where "Kittens at work" is the title of the page that invoked
  the method, "http://kittens.example.org/" is the URI of that page,
  "x-meow" is the string that was passed to the <code
  title="dom-navigator-registerProtocolHandler">registerProtocolHandler()</code>
  method as its first argument (<var title="">protocol</var>),
  "http://kittens.example.org/?show=%s" was the second argument (<var
  title="">uri</var>), and "Kittens-at-work displayer" was the third
  argument (<var title="">title</var>).</p>

  <p>If the user clicks the Cancel button, then nothing further
  happens. If the user clicks the "Trust" button, then the handler is
  remembered.</p>

  <p>When the user then attempts to fetch a URI that uses the
  "x-meow:" scheme, then it might display a dialog as follows:</p>

  <pre>||[ Unknown Protocol ]||||||||||||||||||||||||||||||||||||||||
|                                                            |
| You have attempted to access:                              |
|                                                            |
|    x-meow:S2l0dGVucyBhcmUgdGhlIGN1dGVzdCE%3D               |
|                                                            |
| How would you like FerretBrowser to handle this resource?  |
|                                                            |
|  (o) Contact the FerretBrowser plugin registry to see if   |
|      there is an official way to handle this resource.     |
|                                                            |
|  ( ) Pass this URI to a local application:                 |
|      [ /no application selected/             ] ( Choose )  |
|                                                            |
|  ( ) Pass this URI to the "Kittens-at-work displayer"      |
|      application at "kittens.example.org".                 |
|                                                            |
|  [ ] Always do this for resources using the "x-meow"       |
|      protocol in future.                                   |
|                                                            |
|                                     ( Ok )  (( Cancel ))   |
|____________________________________________________________|</pre>

  <p>...where the third option is the one that was primed by the site
  registering itself earlier.</p>

  <p>If the user does select that option, then the browser, in
  accordance with the requirements described in the previous two
  sections, will redirect the user to
  "http://kittens.example.org/?show=x-meow%3AS2l0dGVucyBhcmUgdGhlIGN1dGVzdCE%253D".</p>

  <p>The <code
  title="dom-navigator-registerContentHandler">registerContentHandler()</code>
  method would work equivalently, but for unknown MIME types instead
  of unknown protocols.</p>


  <h3 id="storage">Client-side session and persistent storage</h3> <!-- local storage -->

  <h4>Introduction</h4>

  <p><em>This section is non-normative.</em></p>

  <p>This specification introduces two related mechanisms, similar to
  HTTP session cookies <a href="#refsRFC2965">[RFC2965]</a>, for
  storing structured data on the client side.</p>

  <p>The first is designed for scenarios where the user is carrying
  out a single transaction, but could be carrying out multiple
  transactions in different windows at the same time.</p>

  <p>Cookies don't really handle this case well. For example, a user
  could be buying plane tickets in two different windows, using the
  same site. If the site used cookies to keep track of which ticket
  the user was buying, then as the user clicked from page to page in
  both windows, the ticket currently being purchased would "leak" from
  one window to the other, potentially causing the user to buy two
  tickets for the same flight without really noticing.</p>

  <p>To address this, this specification introduces the <code
  title="dom-sessionStorage">sessionStorage</code> DOM attribute.
  Sites can add data to the session storage, and it will be accessible
  to any page from that domain opened in that window.</p>

  <div class="example">

   <p>For example, a page could have a checkbox that the user ticks to
   indicate that he wants insurance:</p>

   <pre>&lt;label>
 &lt;input type="checkbox" onchange="sessionStorage.insurance = checked">
 I want insurance on this trip.
&lt;/label></pre>

   <p>A later page could then check, from script, whether the user had
   checked the checkbox or not:</p>

   <pre>if (sessionStorage.insurance) { ... }</pre>

   <p>If the user had multiple windows opened on the site, each one
   would have its own individual copy of the session storage object.</p>

  </div>

  <!--

   sessionStorage.flightDeparture = 'OSL';
   sessionStorage.flightArrival = 'NYC';

   for (var i in forms[0].elements)
      sessionStorage["data_" + i.name] = i.value;

   if (!sessionStorage[documents])
     sessionStorage[documents] = {};
   sessionStorage[documents][filename] = <document/>;

  -->

  <p>The second storage mechanism is designed for storage that spans
  multiple windows, and lasts beyond the current session. In
  particular, Web applications may wish to store megabytes of user
  data, such as entire user-authored documents or a user's mailbox, on
  the clientside for performance reasons.</p>

  <p>Again, cookies do not handle this case well, because they are
  transmitted with every request.</p>

  <p>The <code title="dom-globalStorage">globalStorage</code> DOM
  attribute is used to access the global storage areas.</p>

  <div class="example">

   <p>The site at example.com can display a count of how many times
   the user has loaded its page by putting the following at the bottom
   of its page:</p>

   <pre>&lt;p>
  You have viewed this page
  &lt;span id="count">an untold number of&lt;/span>
  time(s).
&lt;/p>
&lt;script>
  var storage = globalStorage['example.com'];
  if (!storage.pageLoadCount)
    storage.pageLoadCount = 0;
  storage.pageLoadCount = parseInt(storage.pageLoadCount, 10) + 1;
  document.getElementById('count').textContent = storage.pageLoadCount;
&lt;/script></pre>

  </div>

  <p>Each domain and each subdomain has its own separate storage area.
  Subdomains can access the storage areas of parent domains, and
  domains can access the storage areas of subdomains.</p>

  <ul class="brief">
   <li><code>globalStorage['']</code> is accessible to all domains.</li>
   <li><code>globalStorage['com']</code> is accessible to all .com domains</li>
   <li><code>globalStorage['example.com']</code> is accessible to example.com and any of its subdomains</li>
   <li><code>globalStorage['www.example.com']</code> is accessible to www.example.com and example.com, but not www2.example.com.</li>
  </ul>

  <p>Storage areas (both session storage and global storage) store
  strings. To store structured data in a storage area, you must first
  convert it to a string.</p>


  <h4>The <code>Storage</code> interface</h4>

  <pre class="idl">
interface <dfn>Storage</dfn> {
  readonly attribute unsigned long <span title="dom-Storage-length">length</span>;
  DOMString <span title="dom-Storage-key">key</span>(in unsigned long index);
  <span>StorageItem</span> <span title="dom-Storage-getItem">getItem</span>(in DOMString key);
  void <span title="dom-Storage-setItem">setItem</span>(in DOMString key, in DOMString data);
  void <span title="dom-Storage-removeItem">removeItem</span>(in DOMString key);
};</pre>

  <p>Each <code>Storage</code> object provides access to a list of
  key/value pairs, which are sometimes called items. Keys are strings,
  and any string (including the empty string) is a valid key. Values
  are strings with associated metadata, represented by
  <code>StorageItem</code> objects.</p>

  <p>Each <code>Storage</code> object is associated with a list of
  key/value pairs when it is created, as defined in the sections on
  the <code title="dom-sessionStorage">sessionStorage</code> and <code
  title="dom-globalStorage">globalStorage</code> attributes. Multiple
  separate objects implementing the <code>Storage</code> interface can
  all be associated with the same list of key/value pairs
  simultaneously.</p>

  <p>Key/value pairs have associated metadata. In particular, a
  key/value pair can be marked as either "safe only for secure
  content", or as "safe for both secure and insecure content".</p>

  <p>A key/value pair is <dfn title="accessible keys">accessible</dfn>
  if either it is marked as "safe for both secure and insecure
  content", or it is marked as "safe only for secure content" and the
  script in question is running in a <span title="secure scripting
  contexts">secure scripting context</span>.</p>

  <p>The <dfn title="dom-Storage-length"><code>length</code></dfn>
  attribute must return the number of key/value pairs currently
  present and <span title="accessible keys">accessible</span> in the
  list associated with the object.</p>

  <p>The <dfn title="dom-Storage-key"><code>key(<var
  title="">n</var>)</code></dfn> method must return the name of the
  <var title="">n</var>th <span>accessible</span> key in the list. The
  order of keys is user-agent defined, but must be consistent within
  an object between changes to the number of keys. (Thus, <span
  title="dom-Storage-setItem">adding</span> or <span
  title="dom-Storage-removeItem">removing</span> a key may change the
  order of the keys, but merely changing the value of an existing key
  must not.) <!--The order of keys may differ between instances of the
  <code>Storage</code> interface accessing the same list. [removed for
  now for clarity, but if people ask, put it back. this is part of the
  spec.]--> If <var title="">n</var> is less than zero or greater than
  or equal to the number of key/value pairs in the object, then this
  method must raise an <code>INDEX_SIZE_ERR</code> exception.</p>

  <p>The <dfn title="dom-Storage-getItem"><code>getItem(<var
  title="">key</var>)</code></dfn> method must return the
  <code>StorageItem</code> object representing the key/value pair with
  the given <var title="">key</var>. If the given <var
  title="">key</var> does not exist in the list associated with the
  object, or is not <span>accessible</span>, then this method must
  return null. Subsequent calls to this method with the same key from
  scripts running in the same <span>security context</span> must
  return the same instance of the <code>StorageItem</code>
  interface. (Such instances must not be shared across security
  contexts, though.)</p> <!-- XXX define security context -->

  <p>The <dfn title="dom-Storage-setItem"><code>setItem(<var
  title="">key</var>, <var title="">value</var>)</code></dfn> method
  must first check if a key/value pair with the given <var
  title="">key</var> already exists in the list associated with the
  object.</p>

  <p>If it does not, then a new key/value pair must be added to the
  list, with the given <var title="">key</var> and <var
  title="">value</var>, such that any current or future
  <code>StorageItem</code> objects referring to this key/value pair
  will return the value given in the <var title="">value</var>
  argument. If the script setting the value is running in a <span
  title="secure scripting contexts">secure scripting context</span>,
  then the key/value pair must be marked as "safe only for secure
  content", otherwise it must be marked as "safe for both secure and
  insecure content".</p>

  <p>If the given <var title="">key</var> <em>does</em> exist in the
  list, then, if the key/value pair with the given <var
  title="">key</var> is <span>accessible</span>, it must have its
  value updated so that any current or future <code>StorageItem</code>
  objects referring to this key/value pair will return the value given
  in the <var title="">value</var> argument. If it is <em>not</em>
  <span>accessible</span>, the method must raise a <span>security
  exception</span>.</p>

  <p>When the <code title="dom-Storage-setItem">setItem()</code>
  method is successfully invoked (i.e. when it doesn't raise an
  exception), events are fired on other <code>HTMLDocument</code>
  objects that can access the newly stored data, as defined in the
  sections on the <code
  title="dom-sessionStorage">sessionStorage</code> and <code
  title="dom-globalStorage">globalStorage</code> attributes.</p> <!--
  not normative, see the sections below for the normative statement
  -->

  <p>The <dfn title="dom-Storage-removeItem"><code>removeItem(<var
  title="">key</var>)</code></dfn> method must cause the key/value
  pair with the given <var title="">key</var> to be removed from the
  list associated with the object, if it exists and is
  <span>accessible</span>. If no item with that key exists, the method
  must do nothing. If an item with that key exists but is not
  <span>accessible</span>, the method must raise a <span>security
  exception</span>.</p>

  <p>The <code title="dom-Storage-setItem">setItem()</code> and <code
  title="dom-Storage-removeItem">removeItem()</code> methods must be
  atomic with respect to failure. That is, changes to the data storage
  area must either be successful, or the data storage area must not be
  changed at all.</p>

  <p>In the ECMAScript DOM binding, enumerating a <code>Storage</code>
  object must enumerate through the currently stored and
  <span>accessible</span> keys in the list the object is associated
  with. (It must not enumerate the values or the actual members of the
  interface). In the ECMAScript DOM binding, <code>Storage</code>
  objects must support dereferencing such that getting a property that
  is not a member of the object (i.e. is neither a member of the
  <code>Storage</code> interface nor of <code
  title="dom-Object">Object</code>) must invoke the <code
  title="dom-Storage-getItem">getItem()</code> method with the
  property's name as the argument, and setting such a property must
  invoke the <code title="dom-Storage-setItem">setItem()</code> method
  with the property's name as the first argument and the given value
  as the second argument.</p>


  <h4>The <code>StorageItem</code> interface</h4>

  <p>Items in <code>Storage</code> objects are represented by objects
  implementing the <code>StorageItem</code> interface.</p>

  <pre class="idl">
interface <dfn>StorageItem</dfn> {
           attribute boolean <span title="dom-StorageItem-secure">secure</span>;
           attribute DOMString <span title="dom-StorageItem-value">value</span>;
};</pre>

  <p>In the ECMAScript DOM binding, <code>StorageItem</code> objects must
  stringify to their <code title="dom-StorageItem-value">value</code>
  attribute's value.</p>

  <p>The <dfn title="dom-StorageItem-value"><code>value</code></dfn>
  attribute must return the current value of the key/value pair
  represented by the object. When the attribute is set, the user agent
  must invoke the <code title="dom-Storage-setItem">setItem()</code>
  method of the <code>Storage</code> object that the
  <code>StorageItem</code> object is associated with, with the key
  that the <code>StorageItem</code> object is associated with as the
  first argument, and the new given value of the attribute as the
  second argument.</p>

  <p><code>StorageItem</code> objects must be <em>live</em>, meaning
  that as the underlying <code>Storage</code> object has its key/value
  pairs updated, the <code>StorageItem</code> objects must always
  return the actual value of the key/value pair they represent.</p>

  <p>If the key/value pair has been deleted, the
  <code>StorageItem</code> object must act as if its value was the
  empty string. On setting, the key/value pair will be recreated.</p>

  <p>The <dfn title="dom-StorageItem-secure"><code>secure</code></dfn>
  attribute must raise an <code>INVALID_ACCESS_ERR</code> exception
  when accessed or set from a script whose script context is not <span
  title="secure scripting contexts">considered secure</span><!-- XXX
  xref -->. (Basically, if the page is not an SSL page.)</p>

  <p>If the scripting context <em>is</em> secure, then the <code
  title="dom-StorageItem-secure">secure</code> attribute must return
  true if the key/value pair is considered "safe only for secure
  content", and false if it is considered "safe for both secure and
  insecure content". If it is set to true, then the key/value pair
  must be flagged as "safe only for secure content". If it is set to
  false, then the key/value pair must be flagged as "safe for both
  secure and insecure content".</p>

  <p>If a <code>StorageItem</code> object is obtained by a script that
  is not running in a <span title="secure scripting contexts">secure
  scripting context</span>, and the item is then marked with the "safe
  only for secure content" flag by a script that <em>is</em> running
  in a secure context, the <code>StorageItem</code> object must
  continue to be available to the first script, who will be able to
  read the value of the object. However, any attempt to <em>set</em>
  the value would then start raising exceptions as described in the
  previous section, and the key/value pair would no longer appear in
  the appropriate <code>Storage</code> object.</p>


  <h4>The <code title="dom-sessionStorage">sessionStorage</code> attribute</h4>

  <p>The <dfn
  title="dom-sessionStorage"><code>sessionStorage</code></dfn>
  attribute represents the storage area specific to the current
  <span>top-level browsing context</span>.</p>

  <p>Each <span>top-level browsing context</span> has a unique set of
  session storage areas, one for each domain.</p>

  <p>User agents should not expire data from a browsing context's
  session storage areas, but may do so when the user requests that
  such data be deleted, or when the UA detects that it has limited
  storage space, or for security reasons. User agents should always
  avoid deleting data while a script that could access that data is
  running. When a top-level browsing context is destroyed (and
  therefore permanently inaccessible to the user) the data stored in
  its session storage areas can be discarded with it, as the API
  described in this specification provides no way for that data to
  ever be subsequently retrieved.</p>

  <p class="note">The lifetime of a browsing context can be unrelated
  to the lifetime of the actual user agent process itself, as the user
  agent may support resuming sessions after a restart.</p>

  <p>When a new <code>HTMLDocument</code> is created, the user agent
  must check to see if the document's <span>top-level browsing
  context</span> has allocated a session storage area for that
  <span>document's domain</span>. If it has not, a new storage area
  for that document's domain must be created.</p>

  <p>The <code>Storage</code> object for the document's associated
  <code>WindowHTML</code> object's <code
  title="dom-sessionStorage">sessionStorage</code> attribute must then
  be associated with the domain's session storage area.</p>

  <p>When a new <span>top-level browsing context</span> is created by
  cloning an existing <span>browsing context</span>, the new browsing
  context must start with the same session storage areas as the
  original, but the two sets must from that point on be considered
  separate, not affecting each other in any way.</p>

  <p>When a new <span>top-level browsing context</span> is created by
  a script in an existing <span>browsing context</span>, or by the
  user following a link in an existing browsing context, or in some
  other way related to a specific <code>HTMLDocument</code>, then,
  if the new context's first <code>HTMLDocument</code> has the same
  <span title="document's domain">domain</span> as the
  <code>HTMLDocument</code> from which the new context was created,
  the new browsing context must start with a single session storage
  area. That storage area must be a copy of that domain's session
  storage area in the original browsing context, which from that point
  on must be considered separate, with the two storage areas not
  affecting each other in any way.</p>

  <!-- XXX define the case for window.open() -->

  <p id="sessionStorageEvent">When the <code
  title="dom-Storage-setItem">setItem()</code> method is called on a
  <code>Storage</code> object <var title="">x</var> that is associated
  with a session storage area, then, if the method does not raise a
  <span>security exception</span>, in every <code>HTMLDocument</code>
  object whose <code>WindowHTML</code> object's <code
  title="dom-sessionStorage">sessionStorage</code> attribute's
  <code>Storage</code> object is associated with the same storage
  area, other than <var title="">x</var>, a <code
  title="event-storage">storage</code> event must be fired, as <span
  title="event-storage">described below</span>.</p>


  <h4>The <code title="dom-globalStorage">globalStorage</code> attribute</h4>

  <pre class="idl">interface <dfn>StorageList</dfn> {
  <span>Storage</span> <span title="dom-Storagelist-namedItem">namedItem</span>(in DOMString domain);
};</pre>

  <p>The <dfn
  title="dom-globalStorage"><code>globalStorage</code></dfn>
  object provides a <code>Storage</code> object for each domain.</p>

  <p>In the ECMAScript DOM binding, <code>StorageList</code> objects
  must support dereferencing such that getting a property that is not
  a member of the object (i.e. is neither a member of the
  <code>StorageList</code> interface nor of <code
  title="dom-Object">Object</code>) must invoke the <code
  title="dom-Storagelist-namedItem">namedItem()</code> method with the
  property's name as the argument.</p>

  <p>User agents must have a set of global storage areas, one for each
  domain.</p>

  <p>User agents should only expire data from the global storage areas
  for security reasons or when requested to do so by the user. User
  agents should always avoid deleting data while a script that could
  access that data is running. Data stored in global storage areas
  should be considered potentially user-critical. It is expected that
  Web applications will use the global storage areas for storing
  user-written documents.</p>

  <p>The <dfn title="dom-Storagelist-namedItem"><code>namedItem(<var
  title="">domain</var>)</code></dfn> method tries to returns a
  <code>Storage</code> object associated with the given domain,
  according to the rules that follow.</p>

  <div id="splitDomain">

   <p>The <var title="">domain</var> must first be split into an array
   of strings, by splitting the string at "." characters (U+002E FULL
   STOP). If the <var title="">domain</var> argument is the empty
   string, then the array is empty as well. If the <var
   title="">domain</var> argument is not empty but has no dots, then
   the array has one item, which is equal to the <var
   title="">domain</var> argument. If the <var title="">domain</var>
   argument contains consecutive dots, there will be empty strings in
   the array (e.g. the string "hello..world" becomes split into the
   three strings "hello", "", and "world", with the middle one being
   the empty string).</p>

   <p>Each component of the array must then have the IDNA ToASCII
   algorithm applied to it, with both the AllowUnassigned and
   UseSTD3ASCIIRules flags set. <a href="#refsRFC3490">[RFC3490]</a>
   If ToASCII fails to convert one of the components of the string,
   e.g. because it is too long or because it contains invalid
   characters, then the user agent must raise a
   <code>SYNTAX_ERR</code> exception. <a
   href="#refsDOM3CORE">[DOM3CORE]</a> The components after this step
   consist of only US-ASCII characters.</p>

   <p>The components of the array must then be converted to lowercase.
   Since only US-ASCII is involved at this step, this only requires
   converting characters in the range A-Z to the corresponding
   characters in the range a-z.</p>

  </div>

  <p>The resulting array is used in a comparison with another array,
  as described below. In addition, its components are concatenated
  together, each part separated by a dot (U+002E), to form the
  <dfn>normalised requested domain</dfn>.</p>

  <p class="example">If the original <var title="">domain</var> was
  "&Aring;sg&aring;rd.Example.Com", then the resulting array would
  have the three items "xn--sgrd-poac", "example", and "com", and the
  normalised requested domain would be
  "xn--sgrd-poac.example.com".</p>

  <p>Next, the <span title="script's domain">script's own
  domain</span> is processed to find if it is allowed to access the
  requested domain.</p>

  <p>If the script's domain name in not known, e.g. if only the
  server's IP address is known, and the <span>normalised requested
  domain</span> is not the empty string, then the user agent must
  raise a <span>security exception</span>.</p>

  <p class="note">If the <span>normalised requested domain</span> is
  the empty string, then the rest of this algorithm can be skipped.
  This is because in that situation, the comparison of the two arrays
  below will always find them to be the same &mdash; the first array
  in such a situation is also empty and so permission to access that
  storage area will always be given.</p>

  <p>If the script's domain contains no dots (U+002E) then the string
  "<code>.localdomain</code>" must be appended to the script's
  domain.</p>

  <p>Then, the script's domain must be turned into an array, being
  split, converted to ASCII, and lowercased as described for the <var
  title="">domain</var> argument <a href="#splitDomain">above</a>.</p>

  <p>Of the two arrays, the longest one must then be shortened to the
  length of the shorter one, by dropping items from the start of the
  array.</p>

  <div class="example">

   <p>If the <var title="">domain</var> argument is "www.example.com"
   and the script's domain is "example.com" then the first array will be
   a three item array ("www", "example", "com"), and the second will
   be a two item array ("example", "com"). The first array is
   therefore shortened, dropping the leading parts, making both into
   the same array ("example", "com").</p>

  </div>

  <p>If the two arrays are not component-for-component identical in
  literal string comparisons, then the user agent must then raise a
  <span>security exception</span>.</p>

  <p>Otherwise, the user agent must check to see if it has allocated
  global storage area for the <span>normalised requested
  domain</span>. If it has not, a new storage area for that domain
  must be created.</p>

  <p>The user agent must then create a <code>Storage</code> object
  associated with that domain's global storage area, and return
  it.</p>

  <p>When the requested <var title="">domain</var> is a top level
  domain, or the empty string, or a country-specific sub-domain like
  "co.uk" or "ca.us", the associated global storage area is known as
  <dfn>public storage area</dfn></p>

  <div id="globalStorageEvent">

   <p>The <code title="dom-Storage-setItem">setItem()</code> method
   might be called on a <code>Storage</code> object that is associated
   with a global storage area for a domain <var title="">d</var>,
   created by a <code>StorageList</code> object associated with a
   <code>WindowHTML</code> object <var title="">x</var>. Whenever this
   occurs, if the method didn't raise an exception, a <code
   title="event-storage">storage</code> event must be fired, as
   described below, in every <code>HTMLDocument</code> object that
   matches the following conditions:</p>

   <ul>

    <li>Its <code>WindowHTML</code> object is not <var
    title="">x</var>, and</li>

    <li>Its <code>WindowHTML</code> object's <code
    title="dom-sessionStorage">globalStorage</code> attribute's
    <code>StorageList</code> object's <code
    title="dom-Storagelist-namedItem">namedItem()</code> method would
    not raise a <span>security exception</span> according to the rules
    above if it was invoked with the domain <var
    title="">d</var>.</li>

   </ul>

   <p>In other words, every other document that has access to that
   domain's global storage area is notified of the change.</p>

  </div>


  <h4>The <code title="event-storage">storage</code> event</h4>

  <p>The <dfn title="event-storage"><code>storage</code></dfn> event
  is fired in an <code>HTMLDocument</code> when a storage area
  changes, as described in the previous two sections (<a
  href="#sessionStorageEvent">for session storage</a>, <a
  href="#globalStorageEvent">for global storage</a>).</p>

  <p>When this happens, a <code>storage</code> event in no namespace,
  which bubbles, is not cancelable, has no default action, and which
  uses the <code>StorageEvent</code> interface described below, must
  be fired on <span>the body element</span>.</p>

  <p>However, it is possible (indeed, for session storage areas,
  likely) that the target <code>HTMLDocument</code> object is not
  active at that time. For example, it might not be the <span>current
  entry</span> in the session history; user agents typically stop
  scripts from running in pages that are in the history. In such
  cases, the user agent must instead delay the firing of the event
  until such time as the <code>HTMLDocument</code> object in
  question becomes active again.</p>

  <p>When there are multiple delayed <code>storage</code> events for
  the same <code>HTMLDocument</code> object, user agents should
  coalesce events with the same <code
  title="dom-Storageevent-domain">domain</code> value (dropping
  duplicates).</p>

  <p>If the DOM of a page that has delayed <code>storage</code> events
  queued up is <span title="discard">discarded</span>, then the
  delayed events are dropped as well.</p>

  <pre class="idl">interface <dfn>StorageEvent</dfn> : Event {
  readonly attribute DOMString <span title="dom-StorageEvent-domain">domain</span>;
  void <span title="dom-StorageEvent-initStorageEvent">initStorageEvent</span>(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString domainArg);
  void <span title="dom-StorageEvent-initStorageEventNS">initStorageEventNS</span>(in DOMString namespaceURIArg, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString domainArg);
};</pre>

  <p>The <dfn
  title="dom-StorageEvent-initStorageEvent"><code>initStorageEvent()</code></dfn>
  and <dfn
  title="dom-StorageEvent-initStorageEventNS"><code>initStorageEventNS()</code></dfn>
  methods must initialise the event in a manner analogous to the
  similarly-named methods in the DOM3 Events interfaces. <a
  href="#DOM3Events">[DOM3EVENTS]</a></p>

  <p>The <dfn
  title="dom-StorageEvent-domain"><code>domain</code></dfn> attribute
  of the <code>StorageEvent</code> event object must be set to the
  name of the domain associated with the storage area that changed if
  that storage area is a global storage area, or the string
  "<code>#session</code>" if it was a session storage area.</p>

  <!-- XXX onstorage should be defined -->


  <h4>Miscellaneous implementation requirements for storage areas</h4>

  <h5>Disk space</h5>

  <p>User agents should limit the total amount of space allowed for a
  domain based on the domain of the page setting the value.</p>

  <p>User agents should not limit the total amount of space allowed on
  a per-storage-area basis, otherwise a site could just store data in
  any number of subdomains, e.g. storing up to the limit in
  a1.example.com, a2.example.com, a3.example.com, etc, circumventing
  per-domain limits.</p>

  <p>User agents should consider additional quota mechanisms (for
  example limiting the amount of space provided to a domain's
  subdomains as a group) so that hostile authors can't run scripts
  from multiple subdomains all adding data to the global storage area
  in an attempted denial-of-service attack.</p>

  <p>User agents may prompt the user when per-domain space quotas are
  reached, allowing the user to grant a site more space. This enables
  sites to store many user-created documents on the user's computer,
  for instance.</p>

  <p>User agents should allow users to see how much space each domain
  is using.</p>

  <p>If the storage area space limit is reached during a <code
  title="dom-Storage-setItem">setItem()</code> call, the user agent
  should raise an exception.</p> <!-- XXX which one? -->

  <p>A mostly arbitrary limit of five megabytes per domain is
  recommended. Implementation feedback is welcome and will be used to
  update this suggestion in future.</p>


  <h5>Threads</h5>

  <p>Multiple browsing contexts must be able to access the global
  storage areas simultaneously in a predictable manner. Scripts must
  not be able to detect any concurrent script execution.</p>

  <p>This is required to guarentee that the <code
  title="dom-Storage-length">length</code> attribute of a
  <code>Storage</code> object never changes while a script is
  executing, other than in a way that is predictable by the script
  itself.</p>

  <p>There are various ways of implementing this requirement. One is
  that if a script running in one browsing context accesses a global
  storage area, the UA blocks scripts in other browsing contexts when
  they try to access <em>any</em> global storage area until the first
  script has executed to completion. (Similarly, when a script in one
  browsing context accesses its session storage area, any scripts that
  have the same top level browsing context and the same domain would
  block when accessing their session storage area until the first
  script has executed to completion.) Another (potentially more
  efficient but probably more complex) implementation strategy is to
  use optimistic transactional script execution. This specification
  does not require any particular implementation strategy, so long as
  the requirement above is met.</p>


  <h4>Security and privacy</h4>

  <h5>User tracking</h5>

  <p>A third-party advertiser (or any entity capable of getting
  content distributed to multiple sites) could use a unique identifier
  stored in its domain's global storage area to track a user across
  multiple sessions, building a profile of the user's interests to
  allow for highly targeted advertising. In conjunction with a site
  that is aware of the user's real identity (for example an e-commerce
  site that requires authenticated credentials), this could allow
  oppressive groups to target individuals with greater accuracy than
  in a world with purely anonymous Web usage.</p>

  <p>The <code title="dom-globalStorage">globalStorage</code> object
  also introduces a way for sites to cooperate to track users over
  multiple domains, by storing identifying data in "<span
  title="public storage area">public</span>" top-level domain storage
  area, accessible by any domain.</p>

  <p>There are a number of techniques that can be used to mitigate the
  risk of user tracking:</p>

  <ul>

   <li>

    <p>Blocking third-party storage: user agents may restrict access
    to the <code title="dom-globalStorage">globalStorage</code> object
    to scripts originating at the domain of the top-level document of
    the <span>browsing context</span>.</p>

    <p>This blocks a third-party site from using its private storage
    area for tracking a user, but top-level sites could still
    cooperate with third parties to perferm user tracking by using the
    "<span title="public storage area">public</span>" storage area.</p>

   </li>
 
   <li>

    <p>Expiring stored data: user agents may automatically delete
    stored data after a period of time.</p>

    <p>For example, a user agent could treat the global storage area
    as session-only storage, deleting the data once the user had
    closed all the <span>browsing contexts</span> that could access
    it.</p>

    <p>This can restrict the ability of a site to track a user, as the
    site would then only be able to track the user across multiple
    sessions when he authenticates with the site itself (e.g. by
    making a purchase or logging in to a service).</p>

    <!-- XXX should there be an explicit way for sites to state when
    data should expire? as in
    globalStorage['example.com'].expireData(365); ? -->

   </li>

   <li>

    <p>Blocking access to the top-level domain ("<span title="public storage area">public</span>") storage
    areas: user agents may prevent domains from storing data in and
    reading data from the top-level domain entries in the <code
    title="dom-globalStorage">globalStorage</code> object.</p>

    <p>In practice this requires a detailed list of all the "public"
    second-level (and third-level) domains. For example, content at
    the domain <code>www.example.com</code> would be allowed to access
    <code>example.com</code> data but not <code>com</code> data;
    content at the domain <code>example.co.uk</code> would be allowed
    access to <code>example.co.uk</code> but not <code>co.uk</code> or
    <code>uk</code>; and content at
    <code>example.chiyoda.tokyo.jp</code> would be allowed access to
    <code>example.chiyoda.tokyo.jp</code> but not
    <code>chiyoda.tokyo.jp</code>, <code>tokyo.jp</code>, or
    <code>jp</code>, while content at
    <code>example.metro.tokyo.jp</code> would be allowed access to
    both <code>example.metro.tokyo.jp</code> and
    <code>metro.tokyo.jp</code> but not <code>tokyo.jp</code> or
    <code>jp</code>. The problem is even more convoluted when one
    considers private domains with third-party subdomains such as
    <code>dyndns.org</code> or <code>uk.com</code>.</p>

    <p>Blocking access to the "<span title="public storage area">public</span>" storage areas can also prevent
    innocent sites from cooperating to provide services beneficial to
    the user.</p>

   </li>

   <li>

    <p>Treating persistent storage as cookies: user agents may present
    the persistent storage feature to the user in a way that does not
    distinguish it from HTTP session cookies. <a
    href="#refsRFC2965">[RFC2965]</a></p>

    <p>This might encourage users to view persistent storage with
    healthy suspicion.</p>

   </li>

   <li>

    <p>Site-specific white-listing of access to "<span title="public storage area">public</span>" storage
    area: user agents may allow sites to access persistent storage
    for their own domain and subdomains in an unrestricted manner, but
    require the user to authorise access to the storage area of
    higher-level domains.</p>

    <p>For example, code at <code>example.com</code> would be always
    allowed to read and write data for <code>www.example.com</code>
    and <code>example.com</code>, but if it tried to access
    <code>com</code>, the user agent could display a non-modal message
    informing the user that the page requested access to
    <code>com</code> and offering to allow it.</p>

   </li>

   <li>

    <p>Origin-tracking of persistent storage data: user agents may
    record the domain of the script that caused data to be stored.</p>

    <p>If this information is then used to present the view of data
    currently in persistent storage, it would allow the user to make
    informed decisions about which parts of the persistent storage to
    prune. Combined with a blacklist ("delete this data and prevent
    this domain from ever storing data again"), the user can restrict
    the use of persistent storage to sites that he trusts.</p>

   </li>

   <li>

    <p>Shared blacklists: user agents may allow users to share their
    persistent storage domain blacklists.</p>

    <p>This would allow communities to act together to protect their
    privacy.</p>

   </li>

  </ul>

  <p>While these suggestions prevent trivial use of this API for user
  tracking, they do not block it altogether. Within a single domain, a
  site can continue to track the user across multiple sessions, and
  can then pass all this information to the third party along with any
  identifying information (names, credit card numbers, addresses)
  obtained by the site. If a third party cooperates with multiple
  sites to obtain such information, a profile can still be created.</p>

  <p>However, user tracking is to some extent possible even with no
  cooperation from the user agent whatsoever, for instance by using
  session identifiers in URIs, a technique already commonly used for
  innocuous purposes but easily repurposed for user tracking (even
  retroactively). This information can then be shared with other
  sites, using using visitors' IP addresses and other user-specific
  data (e.g. user-agent headers and configuration settings) to combine
  separate sessions into coherent user profiles.</p>

  <h5>Cookie resurrection</h5>

  <p>If the user interface for persistent storage presents data in the
  persistent storage feature separately from data in HTTP session
  cookies, then users are likely to delete data in one and not the
  other. This would allow sites to use the two features as redundant
  backup for each other, defeating a user's attempts to protect his
  privacy.</p>

  <h5>Integrity of "public" storage areas</h5>

  <p>Since the "<span title="public storage area">public</span>" global storage areas are accessible by content
  from many different parties, it is possible for third-party sites to
  delete or change information stored in those areas in ways that the
  originating sites may not expect.</p>

  <p>Authors must not use the "<span title="public storage area">public</span>" global storage areas for
  storing sensitive data. Authors must not trust information stored in
  "<span title="public storage area">public</span>" global storage areas.</p>

  <h5>Cross-protocol and cross-port attacks</h5>

  <p>This API makes no distinction between content served over HTTP,
  FTP, or other host-based protocols, and does not distinguish between
  content served from different ports at the same host.</p>

  <p>Thus, for example, data stored in the global persistent storage
  for domain "www.example.com" by a page served from HTTP port 80 will
  be available to a  page served in
  <code>http://example.com:18080/</code>, even if the latter is an
  experimental server under the control of a different user.</p>

  <p>Since the data is not sent over the wire by the user agent, this
  is not a security risk in its own right. However, authors must take
  proper steps to ensure that all hosts that have fully qualified host
  names that are subsets of hosts dealing with sensitive information
  are as secure as the originating hosts themselves.</p>

  <p>Similarly, authors must ensure that all Web servers on a host,
  regardless of the port, are equally trusted if any of them are to
  use persistent storage. For instance, if a Web server runs a
  production service that makes use of the persistent storage feature,
  then other users that have access to that machine and that can run a
  Web server on another port will be able to access the persistent
  storage added by the production service (assuming they can trick a
  user into visiting their page).</p>

  <p>However, if one is able to trick users into visiting a Web server
  with the same host name but on a different port as a production
  service used by these users, then one could just as easily fake the
  look of the site and thus trick users into authenticating with the
  fake site directly, forwarding the request to the real site and
  stealing the credentials in the process. Thus, the persistent
  storage feature is considered to only minimally increase the
  risk involved.</p>

  <p class="big-issue">What about if someone is able to get a server
  up on a port, and can then send people to that URI? They could steal
  all the data with no further interaction. How about putting the port
  number at the end of the string being compared? (Implicitly.)</p>

  <h5>DNS spoofing attacks</h5>

  <p>Because of the potential for DNS spoofing attacks, one cannot
  guarentee that a host claiming to be in a certain domain really is
  from that domain. The <code
  title="dom-StorageItem-secure">secure</code> attribute is provided
  to mark certain key/value pairs as only being accessible to pages
  that have been authenticated using secure certificates (or similar
  mechanisms).</p>

  <p>Authors must ensure that they do not mark sensitive items as
  "safe for both secure and insecure content". (To prevent the risk of
  a race condition, data stored by scripts in secure contexts default
  to being marked as "safe only for secure content".)</p>

  <h5>Cross-directory attacks</h5>

  <p>Different authors sharing one host name, for example users
  hosting content on <code>geocities.com</code>, all share one
  persistent storage object. There is no feature to restrict the
  access by pathname. Authors on shared hosts are therefore
  recommended to avoid using the persistent storage feature, as it
  would be trivial for other authors to read from and write to the
  same storage area.</p>

  <p class="note">Even if a path-restriction feature was made
  available, the usual DOM scripting security model would make it
  trivial to bypass this protection and access the data from any
  path.</p>


  <h5>Public storage areas corresponding to hosts</h5>

  <p>If a "<span title="public storage area">public</span>" global
  storage area corresponds to a host, as it typically does if for
  private domains with third-party subdomains such as dyndns.org or
  uk.com, the host corresponding to the "public" domain has access to
  all the storage areas of its third-party subdomains. In general,
  authors are discouraged from using the <code
  title="dom-globalStorage">globalStorage</code> API for sensitive
  data unless the operators of all the domains involved are
  trusted.</p>

  <p>User agents may mitigate this problem by preventing hosts
  corresponding to "<span title="public storage area">public</span>"
  global storage areas from accessing any storage areas other than
  their own.</p>


  <h5>Storage areas in the face of untrusted higher-level domains that do not correspond to public storage areas</h5>

  <p>Authors should not store sensitive data using the global storage
  APIs if there are hosts with fully-qualified domain names that are
  subsets of their own which they do not trust. For example, an author
  at <code>finance.members.example.net</code> should not store
  sensitive financial user data in the
  <code>finance.members.example.net</code> storage area if he does not
  trust the host that runs <code>example.net</code>.</p>


  <h5>Storage areas in the face of untrusted subdomains</h5>

  <p>If an author publishing content on one host,
  e.g. <code>example.com</code>, wishes to use the <code
  title="dom-globalStorage">globalStorage</code> API but does not wish
  any content on the host's subdomains to access the data, the author
  should use an otherwise non-existent subdomain name, e.g.,
  <code>private.example.com</code>, to store the data. This will be
  accessible only to that host (and its parent domains), and not to
  any of the real subdomains
  (e.g. <code>upload.example.com</code>).</p>


  <h5>Implementation risks</h5>

  <p>The two primary risks when implementing this persistent storage
  feature are letting hostile sites read information from other
  domains, and letting hostile sites write information that is then
  read from other domains.</p>

  <p>Letting third-party sites read data that is not supposed to be
  read from their domain causes <em>information leakage</em>, For
  example, a user's shopping wishlist on one domain could be used by
  another domain for targeted advertising; or a user's
  work-in-progress confidential documents stored by a word-processing
  site could be examined by the site of a competing company.</p>

  <p>Letting third-party sites write data to the storage areas of
  other domains can result in <em>information spoofing</em>, which is
  equally dangerous. For example, a hostile site could add items to a
  user's wishlist; or a hostile site could set a user's session
  identifier to a known ID that the hostile site can then use to track
  the user's actions on the victim site.</p>

  <p>A risk is also presented by servers on local domains having
  host names matching top-level domain names, for instance having a
  host called "com" or "net". Such hosts might, if implementations
  fail to correctly implement the <code>.localdomain</code> suffixing,
  <!-- XXX cross ref --> have full access to all the data stored in a
  UA's persistent storage for that top level domain.</p>

  <p>Thus, strictly following the model described in this
  specification is important for user security.</p>

  <p>In addition, a number of optional restrictions related to the
  "<span title="public storage area">public</span>" global storage
  areas are suggested in the previous sections. The design of this API
  is intended to be such that not supporting these restrictions, or
  supporting them less than perfectly, does not result in critical
  security problems. However, implementations are still encouraged to
  create and maintain a list of "<span title="public storage
  area">public</span>" domains, and apply the restrictions described
  above.</p>



  <h3 id="sound">Sound</h3>

  <p>The <code>Audio</code> interface allows scripts to play sound
  clips. This interface is intended for sound effects, not for
  streaming audio or multimedia; for the latter, the
  <code>object</code> element is more appropriate. <span
  class="issue">We need to add an API for object to support pausing,
  etc, of streaming APIs.</span></p>

  <p>There is no markup element that corresponds to <code>Audio</code>
  objects, they are only accessible from script.</p>

  <p>User agents should allow users to dynamically enable and disable
  sound output, but doing so must not affect how <code>Audio</code>
  objects act in any way other than whether sounds are physically
  played back or not. For instance, sound files must still be
  downloaded, <code>load</code> and <code>error</code> events must
  still fire, and if two identical clips are started with a two second
  interval then when the sound is reenabled they must still be two
  seconds out of sync.</p>

  <p>When multiple sounds are played simultaneously, the user agent
  must mix the sounds together.</p>

  <pre class="idl">interface <dfn>Audio</dfn> {<!-- XXX xrefs -->
           attribute EventListener onload;
           attribute EventListener onerror;
  void play();
  void loop();
  void loop(in unsigned long playCount);
  void stop();
};</pre>

  <p><code>Audio</code> objects must also implement the
  <code>EventTarget</code> interface. <a
  href="#refsDOM3EVENTS">[DOM3EVENTS]</a>

  <p>In ECMAScript, an instance of <code>Audio</code> can be created
  using the <code>Audio(<var title="">uri</var>)</code> constructor:</p>

  <pre class="example">var a = new Audio("test.wav");</pre>

  <p>The <dfn><code>Audio()</code> constructor</dfn> takes a single
  argument, a URI (or IRI), which is resolved using the script
  context's <code>window.location.href</code> value as the base, and
  which returns an <code>Audio</code> object that will, at the
  completion of the current script, start loading that URI.</p>

  <p>Once the URI is loaded, a <code>load</code> event must be fired
  on the <code>Audio</code> object.</p>

  <p><code>Audio</code> objects have a current position and a play
  count. Both are initially zero.</p>

  <p>The <code>Audio</code> interface has the following members:</p>

  <!-- XXX conf criteria -->
  <dl>

   <dt><dfn title="Audio.onload">onload</dfn></dt>

   <dd>An event listener that is invoked along with any other
   appropriate event listeners that are registered on this object when
   a <code>load</code> event is fired on it.</dd>

   <dt><dfn title="Audio.play">play()</dfn></dt>

   <dd>Begins playing the sound at the current position, setting the
   play count to 1.</dd>

   <dt><dfn title="Audio.loop">loop()</dfn></dt>

   <dd>Begins playing the sound at the current position, setting the
   play count to infinity.</dd>

   <dt><dfn title="Audio.loopN">loop(<var title="">playCount</var>)</dfn></dt>

   <dd>Begins playing the sound at the current position, setting the
   play count to <var title="">playCount</var>.</dd>

   <dt><dfn title="Audio.stop">stop()</dfn></dt>

   <dd>Stops playing the clip and resets the current position and
   play count to zero.</dd>

  </dl>

  <p>When playback of the sound reaches the end of the available data,
  its current position is reset to the start of the clip, and the play
  count is decreased by one (unless it is infinite). If the play count
  is greater than zero, then the sound is played again.</p>

<!--
   var sound = new Audio("URI relative to document URI");
   sound.onload = function() { } // onload event handler
   sound.play(); // play once
   sound.loop(); // loop forever
   sound.loop(2); // play twice
   sound.stop(); // stop (if playing) and rewind
-->

<!--
WANT
   sound.volume = 1.0; // 0.0 to 1.0
   sound.pause(); // stop at current position but don't rewind
   onerror

MAYBE WANT
   sound.seek(l/2); // seek to position, in seconds
   sound.pan = 0.0; // -1.0 (left) to 1.0 (right)
   l = sound.length; // length of clip in seconds
   onprogress
-->



  <h2 id="editing"><dfn>Editing</dfn></h2>

  <p>This section describes various features that allow authors to
  enable users to edit documents and parts of documents
  interactively.</p>

  <h3 id="editing-intro">Introduction</h3>

  <p><em>This section is non-normative.</em></p>

  <p class="big-issue">Would be nice to explain how these features
  work together.</p>


  <h3 id="contenteditable">The <code
  title="attr-contenteditable">contenteditable</code> attribute</h3>

  <p>The <dfn
  title="attr-contenteditable"><code>contenteditable</code></dfn>
  attribute is a common attribute. User agents must support this
  attribute on all <span>HTML elements</span>.</p>

  <p>The <code title="attr-contenteditable">contenteditable</code>
  attribute is an <span>enumerated attribute</span> whose keywords are
  the empty string, <code title="">true</code>, and <code
  title="">false</code>. The empty string and the <code
  title="">true</code> keyword map to the <em>true</em> state. The
  <code title="">false</code> keyword maps to the <em>false</em>
  state, which is also the <em>invalid value default</em>. There is no
  <em>missing value default</em>.</p>

  <p>If an HTML element has a <code
  title="attr-contenteditable">contenteditable</code> attribute set to
  the true state, or if its nearest ancestor with the <code
  title="attr-contenteditable">contenteditable</code> attribute set
  has its attribute set to the true state, or if it has no ancestors
  with the <code title="attr-contenteditable">contenteditable</code>
  attribute set but the <code>Document</code> has <code
  title="dom-document-designMode">designMode</code> enabled, then the
  UA must treat the element as <dfn>editable</dfn> (as described
  below).</p>

  <p>Otherwise, either the HTML element has a <code
  title="attr-contenteditable">contenteditable</code> attribute set to
  the false state, or its nearest ancestor with the <code
  title="attr-contenteditable">contenteditable</code> attribute set is
  not <em>editable</em>, or it has no ancestor with the <code
  title="attr-contenteditable">contenteditable</code> attribute set
  and the <code>Document</code> itself has <code
  title="dom-document-designMode">designMode</code> disabled, and the
  element is thus not editable.</p>

  <p>The <dfn
  title="dom-contentEditable"><code>contentEditable</code></dfn> DOM
  attribute, on getting, must return the string "<code
  title="">inherit</code>" if the content attribute isn't set, "<code
  title="">true</code>" if the attribute is set and has the true
  state, and "<code title="">false</code>" otherwise. On setting, if
  the new value is case-insensitively<!-- XXX ascii --> equal to the
  string "<code title="">inherit</code>" then the content attribute
  must be removed, if the new value is case-insensitively<!-- XXX
  ascii --> equal to the string "<code title="">true</code> then the
  content attribute must be set to the string "<code
  title="">true</code>, if the new value is case-insensitively<!-- XXX
  ascii --> equal to the string "<code title="">false</code> then the
  content attribute must be set to the string "<code
  title="">false</code>, and otherwise the attribute setter must raise
  a <code>SYNTAX_ERR</code> exception.</p>

  <p>If an element is <span>editable</span> and its parent element is
  not, or if an element is <span>editable</span> and it has no parent
  element, then the element is an <dfn>editing host</dfn>. Editable
  elements can be nested. User agents must make editing hosts
  focusable (which typicially means they enter the <span
  title="tabindex">tab order</span>). An editing host can contain
  non-editable sections, these are handled as described below. An
  editing host can contain non-editable sections that contain further
  editing hosts.</p>

  <p>When an editing host has focus, it must have a <dfn>caret
  position</dfn> that specifies where the current editing position
  is. It may also have a <span title="the
  selection">selection</span>.</p> <!--- XXX xref to later section -->

  <p class="note">How the caret and selection are represented depends
  entirely on the UA.</p>

  <!-- XXX rendering requirement: The current caret should affect the
  line-height (i.e. it acts at least like an empty inline element) -->

  <!-- XXX document.designMode attribute -->


  <h4>User editing actions</h4>

  <p>There are several actions that the user agent should allow the
  user to perform while the user is interacting with an editing
  host. How exactly each action is triggered is not defined for every
  action, but when it is not defined, suggested key bindings are
  provided to guide implementors.</p>

  <dl>

   <dt>Move the caret</dt>

   <dd><p>User agents must allow users to move the caret to any
   position within an editing host, even into nested editable
   elements. This could be triggered as the default action of <code
   title="event-keydown">keydown</code> events with various key
   identifiers and as the default action of <code
   title="event-mousedown">mouseydown</code> events.</p></dd>


   <dt>Change the selection</dt>

   <dd><p>User agents must allow users to change <span>the
   selection</span> within an editing host, even into nested editable
   elements. This could be triggered as the default action of <code
   title="event-keydown">keydown</code> events with various key
   identifiers and as the default action of <code
   title="event-mousedown">mouseydown</code> events.</p></dd>


   <dt id="contenteditable-insertText">Insert text</dt>

   <dd><p>This action must be triggered as the default action of a
   <code title="event-textInput">textInput</code> event, and may be
   triggered by other commands as well. It must cause the user agent
   to insert the specified text (given by the event object's <code
   title="">data</code> attribute in the case of the <code
   title="event-textInput">textInput</code> event) at the caret.</p>

   <p>If the caret is positioned somewhere where <span>inline-level
   content</span> is not allowed (e.g. because the element accepts
   "both block-level and inline-level content but not both", and the
   element already contains block-level content), then the user agent
   must not insert the text directly at the caret position. In such
   cases the behaviour is UA-dependent, but user agents must not, in
   response to a request to insert text, generate a DOM that is less
   conformant than the DOM prior to the request.</p>

   <p>User agents should allow users to insert new paragraphs into
   elements that only contain block-level content.</p>

   <div class="example">
    <p>For example, given the markup:</p>
    <pre>&lt;section&gt;
 &lt;dl&gt;
  &lt;dt&gt; Ben &lt;/dt&gt;
  &lt;dd&gt; Goat &lt;/dd&gt;
 &lt;/dl&gt;
&lt;/section&gt;</pre>
    <p>...the user agent should allow the user to insert
    <code>p</code> elements before and after the <code>dl</code>
    element, as children of the <code>section</code> element.</p>
   </div>

   </dd>


   <dt id="contenteditable-breakBlock">Break block</dt>

   <dd><p>UAs should offer a way for the user to request that the
   current block be broken at the caret, e.g. as the default action of
   a <code title="event-keydown">keydown</code> event whose identifier
   is the "Enter" key and that has no modifiers set.</p>

   <p>The exact behaviour is UA-dependent, but user agents must not,
   in response to a request to break a block, generate a DOM that is
   less conformant than the DOM prior to the request.</p></dd>


   <dt id="contenteditable-br">Insert a line separator</dt>

   <dd><p>UAs should offer a way for the user to request an explicit
   line break at the caret position without breaking the block, for
   example as in a poem verse or an address. To insert a line break,
   the user agent must insert a <code>br</code> element.</p>

   <p>If the caret is positioned somewhere where <span>inline-level
   content</span> is not allowed (e.g. because the element accepts
   "both block-level and inline-level content but not both", and the
   element already contains block-level content), then the user agent
   must not insert the <code>br</code> element directly at the caret
   position. In such cases the behaviour is UA-dependent, but user
   agents must not, in response to a request to insert a line
   separator, generate a DOM that is less conformant than the DOM
   prior to the request.</p></dd>


   <dt id="contenteditable-delete">Delete</dt>

   <dd><p>UAs should offer a way for the user to delete text and
   elements, e.g. as the default action of <code
   title="event-keydown">keydown</code> events whose identifiers are
   "U+0008" or "U+007F".</p>

   <p>Five edge cases in particular need to be considered carefully
   when implementing this feature: backspacing at the start of an
   element, backspacing when the caret is immediately after an
   element, forward-deleting at the end of an element,
   forward-deleting when the caret is immediately before an element,
   and deleting a <span title="the selection">selection</span> whose
   start and end points do not share a common parent node.</p>

   <p>In any case, the exact behaviour is UA-dependent, but user
   agents must not, in response to a request to delete text or an
   element, generate a DOM that is less conformant than the DOM prior
   to the request.</p></dd>


   <dt id="contenteditable-wrapSemantic">Insert, and wrap text in,
   semantic elements</dt>

   <dd><p>UAs should offer a way for the user to mark text as having
   <span title="em">stress emphasis</span> and as being <span
   title="strong">important</span>, and may offer the user the ability
   to mark text and blocks with other semantics.</p>

   <p>UAs should similarly offer a way for the user to insert empty
   semantic elements (such as, again, <code>em</code>,
   <code>strong</code>, and others) to subsequently fill by entering
   text manually.</p>

   <p>UAs should also offer a way to remove those semantics from
   marked up text, and to remove empty semantic element that have been
   inserted.</p>

   <p>The exact behaviour is UA-dependent, but user agents must not,
   in response to a request to wrap semantics around some text or to
   insert or remove a semantic element, generate a DOM that is less
   conformant than the DOM prior to the request.</p></dd>


   <dt>Select and move non-editable elements nested inside editing hosts</dt>

   <dd><p>UAs should offer a way for the user to move images and other
   non-editable parts around the content within an editing host. This
   may be done using the <span>drag and drop</span> mechanism. User
   agents must not, in response to a request to move non-editable
   elements nested inside editing hosts, generate a DOM that is less
   conformant than the DOM prior to the request.</p></dd>


   <dt>Edit form controls nested inside editing hosts</dt>

   <dd><p>When an <span>editable</span> form control is edited, the
   changes must be reflected in both its current value <em>and</em>
   its default value. For <code>input</code> elements this means
   updating the <code
   title="dom-input-defaultValue">defaultValue</code> DOM attribute as
   well as the <code title="dom-input-value">value</code> DOM
   attribute; for <code>select</code> elements it means updating the
   <code>option</code> elements' <code
   title="dom-option-defaultSelected">defaultSelected</code> DOM
   attribute as well as the <code
   title="dom-option-selected">selected</code> DOM attribute; for
   <code>textarea</code> elements this means updating the <code
   title="dom-textarea-defaultValue">defaultValue</code> DOM attribute
   as well as the <code title="dom-textarea-value">value</code> DOM
   attribute. (Updating the <code title="">default*</code> DOM
   attributes causes content attributs to be updated as well.)</p></dd>

   <!-- XXX something about not supporting resizing? -->

  </dl>

  <!-- XXX each action performed should be added to the undo history -->

  <p>User agents may perform several commands per user request; for
  example if the user selects a block of text and hits
  <kbd><kbd>Enter</kbd></kbd>, the UA might interpret that as a
  request to delete the content of <span>the selection</span> followed
  by a request to break the block at that position.</p>


  <h4>Making entire documents editable</h4>

  <p>Documents have a <dfn id="designMode"
  title="dom-document-designMode"><code>designMode</code></dfn>, which
  can be either enabled or disabled.</p>

  <p>The <code title="dom-document-designMode">designMode</code> DOM
  attribute on the <code>Document</code> object takes takes two
  values, "<code title="">on</code>" and "<code
  title="">off</code>". When it is set, the new value must be
  case-insensitively <!-- XXX ASCII case-folding --> compared to these
  two values. If it matches the "<code title="">on</code>" value, then
  <code title="dom-document-designMode">designMode</code> must be
  enabled, and if it matches the "<code title="">off</code>" value,
  then <code title="dom-document-designMode">designMode</code> must be
  disabled. Other values must be ignored.</p>

  <p>When <code title="dom-document-designMode">designMode</code> is
  enabled, the DOM attribute must return the value "<code
  title="">on</code>", and when it is disabled, it must return the
  value "<code title="">off</code>".</p>

  <p>The last state set must persist until the document is destroyed
  or the state is changed. Initially, documents must have their <code
  title="dom-document-designMode">designMode</code> disabled.</p>

  <p>Enabling <code title="dom-document-designMode">designMode</code>
  causes scripts in general to be disabled and the document to become
  editable.</p>

  <p>When the <code>Document</code> has <code
  title="dom-document-designMode">designMode</code> enabled, event
  listeners registered on the document or any elements owned by the
  document must do nothing.</p>



  <h3 id="dnd"><dfn>Drag and drop</dfn></h3>

<!--XXX

http://msdn.microsoft.com/workshop/author/datatransfer/overview.asp
http://msdn.microsoft.com/workshop/author/dhtml/reference/objects/clipboarddata.asp

> To implement this with simple interface I've proposed, events should be
> handled either by existing elements (like list items that compare their size
> and position of dragged element to decide whether element should be dropped
> before or after) or handled by container that would probably need to calculate
> positions of it's children and create new element to show drop target. Smooth
> Mac-like drag'n'drop can be implemented by animating drop target's
> padding/margin. So that's quite a bit of code that's going to be reinvented
> each time someone implements reordering.

<hyatt> :droptarget
<hyatt> or something
<hyatt> we don't support a pseudo-class for the drop target but that's a great idea
<Hixie_> yeah, thinking about that too
<Hixie_> :drop-target, :drop-target(above), :drop-target(below) and having ondragover be able to say "not on me, but next to me maybe"

http://msdn.microsoft.com/workshop/author/dhtml/reference/events/ondragstart.asp
http://msdn.microsoft.com/workshop/author/dhtml/reference/events/ondrag.asp
http://msdn.microsoft.com/workshop/author/dhtml/reference/events/ondragend.asp
http://msdn.microsoft.com/workshop/author/dhtml/reference/objects/obj_datatransfer.asp
http://developer.apple.com/documentation/AppleApplications/Conceptual/SafariJSProgTopics/Tasks/DragAndDrop.html
-->

  <p>This section defines an event-based drag-and-drop mechanism.</p>

  <p>This specification does not define exactly what a
  <em>drag-and-drop operation</em> actually is.</p>

  <p>On a visual medium with a pointing device, a drag operation could
  be the default action of a <code
  title="event-mousedown">mousedown</code> event that is followed by a
  series of <code title="event-mousemove">mousemove</code> events, and
  the drop could be triggered by the mouse being released.</p>

  <p>On media without a pointing device, the user would probably have
  to explicitly indicate his intention to perform a drag-and-drop
  operation, stating what he wishes to drag and what he wishes to
  drop, respectively.</p>

  <p>However it is implemented, drag-and-drop operations must have a
  starting point (e.g. where the mouse was clicked, or the start of
  <span>the selection</span> or element that was selected for the
  drag), may have any number of intermediate steps (elements that the
  mouse moves over during a drag, or elements that the user picks as
  possible drop points as he cycles through possibilities), and must
  either have an end point (the element above which the mouse button
  was released, or the element that was finally selected), or be
  canceled. The end point must be the last element selected as a
  possible drop point before the drop occurs (so if the operation is
  not canceled, there must be at least one element in the middle
  step).</p>


  <h4>The <code>DragEvent</code> and <code>DataTransfer</code> interfaces</h4>

  <p>The drag-and-drop processing model involves several events. They
  all use the <code>DragEvent</code> interface.</p>

  <pre class="idl">interface <dfn>DragEvent</dfn> : Event {
  readonly attribute <span>DataTransfer</span> <span title="dom-DragEvent-dataTransfer">dataTransfer</span>;
  void <span title="dom-DragEvent-initDragEvent">initDragEvent</span>(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg);
  void <span title="dom-DragEvent-initDragEventNS">initDragEventNS</span>(in DOMString namespaceURIArg, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg);
};</pre>

  <p>The <dfn
  title="dom-DragEvent-initDragEvent"><code>initDragEvent()</code></dfn>
  and <dfn
  title="dom-DragEvent-initDragEventNS"><code>initDragEventNS()</code></dfn>
  methods must initialise the event in a manner analogous to the
  similarly-named methods in the DOM3 Events interfaces. <a
  href="#DOM3Events">[DOM3EVENTS]</a></p>

  <p>The <dfn
  title="dom-DragEvent-dataTransfer"><code>dataTransfer</code></dfn>
  attribute of the <code>DragEvent</code> interface represents the
  context information for the event.</p>

  <p>When a <code>DragEvent</code> object is created, a new
  <code>DataTransfer</code> object must be created and assigned to the
  <code title="dom-DragEvent-dataTransfer">dataTransfer</code>
  context information field of the event object.</p>


  <pre class="idl">interface <dfn>DataTransfer</dfn> {
           attribute DOMString <span title="dom-DataTransfer-dropEffect">dropEffect</span>;
           attribute DOMString <span title="dom-DataTransfer-effectAllowed">effectAllowed</span>;
  void <span title="dom-DataTransfer-clearData">clearData</span>(in DOMString format);
  void <span title="dom-DataTransfer-setData">setData</span>(in DOMString format, in DOMString data);
  DOMString <span title="dom-DataTransfer-getData">getData</span>(in DOMString format);
  void <span title="dom-DataTransfer-setDragImage">setDragImage</span>(in Element image, in long x, in long y);
  void <span title="dom-DataTransfer-addElement">addElement</span>(in Element element);
};
</pre>

  <p><code>DataTransfer</code> objects can conceptually contain
  various kinds of data.</p>

  <p>When a <code>DragEvent</code> event object is initialised, the
  <code>DataTransfer</code> object created for the event's <code
  title="dom-DragEvent-dataTransfer">dataTransfer</code> member must
  be initialised as follows:</p>

  <ul>

   <li>The <code>DataTransfer</code> object must initially contain no
   data, no elements, and have no associated image.</li>

   <li>The <code>DataTransfer</code> object's <code
   title="dom-DataTransfer-effectAllowed">effectAllowed</code>
   attribute must be set to "<code
   title="">uninitialized</code>".</li>

   <li>The <code title="dom-DataTransfer-dropEffect">dropEffect</code>
   attribute must be set to "<code title="">none</code>".</li>

  </ul>

  <p>The <dfn
  title="dom-DataTransfer-dropEffect"><code>dropEffect</code></dfn>
  attribute controls the drag-and-drop feedback that the user is given
  during a drag-and-drop operation.</p>

  <p>The attribute must ignore any attempts to set it to a value other
  than <code title="">none</code>, <code title="">copy</code>, <code
  title="">link</code>, and <code title="">move</code>. On getting,
  the attribute must return the last of those four values that it was
  set to.</p>

  <p>The <dfn
  title="dom-DataTransfer-effectAllowed"><code>effectAllowed</code></dfn>
  attribute is used in the drag-and-drop processing model to
  initialise the <code
  title="dom-DataTransfer-dropEffect">dropEffect</code> attribute
  during the <code title="event-dragenter">dragenter</code> and <code
  title="event-dragover">dragover</code> events.</p>

  <p>The attribute must ignore any attempts to set it to a value other
  than <code title="">none</code>, <code title="">copy</code>, <code
  title="">copyLink</code>, <code title="">copyMove</code>, <code
  title="">link</code>, <code title="">linkMove</code>, <code
  title="">move</code>, <code title="">all</code>, and <code
  title="">uninitialized</code>. On getting, the attribute must return
  the last of those values that it was set to.</p>

  <p><code>DataTransfer</code> objects can hold pieces of data, each
  associated with a unique format. Formats are generally given by MIME
  types, with some values special-cased for legacy reasons.</p>

  <p>The <dfn title="dom-DataTransfer-clearData"><code>clearData(<var
  title="">format</var>)</code></dfn> method must clear the
  <code>DataTransfer</code> object of any data associated with the
  given <var title="">format</var>. If <var title="">format</var> is
  the value "<code title="">Text</code>", then it must be treated as
  "<code title="">text/plain</code>". If the <var
  title="">format</var> is "<code title="">URL</code>", then it must
  be treated as "<code title="">text/uri-list</code>".</p>

  <p>The <dfn title="dom-DataTransfer-setData"><code>setData(<var
  title="">format</var>, <var title="">data</var>)</code></dfn> method
  must add <var title="">data</var> to the data stored in the
  <code>DataTransfer</code> object, labelled as being of the type <var
  title="">format</var>. This must replace any previous data that had
  been set for that format. If <var title="">format</var> is the value
  "<code title="">Text</code>", then it must be treated as "<code
  title="">text/plain</code>". If the <var title="">format</var> is
  "<code title="">URL</code>", then it must be treated as "<code
  title="">text/uri-list</code>".</p>

  <p>The <dfn title="dom-DataTransfer-getData"><code>getData(<var
  title="">format</var>)</code></dfn> method must return the data that
  is associated with the type <var title="">format</var>, if any, and
  must return the empty string otherwise. If <var
  title="">format</var> is the value "<code title="">Text</code>",
  then it must be treated as "<code title="">text/plain</code>". If
  the <var title="">format</var> is "<code title="">URL</code>", then
  the data associated with the "<code title="">text/uri-list</code>"
  format must be parsed as appropriate for <code
  title="">text/uri-list</code> data, and the first URI from the list
  must be returned. If there is no data with that format, or if there
  is but it has no URIs, then the method must return the empty
  string. <a href="#refsRFC2483">[RFC2483]</a></p>

  <p>The <dfn
  title="dom-DataTransfer-setDragImage"><code>setDragImage(<var
  title="">element</var>, <var title="">x</var>, <var
  title="">y</var>)</code></dfn> method sets which element to use <a
  href="#base-dnd-feedback">to generate the drag feedback</a>. The
  <var title="">element</var> argument can be any
  <code>Element</code>; if it is an <code>img</code> element, then the
  user agent should use the element's image (at its intrinsic size) to
  generate the feedback, otherwise the user agent should base the
  feedback on the given element (but the exact mechanism for doing so
  is not specified).</p>

  <p>The <dfn
  title="dom-DataTransfer-addElement"><code>addElement(<var
  title="">element</var>)</code></dfn> method is an alternative way of
  specifying how the user agent is to <a
  href="#base-dnd-feedback">render the drag feedback</a>. It adds an
  element to the <code>DataTransfer</code> object.</p>


  <h4>Events fired during a drag-and-drop action</h4>

  <p>The following events are involved in the drag-and-drop
  model. Whenever the processing model described below causes one of
  these events to be fired, the event fired must use the
  <code>DragEvent</code> interface defined above, must have the
  bubbling and cancelable behaviours given in the table below, and
  must have the context information set up as described after the
  table.</p>

  <table>

   <thead>
    <tr>
     <th> Event Name </th>
     <th> Target </th>
     <th> Bubbles? </th>
     <th> Cancelable? </th>
     <th> <code title="dom-DataTransfer-addElement">dataTransfer</code> </th>
     <th> <code title="dom-DataTransfer-effectAllowed">effectAllowed</code> </th>
     <th> <code title="dom-DataTransfer-dropEffect">dropEffect</code> </th>
     <th> Default Action </th>
    </tr>
   </thead>

   <tbody>

    <tr>
     <td><dfn title="event-dragstart"><code>dragstart</code></dfn></td>
     <td><span>Source node</span></td>
     <td>&#x2713; Bubbles</td>
     <td>&#x2713; Cancelable</td>
     <td>Contains <span>source node</span> unless a selection is being dragged, in which case it is empty</td>
     <td><code title="">uninitialized</code></td>
     <td><code title="">none</code></td>
     <td>Initiate the drag-and-drop operation</td>
    </tr>

    <tr>
     <td><dfn title="event-drag"><code>drag</code></dfn></td>
     <td><span>Source node</span></td>
     <td>&#x2713; Bubbles</td>
     <td>&#x2713; Cancelable</td>
     <td>Empty</td>
     <td><a href="#effectAllowed-initialisation">Same as last event</a></td>
     <td><code title="">none</code></td>
     <td>Continue the drag-and-drop operation</td>
    </tr>

    <tr>
     <td><dfn title="event-dragenter"><code>dragenter</code></dfn></td>
     <td><span>Immediate user selection</span> or <span>the body element</span></td>
     <td>&#x2713; Bubbles</td>
     <td>&#x2713; Cancelable</td>
     <td>Empty</td>
     <td><a href="#effectAllowed-initialisation">Same as last event</a></td>
     <td><a href="#dropEffect-initialisation">Based on <code>effectAllowed</code> value</a></td>
     <td>Reject <span>immediate user selection</span> as potential <span title="current target element">target element</span></td>
    </tr>

    <tr>
     <td><dfn title="event-dragleave"><code>dragleave</code></dfn></td>
     <td><span title="current target element">Previous target element</span></td>
     <td>&#x2713; Bubbles</td>
     <td>&mdash;</td>
     <td>Empty</td>
     <td><a href="#effectAllowed-initialisation">Same as last event</a></td>
     <td><code title="">none</code></td>
     <td>None</td>
    </tr>

    <tr>
     <td><dfn title="event-dragover"><code>dragover</code></dfn></td>
     <td><span>Current target element</span></td>
     <td>&#x2713; Bubbles</td>
     <td>&#x2713; Cancelable</td>
     <td>Empty</td>
     <td><a href="#effectAllowed-initialisation">Same as last event</a></td>
     <td><a href="#dropEffect-initialisation">Based on <code>effectAllowed</code> value</a></td>
     <td>Reset the <span>current drag operation</span> to "none"</td>
    </tr>

    <tr>
     <td><dfn title="event-drop"><code>drop</code></dfn></td>
     <td><span>Current target element</span></td>
     <td>&#x2713; Bubbles</td>
     <td>&#x2713; Cancelable</td>
     <td><code>getData()</code> returns data set in <code title="dom-dragstart">dragstart</code> event</td>
     <td><a href="#effectAllowed-initialisation">Same as last event</a></td>
     <td><span>Current drag operation</span></td>
     <td>Varies</td>
    </tr>

    <tr>
     <td><dfn title="event-dragend"><code>dragend</code></dfn></td>
     <td><span>Source node</span></td>
     <td>&#x2713; Bubbles</td>
     <td>&mdash;</td>
     <td>Empty</td>
     <td><a href="#effectAllowed-initialisation">Same as last event</a></td>
     <td><span>Current drag operation</span></td>
     <td>Varies</td>
    </tr>

   </tbody>

  </table>

  <p>The <code title="dom-DragEvent-dataTransfer">dataTransfer</code>
  object's contents are empty except for <code
  title="event-dragstart">dragstart</code> events and <code
  title="event-drop">drop</code> events, for which the contents are
  set as described in the processing model, below.</p>

  <p id="effectAllowed-initialisation">The <code
  title="dom-DataTransfer-effectAllowed">effectAllowed</code>
  attribute must be set to "<code title="">uninitialized</code>" for
  <code title="event-dragstart">dragstart</code> events, and to
  whatever value the field had after the last drag-and-drop event was
  fired for all other events (only counting events fired by the user
  agent for the purposes of the drag-and-drop model described
  below).</p>

  <p id="dropEffect-initialisation">The <code
  title="dom-DataTransfer-dropEffect">dropEffect</code> attribute must
  be set to "<code title="">none</code>" for <code
  title="event-dragstart">dragstart</code>, <code
  title="event-drag">drag</code>, <code
  title="event-dragleave">dragleave</code>, and <code
  title="event-dragend">dragend</code> events (except when stated
  otherwise in the algorithms given in the sections below), to the
  value corresponding to the <span>current drag operation</span> for
  <code title="event-drop">drop</code> events, and to a value based on
  the <code
  title="dom-DataTransfer-effectAllowed">effectAllowed</code>
  attribute's value and to the drag-and-drop source, as given by the
  following table, for the remaining events (<code
  title="event-dragenter">dragenter</code> and <code
  title="event-dragover">dragover</code>):</p>

  <table>
   <thead>
    <tr>
     <th><code title="dom-DataTransfer-effectAllowed">effectAllowed</code></th>
     <th><code title="dom-DataTransfer-dropEffect">dropEffect</code></th>
    </tr>
   </thead>
   <tr>
    <td><code title="">none</code></td>
    <td><code title="">none</code></td>
   </tr>
   <tr>
    <td><code title="">copy</code>, <code title="">copyLink</code>, <code title="">copyMove</code>, <code title="">all</code></td>
    <td><code title="">copy</code></td>
   </tr>
   <tr>
    <td><code title="">link</code>, <code title="">linkMove</code></td>
    <td><code title="">link</code></td>
   </tr>
   <tr>
    <td><code title="">move</code></td>
    <td><code title="">move</code></td>
   </tr>
   <tr>
    <td><code title="">uninitialized</code> when what is being dragged is a selection from a text field</td>
    <td><code title="">move</code></td>
   </tr>
   <tr>
    <td><code title="">uninitialized</code> when what is being dragged is a selection</td>
    <td><code title="">copy</code></td>
   </tr>
   <tr>
    <td><code title="">uninitialized</code> when what is being dragged is an <code>a</code> element with an <code>href</code> attribute</td>
    <td><code title="">link</code></td>
   </tr>
   <tr>
    <td>Any other case</td>
    <td><code title="">copy</code></td>
   </tr>
  </table>


  <h4>Drag-and-drop processing model</h4>

  <p>When the user attempts to begin a drag operation, the user agent
  must first determine what is being dragged. If the drag operation
  was invoked on a selection, then it is the selection that is being
  dragged. Otherwise, it is the first element, going up the ancestor
  chain, starting at the node that the user tried to drag, that has
  the DOM attribute <code title="dom-draggable">draggable</code> set
  to true. If there is no such element, then nothing is being dragged,
  the drag-and-drop operation is never started, and the user agent
  must not continue with this algorithm.</p>

  <p class="note"><code>img</code> elements and <code>a</code>
  elements with an <code title="attr-hyperlink-href">href</code>
  attribute have their <code title="dom-draggable">draggable</code>
  attribute set to true by default.</p>

  <p>If the user agent determines that something can be dragged, a
  <code title="event-dragstart">dragstart</code> event must then be
  fired.</p>

  <p>If it is a selection that is being dragged, then this event must
  be fired on the node that the user started the drag on (typically
  the text node that the user originally clicked). If the user did not
  specify a particular node, for example if the user just told the
  user agent to begin a drag of "the selection", then the event must
  be fired on the deepest node that is a common ancestor of all parts
  of the selection.</p>

  <p>If it is not a selection that is being dragged, then the event
  must be fired on the element that is being dragged.</p>

  <p>The node on which the event is fired is the <dfn>source
  node</dfn>. Multiple events are fired on this node during the course
  of the drag-and-drop operation.</p>

  <p>If it is a selection that is being dragged, the <code
  title="dom-DragEvent-dataTransfer">dataTransfer</code> member of the event
  must be created with no nodes. Otherwise, it must be created
  containing just the <span>source node</span>. Script can use the
  <code title="dom-DataTransfer-addElement">addElement()</code> method
  to add further elements to the list of what is being dragged.</p>

  <p>If it is a selection that is being dragged, the <code
  title="dom-DragEvent-dataTransfer">dataTransfer</code> member of the
  event must have the text of the selection added to it as the data
  associated with the <code title="">text/plain</code>
  format. Otherwise, if it is an <code>img</code> element being
  dragged, then the value of the element's <code
  title="dom-img-src">src</code> DOM attribute must be added,
  associated with the <code title="">text/uri-list</code>
  format. Otherwise, if it is an <code>a</code> element being dragged,
  then the value of the element's <code title="dom-a-href">href</code>
  DOM attribute must be added, associated with the <code
  title="">text/uri-list</code> format. Otherwise, no data is added to
  the object by the user agent.</p>

  <p>If the event is canceled, then the drag-and-drop operation must
  not occur; the user agent must not continue with this algorithm.</p>

  <p>If it is not canceled, then the drag-and-drop operation must be
  initiated.</p>

  <p class="note">Since events with no event handlers registered are,
  almost by definition, never canceled, drag-and-drop is always
  available to the user if the author does not specifically prevent
  it.</p>

  <p id="base-dnd-feedback">The drag-and-drop feedback must be
  generated from the first of the following sources that is
  available:</p>

  <ol>

   <li>The element specified in the last call to the <code
   title="dom-DataTransfer-setDragImage">setDragImage()</code> method
   of the <code title="dom-DragEvent-dataTransfer">dataTransfer</code>
   object of the <code title="event-dragstart">dragstart</code> event,
   if the method was called. In visual media, if this is used, the
   <var title="">x</var> and <var title="">y</var> arguments that were
   passed to that method should be used as hints for where to put the
   cursor relative to the resulting image. The values are expressed as
   distances in CSS pixels from the left side and from the top side of
   the image respectively. <a href="#refsCSS21">[CSS21]</a></li> <!--
   CSS3 UNITS would be better -->

   <li>The elements that were added to the <code
   title="dom-DragEvent-dataTransfer">dataTransfer</code> object, both
   before the event was fired, and during the handling of the event
   using the <code
   title="dom-DataTransfer-addElement">addElement()</code>
   method, if any such elements were indeed added.</li>

   <li>The selection that the user is dragging.</li>

  </ol><!-- XXX xref also link to the section that explains how to
  render drag-and-drop, :drag, :drop, etc. Safari has a pseudo-class
  that it uses to render an element off-screen to use as the drag
  feedback. -->

  <p>The user agent must take a note of <span
  title="dom-DataTransfer-setData">the data that was placed</span> in
  the <code title="dom-DragEvent-dataTransfer">dataTransfer</code>
  object. This data will be made available again when the <code
  title="event-drop">drop</code> event is fired.</p>

  <p>From this point until the end of the drag-and-drop operation,
  device input events (e.g. mouse and keyboard events) must be
  suppressed. In addition, the user agent must track all DOM changes
  made during the drag-and-drop operation, and add them to its <a
  href="#undo">undo history</a> as one atomic operation once the
  drag-and-drop operation has ended.</p>

  <p>During the drag operation, the element directly indicated by the
  user as the drop target is called the <dfn>immediate user
  selection</dfn>. (Only elements can be selected by the user; other
  nodes must not be made available as drop targets.)

  However, the <span>immediate user selection</span> is not
  necessarily the <dfn>current target element</dfn>, which is the
  element currently selected for the drop part of the drag-and-drop
  operation.

  The <span>immediate user selection</span> changes as the user
  selects different elements (either by pointing at them with a
  pointing device, or by selecting them in some other way). The
  <span>current target element</span> changes when the <span>immediate
  user selection</span> changes, based on the results of event
  handlers in the document, as described below.</p>

  <p>Both the <span>current target element</span> and the
  <span>immediate user selection</span> can be null, which means no
  target element is selected. They can also both be elements in other
  (DOM-based) documents, or other (non-Web) programs altogether. (For
  example, a user could drag text to a word-processor.) The
  <span>current target element</span> is initially null.</p>

  <p>In addition, there is also a <dfn>current drag operation</dfn>,
  which can take on the values "none", "copy", "link", and "move".
  Initially it has the value "none". It is updated by the user agent
  as described in the steps below.</p>

  <p>User agents must, every 350ms (&#xB1;200ms), perform the
  following steps in sequence. (If the user agent is still performing
  the previous iteration of the sequence when the next iteration
  becomes due, the user agent must not execute the overdue iteration,
  effectively "skipping missed frames" of the drag-and-drop
  operation.)</p>

  <ol>

   <li>

    <p>First, the user agent must fire a <code
    title="event-drag">drag</code> event at the <span>source
    node</span>. If this event is canceled, the user agent must set
    the <span>current drag operation</span> to none (no drag
    operation).</p>

   </li>

   <li>

    <p>Next, if the <code title="event-drag">drag</code> event was not
    canceled and the user has not ended the drag-and-drop operation,
    the user agent must check the state of the drag-and-drop
    operation, as follows:</p>

    <ol>

     <li>

      <p>First, if the user is indicating a different <span>immediate
      user selection</span> than during the last iteration (or if this
      is the first iteration), and if this <span>immediate user
      selection</span> is not the same as the <span>current target
      element</span>, then the <span>current target element</span> must
      be updated, as follows:</p>

      <ol>

       <li>

        <p>If the new <span>immediate user selection</span> is null, or
        is in a non-DOM document or application, then set the
        <span>current target element</span> to the same value.</p>

       <li>

        <p>Otherwise, the user agent must fire a <code
        title="event-dragenter">dragenter</code> event at the
        <span>immediate user selection</span>.</p>

       </li>

       <li>

        <p>If the event is canceled, then the <span>current target
        element</span> must be set to the <span>immediate user
        selection</span>.</p>

       </li>

       <li>

        <p>Otherwise, if the <span>current target element</span> is
        not <span>the body element</span>, the user agent must fire a
        <code title="event-dragenter">dragenter</code> event at
        <span>the body element</span>, and the <span>current target
        element</span> must be set to <span>the body element</span>,
        regardless of whether that event was canceled or not. (If
        <span>the body element</span> is null, then the <span>current
        target element</span> would be set to null too in this case,
        it wouldn't be set to the <code>Document</code> object.)</p>

       </li>

      </ol>

     </li>

     <li>

      <p>If the previous step caused the <span>current target
      element</span> to change, and if the previous target element was
      not null or a part of a non-DOM document, the user agent must fire
      a <code title="event-dragleave">dragleave</code> event at the
      previous target element.</p>

     </li>

     <li>

      <p>If the <span>current target element</span> is a DOM element,
      the user agent must fire a <code
      title="event-dragover">dragover</code> event at this <span>current
      target element</span>.</p>

      <p>If the <code title="event-dragover">dragover</code> event is
      canceled, the <span>current drag operation</span> must be reset
      to "none".</p>

      <p>Otherwise, the <span>current drag operation</span> must be
      set based on the values the <code
      title="dom-DataTransfer-effectAllowed">effectAllowed</code> and
      <code title="dom-DataTransfer-dropEffect">dropEffect</code>
      attributes of the <code
      title="dom-DragEvent-dataTransfer">dataTransfer</code> object
      had after the event was handled, as per the following table:</p>

      <table>
       <thead>
        <tr>
         <th><code title="dom-DataTransfer-effectAllowed">effectAllowed</code></th>
         <th><code title="dom-DataTransfer-dropEffect">dropEffect</code></th>
         <th>Drag operation</th>
        </tr>
       </thead>
       <tr>
        <td><code title="">uninitialized</code>, <code title="">copy</code>, <code title="">copyLink</code>, <code title="">copyMove</code>, or <code title="">all</code></td>
        <td><code title="">copy</code></td>
        <td>"copy"</td>
       </tr>
       <tr>
        <td><code title="">uninitialized</code>, <code title="">link</code>, <code title="">copyLink</code>, <code title="">linkMove</code>, or <code title="">all</code></td>
        <td><code title="">link</code></td>
        <td>"link"</td>
       </tr>
       <tr>
        <td><code title="">uninitialized</code>, <code title="">move</code>, <code title="">copyMove</code>, <code title="">linkMove</code>, or <code title="">all</code></td>
        <td><code title="">move</code></td>
        <td>"move"</td>
       </tr>
       <tr>
        <td colspan="2">Any other case</td>
        <td>"none"</td>
       </tr>
      </table>

      <p>Then, regardless of whether the <code
      title="event-dragover">dragover</code> event was canceled or
      not, the drag feedback (e.g. the mouse cursor) must be updated
      to match the <span>current drag operation</span>, as
      follows:</p>

      <table>
       <thead>
        <tr>
         <th>Drag operation</th>
         <th>Feedback</th>
        </tr>
       </thead>
       <tr>
        <td>"copy"</td>
        <td>Data will be copied if dropped here.</td>
       </tr>
       <tr>
        <td>"link"</td>
        <td>Data will be linked if dropped here.</td>
       </tr>
       <tr>
        <td>"move"</td>
        <td>Data will be moved if dropped here.</td>
       </tr>
       <tr>
        <td>"none"</td>
        <td>No operation allowed, dropping here will cancel the drag-and-drop operation.</td>
       </tr>
      </table>

     </li>

     <li>

      <p>Otherwise, if the <span>current target element</span> is not a
      DOM element, the user agent must use platform-specific mechanisms
      to determine what drag operation is being performed (none, copy,
      link, or move). This sets the <em>current drag operation</em>.</p>

     </li>

    </ol>

   </li>

   <li>

    <p>Otherwise, if the user ended the drag-and-drop operation (e.g.
    by releasing the mouse button in a mouse-driven drag-and-drop
    interface), or if the <code title="event-drag">drag</code> event
    was canceled, then this will be the last iteration. The user
    agent must follow the following steps, then stop looping.</p>

    <ol>

     <li>

      <p>If the <span>current drag operation</span> is none (no drag
      operation), or, if the user ended the drag-and-drop operation by
      canceling it (e.g. by hitting the <kbd>Escape</kbd> key), or if
      the <span>current target element</span> is null, then the drag
      operation failed. If the <span>current target element</span> is
      a DOM element, the user agent must fire a <code
      title="event-dragleave">dragleave</code> event at it; otherwise,
      if it is not null, it must use platform-specific conventions for
      drag cancellation.</p>

     </li>

     <li>

      <p>Otherwise, the drag operation was as success. If the
      <span>current target element</span> is a DOM element, the user
      agent must fire a <code title="event-drop">drop</code> event at
      it; otherwise, it must use platform-specific conventions for
      indicating a drop.</p>

      <p>When the target is a DOM element, the <code
      title="dom-DataTransfer-dropEffect">dropEffect</code> attribute
      of the event's <code
      title="dom-DragEvent-dataTransfer">dataTransfer</code> object
      must be given the value representing the <span>current drag
      operation</span> (<code title="">copy</code>, <code
      title="">link</code>, or <code title="">move</code>), and the
      object must be set up so that the <code
      title="dom-DataTransfer-getData">getData()</code> method will
      return the data that was added during the <code
      title="event-dragstart">dragstart</code> event.</p>

      <p>If the event is canceled, the <span>current drag
      operation</span> must be set to the value of the <code
      title="dom-DataTransfer-dropEffect">dropEffect</code> attribute
      of the event's <code
      title="dom-DragEvent-dataTransfer">dataTransfer</code> object as
      it stood after the event was handled.</p>

      <p>Otherwise, the event is not canceled, and the user agent must
      perform the event's default action, which depends on the exact
      target as follows:</p>

      <dl class="switch">

       <dt>If the <span>current target element</span> is a text field
       (e.g. <code>textarea</code>, or an <code>input</code> element
       with <code title="">type="text"</code><!--XXX xref-->)</dt>

       <dd>The user agent must insert the data associated with the
       <code>text/plain</code> format, if any, into the text field in
       a manner consistent with platform-specific conventions
       (e.g. inserting it at the current mouse cursor position, or
       inserting it at the end of the field).</dd>

       <dt>Otherwise</dt>

       <dd>Reset the <span>current drag operation</span> to
       "none".</dd>

      </dl>

     </li>

     <li>

      <p>Finally, the user agent must fire a <code
      title="event-dragend">dragend</code> event at the <span>source
      node</span>, with the <code
      title="dom-DataTransfer-dropEffect">dropEffect</code> attribute
      of the event's <code
      title="dom-DragEvent-dataTransfer">dataTransfer</code> object
      being set to the value corresponding to the <span>current drag
      operation</span>.</p>

      <p class="note">The <span>current drag operation</span> can
      change during the processing of the <code
      title="event-drop">drop</code> event, if one was fired.</p>

      <p>The event is not cancelable. After the event has been
      handled, the user agent must act as follows:</p>

      <dl class="switch">

       <dt>If the <span>current target element</span> is a text field
       (e.g. <code>textarea</code>, or an <code>input</code> element
       with <code title="">type="text"</code><!--XXX xref-->), and a
       <code title="event-drop">drop</code> event was fired in the
       previous step, and the <span>current drag operation</span> is
       "move", and the source of the drag-and-drop operation is a
       selection in the DOM</dt>

       <dd>The user agent should delete the range representing the
       dragged selection from the DOM.</dd>

       <dt>If the <span>current target element</span> is a text field
       (e.g. <code>textarea</code>, or an <code>input</code> element
       with <code title="">type="text"</code><!--XXX xref-->), and a
       <code title="event-drop">drop</code> event was fired in the
       previous step, and the <span>current drag operation</span> is
       "move", and the source of the drag-and-drop operation is a
       selection in a text field</dt>

       <dd>The user agent should delete the dragged selection from the
       relevant text field.</dd>

       <dt>Otherwise</dt>

       <dd>The event has no default action.</dd>

      </dl>

     </li>

    </ol>

   </li>

  </ol>


  <h5>When the drag-and-drop operation starts or ends in another
  document</h5>

  <p>The model described above is independent of which
  <code>Document</code> object the nodes involved are from; the events
  must be fired as described above and the rest of the processing
  model must be followed as described above, irrespective of how many
  documents are involved in the operation.</p>


  <h5>When the drag-and-drop operation starts or ends in another
  application</h5>

  <p>If the drag is initiated in another application, the <span>source
  node</span> is not a DOM node, and the user agent must use
  platform-specific conventions instead when the requirements above
  involve the source node. User agents in this situation must act as
  if the dragged data had been added to the <code>DataTransfer</code>
  object when the drag started, even though no <code
  title="event-dragstart">dragstart</code> event was actually fired;
  user agents must similarly use platform-specific conventions when
  deciding on what drag feedback to use.</p>

  <p>If a drag is started in a document but ends in another
  application, then the user agent must instead replace the parts of
  the processing model relating to handling the <em>target</em>
  according to platform-specific conventions.</p>

  <p>In any case, scripts running in the context of the document must
  not be able to distinguish the case of a drag-and-drop operation
  being started or ended in another application from the case of a
  drag-and-drop operation being started or ended in another document
  from another domain.</p>



  <h4>The <dfn title="attr-draggable"><code>draggable</code></dfn> attribute</h4>

  <p>All elements may have the <code
  title="attr-draggable">draggable</code> content attribute set. The
  <code title="attr-draggable">draggable</code> attribute is an
  <span>enumerated attribute</span>. It has three states. The first
  state is <em>true</em> and it has the keyword <code
  title="">true</code>. The second state is <em>false</em> and it has
  the keyword <code title="">false</code>. The third state is
  <em>auto</em>; it has no keywords but it is the <em>missing value
  default</em>.</p>

  <p>The <dfn title="dom-draggable"><code>draggable</code></dfn> DOM
  attribute, whose value depends on the content attribute's in the way
  described below, controls whether or not the element is
  draggable. Generally, only text selections are draggable, but
  elements whose <code title="dom-draggable">draggable</code> DOM
  attribute is true become draggable as well.</p>

  <p>If an element's <code title="attr-draggable">draggable</code>
  content attribute has the state <em>true</em>, the <code
  title="dom-draggable">draggable</code> DOM attribute must return
  true.</p>

  <p>Otherwise, if the element's <code
  title="attr-draggable">draggable</code> content attribute has the
  state <em>false</em>, the <code
  title="dom-draggable">draggable</code> DOM attribute must return
  false.</p>

  <p>Otherwise, the element's <code
  title="attr-draggable">draggable</code> content attribute has the
  state <em>auto</em>. If the element is an <code>img</code> element,
  or, if the element is an <code>a</code> element with an <code
  title="attr-hyperlink-href">href</code> content attribute, the <code
  title="dom-draggable">draggable</code> DOM attribute must return
  true.</p>

  <p>Otherwise, the <code title="dom-draggable">draggable</code> DOM
  must return false.</p>

  <p>If the <code title="dom-draggable">draggable</code> DOM attribute
  is set to the value false, the <code
  title="attr-draggable">draggable</code> content attribute must be
  set to the literal value <code title="">false</code>. If the <code
  title="dom-draggable">draggable</code> DOM attribute is set to the
  value true, the <code title="attr-draggable">draggable</code>
  content attribute must be set to the literal value <code
  title="">true</code>.</p>



  <h4>Copy and paste</h4>

  <p>Copy-and-paste is a form of drag-and-drop: the "copy" part is
  equivalent to dragging content to another application (the
  "clipboard"), and the "paste" part is equivalent to dragging content
  <em>from</em> another application.</p>

  <p>Select-and-paste (a model used by mouse operations in the X
  Window System) is equivalent to a drag-and-drop operation where the
  source is the selection.</p>


  <h5>Copy to clipboard</h5>

  <p>When the user invokes a copy operation, the user agent must act
  as if the user had invoked a drag on the current selection. If the
  drag-and-drop operation initiates, then the user agent must act as
  if the user had indicated (as the <span>immediate user
  selection</span>) a hypothetical application representing the
  clipbroad. Then, the user agent must act as if the user had ended
  the drag-and-drop operation without canceling it. If the
  drag-and-drop operation didn't get canceled, the user agent should
  then follow the relevant platform-specific conventions for copy
  operations (e.g. updating the clipboard).</p>


  <h5>Cut to clipboard</h5>

  <p>When the user invokes a cut operation, the user agent must act as
  if the user had invoked a copy operation (see the previous section),
  followed, if the copy was completed successfully, by <a
  href="#contenteditable-delete">a selection delete operation</a>.</p>


  <h5>Paste from clipboard</h5>

  <p>When the user invokes a clipboard paste operation, the user agent
  must act as if the user had invoked a drag on a hypothetical
  application representing the clipboard, setting the data associated
  with the drag as the text from the keyboard (either as <code
  title="">text/plain</code> or <code>text/uri-list</code>). If the
  contents of the clipboard cannot be represented as text or URIs,
  then the paste operation must not have any effect.</p>

  <p>Then, the user agent must act as if the user had indicated (as
  the <span>immediate user selection</span>) the element with the
  keyboard focus, and then ended the drag-and-drop operation without
  canceling it.</p>


  <h5>Paste from selection</h5>

  <p>When the user invokes a selection paste operation, the user agent
  must act as if the user had invoked a drag on the current selection,
  then indicated (as the <span>immediate user selection</span>) the
  element with the keyboard focus, and then ended the drag-and-drop
  operation without canceling it.</p>

  <p>If the contents of the selection cannot be represented as text or
  URIs, then the paste operation must not have any effect.</p>



  <h4>Security risks in the drag-and-drop model</h4>

  <p>User agents must not make the data added to the
  <code>DataTransfer</code> object during the <code
  title="event-dragstart">dragstart</code> event available to scripts
  until the <code title="event-drop">drop</code> event, because
  otherwise, if a user were to drag sensitive information from one
  document to a second document, crossing a hostile third document in
  the process, the hostile document could intercept the data.</p>

  <p>For the same reason, user agents must only consider a drop to be
  successful if the user specifically ended the drag operation &mdash;
  if any scripts end the drag operation, it must be considered
  unsuccessful (canceled) and the <code title="event-drop">drop</code>
  event must not be fired.</p>

  <p>User agents should take care to not start drag-and-drop
  operations in response to script actions. For example, in a
  mouse-and-window environment, if a script moves a window while the
  user has his mouse button depressed, the UA would not consider that
  to start a drag. This is important because otherwise UAs could cause
  data to be dragged from sensitive sources and dropped into hostile
  documents without the user's consent.</p>





  <h3 id="undo"><dfn>Undo history</dfn></h3>

  <p class="big-issue">There has got to be a better way of doing this, surely.</p>

  <p>The user agent must associate an <dfn>undo transaction
  history</dfn> with each <code>HTMLDocument</code> object.</p>

  <p>The <span>undo transaction history</span> is a list of
  entries. The entries are of two type: <span>DOM changes</span> and
  <span title="undo object">undo objects</span>.</p>

  <p>Each <dfn>DOM changes</dfn> entry in the <span>undo transaction
  history</span> consists of batches of one or more of the
  following:</p>

  <ul>

   <li>Changes to the <span>content attributes</span> of an
   <code>Element</code> node.</li>

   <li>Changes to the <span>DOM attributes</span> of a
   <code>Node</code>.</li> <!-- XXX uh, these change on their own, so
   clearly this isn't going to fly. Which DOM attributes, exactly? -->

   <li>Changes to the DOM hierarchy of nodes that are descendants of
   the <code>HTMLDocument</code> object (<code>parentNode</code>,
   <code>childNodes</code>).</li>

  </ul>

  <p><dfn>Undo object</dfn> entries consist of objects representing
  state that scripts running in the document are managing. For
  example, a Web mail application could use an <span>undo
  object</span> to keep track of the fact that a user has moved an
  e-mail to a particular folder, so that the user can undo the
  action and have the e-mail return to its former location.</p>

  <p>Broadly speaking, <span>DOM changes</span> entries are handled by
  the UA in response to user edits of form controls and <span>editing
  hosts</span> on the page, and <span>undo object</span> entries are
  handled by script in response to higher-level user actions (such as
  interactions with server-side state, or in the implementation of a
  drawing tool).</p>


  <h4>The <code>UndoManager</code> interface</h4>

  <div class="big-issue">

   <p>This API sucks. Seriously. It's a terrible API. Really bad. I
   hate it. Here are the requirements:</p>

   <ul>

    <li>Has to cope with cases where the server has undo state already
    when the page is loaded, that can be stuffed into the undo buffer
    onload.</li>

    <li>Has to support undo/redo.</li>

    <li>Has to cope with the "undo" action being "contact the server
    and tell it to undo", rather than it being the opposite of the
    "redo" action.</li>

    <li>Has to cope with some undo states expiring from the undo
    history (e.g. server can only remember one undelete action) but
    other states not expiring (e.g. client can undo arbitrary amounts
    of local edits).</li>

   </ul>

  </div>

  <p>To manage <span>undo object</span> entries in the <span>undo
  transaction history</span>, the <code>UndoManager</code>
  interface can be used:</p>

  <pre class="idl">interface <dfn>UndoManager</dfn> {
  unsigned long <span title="dom-UndoManager-add">add</span>(in DOMObject data, in DOMStrong title);
  void <span title="dom-UndoManager-remove">remove</span>(in unsigned long index);
  void <span title="dom-UndoManager-clearUndo">clearUndo</span>();
  void <span title="dom-UndoManager-clearRedo">clearRedo</span>();
  DOMObject <span title="dom-UndoManager-item">item</span>(in unsigned long index);
  readonly attribute unsigned long <span title="dom-UndoManager-length">length</span>;
  readonly attribute unsigned long <span title="dom-UndoManager-position">position</span>;
};</pre>

  <p>The <dfn title="dom-undoManager"><code>undoManager</code></dfn>
  attribute of the <code>WindowHTML</code> interface must return the
  object implementing the <code>UndoManager</code> interface for that
  <code>WindowHTML</code> object's associated
  <code>HTMLDocument</code> object.</p>

  <p>In the ECMAScript DOM binding, objects implementing this interface
  must also support being dereferenced using the square bracket
  notation, such that dereferencing with an integer index is
  equivalent to invoking the <code
  title="dom-UndoManager-item">item()</code> method with that index
  (e.g. <code title="">undoManager[1]</code> returns the same as <code
  title="">undoManager.item(1)</code>).</p>

  <p><code>UndoManager</code> objects represent their document's
  <span>undo transaction history</span>. Only <span>undo object</span>
  entries are visible with this API, but this does not mean that
  <span>DOM changes</span> entries are absent from the <span>undo
  transaction history</span>.</p>

  <p>The <dfn title="dom-UndoManager-length"><code>length</code></dfn>
  attribute must return the number of <span>undo object</span> entries
  in the <span>undo transaction history</span>.</p>

  <p>The <dfn title="dom-UndoManager-item"><code>item(<var
  title="">n</var>)</code></dfn> method must return the <var
  title="">n</var>th <span>undo object</span> entry in the <span>undo
  transaction history</span>.</p>

  <p>The <span>undo transaction history</span> has a <dfn title="undo
  position">current position</dfn>. This is the position between two
  entries in the <span>undo transaction history</span>'s list where
  the previous entry represents what needs to happen if the user
  invokes the "undo" command (the "undo" side, lower numbers), and the
  next entry represents what needs to happen if the user invokes the
  "redo" command (the "redo" side, higher numbers).</p>

  <p>The <dfn
  title="dom-UndoManager-position"><code>position</code></dfn>
  attribute must return the index of the <span>undo object</span>
  entry nearest to the <span>undo position</span>, on the "redo"
  side. If there are no <span>undo object</span> entries on the "redo"
  side, then the attribute must return the same as the <code
  title="dom-UndoManager-length">length</code> attribute. If there are
  no <span>undo object</span> entries on the "undo" side of the
  <span>undo position</span>, the <code
  title="dom-UndoManager-position">position</code> attribute returns
  zero.</p>

  <p class="note">Since the <span>undo transaction history</span>
  contains both <span>undo object</span> entries and <span>DOM
  changes</span> entries, but the <code
  title="dom-UndoManager-position">position</code> attribute only
  returns indices relative to <span>undo object</span> entries, it is
  possible for several "undo" or "redo" actions to be performed
  without the value of the <code
  title="dom-UndoManager-position">position</code> attribute
  changing.</p>

  <p>The <dfn title="dom-UndoManager-add"><code>add(<var title="">data</var>,
  <var title="">title</var>)</code></dfn> method's behaviour depends on the
  current state. Normally, it must insert the <var title="">data</var> object
  passed as an argument into the <span>undo transaction history</span>
  immediately before the <span>undo position</span>, optionally
  remembering the given <var title="">title</var> to use in the UI. If the
  method is called <span title="do-undo">during an undo
  operation</span>, however, the object must instead be added
  immediately <em>after</em> the <span>undo position</span>.</p>

  <p>If the method is called and there is neither <span
  title="do-undo">an undo operation in progress</span> nor <span
  title="do-redo">a redo operation in progress</span> then any entries
  in the <span>undo transaction history</span> after the <span>undo
  position</span> must be removed (as if <code
  title="dom-UndoManager-clearRedo">clearRedo()</code> had been
  called).</p>

  <p class="big-issue">We could fire events when someone adds
  something to the undo history -- one event per undo object entry
  before the position (or after, during redo addition), allowing the
  script to decide if that entry should remain or not. Or
  something. Would make it potentially easier to expire server-held
  state when the server limitations come into play.</p>

  <!-- XXX note on expiring undo in case server can only do one level undo -->

  <p>The <dfn title="dom-UndoManager-remove"><code>remove(<var
  title="">index</var>)</code></dfn> method must remove the <span>undo
  object</span> entry with the specified <var title="">index</var>. If
  the index is less than zero or greater than or equal to <code
  title="dom-UndoManager-length">length</code> then the method must
  raise an <code>INDEX_SIZE_ERR</code> exception. <span>DOM
  changes</span> entries are unaffected by this method.</p>

  <p>The <dfn
  title="dom-UndoManager-clearUndo"><code>clearUndo()</code></dfn>
  method must remove all entries in the <span>undo transaction
  history</span> before the <span>undo position</span>, be they
  <span>DOM changes</span> entries or <span>undo object</span>
  entries.</p>

  <p>The <dfn
  title="dom-UndoManager-clearRedo"><code>clearRedo()</code></dfn>
  method must remove all entries in the <span>undo transaction
  history</span> after the <span>undo position</span>, be they
  <span>DOM changes</span> entries or <span>undo object</span>
  entries.</p>

  <p class="big-issue">Another idea is to have a way for scripts to
  say "startBatchingDOMChangesForUndo()" and after that the changes to
  the DOM go in as if the user had done them.</p>


  <h4><dfn title="do-undo">Undo: moving back in the undo transaction history</dfn></h4>

  <p>When the user invokes an undo operation, or when the <code
  title="dom-document-execCommand">execCommand()</code> method is
  called with the <code title="command-undo">undo</code> command, the
  user agent must perform an undo operation.</p>

  <p>If the <span>undo position</span> is at the start of the
  <span>undo transaction history</span>, then the user agent must do
  nothing.</p>

  <p>If the entry immediately before the <span>undo position</span> is
  a <span>DOM changes</span> entry, then the user agent must remove
  that <span>DOM changes</span> entry, reverse the DOM changes that
  were listed in that entry, and, if the changes were reversed with no
  problems, add a new <span>DOM changes</span> entry (consisting of
  the opposite of those DOM changes) to the <span>undo transaction
  history</span> on the other side of the <span>undo
  position</span>.</p>

  <p>If the DOM changes cannot be undone (e.g. because the DOM state
  is no longer consistent with the changes represented in the entry),
  then the user agent must simply remove the <span>DOM changes</span>
  entry, without doing anything else.</p>

  <p>If the entry immediately before the <span>undo position</span> is
  an <span>undo object</span> entry, then the user agent must first
  remove that <span>undo object</span> entry from the <span>undo
  transaction history</span>, and then must fire an <code
  title="event-undo">undo</code> event on the <code>Document</code>
  object, using the <span>undo object</span> entry's associated undo
  object as the event's data.</p>

  <p>Any calls to <code title="dom-undoManager-add">add()</code> while
  the event is being handled will be used to populate the redo
  history, and will then be used if the user invokes the "redo"
  command to undo his undo.</p>


  <h4><dfn title="do-redo">Redo: moving forward in the undo transaction history</dfn></h4>

  <p>When the user invokes a redo operation, or when the <code
  title="dom-document-execCommand">execCommand()</code> method is
  called with the <code title="command-redo">redo</code> command, the
  user agent must perform a redo operation.</p>

  <p>This is mostly the opposite of an <span title="do-undo">undo
  operation</span>, but the full definition is included here for
  completeness.</p>

  <p>If the <span>undo position</span> is at the end of the <span>undo
  transaction history</span>, then the user agent must do nothing.</p>

  <p>If the entry immediately after the <span>undo position</span> is
  a <span>DOM changes</span> entry, then the user agent must remove
  that <span>DOM changes</span> entry, reverse the DOM changes that
  were listed in that entry, and, if the changes were reversed with no
  problems, add a new <span>DOM changes</span> entry (consisting of
  the opposite of those DOM changes) to the <span>undo transaction
  history</span> on the other side of the <span>undo
  position</span>.</p>

  <p>If the DOM changes cannot be redone (e.g. because the DOM state
  is no longer consistent with the changes represented in the entry),
  then the user agent must simply remove the <span>DOM changes</span>
  entry, without doing anything else.</p>

  <p>If the entry immediately after the <span>undo position</span> is
  an <span>undo object</span> entry, then the user agent must first
  remove that <span>undo object</span> entry from the <span>undo
  transaction history</span>, and then must fire a <code
  title="event-undo">redo</code> event on the <code>Document</code>
  object, using the <span>undo object</span> entry's associated undo
  object as the event's data.</p>

  <h4>The <code>UndoManagerEvent</code> interface and the <code title="event-undo">undo</code> and <code title="event-redo">redo</code> events</h4>

  <pre class="idl">interface <dfn>UndoManagerEvent</dfn> : Event {
  readonly attribute DOMObject <span title="dom-UndoManagerEvent-data">data</span>;
  void <span title="dom-UndoManagerEvent-initUndoManagerEvent">initUndoManagerEvent</span>(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMObject dataArg);
  void <span title="dom-UndoManagerEvent-initUndoManagerEventNS">initUndoManagerEventNS</span>(in DOMString namespaceURIArg, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMObject dataArg);
};</pre>

  <p>The <dfn
  title="dom-UndoManagerEvent-initUndoManagerEvent"><code>initUndoManagerEvent()</code></dfn>
  and <dfn><code
  title="dom-UndoManagerEvent-initUndoManagerEventNS">initUndoManagerEventNS()</code></dfn>
  methods must initialise the event in a manner analogous to the
  similarly-named methods in the DOM3 Events interfaces. <a
  href="#DOM3Events">[DOM3EVENTS]</a></p>

  <p>The <dfn title="dom-UndoManagerEvent-data"><code>data</code></dfn>
  attribute represents the <span>undo object</span> for the event.</p>

  <p>The <dfn title="event-undo"><code>undo</code></dfn> and <dfn
  title="event-redo"><code>redo</code></dfn> events do not bubble,
  cannot be canceled, and have no default action. When the user agent
  fires one of these events it must use the
  <code>UndoManagerEvent</code> interface, with the <code
  title="dom-UndoManagerEvent-data">data</code> field containing the
  relevant <span>undo object</span>.</p>


  <h4>Implementation notes</h4>

  <p>How user agents present the above conceptual model to the user is
  not defined. The undo interface could be a filtered view of the
  <span>undo transaction history</span>, it could manipulate the
  <span>undo transaction history</span> in ways not described above,
  and so forth. For example, it is possible to design a UA that
  appears to have separate <span title="undo transaction history">undo
  transaction histories</span> for each form control; similarly, it is
  possible to design systems where the user has access to more undo
  information than is present in the offical (as described above)
  <span>undo transaction history</span> (such as providing a
  tree-based approach to document state). Such UI models should be
  based upon the single <span>undo transaction history</span>
  described in this section, however, such that to a script there is
  no detectable difference.</p>


  <h3>Command APIs</h3>

  <p>The <dfn id="execCommand"
  title="dom-document-execCommand"><code>execCommand(<var
  title="">commandID</var>, <var title="">doShowUI</var>, <var
  title="">value</var>)</code></dfn> method on the
  <code>HTMLDocument</code> interface allows scripts to perform
  actions on the <span title="the selection">current selection</span>
  or at the current caret position. Generally, these commands would be
  used to implement editor UI, for example having a "delete" button on
  a toolbar.</p>

  <p>There are three variants to this method, with one, two, and three
  arguments respectively.  The <var title="">doShowUI</var> and <var
  title="">value</var> parameters, even if specified, are ignored
  unless otherwise stated.</p>

  <p class="note">In this specification, in fact, the <var
  title="">doShowUI</var> parameter is always ignored, regardless of
  its value. It is included for historical reasons only.</p>

  <p>When any of these methods are invoked, user agents must act as
  described in the list below.</p>

  <p>For actions marked "<dfn>editing hosts only</dfn>", if the
  selection is not entirely within an <span>editing host</span>, of if
  there is no selection and the caret is not inside an <span>editing
  host</span>, then the user agent must do nothing.</p>

  <dl>

   <dt>If the <var title="">commandID</var> is <dfn title="command-undo"><code>undo</code></dfn></dt>

   <dd>The user agent must <span title="do-undo">move back one
   step</span> in its <span>undo transaction history</span>, restoring
   the associated state. If there is no further undo information the
   user agent must do nothing. See the <span>undo history</span>.</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-redo"><code>redo</code></dfn></dt>

   <dd>The user agent must <span title="do-redo">move forward one
   step</span> in its <span>undo transaction history</span>, restoring
   the associated state. If there is no further undo (well, "redo")
   information the user agent must do nothing. See the <span>undo
   history</span>.</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-selectAll"><code>selectAll</code></dfn></dt>

   <dd>The user agent must change the selection so that all the
   content in the currently focused <span>editing host</span> is
   selected. If no <span>editing host</span> is focused, then the
   content of the entire document must be selected.</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-unselect"><code>unselect</code></dfn></dt>

   <dd><p>The user agent must change the selection so that nothing is
   selected.</p>

   <p class="big-issue">We need some sort of way in which the user can
   make a selection without risk of script clobbering it.</p></dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-superscript"><code>superscript</code></dfn></dt>

   <dd><em>Editing hosts only.</em> The user agent must act as if the
   user had requested that the selection <a
   href="#contenteditable-wrapSemantic">be wrapped in the
   semantics</a> of the <code>sup</code> element (or unwrapped, or, if
   there is no selection, have that semantic inserted or removed
   &mdash; the exact behaviour is UA-defined).</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-subscript"><code>subscript</code></dfn></dt>

   <dd><em>Editing hosts only.</em> The user agent must act as if the
   user had requested that the selection <a
   href="#contenteditable-wrapSemantic">be wrapped in the
   semantics</a> of the <em title=""><code>sub</code></em> element (or, again,
   unwrapped, or have that semantic inserted or removed, as defined by
   the UA).</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-formatBlock"><code>formatBlock</code></dfn></dt>

   <dd><p><em>Editing hosts only.</em> This command changes the
   semantics of the blocks containing the selection.</p>

   <p>If there is no selection, then, where in the description below
   refers to the selection, the user agent must act as if the
   selection was an empty range at the caret position.</p>

   <p>If the <var title="">value</var> parameter is not specified or
   has a value other than one of the following literal strings:</p>
   <ul class="brief">
    <li><code title="">&lt;address&gt;</code></li>
    <li><code title="">&lt;aside&gt;</code></li>
    <li><code title="">&lt;h1&gt;</code></li>
    <li><code title="">&lt;h2&gt;</code></li>
    <li><code title="">&lt;h3&gt;</code></li>
    <li><code title="">&lt;h4&gt;</code></li>
    <li><code title="">&lt;h5&gt;</code></li>
    <li><code title="">&lt;h6&gt;</code></li>
    <li><code title="">&lt;nav&gt;</code></li>
    <li><code title="">&lt;p&gt;</code></li>
    <li><code title="">&lt;pre&gt;</code></li>
   </ul>
   <p>...then the user agent must do nothing.</p>

   <p>Otherwise, the user agent must, for every position in the
   selection, take the furthest <span title="block-level
   elements">block-level element</span> ancestor of that position that
   contains only <span>inline-level content</span> and is not being
   used as a <span title="structured inline-level elements">structured
   inline-level element</span>, and, if that element is a descendant
   of the editing host, rename it according to the <var
   title="">value</var>, by stripping the leading <code>&lt;</code>
   character and the trailing <code>&gt;</code> character and using
   the rest as the new tag name.</p></dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-delete"><code>delete</code></dfn></dt>

   <dd><em>Editing hosts only.</em> The user agent must act as if the
   user had performed <a href="#contenteditable-delete">a backspace
   operation</a>.</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-forwardDelete"><code>forwardDelete</code></dfn></dt>

   <dd><em>Editing hosts only.</em> The user agent must act as if the
   user had performed <a href="#contenteditable-delete">a forward
   delete operation</a>.</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-insertLineBreak"><code>insertLineBreak</code></dfn></dt>

   <dd><em>Editing hosts only.</em> The user agent must act as if the
   user had <a href="#contenteditable-br">requested a line
   separator</a>.</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-insertParagraph"><code>insertParagraph</code></dfn></dt>

   <dd><em>Editing hosts only.</em> The user agent must act as if the
   user had performed a <a href="#contenteditable-breakBlock">break
   block</a> editing action.</dd>

   <dt>If the <var title="">commandID</var> is <dfn title="command-insertText"><code>insertText</code></dfn></dt>

   <dd><em>Editing hosts only.</em> The user agent must act as if the
   user had <a href="#contenteditable-insertText">inserted text</a>
   corresponding to the <var title="">value</var> parameter.</dd>

   <dt>If the <var title="">commandID</var> is <code><var title="">vendorID</var>-<var title="">customCommandID</var></code></dt>

   <dd>User agents may implement vendor-specific extensions to this
   API. Vendor-specific extensions to the list of commands should use
   the syntax <code><var title="">vendorID</var>-<var
   title="">customCommandID</var></code> so as to prevent clashes
   between extensions from different vendors and future additions to
   this specification.</dd>

   <dt>If the <var title="">commandID</var> is something else</dt>

   <dd>User agents must do nothing.</dd>

  </dl>


  <h3 id="selection">The text selection APIs</h3>

  <p>Every <span>browsing context</span> has <dfn title="the
  selection">a selection</dfn>. The selection may be empty, and the
  selection may have more than one range (a disjointed selection). The
  user should be able to change the selection. User agents are not
  required to let the user select more than one range, and may
  collapse multiple ranges in the selection to a single range when the
  user interacts with the selection. (But, of course, the user agent
  may let the user create selections with multiple ranges.)</p>

  <p>This one selection must be shared by all the content of the
  browsing context (though not by nested <span title="browsing
  context">browsing contexts</span>), including any editing hosts in
  the document. (Editing hosts that are not inside a document cannot
  have a selection.)</p>

  <p>If the selection is empty (collapsed, so that it has only one
  segment and that segment's start and end points are the same) then
  the selection's position should equal the caret position. When the
  selection is not empty, this specification does not define the caret
  position; user agents should follow platform conventions in deciding
  whether the caret is at the start of the selection, the end of the
  selection, or somewhere else.</p>

  <p>On some platforms (such as those using Wordstar editing
  conventions), the caret position is totally independent of the start
  and end of the selection, even when the selection is empty. On such
  platforms, user agents may ignore the requirement that the cursor
  position be linked to the position of the selection altogether.</p>

  <p>Mostly for historical reasons, in addition to the <span>browsing
  context</span>'s <span title="the selection">selection</span>, each
  <code>textarea</code> and <code>input</code> element has an
  independent selection. These are the <dfn title="text field
  selection">text field selections</dfn>.</p>

  <p>The <code>datagrid</code> and <code>select</code> elements also
  have selections, indicating which items have been picked by the
  user. These are not discussed in this section.</p>

  <p class="note">This specification does not specify how selections
  are presented to the user. The Selectors specification, in
  conjunction with CSS, can be used to style text selections using the
  <code>::selection</code> pseudo-element. <a
  href="#refsSELECTORS">[SELECTORS]</a> <a
  href="#refsCSS21">[CSS21]</a></p>



  <h4 id="documentSelection">APIs for the browsing context selection</h4>

  <p>The <dfn
  title="dom-getSelection"><code>getSelection()</code></dfn> method on
  the <code>WindowHTML</code> interface must return the
  <code>Selection</code> object representing <span>the
  selection</span> of that <code>WindowHTML</code> object's
  <span>browsing context</span>.

  <p>For historical reasons, the <dfn
  title="dom-document-getSelection"><code>getSelection()</code></dfn>
  method on the <code>HTMLDocument</code> interface must return the
  same <code>Selection</code> object.</p>
                                   
  <pre class="idl">interface <dfn>Selection</dfn> {
  readonly attribute Node <span title="dom-selection-anchorNode">anchorNode</span>;
  readonly attribute long <span title="dom-selection-anchorOffset">anchorOffset</span>;
  readonly attribute Node <span title="dom-selection-focusNode">focusNode</span>;
  readonly attribute long <span title="dom-selection-focusOffset">focusOffset</span>;
  readonly attribute boolean <span title="dom-selection-isCollapsed">isCollapsed</span>;
  void <span title="dom-selection-collapse">collapse</span>(in Node parentNode, in long offset);
  void <span title="dom-selection-collapseToStart">collapseToStart</span>();
  void <span title="dom-selection-collapseToEnd">collapseToEnd</span>();
  void <span title="dom-selection-selectAllChildren">selectAllChildren</span>(in Node parentNode);
  void <span title="dom-selection-deleteFromDocument">deleteFromDocument</span>();
  readonly attribute long <span title="dom-selection-rangeCount">rangeCount</span>;
  Range <span title="dom-selection-getRangeAt">getRangeAt</span>(in long index);
  void <span title="dom-selection-addRange">addRange</span>(in Range range);
  void <span title="dom-selection-removeRange">removeRange</span>(in Range range);
  void <span title="dom-selection-removeAllRanges">removeAllRanges</span>();
  DOMString <span title="dom-selection-toString">toString</span>();
};</pre>
<!--
  See also:
    http://lxr.mozilla.org/mozilla/source/content/base/public/nsISelection.idl
  This spec doesn't have everything from there yet, in particular
  selectionLanguageChange() and containsNode() are missing. They are missing
  because I couldn't work out how to define them in terms of Ranges.

  I also haven't included extend():

    void <span title="dom-selection-extend">extend</span>(in Node parentNode, in long offset);
    // raise if no range
    // raise WRONG_DOCUMENT_ERR if parentNode not in document
    // do something

  ...mostly because I can't work out how to describe what it does quickly.
-->

  <p>The <code>Selection</code> interface is represents a list of
  <code>Range</code> objects. The first item in the list has index 0,
  and the last item has index <var title="">count</var>-1, where
  <var title="">count</var> is the number of ranges in the list. <a
  href="#refsDOM2RANGE">[DOM2RANGE]</a></p>

  <p>All of the members of the <code>Selection</code> interface are
  defined in terms of operations on the <code>Range</code> objects
  represented by this object. These operations can raise exceptions,
  as defined for the <code>Range</code> interface; this can therefore
  result in the members of the <code>Selection</code> interface
  raising exceptions as well, in addition to any explicitly called out
  below.</p> <!--- XXX example -->

  <p>The <dfn
  title="dom-selection-anchorNode"><code>anchorNode</code></dfn>
  attribute must return the value returned by the <code
  title="">startContainer</code> attribute of the last
  <code>Range</code> object in the list, or null if the list is
  empty.</p>

  <p>The <dfn
  title="dom-selection-anchorOffset"><code>anchorOffset</code></dfn>
  attribute must return the value returned by the <code
  title="">startOffset</code> attribute of the last <code>Range</code>
  object in the list, or 0 if the list is empty.</p>

  <p>The <dfn
  title="dom-selection-focusNode"><code>focusNode</code></dfn>
  attribute must return the value returned by the <code
  title="">endContainer</code> attribute of the last
  <code>Range</code> object in the list, or null if the list is
  empty.</p>

  <p>The <dfn
  title="dom-selection-focusOffset"><code>focusOffset</code></dfn>
  attribute must return the value returned by the <code
  title="">endOffset</code> attribute of the last <code>Range</code>
  object in the list, or 0 if the list is empty.</p>

  <p>The <dfn
  title="dom-selection-isCollapsed"><code>isCollapsed</code></dfn>
  attribute must return true if there are zero ranges, or if there is
  exactly one range and its <code title="">collapsed</code> attribute
  is itself true. Otherwise it must return false.</p>

  <p>The <dfn
  title="dom-selection-collapse"><code>collapse(<var title="">parentNode</var>,
  <var title="">offset</var>)</code></dfn> method must raise a
  <code>WRONG_DOCUMENT_ERR</code> DOM exception if
  <var title="">parentNode</var>'s <code title="">ownerDocument</code> is not
  the <code>HTMLDocument</code> object with which the
  <code>Selection</code> object is associated. Otherwise it is, and
  the method must remove all the ranges in the <code>Selection</code>
  list, then create a new <code>Range</code> object, add it to the
  list, and invoke its <code title="">setStart()</code> and <code
  title="">setEnd()</code> methods with the <var title="">parentNode</var> and
  <var title="">offset</var> values as their arguments.</p>

  <p>The <dfn
  title="dom-selection-collapseToStart"><code>collapseToStart()</code></dfn>
  method must raise an <code>INVALID_STATE_ERR</code> DOM exception if
  there are no ranges in the list. Otherwise, it must invoke the <code
  title="dom-selection-collapse">collapse()</code> method with the
  <code title="">startContainer</code> and <code
  title="">startOffset</code> values of the first <code>Range</code>
  object in the list as the arguments.</p>

  <p>The <dfn
  title="dom-selection-collapseToEnd"><code>collapseToEnd()</code></dfn>
  method must raise an <code>INVALID_STATE_ERR</code> DOM exception if
  there are no ranges in the list. Otherwise, it must invoke the <code
  title="dom-selection-collapse">collapse()</code> method with the
  <code title="">endContainer</code> and <code
  title="">endOffset</code> values of the last <code>Range</code>
  object in the list as the arguments.</p>

  <p>The <dfn
  title="dom-selection-selectAllChildren"><code>selectAllChildren(<var title="">parentNode</var>)</code></dfn>
  method must invoke the <code
  title="dom-selection-collapse">collapse()</code> method with the
  <var title="">parentNode</var> value as the first argument and 0 as the
  second argument, and must then invoke the <code
  title="">selectNodeContents()</code> method on the first (and only)
  range in the list with the <var title="">parentNode</var> value as the
  argument.</p>

  <p>The <dfn
  title="dom-selection-deleteFromDocument"><code>deleteFromDocument()</code></dfn>
  method must invoke the <code title="">deleteContents()</code> method
  on each range in the list, if any, from first to last.</p>

  <p>The <dfn
  title="dom-selection-rangeCount"><code>rangeCount</code></dfn>
  attribute must return the number of ranges in the list.</p>

  <p>The <dfn
  title="dom-selection-getRangeAt"><code>getRangeAt(<var title="">index</var>)</code></dfn>
  method must return the <var title="">index</var>th range in the list. If
  <var title="">index</var> is less than zero or greater or equal to the value
  returned by the <code
  title="dom-selection-rangeCount">rangeCount</code> attribute, then
  the method must raise an <code>INDEX_SIZE_ERR</code> DOM
  exception.</p>

  <p>The <dfn
  title="dom-selection-addRange"><code>addRange(<var title="">range</var>)</code></dfn>
  method must add the given <var title="">range</var> Range object to the list
  of selections, at the end (so the newly added range is the new last
  range). Duplicates are not prevented; a range may be added more than
  once in which case it appears in the list more than once, which (for
  example) will cause <code
  title="dom-selection-toString">toString()</code> to return the
  range's text twice.</p> <!-- XXX how does this interact with
  deleteFromDocument() which acts on all ranges? -->

  <p>The <dfn
  title="dom-selection-removeRange"><code>removeRange(<var title="">range</var>)</code></dfn>
  method must remove the first occurrence of <var title="">range</var> in the
  list of ranges, if it appears at all.</p>

  <p>The <dfn
  title="dom-selection-removeAllRanges"><code>removeAllRanges()</code></dfn>
  method must remove all the ranges from the list of ranges, such that
  the <code title="dom-selection-rangeCount">rangeCount</code>
  attribute returns 0 after the <code
  title="dom-selection-removeAllRanges">removeAllRanges()</code>
  method is invoked (and until a new range is added to the list,
  either through this interface or via user interaction).</p>

  <p>The <dfn
  title="dom-selection-toString"><code>toString()</code></dfn> method
  must return a concatenation of the results of invoking the <code
  title="">toString()</code> method of the <code>Range</code> object
  on each of the ranges of the selection, in the order they appear in
  the list (first to last).</p>

  <p>In language bindings where this is supported, objects
  implementing the <code>Selection</code> interface must stringify to
  the value returned by the object's <code
  title="dom-selection-toString">toString()</code> method.</p>

  <div class="example">
   <p>In the following document fragment, the emphasised parts
   indicate the selection.</p>
   <pre>&lt;p>The cute girl likes <em>the </em>&lt;cite><em>Oxford English</em> Dictionary&lt;/cite>.&lt;/p></pre>
   <p>If a script invoked <code
   title="">window.getSelection().toString()</code>, the return value
   would be "<code>the Oxford English</code>".</p>
  </div>

  <p class="note">The <code>Selection</code> interface has no relation
  to the <code>DataGridSelection</code> interface.</p>


  <h4 id="textFieldSelection">APIs for the text field selections</h4>

  <p class="big-issue">When we define HTMLTextAreaElement and
  HTMLInputElement we will have to add the IDL given below to both of
  their IDLs.</p>

  <p>The <code>input</code> and <code>textarea</code> elements define
  four members in their DOM interfaces for handling their text
  selection:</p>

  <pre class="idl">  void <span title="dom-textarea/input-select">select</span>();
           attribute unsigned long <span title="dom-textarea/input-selectionStart">selectionStart</span>;
           attribute unsigned long <span title="dom-textarea/input-selectionEnd">selectionEnd</span>;
  void <span title="dom-textarea/input-setSelectionRange">setSelectionRange</span>(in unsigned long start, in unsigned long end);</pre>
<!-- XXX also add textLength? it seems to be widely used -->

  <p>These methods and attributes expose and control the selection of
  <code>input</code> and <code>textarea</code> text fields.</p>

  <p>The <dfn
  title="dom-textarea/input-select"><code>select()</code></dfn> method
  must cause the contents of the text field to be fully selected.</p>

  <p>The <dfn
  title="dom-textarea/input-selectionStart"><code>selectionStart</code></dfn>
  attribute must, on getting, return the offset (in logical order) to
  the character that immediately follows the start of the
  selection. If there is no selection, then it must return the offset
  (in logical order) to the character that immediately follows the
  text entry cursor.</p>

  <p>On setting, it must act as if the <code
  title="dom-textarea/input-setSelectionRange">setSelectionRange()</code>
  method had been called, with the new value as the first argument,
  and the current value of the <code
  title="dom-textarea/input-selectionEnd">selectionEnd</code>
  attribute as the second argument, unless the current value of the
  <code title="dom-textarea/input-selectionEnd">selectionEnd</code> is
  less than the new value, in which case the second argument must also
  be the new value.</p>

  <p>The <dfn
  title="dom-textarea/input-selectionEnd"><code>selectionEnd</code></dfn>
  attribute must, on getting, return the offset (in logical order) to
  the character that immediately follows the end of the selection. If
  there is no selection, then it must return the offset (in logical
  order) to the character that immediately follows the text entry
  cursor.</p>

  <p>On setting, it must act as if the <code
  title="dom-textarea/input-setSelectionRange">setSelectionRange()</code>
  method had been called, with the current value of the <code
  title="dom-textarea/input-selectionStart">selectionStart</code>
  attribute as the first argument, and new value as the second
  argument.</p>

  <p>The <dfn
  title="dom-textarea/input-setSelectionRange"><code>setSelectionRange(<var
  title="">start</var>, <var title="">end</var>)</code></dfn> method
  must set the selection of the text field to the sequence of
  characters starting with the character at the <var
  title="">start</var>th position (in logical order) and ending with
  the character at the <span>(<var title="">end</var>-1)</span>th
  position. Arguments greater than the length of the value in the text
  field must be treated as pointing at the end of the text field. If
  <var title="">end</var> is less than or equal to <var
  title="">start</var> then the start of the selection and the end of
  the selection must both be placed immediately before the character
  with offset <var title="">end</var>. In UAs where there is no
  concept of an empty selection, this must set the cursor to be just
  before the character with offset <var title="">end</var>.</p>

  <div class="example">

   <p>To obtain the currently selected text, the following JavaScript
   suffices:</p>

   <pre>var selectionText = control.value.substring(control.selectionStart, control.selectionEnd);</pre>

   <p>...where <var title="">control</var> is the <code>input</code>
   or <code>textarea</code> element.</p>

  </div>

  <p>Characters with no visible rendering, such as U+200D ZERO WIDTH
  JOINER, still count as characters. Thus, for instance, the selection
  can include just an invisible character, and the text insertion
  cursor can be placed to one side or another of such a character.</p>

  <p>When these methods and attributes are used with
  <code>input</code> elements that are not displaying simple text
  fields, they must raise an <code>INVALID_STATE_ERR</code>
  exception.</p>



  <h2 id="comms">Communication</h2>


  <h3>Event definitions</h3>

  <p>Messages in <span>cross-document messaging</span> and, by
  default, in <span>server-sent DOM events</span>, use the <dfn
  title="event-message"><code>message</code></dfn> event.</p>

  <p>The following interface is defined for this event:</p>

  <pre class="idl">interface <dfn>MessageEvent</dfn> : Event {
  readonly attribute DOMString <span title="dom-MessageEvent-data">data</span>;
  readonly attribute DOMString <span title="dom-MessageEvent-domain">domain</span>;
  readonly attribute DOMString <span title="dom-MessageEvent-uri">uri</span>;
  readonly attribute Document <span title="dom-MessageEvent-source">source</span>;
  void <span title="dom-MessageEvent-initMessageEvent">initMessageEvent</span>(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg, in DOMString domainArg, in DOMString uriArg, in Document documentArg);
  void <span title="dom-MessageEvent-initMessageEventNS">initMessageEventNS</span>(in DOMString namespaceURI, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg, in DOMString domainArg, in DOMString uriArg, in Document documentArg);
};</pre>

  <p>The <dfn
  title="dom-MessageEvent-initMessageEvent"><code>initMessageEvent()</code></dfn>
  and <dfn
  title="dom-MessageEvent-initMessageEventNS"><code>initMessageEventNS()</code></dfn>
  methods must initialise the event in a manner analogous to the
  similarly-named methods in the DOM3 Events interfaces. <a
  href="#DOM3Events">[DOM3EVENTS]</a></p>

  <p>The <dfn
  title="dom-MessageEvent-data"><code>data</code></dfn>
  attribute represents the message being sent.</p>

  <p>The <dfn
  title="dom-MessageEvent-domain"><code>domain</code></dfn> attribute
  represents, in <span>cross-document messaging</span>, the domain of
  the document from which the message came.</p>

  <p>The <dfn title="dom-MessageEvent-uri"><code>uri</code></dfn>
  attribute represents, in <span>cross-document messaging</span>, the
  address of the document from which the message came.</p>

  <p>The <dfn
  title="dom-MessageEvent-source"><code>source</code></dfn> attribute
  represents, in <span>cross-document messaging</span>, the
  <code>Document</code> from which the message came.</p>


  <h3 id="server-sent-events"><dfn>Server-sent DOM events</dfn></h3>
  <!-- event-source -->

  <p>This section describes a mechanism for allowing servers to
  dispatch DOM events into documents that expect it. The
  <code>event-source</code> element provides a simple interface to
  this mechanism.</p>



  <h4>The <dfn><code>RemoteEventTarget</code></dfn> interface</h4>

  <p>Any object that implements the <code>EventTarget</code> interface
  must also implement the <code>RemoteEventTarget</code> interface.</p>

  <pre class="idl">interface <dfn>RemoteEventTarget</dfn> {
  void <span title="dom-RemoteEventTarget-addEventSource">addEventSource</span>(in DOMString src);
  void <span title="dom-RemoteEventTarget-removeEventSource">removeEventSource</span>(in DOMString src);
};</pre>

  <p>When the <dfn
  title="dom-RemoteEventTarget-addEventSource"><code>addEventSource(<var
  title="">src</var>)</code></dfn> method is invoked, the user agent
  must add the URI specified in <var title="">src</var> to the <span
  title="concept-event-source-list">list of event sources</span> for
  that object. The same URI can be registered multiple times.</p>

  <p>When the <dfn
  title="dom-RemoteEventTarget-removeEventSource"><code>removeEventSource(<var
  title="">src</var>)</code></dfn> method is invoked, the user agent
  must remove the URI specified in <var title="">src</var> from the
  <span title="concept-event-source-list">list of event sources</span>
  for that object.  If the same URI has been registered multiple
  times, removing it must only remove one instance of that URI for
  each invokation of the <code
  title="removeEventSource"removeEventSource()</code> method.</p>

  <p>Relative URIs must be resolved relative to <span
  class="big-issue">...</span>.</p>


  <h4>Connecting to an event stream</h4>

  <p>Each object implementing the <code>EventTarget</code> and
  <code>RemoteEventTarget</code> interfaces has a <dfn
  title="concept-event-source-list">list of event sources</dfn> that
  are registered for that object.</p>

  <p>When a new URI is added to this list, the user agent should, as
  soon as all currently executing scripts (if any) have finished
  executing, and if the specified URI isn't removed from the list
  before they do so, fetch the resource identified by that URI.</p>

  <p>When an event source is removed from the list of event sources
  for an object, if that resource is still being fetched, then the
  relevant connection must be closed.</p>

  <p>Since connections established to remote servers for such
  resources are expected to be long-lived, UAs should ensure that
  appropriate buffering is used. In particular, while line buffering
  may be safe if lines are defined to end with a single U+000A LINE
  FEED character, block buffering or line buffering with different
  expected line endings can cause delays in event dispatch.</p>

  <p>In general, the semantics of the transport protocol specified by
  the URIs for the event sources must be followed, including HTTP
  caching rules.</p>

  <p>For HTTP connections, the <code title="">Accept</code> header may
  be included; if included, it must only contain formats of event
  framing that are supported by the user agent (one of which must be
  <code>application/x-dom-event-stream</code>, as described
  below).</p>

  <p>Other formats of event framing may also be supported in addition
  to <code>application/x-dom-event-stream</code>, but this
  specification does not define how they are to be parsed or
  processed.</p>

  <p class="note">Such formats could include systems like SMS-push;
  for example servers could use <code title="">Accept</code> headers
  and HTTP redirects to an SMS-push mechanism as a kind of protocol
  negotiation to reduce network load in GSM environments.</p>

  <p>User agents should use the <code>Cache-Control: no-cache</code>
  header in requests to bypass any caches for requests of event
  sources.</p>

  <p>For connections to domains other than the <span>document's
  domain</span>, the semantics of the Access-Control HTTP header must
  be followed. <a href="#refsACCESSCONTROL">[ACCESSCONTROL]</a>

  <p>HTTP 200 OK responses with a <code>Content-Type</code> header
  specifying the type <code>application/x-dom-event-stream</code> that
  are either from the <span>document's domain</span> or explicitly
  allowed by the Access-Control HTTP headers must be processed line by
  line <a href="#event-stream-interpretation">as described
  below</a>.</p>

  <p>For the purposes of such successfully opened event streams only,
  user agents should ignore HTTP cache headers, and instead assume
  that the resource indicates that it does not wish to be cached.</p>

  <p>If such a resource completes loading (i.e. the entire HTTP
  response body is received or the connection itself closes), the user
  agent should request the event source resource again after a delay
  of approximately five seconds.</p>

  <p>HTTP 200 OK responses that have a Content-Type other than
  <code>application/x-dom-event-stream</code> (or some other supported
  type), and HTTP responses whose Access-Control headers indicate that
  the resource are not to be used, must be ignored and must prevent
  the user agent from refetching the resource for that event
  source.</p>

  <p>HTTP 201 Created, 202 Accepted, 203 Non-Authoritative
  Information, and 206 Partial Content responses must be treated like
  HTTP 200 OK responses for the purposes of reopening event source
  resources. They are, however, likely to indicate an error has
  occurred somewhere and may cause the user agent to emit a
  warning.</p>

  <p>HTTP 204 No Content, and 205 Reset Content responses must be
  treated as if they were 200 OK responses with the right MIME type
  but no content, and should therefore cause the user agent to refetch
  the resource after a short delay.</p>

  <p>HTTP 300 Multiple Choices responses should be handled
  automatically if possible (treating the responses as if they were
  302 Found responses pointing to the appropriate resource), and
  otherwise must be treated as HTTP 404 responses.</p>

  <p>HTTP 301 Moved Permanently responses must cause the user agent to
  reconnect using the new server specified URI instead of the
  previously specified URI for all subsequent requests for this event
  source. (It doesn't affect other event sources with the same URI
  unless they also receive 301 responses, and it doesn't affect future
  sessions, e.g. if the page is reloaded.)</p>

  <p>HTTP 302 Found, 303 See Other, and 307 Temporary Redirect
  responses must cause the user agent to connect to the new
  server-specified URI, but if the user agent needs to again request
  the resource at a later point, it must return to the previously
  specified URI for this event source.</p>

  <p>HTTP 304 Not Modified responses should be handled like HTTP 200
  OK responses, with the content coming from the user agent cache. A
  new request should then be made after a short delay of approximately
  five seconds.</p>

  <p>HTTP 305 Use Proxy, HTTP 401 Unauthorized, and 407 Proxy
  Authentication Required should be treated transparently as for any
  other subresource.</p>

  <p>Any other HTTP response code not listed here should cause the
  user agent to stop trying to process this event source.</p> <!--
  including: HTTP 400 Bad Request, 403 Forbidden, 404 Not Found, 405
  Method Not Allowed, 406 Not Acceptable, 408 Request Timeout, 409
  Conflict, 410 Gone, 411 Length Required, 412 Precondition Failed,
  413 Request Entity Too Large, 414 Request-URI Too Long, 415
  Unsupported Media Type, 416 Requested Range Not Satisfiable, 417
  Expectation Failed, 500 Internal Server Error, 501 Not Implemented,
  502 Bad Gateway, 503 Service Unavailable, 504 Gateway Timeout, and
  505 HTTP Version Not Supported responses -->

  <p>DNS errors must be considered fatal, and cause the user agent to
  not open any connection for that event source.</p>

  <p>For non-HTTP protocols, UAs should act in equivalent ways.</p>


  <h4>Parsing an event stream</h4>

  <p>This event stream format's MIME type is
  <code>application/x-dom-event-stream</code>.</p>

  <p>The event stream format is (in pseudo-BNF):</p>

  <pre>&lt;stream&gt;          ::= &lt;bom&gt;? &lt;event&gt;*
&lt;event&gt;           ::= [ &lt;comment&gt; | &lt;command&gt; | &lt;field&gt; ]* &lt;newline&gt;
&lt;comment&gt;         ::= ';' &lt;any-char&gt;* &lt;newline&gt;
&lt;command&gt;         ::= ':' &lt;any-char&gt;* &lt;newline&gt;
&lt;field&gt;           ::= &lt;name&gt; [ ':' &lt;space&gt;? &lt;any-char&gt;* ]? &lt;newline&gt;
&lt;name&gt;            ::= &lt;name-start-char&gt; &lt;name-char&gt;*

# characters:
&lt;bom&gt;             ::= a single U+FEFF BYTE ORDER MARK character
&lt;space&gt;           ::= a single U+0020 SPACE character (' ')
&lt;newline&gt;         ::= a U+000D CARRIAGE RETURN character
                      followed by a U+000A LINE FEED character
                      | a single U+000D CARRIAGE RETURN character
                      | a single U+000A LINE FEED character
                      | the end of the file
&lt;name-start-char&gt; ::= a single Unicode character other than
                      ':', ';', U+000D CARRIAGE RETURN and U+000A LINE FEED
&lt;name-char&gt;       ::= a single Unicode character other than
                      ':', U+000D CARRIAGE RETURN and U+000A LINE FEED
&lt;any-char&gt;        ::= a single Unicode character other than
                      U+000D CARRIAGE RETURN and U+000A LINE FEED
</pre>

  <p>Event streams in this format must always be encoded as
  UTF-8. Lines must be separated by either a U+000D CARRIAGE RETURN
  U+000A LINE FEED (CRLF) character pair, a single U+000A LINE FEED
  (LF) character, or a single U+000D CARRIAGE RETURN (CR)
  character. User agents must treat those three variants as equivalent
  line terminators.</p>

  <p>Bytes that are not valid UTF-8 sequences must be interpreted as
  the U+FFFD REPLACEMENT CHARACTER.</p>

  <p>A leading U+FEFF BYTE ORDER MARK character must be ignored if
  present.</p>

  <p>The stream must then be parsed by reading everything line by
  line, in blocks separated by blank lines. Comment lines (those
  starting with the character ';') and command lines (those starting
  with the character ':') must be ignored.</p>

  <p>Command lines are reserved for future extensions.</p>

  <!--XXX Lachlan says:
    For the next version of server sent events, it might be useful if
    authors could specify the retry interval for connections.

    e.g. In cases where it is known that content is only updated at
    specified intervals (e.g. once per minute), having the browser retry
    the connection every 5 seconds and fire the event with the same
    content may be excessive.

    This could possibly be done using the :command syntax.

    e.g.
      Event: click
      :retry 60000

    The browser would then retry the connection in 60,000 milliseconds (1
    minute).
  -->

  <p>For each non-blank, non-comment, non-command line, the field name
  must first be taken. This is everything on the line up to but not
  including the first colon (':') or the line terminator, whichever
  comes first. Then, if there was a colon, the data for that line must
  be taken. This is everything after the colon, ignoring a single
  space after the colon if there is one, up to the end of the line. If
  there was no colon the data is the empty string.</p>

  <div class="example">
   <p>Examples:</p>
   <pre>Field name:&nbsp;Field data</pre>
   <pre>This is a blank field</pre>
   <pre>1. These two lines:&nbsp;have the same data
2. These two lines:have the same data</pre>
   <pre>1. But these two lines:&nbsp; do not
2. But these two lines:&nbsp;do not</pre>
  </div>

  <p>If a field name occurs multiple times in a block, the value for
  that field in that black must consist of the data parts for each of
  those lines, concatenated with U+000A LINE FEED characters between
  them (regardless of what the line terminators used in the stream
  actually are).</p>

  <div class="example">
   <p>For example, the following block:</p>
   <pre>Test:&nbsp;Line 1
Foo:&nbsp;&nbsp;Bar
Test:&nbsp;Line 2</pre>
   <p>...is treated as having two fields, one called <code>Test</code>
   with the value "<code>Line 1\nLine 2</code>" (where <code>\n</code>
   represents a newline), and one called <code>Foo</code> with the
   value "<code>&nbsp;Bar</code>" (note the leading space
   character).</p>
  </div>

  <p>A block thus consists of all the name-value pairs for its
  fields. Command lines have no effect on blocks and are not
  considered part of a block.</p>

  <p class="note">Since any random stream of characters matches the above
  format, there is no need to define any error handling.</p>


  <h4 id="event-stream-interpretation">Interpreting an event stream</h4>

  <p>Once the fields have been parsed, they are interpreted as follows
  (these are case-sensitive exact comparisons):</p>

  <dl>

   <dt><code title="">Event</code> field</dt>

   <dd><p>This field gives the name of the event. For example, <code
   title="">load</code>, <code title="">DOMActivate</code>, <code
   title="">updateTicker</code>. If there is no field with this name,
   the name <code title="event-message">message</code> must be
   used.</p></dd>


   <dt><code title="">Namespace</code> field</dt>

   <dd><p>This field gives the DOM3 namespace for the event. (For
   normal DOM events this would be null.) If it isn't specified the
   event namespace is null.</p></dd>


   <dt><code title="">Class</code> field</dt>

   <dd>

    <p>This field gives is the interface used for the event, for
    instance <code>Event</code>, <code>UIEvent</code>,
    <code>MutationEvent</code>, <code>KeyboardEvent</code>, etc. For
    compatibility with DOM3 Events, the values <code
    title="">UIEvents</code>, <code title="">MouseEvents</code>, <code
    title="">MutationEvents</code>, and <code
    title="">HTMLEvents</code> are valid values and must be treated
    respectively as meaning the interfaces <code>UIEvent</code>,
    <code>MouseEvent</code>, <code>MutationEvent</code>, and
    <code>Event</code>. (This value can therefore be used as the
    argument to <code title="">createEvent()</code>.)</p>

    <p>If the value is not specified but the <code
    title="">Namespace</code> is null and the <code
    title="">Event</code> field exactly matches one of the events
    specified by DOM3 Events in <a
    href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#Events-EventTypes-complete">section
    1.4.2 "Complete list of event types"</a>, then the interface used
    must default to the interface relevant for that event type. <a
    href="#refsDOM3EVENTS">[DOM3EVENTS]</a></p>

    <div class="example">
     <p>For example:</p>
     <pre>Event: click</pre>
     <p>...would cause <code title="">Class</code> to be treated as <code>MouseEvent</code>.</p>
    </div>

    <p>If the <code title="">Namespace</code> is null and the <code
    title="">Event</code> field is <code
    title="event-message">message</code> (including if it was not
    specified explicitly), then the <code>MessageEvent</code>
    interface must be used.</p>

    <p>Otherwise, the <code>Event</code> interface must be used.</p>

    <p>It is quite possible to give the wrong class for an event. This
    is equivalent to creating an event in the DOM using the DOM Event
    APIs, but using the wrong interface for it.</p>

   </dd>


   <dt><code title="">Bubbles</code> field</dt>

   <dd>

    <p>This field specifies whether the event is to bubble. If it is
    specified and has the value <code title="">No</code>, the event
    must not bubble. If it is specified and has any other value
    (including <code title="">no</code> or <code title="">NO</code>)
    then the event must bubble.</p>

    <p>If it is not specified but the <code title="">Namespace</code>
    field is null and the <code title="">Event</code> field exactly
    matches one of the events specified by DOM3 Events in <a
    href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#Events-EventTypes-complete">section
    1.4.2 "Complete list of event types"</a>, then the event must
    bubble if the DOM3 Events spec specifies that that event bubbles,
    and musn't bubble if it specifies it does not.  <a
    href="#refsDOM3EVENTS">[DOM3EVENTS]</a></p>

    <div class="example">
     <p>For example:</p>
     <pre>Event: load</pre>
     <p>...would cause <code title="">Bubbles</code> to be treated as <code title="">No</code>.</p>
    </div>

    <p>Otherwise, the event must bubble.</p>

   </dd>

   <dt><code title="">Cancelable</code> field</dt>

   <dd>

    <p>This field specifies whether the event can have its default
    action prevented. If it is specified and has the value <code
    title="">No</code>, the event must not be cancelable. If it is
    specified and has any other value (including <code
    title="">no</code> or <code title="">NO</code>) then the event
    must be cancelable.</p>

    <p>If it is not specified, but the <code title="">Namespace</code>
    field is null and the <code title="">Event</code> field exactly
    matches one of the events specified by DOM3 Events in <a
    href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#Events-EventTypes-complete">section
    1.4.2 "Complete list of event types"</a>, then the event must be
    cancelable if the DOM3 Events specification specifies that it is,
    and must not be cancelable otherwise. <a
    href="#refsDOM3EVENTS">[DOM3EVENTS]</a></p>

    <div class="example">
     <p>For example:</p>
     <pre>Event: load</pre>
     <p>...would cause <code title="">Cancelable</code> to be treated as <code title="">No</code>.</p>
    </div>

    <p>Otherwise, the event must be cancelable.</p>

   </dd>


   <dt><code title="">Target</code> field</dt>

   <dd>

    <p>This field gives the node that the event is to be dispatched
    on.</p>

    <p>If the object for which the event source is being processed is
    not a Node, but the <code title="">Target</code> field is
    nonetheless specified, then the event must be dropped.</p>

    <p>Otherwise, if field is specified and its value starts with a
    <code title="">#</code> character, then the remainder of the value
    represents an ID, and the event must be dispatched on the same
    node as would be obtained by the <code
    title="">getElementById()</code> method on the <code
    title="">ownerDocument</code> of the node whose event source is
    being processed.</p>

    <div class="example">
     <p>For example,</p>
     <pre>Target: #test</pre>
     <p>...would target the element with ID <code title="">test</code>.</p>
    </div>

    <p>Otherwise, if the field is specified and its value is the
    literal string "<code title="">Document</code>", then the event
    must be dispatched at the <code title="">ownerDocument</code> of
    the node whose event source is being processed.</p>

    <p>Otherwise, the field (whether specified or not) is ignored and
    the event must be dispatched at the object itself.</p>

   </dd>

  </dl>

  <p>Other fields depend on the interface specified (or possibly
  implied) by the <code title="">Class</code> field. If the specified
  interface has an attribute that exactly matches the name of the
  field, and the value of the field can be converted (using the type
  conversions defined in ECMAScript) to the type of the attribute,
  then it must be used. Any attributes (other than the
  <code>Event</code> interface attributes) that do not have matching
  fields are initialised to zero, null, false, or the empty
  string.</p>

  <div class="example">
   <p>For example:</p>
   <pre>Event: click
Class: MouseEvent
button: 2</pre>
   <p>...would result in a 'click' event using the
   <code>MouseEvent</code> interface that has <code>button</code> set
   to <code title="">2</code> but <code>screenX</code>,
   <code>screenY</code>, etc, set to 0, false, or null as
   appropriate.</p>
  </div>

  <p>If a field does not match any of the attributes on the event, it
  must be ignored.</p>

  <div class="example">
   <p>For example:</p>
   <pre>Event: keypress
Class: MouseEvent
keyIdentifier: 0</pre>
   <p>...would result in a <code>MouseEvent</code> event with its
   fields all at their default values, with the event name being <code
   title="">keypress</code>. The <code title="">keyIdentifier</code>
   field would be ignored. (If the author had not included the <code
   title="">Class</code> field explicitly, it would have just worked,
   since the class would have defaulted as described above.)</p>
  </div>

  <p>Once a blank line or the end of the file is reached, an event of
  the type and namespace given by the <code title="">Event</code> and
  <code>Namespace</code> fields respectively must be synthesized and
  dispatched to the appropriate node as described by the fields
  above. No event must be dispatched until a blank line has been
  received or the end of the file reached.</p>

  <p>The event must be dispatched as if using the DOM <code
  title="">dispatchEvent()</code> method. Thus, if the <code
  title="">Event</code> field was omitted, leaving the name as the
  empty string, or if the name had invalid characters, then the
  dispatching of the event fails.</p>

  <p>Events fired from event sources do not have user-agent default
  actions.</p>

  <div class="example">

   <p>The following event stream, once followed by a blank line:</p>
   <pre>data: YHOO
data: -2
data: 10</pre>

   <p>...would cause an event <code
   title="event-message">message</code> with the interface
   <code>MessageEvent</code> to be dispatched on the
   <code>event-source</code> element, which would then bubble up the
   DOM, and whose <code title="dom-MessageEvent-data">data</code>
   attribute would contain the string <code>YHOO\n-2\n10</code> (where
   <code>\n</code> again represents a newline).</p>

   <p>This could be used as follows:
   <pre>&lt;event-source src="http://stocks.example.com/ticker.php"
              onmessage="var data = event.data.split('\n'); updateStocks(data[0], data[1], data[2]);"&gt;</pre>
   <p>...where <code title="">updateStocks()</code> is a function defined as:</p>
   <pre>function updateStocks(symbol, delta, value) { ... }</pre>
   <p>...or some such.</p>

  </div>

  <div class="example">

   <p>The following stream contains four blocks and therefore fires
   four events. The first block has just a comment, and will fire a
   <code title="event-message">message</code> event with all the
   fields set to the empty string or null. The second block has two
   fields with names "load" and "Target" respectively; since there is
   no "<code title="">load</code>" member on the
   <code>MessageEvent</code> object that field is ignored, leaving the
   event as a second <code title="event-message">message</code> event
   with all the fields set to the empty string or null, but this time
   the event is targetted at an element with ID "image1". The third
   block is empty (no lines between two blank lines), and the fourth
   block has only two comments, so they both yet again fire <code
   title="event-message">message</code> events with all the fields set
   to the empty string or null.</p>

   <pre>; test

load
Target: #image1


; if any more events follow this block, they will not be affected by
; the "Target" and "load" fields above.
</pre>
  </div>


  <h4>Notes</h4>

  <p>Legacy proxy servers are known to, in certain cases, drop HTTP
  connections after a short timeout. To protect against such proxy
  servers, authors can include a comment line (one starting with a ';'
  character) every 15 seconds or so.</p>

  <p>Authors wishing to relate event source connections to each other
  or to specific documents previously served might find that relying
  on IP addresses doesn't work, as individual clients can have
  multiple IP addresses (due to having multiple proxy servers) and
  individual IP addresses can have multiple clients (due to sharing a
  proxy server). It is better to include a unique identifier in the
  document when it is served and then pass that identifier as part of
  the URI in the <code title="attr-event-source-src">src</code>
  attribute of the <code>event-source</code> element.</p>

  <p>Implementations that support HTTP's per-server connection
  limitation might run into trouble when opening multiple pages from a
  site if each page has an <code>event-source</code> to the same
  domain. Authors can avoid this using the relatively complex
  mechanism of using unique domain names per connection, or by
  allowing the user to enable or disable the <code>event-source</code>
  functionality on a per-page basis.</p>



  <h3 id="network">Network connections</h3>

  <p>To enable Web applications to communicate with each other in
  local area networks, and to maintain bidirectional communications
  with their originating server, this specification introduces the
  <code>Connection</code> interface.</p>

  <p>The <code>WindowHTML</code> interface provides three constructors
  for creating <code>Connection</code> objects: <code
  title="dom-TCPConnection">TCPConnection()</code>, for creating a
  direct (possibly encrypted) link to another node on the Internet
  using TCP/IP; <code
  title="dom-LocalBroadcastConnection">LocalBroadcastConnection()</code>,
  for creating a connection to any listening peer on a local network
  (which could be a local TCP/IP subnet using UDP, a Bluetooth PAN, or
  another kind of network infrastructure); and <code
  title="dom-PeerToPeerConnection">PeerToPeerConnection()</code>, for
  a direct peer-to-peer connection (which could again be over TCP/IP,
  Bluetooth, IrDA, or some other type of network).</p>

  <p class="note">This interface does not allow for raw access to the
  underlying network. For example, this interface could not be used to
  implement an IRC client without proxying messages through a custom
  server.</p>


  <h4 id="network-intro">Introduction</h4>

  <p><em>This section is non-normative.</em></p>

  <p class="big-issue">An introduction to the client-side and
  server-side of using the direct connection APIs.</p>

  <p class="big-issue">An example of a party-line implementation of a
  broadcast service, and direct peer-to-peer chat for direct local
  connections.</p>

<!--
    <div class="example">
     <p>The following script creates a connection to a local party
     line:</p>
     <pre>var a = new LocalBroadcastConnection();
  a.onread = function(e) { alert(e.source + ' wrote ' + e.data); }
  a.send('hello');</pre>
    </div>
-->

  <!--XXX
   Explain why we don't use HTTP instead of our own protocol: wouldn't
   work for peer-to-peer, too much work to implement server if you
   have to implement a compliant HTTP server as well, etc
  -->


  <h4>The <code>Connection</code> interface</h4>
 
  <pre class="idl">interface <dfn>Connection</dfn> {
  readonly attribute DOMString <span title="dom-Connection-network">network</span>;
  readonly attribute DOMString <span title="dom-Connection-peer">peer</span>;
  readonly attribute int <span title="dom-Connection-readyState">readyState</span>;
           attribute EventListener <span title="dom-Connection-onopen">onopen</span>;
           attribute EventListener <span title="dom-Connection-onread">onread</span>;
           attribute EventListener <span title="dom-Connection-onclose">onclose</span>;
  void <span title="dom-Connection-send">send</span>(in DOMString data);
  void <span title="dom-Connection-disconnect">disconnect</span>();
};</pre>

  <p><code>Connection</code> objects must also implement the
  <code>EventTarget</code> interface. <a
  href="#refsDOM3EVENTS">[DOM3EVENTS]</a>

  <p>When a <code>Connection</code> object is created, the UA must try
  to establish a connection, as described in the sections below
  describing each connection type.</p>

  <p>The <dfn
  title="dom-Connection-network"><code>network</code></dfn> attribute
  represents the name of the network connection (the value depends on
  the kind of connection being established). The <dfn
  title="dom-Connection-peer"><code>peer</code></dfn> attribute
  identifies the remote host for direct (non-broadcast)
  connections.</p>

  <p>The <code title="dom-Connection-network">network</code> attribute
  must be set as soon as the <code>Connection</code> object is
  created, and keeps the same value for the lifetime of the object.
  The <code title="dom-Connection-peer">peer</code> attribute must
  initially be set to the empty string and must be updated once, when
  the connection is established, after which point it must keep the
  same value for the lifetime of the object.</p>

  <p>The <dfn
  title="dom-Connection-readyState"><code>readyState</code></dfn>
  attribute represents the state of the connection. When the object is
  created it must be set to 0. It can have the following values:</p>

  <dl>

   <dt>0 Connecting</dt>
   <dd>The connection has not yet been established.</dd>

   <dt>1 Connected</dt>
   <dd>The connection is established and communication is possible.</dd>

   <dt>2 Closed</dt>
   <dd>The connection has been closed.</dd>

  </dl>

  <p id="openConnection">Once a connection is established, the <code
  title="dom-Connection-readyState">readyState</code> attribute's
  value must be changed to 1, and the <code
  title="event-connection-open">open</code> event must be fired on the
  <code>Connection</code> object.</p>

  <p>When data is received, the <code
  title="event-connection-read">read</code> event will be fired on the
  <code>Connection</code> object.</p> <!-- conf crit for this
  statement is in the various protocol-specific sections below. -->

  <p id="closeConnection">When the connection is closed, the <code
  title="dom-Connection-readyState">readyState</code> attribute's
  value must be changed to 2, and the <code
  title="event-connection-close">close</code> event must be fired on
  the <code>Connection</code> object.</p>

  <p>The <dfn title="dom-Connection-onopen"><code>onopen</code></dfn>,
  <dfn title="dom-Connection-onread"><code>onread</code></dfn>, and
  <dfn title="dom-Connection-onclose"><code>onclose</code></dfn>
  attributes must, when set, register their new value as an event
  listener for their respective events (namely <code
  title="event-connection-open">open</code>, <code
  title="event-connection-read">read</code>, and <code
  title="event-connection-close">close</code>), and unregister their
  previous value if any.</p>

  <p>The <dfn title="dom-Connection-send"><code>send()</code></dfn>
  method transmits data using the connection. If the connection is not
  yet established, it must raise an <code>INVALID_STATE_ERR</code>
  exception. If the connection <em>is</em> established, then the
  behaviour depends on the connection type, as described below.</p>

  <p>The <dfn
  title="dom-Connection-disconnect"><code>disconnect()</code></dfn>
  method must close the connection, if it is open. If the connection
  is already closed, it must do nothing. Closing the connection causes
  a <code title="event-connection-close">close</code> event to be
  fired and the <code
  title="dom-Connection-readyState">readyState</code> attribute's
  value to change, as <a href="#closeConnection">described
  above</a>.</p>


  <h4>Connection Events</h4>

  <p>All the events described in this section are events in no
  namespace, which do not bubble, are not cancelable, and have no
  default action.</p>

  <p>The <dfn title="event-connection-open"><code>open</code></dfn>
  event is fired when the connection is established. UAs must use the
  normal <code>Event</code> interface when firing this event.</p>

  <p>The <dfn title="event-connection-close"><code>close</code></dfn>
  event is fired when the connection is closed (whether by the author,
  calling the <code
  title="dom-Connection-disconnect">disconnect()</code> method, or by
  the server, or by a network error). UAs must use the normal
  <code>Event</code> interface when firing this event as well.</p>

  <p class="note">No information regarding why the connection was
  closed is passed to the application in this version of this
  specification.</p>

  <p>The <dfn title="event-connection-read"><code>read</code></dfn>
  event is fired when when data is received for a connection. UAs must
  use the <code>ConnectionReadEvent</code> interface for this
  event.</p>

  <pre class="idl">interface <dfn>ConnectionReadEvent</dfn> : Event {
  readonly attribute DOMString <span title="dom-ConnectionReadEvent-data">data</span>;
  readonly attribute DOMString <span title="dom-ConnectionReadEvent-source">source</span>;
  void <span title="dom-ConnectionReadEvent-initConnectionReadEvent">initConnectionReadEvent</span>(in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
  void <span title="dom-ConnectionReadEvent-initConnectionReadEventNS">initConnectionReadEventNS</span>(in DOMString namespaceURI, in DOMString typeArg, in boolean canBubbleArg, in boolean cancelableArg, in DOMString dataArg);
};
</pre>

  <p>The <dfn
  title="dom-ConnectionReadEvent-initConnectionReadEvent"><code>initConnectionReadEvent()</code></dfn>
  and <dfn
  title="dom-ConnectionReadEvent-initConnectionReadEventNS"><code>initConnectionReadEventNS()</code></dfn>
  methods must initialise the event in a manner analogous to the
  similarly-named methods in the DOM3 Events interfaces. <a
  href="#DOM3Events">[DOM3EVENTS]</a></p>

  <p>The <dfn
  title="dom-ConnectionReadEvent-data"><code>data</code></dfn>
  attribute represents the data that was transmitted from the
  peer.</p>

  <p>The <dfn
  title="dom-ConnectionReadEvent-source"><code>source</code></dfn>
  attribute represents the name of the peer. This is primarily useful
  on broadcast connections; on direct connections it is equal to the
  <code title="dom-Connection-peer">peer</code> attribute on the
  <code>Connection</code> object.</p>

  <!-- XXX check that the following three sections define "the data
  that was transmitted" and "the name of the peer" in terms that mean
  they fit into the above definitions ("for the purposes of the
  ConnectionReadEvent"), and check they say that they MUST be set
  correctly. -->

  <!-- XXX should we have a Connection attribute on the event? -->

  <p>Events that would be fired during script execution (e.g. between
  the connection object being created &mdash; and thus the connection
  being established &mdash; and the current script completing; or,
  during the execution of a <code
  title="event-connection-read">read</code> event handler) must be
  buffered, and those events queued up and each one individually fired
  after the script has completed.</p> <!-- XXX make this more generic -->

  <h4>TCP connections</h4>

  <p>The <dfn title="dom-TCPConnection"><code>TCPConnection(<var
  title="">subdomain</var>, <var title="">port</var>, <var
  title="">secure</var>)</code></dfn> constructor on the
  <code>WindowHTML</code> interface returns a new object implementing
  the <code>Connection</code> interface, set up for a direct
  connection to a specified host on the page's domain.</p>

  <p>When this constructor is invoked, the following steps must be
  followed.</p>

  <p>First, if the <span>script's domain</span> is not a host name
  (e.g. it is an IP address) then the UA must raise a <span>security
  exception</span>. <span class="issue">We currently don't allow
  connections to be set up back to an originating IP address, but we
  could, if the subdomain is the empty string.</span></p>

  <p>Then, if the <var title="">subdomain</var> argument is null or
  the empty string, the target host is the <span>script's
  domain</span>. Otherwise, the <var title="">subdomain</var> argument
  is prepended to the <span>script's domain</span> with a dot
  separating the two strings, and that is the target host.</p>

  <p>If either:</p>
  <ul>
   <li>the target host is not a valid host name, or</li>
   <li>the <var title="">port</var> argument is neither equal to 80,
   nor equal to 443, nor greater than or equal to 1024 and less than
   or equal to 65535,</li>
  </ul>
  <p>...then the UA must raise a <span>security exception</span>.</p>
  <!-- XXX we should have our own port for this too, e.g. 980 -->

  <p>Otherwise, the user agent must verify that the <span>the string
  representing the script's domain in IDNA format</span> can be
  obtained without errors. If it cannot, then the user agent must
  raise a <span>security exception</span>.</p>

  <p>The user agent may also raise a <span>security exception</span>
  at this time if, for some reason, permission to create a direct TCP
  connection to the relevant host is denied. Reasons could include the
  UA being instructed by the user to not allow direct connections, or
  the UA establishing (for instance using UPnP) that the network
  topology will cause connections on the specified port to be directed
  at the wrong host.</p>

  <p>If no exceptions are raised by the previous steps, then a new
  <code>Connection</code> object must be created, its <code
  title="dom-Connection-peer">peer</code> attribute must be set to a
  string consisting of the name of the target host, a colon (U+003A
  COLON), and the port number as decimal digits, and its <code
  title="dom-Connection-network">network</code> attribute must be set
  to the same value as the <code
  title="dom-Connection-peer">peer</code> attribute.</p>

  <p>This object must then be returned.</p>

  <p>The user agent must then begin trying to establish a connection
  with the target host and specified port. (This typically would begin
  in the backgound, while the script continues to execute.)</p>

  <p>If the <var title="">secure</var> boolean argument is set to
  true, then the user agent must establish a secure connection with
  the target host and specified port using TLS or another protocol,
  negotiated with the server. <a href="#refsRFC2246">[RFC2246]</a> If
  this fails the user agent must act as if it had <a
  href="#closeConnection">closed the connection</a>.</p>

  <p>Once a secure connection is established, or if the <var
  title="">secure</var> boolean argument is not set to true, then the
  user agent must continue to connect to the server using the protocol
  described in the section entitled <span>clients connecting over
  TCP</span>. All data on connections made using TLS must be sent as
  "application data".</p>

  <p>Once the connection is established, the UA must act as described
  in the section entitled <span>sending and receiving data over
  TCP</span>.</p>

  <p>User agents should allow multiple TCP connections to be
  established per host. In particular, user agents should not apply
  per-host HTTP connection limits to connections established with the
  <code title="dom-TCPConnection">TCPConnection</code>
  constructor.</p>


  <h4>Broadcast connections</h4>

  <p>The <dfn
  title="dom-LocalBroadcastConnection"><code>LocalBroadcastConnection()</code></dfn>
  constructor on the <code>WindowHTML</code> interface returns a new
  object implementing the <code>Connection</code> interface, set up to
  broadcast on the local network.</p>

  <p>When this constructor is invoked, a new <code>Connection</code>
  object must be created.</p>

  <p>The <code title="dom-Connection-network">network</code> attribute
  of the object must be set to <span>the string representing the
  script's domain in IDNA format</span>. If this string cannot be
  obtained, then the user agent must raise a <span>security
  exception</span> exception when the constructor is called.</p>

  <p>The <code title="dom-Connection-peer">peer</code> attribute must
  be set to the empty string.</p>

  <p>The object must then be returned, unless, for some reason,
  permission to broadcast on the local network is to be denied. In the
  latter case, a <span>security exception</span> must be raised
  instead. User agents may deny such permission for any reason, for
  example a user preference.</p>

  <p>If the object is returned (i.e. if no exception is raised), the
  user agent must the begin broadcasting and listening on the local
  network, in the background, as described below. The user agent may
  define "the local network" in any way it considers appropriate and
  safe; for instance the user agent may ask the user which network
  (e.g. Bluetooth, IrDA, Ethernet, etc) the user would like to
  broadcast on before beginning broadcasting.</p>

  <p>UAs may broadcast and listen on multiple networks at once. For
  example, the UA could broadcast on both Bluetooth and Wifi at the
  same time.</p> <!-- XXX bridging? how do we handle one UA not seeing
  the same hosts as another UA? -->

  <p>As soon as the object is returned, the connection <a
  href="#openConnection">has been established</a>, which implies that
  the <code title="event-connection-open">open</code> event must be
  fired. Broadcast connections are never closed.</p>


  <h5>Broadcasting over TCP/IP</h5>

  <p class="big-issue">Should we drop this altogether? Letting people
  fill the local network with garbage seems unwise.</p>

  <p class="big-issue">We need to register a UDP port for this. For
  now this spec refers to port 18080/udp.</p>

  <p class="note">Since this feature requires that the user agent
  listen to a particular port, some platforms might prevent more than
  one user agent per IP address from using this feature at any one
  time.</p>

  <p>On TCP/IP networks, broadcast connections transmit data using UDP
  over port 18080.</p>

  <p>When the <code title="dom-Connection-send">send(<var
  title="">data</var>)</code> method is invoked on a
  <code>Connection</code> object that was created by the <code
  title="dom-LocalBroadcastConnection">LocalBroadcastConnection()</code>
  constructor, the user agent must follow these steps:</p>

  <ol>

   <li>Create a string consisting of the value of the <code
   title="dom-Connection-network">network</code> attribute of the
   <code>Connection</code> object, a U+0020 SPACE character, a U+0002
   START OF TEXT character, and the <var title="">data</var>
   argument.</li>

   <li>Encode the string as UTF-8.</li>

   <li>If the resulting byte stream is longer than 65487 bytes, raise
   an <code>INDEX_SIZE_ERR</code> DOM exception and stop.</li>

   <li>Create a UDP packet whose data is the byte stream, with the
   source and destination ports being 18080, and with appropriate
   length and checksum fields. Transmit this packet to IPv4 address
   255.255.255.255 or IPv6 address ff02::1, as appropriate. <span
   class="note">IPv6 applications will also have to enable reception
   from this address.</span></li>

  </ol>

  <p>When a broadcast connection is opened on a TCP/IP network, the
  user agent should listen for UDP packets on port 18080.</p>

  <p>When the user agent receives a packet on port 18080, the user
  agent must attempt to decode that packet's data as UTF-8. If the
  data is not fully correct UTF-8 (i.e. if there are decoding errors)
  then the packet must be ignored. Otherwise, the user agent must
  check to see if the decoded string contains a U+0020 SPACE
  character. If it does not, then the packet must again be ignored (it
  might be a peer discovery packet from a <code
  title="dom-PeerToPeerConnection">PeerToPeerConnection()</code>
  constructor). If it does then the user agent must split the
  string at the first space character. All the characters before the
  space are then known as <var title="">d</var>, and all the
  characters after the space are known as <var title="">s</var>. If
  <var title="">s</var> is not at least one character long, or if the
  first character of <var title="">s</var> is not a U+0002 START OF
  TEXT character, then the packet must be ignored. (This allows for
  future extension of this protocol.)</p>

  <p>Otherwise, for each <code>Connection</code> object that was
  created by the <code
  title="dom-LocalBroadcastConnection">LocalBroadcastConnection()</code>
  constructor and whose <code
  title="dom-Connection-network">network</code> attribute exactly
  matches <var title="">d</var>, a <code
  title="event-connection-read">read</code> event must be fired on the
  <code>Connection</code> object. The string <var title="">s</var>,
  with the first character removed, must be used as the <code
  title="dom-ConnectionReadEvent-data">data</code>, and the source IP
  address of the packet as the <code
  title="dom-ConnectionReadEvent-source">source</code>.</p>

  <p class="big-issue">Making the source IP available means that if
  two or more machines in a private network can be made to go to a
  hostile page simultaneously, the hostile page can determine the IP
  addresses used locally (i.e. on the other side of any NAT
  router). Is there some way we can keep link-local IP addresses
  secret while still allowing for applications to distinguish between
  multiple participants?</p>


  <h5 id="bluetooth-broadcast">Broadcasting over Bluetooth</h5>

  <p class="big-issue">Does anyone know enough about Bluetooth to
  write this section?</p>


  <h5 id="irda-broadcast">Broadcasting over IrDA</h5>

  <p class="big-issue">Does anyone know enough about IrDA to write
  this section?</p>


  <h4>Peer-to-peer connections</h4>

  <p>The <dfn
  title="dom-PeerToPeerConnection"><code>PeerToPeerConnection()</code></dfn>
  constructor on the <code>WindowHTML</code> interface returns a new
  object implementing the <code>Connection</code> interface, set up
  for a direct connection to a user-specified host.</p>

  <p>When this constructor is invoked, a new <code>Connection</code>
  object must be created.</p>

  <p>The <code title="dom-Connection-network">network</code> attribute
  of the object must be set to <span>the string representing the
  script's domain in IDNA format</span>. If this string cannot be
  obtained, then the user agent must raise a <span>security
  exception</span> exception when the constructor is called.</p>

  <p>The <code title="dom-Connection-peer">peer</code> attribute must
  be set to the empty string.</p>

  <p>The object must then be returned, unless, for some reason,
  permission to establish peer-to-peer connections is generally
  disallowed, for example due to administrator settings. In the latter
  case, a <span>security exception</span> must be raised instead.</p>

  <p>The user agent must then, typically while the script resumes
  execution, find a remote host to establish a connection to. To do
  this it must start broadcasting and listening for peer discovery
  messages and listening for incoming connection requests on all the
  supported networks. How this is performed depends on the type of
  network and is described below.</p>

  <p>The UA should inform the user of the clients that are detected,
  and allow the user to select one to connect to. UAs may also allow
  users to explicit specify hosts that were not detected, e.g. by
  having the user enter an IP address.</p>

  <p>If an incoming connection is detected before the user specifies a
  target host, the user agent should ask the user to confirm that this
  is the host they wish to connect to. If it is, the connection should
  be accepted and the UA will act as the <em>server</em> in this
  connection. (Which UA acts as the server and which acts as the
  client is not discernible at the DOM API level.)</p>

  <p>If no incoming connection is detected and if the user specifies a
  particular target host, a connection should be established to that
  host, with the UA acting as the <em>client</em> in the
  connection.</p>

  <p>No more than one connection must be established per
  <code>Connection</code> object, so once a connection has been
  established, the user agent must stop listening for further
  connections (unless, or until such time as, another
  <code>Connection</code> object is being created).</p>

  <p>If at any point the user cancels the connection process or the
  remote host refuses the connection, then the user agent must act as
  if it had <a href="#closeConnection">closed the connection</a>, and
  stop trying to connect.</p>


  <h5>Peer-to-peer connections over TCP/IP</h5>

  <p class="big-issue">Should we replace this section with something
  that uses Rendez-vous/zeroconf or equivalent?</p>

  <p class="big-issue">We need to register ports for this. For now
  this spec refers to port 18080/udp and 18080/tcp.</p>

  <p class="note">Since this feature requires that the user agent
  listen to a particular port, some platforms might prevent more than
  one user agent per IP address from using this feature at any one
  time.</p>

  <p>When using TCP/IP, broadcasting peer discovery messages must be
  done by creating UDP packets every few seconds containing as their
  data the value of the connection's <code
  title="dom-Connection-network">network</code> attribute, encoded as
  UTF-8, with the source and destination ports being set to 18080 and
  appropriate length and checksum fields, and sending these packets to
  address (in IPv4) 255.255.255.255 or (in IPv6) ff02::1, as
  appropriate.</p>

  <p>Listening for peer discovery messages must be done by examining
  incoming UDP packets on port 18080. <span class="note">IPv6
  applications will also have to enable reception from the ff02::1
  address.</span> If their payload is exactly byte-for-byte equal to a
  UTF-8 encoded version of the value of the connection's <code
  title="dom-Connection-network">network</code> attribute, then the
  source address of that packet represents the address of a host that
  is ready to accept a peer-to-peer connection, and it should
  therefore be offered to the user.</p>

  <p>Incoming connection requests must be listened for on TCP port
  18080. If an incoming connection is received, the UA must act as a
  <em>server</em>, as described in the section entitled <span>servers
  accepting connections over TCP</span>.</p>

  <p>If no incoming connection requests are accepted and the user
  instead specifies a target host to connect to, the UA acts as a
  <em>client</em>: the user agent must attempt to connect to the
  user-specified host on port 18080, as described in the section
  entitled <span>clients connecting over TCP</span>.</p>

  <p>Once the connection is established, the UA must act as described
  in the section entitled <span>sending and receiving data over
  TCP</span>.</p>

  <p class="note">This specification does not include a way to
  establish <em>secure</em> (encrypted) peer-to-peer connections at
  this time. <span class="big-issue">If you can see a good way to do
  this, let me know.</span></p>

  <h5 id="bluetooth-peer">Peer-to-peer connections over Bluetooth</h5>

  <p class="big-issue">Does anyone know enough about Bluetooth to
  write this section?</p>


  <h5 id="irda-peer">Peer-to-peer connections over IrDA</h5>

  <p class="big-issue">Does anyone know enough about IrDA to write
  this section?</p>



<!--XXX
    <p>Prompts the user to select a connection to make, which could
    look like this:</p>

<pre>|:: New Connection :::::::::::::::::::::::::::::::::::::::::|
|                                                           |
|  Select the peer to connect to:                           |
|                                                           |
|    JohnSmith_Series60   via Bluetooth      (( Connect ))  |
|    Patrick's Phone      via Bluetooth       ( Connect )   |
|    John Smith           via UDP             ( Connect )   |
|                                                           |
|                                               ( Cancel )  |
|___________________________________________________________|
</pre>

    <p>While the prompt is displayed, the UA should broadcast on all
    supported networks, as described <span title="announcing peer
    connections">below</span>.</p>

    <p>Returns null if the prompt was canceled. Otherwise, returns a
    <code>Connection</code> object with its <code>network</code>
    attribute set to <var title="">topic</var> and its <code>peer</code>
    attribute set to a string uniquely identifying the selected peer,
    and opens a connection to that peer. (See: <span>peer connection
    formats</span>.)</p>


   |:: New Connection :::::::::::::::::::::::::::::::::::::::::|
   |                                                           |
   |  Would you like to open a connection called "Chess" for   |
   |  this Web site?:                                          |
   |                                                           |
   |    example.org                                            |
   |                                                           |
   |  Select connection to use: [ Bluetooth      | v ]         |
   |                                                           |
   |                        (( Open connection ))  ( Cancel )  |
   |___________________________________________________________|

  c = new LocalBroadcastConnection("Chess");
  c.onread = function(s, f) { alert("got message " + s + " from " + f); }
  c.send("hello, anybody there?");


   |:: New Connection :::::::::::::::::::::::::::::::::::::::::|
   |                                                           |
   |  Select the peer to connect to:                           |
   |                                                           |
   |    JohnSmith_Series60   via Bluetooth      (( Connect ))  |
   |    Patrick's Phone      via Bluetooth       ( Connect )   |
   |    John Smith           via UDP             ( Connect )   |
   |                                                           |
   |                                               ( Cancel )  |
   |___________________________________________________________|

  c = new LocalPeerConnection("Chess");
  // c.peer contains peer's name
  c.onread = function(s) { alert("got message " + s); } // second argument is c.peer
  c.send("hello");

  c = new TCPConnection("chess.example.com", 8089, false);
  // c.peer contains 'chess.example.com:8089'
  c.onread = function(s) { alert("got message " + s); } // second argument is c.peer
  c.send("hello");

> > Again, what else should we support? Should this have an HTML Element
> > backing it for more declarative authoring? What error handling do we need?
> > Should it automatically use bluetooth, TCP/IP broadcast, infrared, or
> > should it be under the control of the author or user?
-->


  <h4>The common protocol for TCP-based connections</h4>

  <p>The same protocol is used for <code
  title="dom-TCPConnection">TCPConnection</code> and <code
  title="dom-PeerToPeerConnection">PeerToPeerConnection</code>
  connection types. This section describes how such connections are
  established from the client and server sides, and then describes how
  data is sent and received over such connections (which is the same
  for both clients and servers).</p>


  <h5><dfn>Clients connecting over TCP</dfn></h5>

  <p>This section defines the client-side requirements of the protocol
  used by the <code title="dom-TCPConnection">TCPConnection</code> and
  <code title="dom-PeerToPeerConnection">PeerToPeerConnection</code>
  connection types.</p>

  <p>If a TCP connection to the specified target host and port cannot
  be established, for example because the target host is a domain name
  that cannot be resolved to an IP address, or because packets cannot
  be routed to the host, the user agent should retry creating the
  connection. If the user agent gives up trying to connect, the user
  agent must act as if it had <a href="#closeConnection">closed the
  connection</a>.</p>

  <p class="note">No information regarding the state of the connection
  is passed to the application while the connection is being
  established in this version of this specification.</p>

  <p>Once a TCP/IP connection to the remote host is established, the
  user agent must transmit the following sequence of bytes,
  represented here in hexadecimal form:</p>

  <pre>0x48 0x65 0x6C 0x6C 0x6F 0x0A</pre>

  <p class="note">This represents the string "Hello" followed by a
  newline, encoded in UTF-8.</p>

  <p>The user agent must then read all the bytes sent from the remote
  host, up to the first 0x0A byte (inclusive). That string of bytes is
  then compared byte-for-byte to the following string of bytes:</p>

  <pre>0x57 0x65 0x6C 0x63 0x6F 0x6E 0x65 0x0A</pre>

  <p class="note">This says "Welcome".</p>

  <p>If the server sent back a string in any way different to this,
  then the user agent must <a href="#closeConnection">close the
  connection</a> and give up trying to connect.</p>

  <p>Otherwise, the user agent must then take <span>the string
  representing the script's domain in IDNA format</span>, encode it as
  UTF-8, and send that to the remote host, followed by a 0x0A byte (a
  U+000A LINE FEED in UTF-8).</p>

  <p>The user agent must then read all the bytes sent from the remote
  host, up to the first 0x0A byte (inclusive). That string of bytes
  must then be compared byte-for-byte to the string that was just sent
  to the server (the one with the IDNA domain name and ending with a
  newline character). If the server sent back a string in any way
  different to this, then the user agent must <a
  href="#closeConnection">close the connection</a> and give up trying
  to connect.</p>

  <p>Otherwise, the connection <a href="#openConnection">has been
  established</a> (and events and so forth get fired, as described
  above).</p>

  <p>If at any point during this process the connection is closed
  prematurely, then the user agent must <a
  href="#closeConnection">close the connection</a> and give up trying
  to connect.</p> <!-- XXX we should support automatic reconnect -->


  <h5><dfn>Servers accepting connections over TCP</dfn></h5>

  <p>This section defines the server side of the protocol described in
  the previous section. For authors, it should be used as a guide for
  how to implement servers that can communicate with Web pages over
  TCP. For UAs these are the requirements for the server part of <code
  title="dom-PeerToPeerConnection">PeerToPeerConnection</code>s.</p>

  <p>Once a TCP/IP connection from a remote host is established, the
  user agent must transmit the following sequence of bytes,
  represented here in hexadecimal form:</p>

  <pre>0x57 0x65 0x6C 0x63 0x6F 0x6E 0x65 0x0A</pre>

  <p class="note">This says "Welcome" and a newline in UTF-8.</p>

  <p>The user agent must then read all the bytes sent from the remote
  host, up to the first 0x0A byte (inclusive). That string of bytes is
  then compared byte-for-byte to the following string of bytes:</p>

  <pre>0x48 0x65 0x6C 0x6C 0x6F 0x0A</pre>

  <p class="note">"Hello" and a newline.</p>

  <p>If the remote host sent back a string in any way different to
  this, then the user agent must <a href="#closeConnection">close the
  connection</a> and give up trying to connect.</p>

  <p>Otherwise, the user agent must then take <span>the string
  representing the script's domain in IDNA format</span>, encode it as
  UTF-8, and send that to the remote host, followed by a 0x0A byte (a
  U+000A LINE FEED in UTF-8).</p>

  <p>The user agent must then read all the bytes sent from the remote
  host, up to the first 0x0A byte (inclusive). That string of bytes
  must then be compared byte-for-byte to the string that was just sent
  to that host (the one with the IDNA domain name and ending with a
  newline character). If the remote host sent back a string in any way
  different to this, then the user agent must <a
  href="#closeConnection">close the connection</a> and give up trying
  to connect.</p>

  <p>Otherwise, the connection <a href="#openConnection">has been
  established</a> (and events and so forth get fired, as described
  above).</p>

  <p class="note">For author-written servers (as opposed to the server
  side of a peer-to-peer connection), the script's domain would be
  replaced by the hostname of the server. Alternatively, such servers
  might instead wait for the client to send its domain string, and
  then simply echo it back. This would allow connections from pages on
  any domain, instead of just pages originating from the same
  host. The client compares the two strings to ensure they are the
  same before allowing the connection to be used by author script.</p>

  <p>If at any point during this process the connection is closed
  prematurely, then the user agent must <a
  href="#closeConnection">close the connection</a> and give up trying
  to connect.</p> <!-- XXX we should support automatic reconnect -->


  <h5><dfn>Sending and receiving data over TCP</dfn></h5>

  <p>When the <code title="dom-Connection-send">send(<var
  title="">data</var>)</code> method is invoked on the connection's
  corresponding <code>Connection</code> object, the user agent must
  take the <var title="">data</var> argument, replace any U+0000 NULL
  and U+0017 END OF TRANSMISSION BLOCK characters in it with U+FFFD
  REPLACEMENT CHARACTER characters, then transmit a U+0002 START OF
  TEXT character, this new <var title="">data</var> string and a
  single U+0017 END OF TRANSMISSION BLOCK character (in that order) to
  the remote host, all encoded as UTF-8.</p>

  <p>When the user agent receives bytes on the connection, the user
  agent must buffer received bytes until it receives a 0x17 byte (a
  U+0017 END OF TRANSMISSION BLOCK character). If the first buffered
  byte is not a 0x02 byte (a U+0002 START OF TEXT character encoded as
  UTF-8) then all the data up to the 0x17 byte, inclusive, must be
  dropped. (This allows for future extension of this protocol.)
  Otherwise, all the data from (but not including) the 0x02 byte and
  up to (but not including) the 0x17 byte must be taken, interpreted
  as a UTF-8 string, and a <code
  title="event-connection-read">read</code> event must be fired on the
  <code>Connection</code> object with that string as the <code
  title="dom-ConnectionReadEvent-data">data</code>. If that string
  cannot be decoded as UTF-8 without errors, the packet should be
  ignored.</p>

  <p class="note">This protocol does not yet allow binary data
  (e.g. an image or video data) to be efficiently transmitted. A
  future version of this protocol might allow this by using the prefix
  character U+001F INFORMATION SEPARATOR ONE, followed by binary data
  which uses a particular byte (e.g. 0xFF) to encode byte 0x17 somehow
  (since otherwise 0x17 would be treated as transmission end by
  down-level UAs).</p>

  <!--
    Specifically, replace all occurrences of 0xFF with 0xFF 0xFF and
    all occurrences of 0x17 with 0xFF 0x00, or similar.
   -->

  <h4 id="network-security">Security</h4>

  <p class="big-issue">Need to write this section.</p>

  <p class="big-issue">If you have an unencrypted page that is
  (through a man-in-the-middle attack) changed, it can access a secure
  service that is using IP authentication and then send that data back
  to the attacker. Ergo we should probably stop unencrypted pages from
  accessing encrypted services, on the principle that the actual level
  of security is zero. Then again, if we do that, we prevent insecure
  sites from using SSL as a tunneling mechanism.</p>

  <p class="big-issue">Should consider dropping the subdomain-only
  restriction. It doesn't seem to add anything, and prevents
  cross-domain chatter.</p>

  <h4 id="network-other-specs">Relationship to other standards</h4>

  <p class="big-issue">Should have a section talking about the fact
  that we blithely ignoring IANA's port assignments here.</p>

  <p class="big-issue">Should explain why we are not reusing HTTP for
  this. (HTTP is too heavy-weight for such a simple need; requiring
  authors to implement an HTTP server just to have a party line is too
  much of a barrier to entry; cannot rely on prebuilt components;
  having a simple protocol makes it much easier to do RAD; HTTP
  doesn't fit the needs and doesn't have the security model
  needed; etc)</p>



  <h3 id="crossDocumentMessages"><dfn>Cross-document messaging</dfn></h3>

  <p>Web browsers, for security and privacy reasons, prevent documents
  in different domains from affecting each other; that is, cross-site
  scripting is disallowed.</p>

  <p>While this is an important security feature, it prevents pages
  from different domains from communicating even when those pages are
  not hostile. This section introduces a messaging system that allows
  documents to communicate with each other regardless of their source
  domain, in a way designed to not enable cross-site scripting
  attacks.</p>


  <h4>Processing model</h4>

  <p>When a script invokes the <dfn
  title="dom-document-postMessage"><code>postMessage(<var
  title="">message</var>)</code></dfn> method on a
  <code>Document</code> object, the user agent must create an event
  that uses the <code>MessageEvent</code> interface, with the event
  name <code title="event-message">message</code>, which
  bubbles, is cancelable, and has no default action. The <code
  title="dom-MessageEvent-data">data</code> attribute must
  be set to the value passed as the <var title="">message</var>
  argument to the <code
  title="dom-document-postMessage">postMessage()</code> method, the
  <code title="dom-MessageEvent-domain">domain</code>
  attribute must be set to the domain of the document that the script
  that invoked the methods is associated with, the <code
  title="dom-MessageEvent-uri">uri</code> attribute must
  be set to the URI of that document, and the <code
  title="dom-MessageEvent-source">source</code> attribute
  must be set to the <code>Document</code> object representing that
  document.</p>

  <p>The event must then be dispatched at the <code>Document</code>
  object itself.</p>

  <!-- XXX must ensure that postMessage() is accessible on
  cross-domain Document objects but that the dispatchEvent() method is
  not. -->

  <p class="warning">Authors should check the <code
  title="dom-MessageEvent-domain">domain</code> attribute to ensure
  that messages are only accepted from domains that they expect to
  receive messages from. Otherwise, bugs in the author's message
  handling code could be exploited by hostile sites.</p>

  <div class="example">

   <p>For example, if document A contains an <code>object</code>
   element that contains document B, and script in document A calls
   <code title="dom-document-postMessage">postMessage()</code> on
   document B, then a message event will be fired on that element,
   marked as originating from document A.  The script in document A
   might look like:</p>

   <pre>var o = document.getElementsByTagName('object')[0];
o.<span title="">contentDocument</span>.<span title="dom-document-postMessage">postMessage</span>('Hello world');
</pre>

   <p>To register an event handler for incoming events, the script
   would use <code title="">addEventListener()</code> (or similar mechanisms).
   For example, the script in document B might look like:</p>

   <pre>document.addEventListener('message', receiver, false);
function receiver(e) {
  if (e.domain == 'example.com') {
    if (e.data == 'Hello world') {
      e.source.postMessage('Hello');
    } else {
      alert(e.data);
    }
  }
}</pre>

   <p>This script first checks the domain is the expected domain, and
   then looks at the message, which it either displays to the user, or
   responds to by sending a message back to the document which sent
   the message in the first place.</p>

  </div>

  <p class="note">Implementors are urged to take extra care in the
  implementation of this feature. It allows authors to transmit
  information from one domain to another domain, which is normally
  disallowed for security reasons. It also requires that UAs be
  careful to allow access to certain properties but not others.</p>




  <h2 id="syntax">The HTML syntax</h2>

  <h3>Writing HTML documents</h3>

  <p><em>This section only applies to documents, authoring tools, and
  markup generators. In particular, it does not apply to conformance
  checkers; conformance checkers must use the requirements given in
  the next section ("parsing HTML documents").</em></p>

  <p>Documents must consist of the following parts, in the given
  order:</p>

  <ol>

   <li>Optionally, a single U+FEFF BYTE ORDER MARK (BOM) character.</li>

   <li>Any number of <span title="syntax-comments">comments</span> and
   <span title="space character">space characters</span>.</li>

   <li>A <span title="syntax-doctype">DOCTYPE</span>.

   <li>Any number of <span title="syntax-comments">comments</span> and
   <span title="space character">space characters</span>.</li>

   <li>The root element, in the form of an <code>html</code> <span
   title="syntax-elements">element</span>.</li>

   <li>Any number of <span title="syntax-comments">comments</span> and
   <span title="space character">space characters</span>.</li>

  </ol>

  <p>The various types of content mentioned above are described in the
  next few sections.</p>

  <p>In addition, there are some restrictions on how <span
  title="attr-meta-charset">character encoding declarations</span> are
  to be serialised, as discussed in the section on that topic.</p>


  <h4>The DOCTYPE</h4>

  <p>A <dfn title="syntax-doctype">DOCTYPE</dfn> is a mostly useless,
  but required, header.</p>

  <p class="note">DOCTYPEs are required for legacy reasons. When
  omitted, browsers tend to use a different rendering mode that is
  incompatible with some specifications. Including the DOCTYPE in a
  document ensures that the browser makes a best-effort attempt at
  following the relevant specifications.</p>

  <p>A DOCTYPE must consist of the following characters, in this
  order:</p>

  <ol class="brief">
   <li>A U+003C LESS-THAN SIGN (<code>&lt;</code>) character.</li>
   <li>A U+0021 EXCLAMATION MARK (<code>!</code>) character.</li>
   <li>A U+0044 LATIN CAPITAL LETTER D or U+0064 LATIN SMALL LETTER D character.</li>
   <li>A U+004F LATIN CAPITAL LETTER O or U+006F LATIN SMALL LETTER O character.</li>
   <li>A U+0043 LATIN CAPITAL LETTER C or U+0063 LATIN SMALL LETTER C character.</li>
   <li>A U+0054 LATIN CAPITAL LETTER T or U+0074 LATIN SMALL LETTER T character.</li>
   <li>A U+0059 LATIN CAPITAL LETTER Y or U+0079 LATIN SMALL LETTER Y character.</li>
   <li>A U+0050 LATIN CAPITAL LETTER P or U+0070 LATIN SMALL LETTER P character.</li>
   <li>A U+0045 LATIN CAPITAL LETTER E or U+0065 LATIN SMALL LETTER E character.</li>
   <li>One or more <span title="space character">space characters</span>.</li>
   <li>A U+0048 LATIN CAPITAL LETTER H or U+0068 LATIN SMALL LETTER H character.</li>
   <li>A U+0054 LATIN CAPITAL LETTER T or U+0074 LATIN SMALL LETTER T character.</li>
   <li>A U+004D LATIN CAPITAL LETTER M or U+006D LATIN SMALL LETTER M character.</li>
   <li>A U+004C LATIN CAPITAL LETTER L or U+006C LATIN SMALL LETTER L character.</li>
   <li>Zero or more <span title="space character">space characters</span>.</li>
   <li>A U+003E GREATER-THAN SIGN (<code>&gt;</code>) character.</li>
  </ol>

  <p class="note">In other words, <code>&lt;!DOCTYPE HTML></code>,
  case-insensitively.</p>


  <h4>Elements</h4>

  <p>There are four different kinds of <dfn
  title="syntax-elements">elements</dfn>: void elements, CDATA
  elements, RCDATA elements, and normal elements.</p>

  <dl>

   <dt>Void elements</dt>

   <dd><code>base</code>, <code>link</code>, <code>meta</code>,
   <code>hr</code>, <code>br</code>, <code>img</code>,
   <code>embed</code>, <code>param</code>, <code>area</code>,
   <code>col</code>, <code>input</code><!-- XXX add: ,
   <code>command</code>, <code>event-source</code> --></dd> <!-- XXX
   keep this synchronised with the list of "permitted slash" elements
   -->

   <dt>CDATA elements</dt>

   <dd><code>style</code>, <code>script</code></dd> <!-- iframe and
   noscript don't count as CDATA for syntax purposes -->

   <dt>RCDATA elements</dt>

   <dd><code>title</code>, <code>textarea</code></dd>

   <dt>Normal elements</dt>

   <dd>All other allowed HTML elements are normal elements.</dd>

  </dl>

  <p><dfn title="syntax-tags">Tags</dfn> are used to delimit the start
  and end of elements in the markup. CDATA, RCDATA, and normal
  elements have a <span title="syntax-start-tags">start tag</span> to
  indicate where they begin, and an <span title="syntax-end-tags">end
  tag</span> to indicate where they end. The start and end tags of
  certain normal elements can be <span
  title="syntax-tag-omission">omitted</span>, as described
  later. Those that cannot be omitted must not be omitted. Void
  elements only have a start tag; end tags must not be specified for
  void elements.</p>

  <p>The contents of the element must be placed between just after the
  start tag (which <span title="syntax-tag-omission">might be implied,
  in certain cases</span>) and just before the end tag (which again,
  <span title="syntax-tag-omission">might be implied in certain
  cases</span>). The exact allowed contents of each individual element
  depends on the content model of that element, as described earlier
  in this specification. Elements must not contain content that their
  content model disallows. In addition to the restrictions placed on
  the contents by those content models, however, the four types of
  elements have additional <em>syntactic</em> requirements.</p>

  <p>Void elements can't have any contents (since there's no end
  tag, no content can be put between the start tag and the end
  tag.)</p>

  <p>CDATA elements can have <span title="syntax-text">text</span>,
  but the text must not contain the two character sequence
  "<code>&lt;/</code>" (U+003C LESS-THAN SIGN, U+002F SOLIDUS).</p>

  <p>RCDATA elements can have <span title="syntax-text">text</span>
  and <span title="syntax-entities">character entity
  references</span>, but the text must not contain the character
  U+003C LESS-THAN SIGN (<code>&lt;</code>) or the character U+0026
  AMPERSAND (<code>&amp;</code>).</p>

  <p>Normal elements can have <span title="syntax-text">text</span>,
  <span title="syntax-entities">character entity references</span>,
  other <span title="syntax-elements">elements</span>, and <span
  title="syntax-comments">comments</span>, but the text must not
  contain the character U+003C LESS-THAN SIGN (<code>&lt;</code>) or
  the character U+0026 AMPERSAND (<code>&amp;</code>). Some normal
  elements also have <span title="syntax-element-restrictions">yet
  more restrictions</span> on what content they are allowed to hold,
  beyond the restrictions imposed by the content model and those
  described in this paragraph. Those restrictions are described
  below.</p>

  <p>Tags contain a <dfn title="syntax-tag-name">tag name</dfn>,
  giving the element's name. HTML elements all have names that only
  use characters in the range U+0061 LATIN SMALL LETTER A .. U+007A
  LATIN SMALL LETTER Z, or, in uppercase, U+0041 LATIN CAPITAL LETTER
  A .. U+005A LATIN CAPITAL LETTER Z, and U+002D HYPHEN-MINUS
  (<code>-</code>). In the HTML syntax, tag names may be written with
  any mix of lower- and uppercase letters that, when converted to
  all-lowercase, matches the element's tag name; tag names are
  case-insensitive.</p>


  <h5>Start tags</h5>

  <p><dfn title="syntax-start-tags">Start tags</dfn> must have the
  following format:</p>

  <ol>

   <li>The first character of a start tag must be a U+003C LESS-THAN
   SIGN (<code>&lt;</code>).</li>

   <li>The next few characters of a start tag must be the element's
   <span title="syntax-tag-name">tag name</span>.</li>

   <li>If there are to be any attributes in the next step, there must
   first be one or more <span title="space character">space
   characters</span>.</li>

   <li>Then, the start tag may have a number of attributes, the <span
   title="syntax-attributes">syntax for which</span> is described
   below. Attributes may be separated from each other by one or more
   <span title="space character">space characters</span>.</li>

   <li>After the attributes, there may be one or more <span
   title="space character">space characters</span>. (Some attributes
   are required to be followed by a space. See the <span
   title="syntax-attributes">attributes section</span> below.)</li>

   <li>Then, if the element is one of the void elements, then there
   may be a single U+002F SOLIDUS (<code>/</code>) character. This
   character has no effect except to appease the markup gods. As this
   character is therefore just a symbol of faith, atheists should omit
   it.</li>

   <li>Finally, start tags must be closed by a U+003E GREATER-THAN
   SIGN (<code>&gt;</code>) character.</li>

  </ol>


  <h5>End tags</h5>

  <p><dfn title="syntax-end-tags">End tags</dfn> must have the
  following format:</p>

  <ol>

   <li>The first character of an end tag must be a U+003C LESS-THAN
   SIGN (<code>&lt;</code>).</li>

   <li>The second character of an end tag must be a U+002F SOLIDUS
   (<code>/</code>).</li>

   <li>The next few characters of an end tag must be the element's
   <span title="syntax-tag-name">tag name</span>.</li>

   <li>After the tag name, there may be one or more <span title="space
   character">space characters</span>.</li>

   <li>Finally, end tags must be closed by a U+003E GREATER-THAN
   SIGN (<code>&gt;</code>) character.</li>

  </ol>


  <h5>Attributes</h5>

  <p><dfn title="syntax-attributes">Attributes</dfn> for an element
  are expressed inside the element's start tag.</p>

  <p>Attributes have a name and a value. <dfn
  title="syntax-attribute-name">Attribute names</dfn> use characters
  in the range U+0061 LATIN SMALL LETTER A .. U+007A LATIN SMALL
  LETTER Z, or, in uppercase, U+0041 LATIN CAPITAL LETTER A .. U+005A
  LATIN CAPITAL LETTER Z, and U+002D HYPHEN-MINUS (<code>-</code>). In
  the HTML syntax, attribute names may be written with any mix of
  lower- and uppercase letters that, when converted to all-lowercase,
  matches the attribute's name; attribute names are
  case-insensitive.</p>

  <p><dfn title="syntax-attribute-value">Attribute values</dfn> are a
  mixture of <span title="syntax-text">text</span> and <span
  title="syntax-entities">character entity references</span>, except
  with the additional restriction that the text cannot contain a
  U+0026 AMPERSAND (<code>&amp;</code>) character.</p>

  <p>Attributes can be specified in four different ways:</p>

  <dl>

   <dt>Empty attribute syntax</dt>

   <dd>

    <p>Just the <span title="syntax-attribute-name">attribute
    name</span>.</p>

    <div class="example">

     <p>In the following example, the <code
     title="attr-input-disabled">disabled</code> attribute is given
     with the empty attribute syntax:</p>

     <pre>&lt;input <em>disabled</em>&gt;</pre>

    </div>

    <p>If an attribute using the empty attribute syntax is to be
    followed by another attribute, then there must be a <span>space
    character</span> separating the two.</p>

   </dd>

   <dt>Unquoted attribute value syntax</dt>

   <dd>

    <p>The <span title="syntax-attribute-name">attribute name</span>,
    followed by zero or more <span title="space character">space
    characters</span>, followed by a single U+003D EQUALS SIGN
    character, followed by zero or more <span title="space
    character">space characters</span>, followed by the <span
    title="syntax-attribute-value">attribute value</span>, which, in
    addition to the requirements given above for attribute values,
    must not contain any literal <span title="space character">space
    characters</span>, U+003E GREATER-THAN SIGN (<code>&gt;</code>)
    characters, or U+003C LESS-THAN SIGN (<code>&lt;</code>)
    characters, and must not, furthermore, start with either a literal
    U+0022 QUOTATION MARK (<code>&#x22;</code>) character or a literal
    U+0027 APOSTROPHE (<code>&#x27;</code>) character.</p>

    <div class="example">

     <p>In the following example, the <code
     title="attr-input-value">value</code> attribute is given
     with the unquoted attribute value syntax:</p>

     <pre>&lt;input <em>value=yes</em>&gt;</pre>

    </div>

    <p>If an attribute using the unquoted attribute syntax is to be
    followed by another attribute or by one of the optional U+002F
    SOLIDUS (<code>/</code>) characters allowed in step 6 of the <span
    title="syntax-start-tag">start tag</span> syntax above, then there
    must be a <span>space character</span> separating the two.</p>

   </dd>

   <dt>Single-quoted attribute value syntax</dt>

   <dd>

    <p>The <span title="syntax-attribute-name">attribute name</span>,
    followed by zero or more <span title="space character">space
    characters</span>, followed by a single U+003D EQUALS SIGN
    character, followed by zero or more <span title="space
    character">space characters</span>, followed by a single U+0027
    APOSTROPHE (<code>'</code>) character, followed by the <span
    title="syntax-attribute-value">attribute value</span>, which, in
    addition to the requirements given above for attribute values,
    must not contain any literal U+0027 APOSTROPHE (<code>'</code>)
    characters, and finally followed by a second single U+0027
    APOSTROPHE (<code>'</code>) character.</p>

    <div class="example">

     <p>In the following example, the <code
     title="attr-input-type">type</code> attribute is given with the
     single-quoted attribute value syntax:</p>

     <pre>&lt;input <em>type='checkbox'</em>&gt;</pre>

    </div>

   </dd>

   <dt>Double-quoted attribute value syntax</dt>

   <dd>

    <p>The <span title="syntax-attribute-name">attribute name</span>,
    followed by zero or more <span title="space character">space
    characters</span>, followed by a single U+003D EQUALS SIGN
    character, followed by zero or more <span title="space
    character">space characters</span>, followed by a single U+0022
    QUOTATION MARK (<code>"</code>) character, followed by the <span
    title="syntax-attribute-value">attribute value</span>, which, in
    addition to the requirements given above for attribute values,
    must not contain any literal U+0022 QUOTATION MARK
    (<code>"</code>) characters, and finally followed by a second
    single U+0022 QUOTATION MARK (<code>"</code>) character.</p>

    <div class="example">

     <p>In the following example, the <code
     title="attr-input-name">name</code> attribute is given with the
     double-quoted attribute value syntax:</p>

     <pre>&lt;input <em>name="be evil"</em>&gt;</pre>

    </div>

   </dd>

  </dl>


  <h5>Optional tags</h5>

  <p>Certain tags can be <dfn
  title="syntax-tag-omission">omitted</dfn>.</p>

  <!-- <html> -->
  <p>An <code>html</code> element's <span
  title="syntax-start-tag">start tag</span> may be omitted if the
  first thing inside the <code>html</code> element is not a
  <span>space character</span> or a <span
  title="syntax-comments">comment</span>.</p>

  <!-- </html> -->
  <p>An <code>html</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>html</code> element is not
  immediately followed by a <span>space character</span> or a <span
  title="syntax-comments">comment</span>.</p>

  <!-- <head> -->
  <p>A <code>head</code> element's <span
  title="syntax-start-tag">start tag</span> may be omitted if the
  first thing inside the <code>head</code> element is an element.</p>

  <!-- </head> -->
  <p>A <code>head</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>head</code> element is not
  immediately followed by a <span>space character</span> or a <span
  title="syntax-comments">comment</span>.</p>

  <!-- <body> -->
  <p>A <code>body</code> element's <span
  title="syntax-start-tag">start tag</span> may be omitted if the
  first thing inside the <code>body</code> element is not a
  <span>space character</span> or a <span
  title="syntax-comments">comment</span>, except if the first thing
  inside the <code>body</code> element is a <code>script</code> or
  <code>style</code> element and the node immediately preceding the
  <code>body</code> element is a <code>head</code> element whose end
  tag has been omitted.</p>

  <!-- </body> -->
  <p>A <code>body</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>body</code> element is not
  immediately followed by a <span>space character</span> or a <span
  title="syntax-comments">comment</span>.

  <!-- </li> -->
  <p>A <code>li</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>li</code> element is
  immediately followed by another <code>li</code> element or if there
  is no more content in the parent element.</p>

  <!-- </dt> -->
  <p>A <code>dt</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>dt</code> element is
  immediately followed by another <code>dt</code> element or a
  <code>dd</code> element.</p>

  <!-- </dd> -->
  <p>A <code>dd</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>dd</code> element is
  immediately followed by another <code>dd</code> element or a
  <code>dt</code> element, or if there is no more content in the
  parent element.</p>

  <!-- </p> -->
  <p>A <code>p</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>p</code> element is
  immediately followed by an <code>address</code>,
  <code>blockquote</code>, <code>dl</code>, <code>fieldset</code>,
  <code>form</code>, <code>h1</code>, <code>h2</code>,
  <code>h3</code>, <code>h4</code>, <code>h5</code>, <code>h6</code>,
  <code>hr</code>, <code>menu</code>, <code>ol</code>, <code>p</code>,
  <code>pre</code>, <code>table</code>, or <code>ul</code> element, or
  if there is no more content in the parent element.</p>

  <!-- </optgroup> -->
  <p>An <code>optgroup</code> element's <span
  title="syntax-end-tag">end tag</span> may be omitted if the
  <code>optgroup</code> element is immediately followed by another
  <code>optgroup</code> element, or if there is no more content in the
  parent element.</p>

  <!-- </option> -->
  <p>An <code>option</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>option</code> element is
  immediately followed by another <code>option</code> element, or if
  there is no more content in the parent element.</p>

  <!-- <colgroup> -->
  <p>A <code>colgroup</code> element's <span
  title="syntax-start-tag">start tag</span> may be omitted if the
  first thing inside the <code>colgroup</code> element is a
  <code>col</code> element, and if the element is not immediately
  preceeded by another <code>colgroup</code> element whose <span
  title="syntax-end-tag">end tag</span> has been omitted.</p>

  <!-- </colgroup> -->
  <p>A <code>colgroup</code> element's <span
  title="syntax-end-tag">end tag</span> may be omitted if the
  <code>colgroup</code> element is not immediately followed by a
  <span>space character</span> or a <span
  title="syntax-comments">comment</span>.</p>

  <!-- </thead> -->
  <p>A <code>thead</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>thead</code> element is
  immediately followed by a <code>tbody</code> or <code>tfoot</code>
  element.</p>

  <!-- <tbody> -->
  <p>A <code>tbody</code> element's <span
  title="syntax-start-tag">start tag</span> may be omitted if the
  first thing inside the <code>tbody</code> element is a
  <code>tr</code> element, and if the element is not immediately
  preceeded by a <code>tbody</code>, <code>thead</code>, or
  <code>tfoot</code> element whose <span title="syntax-end-tag">end
  tag</span> has been omitted.</p>

  <!-- </tbody> -->
  <p>A <code>tbody</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>tbody</code> element is
  immediately followed by a <code>tbody</code> or <code>tfoot</code>
  element, or if there is no more content in the parent element.</p>

  <!-- </tfoot> -->
  <p>A <code>tfoot</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>tfoot</code> element is
  immediately followed by a <code>tbody</code> element, or if there is
  no more content in the parent element.</p>

  <!-- </tr> -->
  <p>A <code>tr</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>tr</code> element is
  immediately followed by another <code>tr</code> element, or if there
  is no more content in the parent element.</p>

  <!-- </td> -->
  <p>A <code>td</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>td</code> element is
  immediately followed by a <code>td</code> or <code>th</code>
  element, or if there is no more content in the parent element.</p>

  <!-- </th> -->
  <p>A <code>th</code> element's <span title="syntax-end-tag">end
  tag</span> may be omitted if the <code>th</code> element is
  immediately followed by a <code>td</code> or <code>th</code>
  element, or if there is no more content in the parent element.</p>

  <p><strong>However</strong>, a <span title="syntax-start-tag">start
  tag</span> must never be omitted if it has any attributes.</p>


  <h5>Restrictions on content models</h5>

  <p>For historical reasons, certain elements <dfn
  title="syntax-element-restrictions">have extra restrictions</dfn>
  beyond even the restrictions given by their content model.</p>

  <p>A <code>p</code> element must not contain
  <code>blockquote</code>, <code>dl</code>, <code>menu</code>,
  <code>ol</code>, <code>pre</code>, <code>table</code>, or
  <code>ul</code> elements, even though these elements are technically
  allowed inside <code>p</code> elements according to the content
  models described in this specification. (In fact, if one of those
  elements is put inside a <code>p</code> element in the markup, it
  will instead imply a <code>p</code> element end tag before it.)</p>

  <p>An <code>optgroup</code> element must not contain
  <code>optgroup</code> elements, even though these elements are
  technically allowed to be nested according to the content models
  described in this specification. (If an <code>optgroup</code>
  element is put inside another in the markup, it will in fact imply
  an <code>optgroup</code> end tag before it.)</p>

  <p>A <code>table</code> element must not contain <code>tr</code>
  elements, even though these elements are technically allowed inside
  <code>table</code> elements according to the content models
  described in this specification. (If a <code>tr</code> element is
  put inside a <code>table</code> in the markup, it will in fact imply
  a <code>tbody</code> start tag before it.)</p>

  <p>A single U+000A LINE FEED (LF) character may be placed
  immediately after a <code>pre</code> element's <span
  title="syntax-start-tag">start tag</span>. This does not affect the
  processing of the element. The otherwise optional U+000A LINE FEED
  (LF) character <em>must</em> be included if the element's contents
  start with that character (because otherwise the leading newline in
  the contents would be treated like the optional newline, and
  ignored).</p>

  <div class="example">
   <p>The following two <code>pre</code> blocks are equivalent:</p>
   <pre>&lt;pre>Hello&lt;/pre></pre>
   <pre>&lt;pre><br>Hello&lt;/pre></pre>
  </div>



  <h4>Text</h4>

  <p><dfn title="syntax-text">Text</dfn> is allowed inside elements,
  attributes, and comments. Text must consist of valid Unicode
  characters other than U+0000. Text should not contain control
  characters other than <span title="space character">space
  characters</span>. Extra constraints are placed on what is and what
  is not allowed in text based on where the text is to be put, as
  described in the other sections.</p>


  <h5>Newlines</h5>

  <p><dfn title="syntax-newlines">Newlines</dfn> in HTML may be
  represented either as U+000D CARRIAGE RETURN (CR) characters, U+000A
  LINE FEED (LF) characters, or pairs of U+000D CARRIAGE RETURN (CR),
  U+000A LINE FEED (LF) characters in that order.</p>



  <h4>Character entity references</h4>

  <p>In certain cases described in other sections, <span
  title="syntax-text">text</span> may be mixed with <dfn
  title="syntax-entities">character entity references</dfn>. These can
  be used to escape characters that couldn't otherwise legally be
  included in <span title="syntax-text">text</span>.</p>

  <p>Character entity references must start with a U+0026 AMPERSAND
  (<code>&amp;</code>). Following this, there are three possible kinds
  of character entity references:</p>

  <dl>

   <dt>Named entities</dt>

   <dd>The ampersand must be followed by one of the names given in the
   <span>entities</span> section, using the same case. Finally, after
   the name, the entity must be terminated by a U+003B SEMICOLON
   character (<code title="">;</code>).</dd>


   <dt>Decimal numeric entities</dt>

   <dd>The ampersand must be followed by a U+0023 NUMBER SIGN
   (<code>#</code>) character, followed by one or more digits in the
   range U+0030 DIGIT ZERO .. U+0039 DIGIT NINE, representing a
   base-ten integer that itself is a valid Unicode code point that
   isn't U+0000. The digits must then be followed by a U+003B
   SEMICOLON character (<code title="">;</code>).</dd>


   <dt>Hexadecimal numeric entities</dt>

   <dd>The ampersand must be followed by a U+0023 NUMBER SIGN
   (<code>#</code>) character, which must be followed by either a
   U+0078 LATIN SMALL LETTER X or a U+0058 LATIN CAPITAL LETTER X
   character, which must then be followed by one or more digits in the
   range U+0030 DIGIT ZERO .. U+0039 DIGIT NINE, U+0061 LATIN SMALL
   LETTER A .. U+0066 LATIN SMALL LETTER F, and U+0041 LATIN CAPITAL
   LETTER A .. U+0046 LATIN CAPITAL LETTER F, representing a
   base-sixteen integer that itself is a valid Unicode code point that
   isn't U+0000. The digits must then be followed by a U+003B
   SEMICOLON character (<code title="">;</code>).</dd>

  </dl>


  <h4>Comments</h4>

  <p><dfn title="syntax-comments">Comments</dfn> must start with the
  four character sequence U+003C LESS-THAN SIGN, U+0021 EXCLAMATION
  MARK, U+002D HYPHEN-MINUS, U+002D HYPHEN-MINUS
  (<code title="">&lt;!--</code>). Following this sequence, the comment may
  have <span title="syntax-text">text</span>, with the additional
  restriction that the text must not contain two consecutive U+002D
  HYPHEN-MINUS (<code title="">-</code>) characters, nor end with a U+002D
  HYPHEN-MINUS (<code title="">-</code>) character. Finally, the comment must
  be ended by the three character sequence U+002D HYPHEN-MINUS, U+002D
  HYPHEN-MINUS, U+003E GREATER-THAN SIGN (<code title="">--&gt;</code>).</p>



  <h3 id="parsing">Parsing HTML documents</h3>

  <p><em>This section only applies to user agents, data mining tools,
  and conformance checkers.</em></p>
 
  <p>The rules for parsing <span>XML documents</span> (and thus
  <span>XHTML</span> documents) into DOM trees are covered by the XML
  and Namespaces in XML specifications, and are out of scope of this
  specification. <a href="#refsXML">[XML]</a> <a
  href="#refsXMLNS">[XMLNS]</a> <!-- XXX refs --></p>

  <p>For <span>HTML documents</span>, user agents must use the parsing
  rules described in this section to generate the DOM trees. Together,
  these rules define what is referred to as the <dfn>HTML
  parser</dfn>.</p><!-- XXX should probably remove that "must" since
  it'll be redundant with something in the navigating processing model
  eventually -->

  <div class="note">

   <p>While the HTML form of HTML5 bears a close resemblance to SGML
   and XML, it is a separate language with its own parsing rules.</p>

   <p>Some earlier versions of HTML (in particular from HTML2 to
   HTML4) were based on SGML and used SGML parsing rules. However, few
   (if any) web browsers ever implemented true SGML parsing for HTML
   documents; the only user agents to strictly handle HTML as an SGML
   application have historically been validators. The resulting
   confusion &mdash; with validators claiming documents to have one
   representation while widely deployed Web browsers interoperably
   implemented a different representation &mdash; has resulted in this
   version of HTML returning to a non-SGML basis.</p>

   <p>Authors interested in using SGML tools in their authoring
   pipeline are encouraged to use the XML serialisation of HTML5
   instead of the HTML serialisation.</p>

  </div>

  <p>This specification defines the parsing rules for HTML documents,
  whether they are syntactically valid or not. Certain points in the
  parsing algorithm are said to be <dfn title="parse error">parse
  errors</dfn>. The error handling for parse errors is well-defined:
  user agents must either act as described below when encountering
  such problems, or must abort processing at the first error that they
  encounter for which they do not wish to apply the rules described
  below.</p>

  <p>Conformance checkers must report at least one parse error
  condition to the user if one or more parse error conditions exist in
  the document and must not report parse error conditions if none
  exist in the document. Conformance checkers may report more than one
  parse error condition if more than one parse error conditions exist
  in the document. Conformance checkers are not required to recover
  from parse errors.</p>

  <p class="note">Parse errors are only errors with the
  <em>syntax</em> of HTML. In addition to checking for parse errors,
  conformance checkers will also verify that the document obeys all
  the other conformance requirements described in this
  specification.</p>


  <h4>Overview of the parsing model</h4>

  <p>The input to the HTML parsing process consists of a stream of
  Unicode characters, which is passed through a
  <span>tokenisation</span> stage (lexical analysis) followed by a
  <span>tree construction</span> stage (semantic analysis). The output
  is a <code>Document</code> object.</p>

  <p class="note">Implementations that <a href="#non-scripted">do not
  support scripting</a> do not have to actually create a DOM
  <code>Document</code> object, but the DOM tree in such cases is
  still used as the model for the rest of the specification.</p>

  <p>In the common case, the data handled by the tokenisation stage
  comes from the network, but <span title="dynamic markup
  insertion">it can also come from script</span>, e.g. using the <code
  title="dom-document-write-HTML">document.write()</code> API.</p>

  <p><img src="parsing-model-overview.png" alt=""></p>

  <p id="nestedParsing">There is only one set of state for the
  tokeniser stage and the tree construction stage, but the tree
  construction stage is reentrant, meaning that while the tree
  construction stage is handling one token, the tokeniser might be
  resumed, causing further tokens to be emitted and processed before
  the first token's processing is complete.</p>

  <div class="example">

   <p>In the following example, the tree construction stage will be
   called upon to handle a "p" start tag token while handling the
   "script" start tag token:</p>

   <pre>...
&lt;script>
 document.write('&lt;p>');
&lt;/script>
...</pre>

  </div>


  <h4>The <dfn>input stream</dfn></h4>

  <p>The stream of Unicode characters that consists the input to the
  tokenisation stage will be initially seen by the user agent as a
  stream of bytes (typically coming over the network or from the local
  file system). The bytes encode the actual characters according to a
  particular <em>character encoding</em>, which the user agent must
  use to decode the bytes into characters.</p>

  <p id="documentEncoding">For HTML, user agents must use the
  following algorithm in determining the character encoding of a
  document:</p>

  <ol>

   <li><p>If the transport layer specifies an encoding, use that, and
   abort these steps.</p></li>

   <li><p>The user agent may wait for 512 or more bytes of the
   resource to be available.</p></li>

   <li><p>Let <var title="">n</var> be the smaller of either 512 or
   the number of bytes already available.</p></li>

   <li><p>For each of the rows in the following table, starting with
   the first one and going down, if <var title="">n</var> is equal to
   or greater than the number of bytes in the first column, and the
   first bytes of the file match the bytes given in the first column,
   then use the encoding given in the cell in the second column of
   that row, and abort these steps:</p>

    <table>
     <thead>
      <tr>
       <th>Bytes in Hexadecimal
       <th>Description
     <tbody>
      <tr>
       <td>00 00 FE FF
       <td>UTF-32BE BOM
      <tr>
       <td>FF FE 00 00
       <td>UTF-32LE BOM
      <tr>
       <td>FE FF
       <td>UTF-16BE BOM
      <tr>
       <td>FF FE
       <td>UTF-16LE BOM
      <tr>
       <td>EF BB BF
       <td>UTF-8 BOM
<!-- nobody uses this
      <tr>
       <td>DD 73 66 73
       <td>UTF-EBCDIC
-->
    </table>

   <li><p>Otherwise, the user agent will have to search for explicit
   character encoding information in the file itself. This must
   proceed as follows:

    <p>Let <var title="">position</var> be a pointer to a byte in the
    input stream, initially pointing at the first byte. If at any
    point during these steps the <var title="">position</var> pointer
    points beyond the <var title="">n</var>th byte of the input
    stream, then skip to the next step of the overall character
    encoding detection algorithm (the step which mentions frequency
    analysis below).</p>

    <p>Now, repeat the following "two" steps until the algorithm
    aborts (either because <var title="">position</var> reaches beyond
    the <var title="">n</var>th byte, or because a character encoding
    is found):</p>

    <ol>

     <li><p>If <var title="">position</var> points to:</p>

      <dl class="switch">

       <dt>A sequence of bytes starting with: 0x3C 0x21 0x2D 0x2D (ASCII '&lt;!--')</dt>
       <dd>

        <p>Advance the <var title="">position</var> pointer so that it
        points at the first 0x3E byte which is preceeded by two 0x2D
        bytes (i.e. at the end of an ASCII '-->' sequence) and comes
        after the second 0x2D byte that was found. (The two 0x2D bytes
        cannot be the same as the those in the '&lt;!--' sequence.) If
        no such byte is found before the <var title="">n</var>th byte,
        abort this "two step" algorithm.</p>

       </dd>

       <dt>A sequence of bytes starting with: 0x3C, 0x4D or 0x6D, 0x45 or 0x65, 0x54 or 0x74, 0x41 or 0x61, and finally one of 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x20 (case-insensitive ASCII '&lt;meta' followed by a space)</dt>
       <dd>

        <ol>

         <li><p>Advance the <var title="">position</var> pointer so
         that it points at the next 0x09, 0x0A, 0x0B, 0x0C, 0x0D, or
         0x20 byte (the one in sequence of characters matched above),
         if there is one before the <var title="">n</var>th byte. If
         there isn't, abort the "two step" algorithm.</p></li>

         <li><p><span title="concept-get-attributes-when-sniffing">Get
         an attribute</span> and its value. If no attribute was
         sniffed, then skip this inner set of steps, and jump to the
         second step in the overall "two step" algorithm.</p>

         <p class="note">As required above, if the <var
         title="">position</var> pointer points beyond the <var
         title="">n</var>th byte after the "get an attribute" step,
         the "two step" algorithm will abort.</p></li>

         <li><p>Examine the attribute's name:</p>

          <dl class="switch">

           <dt>If it is 'charset'</dt>

           <dd><p>If the attribute's value is a supported character
           encoding, then use the given encoding, and abort all these
           steps. Otherwise, do nothing with this attribute.</p></dd>

           <dt>If it is 'content'</dt>

           <dd>

            <p>The attribute's value is now parsed.</p>

            <ol>

             <li><p>Skip characters in the attribute's value up to and
             including the first U+003B SEMICOLON (<code
             title="">;</code>) character.</p></li>

             <li><p>Skip any U+0009, U+000A, U+000B, U+000C, U+000D,
             or U+0020 characters (i.e. spaces) that immediately
             follow the semicolon.</p></li>

             <li><p>If the next six characters are not 'charset',
             abort this very inner set of steps (parsing the
             attribute's value), and continue looking for other
             attributes.</p></li>

             <li><p>Skip any U+0009, U+000A, U+000B, U+000C, U+000D,
             or U+0020 characters that immediately follow the word
             'charset' (there might not be any).</p></li>

             <li><p>If the next character is not a U+003D EQUALS SIGN
             ('='), abort this very inner set of steps (parsing the
             attribute's value), and continue looking for other
             attributes.</p></li>

             <li><p>Skip any U+0009, U+000A, U+000B, U+000C, U+000D,
             or U+0020 characters that immediately follow the word
             equals sign (there might not be any).</p></li>

             <li><p>Process the next character as follows:</p>

              <dl class="switch">

               <dt>If it is a U+0022 QUOTATION MARK ('"') and there is
               a later U+0022 QUOTATION MARK ('"') in the attribute's
               value</dt>

               <dd><p>Let <var title="">tentative encoding</var> be
               the string between the two quotation marks.</dd>

               <dt>If it is a U+0027 APOSTROPHE ("'") and there is a
               later U+0027 APOSTROPHE ("'") in the attribute's
               value</dt>

               <dd><p>Let <var title="">tentative encoding</var> be
               the string between the two apostrophes.</dd>

               <dt>If it is an unmatched U+0022 QUOTATION MARK ('"')</dt>

               <dt>If it is an unmatched U+0027 APOSTROPHE ("'")</dt>

               <dd><p>There is no <var title="">tentative
               encoding</var>.</dd>

               <dt>Otherwise</dt>

               <dd><p>Let <var title="">tentative encoding</var> be
               the string from this character to the first U+0009,
               U+000A, U+000B, U+000C, U+000D, or U+0020 character or
               the end of the attribute's value, whichever comes
               first.</dd>

              </dl>

             </li>

             <li>If there is a <var title="">tentative encoding</var>
             and it is the name of a supported character encoding,
             then use that encoding; abort all these steps.</li>

             <li>Otherwise, skip this 'content' attribute and continue
             on with any other attributes.</li>

            </ol>

           <dd>

           <dt>Any other name</dt>

           <dd><p>Do nothing with that attribute.</p></dd>

          </dl>

         </li>

         <li><p>Return to step 1 in these inner steps.</p></li>

        </ol>

       </dd>

       <dt>A sequence of bytes starting with a 0x3C byte (ASCII '&lt;'), optionally a 0x2F byte (ASCII '/'), and finally a byte in the range 0x41-0x5A or 0x61-0x7A (an ASCII letter)</dt>
       <dd>

        <ol>

         <li><p>Advance the <var title="">position</var> pointer so
         that it points at the next 0x09 (ASCII TAB), 0x0A (ASCII LF),
         0x0B (ASCII VT), 0x0C (ASCII FF), 0x0D (ASCII CR), 0x20
         (ASCII space), 0x3E (ASCII '>'), 0x3C (ASCII '<') byte, if
         there is one before the <var title="">n</var>th byte. If
         there isn't, abort the "two step" algorithm.</p></li>

         <li><p>If the pointer points to a 0x3C (ASCII '<') byte, then
         return to the first step in the overall "two step"
         algorithm.</p></li>

         <li><p>Repeatedly <span
         title="concept-get-attributes-when-sniffing">get an
         attribute</span> until no further attributes can be found,
         then jump to the second step in the overall "two step"
         algorithm.</p></li>

        </ol>

       </dd>

       <dt>A sequence of bytes starting with: 0x3C 0x2D (ASCII '&lt;!')</dt>
       <dt>A sequence of bytes starting with: 0x3C 0x2F (ASCII '&lt;/')</dt>
       <dt>A sequence of bytes starting with: 0x3C 0x3F (ASCII '&lt;?')</dt>
       <dd>

        <p>Advance the <var title="">position</var> pointer so that it
        points at the first 0x3E byte (ASCII '>') that comes after the
        0x3C byte that was found. If no such byte is found before the
        <var title="">n</var>th byte, abort this "two step"
        algorithm.</p>

       </dd>

       <dt>Any other byte</dt>
       <dd>

        <p>Do nothing with that byte.</p>

       </dd>

      </dl>

     </li>

     <li>Move <var title="">position</var> so it points at the next
     byte in the input stream, and return to the first step of this
     "two step" algorithm.</li>

    </ol>

    <p>When the above "two step" algorithm says to <dfn
    title="concept-get-attributes-when-sniffing">get an
    attribute</dfn>, it means doing this:</p>

    <ol>

     <li><p>If the byte at <var title="">position</var> is one of 0x09
     (ASCII TAB), 0x0A (ASCII LF), 0x0B (ASCII VT), 0x0C (ASCII FF),
     0x0D (ASCII CR), 0x20 (ASCII space), or 0x2F (ASCII '/') then
     advance <var title="">position</var> to the next byte and start
     over.</p></li>

     <li><p>If the byte at <var title="">position</var> is 0x3C (ASCII
     '&lt;'), then move <var title="">position</var> back to the
     previous byte, and stop looking for an attribute. There isn't
     one.</p></li>

     <li><p>If the byte at <var title="">position</var> is 0x3E (ASCII
     '>'), then stop looking for an attribute. There isn't
     one.</p></li>

     <li><p>Otherwise, the byte at <var title="">position</var> is the
     start of the attribute name. Let <var title="">attribute
     name</var> and <var title="">attribute value</var> be the empty
     string.</p></li>

     <li><p><em>Attribute name</em>: Process the byte at <var
     title="">position</var> as follows:</p>

      <dl class="switch">

       <dt>If it is 0x3D (ASCII '='), and the <var title="">attribute
       name</var> is longer than the empty string</dt>

       <dd>Jump to the step below labelled <em>value</em>.</dd>

       <dt>If it is 0x09 (ASCII TAB), 0x0A (ASCII LF), 0x0B (ASCII
       VT), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20 (ASCII
       space)</dt>

       <dd>Jump to the step below labelled <em>spaces</em>.</dd>

       <dt>If it is 0x2F (ASCII '/'), 0x3C (ASCII '&lt;'), or 0x3E
       (ASCII '&gt;').</dt>

       <dd>Stop looking for an attribute. Move <var
       title="">position</var> back to the previous byte. The
       attribute's name is the value of <var title="">attribute
       name</var>, its value is the empty string.</dd>

       <dt>If it is in the range 0x41 (ASCII 'A') to 0x5A (ASCII
       'Z')</dt>

       <dd>Append the Unicode character with codepoint <span><var
       title="">b</var>+0x20</span> to <var title="">attribute
       name</var> (where <var title="">b</var> is the value of the
       byte at <var title="">position</var>).</dd>

       <dt>Anything else</dt>

       <dd>Append the Unicode character with the same codepoint as the
       value of the byte at <var title="">position</var>) to <var
       title="">attribute name</var>. (It doesn't actually matter how
       bytes outside the ASCII range are handled here, since only
       ASCII characters can contribute to the detection of a character
       encoding.)</dd>

      </dl>

     </li>

     <li><p>Advance <var title="">position</var> to the next byte and
     return to the previous step.</p></li>

     <li><p><em>Spaces.</em> If the byte at <var
     title="">position</var> is one of 0x09 (ASCII TAB), 0x0A (ASCII
     LF), 0x0B (ASCII VT), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20
     (ASCII space) then advance <var title="">position</var> to the
     next byte, then, repeat this step.</p></li>

     <li><p>If the byte at <var title="">position</var> is
     <em>not</em> 0x3D (ASCII '='), stop looking for an
     attribute. Move <var title="">position</var> back to the previous
     byte. The attribute's name is the value of <var
     title="">attribute name</var>, its value is the empty
     string.</p></li>

     <li><p>Advance <var title="">position</var> past the 0x3D (ASCII
     '=') byte.</p></li>

     <li><p><em>Value.</em> If the byte at <var
     title="">position</var> is one of 0x09 (ASCII TAB), 0x0A (ASCII
     LF), 0x0B (ASCII VT), 0x0C (ASCII FF), 0x0D (ASCII CR), or 0x20
     (ASCII space) then advance <var title="">position</var> to the
     next byte, then, repeat this step.</p></li>

     <li><p>Process the byte at <var title="">position</var> as
     follows:</p>

      <dl class="switch">

       <dt>If it is 0x22 (ASCII '"') or 0x27 ("'")</dt>

       <dd>

        <ol>

         <li>Let <var title="">b</var> be the value of the byte at
         <var title="">position</var>.</li>

         <li>Advance <var title="">position</var> to the next
         byte.</li>

         <li>If the value of the byte at <var title="">position</var>
         is the value of <var title="">b</var>, then stop looking for
         an attribute. The attribute's name is the value of <var
         title="">attribute name</var>, and its value is the value of
         <var title="">attribute value</var>.</li>

         <li>Otherwise, if the value of the byte at <var
         title="">position</var> is in the range 0x41 (ASCII 'A') to
         0x5A (ASCII 'Z'), then append a Unicode character to <var
         title="">attribute value</var> whose codepoint is 0x20 more
         than the value of the byte at <var
         title="">position</var>.</li>

         <li>Otherwise, append a Unicode character to <var
         title="">attribute value</var> whose codepoint is the same as
         the value of the byte at <var title="">position</var>.</li>

         <li>Return to the second step in these substeps.</p>

        </ol>

       </dd>

       <dt>If it is 0x3C (ASCII '&lt;'), or 0x3E (ASCII '&gt;').</dt>

       <dd>Stop looking for an attribute. Move <var
       title="">position</var> back to the previous byte. The
       attribute's name is the value of <var title="">attribute
       name</var>, its value is the empty string.</dd>


       <dt>If it is in the range 0x41 (ASCII 'A') to 0x5A (ASCII
       'Z')</dt>

       <dd>Append the Unicode character with codepoint <span><var
       title="">b</var>+0x20</span> to <var title="">attribute
       value</var> (where <var title="">b</var> is the value of the
       byte at <var title="">position</var>).</dd>

       <dt>Anything else</dt>

       <dd>Append the Unicode character with the same codepoint as the
       value of the byte at <var title="">position</var>) to <var
       title="">attribute value</var>.</dd>

      </dl>

     </li>

     <li><p>Process the byte at <var title="">position</var> as
     follows:</p>

      <dl class="switch">

       <dt>If it is 0x09 (ASCII TAB), 0x0A (ASCII LF), 0x0B (ASCII
       VT), 0x0C (ASCII FF), 0x0D (ASCII CR), 0x20 (ASCII space), 0x3C
       (ASCII '&lt;'), or 0x3E (ASCII '&gt;').</dt>

       <dd>Stop looking for an attribute. Move <var
       title="">position</var> back to the previous byte. The
       attribute's name is the value of <var title="">attribute
       name</var> and its vale is the value of <var title="">attribute
       value</var>.</dd>

       <dt>If it is in the range 0x41 (ASCII 'A') to 0x5A (ASCII
       'Z')</dt>

       <dd>Append the Unicode character with codepoint <span><var
       title="">b</var>+0x20</span> to <var title="">attribute
       value</var> (where <var title="">b</var> is the value of the
       byte at <var title="">position</var>).</dd>

       <dt>Anything else</dt>

       <dd>Append the Unicode character with the same codepoint as the
       value of the byte at <var title="">position</var>) to <var
       title="">attribute value</var>.</dd>

      </dl>

     </li>

     <li><p>Advance <var title="">position</var> to the next byte and
     return to the previous step.</p></li>

    </ol>

   </li>

   <li><p>The user agent may attempt to autodetect the character encoding
   from applying frequency analysis or other algorithms to the data
   stream. If autodetection succeeds in determining a character
   encoding, then use that; abort these steps. <a
   href="#refsUNIVCHARDET">[UNIVCHARDET]</a></p></li> <!--
   http://www.mozilla.org/projects/intl/UniversalCharsetDetection.html
   -->

   <li><p>Otherwise, use an implementation-defined or user-specified
   default character encoding. Due to its use in legacy content,
   <code title="">windows-1252</code> is recommended as a default in
   predominantly Western demographics. In non-legacy environments, the
   more comprehensive <code title="">UTF-8</code> encoding is recommended
   instead. Since these encodings can in many cases be distinguished
   by inspection, a user agent may heuristically decide which to use
   as a default.</p></li>

  </ol>

  <p class="note">For XML documents, the algorithm user agents must
  use to determine the character encoding is given by the XML
  specification. This section does not apply to XML documents. <a
  href="#refsXML">[XML]</a></p>

  <p>When a user agent would otherwise use the ISO-8859-1 encoding, it
  must instead use the Windows-1252 encoding. User agents must not
  support the CESU-8, UTF-7, BOCU-1 and SCSU encodings. <a
  href="#refsCESU8">[CESU8]</a> <a href="#refsUTF7">[UTF7]</a> <a
  href="#refsBOCU1">[BOCU1]</a> <a href="#refsSCSU">[SCSU]</a></p>

  <p>Bytes or sequences of bytes in the original byte stream that
  could not be converted to Unicode characters must be converted to
  U+FFFD REPLACEMENT CHARACTER code points.</p>

  <p>A leading U+FEFF BYTE ORDER MARK (BOM) must be dropped if
  present.</p>

  <p>All U+0000 NULL characters in the input must be replaced by
  U+FFFD REPLACEMENT CHARACTERs.</p>

  <p>U+000D CARRIAGE RETURN (CR) characters, and U+000A LINE FEED (LF)
  characters, are treated specially. Any CR characters that are
  followed by LF characters must be removed, and any CR characters not
  followed by LF characters must be converted to LF characters. Thus,
  newlines in HTML DOMs are represented by LF characters, and there
  are never any CR characters in the input to the
  <span>tokenisation</span> stage.</p>

  <p>The <dfn>next input character</dfn> is the first character in the
  input stream that has not yet been <dfn>consumed</dfn>. Initially,
  the <em>next input character</em> is the first character in the
  input.</p>

  <p>The <dfn>insertion point</dfn> is the position (just before a
  character or just before the end of the input stream) where content
  inserted using <code
  title="dom-document-write-HTML">document.write()</code> is actually
  inserted. The insertion point is relative to the position of the
  character immediately after it, it is not an absolute offset into
  the input stream. Initially, the insertion point is
  uninitialised.</p>

  <p>The "EOF" character in the tables below is a conceptual character
  representing the end of the <span>input stream</span>. If the parser
  is a <span>script-created parser</span>, then the end of the
  <span>input stream</span> is reached when an <dfn>explicit "EOF"
  character</dfn> (inserted by the <code
  title="dom-document-close">document.close()</code> method) is
  consumed. Otherwise, the "EOF" character is not a real character in
  the stream, but rather the lack of any further characters.</p>


  <h4><dfn>Tokenisation</dfn></h4>

  <p>Implementations must act as if they used the following state
  machine to tokenise HTML. The state machine must start in the
  <span>data state</span>. Most states consume a single character,
  which may have various side-effects, and either switches the state
  machine to a new state to <em>reconsume</em> the same character, or
  switches it to a new state (to consume the next character), or
  repeats the same state (to consume the next character). Some states
  have more complicated behaviour and can consume several characters
  before switching to another state.</p>

  <p>The exact behaviour of certain states depends on a <dfn>content
  model flag</dfn> that is set after certain tokens are emitted. The
  flag has several states: <em title="">PCDATA</em>, <em
  title="">RCDATA</em>, <em title="">CDATA</em>, and <em
  title="">PLAINTEXT</em>. Initially it is in the PCDATA state.</p>

  <p>The output of the tokenisation step is a series of zero or more
  of the following tokens: DOCTYPE, start tag, end tag, comment,
  character, end-of-file. DOCTYPE tokens have names and can be either
  correct or in error.  Start and end tag tokens have a tagname and a
  list of attributes, each of which has a name and a value. Comment
  and character tokens have data.</p>

  <p>When a token is emitted, it must immediately be handled by the
  <span>tree construction</span> stage. The tree construction stage
  can affect the state of the <span>content model flag</span>, and can
  insert additional characters into the stream. (For example, the
  <code>script</code> element can result in scripts executing and
  using the <span>dynamic markup insertion</span> APIs to insert
  characters into the stream being tokenised.)</p>

  <p>Before each step of the tokeniser, the user agent may check to
  see if either one of the scripts in the <span>list of scripts that
  will execute as soon as possible</span> or the first script in the
  <span>list of scripts that will execute asynchronously</span>, has
  <span>completed loading</span><!-- XXX xref -->. If one has, then it
  must be <span title="executing a script block">executed</span> and
  removed from its list.</li>

  <p>The tokeniser state machine is as follows:</p>

  <dl>

   <dt><dfn>Data state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0026 AMPERSAND (&amp;)</dt>
     <dd>When the <span>content model flag</span> is set to one of the
     PCDATA or RCDATA states: switch to the <span>entity data
     state</span>.</dd>
     <dd>Otherwise: treat it as per the "anything else" entry below.</dd>

     <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
     <dd>When the <span>content model flag</span> is set to a state
     other than the PLAINTEXT state: switch to the <span>tag open
     state</span>.</dd>
     <dd>Otherwise: treat it as per the "anything else" entry
     below.</dd>

     <dt>EOF</dt>
     <dd>Emit an end-of-file token.</dd>

     <dt>Anything else</dt>
     <dd>Emit the input character as a character token. Stay in the
     <span>data state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Entity data state</dfn></dt>

   <dd>

    <p><em>(This cannot happen if the <span>content model flag</span>
    is set to the CDATA state.)</em></p>

    <p>Attempt to <span>consume an entity</span>.</p>

    <p>If nothing is returned, emit a U+0026 AMPERSAND character
    token.</p>

    <p>Otherwise, emit the character token that was returned.</p>

    <p>Finally, switch to the <span>data state</span>.</p>

   </dd>

   <dt><dfn>Tag open state</dfn></dt>

   <dd>

    <p>The behaviour of this state depends on the <span>content model
    flag</span>.</p>

    <dl>

     <dt>If the <span>content model flag</span> is set to the RCDATA
     or CDATA states</dt>

     <dd>

      <p>If the <span>next input character</span> is a U+002F SOLIDUS (/)
      character, consume it and switch to the <span>close tag open
      state</span>. If the <span>next input character</span> is not a U+002F
      SOLIDUS (/) character, emit a U+003C LESS-THAN SIGN character
      token and reconsume the current input character in the
      <span>data state</span>.</p>

     </dd>

     <dt>If the <span>content model flag</span> is set to the PCDATA
     state</dt>

     <dd>

      <p>Consume the <span>next input character</span>:</p>

      <dl class="switch">

       <dt>U+0021 EXCLAMATION MARK (!)</dt>
       <dd>Switch to the <span>markup declaration open state</span>.</dd>

       <dt>U+002F SOLIDUS (/)</dt>
       <dd>Switch to the <span>close tag open state</span>.</dd>

       <dt>U+0041 LATIN CAPITAL LETTER A through to U+005A LATIN CAPITAL LETTER Z</dt>
       <dd>Create a new start tag token, set its tag name to the
       lowercase version of the input character (add 0x0020 to the
       character's code point), then switch to the <span>tag name
       state</span>. (Don't emit the token yet; further details will
       be filled in before it is emitted.)</dd>

       <dt>U+0061 LATIN SMALL LETTER A through to U+007A LATIN SMALL LETTER Z</dt>
       <dd>Create a new start tag token, set its tag name to the input
       character, then switch to the <span>tag name
       state</span>. (Don't emit the token yet; further details will
       be filled in before it is emitted.)</dd>

       <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
       <dd><span>Parse error</span>. Emit a U+003C LESS-THAN SIGN
       character token and a U+003E GREATER-THAN SIGN character
       token. Switch to the <span>data state</span>.</dd>

       <dt>U+003F QUESTION MARK (?)</dt>
       <dd><span>Parse error</span>. Switch to the <span>bogus
       comment state</span>.</dd>

       <dt>Anything else</dt>
       <dd><span>Parse error</span>. Emit a U+003C LESS-THAN SIGN
       character token and reconsume the current input character in the
       <span>data state</span>.</dd>

      </dl>

     </dd>

    </dl>

   </dd>

   <dt><dfn>Close tag open state</dfn></dt>

   <dd>

    <p>If the <span>content model flag</span> is set to the RCDATA or
    CDATA states then examine the next few characters. If they do not
    match the tag name of the last start tag token emitted (case
    insensitively), or if they do but they are not immediately
    followed by one of the following characters:</p>

    <ul class="brief">
     <li>U+0009 CHARACTER TABULATION</li>
     <li>U+000A LINE FEED (LF)</li>
     <li>U+000B LINE TABULATION</li>
     <li>U+000C FORM FEED (FF)</li>
     <!--<li>U+000D CARRIAGE RETURN (CR)</li>-->
     <li>U+0020 SPACE</li>
     <li>U+003E GREATER-THAN SIGN (&gt;)</li>
     <li>U+002F SOLIDUS (/)</li>
     <li>U+003C LESS-THAN SIGN (&lt;)</li>
     <li>EOF</li>
    </ul>

    <p>...then there is a <span>parse error</span>. Emit a
    U+003C LESS-THAN SIGN character token, a U+002F SOLIDUS character
    token, and reconsume the current input character in the <span>data
    state</span>.</p>

    <p>Otherwise, if the <span>content model flag</span> is set to the
    PCDATA state, or if the next few characters <em>do</em> match that tag
    name, consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0041 LATIN CAPITAL LETTER A through to U+005A LATIN CAPITAL LETTER Z</dt>
     <dd>Create a new end tag token, set its tag name to the lowercase
     version of the input character (add 0x0020 to the character's
     code point), then switch to the <span>tag name
     state</span>. (Don't emit the token yet; further details will be
     filled in before it is emitted.)</dd>

     <dt>U+0061 LATIN SMALL LETTER A through to U+007A LATIN SMALL LETTER Z</dt>
     <dd>Create a new end tag token, set its tag name to the input
     character, then switch to the <span>tag name state</span>. (Don't
     emit the token yet; further details will be filled in before it
     is emitted.)</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd><span>Parse error</span>. Switch to the <span>data
     state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit a U+003C LESS-THAN SIGN
     character token and a U+002F SOLIDUS character token.  Reconsume
     the EOF character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd><span>Parse error</span>. Switch to the <span>bogus
     comment state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Tag name state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Switch to the <span>before attribute name state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current tag token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+0041 LATIN CAPITAL LETTER A through to U+005A LATIN CAPITAL LETTER Z</dt>
     <dd>Append the lowercase version of the current input character
     (add 0x0020 to the character's code point) to the current tag
     token's tag name. Stay in the <span>tag name state</span>.</dd>

     <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>

     <dt>U+002F SOLIDUS (/)</dt>
     <dd><span>Parse error</span> unless this is a <span>permitted
     slash</span>. Switch to the <span>before attribute name
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current tag token's
     tag name. Stay in the <span>tag name state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Before attribute name state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Stay in the <span>before attribute name state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current tag token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+0041 LATIN CAPITAL LETTER A through to U+005A LATIN CAPITAL LETTER Z</dt>
     <dd>Start a new attribute in the current tag token. Set that
     attribute's name to the lowercase version of the current input
     character (add 0x0020 to the character's code point), and its
     value to the empty string. Switch to the <span>attribute name
     state</span>.</dd>

     <dt>U+002F SOLIDUS (/)</dt>
     <dd><span>Parse error</span> unless this is a <span>permitted
     slash</span>. Stay in the <span>before attribute name
     state</span>.</dd>

     <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>
     
     <dt>Anything else</dt>
     <dd>Start a new attribute in the current tag token. Set that
     attribute's name to the current input character, and its value to
     the empty string. Switch to the <span>attribute name
     state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Attribute name state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Switch to the <span>after attribute name state</span>.</dd>

     <dt>U+003D EQUALS SIGN (=)</dt>
     <dd>Switch to the <span>before attribute value state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current tag token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+0041 LATIN CAPITAL LETTER A through to U+005A LATIN CAPITAL LETTER Z</dt>
     <dd>Append the lowercase version of the current input character
     (add 0x0020 to the character's code point) to the current
     attribute's name. Stay in the <span>attribute name
     state</span>.</dd>

     <dt>U+002F SOLIDUS (/)</dt>
     <dd><span>Parse error</span> unless this is a <span>permitted
     slash</span>. Switch to the <span>before attribute name
     state</span>.</dd>

     <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current attribute's
     name. Stay in the <span>attribute name state</span>.</dd>

    </dl>

    <p>When the user agent leaves the attribute name state (and before
    emitting the tag token, if appropriate), the complete attribute's
    name must be compared to the other attributes on the same token;
    if there is already an attribute on the token with the exact same
    name, then this is a <span>parse error</span> and the new
    attribute must be dropped, along with the value that gets
    associated with it (if any).</p>

   </dd>

   <dt><dfn>After attribute name state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Stay in the <span>after attribute name state</span>.</dd>

     <dt>U+003D EQUALS SIGN (=)</dt>
     <dd>Switch to the <span>before attribute value state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current tag token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+0041 LATIN CAPITAL LETTER A through to U+005A LATIN CAPITAL LETTER Z</dt>
     <dd>Start a new attribute in the current tag token. Set that
     attribute's name to the lowercase version of the current input character
     (add 0x0020 to the character's code point), and its value to
     the empty string. Switch to the <span>attribute name
     state</span>.</dd>

     <dt>U+002F SOLIDUS (/)</dt>
     <dd><span>Parse error</span> unless this is a <span>permitted
     slash</span>. Switch to the <span>before attribute name
     state</span>.</dd>

     <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Start a new attribute in the current tag token. Set that
     attribute's name to the current input character, and its value to
     the empty string. Switch to the <span>attribute name
     state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Before attribute value state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Stay in the <span>before attribute value state</span>.</dd>

     <dt>U+0022 QUOTATION MARK (&quot;)</dt>
     <dd>Switch to the <span>attribute value (double-quoted) state</span>.</dd>

     <dt>U+0026 AMPERSAND (&amp;)</dt>
     <dd>Switch to the <span>attribute value (unquoted) state</span>
     and reconsume this input character.</dd>

     <dt>U+0027 APOSTROPHE (')</dt>
     <dd>Switch to the <span>attribute value (single-quoted) state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current tag token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current attribute's
     value. Switch to the <span>attribute value (unquoted)
     state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Attribute value (double-quoted) state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0022 QUOTATION MARK (&quot;)</dt>
     <dd>Switch to the <span>before attribute name state</span>.</dd>

     <dt>U+0026 AMPERSAND (&amp;)</dt>
     <dd>Switch to the <span>entity in attribute value state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current attribute's
     value. Stay in the <span>attribute value (double-quoted)
     state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Attribute value (single-quoted) state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0027 APOSTROPHE (')</dt>
     <dd>Switch to the <span>before attribute name state</span>.</dd>

     <dt>U+0026 AMPERSAND (&amp;)</dt>
     <dd>Switch to the <span>entity in attribute value state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current attribute's
     value. Stay in the <span>attribute value (single-quoted)
     state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Attribute value (unquoted) state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Switch to the <span>before attribute name state</span>.</dd>

     <dt>U+0026 AMPERSAND (&amp;)</dt>
     <dd>Switch to the <span>entity in attribute value state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current tag token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+003C LESS-THAN SIGN (&lt;)</dt>
     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current tag
     token. Reconsume the character in the <span>data
     state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current attribute's
     value. Stay in the <span>attribute value (unquoted)
     state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Entity in attribute value state</dfn></dt>

   <dd>

    <p>Attempt to <span>consume an entity</span>.</p>

    <p>If nothing is returned, append a U+0026 AMPERSAND character to
    the current attribute's value.</p>

    <p>Otherwise, append the returned character token to the current
    attribute's value.</p>

    <p>Finally, switch back to the attribute value state that you were
    in when were switched into this state.</p>

   </dd>

   <dt><dfn>Bogus comment state</dfn></dt>

   <dd>

    <p><em>(This can only happen if the <span>content model
    flag</span> is set to the PCDATA state.)</em></p>

    <p>Consume every character up to the first U+003E GREATER-THAN
    SIGN character (&gt;) or the end of the file (EOF), whichever
    comes first. Emit a comment token whose data is the concatenation
    of all the characters starting from and including the character
    that caused the state machine to switch into the bogus comment
    state, up to and including the last consumed character before the
    U+003E character, if any, or up to the end of the file
    otherwise. (If the comment was started by the end of the file
    (EOF), the token is empty.)</p>

    <p>Switch to the <span>data state</span>.</p>

    <p>If the end of the file was reached, reconsume the EOF
    character.</p>

   </dd>

   <dt><dfn>Markup declaration open state</dfn></dt>

   <dd>

    <p><em>(This can only happen if the <span>content model
    flag</span> is set to the PCDATA state.)</em></p>

    <p>If the next two characters are both U+002D HYPHEN-MINUS (-)
    characters, consume those two characters, create a comment token
    whose data is the empty string, and switch to the <span>comment
    state</span>.</p>

    <p>Otherwise if the next seven chacacters are a
    <span>case-insensitive</span><!-- XXX xref, ascii only --> match
    for the word "DOCTYPE", then consume those characters and switch
    to the <span>DOCTYPE state</span>.</p>

    <p>Otherwise, is is a <span>parse error</span>. Switch to the
    <span>bogus comment state</span>. The next character that is
    consumed, if any, is the first character that will be in the
    comment.</p>

   </dd>

   <dt><dfn id="comment">Comment state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+002D HYPHEN-MINUS (-)</dt>
     <dd>Switch to the <span>comment dash state</span></dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the comment token. Reconsume
     the EOF character in the <span>data state</span>.</dd> <!-- For
     security reasons: otherwise, hostile user could put a <script> in
     a comment e.g. in a blog comment and then DOS the server so that
     the end tag isn't read, and then the commented <script> tag would
     be treated as live code -->

     <dt>Anything else</dt>
     <dd>Append the input character to the comment token's data. Stay
     in the <span>comment state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Comment dash state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+002D HYPHEN-MINUS (-)</dt>
     <dd>Switch to the <span>comment end state</span></dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the comment token. Reconsume
     the EOF character in the <span>data state</span>.</dd> <!-- For
     security reasons: otherwise, hostile user could put a <script> in
     a comment e.g. in a blog comment and then DOS the server so that
     the end tag isn't read, and then the commented <script> tag would
     be treated as live code -->

     <dt>Anything else</dt>
     <dd>Append a U+002D HYPHEN-MINUS (-) character and the input
     character to the comment token's data. Switch to the
     <span>comment state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Comment end state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the comment token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+002D HYPHEN-MINUS (-)</dt>
     <dd><span>Parse error</span>. Append a U+002D HYPHEN-MINUS
     (-) character to the comment token's data. Stay in the
     <span>comment end state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the comment token. Reconsume
     the EOF character in the <span>data state</span>.</dd> <!-- For
     security reasons: otherwise, hostile user could put a <script> in
     a comment e.g. in a blog comment and then DOS the server so that
     the end tag isn't read, and then the commented <script> tag would
     be treated as live code -->

     <dt>Anything else</dt>
     <dd><span>Parse error</span>. Append two U+002D HYPHEN-MINUS (-)
     characters and the input character to the comment token's
     data. Switch to the <span>comment state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>DOCTYPE state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Switch to the <span>before DOCTYPE name state</span>.</dd>

     <dt>Anything else</dt>
     <dd><span>Parse error</span>. Reconsume the current
     character in the <span>before DOCTYPE name state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Before DOCTYPE name state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Stay in the <span>before DOCTYPE name state</span>.</dd>

     <dt>U+0061 LATIN SMALL LETTER A through to U+007A LATIN SMALL LETTER Z</dt>
     <dd>Create a new DOCTYPE token. Set the token's name name to the
     uppercase version of the current input character (subtract 0x0020
     from the character's code point), and mark it as being in
     error. Switch to the <span>DOCTYPE name state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd><span>Parse error</span>. Emit a DOCTYPE token whose
     name is the empty string and that is marked as being in
     error. Switch to the <span>data state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit a DOCTYPE token whose name is
     the empty string and that is marked as being in error. Reconsume
     the EOF character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Create a new DOCTYPE token. Set the token's name name to the
     current input character, and mark it as being in error. Switch to
     the <span>DOCTYPE name state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>DOCTYPE name state</dfn></dt>

   <dd>

    <p>First, consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Switch to the <span>after DOCTYPE name state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current DOCTYPE token. Switch to the <span>data
     state</span>.</dd>

     <dt>U+0061 LATIN SMALL LETTER A through to U+007A LATIN SMALL LETTER Z</dt>
     <dd>Append the uppercase version of the current input character
     (subtract 0x0020 from the character's code point) to the current DOCTYPE
     token's name. Stay in the <span>DOCTYPE name state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current DOCTYPE token.
     Reconsume the EOF character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Append the current input character to the current DOCTYPE
     token's name. Stay in the <span>DOCTYPE name state</span>.</dd>

    </dl>

    <p>Then, if the name of the DOCTYPE token is exactly the four
    letters "HTML", then mark the token as being correct. Otherwise,
    mark it as being in error.</p>

    <p class="note">Because lowercase letters in the name are
    uppercased by the algorithm above, the "HTML" letters are actually
    case-insensitive relative to the markup.</p>

   </dd>

   <dt><dfn>After DOCTYPE name state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+0009 CHARACTER TABULATION</dt>
     <dt>U+000A LINE FEED (LF)</dt>
     <dt>U+000B LINE TABULATION</dt>
     <dt>U+000C FORM FEED (FF)</dt>
     <!--<dt>U+000D CARRIAGE RETURN (CR)</dt>-->
     <dt>U+0020 SPACE</dt>
     <dd>Stay in the <span>after DOCTYPE name state</span>.</dd>

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current DOCTYPE token. Switch to the <span>data
     state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current DOCTYPE token.
     Reconsume the EOF character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd><span>Parse error</span>. Mark the DOCTYPE token as
     being in error, if it is not already. Switch to the <span>bogus
     DOCTYPE state</span>.</dd>

    </dl>

   </dd>

   <dt><dfn>Bogus DOCTYPE state</dfn></dt>

   <dd>

    <p>Consume the <span>next input character</span>:</p>

    <dl class="switch">

     <dt>U+003E GREATER-THAN SIGN (&gt;)</dt>
     <dd>Emit the current DOCTYPE token. Switch to the <span>data
     state</span>.</dd>

     <dt>EOF</dt>
     <dd><span>Parse error</span>. Emit the current DOCTYPE token.
     Reconsume the EOF character in the <span>data state</span>.</dd>

     <dt>Anything else</dt>
     <dd>Stay in the <span>bogus DOCTYPE state</span>.</dd>

    </dl>

   </dd>

  </dl>

  <p>When an end tag token is emitted, the <span>content model
  flag</span> must be switched to the PCDATA state.</p>

  <p>When an end tag token is emitted with attributes, that is a
  <span>parse error</span>.</p>

  <p>A <dfn>permitted slash</dfn> is a U+002F SOLIDUS character that
  is immediately followed by a U+003E GREATER-THAN SIGN, if, and only
  if, the current token being processed is a start tag token whose tag
  name is one of the following: <code>base</code>, <code>link</code>,
  <code>meta</code>, <code>hr</code>, <code>br</code>,
  <code>img</code>, <code>embed</code>, <code>param</code>,
  <code>area</code>, <code>col</code>, <code>input</code><!-- XXX add:
  , <code>command</code>, <code>event-source</code> --></p> <!-- XXX
  keep this synchronised with the list of "void elements" -->


  <h5>Tokenising entities</h5>

  <p>This section defines how to <dfn>consume an entity</dfn>. This
  definition is used when parsing entities <span title="entity data
  state">in text</span> and <span title="entity in attribute value
  state">in attributes</span>.</p>

  <p>The behaviour depends on the identity of the next character (the
  one immediately after the U+0026 AMPERSAND character):</p>

  <dl class="switch">

   <dt>U+0023 NUMBER SIGN (#)</dt>

   <dd>

    <p>Consume the U+0023 NUMBER SIGN.</p>

    <p>The behaviour further depends on the character after the U+0023
    NUMBER SIGN:</p>

    <dl class="switch">

     <dt>U+0078 LATIN SMALL LETTER X</dt>
     <dt>U+0058 LATIN CAPITAL LETTER X</dt>

     <dd>

      <p>Consume the X.</p>

      <p>Follow the steps below, but using the range of characters
      U+0030 DIGIT ZERO through to U+0039 DIGIT NINE, U+0061 LATIN
      SMALL LETTER A through to U+0078 LATIN SMALL LETTER F, and
      U+0041 LATIN CAPITAL LETTER A, through to U+0058 LATIN CAPITAL
      LETTER F (in other words, 0-9, A-F, a-f).</p>

      <p>When it comes to interpreting the number, interpret it as a
      hexadecimal number.</p>

     </dd>


     <dt>Anything else</dt>

     <dd>

      <p>Follow the steps below, but using the range of characters
      U+0030 DIGIT ZERO through to U+0039 DIGIT NINE (i.e. just
      0-9).</p>

      <p>When it comes to interpreting the number, interpret it as a
      decimal number.</p>

     </dd>

    </dl>

    <p>Consume as many characters as match the range of characters
    given above.</p>

    <p>If no characters match the range, then don't consume any
    characters (and unconsume the U+0023 NUMBER SIGN character and, if
    appropriate, the X character). This is a <span>parse
    error</span>; nothing is returned.</p>

    <p>Otherwise, if the next character is a U+003B SEMICOLON, consume
    that too. If it isn't, there is a <span>parse
    error</span>.</p>

    <p>If one or more characters match the range, then take them all
    and interpret the string of characters as a number (either
    hexadecimal or decimal as appropriate), and return a character
    token for the Unicode character whose code point is that number. If
    the number is not a valid Unicode character (e.g. if the number is
    higher than 1114111), or if the number is zero, then return a
    character token for the U+FFFD REPLACEMENT CHARACTER character
    instead.</p>

   </dd>

   <dt>Anything else</dt>

   <dd>

    <p>Consume the maximum number of characters possible, with the
    consumed characters case-sensitively matching one of the
    identifiers in the first column of the <span>entities</span>
    table.</p>

    <p>If no match can be made, then this is a <span>parse
    error</span>. No characters are consumed, and nothing is
    returned.</p>

    <p>Otherwise, if the next character is a U+003B SEMICOLON, consume
    that too. If it isn't, there is a <span>parse
    error</span>.</p>

    <p>Return a character token for the character corresponding to the
    entity name (as given by the second column of the
    <span>entities</span> table).</p>

    <div class="example">

     <p>If the markup contains <code title="">I'm &amp;notit without
     you</code>, the entity is parsed as "not", as in, <code title="">I'm
     &not;it without you</code>. But if the markup was <code title="">I'm
     &amp;notin without you</code>, the entity would be parsed as
     "notin", resulting in <code title="">I'm &notin; without you</code>.</p>

    </div>

   </dd>

  </dl>

  <p class="big-issue">This isn't quite right. For some entities, UAs
  require a semicolon, for others they don't. We probably need to do
  the same for backwards compatibility. If we do that we might be able
  to add more entities, e.g. for mathematics. Probably the way to mark
  whether or not an entity requires a semicolon is with an additional
  column in the <span title="entities">entity table lower
  down</span>.</p>

  <!--
XXX
handle entities in the Win1252 range...
http://trac.webkit.org/projects/webkit/browser/trunk/WebCore/html/HTMLTokenizer.cpp#L101
  -->


  <h4><dfn>Tree construction</dfn></h4>

  <p>The input to the tree construction stage is a sequence of tokens
  from the <span>tokenisation</span> stage. The tree construction
  stage is associated with a DOM <code>Document</code> object when a
  parser is created. The "output" of this stage consists of
  dynamically modifying or extending that document's DOM tree.</p>

  <p>Tree construction passes through several phases. Initially, UAs
  must act according to the steps described as being those of
  <span>the initial phase</span>.</p>

  <p>This specification does not define when an interactive user agent
  has to render the <code>Document</code> available to the user, or
  when it has to begin accepting user input.</p>

  <p>When the steps below require the UA to <dfn>append a
  character</dfn> to a node, the UA must collect it and all subsequent
  consecutive characters that would be appended to that node, and
  insert one <code>Text</code> node whose data is the concatenation of
  all those characters.</p>

  <p id="mutation-during-parsing">DOM mutation events must not fire
  for changes caused by the UA parsing the document. (Conceptually,
  the parser is not mutating the DOM, it is constructing it.) This
  includes the parsing of any content inserted using <code
  title="dom-document-write-HTML">document.write()</code> and <code
  title="dom-document-writeln">document.writeln()</code> calls.<!--
  XXX xref --> <a href="#refsDOM3Events">[DOM3EVENTS]</a></p><!-- XXX
  what abotu innerHTML? -->

  <p class="note">Not all of the tag names mentioned below are
  conformant tag names in this specification; many are included to
  handle legacy content. They still form part of the algorithm that
  implementations are required to implement to claim conformance.</p>

  <p class="note">The algorithm described below places no limit on the
  depth of the DOM tree generated, or on the length of tag names,
  attribute names, attribute values, text nodes, etc. While
  implementators are encouraged to avoid arbitrary limits, it is
  recognised that <a href="#hardwareLimitations">practical
  concerns</a> will likely force user agents to impose nesting
  depths.</p>


  <h5><dfn>The initial phase</dfn></h5>

  <p>Initially, the tree construction stage must handle each token
  emitted from the <span>tokenisation</span> stage as follows:</p>

  <dl class="switch">

   <dt>A DOCTYPE token that is marked as being in error</dt>
   <dt>A comment token</dt>
   <dt>A start tag token</dt>
   <dt>An end tag token</dt>
   <dt>A character token that is not one of one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000B LINE TABULATION, U+000C
   FORM FEED (FF), or U+0020 SPACE</dt>
   <dt>An end-of-file token</dt>

   <dd>

    <p>This specification does not define how to handle this case. In
    particular, user agents may ignore the entirety of this
    specification altogether for such documents, and instead invoke
    special parse modes with a greater emphasis on backwards
    compatibility.</p>

    <div class="note">
     <p>Browsers in particular have generally used DOCTYPE-based
     sniffing to invoke an "alternative conformance mode" known as
     <em>quirks mode</em> on certain documents. In this mode, emphasis
     is put on legacy compatibility rather than on standards
     compliance. This specification takes no position on this
     behaviour; documents without DOCTYPEs or with DOCTYPEs that do
     not conform to the syntax allowed by this specification are
     considered to be out of scope of this specification.</p>
    </div>

    <div class="big-issue">

     <p>As far as parsing goes, the quirks I know of are:</p>

     <ul>

      <li>Comment parsing is different.</li>

      <li>The following is considered one script block (!):
       <pre>&lt;script>&lt;!-- document.write('&lt;/script>'); -->&lt;/script></pre>
      </li>

      <li><code title="">&lt;/br></code> and <code title="">&lt;/p></code> do magical
      things.</li>

      <li><code>p</code> can contain <code>table</code></li>

      <li>Safari and IE have special parsing rules for &lt;% ... %&gt;
      (even in standards mode, though clearly this should be
      quirks-only).</li>

     </ul>

     <p>Maybe we should just adopt all those and be done with it. One
     parsing mode to rule them all. Or legitimise/codify the quirks
     mode parsing in some way.</p>

     <p>Would be interesting to do a search to see how many pages hit
     each of the above.</p> <!-- biased by page rank? -->

    </div>

   </dd>


   <dt>A DOCTYPE token marked as being correct</dt>
   <dd>

    <p>Append a <code>DocumentType</code> node to the
    <code>Document</code> node, with the <code title="">name</code>
    attribute set to the name given in the DOCTYPE token (which will
    be "HTML"), and the other attributes specific to
    <code>DocumentType</code> objects set to null, empty lists, or the
    empty string as appropriate.</p>

    <p>Then, switch to <span>the root element phase</span> of the tree
    construction stage.</p>

    <!-- XXX should set doctype on the Document object, too, unless
    spec is defined to already point to it if you append -->

   </dd>

   <dt>A character token that <em>is</em> one of one of U+0009
   CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
   TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
   <dd>
    <p><span title="append a character">Append that character</span>
    to the <code>Document</code> node.</p>
   </dd>

  </dl>


  <h5><dfn>The root element phase</dfn></h5>

  <p>After <span>the initial phase</span>, as each token is emitted
  from the <span>tokenisation</span> stage, it must be processed as
  described in this section.</p>

  <dl class="switch">

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p>Append a <code>Comment</code> node to the <code>Document</code>
    object with the <code title="">data</code> attribute set to the
    data given in the comment token.</p>
   </dd>

   <dt>A character token that is one of one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000B LINE TABULATION, U+000C
   FORM FEED (FF), or U+0020 SPACE</dt>
   <dd>
    <p><span title="append a character">Append that character</span>
    to the <code>Document</code> node.</p>
   </dd>

   <dt>A character token that is <em>not</em> one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000B LINE TABULATION, U+000C
   FORM FEED (FF), or U+0020 SPACE</dt>
   <dt>A start tag token</dt>
   <dt>An end tag token</dt>
   <dt>An end-of-file token</dt>
   <dd>
    <p>Create an <code>HTMLElement</code> node with the tag name
    <code>html</code>, in the <span>HTML namespace</span>. Append it
    to the <code>Document</code> object. Switch to <span>the main
    phase</span> and reprocess the current token.</p>

    <p class="big-issue">Should probably make end tags be ignored, so
    that "&lt;/head>&lt;!-- -->&lt;html>" puts the comment befor the
    root node (or should we?)</p>

   </dd>

  </dl>

  <p>The root element can end up being removed from the
  <code>Document</code> object, e.g. by scripts; nothing in particular
  happens in such cases, content continues being appended to the nodes
  as described in the next section.</p>


  <h5><dfn>The main phase</dfn></h5>

  <p>After <span>the root element phase</span>, each token emitted
  from the <span>tokenisation</span> stage must be processed as
  described in <em>this</em> section. This is by far the most involved
  part of parsing an HTML document.</p>

  <p>The tree construction stage in this phase has several pieces of
  state: a <span>stack of open elements</span>, a <span>list of active
  formatting elements</span>, a <span><code title="">head</code>
  element pointer</span>, a <span><code title="">form</code> element
  pointer</span>, and an <span>insertion mode</span>.</p>

  <p class="big-issue">We could just fold insertion modes and phases
  into one concept (and duplicate the two rules common to all
  insertion modes into all of them).</p>


  <h6>The stack of open elements</h6>

  <p>Initially the <dfn>stack of open elements</dfn> contains just the
  <code>html</code> root element node created in the <span title="the
  root element phase">last phase</span> before switching to
  <em>this</em> phase (or, in the <span><code>innerHTML</code>
  case</span>, the <code>html</code> element created to represent the
  element whose <code title="dom-innerHTML-HTML">innerHTML</code>
  attribute is being set). That's the topmost node of the stack. It
  never gets popped off the stack. (This stack grows downwards.)</p>

  <p>The <dfn>current node</dfn> is the bottommost node in this
  stack.</p>

  <p>Elements in the stack fall into the following categories:</p>

  <dl>

   <dt><dfn>Special</dfn></dt>
   <dd><p>The following HTML elements have varying levels of special
   parsing rules: <code>address</code>, <code>area</code>,
   <code>base</code>, <code>basefont</code>, <code>bgsound</code>,
   <code>blockquote</code>, <code>body</code>, <code>br</code>,
   <code>center</code>, <code>col</code>, <code>colgroup</code>,
   <code>dd</code>, <code>dir</code>, <code>div</code>,
   <code>dl</code>, <code>dt</code>, <code>embed</code>,
   <code>fieldset</code>, <code>form</code>, <code>frame</code>,
   <code>frameset</code>, <code>h1</code>, <code>h2</code>,
   <code>h3</code>, <code>h4</code>, <code>h5</code>, <code>h6</code>,
   <code>head</code>, <code>hr</code>, <code>iframe</code>,
   <code>image</code><!-- XXX ? this isn't an element that can end up
   on the stack-->, <code>img</code>, <code>input</code>,
   <code>isindex</code>, <code>li</code>, <code>link</code>,
   <code>listing</code>, <code>menu</code>, <code>meta</code>,
   <code>noembed</code>, <code>noframes</code>, <code>noscript</code>,
   <code>ol</code>, <code>optgroup</code>, <code>option</code>,
   <code>p</code>, <code>param</code>, <code>plaintext</code>,
   <code>pre</code>, <code>script</code>, <code>select</code>,
   <code>spacer</code>, <code>style</code>, <code>tbody</code>,
   <code>textarea</code>, <code>tfoot</code>, <code>thead</code>,
   <code>title</code>, <code>tr</code>, <code>ul</code>, and
   <code>wbr</code>.</p></dd>

   <dt><dfn>Scoping</dfn></dt>
   <dd><p>The following HTML elements introduce new <span title="has
   an element in scope">scopes</span> for various parts of the
   parsing: <code>button</code>, <code>caption</code>,
   <code>html</code>, <code>marquee</code>, <code>object</code>,
   <code>table</code>, <code>td</code> and <code>th</code>.</p></dd>

   <dt><dfn>Formatting</dfn></dt>
   <dd><p>The following HTML elements are those that end up in the
   <span>list of active formatting elements</span>: <code>a</code>,
   <code>b</code>, <code>big</code>, <code>em</code>,
   <code>font</code>, <code>i</code>, <code>nobr</code>,
   <code>s</code>, <code>small</code>, <code>strike</code>,
   <code>strong</code>, <code>tt</code>, and <code>u</code>.</p></dd>

   <dt><dfn>Phrasing</dfn></dt>
   <dd><p>All other elements found while parsing an HTML
   document.</p></dd>

  </dl>

  <p class="big-issue">Still need to add these new elements to the
  lists: <code>event-source</code>, <code>section</code>,
  <code>nav</code>, <code>article</code>, <code>aside</code>,
  <code>header</code>, <code>footer</code>, <code>datagrid</code>,
  <code>command</code></p>

  <p>The <span>stack of open elements</span> is said to <dfn
  title="has an element in scope">have an element in scope</dfn> or
  <dfn title="has an element in table scope">have an element in
  <em>table scope</em></dfn> when the following algorithm terminates
  in a match state:</p>

  <ol>

   <li><p>Initialise <var title="">node</var> to be the <span>current
   node</span> (the bottommost node of the stack).</p></li>

   <li><p>If <var title="">node</var> is the target node, terminate in a match
   state.</p></li>

   <li><p>Otherwise, if <var title="">node</var> is a <code>table</code>
   element, terminate in a failure state.</p></li>

   <li><p>Otherwise, if the algorithm is the "has an element in scope"
   variant (rather than the "has an element in table scope" variant),
   and <var title="">node</var> is one of the following, terminate in a failure
   state:</p>
    <ul class="brief">
     <li><code>caption</code></li>
     <li><code>td</code></li>
     <li><code>th</code></li>
     <li><code>button</code></li>
     <li><code>marquee</code></li>
     <li><code>object</code></li>
    </ul>
   </li>

   <li><p>Otherwise, if <var title="">node</var> is an <code>html</code>
   element, terminate in a failure state. (This can only happen if the
   <var title="">node</var> is the topmost node of the <span>stack of open
   elements</span>, and prevents the next step from being invoked if
   there are no more elements in the stack.)</p></li>

   <li><p>Otherwise, set <var title="">node</var> to the previous entry in the
   <span>stack of open elements</span> and return to step 2. (This
   will never fail, since the loop will always terminate in the
   previous step if the top of the stack is reached.)</p></li>

  </ol>

  <p>Nothing happens if at any time any of the elements in the
  <span>stack of open elements</span> are moved to a new location in,
  or removed from, the <code>Document</code> tree. In particular, the
  stack is not changed in this situation. This can cause, amongst
  other strange effects, content to be appended to nodes that are no
  longer in the DOM.</p>

  <p class="note">In some cases (namely, when <a
  href="#adoptionAgency">closing misnested formatting elements</a>),
  the stack is manipulated in a random-access fashion.</p>


  <h6>The list of active formatting elements</h6>

  <p>Initially the <dfn>list of active formatting elements</dfn> is
  empty. It is used to handle mis-nested <span
  title="formatting">formatting element tags</span>.</p>

  <p>The list contains elements in the <span>formatting</span>
  category, and scope markers. The scope markers are inserted when
  entering buttons, <code>object</code> elements, marquees, table
  cells, and table captions, and are used to prevent formatting from
  "leaking" into tables, buttons, <code>object</code> elements, and
  marquees.</p>

  <p>When the steps below require the UA to <dfn>reconstruct the
  active formatting elements</dfn>, the UA must perform the following
  steps:</p>

  <ol>

   <li>If there are no entries in the <span>list of active formatting
   elements</span>, then there is nothing to reconstruct; stop this
   algorithm.</li>

   <li>If the last (most recently added) entry in the <span>list of
   active formatting elements</span> is a marker, or if it is an
   element that is in the <span>stack of open elements</span>, then
   there is nothing to reconstruct; stop this algorithm.</li>

   <li>Let <var title="">entry</var> be the last (most recently added)
   element in the <span>list of active formatting
   elements</span>.</li>

   <li>If there are no entries before <var title="">entry</var> in the
   <span>list of active formatting elements</span>, then jump to step
   8.</li>

   <li>Let <var title="">entry</var> be the entry one earlier than
   <var title="">entry</var> in the <span>list of active formatting
   elements</span>.</li>

   <li>If <var title="">entry</var> is neither a marker nor an element
   that is also in the <span>stack of open elements</span>, go to step
   4.</li>

   <li>Let <var title="">entry</var> be the element one later than
   <var title="">entry</var> in the <span>list of active formatting
   elements</span>.</li>

   <li>Perform a shallow clone of the element <var title="">entry</var> to
   obtain <var title="">clone</var>. <a
   href="#refsDOM3CORE">[DOM3CORE]</a></li>

   <li>Append <var title="">clone</var> to the <span>current
   node</span> and push it onto the <span>stack of open
   elements</span> so that it is the new <span>current
   node</span>.</li>

   <li>Replace the entry for <var title="">entry</var> in the list
   with an entry for <var title="">clone</var>.</li>

   <li>If the entry for <var title="">clone</var> in the <span>list of
   active formatting elements</span> is not the last entry in the
   list, return to step 7.</li>

  </ol>

  <p>This has the effect of reopening all the formatting elements that
  were opened in the current body, cell, or caption (whichever is
  youngest) that haven't been explicitly closed.</p>

  <p class="note">The way this specification is written, the
  <span>list of active formatting elements</span> always consists of
  elements in chronological order with the least recently added
  element first and the most recently added element last (except for
  while steps 8 to 11 of the above algorithm are being executed, of
  course).</p>

  <p>When the steps below require the UA to <dfn>clear the list of
  active formatting elements up to the last marker</dfn>, the UA must
  perform the following steps:</p>

  <ol>

   <li>Let <var title="">entry</var> be the last (most recently added)
   entry in the <span>list of active formatting elements</span>.</li>

   <li>Remove <var title="">entry</var> from the <span>list of active
   formatting elements</span>.</li>

   <li>If <var title="">entry</var> was a marker, then stop the
   algorithm at this point. The list has been cleared up to the last
   marker.</li>

   <li>Go to step 1.</li>

  </ol>


  <h6>Creating and inserting HTML elements</h6>

  <p>When the steps below require the UA to <dfn title="create an
  element for the token">create an element for a token</dfn>, the UA
  must create a node implementing the interface appropriate for the
  element type corresponding to the tag name of the token (as given in
  the section of this specification that defines that element,
  e.g. for an <code>a</code> element it would be the
  <code>HTMLAnchorElement</code> interface), with the tag name being
  the name of that element, with the node being in the <span>HTML
  namespace</span>, and with the attributes on the node being those
  given in the given token.</p>

  <p>When the steps below require the UA to <dfn>insert an HTML
  element</dfn> for a token, the UA must first <span>create an element
  for the token</span>, and then append this node to the <span>current
  node</span>, and push it onto the <span>stack of open
  elements</span> so that it is the new <span>current node</span>.</p>

  <p>The steps below may also require that the UA insert an HTML
  element in a particular place, in which case the UA must
  <span>create an element for the token</span> and then insert or
  append the new node in the location specified. (This happens in
  particular during the parsing of tables with invalid content.)</p>

  <p>The interface appropriate for an element that is not defined in
  this specification is <code>HTMLElement</code>.</p>


  <h6>Closing elements that have implied end tags</h6>

  <p>When the steps below require the UA to <dfn>generate implied end
  tags</dfn>, then, if the <span>current node</span> is a
  <code>dd</code> element, a <code>dt</code> element, an
  <code>li</code> element, a <code>p</code> element, a <code>td</code>
  element, a <code>th</code> element, or a <code>tr</code> element,
  the UA must act as if an end tag with the respective tag name had
  been seen and then <span>generate implied end tags</span> again.</p>

  <p>The step that requires the UA to generate implied end tags but
  lists an element to exclude from the process, then the UA must
  perform the above steps as if that element was not in the above
  list.</p>


  <h6>The element pointers</h6>

  <p>Initially the <dfn><code title="">head</code> element
  pointer</dfn> and the <dfn><code title="">form</code> element
  pointer</dfn> are both null.</p>

  <p>Once a <code>head</code> element has been parsed (whether
  implicitly or explicitly) the <span><code title="">head</code>
  element pointer</span> gets set to point to this node.</p>

  <p>The <span><code title="">form</code> element pointer</span>
  points to the last <code>form</code> element that was opened and
  whose end tag has not yet been seen. It is used to make form
  controls associate with forms in the face of dramatically bad
  markup, for historical reasons.</p>


  <h6>The insertion mode</h6>

  <p>Initially the <dfn>insertion mode</dfn> is "<span
  title="insertion mode: before head">before head</span>". It can
  change to "<span title="insertion mode: in head">in head</span>",
  "<span title="insertion mode: after head">after head</span>", "<span
  title="insertion mode: in body">in body</span>", "<span
  title="insertion mode: in table">in table</span>", "<span
  title="insertion mode: in caption">in caption</span>", "<span
  title="insertion mode: in column group">in column group</span>",
  "<span title="insertion mode: in table body">in table body</span>",
  "<span title="insertion mode: in row">in row</span>", "<span
  title="insertion mode: in cell">in cell</span>", "<span
  title="insertion mode: in select">in select</span>", "<span
  title="insertion mode: after body">after body</span>", "<span
  title="insertion mode: in frameset">in frameset</span>", and "<span
  title="insertion mode: after frameset">after frameset</span>" during
  the course of the parsing, as described below. It affects how
  certain tokens are processed.</p>

  <p>If the tree construction stage is switched from <span>the main
  phase</span> to <span>the trailing end phase</span> and back again,
  the various pieces of state are not reset; the UA must act as if the
  state was maintained.</p>

  <p>When the steps below require the UA to <dfn>reset the insertion
  mode appropriately</dfn>, it means the UA must follow these
  steps:</p>

  <ol>

   <li>Let <var title="">last</var> be false.</li>

   <li>Let <var title="">node</var> be the last node in the
   <span>stack of open elements</span>.</li>

   <li>If <var title="">node</var> is the first node in the stack of
   open elements, then set <var title="">last</var> to true. If the
   element whose <code title="dom-innerHTML-HTML">innerHTML</code>
   attribute is being set is neither a <code>td</code> element nor a
   <code>th</code> element, then set <var title="">node</var> to the
   element whose <code title="dom-innerHTML-HTML">innerHTML</code>
   attribute is being set. (<span><code>innerHTML</code>
   case</span>)</li>

   <li>If <var title="">node</var> is a <code>select</code> element,
   then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in select">in select</span>" and abort these
   steps. (<span><code>innerHTML</code> case</span>)</li>

   <li>If <var title="">node</var> is a <code>td</code> or
   <code>th</code> element, then switch the <span>insertion
   mode</span> to "<span title="insertion mode: in cell">in
   cell</span>" and abort these steps.</li>

   <li>If <var title="">node</var> is a <code>tr</code> element, then
   switch the <span>insertion mode</span> to "<span title="insertion
   mode: in row">in row</span>" and abort these steps.</li>

   <li>If <var title="">node</var> is a <code>tbody</code>,
   <code>thead</code>, or <code>tfoot</code> element, then switch the
   <span>insertion mode</span> to "<span title="insertion mode: in
   table body">in table body</span>" and abort these steps.</li>

   <li>If <var title="">node</var> is a <code>caption</code> element,
   then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in caption">in caption</span>" and abort
   these steps.</li>

   <li>If <var title="">node</var> is a <code>colgroup</code> element,
   then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in column group">in column group</span>" and
   abort these steps. (<span><code>innerHTML</code> case</span>)</li>

   <li>If <var title="">node</var> is a <code>table</code> element,
   then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in table">in table</span>" and abort these
   steps.</li>

   <li>If <var title="">node</var> is a <code>head</code> element,
   then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in body">in body</span>" ("<span
   title="insertion mode: in body">in body</span>"! <em> not "<span
   title="insertion mode: in head">in head</span>"</em>!) and abort
   these steps. (<span><code>innerHTML</code> case</span>)</li>

   <li>If <var title="">node</var> is a <code>body</code> element,
   then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in body">in body</span>" and abort these
   steps.</li>

   <li>If <var title="">node</var> is a <code>frameset</code> element,
   then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in frameset">in frameset</span>" and abort
   these steps. (<span><code>innerHTML</code> case</span>)</li>

   <li>If <var title="">node</var> is an <code>html</code> element,
   then: if the <span><code title="">head</code> element
   pointer</span> is null, switch the <span>insertion mode</span> to
   "<span title="insertion mode: before head">before head</span>",
   otherwise, switch the <span>insertion mode</span> to "<span
   title="insertion mode: after head">after head</span>". In either
   case, abort these steps. (<span><code>innerHTML</code>
   case</span>)</li> <!-- XXX can the head element pointer ever be
   non-null when we're going through these steps? -->

   <li>If <var title="">last</var> is true, then set the
   <span>insertion mode</span> to "<span title="insertion mode: in
   body">in body</span>" and abort these
   steps. (<span><code>innerHTML</code> case</span>)</li>

   <li>Let <var title="">node</var> now be the node before <var
   title="">node</var> in the <span>stack of open
   elements</span>.</li>

   <li>Return to step 3.</li>

  </ol>

<!--When you don't have to handle innerHTML, you can use this
simplified explanation instead:

  <ol>

   <li><p>If the <span>stack of open elements</span> <span title="has
   an element in table scope">has a <code>td</code> or <code>th</code>
   element in table scope</span>, then switch the <span>insertion
   mode</span> to "<span title="insertion mode: in cell">in
   cell</span>".</p></li>

   <li><p>Otherwise, if the <span>stack of open elements</span> <span
   title="has an element in table scope">has a <code>tr</code> element
   in table scope</span>, then switch the <span>insertion mode</span>
   to "<span title="insertion mode: in row">in row</span>".</p></li>

   <li><p>Otherwise, if the <span>stack of open elements</span> <span
   title="has an element in table scope">has a <code>tbody</code>,
   <code>tfoot</code>, or <code>thead</code> element in table
   scope</span>, then switch the <span>insertion mode</span> to "<span
   title="insertion mode: in table body">in table
   body</span>".</p></li>

   <li><p>Otherwise, if the <span>stack of open elements</span> <span
   title="has an element in table scope">has a <code>caption</code>
   element in table scope</span>, then switch the <span>insertion
   mode</span> to "<span title="insertion mode: in caption">in
   caption</span>".</p></li>

   ( you can't reach this point with a colgroup element on the
   stack )

   <li><p>Otherwise, if the <span>stack of open elements</span> <span
   title="has an element in table scope">has a <code>table</code>
   element in table scope</span>, then switch the <span>insertion
   mode</span> to "<span title="insertion mode: in table">in
   table</span>".</p></li>

   <li><p>Otherwise, switch the <span>insertion mode</span> to "<span
   title="insertion mode: in body">in body</span>".</p></li>

  </ol>
-->


  <h6>How to handle tokens in the main phase</h6>

  <p>Tokens in the main phase must be handled as follows:</p>

  <dl class="switch">

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A start tag token with the tag name "html"</dt>
   <dd>
    <p>If this start tag token was not the first start tag token, then
    it is a <span>parse error</span>.</p>
    <p>For each attribute on the token, check to see if the attribute
    is already present on the top element of the <span>stack of open
    elements</span>. If it is not, add the attribute and its
    corresponding value to that element.</p>
   </dd>

   <dt>An end-of-file token</dt>
   <dd>

    <p><span>Generate implied end tags.</span></p>

    <p>If there are more than two nodes on the <span>stack of open
    elements</span>, or if there are two nodes but the second node is
    not a <code>body</code> node, this is a <span>parse
    error</span>.</p>

    <p>Otherwise, if the parser was originally created in order to
    handle the setting of an element's <code
    title="dom-innerHTML-HTML">innerHTML</code> attribute, and there's
    more than one element in the <span>stack of open elements</span>,
    and the second node on the <span>stack of open elements</span> is
    not a <code>body</code> node, then this is a <span>parse
    error</span>. (<span><code>innerHTML</code> case</span>)</p>

    <p><span>Stop parsing.</span></p>

    <p class="big-issue">This fails because it doesn't imply HEAD and
    BODY tags. We should probably expand out the insertion modes and
    merge them with phases and then put the three things here into
    each insertion mode instead of trying to factor them out so
    carefully.</p>

   </dd>

   <dt>Anything else</dt>
   <dd>

    <p>Depends on the <span>insertion mode</span>:</p>

    <dl class="switch">

     <dt>If the <span>insertion mode</span> is "<dfn title="insertion mode: before head">before head</dfn>"</dt>
     <dd>

      <p>Handle the token as follows:</p>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p><span title="append a character">Append the character</span> to
        the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag token with the tag name "head"</dt>
       <dd>

        <p><span>Create an element for the token</span>.</p>

        <p>Set the <span><code title="">head</code> element
        pointer</span> to this new element node.</p>

        <p>Append the new element to the <span>current node</span> and
        push it onto the <span>stack of open elements</span>.</p>

        <p>Change the <span>insertion mode</span> to "<span
        title="insertion mode: in head">in head</span>".</p>

       </dd>

       <dt>A start tag token whose tag name is one of: "base", "link",
       "meta", "script", "style", "title"</dt>

       <dd>

        <p>Act as if a start tag token with the tag name "head" and no
        attributes had been seen, then reprocess the current
        token.</p>

        <p class="note">This will result in a <code>head</code>
        element being generated, and with the current token being
        reprocessed in the "<span title="insertion mode: in head">in
        head</span>" <span>insertion mode</span>.</p>

       </dd>

       <dt>An end tag with the tag name "html"</dt>
       <dd>

        <p>Act as if a start tag token with the tag name "head" and no
        attributes had been seen, then reprocess the current
        token.</p>

       </dd>

       <dt>Any other end tag</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>A character token that is <em>not</em> one of U+0009 CHARACTER
       TABULATION, U+000A LINE FEED (LF), U+000B LINE TABULATION, U+000C
       FORM FEED (FF), or U+0020 SPACE</dt>
       <dt>Any other start tag token</dt>
       <dd>

        <p>Act as if a start tag token with the tag name "head" and no
        attributes had been seen, then reprocess the current
        token.</p>

        <p class="note">This will result in an empty <code>head</code>
        element being generated, with the current token being
        reprocessed in the "<span title="insertion mode: after
        head">after head</span>" <span>insertion mode</span>.</p>

       </dd>

      </dl>

     </dd>


     <dt id="parsing-main-inhead">If the <span>insertion mode</span> is "<dfn title="insertion mode: in head">in head</dfn>"</dt>
     <dd>

      <p>Handle the token as follows.</p>

      <p class="note">The rules for handling "title", "style", and
      "script" start tags are similar, but not identical.</p>

      <p class="note">It is possible for the <span>tree
      construction</span> stage's <span title="the main phase">main
      phase</span> to be in the "<span title="insertion mode: in
      head">in head</span>" <span>insertion mode</span> without the
      <span>current node</span> being a <code>head</code> element,
      e.g. if a <code>head</code> end tag is immediately followed by a
      <code>meta</code> start tag.</p>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p><span title="append a character">Append the character</span> to
        the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag with the tag name "title"</dt>
       <dd>

        <p><span>Create an element for the token</span>.</p>

        <p>Append the new element to the node pointed to by the
        <span><code title="">head</code> element pointer</span>, or,
        if that is null (<span><code>innerHTML</code> case</span>), to
        the <span>current node</span>.</p>

        <p>Switch the tokeniser's <span>content model flag</span> to
        the RCDATA state.</p>

        <p>Then, collect all the character tokens that the tokeniser
        returns until it returns a token that is not a character
        token.</p>

        <p>If this process resulted in a collection of character
        tokens, append a single <code>Text</code> node to the
        <code>title</code> element node whose contents is the
        concatenation of all those tokens' characters.</p>

        <p>The tokeniser's <span>content model flag</span> will have
        switched back to the PCDATA state.</p>

        <p>If the next token is an end tag token with the tag name
        "title", ignore it. Otherwise, this is a <span>parse error</span>.</p>

       </dd>

       <dt>A start tag with the tag name "style"</dt>
       <dd>

        <p><span>Create an element for the token</span>.</p>

        <p>Append the new element to the <span>current node</span>,
        unless the <span>insertion mode</span> is "<span
        title="insertion mode: in head">in head</span>" and the
        <span><code title="">head</code> element pointer</span> is not
        null, in which case append it to the node pointed to by the
        <span><code title="">head</code> element pointer</span>. <!--
        <head></head><style><body> should put the style block in the
        head, and does so by switching back to in head, but the head
        isn't the current node at that point (comments should go
        between the head and the body) -->.</p>

        <p>Switch the tokeniser's <span>content model flag</span> to
        the CDATA state.</p>

        <p>Then, collect all the character tokens that the tokeniser
        returns until it returns a token that is not a character
        token, or until it stops tokenising.</p>

        <p>If this process resulted in a collection of character
        tokens, append a single <code>Text</code> node to the
        <code>style</code> element node whose contents is the
        concatenation of all those tokens' characters.</p>

        <p>The tokeniser's <span>content model flag</span> will have
        switched back to the PCDATA state.</p>

        <p>If the next token is an end tag token with the tag name
        "style", ignore it. Otherwise, this is a <span>parse error</span>.</p>

       </dd>

       <dt id="scriptTag">A start tag with the tag name "script"</dt>
       <dd>

        <p><span>Create an element for the token</span>.</p>

        <p>Mark the element as being
        <span>"parser-inserted"</span>. This ensures that, if the
        script is external, any <code
        title="dom-document-write-HTML">document.write()</code> calls
        in the script will execute in-line, instead of blowing the
        document away, as would happen in most other cases.</p>

        <p>Switch the tokeniser's <span>content model flag</span> to
        the CDATA state.</p>

        <p>Then, collect all the character tokens that the tokeniser
        returns until it returns a token that is not a character
        token, or until it stops tokenising.</p>

        <p>If this process resulted in a collection of character
        tokens, append a single <code>Text</code> node to the
        <code>script</code> element node whose contents is the
        concatenation of all those tokens' characters.</p>

        <p>The tokeniser's <span>content model flag</span> will have
        switched back to the PCDATA state.</p>

        <p>If the next token is not an end tag token with the tag name
        "script", then this is a <span>parse error</span>; mark the
        <code>script</code> element as <span>"already
        executed"</span>. Otherwise, the token is the
        <code>script</code> element's end tag, so ignore it.</p>

        <p>If the parser was originally created in order to handle the
        setting of a node's <code
        title="dom-innerHTML-HTML">innerHTML</code> attribute, then
        mark the <code>script</code> element as <span>"already
        executed"</span>, and skip the rest of the processing
        described for this token (including the part below where
        "<span title="the script that will execute as soon as the
        parser resumes">scripts that will execute as soon as the
        parser resumes</span>" are
        executed). (<span><code>innerHTML</code> case</span>)</p>

        <p class="note">Marking the <code>script</code> element as
        "already executed" prevents it from executing when it is
        inserted into the document a few paragraphs below. Scripts
        missing their end tags and scripts that were inserted using
        <code title="dom-innerHTML-HTML">innerHTML</code> aren't
        executed.</p>

        <p>Let the <var title="">old insertion point</var> have the
        same value as the current <span>insertion point</span>. Let
        the <span>insertion point</span> be just before the <span>next
        input character</span>.</p>

        <p>Append the new element to the <span>current node</span>,
        unless the <span>insertion mode</span> is "<span
        title="insertion mode: in head">in head</span>" and the
        <span><code title="">head</code> element pointer</span> is not
        null, in which case append it to the node pointed to by the
        <span><code title="">head</code> element pointer</span>. <!--
        <head></head><script><body> should put the script in the head,
        and does so by switching back to in head, but the head isn't
        the current node at that point (comments should go between the
        head and the body) --> <span title="running a script">Special
        processing occurs when a <code>script</code> element is
        inserted into a document</span> that might cause some script
        to execute, which might cause <span
        title="dom-document-write-HTML">new characters to be inserted
        into the tokeniser</span>.</p>

        <p>Let the <span>insertion point</span> have the value of the
        <var title="">old insertion point</var>. (In other words,
        restore the <span>insertion point</span> to the value it had
        before the previous paragraph. This value might be the
        "undefined" value.)</p>

        <p id="scriptTagParserResumes">At this stage, if there is
        <span title="the script that will execute as soon as the
        parser resumes">a script that will execute as soon as the
        parser resumes</span>, then:</p>

        <dl class="switch">

         <dt>If the tree construction stage is <a
         href="#nestedParsing">being called reentrantly</a>, say from
         a call to <code
         title="dom-document-write-HTML">document.write()</code>:</dt>

         <dd><p>Abort the processing of any nested invokations of the
         tokeniser, yielding control back to the caller. (Tokenisation
         will resume when the caller returns to the "outer" tree
         construction stage.)</p></dd>

         <dt>Otherwise:</dt>

         <dd>

          <p>Follow these steps:</p>

          <ol>

           <li><p>Let <var title="">the script</var> be <span>the
           script that will execute as soon as the parser
           resumes</span>. There is no longer <span title="the script
           that will execute as soon as the parser resumes">a script
           that will execute as soon as the parser
           resumes</span>.</p></li>

           <li><p><span>Pause</span> until the script has <span>completed
           loading</span><!-- XXX xref -->.</p></li>

           <li><p>Let the <span>insertion point</span> be just before the
           <span>next input character</span>.</p></li>

           <li><p><span title="executing a script block">Execute the
           script</span>.</p></li>

           <li><p>Let the <span>insertion point</span> be undefined
           again.</p></li>

           <li><p>If there is once again <span title="the script that
           will execute as soon as the parser resumes">a script that
           will execute as soon as the parser resumes</span>, then
           repeat these steps from step 1.</p></li>

          </ol>

         </dd>

        </dl>

       </dd>

       <dt>A start tag with the tag name "base", "link", or "meta"</dt>
       <dd>

        <p><span>Create an element for the token</span>.</p>

        <p>Append the new element to the node pointed to by the
        <span><code title="">head</code> element pointer</span>, or,
        if that is null (<span><code>innerHTML</code> case</span>), to
        the <span>current node</span>.</p>

        <p class="big-issue">Need to cope with second and subsequent
        <code>base</code> elements affecting subsequent elements
        magically.</p>

       </dd>

       <dt>An end tag with the tag name "head"</dt>
       <dd>

        <p>If the <span>current node</span> is a <code>head</code>
        element, pop the <span>current node</span> off the <span>stack
        of open elements</span>. Otherwise, this is a <span>parse
        error</span>.</p> <!-- might happen if you see two </head>s
        and something in between the two sends you from "after head"
        back to "in head" -->

        <p>Change the <span>insertion mode</span> to "<span
        title="insertion mode: after head">after head</span>".</p>

       </dd>

       <dt>An end tag with the tag name "html"</dt>
       <dd>

        <p>Act as described in the "anything else" entry below.</p>

       </dd>

       <dt>A start tag with the tag name "head"</dt>
       <dt>Any other end tag</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>Anything else</dt>
       <dd>

        <p>If the <span>current node</span> is a <code>head</code>
        element, act as if an end tag token with the tag name "head" had
        been seen.</p>

        <p>Otherwise, change the <span>insertion mode</span> to "<span
        title="insertion mode: after head">after head</span>".</p>

        <p>Then, reprocess the current token.</p>

        <p class="big-issue">In certain UAs, <a
        href="https://bugzilla.mozilla.org/attachment.cgi?id=180157&amp;action=view">some
        elements</a> don't trigger the "in body" mode straight away,
        but instead get put into the head. Do we want to copy
        that?</p>

       </dd>

      </dl>

     </dd>


     <dt>If the <span>insertion mode</span> is "<dfn title="insertion mode: after head">after head</dfn>"</dt>
     <dd>

      <p>Handle the token as follows:</p>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p><span title="append a character">Append the character</span> to
        the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag token with the tag name "body"</dt>
       <dd>

        <p><span title="insert an HTML element">Insert a
        <code>body</code> element</span> for the token.</p>

        <p>Change the <span>insertion mode</span> to "<span
        title="insertion mode: in body">in body</span>".</p>

       </dd>

       <dt>A start tag token with the tag name "frameset"</dt>
       <dd>

        <p><span title="insert an HTML element">Insert a
        <code>frameset</code> element</span> for the token.</p>

        <p>Change the <span>insertion mode</span> to "<span
        title="insertion mode: in frameset">in frameset</span>".</p>

       </dd>

       <dt>A start tag token whose tag name is one of: "base", "link",
       "meta", "script", "style", "title"</dt>
       <dd>

        <p><span>Parse error</span>. Switch the <span>insertion
        mode</span> back to "<span title="insertion mode: in head">in
        head</span>" and reprocess the token.</p>

       </dd>

       <dt>Anything else</dt>
       <dd>
        <p>Act as if a start tag token with the tag name "body" and no
        attributes had been seen, and then reprocess the current
        token.</p>
       </dd>
      
      </dl>

     </dd>


     <dt id="parsing-main-inbody">If the <span>insertion mode</span> is "<dfn title="insertion mode: in body">in body</dfn>"</dt>
     <dd>

      <p>Handle the token as follows:</p>

      <dl class="switch">

       <dt>A character token</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span title="append a character">Append the token's
        character</span> to the <span>current node</span>.</p>

       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag token whose tag name is one of: "script", "style"</dt>
       <dd>
        <p>Process the token as if the <span>insertion mode</span> had
        been "<span title="insertion mode: in head">in head</span>".</p>
       </dd>

       <dt>A start tag token whose tag name is one of: "base", "link",
       "meta", "title"</dt>
       <dd>
        <p><span>Parse error</span>. Process the token as if the
        <span>insertion mode</span> had been "<span title="insertion
        mode: in head">in head</span>".</p>
       </dd>

       <dt>A start tag token with the tag name "body"</dt>
       <dd>

        <p><span>Parse error</span>.</p>

        <p>If the second element on the <span>stack of open
        elements</span> is not a <code>body</code> element, or, if the
        <span>stack of open elements</span> has only one node on it,
        then ignore the token. (<span><code>innerHTML</code>
        case</span>)</p>

        <p>Otherwise, for each attribute on the token, check to see if
        the attribute is already present on the <code>body</code>
        element (the second element) on the <span>stack of open
        elements</span>. If it is not, add the attribute and its
        corresponding value to that element.</p>

       </dd>

       <dt>An end tag with the tag name "body"</dt>
       <dd>

        <p>If the second element in the <span>stack of open
        elements</span> is not a <code>body</code> element, this is a
        <span>parse error</span>. Ignore the token.
        (<span><code>innerHTML</code> case</span>)</p>

        <p>Otherwise:</p>

        <p class="big-issue">this needs to handle closing of implied elements, but without closing them</p>

        <p>If the <span>current node</span> is not the
        <code>body</code> element, then this is a <span>parse
        error</span>.</p>

        <p>Change the <span>insertion mode</span> to "<span
        title="insertion mode: after body">after body</span>".</p>

       </dd>

       <dt>An end tag with the tag name "html"</dt>
       <dd>

        <p>Act as if an end tag with tag name "body" had been seen,
        then, if that token wasn't ignored, reprocess the current
        token.</p>

        <p class="note">The fake end tag token here can only be
        ignored in the <span><code>innerHTML</code> case</span>.</p>

       </dd>

       <dt>A start tag whose tag name is one of: "address",
       "blockquote", "center", "dir", "div", "dl", "fieldset",
       "listing", "menu", "ol", "p", "ul"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p>

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token.</p>

       </dd>

       <dt>A start tag whose tag name is "pre"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p>

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token.</p>

        <p>If the next token is a U+000A LINE FEED (LF) character
        token, then ignore that token and move on to the next
        one. (Newlines at the start of <code>pre</code> blocks are
        ignored as an authoring convenience.)</p>

       </dd>

       <dt>A start tag whose tag name is "form"</dt>
       <dd>

        <p>If the <span><code title="form">form</code> element
        pointer</span> is not null, ignore the token with a
        <span>parse error</span>.</p>

        <p>Otherwise:</p>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p>

        <p><span title="insert an html Element">Insert an HTML
        element</span> for the token, and set the <code
        title="form">form</code> element pointer to point to the
        element created.</p>

       </dd>

       <dt>A start tag whose tag name is "li"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p>

        <p>Run the following algorithm:</p>

        <ol>

         <li><p>Initialise <var title="">node</var> to be the <span>current
         node</span> (the bottommost node of the stack).</p></li>

         <li><p>If <var title="">node</var> is an <code>li</code> element, then
         pop all the nodes from the <span>current node</span> up to
         <var title="">node</var>, including <var title="">node</var>, then stop this
         algorithm.</p></li>

         <li><p>If <var title="">node</var> is not in the
         <span>formatting</span> category, and is not in the
         <span>phrasing</span> category, and is not an
         <code>address</code> or <code>div</code> element, then stop
         this algorithm.</p></li> <!-- an element <foo> is in this
         list if the following markup:

             <!DOCTYPE html><body><ol><li><foo><li>

         ...results in the second <li> not being (in any way) a
         descendant of the first <li>, or if <foo> is a formatting
         element that gets reopened later. -->

         <li><p>Otherwise, set <var title="">node</var> to the previous entry
         in the <span>stack of open elements</span> and return to step
         2.</p></li>

        </ol>

        <p>Finally, <span title="insert an html element">insert an
        <code>li</code> element</span>.</p>

       </dd>

       <dt>A start tag whose tag name is "dd" or "dt"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p>

        <p>Run the following algorithm:</p>

        <ol>

         <li><p>Initialise <var title="">node</var> to be the <span>current
         node</span> (the bottommost node of the stack).</p></li>

         <li><p>If <var title="">node</var> is a <code>dd</code> or
         <code>dt</code> element, then pop all the nodes from the
         <span>current node</span> up to <var title="">node</var>, including
         <var title="">node</var>, then stop this algorithm.</p></li>

         <li><p>If <var title="">node</var> is not in the
         <span>formatting</span> category, and is not in the
         <span>phrasing</span> category, and is not an
         <code>address</code> or <code>div</code> element, then stop
         this algorithm.</p></li> <!-- an element <foo> is in this
         list if the following markup:

             <!DOCTYPE html><body><ol><dt><foo><dt>

         ...results in the second <li> not being (in any way) a
         descendant of the first <li>, or if <foo> is a formatting
         element that gets reopened later. -->

         <li><p>Otherwise, set <var title="">node</var> to the previous entry
         in the <span>stack of open elements</span> and return to step
         2.</p></li>

        </ol>

        <p>Finally, <span title="insert an html element">insert an
        HTML element</span> with the same tag name as the token's.</p>

       </dd>

       <dt>A start tag token whose tag name is "plaintext"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p>

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token.</p>

        <p>Switch the <span>content model flag</span> to the PLAINTEXT
        state.</p>

        <p class="note">Once a start tag with the tag name "plaintext"
        has been seen, that will be the last token ever seen other
        than character tokens (and the end-of-file token), because
        there is no way to switch the <span>content model flag</span>
        out of the PLAINTEXT state.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "address",
       "blockquote", "center", "dir", "div", "dl", "fieldset",
       "listing", "menu", "ol", "pre", "ul"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span>has an
        element in scope</span> with the same tag name as that of the
        token, then <span>generate implied end tags</span>.</p>

        <p>Now, if the <span>current node</span> is not an element
        with the same tag name as that of the token, then this is a
        <span>parse error</span>.</p>

        <p>If the <span>stack of open elements</span> <span>has an
        element in scope</span> with the same tag name as that of the
        token, then pop elements from this stack until an element with
        that tag name has been popped from the stack.</p>

        <!-- XXX quirk (except for in certain cases?):
        <p>Otherwise, act as if a start tag with the tag name given in
        the token had been seen, then reprocess the current token.</p>
        -->

       </dd>

       <dt>An end tag whose tag name is "form"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span>has an
        element in scope</span> with the same tag name as that of the
        token, then <span>generate implied end tags</span>.</p>

        <p>Now, if the <span>current node</span> is not an element
        with the same tag name as that of the token, then this is a
        <span>parse error</span>.</p>

        <p>If the <span>stack of open elements</span> <span>has an
        element in scope</span> with the same tag name as that of the
        token, then pop elements from this stack until an element with
        that tag name has been popped from the stack.</p>

        <p>In any case, set the <span><code title="">form</code>
        element pointer</span> to null.</p>

       </dd>

       <dt>An end tag whose tag name is "p"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then <span>generate implied end tags</span>,
        except for <code>p</code> elements.</p>

        <p>If the <span>current node</span> is not a <code>p</code>
        element, then this is a <span>parse error</span>.</p>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then pop elements from this stack until the
        stack no longer <span title="has an element in scope">has a
        <code>p</code> element in scope</span>.</p>

        <!-- XXX quirk:
        <p>Otherwise, act as if a start tag with the tag name
        <code>p</code> had been seen, then reprocess the current
        token.</p>
        -->

       </dd>

       <dt>An end tag whose tag name is "dd", "dt", or "li"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span>has an
        element in scope</span> whose tag name matches the tag name of
        the token, then <span>generate implied end tags</span>, except
        for elements with the same tag name as the token.</p>

        <p>If the <span>current node</span> is not an element with the
        same tag name as the token, then this is a <span>parse
        error</span>.</p>

        <p>If the <span>stack of open elements</span> <span>has an
        element in scope</span> whose tag name matches the tag name of
        the token, then pop elements from this stack until an element
        with that tag name has been popped from the stack.</p>

       </dd>

       <dt>A start tag whose tag name is one of: "h1", "h2", "h3",
       "h4", "h5", "h6"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has in scope</span> an element whose tag
        name is one of "h1", "h2", "h3", "h4", "h5", or "h6", then
        this is a <span>parse error</span>; pop elements from the
        stack until an element with one of those tag names has been
        popped from the stack.</p>

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "h1", "h2", "h3",
       "h4", "h5", "h6"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has in scope</span> an element whose tag
        name is one of "h1", "h2", "h3", "h4", "h5", or "h6", then
        <span>generate implied end tags</span>.</p>

        <p>Now, if the <span>current node</span> is not an element
        with the same tag name as that of the token, then this is a
        <span>parse error</span>.</p>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has in scope</span> an element whose tag
        name is one of "h1", "h2", "h3", "h4", "h5", or "h6", then pop
        elements from the stack until an element with one of those tag
        names has been popped from the stack.</p>

        <!-- XXX quirk:
        <p>Otherwise, act as if a start tag with the tag name given in
        the token had been seen, then reprocess the current token.</p>
        -->

       </dd>

       <!-- ADOPTION AGENCY ELEMENTS
            Mozilla-only: bdo blink del ins sub sup q
            Safari-only: code dfn kbd nobr samp var wbr
            Both: a b big em font i s small strike strong tt u -->

       <dt>A start tag whose tag name is "a"</dt>
       <dd>

        <p>If the <span>list of active formatting elements</span>
        contains an element whose tag name is "a" between the end of
        the list and the last marker on the list (or the start of the
        list if there is no marker on the list), then this is a
        <span>parse error</span>; act as if an end tag with the tag
        name "a" had been seen, then remove that element from the
        <span>list of active formatting elements</span> and the
        <span>stack of open elements</span> if the end tag didn't
        already remove it (it might not have if the element is not
        <span title="has an element in table scope">in table
        scope</span>).</p>

        <p class="example">In the non-conforming stream
        <code>&lt;a&nbsp;href="a">a&lt;table>&lt;a&nbsp;href="b">b&lt;/table>x</code>,
        the first <code>a</code> element would be closed upon seeing
        the second one, and the "x" character would be inside a link
        to "b", not to "a". This is despite the fact that the outer
        <code>a</code> element is not in table scope (meaning that a
        regular <code>&lt;/a></code> end tag at the start of the table
        wouldn't close the outer <code>a</code> element).</p>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token. Add that element to the
        <span>list of active formatting elements</span>.</p>

       </dd>

       <dt>A start tag whose tag name is one of: "b", "big", "em",
       "font", "i", "nobr", "s", "small", "strike", "strong", "tt",
       "u"</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token. Add that element to the
        <span>list of active formatting elements</span>.</p>

       </dd>

       <dt id="adoptionAgency">An end tag whose tag name is one of:
       "a", "b", "big", "em", "font", "i", "nobr", "s", "small",
       "strike", "strong", "tt", "u"</dt>
       <dd>

        <p>Follow these steps:</p>

        <ol>

         <li>

          <p>Let the <var title="">formatting element</var> be the
          last element in the <span>list of active formatting
          elements</span> that:</p>

          <ul>

           <li>is between the end of the list and the last scope
           marker in the list, if any, or the start of the list
           otherwise, and</li>

           <li>has the same tag name as the token.</li>

          </ul>

          <p>If there is no such node, or, if that node is also in the
          <span>stack of open elements</span> but the element is not
          <span title="has an element in scope">in scope</span>, then
          this is a <span>parse error</span>. Abort these steps. The
          token is ignored.</p>

          <p>Otherwise, if there is such a node, but that node is not
          in the <span>stack of open elements</span>, then this is a
          <span>parse error</span>; remove the element from the list,
          and abort these steps.</p>

          <p>Otherwise, there is a <var title="">formatting
          element</var> and that element is in <span title="stack of
          open elements">the stack</span> and is <span title="has an
          element in scope">in scope</span>. If the element is not the
          <span>current node</span>, this is a <span>parse
          error</span>. In any case, proceed with the algorithm as
          written in the following steps.</p>

         </li>

         <li><p>Let the <var title="">furthest block</var> be the
         topmost node in the <span>stack of open elements</span> that
         is lower in the stack than the <var title="">formatting
         element</var>, and is not an element in the
         <span>phrasing</span> or <span>formatting</span>
         categories. There might not be one.</p></li>

         <li><p>If there is no <var title="">furthest block</var>,
         then the UA must skip the subsequent steps and instead just
         pop all the nodes from the bottom of the <span>stack of open
         elements</span>, from the <span>current node</span> up to the
         <var title="">formatting element</var>, and remove the <var
         title="">formatting element</var> from the <span>list of
         active formatting elements</span>.</p></li>

         <li><p>Let the <var title="">common ancestor</var> be the element
         immediately above the <var title="">formatting element</var> in the
         <span>stack of open elements</span>.</p></li>

         <li><p>If the <var title="">furthest block</var> has a parent node,
         then remove the <var title="">furthest block</var> from its parent
         node.</p></li>

         <li><p>Let a bookmark note the position of the <var
         title="">formatting element</var> in the <span>list of active
         formatting elements</span> relative to the elements on either
         side of it in the list.</p></li>

         <li>

          <p>Let <var title="">node</var> and <var title="">last node</var> be the
          <var title="">furthest block</var>. Follow these steps:</p>

          <ol>

           <li>Let <var title="">node</var> be the element immediately prior to
           <var title="">node</var> in the <span>stack of open
           elements</span>.</li>

           <li>If <var title="">node</var> is not in the <span>list of
           active formatting elements</span>, then remove <var
           title="">node</var> from the <span>stack of open
           elements</span> and then go back to step 1.</li>

           <li>Otherwise, if <var title="">node</var> is the <var
           title="">formatting element</var>, then go to the next step
           in the overall algorithm.</li>

           <li>Otherwise, if <var title="">last node</var> is the <var
           title="">furthest block</var>, then move the aforementioned
           bookmark to be immediately after the <var
           title="">node</var> in the <span>list of active formatting
           elements</span>.</li>

           <li>If <var title="">node</var> has any children, perform a shallow
           clone of <var title="">node</var>, replace the entry for
           <var title="">node</var> in the <span>list of active formatting
           elements</span> with an entry for the clone, replace the
           entry for <var title="">node</var> in the <span>stack of open
           elements</span> with an entry for the clone, and let
           <var title="">node</var> be the clone.</li>

           <li>Insert <var title="">last node</var> into <var
           title="">node</var>, first removing it from its previous
           parent node if any.</li>

           <li>Let <var title="">last node</var> be <var title="">node</var>.</li>

           <li>Return to step 1 of this inner set of steps.</li>

          </ol>

         </li>

         <li><p>Insert whatever <var title="">last node</var> ended up
         being in the previous step into the <var title="">common
         ancestor</var> node, first removing it from its previous
         parent node if any.</p></li>

         <li><p>Perform a shallow clone of the <var title="">formatting
         element</var>.</p></li>

         <li><p>Take all of the child nodes of the <var title="">furthest
         block</var> and append them to the clone created in the last
         step.</p></li>

         <li><p>Append that clone to the <var title="">furthest
         block</var>.</p></li>

         <li><p>Remove the <var title="">formatting element</var> from the
         <span>list of active formatting elements</span>, and insert
         the clone into the <span>list of active formatting
         elements</span> at the position of the aforementioned
         bookmark.</p></li>

         <li><p>Remove the <var title="">formatting element</var> from the
         <span>stack of open elements</span>, and insert the clone
         into the <span>stack of open elements</span> immediately
         after (i.e. in a more deeply nested position than) the
         position of the <var title="">furthest block</var> in that
         stack.</p></li>

         <li><p>Jump back to step 1 in this series of steps.</p></li>

        </ol>

        <p class="note">The way these steps are defined, only elements
        in the <span>formatting</span> category ever get cloned by
        this algorithm.</p>

<!--XXX
        <div class="example">
         <p class="big-issue">Need an example.</p>
        </div>
-->

        <p class="note">Because of the way this algorithm causes elements to
        change parents, it has been dubbed the "adoption agency algorithm"
        (in contrast with other possibly algorithms for dealing with
        misnested content, which included the "incest algorithm", the
        "secret affair algorithm", and the "Heisenberg algorithm").</p>

       </dd>

       <dt>A start tag token whose tag name is "button"</dt>
       <dd>
        
        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>button</code> element in
        scope</span>, then this is a <span>parse error</span>;
        act as if an end tag with the tag name "button" had been seen,
        then reprocess the token.</p>

        <p>Otherwise:</p>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span>Insert an HTML element</span> for the token.</p>

        <p>Insert a marker at the end of the <span>list of active
        formatting elements</span>.</p>

       </dd>

       <dt>A start tag token whose tag name is one of: "marquee",
       "object"</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span>Insert an HTML element</span> for the token.</p>

        <p>Insert a marker at the end of the <span>list of active
        formatting elements</span>.</p>

       </dd>

       <dt>An end tag token whose tag name is one of: "button",
       "marquee", "object"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has in scope</span> an element whose tag
        name is the same as the tag name of the token, then
        <span>generate implied end tags</span>.</p>

        <p>Now, if the <span>current node</span> is not an element
        with the same tag name as the token, then this is a
        <span>parse error</span>.</p>

        <p>Now, if the <span>stack of open elements</span> <span>has
        an element in scope</span> whose tag name matches the tag name
        of the token, then pop elements from the stack until that
        element has been popped from the stack, and <span>clear the
        list of active formatting elements up to the last
        marker</span>.</p>

       </dd>

       <dt>A start tag token whose tag name is "xmp"</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span>Insert an HTML element</span> for the token.</p>

        <p>Switch the <span>content model flag</span> to the CDATA
        state.</p>

       </dd>

       <dt>A start tag whose tag name is "table"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p> <!-- XXX quirks: don't do this -->

        <p><span>Insert an HTML element</span> for the token.</p>

        <p>Change the <span>insertion mode</span> to "<span
        title="insertion mode: in table">in table</span>".</p>

       </dd>

       <dt>A start tag whose tag name is one of: "area", "basefont",
       "bgsound", "br", "embed", "img", "param", "spacer", "wbr"</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token. Immediately pop the
        <span>current node</span> off the <span>stack of open
        elements</span>.</p>

       </dd>

       <dt>A start tag whose tag name is "hr"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> <span title="has
        an element in scope">has a <code>p</code> element in
        scope</span>, then act as if an end tag with the tag name
        <code>p</code> had been seen.</p> <!-- XXX quirks: don't do this -->

        <p><span title="insert an html element">Insert an HTML
        element</span> for the token. Immediately pop the
        <span>current node</span> off the <span>stack of open
        elements</span>.</p>

       </dd>

       <dt>A start tag whose tag name is "image"</dt>
       <dd>
        <p><span>Parse error</span>. Change the token's tag name
        to "img" and reprocess it. (Don't ask.)</p> <!-- As of
        2005-12, studies showed that around 0.2% of pages used the
        <image> element. -->
       </dd>

       <dt>A start tag whose tag name is "input"</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span title="insert an html element">Insert an
        <code>input</code> element</span> for the token.</p>

        <p>If the <span><code title="">form</code> element
        pointer</span> is not null, then <span>associate</span><!--XXX
        xref! --> the <code>input</code> element with the
        <code>form</code> element pointed to by the <span><code
        title="">form</code> element pointer</span>.</p>

        <p>Pop that <code>input</code> element off the <span>stack of
        open elements</span>.</p>

       </dd>

       <dt id="isindex">A start tag whose tag name is "isindex"</dt>
       <dd>
        <p><span>Parse error</span>.</p>
        <p>If the <span><code title="">form</code> element
        pointer</span> is not null, then ignore the token.</p>
        <p>Otherwise:</p>
        <p>Act as if a start tag token with the tag name "form" had been seen.</p>
        <p>Act as if a start tag token with the tag name "hr" had been seen.</p>
        <p>Act as if a start tag token with the tag name "p" had been seen.</p>
        <p>Act as if a start tag token with the tag name "label" had been seen.</p>
        <p>Act as if a stream of character tokens had been seen (see below for what they should say).</p>
        <p>Act as if a start tag token with the tag name "input" had been
        seen, with all the attributes from the "isindex" token, except
        with the "name" attribute set to the value "isindex" (ignoring
        any explicit "name" attribute).</p>
        <p>Act as if a stream of character tokens had been seen (see below for what they should say).</p>
        <p>Act as if an end tag token with the tag name "label" had been seen.</p>
        <p>Act as if an end tag token with the tag name "p" had been seen.</p>
        <p>Act as if a start tag token with the tag name "hr" had been seen.</p>
        <p>Act as if an end tag token with the tag name "form" had been seen.</p>

        <p>The two streams of character tokens together should,
        together with the <code>input</code> element, express the
        equivalent of "This is a searchable index. Insert your search
        keywords here: (input field)" in the user's preferred
        language.</p>

        <p class="big-issue">
        Then need to specify that if the form submission causes just a single
        form control, whose name is "isindex", to be submitted, then we submit
        just the value part, not the "isindex=" part.
        </p>

       </dd>

<!-- XXX keygen support; don't forget form element pointer!

       <dt>A start tag whose tag name is "keygen"</dt>
       <dd>
        ...
       </dd>
-->

       <dt>A start tag whose tag name is "textarea"</dt>
       <dd>

        <p><span>Create an element for the token</span>.</p>

        <p>If the <span><code title="">form</code> element
        pointer</span> is not null, then <span>associate</span><!--XXX
        xref! --> the <code>textarea</code> element with the
        <code>form</code> element pointed to by the <span><code
        title="">form</code> element pointer</span>.</p>

        <p>Append the new element to the <span>current
        node</span>.</p>

        <p>Switch the tokeniser's <span>content model flag</span> to
        the RCDATA state.</p>

        <p>Then, collect all the character tokens that the tokeniser
        returns until it returns a token that is not a character
        token, or until it stops tokenising.</p>

        <p>If this process resulted in a collection of character
        tokens, append a single <code>Text</code> node, whose contents
        is the concatenation of all those tokens' characters, to the
        new element node.</p>

        <p>The tokeniser's <span>content model flag</span> will have
        switched back to the PCDATA state.</p>

        <p>If the next token is an end tag token with the tag name
        "textarea", ignore it. Otherwise, this is a <span>parse
        error</span>.</p>

       </dd>

       <dt>A start tag whose tag name is one of: "iframe",
       "noembed", "noframes"</dt>
       <dt>A start tag whose tag name is "noscript", if
       <span>scripting is enabled</span>:</dt>
       <dd>

        <p><span>Create an element for the token</span>.</p>

        <p>For "iframe" tags, the node must be an
        <code>HTMLIFrameElement</code> object, for the other tags it
        must be an <code>HTMLElement</code> object.</p>

        <p>Append the new element to the <span>current
        node</span>.</p>

        <p>Switch the tokeniser's <span>content model flag</span> to
        the CDATA state.</p>

        <p>Then, collect all the character tokens that the tokeniser
        returns until it returns a token that is not a character
        token, or until it stops tokenising.</p>

        <p>If this process resulted in a collection of character
        tokens, append a single <code>Text</code> node, whose contents
        is the concatenation of all those tokens' characters, to the
        new element node.</p>

        <p>The tokeniser's <span>content model flag</span> will have
        switched back to the PCDATA state.</p>

        <p>If the next token is an end tag token with the same tag
        name as the start tag token, ignore it. Otherwise, this is a
        <span>parse error</span>.</p>

       </dd>

       <dt>A start tag whose tag name is "select"</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span>Insert an HTML element</span> for the token.</p>

        <p>Change the <span>insertion mode</span> to "<span
        title="insertion mode: in select">in select</span>".</p>

       </dd>

<!-- XXX quirks:
       <dt>An end tag whose tag name is "br"</dt>
       <dd>
        <p>Act as if a start tag token with the tag name "br" had been
        seen. Ignore the end tag token.</p>
       </dd>
-->

       <dt>A start or end tag whose tag name is one of: "caption",
       "col", "colgroup", "frame", "frameset", "head", "option",
       "optgroup", "tbody", "td", "tfoot", "th", "thead", "tr"</dt>
       <dt>An end tag whose tag name is one of: "area", "basefont",
       "bgsound", <!--XXX quirks: remove br-->"br", "embed", "hr",
       "iframe", "image", "img", "input", "isindex", "noembed",
       "noframes", "param", "select", "spacer", "table", "textarea",
       "wbr"</dt> <!-- add keygen if we add the start tag -->
       <dt>An end tag whose tag name is "noscript", if <span>scripting
       is enabled</span>:</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>A start or end tag whose tag name is one of:
       "event-source", "section", "nav", "article", "aside", "header",
       "footer", "datagrid", "command"</dt>

       <dd>

        <!-- XXXX -->

        <p class="big-issue">Work in progress!</p>

       </dd>

       <dt>A start tag token not covered by the previous entries</dt>
       <dd>

        <p><span>Reconstruct the active formatting elements</span>, if
        any.</p>

        <p><span>Insert an HTML element</span> for the token.</p>

        <p class="note">This element will be a <span>phrasing</span>
        element.</p>

<!--
Put the following into the MathML namespace if parsed:
   math, mrow, mfrac, msqrt, mroot, mstyle, merror, mpadded, 
   mphantom, mfenced, menclose, msub, msup, msubsup, munder, 
   mover, munderover, mmultiscripts, mtable, mlabeledtr, mtr, 
   mtd, maction
-->

       </dd>

       <dt>An end tag token not covered by the previous entries</dt>
       <dd>

        <p>Run the following algorithm:</p>

        <ol>

         <li><p>Initialise <var title="">node</var> to be the <span>current
         node</span> (the bottommost node of the stack).</p></li>

         <li><p>If <var title="">node</var> has the same tag name as
         the end tag token, then:</p>

          <ol>

           <li><p><span>Generate implied end tags</span>.</p></li>

           <li><p>If the tag name of the end tag token does not match
           the tag name of the <span>current node</span>, this is a
           <span>parse error</span>.</p></li>

           <li><p>Pop all the nodes from the <span>current node</span>
           up to <var title="">node</var>, including <var title="">node</var>, then stop
           this algorithm.</p></li>

          </ol>

         </li>

         <li><p>Otherwise, if <var title="">node</var> is in neither
         the <span>formatting</span> category nor the
         <span>phrasing</span> category, then this is a <span>parse
         error</span>. Stop this algorithm. The end tag token is
         ignored.</p></li>

         <li><p>Set <var title="">node</var> to the previous entry in the
         <span>stack of open elements</span>.</p></li>

         <li><p>Return to step 2.</p></li>

        </ol>

       </dd>

      </dl>

     </dd>


     <dt id="parsing-main-intable">If the <span>insertion mode</span> is "<dfn title="insertion mode: in table">in table</dfn>"</dt>
     <dd>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p><span title="append a character">Append the character</span> to
        the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag whose tag name is "caption"</dt>
       <dd>

        <p><span>Clear the stack back to a table context</span>. (See
        below.)</p>

        <p>Insert a marker at the end of the <span>list of active
        formatting elements</span>.</p>

        <p><span>Insert an HTML element</span> for the token, then
        switch the <span>insertion mode</span> to "<span
        title="insertion mode: in caption">in caption</span>".</p>

       </dd>

       <dt>A start tag whose tag name is "colgroup"</dt>
       <dd>

        <p><span>Clear the stack back to a table context</span>. (See
        below.)</p>

        <p><span>Insert an HTML element</span> for the token, then
        switch the <span>insertion mode</span> to "<span
        title="insertion mode: in column group">in column
        group</span>".</p>

       </dd>

       <dt>A start tag whose tag name is "col"</dt>
       <dd>
        <p>Act as if a start tag token with the tag name "colgroup"
        had been seen, then reprocess the current token.</p>
       </dd>

       <dt>A start tag whose tag name is one of: "tbody", "tfoot", "thead"</dt>
       <dd>

        <p><span>Clear the stack back to a table context</span>. (See
        below.)</p>

        <p><span>Insert an HTML element</span> for the token, then
        switch the <span>insertion mode</span> to "<span
        title="insertion mode: in table body">in table
        body</span>".</p>

       </dd>

       <dt>A start tag whose tag name is one of: "td", "th", "tr"</dt>
       <dd>
        <p>Act as if a start tag token with the tag name "tbody" had
        been seen, then reprocess the current token.</p>
       </dd>

       <dt>A start tag whose tag name is "table"</dt>
       <dd>

        <p><span>Parse error</span>. Act as if an end tag token with
        the tag name "table" had been seen, then, if that token wasn't
        ignored, reprocess the current token.</p>

        <p class="note">The fake end tag token here can only be
        ignored in the <span><code>innerHTML</code> case</span>.</p>

       </dd>

       <dt>An end tag whose tag name is "table"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as the token, this is a
        <span>parse error</span>. Ignore the
        token. (<span><code>innerHTML</code> case</span>)</p>

        <p>Otherwise:</p>

        <p><span>Generate implied end tags</span>.</p>

        <p>Now, if the <span>current node</span> is not a
        <code>table</code> element, then this is a <span>parse
        error</span>.</p>

        <p>Pop elements from this stack until a <code>table</code>
        element has been popped from the stack.</p>

        <p><span>Reset the insertion mode appropriately</span>.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "body", "caption",
       "col", "colgroup", "html", "tbody", "td", "tfoot", "th",
       "thead", "tr"</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>Anything else</dt>
       <dd>

        <p><span>Parse error</span>. Process the token as if the
        <span>insertion mode</span> was "<span title="insertion mode:
        in body">in body</span>", with the following exception:</p>

        <p>If the <span>current node</span> is a <code>table</code>,
        <code>tbody</code>, <code>tfoot</code>, <code>thead</code>, or
        <code>tr</code> element, then, whenever a node would be
        inserted into the <span>current node</span>, it must instead
        be inserted into the <em>foster parent element</em>.</p>

        <p>The <dfn>foster parent element</dfn> is the parent element
        of the last <code>table</code> element in the <span>stack of
        open elements</span>, if there is a <code>table</code> element
        and it has such a parent element. If there is no
        <code>table</code> element in the <span>stack of open
        elements</span> (<span><code>innerHTML</code> case</span>),
        then the <em>foster parent element</em> is the first element
        in the <span>stack of open elements</span> (the
        <code>html</code> element). Otherwise, if there is a
        <code>table</code> element in the <span>stack of open
        elements</span>, but the last <code>table</code> element in
        the <span>stack of open elements</span> has no parent, or its
        parent node is not an element, then the <em>foster parent
        element</em> is the element before the last <code>table</code>
        element in the <span>stack of open elements</span>.</p>

        <p>If the <em>foster parent element</em> is the parent element
        of the last <code>table</code> element in the <span>stack of
        open elements</span>, then the new node must be inserted
        immediately <em>before</em> the last <code>table</code>
        element in the <span>stack of open elements</span> in the
        <span>foster parent element</span>; otherwise, the new node
        must be <em>appended</em> to the <span>foster parent
        element</span>.</p>

       </dd>

      </dl>

      <p>When the steps above require the UA to <dfn>clear the stack
      back to a table context</dfn>, it means that the UA must, while
      the <span>current node</span> is not a <code>table</code>
      element or an <code>html</code> element, pop elements from the
      <span>stack of open elements</span>. If this causes any elements
      to be popped from the stack, then this is a <span>parse
      error</span>.</p>

      <p class="note">The <span>current node</span> being an
      <code>html</code> element after this process is an
      <span><code>innerHTML</code> case</span>.</p>

     </dd>


     <dt id="parsing-main-incaption">If the <span>insertion mode</span> is "<dfn title="insertion mode: in caption">in caption</dfn>"</dt>
     <dd>

      <dl class="switch">

       <dt>An end tag whose tag name is "caption"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as the token, this is a
        <span>parse error</span>. Ignore the
        token. (<span><code>innerHTML</code> case</span>)</p>

        <p>Otherwise:</p>

        <p><span>Generate implied end tags</span>.</p>

        <p>Now, if the <span>current node</span> is not a
        <code>caption</code> element, then this is a <span>parse
        error</span>.</p>

        <p>Pop elements from this stack until a <code>caption</code>
        element has been popped from the stack.</p>

        <p><span>Clear the list of active formatting elements up to
        the last marker</span>.</p>

        <p>Switch the <span>insertion mode</span> to "<span
        title="insertion mode: in table">in table</span>".</p>

       </dd>

       <dt>A start tag whose tag name is one of: "caption", "col",
       "colgroup", "tbody", "td", "tfoot", "th", "thead", "tr"</dt>
       <dt>An end tag whose tag name is "table"</dt>
       <dd>

        <p><span>Parse error</span>. Act as if an end tag with the tag
        name "caption" had been seen, then, if that token wasn't
        ignored, reprocess the current token.</p>

        <p class="note">The fake end tag token here can only be
        ignored in the <span><code>innerHTML</code> case</span>.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "body", "col",
       "colgroup", "html", "tbody", "td", "tfoot", "th", "thead",
       "tr"</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>Anything else</dt>
       <dd>
        <p>Process the token as if the <span>insertion mode</span> was
        "<span title="insertion mode: in body">in body</span>".</p>
       </dd>

      </dl>

     </dd>


     <dt id="parsing-main-incolgroup">If the <span>insertion mode</span> is "<dfn title="insertion mode: in column group">in column group</dfn>"</dt>
     <dd>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p><span title="append a character">Append the character</span> to
        the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag whose tag name is "col"</dt>
       <dd>
        <p><span title="insert an HTML element">Insert a
        <code>col</code> element</span> for the token. Immediately
        pop the <span>current node</span> off the <span>stack of open
        elements</span>.</p>
       </dd>

       <dt>An end tag whose tag name is "colgroup"</dt>
       <dd>

        <p>If the <span>current node</span> is the root
        <code>html</code> element, then this is a <span>parse
        error</span>, ignore the token. (<span><code>innerHTML</code>
        case</span>)</p>

        <p>Otherwise, pop the <span>current node</span> (which will be
        a <code>colgroup</code> element) from the <span>stack of open
        elements</span>. Switch the <span>insertion mode</span> to
        "<span title="insertion mode: in table">in table</span>".</p>

       </dd>

       <dt>An end tag whose tag name is "col"</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>Anything else</dt>
       <dd>

        <p>Act as if an end tag with the tag name "colgroup" had been
        seen, and then, if that token wasn't ignored, reprocess the
        current token.</p>

        <p class="note">The fake end tag token here can only be
        ignored in the <span><code>innerHTML</code> case</span>.</p>

       </dd>

      </dl>

     </dd>


     <dt id="parsing-main-intbody">If the <span>insertion mode</span> is "<dfn title="insertion mode: in table body">in table body</dfn>"</dt>
     <dd>

      <dl class="switch">

       <dt>A start tag whose tag name is "tr"</dt>
       <dd>

        <p><span>Clear the stack back to a table body
        context</span>. (See below.)</p>

        <p><span title="insert an HTML element">Insert a
        <code>tr</code> element</span> for the token, then switch the
        <span>insertion mode</span> to "<span title="insertion mode:
        in row">in row</span>".</p>

       </dd>

       <dt>A start tag whose tag name is one of: "th", "td"</dt>
       <dd>
        <p><span>Parse error</span>. Act as if a start tag with
        the tag name "tr" had been seen, then reprocess the current
        token.</p>
       </dd>

       <dt>An end tag whose tag name is one of: "tbody", "tfoot",
       "thead"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as the token, this is a
        <span>parse error</span>. Ignore the token.</p>

        <p>Otherwise:</p>

        <p><span>Clear the stack back to a table body
        context</span>. (See below.)</p>

        <p>Pop the <span>current node</span> from the <span>stack of
        open elements</span>. Switch the <span>insertion mode</span>
        to "<span title="insertion mode: in table">in table</span>".</p>

       </dd>

       <dt>A start tag whose tag name is one of: "caption", "col",
       "colgroup", "tbody", "tfoot", "thead"</dt>
       <dt>An end tag whose tag name is "table"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have a
        <code>tbody</code>, <code>thead</code>, or <code>tfoot</code>
        element in table scope</span>, this is a <span>parse
        error</span>. Ignore the token. (<span><code>innerHTML</code>
        case</span>)</p>

        <p>Otherwise:</p>

        <p><span>Clear the stack back to a table body
        context</span>. (See below.)</p>

        <p>Act as if an end tag with the same tag name as the
        <span>current node</span> ("tbody", "tfoot", or "thead") had
        been seen, then reprocess the current token.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "body", "caption",
       "col", "colgroup", "html", "td", "th", "tr"</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>Anything else</dt>
       <dd>
        <p>Process the token as if the <span>insertion mode</span> was
        "<span title="insertion mode: in table">in table</span>".</p>
       </dd>

      </dl>

      <p>When the steps above require the UA to <dfn>clear the stack
      back to a table body context</dfn>, it means that the UA must,
      while the <span>current node</span> is not a <code>tbody</code>,
      <code>tfoot</code>, <code>thead</code>, or <code>html</code>
      element, pop elements from the <span>stack of open
      elements</span>. If this causes any elements to be popped from
      the stack, then this is a
      <span>parse error</span>.</p>

      <p class="note">The <span>current node</span> being an
      <code>html</code> element after this process is an
      <span><code>innerHTML</code> case</span>.</p>

     </dd>


     <dt id="parsing-main-intr">If the <span>insertion mode</span> is "<dfn title="insertion mode: in row">in row</dfn>"</dt>
     <dd>

      <dl class="switch">

       <dt>A start tag whose tag name is one of: "th", "td"</dt>
       <dd>

        <p><span>Clear the stack back to a table row
        context</span>. (See below.)</p>

        <p><span title="insert an HTML element">Insert an HTML
        element</span> for the token, then switch the <span>insertion
        mode</span> to "<span title="insertion mode: in cell">in
        cell</span>".</p>

        <p>Insert a marker at the end of the <span>list of active
        formatting elements</span>.</p>

       </dd>

       <dt>An end tag whose tag name is "tr"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as the token, this is a
        <span>parse error</span>. Ignore the
        token. (<span><code>innerHTML</code> case</span>)</p>

        <p>Otherwise:</p>

        <p><span>Clear the stack back to a table row
        context</span>. (See below.)</p>

        <p>Pop the <span>current node</span> (which will be a
        <code>tr</code> element) from the <span>stack of open
        elements</span>. Switch the <span>insertion mode</span> to
        "<span title="insertion mode: in table body">in table
        body</span>".</p>

       </dd>

       <dt>A start tag whose tag name is one of: "caption", "col",
       "colgroup", "tbody", "tfoot", "thead", "tr"</dt>
       <dt>An end tag whose tag name is "table"</dt>
       <dd>

        <p>Act as if an end tag with the tag name "tr" had been seen,
        then, if that token wasn't ignored, reprocess the current
        token.</p>

        <p class="note">The fake end tag token here can only be
        ignored in the <span><code>innerHTML</code> case</span>.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "tbody", "tfoot",
       "thead"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as the token, this is a
        <span>parse error</span>. Ignore the token.</p>

        <p>Otherwise, act as if an end tag with the tag name "tr" had
        been seen, then reprocess the current token.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "body", "caption",
       "col", "colgroup", "html", "td", "th"</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>Anything else</dt>
       <dd>
        <p>Process the token as if the <span>insertion mode</span> was
        "<span title="insertion mode: in table">in table</span>".</p>
       </dd>

      </dl>

      <p>When the steps above require the UA to <dfn>clear the stack
      back to a table row context</dfn>, it means that the UA must,
      while the <span>current node</span> is not a <code>tr</code>
      element or an <code>html</code> element, pop elements from the
      <span>stack of open elements</span>. If this causes any elements
      to be popped from the stack, then this is a <span>parse
      error</span>.</p>

      <p class="note">The <span>current node</span> being an
      <code>html</code> element after this process is an
      <span><code>innerHTML</code> case</span>.</p>

     </dd>


     <dt id="parsing-main-intd">If the <span>insertion mode</span> is "<dfn title="insertion mode: in cell">in cell</dfn>"</dt>
     <dd>

      <dl class="switch">

       <dt>An end tag whose tag name is one of: "td", "th"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as that of the token, then
        this is a <span>parse error</span> and the token must be
        ignored.</p>

        <p>Otherwise:</p>

        <p><span>Generate implied end tags</span>, except for elements
        with the same tag name as the token.</p>

        <p>Now, if the <span>current node</span> is not an element
        with the same tag name as the token, then this is a
        <span>parse error</span>.</p>

        <p>Pop elements from this stack until an element with the same
        tag name as the token has been popped from the stack.</p>

        <p><span>Clear the list of active formatting elements up to
        the last marker</span>.</p>

        <p>Switch the <span>insertion mode</span> to "<span
        title="insertion mode: in row">in row</span>". (The
        <span>current node</span> will be a <code>tr</code> element at
        this point.)</p>

       </dd>

       <dt>A start tag whose tag name is one of: "caption", "col",
       "colgroup", "tbody", "td", "tfoot", "th", "thead", "tr"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does
        <em>not</em> <span title="has an element in table scope">have
        a <code>td</code> or <code>th</code> element in table
        scope</span>, then this is a <span>parse error</span>; ignore
        the token. (<span><code>innerHTML</code> case</span>)</p>

        <p>Otherwise, <span>close the cell</span> (see below) and
        reprocess the current token.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "body", "caption",
       "col", "colgroup", "html"</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

       <dt>An end tag whose tag name is one of: "table", "tbody",
       "tfoot", "thead", "tr"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as that of the token
        (which can only happen for "tbody", "tfoot" and "thead", or,
        in the <span><code>innerHTML</code> case</span>), then this is
        a <span>parse error</span> and the token must be ignored.</p>

        <p>Otherwise, <span>close the cell</span> (see below) and
        reprocess the current token.</p>

       </dd>

       <dt>Anything else</dt>
       <dd>
        <p>Process the token as if the <span>insertion mode</span> was
        "<span title="insertion mode: in body">in body</span>".</p>
       </dd>

      </dl>

      <p>Where the steps above say to <dfn>close the cell</dfn>, they
      mean to follow the following algorithm:</p>

      <ol>

       <li><p>If the <span>stack of open elements</span> <span
       title="has an element in table scope">has a <code>td</code>
       element in table scope</span>, then act as if an end tag token
       with the tag name "td" had been seen.</p></li>

       <li><p>Otherwise, the <span>stack of open elements</span> will
       <span title="has an element in table scope">have a
       <code>th</code> element in table scope</span>; act as if an end
       tag token with the tag name "th" had been seen.</p></li>

      </ol>

      <p class="note">The <span>stack of open elements</span> cannot
      have both a <code>td</code> and a <code>th</code> element <span
      title="has an element in table scope">in table scope</span> at
      the same time, nor can it have neither when the <span>insertion
      mode</span> is "<span title="insertion mode: in cell">in
      cell</span>".</p>

     </dd>


     <dt id="parsing-main-inselect">If the <span>insertion mode</span> is "<dfn title="insertion mode: in select">in select</dfn>"</dt>
     <dd>

      <p>Handle the token as follows:</p>

      <dl class="switch">

       <dt>A character token</dt>
       <dd>
        <p><span title="append a character">Append the token's
        character</span> to the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag token whose tag name is "option"</dt>
       <dd>

        <p>If the <span>current node</span> is an <code>option</code>
        element, act as if an end tag with the tag name "option" had
        been seen.</p>

        <p><span>Insert an HTML element</span> for the token.</p>

       </dd>

       <dt>A start tag token whose tag name is "optgroup"</dt>
       <dd>

        <p>If the <span>current node</span> is an <code>option</code>
        element, act as if an end tag with the tag name "option" had
        been seen.</p>

        <p>If the <span>current node</span> is an
        <code>optgroup</code> element, act as if an end tag with the
        tag name "optgroup" had been seen.</p>

        <p><span>Insert an HTML element</span> for the token.</p>

       </dd>

       <dt>An end tag token whose tag name is "optgroup"</dt>
       <dd>

        <p>First, if the <span>current node</span> is an
        <code>option</code> element, and the node immediately before
        it in the <span>stack of open elements</span> is an
        <code>optgroup</code> element, then act as if an end tag with
        the tag name "option" had been seen.</p>

        <p>If the <span>current node</span> is an
        <code>optgroup</code> element, then pop that node from the
        <span>stack of open elements</span>. Otherwise, this is a
        <span>parse error</span>, ignore the token.</p>

       </dd>

       <dt>An end tag token whose tag name is "option"</dt>
       <dd>

        <p>If the <span>current node</span> is an <code>option</code>
        element, then pop that node from the <span>stack of open
        elements</span>. Otherwise, this is a <span>parse
        error</span>, ignore the token.</p>

       </dd>

       <dt>An end tag whose tag name is "select"</dt>
       <dd>

        <p>If the <span>stack of open elements</span> does not <span
        title="has an element in table scope">have an element in table
        scope</span> with the same tag name as the token, this is a
        <span>parse error</span>. Ignore the
        token. (<span><code>innerHTML</code> case</span>)</p>

        <p>Otherwise:</p>

        <p>Pop elements from the <span>stack of open elements</span>
        until a <code>select</code> element has been popped from the
        stack.</p>

        <p><span>Reset the insertion mode appropriately</span>.</p>

       </dd>

       <dt>A start tag whose tag name is "select"</dt>
       <dd>

        <p><span>Parse error</span>. Act as if the token had been
        an end tag with the tag name "select" instead.</p>

       </dd>

       <dt>An end tag whose tag name is one of: "caption", "table",
       "tbody", "tfoot", "thead", "tr", "td", "th"</dt>
       <dd>

        <p><span>Parse error</span>.</p>

        <p>If the <span>stack of open elements</span> <span>has an
        element in table scope</span> with the same tag name as that
        of the token, then act as if an end tag with the tag name
        "select" had been seen, and reprocess the token. Otherwise,
        ignore the token.</p>

       </dd>

       <dt>Anything else</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

      </dl>

     </dd>


     <dt id="parsing-main-afterbody">If the <span>insertion mode</span> is "<dfn title="insertion mode: after body">after body</dfn>"</dt>
     <dd>

      <p>Handle the token as follows:</p>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p>Process the token as it would be processed if the
        <span>insertion mode</span> was "<span title="insertion mode:
        in body">in body</span>".</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the first element in
        the <span>stack of open elements</span> (the <code>html</code>
        element), with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>An end tag with the tag name "html"</dt>
       <dd>

        <p>If the parser was originally created in order to handle the
        setting of <em>an element</em>'s <code
        title="dom-innerHTML-HTML">innerHTML</code> attribute, this is
        a <span>parse error</span>; ignore the token. (The element
        will be an <code>html</code> element in this case.)
        (<span><code>innerHTML</code> case</span>)</p>

        <p>Otherwise, switch to <span>the trailing end
        phase</span>.</p>

       </dd>

       <dt>Anything else</dt>
       <dd>

        <p><span>Parse error</span>. Set the <span>insertion
        mode</span> to "<span title="insertion mode: in body">in
        body</span>" and reprocess the token.</p>

       </dd>

      </dl>

     </dd>


     <dt id="parsing-main-inframeset">If the <span>insertion mode</span> is "<dfn title="insertion mode: in frameset">in frameset</dfn>"</dt>
     <dd>

      <p>Handle the token as follows:</p>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p><span title="append a character">Append the character</span> to
        the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>A start tag with the tag name "frameset"</dt>
       <dd>
        <p><span title="Insert an HTML element">Insert a
        <code>frameset</code> element</span> for the token.</p>
       </dd>

       <dt>An end tag with the tag name "frameset"</dt>
       <dd>

        <p>If the <span>current node</span> is the root
        <code>html</code> element, then this is a <span>parse
        error</span>; ignore the token. (<span><code>innerHTML</code>
        case</span>)</p>

        <p>Otherwise, pop the <span>current node</span> from the
        <span>stack of open elements</span>.</p>

        <p>If the parser was <em>not</em> originally created in order
        to handle the setting of an element's <code
        title="dom-innerHTML-HTML">innerHTML</code> attribute
        (<span><code>innerHTML</code> case</span>), and the
        <span>current node</span> is no longer a <code>frameset</code>
        element, then change the <span>insertion mode</span> to "<span
        title="insertion mode: after frameset">after
        frameset</span>".</p>

       </dd>

       <dt>A start tag with the tag name "frame"</dt>
       <dd>
        <p><span>Insert an HTML element</span> for the token.
        Immediately pop the <span>current node</span> off the
        <span>stack of open elements</span>.</p>
       </dd>

       <dt>A start tag with the tag name "noframes"</dt>
       <dd>
        <p>Process the token as if the <span>insertion mode</span> had
        been "<span title="insertion mode: in body">in body</span>".</p>
       </dd>

       <dt>Anything else</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

      </dl>

     </dd>


     <dt id="parsing-main-afterframeset">If the <span>insertion mode</span> is "<dfn title="insertion mode: after frameset">after frameset</dfn>"</dt>
     <dd>

      <p>Handle the token as follows:</p>

      <dl class="switch">

       <dt>A character token that is one of one of U+0009
       CHARACTER TABULATION, U+000A LINE FEED (LF), U+000B LINE
       TABULATION, U+000C FORM FEED (FF), or U+0020 SPACE</dt>
       <dd>
        <p><span title="append a character">Append the character</span> to
        the <span>current node</span>.</p>
       </dd>

       <dt>A comment token</dt>
       <dd>
        <p>Append a <code>Comment</code> node to the <span>current
        node</span> with the <code title="">data</code> attribute set to
        the data given in the comment token.</p>
       </dd>

       <dt>An end tag with the tag name "html"</dt>
       <dd>
        <p>Switch to <span>the trailing end phase</span>.</p>
       </dd>

       <dt>A start tag with the tag name "noframes"</dt>
       <dd>
        <p>Process the token as if the <span>insertion mode</span> had
        been "<span title="insertion mode: in body">in body</span>".</p>
       </dd>

       <dt>Anything else</dt>
       <dd>
        <p><span>Parse error</span>. Ignore the token.</p>
       </dd>

      </dl>

     </dd>

    </dl>

   </dd>

  </dl>

  <p class="big-issue">This doesn't handle UAs that don't support
  frames, or that do support frames but want to show the NOFRAMES
  content. Supporting the former is easy; supporting the latter is
  harder.</p>


  <h5><dfn>The trailing end phase</dfn></h5>

  <p>After <span>the main phase</span>, as each token is emitted from
  the <span>tokenisation</span> stage, it must be processed as
  described in this section.</p>

  <dl class="switch">

   <dt>A DOCTYPE token</dt>
   <dd>
    <p><span>Parse error</span>. Ignore the token.</p>
   </dd>

   <dt>A comment token</dt>
   <dd>
    <p>Append a <code>Comment</code> node to the <code>Document</code>
    object with the <code title="">data</code> attribute set to the
    data given in the comment token.</p>
   </dd>

   <dt>A character token that is one of one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000B LINE TABULATION, U+000C
   FORM FEED (FF), or U+0020 SPACE</dt>
   <dd>
    <p>Process the token as it would be processed in <span>the main
    phase</span>.</p>
   </dd>

   <dt>A character token that is <em>not</em> one of U+0009 CHARACTER
   TABULATION, U+000A LINE FEED (LF), U+000B LINE TABULATION, U+000C
   FORM FEED (FF), or U+0020 SPACE</dt>
   <dt>A start tag token</dt>
   <dt>An end tag token</dt>
   <dd>
    <p><span>Parse error</span>. Switch back to <span>the main
    phase</span> and reprocess the token.</p>
   </dd>

   <dt>An end-of-file token</dt>
   <dd>
    <p><span>Stop parsing</span>.</p>
   </dd>

  </dl>


  <h4>The End</h4>

  <p>Once the user agent <dfn title="stop parsing">stops parsing</dfn>
  the document, the user agent must follow the steps in this
  section.</p>

  <p>First, <!--the user agent must <span title="fire a DOMContentLoaded
  event">fire a <code
  title="event-DOMContentLoaded">DOMContentLoaded</code> event</span>
  at <span>the <code>body</code> element</span>.</p>

  <p>Then, -->the rules for <span>when a script completes
  loading</span> start applying (script execution is no longer managed
  by the parser).</p>

  <p>If any of the scripts in the <span>list of scripts that will
  execute as soon as possible</span> have <span>completed
  loading</span><!-- XXX xref -->, or if the <span>list of scripts
  that will execute asynchronously</span> is not empty and the first
  script in that list has <span>completed loading</span><!-- XXX xref
  -->, then the user agent must act as if those scripts just completed
  loading, following the rules given for that in the
  <code>script</code> element definition.</p>

  <p>Then, if the <span>list of scripts that will execute when the
  document has finished parsing</span> is not empty, and the first
  item in this list has already <span>completed loading</span><!--XXX
  xref -->, then the user agent must act as if that script just
  finished loading.</p>

  <p>By this point, there will be no scripts that have loaded but have
  not yet been executed.</p>

  <p>Once everything that <dfn title="delay the load event">delays the
  load event</dfn> has completed, the user agent must <span
  title="fire a load event">fire a <code
  title="event-load">load</code> event</span> at <span>the
  <code>body</code> element</span>.</p>

  <!-- XXX make sure things "delay the load event" -->


<!--XXX need to handle
http://lxr.mozilla.org/mozilla/source/parser/htmlparser/src/CNavDTD.cpp#2354
2354           // Don't open transient styles if it makes the stack deep, bug 58917.
-->

<!--XXX
http://lxr.mozilla.org/mozilla/source/parser/htmlparser/src/nsHTMLTokenizer.cpp#749
-->

<!--
see also  CTextToken::ConsumeCharacterData()  for CDATA parsing?

1212                      1  Here's a tricky case from bug 22596:  <h5><li><h5>
1213                         How do we know that the 2nd <h5> should close the <LI> rather than nest inside the <LI>?
1214                         (Afterall, the <h5> is a legal child of the <LI>).
1215               
1216                         The way you know is that there is no root between the two, so the <h5> binds more
1217                         tightly to the 1st <h5> than to the <LI>.
1218                      2.  Also, bug 6148 shows this case: <SPAN><DIV><SPAN>
1219                         From this case we learned not to execute this logic if the parent is a block.
1220                     
1221                      3. Fix for 26583
1222                         Ex. <A href=foo.html><B>foo<A href-bar.html>bar</A></B></A>  <- A legal HTML
1223                         In the above example clicking on "foo" or "bar" should link to
1224                         foo.html or bar.html respectively. That is, the inner <A> should be informed
1225                         about the presence of an open <A> above <B>..so that the inner <A> can close out
1226                         the outer <A>. The following code does it for us.
1227                      
1228                      4. Fix for 27865 [ similer to 22596 ]. Ex: <DL><DD><LI>one<DD><LI>two
 - http://lxr.mozilla.org/mozilla/source/parser/htmlparser/src/CNavDTD.cpp#1211

815             // Here's a problem.  If theTag is legal in here, we don't move it
816             // out.  So if we're moving stuff out of here, the parent of theTag
817             // gets closed at this point.  But some things are legal
818             // _everywhere_ and hence would effectively close out misplaced
819             // content in tables.  This is undesirable, so treat them as
820             // illegal here so they'll be shipped out with their parents and
821             // siblings.  See bug 40855 for an explanation (that bug was for
822             // comments, but the same issues arise with whitespace, newlines,
823             // noscript, etc).  Script is special, though.  Shipping it out
824             // breaks document.write stuff.  See bug 243064.
 - http://lxr.mozilla.org/mozilla/source/parser/htmlparser/src/CNavDTD.cpp#825


1326     /**************************************************************************************
1327      *
1328      * Now a little code to deal with bug #49687 (crash when layout stack gets too deep)
1329      * I've also opened this up to any container (not just inlines): re bug 55095
1330      * Improved to handle bug 55980 (infinite loop caused when DEPTH is exceeded and
1331      * </P> is encountered by itself (<P>) is continuously produced.
1332      *
1333      **************************************************************************************/

1912               // Oh boy!! we found a "stray" tag. Nav4.x and IE introduce line break in
1913               // such cases. So, let's simulate that effect for compatibility.
1914               // Ex. <html><body>Hello</P>There</body></html>
http://lxr.mozilla.org/mozilla/source/parser/htmlparser/src/CNavDTD.cpp#1912

http://lxr.mozilla.org/seamonkey/search?string=nested
/parser/htmlparser/src/CNavDTD.cpp, line 791 - * 2. <CENTER><DL><DT><A><CENTER> allow nested <CENTER>
/parser/htmlparser/src/CNavDTD.cpp, line 792 - * 3. <TABLE><TR><TD><TABLE>... allow nested <TABLE>
/parser/htmlparser/src/CNavDTD.cpp, line 2562 - // Discard nested forms - bug 72639
/parser/htmlparser/src/nsElementTable.cpp, line 1453 - * 2. <CENTER><DL><DT><A><CENTER> allow nested <CENTER>
/parser/htmlparser/src/nsElementTable.cpp, line 1454 - * 3. <TABLE><TR><TD><TABLE>... allow nested <TABLE>
/parser/htmlparser/src/nsElementTable.cpp, line 1901 - // Ex: <H1><LI><H1><LI>. Inner LI has the potential of getting nested
-->

  <h3>Namespaces</h3>

  <p>The <dfn>HTML namespace</dfn> is: <code>http://www.w3.org/1999/xhtml</code></p>

  <h3><dfn>Entities</dfn></h3>

  <p>This table lists the entity names that are supported by HTML, and
  the code points to which they refer. It is referenced by the previous
  sections.</p>

<!--XXX
 entities: 
 94         // If an entity value is greater than 255 then:
 95         // Nav 4.x does not treat it as an entity,
 96         // IE treats it as an entity if terminated with a semicolon.
 97         // Resembling IE!!
http://lxr.mozilla.org/mozilla/source/parser/htmlparser/src/nsHTMLTokens.cpp#94
-->

  <table>
   <thead>
    <tr> <th> Entity Name </th> <th> Character </th> </tr>
   </thead>
   <tbody>
    <tr> <td> <code title="">AElig</code> </td> <td> U+00C6 </td> </tr>
    <tr> <td> <code title="">Aacute</code> </td> <td> U+00C1 </td> </tr>
    <tr> <td> <code title="">Acirc</code> </td> <td> U+00C2 </td> </tr>
    <tr> <td> <code title="">Agrave</code> </td> <td> U+00C0 </td> </tr>
    <tr> <td> <code title="">Alpha</code> </td> <td> U+0391 </td> </tr>
    <tr> <td> <code title="">Aring</code> </td> <td> U+00C5 </td> </tr>
    <tr> <td> <code title="">Atilde</code> </td> <td> U+00C3 </td> </tr>
    <tr> <td> <code title="">Auml</code> </td> <td> U+00C4 </td> </tr>
    <tr> <td> <code title="">Beta</code> </td> <td> U+0392 </td> </tr>
    <tr> <td> <code title="">Ccedil</code> </td> <td> U+00C7 </td> </tr>
    <tr> <td> <code title="">Chi</code> </td> <td> U+03A7 </td> </tr>
    <tr> <td> <code title="">Dagger</code> </td> <td> U+2021 </td> </tr>
    <tr> <td> <code title="">Delta</code> </td> <td> U+0394 </td> </tr>
    <tr> <td> <code title="">ETH</code> </td> <td> U+00D0 </td> </tr>
    <tr> <td> <code title="">Eacute</code> </td> <td> U+00C9 </td> </tr>
    <tr> <td> <code title="">Ecirc</code> </td> <td> U+00CA </td> </tr>
    <tr> <td> <code title="">Egrave</code> </td> <td> U+00C8 </td> </tr>
    <tr> <td> <code title="">Epsilon</code> </td> <td> U+0395 </td> </tr>
    <tr> <td> <code title="">Eta</code> </td> <td> U+0397 </td> </tr>
    <tr> <td> <code title="">Euml</code> </td> <td> U+00CB </td> </tr>
    <tr> <td> <code title="">Gamma</code> </td> <td> U+0393 </td> </tr>
    <tr> <td> <code title="">Iacute</code> </td> <td> U+00CD </td> </tr>
    <tr> <td> <code title="">Icirc</code> </td> <td> U+00CE </td> </tr>
    <tr> <td> <code title="">Igrave</code> </td> <td> U+00CC </td> </tr>
    <tr> <td> <code title="">Iota</code> </td> <td> U+0399 </td> </tr>
    <tr> <td> <code title="">Iuml</code> </td> <td> U+00CF </td> </tr>
    <tr> <td> <code title="">Kappa</code> </td> <td> U+039A </td> </tr>
    <tr> <td> <code title="">Lambda</code> </td> <td> U+039B </td> </tr>
    <tr> <td> <code title="">Mu</code> </td> <td> U+039C </td> </tr>
    <tr> <td> <code title="">Ntilde</code> </td> <td> U+00D1 </td> </tr>
    <tr> <td> <code title="">Nu</code> </td> <td> U+039D </td> </tr>
    <tr> <td> <code title="">OElig</code> </td> <td> U+0152 </td> </tr>
    <tr> <td> <code title="">Oacute</code> </td> <td> U+00D3 </td> </tr>
    <tr> <td> <code title="">Ocirc</code> </td> <td> U+00D4 </td> </tr>
    <tr> <td> <code title="">Ograve</code> </td> <td> U+00D2 </td> </tr>
    <tr> <td> <code title="">Omega</code> </td> <td> U+03A9 </td> </tr>
    <tr> <td> <code title="">Omicron</code> </td> <td> U+039F </td> </tr>
    <tr> <td> <code title="">Oslash</code> </td> <td> U+00D8 </td> </tr>
    <tr> <td> <code title="">Otilde</code> </td> <td> U+00D5 </td> </tr>
    <tr> <td> <code title="">Ouml</code> </td> <td> U+00D6 </td> </tr>
    <tr> <td> <code title="">Phi</code> </td> <td> U+03A6 </td> </tr>
    <tr> <td> <code title="">Pi</code> </td> <td> U+03A0 </td> </tr>
    <tr> <td> <code title="">Prime</code> </td> <td> U+2033 </td> </tr>
    <tr> <td> <code title="">Psi</code> </td> <td> U+03A8 </td> </tr>
    <tr> <td> <code title="">Rho</code> </td> <td> U+03A1 </td> </tr>
    <tr> <td> <code title="">Scaron</code> </td> <td> U+0160 </td> </tr>
    <tr> <td> <code title="">Sigma</code> </td> <td> U+03A3 </td> </tr>
    <tr> <td> <code title="">THORN</code> </td> <td> U+00DE </td> </tr>
    <tr> <td> <code title="">Tau</code> </td> <td> U+03A4 </td> </tr>
    <tr> <td> <code title="">Theta</code> </td> <td> U+0398 </td> </tr>
    <tr> <td> <code title="">Uacute</code> </td> <td> U+00DA </td> </tr>
    <tr> <td> <code title="">Ucirc</code> </td> <td> U+00DB </td> </tr>
    <tr> <td> <code title="">Ugrave</code> </td> <td> U+00D9 </td> </tr>
    <tr> <td> <code title="">Upsilon</code> </td> <td> U+03A5 </td> </tr>
    <tr> <td> <code title="">Uuml</code> </td> <td> U+00DC </td> </tr>
    <tr> <td> <code title="">Xi</code> </td> <td> U+039E </td> </tr>
    <tr> <td> <code title="">Yacute</code> </td> <td> U+00DD </td> </tr>
    <tr> <td> <code title="">Yuml</code> </td> <td> U+0178 </td> </tr>
    <tr> <td> <code title="">Zeta</code> </td> <td> U+0396 </td> </tr>
    <tr> <td> <code title="">aacute</code> </td> <td> U+00E1 </td> </tr>
    <tr> <td> <code title="">acirc</code> </td> <td> U+00E2 </td> </tr>
    <tr> <td> <code title="">acute</code> </td> <td> U+00B4 </td> </tr>
    <tr> <td> <code title="">aelig</code> </td> <td> U+00E6 </td> </tr>
    <tr> <td> <code title="">agrave</code> </td> <td> U+00E0 </td> </tr>
    <tr> <td> <code title="">alefsym</code> </td> <td> U+2135 </td> </tr>
    <tr> <td> <code title="">alpha</code> </td> <td> U+03B1 </td> </tr>
    <tr> <td> <code title="">amp</code> </td> <td> U+0026 </td> </tr>
    <tr> <td> <code title="">AMP</code> </td> <td> U+0026 </td> </tr>
    <tr> <td> <code title="">and</code> </td> <td> U+2227 </td> </tr>
    <tr> <td> <code title="">ang</code> </td> <td> U+2220 </td> </tr>
    <tr> <td> <code title="">apos</code> </td> <td> U+0027 </td> </tr>
    <tr> <td> <code title="">aring</code> </td> <td> U+00E5 </td> </tr>
    <tr> <td> <code title="">asymp</code> </td> <td> U+2248 </td> </tr>
    <tr> <td> <code title="">atilde</code> </td> <td> U+00E3 </td> </tr>
    <tr> <td> <code title="">auml</code> </td> <td> U+00E4 </td> </tr>
    <tr> <td> <code title="">bdquo</code> </td> <td> U+201E </td> </tr>
    <tr> <td> <code title="">beta</code> </td> <td> U+03B2 </td> </tr>
    <tr> <td> <code title="">brvbar</code> </td> <td> U+00A6 </td> </tr>
    <tr> <td> <code title="">bull</code> </td> <td> U+2022 </td> </tr>
    <tr> <td> <code title="">cap</code> </td> <td> U+2229 </td> </tr>
    <tr> <td> <code title="">ccedil</code> </td> <td> U+00E7 </td> </tr>
    <tr> <td> <code title="">cedil</code> </td> <td> U+00B8 </td> </tr>
    <tr> <td> <code title="">cent</code> </td> <td> U+00A2 </td> </tr>
    <tr> <td> <code title="">chi</code> </td> <td> U+03C7 </td> </tr>
    <tr> <td> <code title="">circ</code> </td> <td> U+02C6 </td> </tr>
    <tr> <td> <code title="">clubs</code> </td> <td> U+2663 </td> </tr>
    <tr> <td> <code title="">cong</code> </td> <td> U+2245 </td> </tr>
    <tr> <td> <code title="">copy</code> </td> <td> U+00A9 </td> </tr>
    <tr> <td> <code title="">COPY</code> </td> <td> U+00A9 </td> </tr>
    <tr> <td> <code title="">crarr</code> </td> <td> U+21B5 </td> </tr>
    <tr> <td> <code title="">cup</code> </td> <td> U+222A </td> </tr>
    <tr> <td> <code title="">curren</code> </td> <td> U+00A4 </td> </tr>
    <tr> <td> <code title="">dArr</code> </td> <td> U+21D3 </td> </tr>
    <tr> <td> <code title="">dagger</code> </td> <td> U+2020 </td> </tr>
    <tr> <td> <code title="">darr</code> </td> <td> U+2193 </td> </tr>
    <tr> <td> <code title="">deg</code> </td> <td> U+00B0 </td> </tr>
    <tr> <td> <code title="">delta</code> </td> <td> U+03B4 </td> </tr>
    <tr> <td> <code title="">diams</code> </td> <td> U+2666 </td> </tr>
    <tr> <td> <code title="">divide</code> </td> <td> U+00F7 </td> </tr>
    <tr> <td> <code title="">eacute</code> </td> <td> U+00E9 </td> </tr>
    <tr> <td> <code title="">ecirc</code> </td> <td> U+00EA </td> </tr>
    <tr> <td> <code title="">egrave</code> </td> <td> U+00E8 </td> </tr>
    <tr> <td> <code title="">empty</code> </td> <td> U+2205 </td> </tr>
    <tr> <td> <code title="">emsp</code> </td> <td> U+2003 </td> </tr>
    <tr> <td> <code title="">ensp</code> </td> <td> U+2002 </td> </tr>
    <tr> <td> <code title="">epsilon</code> </td> <td> U+03B5 </td> </tr>
    <tr> <td> <code title="">equiv</code> </td> <td> U+2261 </td> </tr>
    <tr> <td> <code title="">eta</code> </td> <td> U+03B7 </td> </tr>
    <tr> <td> <code title="">eth</code> </td> <td> U+00F0 </td> </tr>
    <tr> <td> <code title="">euml</code> </td> <td> U+00EB </td> </tr>
    <tr> <td> <code title="">euro</code> </td> <td> U+20AC </td> </tr>
    <tr> <td> <code title="">exist</code> </td> <td> U+2203 </td> </tr>
    <tr> <td> <code title="">fnof</code> </td> <td> U+0192 </td> </tr>
    <tr> <td> <code title="">forall</code> </td> <td> U+2200 </td> </tr>
    <tr> <td> <code title="">frac12</code> </td> <td> U+00BD </td> </tr>
    <tr> <td> <code title="">frac14</code> </td> <td> U+00BC </td> </tr>
    <tr> <td> <code title="">frac34</code> </td> <td> U+00BE </td> </tr>
    <tr> <td> <code title="">frasl</code> </td> <td> U+2044 </td> </tr>
    <tr> <td> <code title="">gamma</code> </td> <td> U+03B3 </td> </tr>
    <tr> <td> <code title="">ge</code> </td> <td> U+2265 </td> </tr>
    <tr> <td> <code title="">gt</code> </td> <td> U+003E </td> </tr>
    <tr> <td> <code title="">GT</code> </td> <td> U+003E </td> </tr>
    <tr> <td> <code title="">hArr</code> </td> <td> U+21D4 </td> </tr>
    <tr> <td> <code title="">harr</code> </td> <td> U+2194 </td> </tr>
    <tr> <td> <code title="">hearts</code> </td> <td> U+2665 </td> </tr>
    <tr> <td> <code title="">hellip</code> </td> <td> U+2026 </td> </tr>
    <tr> <td> <code title="">iacute</code> </td> <td> U+00ED </td> </tr>
    <tr> <td> <code title="">icirc</code> </td> <td> U+00EE </td> </tr>
    <tr> <td> <code title="">iexcl</code> </td> <td> U+00A1 </td> </tr>
    <tr> <td> <code title="">igrave</code> </td> <td> U+00EC </td> </tr>
    <tr> <td> <code title="">image</code> </td> <td> U+2111 </td> </tr>
    <tr> <td> <code title="">infin</code> </td> <td> U+221E </td> </tr>
    <tr> <td> <code title="">int</code> </td> <td> U+222B </td> </tr>
    <tr> <td> <code title="">iota</code> </td> <td> U+03B9 </td> </tr>
    <tr> <td> <code title="">iquest</code> </td> <td> U+00BF </td> </tr>
    <tr> <td> <code title="">isin</code> </td> <td> U+2208 </td> </tr>
    <tr> <td> <code title="">iuml</code> </td> <td> U+00EF </td> </tr>
    <tr> <td> <code title="">kappa</code> </td> <td> U+03BA </td> </tr>
    <tr> <td> <code title="">lArr</code> </td> <td> U+21D0 </td> </tr>
    <tr> <td> <code title="">lambda</code> </td> <td> U+03BB </td> </tr>
    <tr> <td> <code title="">lang</code> </td> <td> U+2329 </td> </tr>
    <tr> <td> <code title="">laquo</code> </td> <td> U+00AB </td> </tr>
    <tr> <td> <code title="">larr</code> </td> <td> U+2190 </td> </tr>
    <tr> <td> <code title="">lceil</code> </td> <td> U+2308 </td> </tr>
    <tr> <td> <code title="">ldquo</code> </td> <td> U+201C </td> </tr>
    <tr> <td> <code title="">le</code> </td> <td> U+2264 </td> </tr>
    <tr> <td> <code title="">lfloor</code> </td> <td> U+230A </td> </tr>
    <tr> <td> <code title="">lowast</code> </td> <td> U+2217 </td> </tr>
    <tr> <td> <code title="">loz</code> </td> <td> U+25CA </td> </tr>
    <tr> <td> <code title="">lrm</code> </td> <td> U+200E </td> </tr>
    <tr> <td> <code title="">lsaquo</code> </td> <td> U+2039 </td> </tr>
    <tr> <td> <code title="">lsquo</code> </td> <td> U+2018 </td> </tr>
    <tr> <td> <code title="">lt</code> </td> <td> U+003C </td> </tr>
    <tr> <td> <code title="">LT</code> </td> <td> U+003C </td> </tr>
    <tr> <td> <code title="">macr</code> </td> <td> U+00AF </td> </tr>
    <tr> <td> <code title="">mdash</code> </td> <td> U+2014 </td> </tr>
    <tr> <td> <code title="">micro</code> </td> <td> U+00B5 </td> </tr>
    <tr> <td> <code title="">middot</code> </td> <td> U+00B7 </td> </tr>
    <tr> <td> <code title="">minus</code> </td> <td> U+2212 </td> </tr>
    <tr> <td> <code title="">mu</code> </td> <td> U+03BC </td> </tr>
    <tr> <td> <code title="">nabla</code> </td> <td> U+2207 </td> </tr>
    <tr> <td> <code title="">nbsp</code> </td> <td> U+00A0 </td> </tr>
    <tr> <td> <code title="">ndash</code> </td> <td> U+2013 </td> </tr>
    <tr> <td> <code title="">ne</code> </td> <td> U+2260 </td> </tr>
    <tr> <td> <code title="">ni</code> </td> <td> U+220B </td> </tr>
    <tr> <td> <code title="">not</code> </td> <td> U+00AC </td> </tr>
    <tr> <td> <code title="">notin</code> </td> <td> U+2209 </td> </tr>
    <tr> <td> <code title="">nsub</code> </td> <td> U+2284 </td> </tr>
    <tr> <td> <code title="">ntilde</code> </td> <td> U+00F1 </td> </tr>
    <tr> <td> <code title="">nu</code> </td> <td> U+03BD </td> </tr>
    <tr> <td> <code title="">oacute</code> </td> <td> U+00F3 </td> </tr>
    <tr> <td> <code title="">ocirc</code> </td> <td> U+00F4 </td> </tr>
    <tr> <td> <code title="">oelig</code> </td> <td> U+0153 </td> </tr>
    <tr> <td> <code title="">ograve</code> </td> <td> U+00F2 </td> </tr>
    <tr> <td> <code title="">oline</code> </td> <td> U+203E </td> </tr>
    <tr> <td> <code title="">omega</code> </td> <td> U+03C9 </td> </tr>
    <tr> <td> <code title="">omicron</code> </td> <td> U+03BF </td> </tr>
    <tr> <td> <code title="">oplus</code> </td> <td> U+2295 </td> </tr>
    <tr> <td> <code title="">or</code> </td> <td> U+2228 </td> </tr>
    <tr> <td> <code title="">ordf</code> </td> <td> U+00AA </td> </tr>
    <tr> <td> <code title="">ordm</code> </td> <td> U+00BA </td> </tr>
    <tr> <td> <code title="">oslash</code> </td> <td> U+00F8 </td> </tr>
    <tr> <td> <code title="">otilde</code> </td> <td> U+00F5 </td> </tr>
    <tr> <td> <code title="">otimes</code> </td> <td> U+2297 </td> </tr>
    <tr> <td> <code title="">ouml</code> </td> <td> U+00F6 </td> </tr>
    <tr> <td> <code title="">para</code> </td> <td> U+00B6 </td> </tr>
    <tr> <td> <code title="">part</code> </td> <td> U+2202 </td> </tr>
    <tr> <td> <code title="">permil</code> </td> <td> U+2030 </td> </tr>
    <tr> <td> <code title="">perp</code> </td> <td> U+22A5 </td> </tr>
    <tr> <td> <code title="">phi</code> </td> <td> U+03C6 </td> </tr>
    <tr> <td> <code title="">pi</code> </td> <td> U+03C0 </td> </tr>
    <tr> <td> <code title="">piv</code> </td> <td> U+03D6 </td> </tr>
    <tr> <td> <code title="">plusmn</code> </td> <td> U+00B1 </td> </tr>
    <tr> <td> <code title="">pound</code> </td> <td> U+00A3 </td> </tr>
    <tr> <td> <code title="">prime</code> </td> <td> U+2032 </td> </tr>
    <tr> <td> <code title="">prod</code> </td> <td> U+220F </td> </tr>
    <tr> <td> <code title="">prop</code> </td> <td> U+221D </td> </tr>
    <tr> <td> <code title="">psi</code> </td> <td> U+03C8 </td> </tr>
    <tr> <td> <code title="">quot</code> </td> <td> U+0022 </td> </tr>
    <tr> <td> <code title="">QUOT</code> </td> <td> U+0022 </td> </tr>
    <tr> <td> <code title="">rArr</code> </td> <td> U+21D2 </td> </tr>
    <tr> <td> <code title="">radic</code> </td> <td> U+221A </td> </tr>
    <tr> <td> <code title="">rang</code> </td> <td> U+232A </td> </tr>
    <tr> <td> <code title="">raquo</code> </td> <td> U+00BB </td> </tr>
    <tr> <td> <code title="">rarr</code> </td> <td> U+2192 </td> </tr>
    <tr> <td> <code title="">rceil</code> </td> <td> U+2309 </td> </tr>
    <tr> <td> <code title="">rdquo</code> </td> <td> U+201D </td> </tr>
    <tr> <td> <code title="">real</code> </td> <td> U+211C </td> </tr>
    <tr> <td> <code title="">reg</code> </td> <td> U+00AE </td> </tr>
    <tr> <td> <code title="">REG</code> </td> <td> U+00AE </td> </tr>
    <tr> <td> <code title="">rfloor</code> </td> <td> U+230B </td> </tr>
    <tr> <td> <code title="">rho</code> </td> <td> U+03C1 </td> </tr>
    <tr> <td> <code title="">rlm</code> </td> <td> U+200F </td> </tr>
    <tr> <td> <code title="">rsaquo</code> </td> <td> U+203A </td> </tr>
    <tr> <td> <code title="">rsquo</code> </td> <td> U+2019 </td> </tr>
    <tr> <td> <code title="">sbquo</code> </td> <td> U+201A </td> </tr>
    <tr> <td> <code title="">scaron</code> </td> <td> U+0161 </td> </tr>
    <tr> <td> <code title="">sdot</code> </td> <td> U+22C5 </td> </tr>
    <tr> <td> <code title="">sect</code> </td> <td> U+00A7 </td> </tr>
    <tr> <td> <code title="">shy</code> </td> <td> U+00AD </td> </tr>
    <tr> <td> <code title="">sigma</code> </td> <td> U+03C3 </td> </tr>
    <tr> <td> <code title="">sigmaf</code> </td> <td> U+03C2 </td> </tr>
    <tr> <td> <code title="">sim</code> </td> <td> U+223C </td> </tr>
    <tr> <td> <code title="">spades</code> </td> <td> U+2660 </td> </tr>
    <tr> <td> <code title="">sub</code> </td> <td> U+2282 </td> </tr>
    <tr> <td> <code title="">sube</code> </td> <td> U+2286 </td> </tr>
    <tr> <td> <code title="">sum</code> </td> <td> U+2211 </td> </tr>
    <tr> <td> <code title="">sup</code> </td> <td> U+2283 </td> </tr>
    <tr> <td> <code title="">sup1</code> </td> <td> U+00B9 </td> </tr>
    <tr> <td> <code title="">sup2</code> </td> <td> U+00B2 </td> </tr>
    <tr> <td> <code title="">sup3</code> </td> <td> U+00B3 </td> </tr>
    <tr> <td> <code title="">supe</code> </td> <td> U+2287 </td> </tr>
    <tr> <td> <code title="">szlig</code> </td> <td> U+00DF </td> </tr>
    <tr> <td> <code title="">tau</code> </td> <td> U+03C4 </td> </tr>
    <tr> <td> <code title="">there4</code> </td> <td> U+2234 </td> </tr>
    <tr> <td> <code title="">theta</code> </td> <td> U+03B8 </td> </tr>
    <tr> <td> <code title="">thetasym</code> </td> <td> U+03D1 </td> </tr>
    <tr> <td> <code title="">thinsp</code> </td> <td> U+2009 </td> </tr>
    <tr> <td> <code title="">thorn</code> </td> <td> U+00FE </td> </tr>
    <tr> <td> <code title="">tilde</code> </td> <td> U+02DC </td> </tr>
    <tr> <td> <code title="">times</code> </td> <td> U+00D7 </td> </tr>
    <tr> <td> <code title="">trade</code> </td> <td> U+2122 </td> </tr>
    <tr> <td> <code title="">uArr</code> </td> <td> U+21D1 </td> </tr>
    <tr> <td> <code title="">uacute</code> </td> <td> U+00FA </td> </tr>
    <tr> <td> <code title="">uarr</code> </td> <td> U+2191 </td> </tr>
    <tr> <td> <code title="">ucirc</code> </td> <td> U+00FB </td> </tr>
    <tr> <td> <code title="">ugrave</code> </td> <td> U+00F9 </td> </tr>
    <tr> <td> <code title="">uml</code> </td> <td> U+00A8 </td> </tr>
    <tr> <td> <code title="">upsih</code> </td> <td> U+03D2 </td> </tr>
    <tr> <td> <code title="">upsilon</code> </td> <td> U+03C5 </td> </tr>
    <tr> <td> <code title="">uuml</code> </td> <td> U+00FC </td> </tr>
    <tr> <td> <code title="">weierp</code> </td> <td> U+2118 </td> </tr>
    <tr> <td> <code title="">xi</code> </td> <td> U+03BE </td> </tr>
    <tr> <td> <code title="">yacute</code> </td> <td> U+00FD </td> </tr>
    <tr> <td> <code title="">yen</code> </td> <td> U+00A5 </td> </tr>
    <tr> <td> <code title="">yuml</code> </td> <td> U+00FF </td> </tr>
    <tr> <td> <code title="">zeta</code> </td> <td> U+03B6 </td> </tr>
    <tr> <td> <code title="">zwj</code> </td> <td> U+200D </td> </tr>
    <tr> <td> <code title="">zwnj</code> </td> <td> U+200C </td> </tr>
   </tbody>
  </table>



  <h2 id="wysiwyg">WYSIWYG editors</h2>

  <p><dfn>WYSIWYG editors</dfn> are authoring tools with a
  predominantly presentation-driven user interface.</p>


  <h3>Presentational markup</h3>


  <h4><dfn>WYSIWYG signature</dfn></h4>

  <p>WYSIWYG editors must include a <code>meta</code> element in the
  <code>head</code> element whose <code
  title="attr-meta-name">name</code> attribute has the value <code
  title="meta-generator">generator</code> and whose <code
  title="attr-meta-content">content</code> attribute's value ends with
  the string "<code title="">(WYSIWYG editor)</code>". Non-WYSIWYG
  authoring tools must not include this string in their generator
  string.</p>


  <h4>The <dfn><code>font</code></dfn> element</h4>

  <p><span>Transparent</span> <span title="block-level
  elements">block-level element</span>, and <span>transparent</span>
  <span>strictly inline-level content</span>.</p>

  <dl class="element">
   <dt>Contexts in which this element may be used:</dt>
   <dd>Where <span>block-level content</span> is allowed.</dd>
   <dd>Where <span>strictly inline-level content</span> is allowed.</dd>
   <dt>Content model:</dt>
   <dd><span>Transparent</span>.</dd>
   <dt>Element-specific attributes:</dt><!--
   <dd><code title="attr-font-color">color</code></dd>
   <dd><code title="attr-font-face">face</code></dd>
   <dd><code title="attr-font-size">size</code></dd>-->
   <dd><code title="attr-font-style">style</code></dd>
   <dt>Predefined classes that apply to this element:</dt>
   <dd>None.</dd>
   <dt>DOM interface:</dt>
   <dd>
<pre class="idl">interface <dfn>HTMLFontElement</dfn> : <span>HTMLElement</span> {<!--
           attribute DOMString <span title="dom-font-color">color</span>;
           attribute DOMString <span title="dom-font-face">face</span>;
           attribute DOMString <span title="dom-font-size">size</span>;-->
  readonly attribute CSSStyleDeclaration <span title="dom-font-style">style</span>;
};</pre>
   </dd>
  </dl>

  <p>The <code>font</code> element doesn't represent anything. It must
  not be used except by <span>WYSIWYG editors</span>, which may use it
  to achieve presentational affects. Even WYSIWYG editors, however,
  should make every effort to use appropriate semantic markup and
  avoid the use of media-specific presentational markup.</p>

  <p>Conformance checkers must consider this element to be
  non-conforming if it is used on a page lacking the <span>WYSIWYG
  signature</span>.</p>

  <p>A <code>font</code> element can only contain content that would
  still be conformant if all elements with <span>transparent</span>
  content models were replaced by their contents.</p>

  <div class="example">

   <p>The following would be syntactically legal (as the output from a
   WYSIWYG editor, though not anywhere else):</p>

   <pre>&lt;!DOCTYPE HTML>
&lt;html>
 &lt;head>
  &lt;title>&lt;/title>
  &lt;meta name="generator" content="Sample Editor 1.0 <em>(WYSIWYG editor)</em>">
 &lt;/head>
 &lt;body>
  &lt;font style="display: block; border: solid">
   &lt;h1>Hello.&lt;/h1>
  &lt;/font>
  &lt;p>
   &lt;font style="color: orange; background: white">How&lt;/font>
   &lt;font style="color: yellow; background: white">do&lt;/font>
   &lt;font style="color: green; background: white"><em>&lt;em></em>you<em>&lt;/em></em>&lt;/font>
   &lt;font style="color: blue; background: white">do?&lt;/font>
  &lt;/p>
 &lt;/body>
&lt;/html></pre>

   <p>The first <code>font</code> element is conformant because
   <code>h1</code> and <code>p</code> elements are both allowed in
   <code>body</code> elements. the next four are allowed because text
   and <code>em</code> elements are allowed in <code>p</code>
   elements.</p>

  </div>

  <p>The <dfn title="attr-font-style"><code>style</code></dfn>
  attribute, if specified, must contain only a list of zero or more
  semicolon-separated (;) CSS declarations. <a
  href="#refsCSS21">[CSS21]</a></p>

  <!-- XXX deal with each of the use cases in this:
  http://lists.w3.org/Archives/Public/www-html/2003Jan/0277.html -->

  <p>The declarations specified must be parsed and treated as the body
  of a declaration block whose selector matches just that
  <code>font</code> element. For the purposes of the CSS cascade, the
  attribute must be considered to be a 'style' attribute at the author
  level.</p>

  <p>The <dfn title="dom-font-style"><code>style</code></dfn> DOM
  attribute must return a <code>CSSStyleDeclaration</code> whose value
  represents the declarations specified in the attribute, if
  present. Mutating the <code>CSSStyleDeclaration</code> object must
  create a <code title="attr-font-style">style</code> attribute on the
  element (if there isn't one already) and then change its value to be
  a value representing the serialised form of the
  <code>CSSStyleDeclaration</code> object. <a
  href="#refsCSSOM">[CSSOM]</a>



  <h2 id="rendering">Rendering</h2>

  <p class="big-issue">This section will probably include details on
  how to render DATAGRID (including <span id="datagridPseudos">its
  pseudo-elements</span>), drag-and-drop, etc, in a visual medium, in
  concert with CSS. Terms that need to be defined include: <dfn>sizing
  of embedded content</dfn></p>

  <p>CSS UAs in visual media must, when scrolling a page to a fragment
  identifier, align the top of the viewport with the target element's
  top border edge.</p> <!-- XXX horiz pos given bidi, and not
  scrolling when not required to? -->

<!-- Elements that have been dropped: ACRONYM APPLET B BASEFONT BLINK
BIG CENTER DIR DIV FONT FRAME FRAMESET I ISINDEX MARQUEE NOEMBED
NOFRAMES S SPACER STRIKE TT U -->

<!-- XXX bits and pieces that were removed from the semantic parts:

  <p>In CSS-aware user agents, the default presentation of this
  element should be achieved by including the following rules, or
  their equivalent, in the UA's user agent style sheet:</p>

  <pre>@namespace xh url(http://www.w3.org/1999/xhtml);
xh|section { display: block; margin: 1em 0; }</pre>

  <h4>Section headers</h4>

  <p>For <code>h1</code> elements, CSS-aware visual user agents should
  derive the size of the header from the level of <code>section</code>
  nesting. This effect should be achieved by including the following
  rules, or their equivalent, in the UA's user agent style sheet:</p>

  <pre>@namespace xh url(http://www.w3.org/1999/xhtml);
xh|section xh|h1 { /* same styles as h2 */ }
xh|section xh|section xh|h1 { /* same styles as h4 */ }
xh|section xh|section xh|section xh|h1 { /* same styles as h4 */ }
xh|section xh|section xh|section xh|section xh|h1 { /* same styles as h5 */ }
xh|section xh|section xh|section xh|section xh|section xh|h1 { /* same styles as h6 */ }</pre>

  <p>Authors should use <code>h1</code> elements to denote headers in
  sections. Authors may instead use <code>h2</code> ...
  <code>h6</code> elements, for backwards compatibility with user
  agents that do not support <code>section</code> elements.</p>

-->



  <h3>Rendering and the DOM</h3>

  <p class="big-issue">This section is wrong. mediaMode will end up on
  Window, I think. All views implement Window.</p>

  <p>Any object implement the <code>AbstractView</code> interface must
  also implement the <code>MediaModeAbstractView</code> interface.</p>

  <pre class="idl">interface <dfn>MediaModeAbstractView</dfn> {
  readonly attribute DOMString <span>mediaMode</span>;
};</pre>

  <p>The <dfn><code>mediaMode</code></dfn> attribute on objects
  implementing the <code>MediaModeAbstractView</code> interface must
  return the string that represents the canvas' current rendering mode
  (<code>screen</code>, <code>print</code>, etc). This is a lowercase
  string, as <a
  href="http://www.w3.org/TR/CSS21/media.html#media-types">defined by
  the CSS specification</a>. <a href="#refsCSS21">[CSS21]</a></p>

  <p>Some user agents may support multiple media, in which case there
  will exist multiple objects implementing the
  <code>AbstractView</code> interface. Only the default view
  implements the <code>Window</code> interface. The other views can be
  reached using the <code>view</code> attribute of the
  <code>UIEvent</code> inteface, during event propagation. There is no
  way currently to enumerate all the views.</p>

  <!-- XXX examples! -->



  <h2 id="no">Things that you can't do with this specification because
  they are better handled using other technologies that are further
  described herein</h2>

  <p><em>This section is non-normative.</em></p>

  <p>There are certain features that are not handled by this
  specification because a client side markup language is not the right
  level for them, or because the features exist in other languages
  that can be integrated into this one. This section covers some of
  the more common requests.</p>

  <h3>Localisation</h3>

  <p>If you wish to create localised versions of an HTML application,
  the best solution is to preprocess the files on the server, and then
  use HTTP content negotation to serve the appropriate language.</p>

  <!-- <p>XXX example here</p> -->

  <h3>Declarative 2D vector graphics and animation</h3>

  <p>Embedding vector graphics into XHTML documents is the domain of
  SVG.</p>

  <!-- <p>XXX example here</p> -->

  <h3>Declarative 3D scenes</h3>

  <p>Embedding 3D imagery into XHTML documents is the domain of X3D,
  or technologies based on X3D that are namespace-aware.</p>

  <!-- <p>XXX example here</p> -->



  <h3 id="timers">Timers</h3>

  <p>This section is expected to be moved to the Window Object
  specification in due course.</p>

<pre class="idl">
interface <dfn>WindowTimers</dfn> {
  // timers
  long <span>setTimeout</span>(in <span>TimeoutHandler</span> handler, in long timeout);
  long <span>setTimeout</span>(in <span>TimeoutHandler</span> handler, in long timeout, <var title="">arguments...</var>);
  long <span>setTimeout</span>(in DOMString code, in long timeout);
  long <span>setTimeout</span>(in DOMString code, in long timeout, in DOMString language);
  void <span>clearTimeout</span>(in long handle);
  long <span>setInterval</span>(in <span>TimeoutHandler</span> handler, in long timeout);
  long <span>setInterval</span>(in <span>TimeoutHandler</span> handler, in long timeout, <var title="">arguments...</var>);
  long <span>setInterval</span>(in DOMString code, in long timeout);
  long <span>setInterval</span>(in DOMString code, in long timeout, in DOMString language);
  void <span>clearInterval</span>(in long handle);
};

interface <dfn>TimeoutHandler</dfn> {
  void handleEvent(<var title="">arguments...</var>);
};
</pre>

  <p>The <code>WindowTimers</code> interface must be obtainable from
  any <code>Window</code> object using binding-specific casting
  methods.</p>

  <p>The <code>setTimeout</code> and <code>setInterval</code> methods
  allow authors to schedule timer-based events.</p>

  <p>The <dfn title="setTimeout"><code>setTimeout(<var
  title="">handler</var>, <var title="">timeout</var>[, <var
  title="">arguments...</var>])</code></dfn> method takes a reference
  to a <code>TimeoutHandler</code> object and a length of time in
  milliseconds. It must return a handle to the timeout created, and
  then asynchronously wait <var title="">timeout</var> milliseconds
  and then invoke <code>handleEvent()</code> on the <var
  title="">handler</var> object. If any <var
  title="">arguments...</var> were provided, they must be passed to
  the <var title="">handler</var> as arguments to the
  <code>handleEvent()</code> function.</p>

  <p>In the ECMAScript DOM binding, the ECMAScript native
  <code>Function</code> type must implement the
  <code>TimeoutHandler</code> interface such that invoking the
  <code>handleEvent()</code> method of that interface on the object
  from another language binding invokes the function itself, with the
  arguments passed to <code>handleEvent()</code> as the arguments
  passed to the function. In the ECMAScript DOM binding itself, however,
  the <code>handleEvent()</code> method of the interface is not
  directly accessible on <code>Function</code> objects. Such functions
  must be called in the <span>global scope</span><!--XXX-->.</p>

  <p>Alternatively, <dfn title=""><code>setTimeout(<var
  title="">code</var>, <var title="">timeout</var>[, <var
  title="">language</var>])</code></dfn> may be used. This variant
  takes a string instead of a <code>TimeoutHandler</code> object. That
  string must be parsed using the specified <var title="">language</var>
  (defaulting to ECMAScript if the third argument is omitted) and
  executed in the <span>global scope</span><!--XXX-->.</p>

  <p class="big-issue">Need to define <var title="">language</var> values.</p>

  <p>The <dfn><code>setInterval(...)</code></dfn> variants must work
  in the same way as the <code>setTimeout</code> variants except that
  the <var title="">handler</var> or <code>code</code> must be invoked
  again every <var title="">timeout</var> milliseconds, not just the
  once.</p>

  <p>The <dfn><code>clearTimeout()</code></dfn> and
  <dfn><code>clearInterval()</code></dfn> methods take one integer (the
  value returned by <code>setTimeout</code> and
  <code>setInterval</code> respectively) and must cancel the specified
  timeout. When called with a value that does not correspond to an
  active timeout or interval, the methods must return without doing
  anything.</p>

  <p>Timeouts must never fire while another script is executing. (Thus
  the HTML scripting model is strictly single-threaded and not
  reentrant.)</p>



  <h2 class="no-num" id="references">References</h2>

  <p class="big-issue">This section will be written in a future
  draft.<!--XXX--></p>



  <h2 class="no-num">Acknowledgements</h2>

  <p>Thanks to Aankhen, Aaron Leventhal, Alexey Feldgendler, Anne van
  Kesteren, Anthony Hickson, Asbj&oslash;rn Ulsberg, Ben Godfrey, Ben
  Meadowcroft, Benjamin Hawkes-Lewis, Bjoern Hoehrmann, Boris Zbarsky,
  Brad Fults, Brad Neuberg, Brendan Eich, Brett Wilson, Channy Yun,
  Charl van Niekerk<!--status.whatwg.org maintainer-->, Charles
  McCathieNevile, Christian Biesinger, Christian Johansen, Chriswa,
  Daniel Peng, Darin Fisher, Dave Townsend<!-- Mossop on moz irc -->,
  David Baron, David Flanagan, David H&aring;s&auml;ther, David Hyatt,
  Derek Featherstone, Dimitri Glazkov, dolphinling, Doron Rosenberg,
  Eira Monstad, Elliotte Harold, Erik Arvidsson, fantasai, Franck
  'Shift' Qu&eacute;lain, H&aring;kon Wium Lie, Henri Sivonen, Henrik
  Lied, Ignacio Javier, J. King, James Graham, James M Snell, James
  Perrett, Jan-Klaas Kollhof, Jasper Bryant-Greene, Jens Bannmann,
  Joel Spolsky, Johnny Stenback, Jon Perlow, Jonathan Worent, Jorgen
  Horstink, Joshua Randall, Jukka K. Korpela, Kai Hendry, Kornel
  Lesinski, &#x9ed2;&#x6fa4;&#x525b;&#x5fd7; (KUROSAWA Takeshi),
  Lachlan Hunt, Larry Page, Laurens Holst, Lenny Domnitser,
  L&eacute;onard Bouchet, Leons Petrazickis, Logan<!-- on moz irc -->,
  Maciej Stachowiak, Malcolm Rowe, Mark Nottingham, Mark Schenk,
  Martijn Wargers, Martin Atkins, Martin Honnen, Mathieu Henri,
  Matthew Mastracci, Matthew Raymond, Matthew Thomas, Mattias Waldau,
  Max Romantschuk, Michael 'Ratt' Iannarelli, Michael A. Nachbaur,
  Michael Gratton, Michel Fortin, Mihai &#x015E;ucan<!-- from ROBO
  Design -->, Mike Dierken<!-- S. Mike Dierken -->, Mike Dixon, Mike
  Schinkel, Mike Shaver, Mikko Rantalainen, Neil Deakin, Olav Junker
  Kj&aelig;r, Rimantas Liubertas, Robert O'Callahan, Robert Sayre,
  Roman Ivanov, S. Mike Dierken, Sam Ruby, Shadow2531, Shaun Inman,
  Simon Pieters, Stefan Haustein, Stephen Ma, Steve Runyon, Steven
  Garrity, Stewart Brodie, Stuart Parmenter, Tantek &Ccedil;elik,
  Thomas Broyer, Thomas O'Connor, Tim Altman, Vladimir
  Vuki&#x0107;evi&#x0107;, William Swanson, and everyone on the WHATWG
  mailing list for their useful and substantial comments.</p>

  <p>Special thanks to Richard Williamson for creating the first
  implementation of <code>canvas</code> in Safari, from which the
  canvas feature was designed.</p>

  <p>Special thanks also to the Microsoft employees who first
  implemented the event-based drag-and-drop mechanism, <code
  title="attr-contenteditable">contenteditable</code>, and other
  features first widely deployed by the Windows Internet Explorer
  browser.</p>

  <p>Special thanks and $10,000 to David Hyatt who came up with a
  broken implementation of the <a href="#adoptionAgency">adoption
  agency algorithm</a> that the editor had to reverse engineer and fix
  before using it in the parsing section.</p>

  <p>Thanks also the Microsoft blogging community for some ideas, to
  the attendees of the W3C Workshop on Web Applications and Compound
  Documents for inspiration, and to the #mrt crew, the #mrt.no crew,
  and the cabal for their ideas and support.</p>

  <!-- Hopefully Kam won't notice he's covered by these
  acknowledgements three times! -->

<!--
 !  menus

<hyatt> the ability to get the current focused window in a window hierarchy

wizards
tabbed interface

Application object? http://longhorn.msdn.microsoft.com/lhsdk/ref/ns/msavalon.windows/c/application/application.aspx

<input type="text" menu="foo" icon="g.png"/> <menu id="foo"> <menuitem icon="g.png" onclick="engine('google')">Google</menuitem> ... </menu>

> One more aspect I want you think about - for "user interface systems" in
> general: The windowing system.
>   Different kinds of windows ("document", "browser (file-system/network or
> otherwise)", "palette", "application modal dialog", "system modal dialog"),
> the rules for layering them (appropriately flexible to allow different
> implementations, e.g. MacOS vs. X-Windows), and simplifications for handheld
> devices (which are sometimes single window devices anyway, but sometimes
> they are one "normal" window plus sometimes one "dialog" window on top.

window.open for dialogs


Thus, they lack things like proper windows, tree 
widgets, menu bars, rich text areas and so forth. This is what I would 
like XUL to solve. - Paul Prescod




Olav:
> <product> to indicate something you can buy, like a cd on amazon
> or a biker jacket at harleydavidson.com


Drop downs often have a title for when there is no selection.

http://www.w3.org/mid/BAY1-F150PNOkJvX41K000418e1@hotmail.com

http://crew.tweakers.net/crisp/newlayout/index.html
http://crew.tweakers.net/crisp/newlayout/list_topics.html
http://crew.tweakers.net/crisp/newlayout/list_messages.html
http://crew.tweakers.net/crisp/newlayout/list_messages_mod.html

http://mail.mozilla.org/private/gui-toolkit/2004-April/000041.html

> > > A standard for rich edit widgets would also be of interest to me.
> >
> > As in WYSIWIG editing? Of the bold/italic/underline/larger/smaller kind?
> > 
> > Or do you mean as in the bare bones to be able to build an editor on top
> > of? As in something that basically just gives you a cursor and the ability
> > to tell where the selection is and some way to hook into the Undo
> > functionality?
> 
> I have use cases for both...I have a more desperate business need for
> the latter (and have build apps using the gross APIs out there today)
> but there are a lot of circumstances where an editor that already has
> all standard HTML editing behaviour would be fine.
>
- Paul Prescod

 * a way of selecting rows, so that you can declaratively have buttons
   outside the template that move a "selected row" around. => web apps


Calendar with list of days that have events (think: blog calendars)

Find object at (x,y)
Find mouse position

Styling scrollbars:

   ::scrollbars { ... }


table of contents?


http://www.gadgetopia.com/2004/05/04/FileIconTag.html


on going back
on going forward
on came from back
on came from forward
better state serialisation for going back/forward


some sort of markup to tell google _not_ to index a particular part of the site

drop down menu with URIs to replace the silly <select> hacks.

http://www.cs.tut.fi/~jkorpela/html/em.html

<htmlarea>, <xmlarea>...

> 3) Extensible syntax highlighting (coloring). I am aware that a ton of
> code editors don't even do this well. The ability to load a syntax
> definition file and have it color a block of code would do wonders for
> making the web a more friendly place to script.
 - Ryan Johnson

toolbars, status bars. - Didier PH Martin

   * methods/properties for scrolling managing, especially in
   TextArea, such as .scrollTop and .scrollHeight in Mozilla and -


Robert Bateman:

   I've looked thru as many of the examples from around the web as I can find and
   don't see an obvious way to do date calculations.

   What I'm trying to do is populate an xsd:date field with now() plus 5 days as
   it's default value.  The field in question is a proposed "due date" for a
   work order.

   I've seen that I can get a "difference" between two dates, but no
   calculations.


Wladimir Palant pointed out problems with chunking with server-sent-events



> 2.  Some method of integration to allow Web apps to respond
>      to the browser's Cut, Copy, Paste, and Select All menu
>      items and keyboard equivalents. These work automatically
>      for text fields in any Web application; it would be
>      great if apps could make them work for stocks, address
>      book cards, message attachments, transactions, photos,
>      and so on too.
>
>      I'd add Undo and Redo to that list, but unfortunately
>      IE6 doesn't have Undo and Redo menu items.
 - mpt



>> maybe except for the server sent events and the clipboard
>> api (but even in those cases it might be possible).
>
> Clipboard API I don't really want to see, given the problems IE's
> implementation of such brought up. A better standardised drag-and-drop
> interface would be great though, as doing it with mouse events and IE's
> proprietary events is annoying-to-impossible to get right all the time.
>
> I really like the idea of server-side events, though I would prefer to
> have them set up by a scripting call rather than an HTML element.
 - Andrew Clover


    <html application="application">

...would, instead of showing the Web page itself, the first time, show
(inline in the browser):

  :::: Security Warning :::::::::::::::::::::::::::::::::::::
  ::                                                       ::
  ::  The Web page at this domain:                         ::
  ::                                                       ':
  ::     paypcl.com                                        
  ::                                                       
  ::  ...wishes to launch an application in a separate     
  ::  window. Do you trust this domain?                    
  ::                                                       
  ::  [x] Remember this decision.                          
  ::                                                       
  ::      (( Trust paypcl.com ))  ( Display as Web page )  
  ::                                                      
  :::::.
- (spurred on by Jose Dinuncio)


  :::: Security Warning :::::::::::::::::::::::::::::::::::::
  ::                                                       ::
  ::  This Web page wishes to launch an application in a   ::
  ::  separate window. Do you trust this domain?           ::
  ::                                                       ::
  ::     paypcl.com                                         '
  ::                                                       
  ::             ( Trust this site for now )
  ::
  ::              ( Always trust this site )
  ::
  ::              (( Display as Web page ))
  ::                                                      
  :::::.


breadcrumb navigation markup
other markup:
   http://www.stuffandnonsense.co.uk/archives/whats_in_a_name_pt2.html


common icons: http://www.intersmash.com/300images/


http://www.gadgetopia.com/2004/06/18/DoYouWantToSaveYourChanges.html#Comments

http://www.mojavelinux.com/cooker/demos/domTT/index.html

http://www.mozilla.org/projects/ui/accessibility/dynamic-accessibility.html

http://blog.colorstudy.com/ianb/weblog/2004/06/23.html
http://daringfireball.net/2004/06/location_field

listview/gridview API
http://www.activewidgets.com/grid/


> I would rather have it that changing the dom attribute 'value' or typing
> in the textarea, would also change the contents of the textnode in the
> textarea.
>
> In that way the dom level 2 traversal and range specification would not
> be useless for textarea's.
> 
> The same goes for input text controls and probably also for other form
> controls.
 - martijnw



1. point to an xml instance and cause the page to be filled in
2. serialise the site to a version of that xml instance

<menu>
 <li state="bar"/>
</menu>
<button state="bar"/>
<state id="bar" label="" disabled="" value=""/>

<input state="foo"/>
<input state="foo"/>
<input state="foo 2"/>
<input state="foo 2"/>
<state id="foo" model="x" ref="cat:orderLine[$v1]/cat:foo"/>

<instance src=""/>

<instance id="x">

<Order xmlns="urn:oasis:names:tc:ubl:Order:1.0:0.70" xmlns:cat="urn:oasis:names:tc:ubl:CommonAggregateTypes:1.0:0.70">
  <cat:ID/>
  <cat:IssueDate/>
  <cat:LineExtensionTotalAmount currencyID="USD"/>
  <cat:BuyerParty>
    <cat:ID/>
    <cat:PartyName>
      <cat:Name/>
    </cat:PartyName>
    <cat:Address>
      <cat:ID/>
      <cat:Street/>
      <cat:CityName/>
      <cat:PostalZone/>
      <cat:CountrySub-Entity/>
    </cat:Address>
    <cat:BuyerContact>
      <cat:ID/>
      <cat:Name/>
    </cat:BuyerContact>
  </cat:BuyerParty>
  <cat:SellerParty>
    <cat:ID/>
    <cat:PartyName>
      <cat:Name/>
    </cat:PartyName>
    <cat:Address>
      <cat:ID/>
      <cat:Street/>
      <cat:CityName/>
      <cat:CountrySub-Entity/>
    </cat:Address>
  </cat:SellerParty>
  <cat:DeliveryTerms>
    <cat:ID/>
    <cat:SpecialTerms/>
  </cat:DeliveryTerms>
  <cat:OrderLine>
    <cat:BuyersID/>
    <cat:SellersID/>
    <cat:LineExtensionAmount currencyID=""/>
    <cat:Quantity unitCode="">1</cat:Quantity>
    <cat:Item>
      <cat:ID/>
      <cat:Description>Enter description here</cat:Description>
      <cat:SellersItemIdentification>
        <cat:ID>Enter part number here</cat:ID>
      </cat:SellersItemIdentification>
      <cat:BasePrice>
        <cat:PriceAmount currencyID="">0.00</cat:PriceAmount>
      </cat:BasePrice>
    </cat:Item>
  </cat:OrderLine>
</Order> 

</instance>




  <h2>Tree and List Widgets</h2>
   click item to go uri
   doube click to submit form with value
   sort list by any column
   specify column headers, column sort types
   specify data inline, or out of band
   data can be linear or a one way tree
   rows can have an icon associated with them
   rows can have overlays associated with them

 progress meter

    http://www.gazingus.org/html/menuDropdown.html



Disclosure triangles


I think UAs should automatically highlight the accesskey (or add it in    
brackets if it isn't already in the string). I am thinking of writing some
text - optional, of course, since this wouldn't apply to all UAs or all  
platforms - that specifies this.

I also think that there should be an accesskey value which is basically   
"auto", and which picks a non-clashing access key based on the element    
content.



| adding HTTP authentication capabilities to HTML allow sites to:
|   - remove a site's authentication state from the browser when
|     activated (i.e., a "log out" interface)
|   - add user data to a site's authentication state in the browser
|     (i.e., "log on" interfaces)
|   - display the user's current authentication state
| 
| There are a few good reasons to do this. Many sites use cookies to
| authenticate users, because HTTP authentication doesn't have any
| mechanism to allow logging out (a key requirement of financial
| institutions and other sensitive applications), and because the UI for
| HTTP authentication can't be controlled, and doesn't offer an
| "anyonymous" / "not logged in" view.
| 
| By accommodating HTTP authentication in Web forms, it will be possible
| to have styled, custom "log on" interfaces as part of pages, as well
| as "log out" facilities, while still retaining the benefits of HTTP
| authentication.
| 
| Specifically, HTTP authentication is more secure than cookies (when
| Digest auth is used), and is more amenable to automated processes
| (agents, spiders, etc.) as well as alternate browsing devices (screen
| readers, etc.).


http://jogin.com/weblog/archives/2004/07/19/hierarchy


Yeah, <header> and <footer> or similar elements are almost certainly going
to be defined at some point, along with <content> (for the main body of
the page), <entry> or <post> or <article> to refer to a unit of text
bigger than a section but smaller than a page, <aside> to mean a
side bar, <note> to mean a note... and so forth. Suggestions welcome.     
We'll probably keep it to a minimum though. The idea is just to relieve   
the most common pseudo-semantic uses of <div>.


http://lxr.mozilla.org/seamonkey/source/dom/public/idl/base/nsIDOMWindow.idl
scrollBy, etc
http://lxr.mozilla.org/seamonkey/source/dom/public/idl/base/nsIDOMWindowInternal.idl
DOM level 0


DH: I was arguing that you should be able to get the CSS info for
document fragments if you had an owner document with CSS in it.



So maybe:

   var library = new ZipFile("data.zip");
   library.onload = function() {
      var sound1 = library.getAudio("sound1.wav"); // returns an Audio object
      var image1 = library.getImage("image1.png"); // returns an HTMLImageElement
      var doc1 = library.getXMLDocument("doc1.xml"); // returns a Document
      var doc2 = library.getHTMLDocument("doc1.html"); // returns an HTMLDocument
   }

Also maybe supporting more than one file at a time:

   var library = new ResourceLoader("data.zip");
   library.add("moredata.zip");
   library.onload = function() { ... }
   library.onloading = function() {
      reportLoadProgress(library.progress); // 0.0 .. 1.0
   }

...although I'm not sure how we would then deal with filename clashes.

   var library = new AudioZip("sounds.zip");
   library.onload = function() {
      var sound1 = library["sound1.wav"];
      sound.play();
   }


If we define onbeforeunload, then we have to say that the JS
implementation of EventListener::handleEvent checks for that event,
treating the return value as the string to use for the unload warning
message if there is a return value, and calling preventDefault if
there isn't.


> > > Schematic editors, layout editors, interactive maps, data 
> > > visualization for network flows, etc.
> Searching the web for the above keywords should find you a lot more.
 - Denis Bohm



Jens Meiert:
- For non-native English speakers, it's sometimes difficult to understand
the difference between <cite /> and <quote />, since citations often seem to
be quoted, too (this is a presentational aspect, I know).
- Is it right that the <dfn /> element [1] /must/ be used only in the
context of the definition of the enclosed term (as the example suggests)?
(If so, wouldn't it be useful to add this note, too?)


http://secunia.com/advisories/9711/
In particular number 7. - Chris Hofmann


> [1] http://www.stopdesign.com/log/2004/08/25/microsoft-advances.html
> [2] http://www.stopdesign.com/articles/throwing_tables/


In other areas, however, the replacement is not a match in terms of functionality. Like it or not, but showModalDialog is a better way to provide feature-rich user feedback windows than window.confirm (which Firefox supports, even though there is NO PUBLIC STANDARD for it). With showModalDialog, I can pop a window offering "Yes," "No," or "Cancel" buttons that requires a response before proceeding. With window.confirm, I have to craft all my questions as something to which "OK" or "Cancel" makes sense, never mind asking for three, four, or five state responses.
- http://news.zdnet.com/2100-9588-5438955.html ( John Carroll )



> http://channel9.msdn.com/wiki/default.aspx/Channel9.InternetExplorerFeatureRequests
>    Alternate way of caching content
>    Avalon Integration
>    getData/setData improvement (clipboardData)
>    Input type=file improvements
>    HTML editing: Editing Tables
>    Input type=file improvements
>    .NET framework
>    
> http://channel9.msdn.com/wiki/default.aspx/Channel9.InternetExplorerOutrageous
>     Some decent controls
 - lachlan.hunt@lachy.id.au


http://lists.w3.org/Archives/Member/w3c-html-wg/2004JulSep/att-0135/role072704a.html


> I've encountered two situations where setting or retrieving the caret
> position would be useful.  The first is a situation where I'd like to
> apply an input mask to a text box.  For example, I'd like the ability to
> create a text box where the date delimiters (dashes or slashes) appear  
> automatically in a text box upon entering the field, and when the user  
> types in the field, it fills into the appropriate spaces in the input    
> box and sets the text selection to the next appropriate position, all    
> while allowing the user to reposition the cursor within the text box     
> with a keyboard or mouse without being able to edit or delete the
> delimiters (dashes or slashes).  This would be very similar to input
> mask features in certain native apps that I've used.
 - Greg Kilwein

> The second situation is an application that would like to highlight text  
> in a text box or textarea for the purposes of a spell check, thesaurus, 
> or search-and-replace operation.
 - Greg Kilwein




HTMLImageElement.click(x, y); (for Csaba Gabor)
or clickPoint, if click() can't be done in IE
can this be emulated in IE by posting a synthetic moue click event
with those X and Y coords?


<menulabel>, or rather menus in general, need an icon attribute and a
hide attribute, like the <command> element.


What about safe clipboard access.
As discussed before by others as well:
The user initiates a paste action as recognized by the UISystem the user is working in.
E.g pressing Ctrl-V or selecting paste from a context menu.
An event is fired and a Listener can now access the pasted data as part of the event object.
The same for cut and copy. The Listner can set data as part of the event object.
This is safe and will not allow any script to mess with the clipboard without the user specifically asking for it
by initiating a cut/copy/paste action.
 -  Jan-Klaas Kollhof


Need to say that NodeList's items are enumerable, so that for (var x in myNodeList) { } works.
 thank Dethe Elza

rel="" on submit buttons?

what does <label> _mean_? how about an empty one, one which contains
more than one control, no controls?


data: URIs and same-origin policy when navigated to from http:?
 - Hallvord Reiar Michaelsen Steen


need conformance section for editors, which says stuff like "can't be
conforming if editor has an "italics" button"

people want multiline tooltips with explicit line breaks



attributes of type ID that have no value beyond the empty string do
not give the element an ID of "".


ability for a web app to save a file to the local disk:
   var file = window.openFile(); // throws up UI
   file.read();
   var file = window.saveAsFile(); // throws up UI
   file.write();
...or something? Or use data: URIs and right-click-to-save?

http://lxr.mozilla.org/mozilla/source/dom/public/idl/html/nsIDOMNSHTMLDocument.idl


  <p><em>This section is non-normative.</em></p>


how to handle 404s and 500s and other non-OK responses when it comes
to <script>, <link>, <style>, etc.


normative classes:
  -example
  -note
  -warning
  -issue
  hCard, hCalendar
  wiki based registration, first come first served
   * class:
   * applies to elements:
   * processing model:
   * status:


<Hixie> vlad: you should define what the UA should do with out-of-order aDATs
<pav> its an error
<pav> pretty sure we say that somewhere
<Hixie> yes i know it's an error
<Hixie> but that doesn't say what the UA should do
<pav> error == image is invalid
<vlad> yep
<vlad> either broken image icon
<vlad> or display first frame (fall back to normal PNG)
<vlad> up to the UA
<Hixie> right
<Hixie> you should say which one
<pav> its up to the UA
<Hixie> why?
<vlad> "SHOULD display the first frame, but MAY display broken image icon if that's not convenient", in rfc parlance
<vlad> because it's not useful to specify that, IMO
<Hixie> up to the UA means one UA will implement something, it'll become a popular UA, then all the others will have to copy it.
<vlad> how a UA wants to handle image errors is up to the UA
<pav> we're designing an image format, not the html image tag
<pav> the html spec should say what to do with it


should we say that elements in HTML must be lowercase? (but with error
handling for uppercase tags, obviously)? If so, update examples.

<title> is for out of context headers
<h1> is for in-context headers

The parsing rules of HTML

media="" is case-insensitive
case-sensitivity of other attributes, and what it means

empty title attribute is equivalent to missing attribute for purposes
of alternate style sheet processing


<p>s that contain <ul><ol><table><dl><blockquote>? (did we get all those?)



> I'd like search engines to be able to show me the title of a page in the
> same consistent position in a search result, and the name of the site
> (if available) in the same consistent position in a search result, and
> the name of the author (if available) in the same consistent position in
> a search result.
>  
> For that to happen, it would help slightly if the HTML specification
> stopped SHOULD-ing the current <title> behavior. It would help more if
> the HTML specification contained clear, straightforward markup for
> author and site name (and encouraged UAs to present this information   
> when the document is taken out of context).

   <title site="" publisher="" author="">Page Title</title>
   <title>Page Title - <site></site> - <author></author> (<publisher></publisher>)</title>

   <title>Page Title</title>
   <link rel="top" title="" href="">
   <link rel="publisher" title="" href="">
   <link rel="author" title="" href="">


 h1 is styled appropriately, h2 to h6 are styled according to legacy.


[onclick] should make element focusable; enter should send onclick

define implied <html>, <head>, <body>, <p>, </p>, etc.

http://www.aujsproduction.com/samples/wishlist/revampedselector.asp


interactive elements can't be nested (as in <a><button><input></button></a>)


need a summary of all the content models and how they interact:
   a | interactive strictly inline-level element   | where inline-level content is expected | strictly inline-level content  | interactive elements must not be nested
   i | strictly inline-level element               | where inline-level content is expected | strictly inline-level content  |
  em | strictly inline-level element               | where inline-level content is expected | inline-level content           |
   p | block-level element, structured inline-     | where block-level content is expected, | inline-level content           | must not be nested
     | level element                               | where inline-level content is expected |                                |
...etc


need a summary of the differences between the HTML and XML serialisations.
e.g. how <p><ul> is allowed in one but not the other



Google suggest: oninput -> submit a form whose only contents is the
drop down list which you refresh (<datalist>).

Inline editing of <select multiple=""> boxes

image buttons shouldn't be used unless you want the coordinate

need for the spec to say something about sending proprietary data over
the network, e.j. in XMLHttpRequest and other data streams. Is it ok,
if the page is doing the translation?

built-in spell-checking in <input type="text">, <textarea>

author-driven highlighting of individual words in text fields


support access Array element via () instead of [] (IEism)
- https://bugzilla.mozilla.org/show_bug.cgi?id=289876


atom can do this:
       <author>
         <name>Mark Pilgrim</name>
         <uri>http://example.org/</uri>
         <email>f8dy@example.com</email>
       </author>
       <contributor>
         <name>Sam Ruby</name>
         <uri>http://intertwingly.net/blog/</uri>
       </contributor>
how do we do this in HTML5? (what's the use case?)

how to interpret an HTML5 document for syndication
http://hixie.ch/specs/hsf/hsf



section "rendering HTML" has to cope with:
 <q> element's quotes
 <section> <h1>
 default margins and paddings for <ul>, <form>, etc.

  <h4>The <code>q</code> element</h4>
  <p class="big-issue">Need to deal with the quotemark problem without
  adding verbose markup, breaking existing documents, or adding
  redundant elements.</p>



<Hixie> here's how <object> works (assuming you don't support ActiveX)
<Hixie> 1. look at the data="" attribute. If it's not there, go to the step i'll label "bail" below.
<Hixie> 2. fetch the file indicated by the data="" attribute.
<Hixie> 3. while waiting for the MIME type, treat <object> as a replaced element of transparent nothingness, intrinsic size zero.
<hyatt> (so we would honor width/height)
<hyatt> (because it's replaced)
<Hixie> (yes)
<Hixie> 4. if the MIME type is a long time coming (e.g. DNS is being slow) then jump to the "bail" step below until you have the MIME type, then jump back to step 5.
<Hixie> 5. Once you have the MIME type, examine it. If it's a plugin type, jump to the plugin step below. If it's an image, jump to the image step below. If it's a document type (HTML, XML, etc) jump to the iframe step below. Otherwise, you don't recognise it, and jump to the "bail" step.
<Hixie> plugin step: collect all the <param> element children in the <object>. instantiate the plugin and pass the params to it.
<Hixie> image step: render the <object> as if it was an <img>
<Hixie> document step: render the <object> as if it was an <iframe>
<Hixie> bail step: render the <object> as if it was a <span>
 - if there is no authoratative MIME type, then use the type="" attribute.
 - if type="" is something you know you don't support, you MAY not download it
 - if type="" is dynamically changed, do nothing
 - if data="" is dynamically changed, redo loop

<hyatt> apparently your url can come from <param>
<hyatt> not just the data attribute
<hyatt> our code looks for params with "src", "movie", "code" and "url"
<hyatt> and also tries to find the type on a param
<Hixie> oh that's you trying to have hacky activex support
<Hixie> opera does that too
<hyatt> yeah we support activex versions of plugins that are common
<hyatt> like flash and quicktime and realaudio
<Hixie> that would be a step 1b. if no data attribute, then look for a <param> to get you a URL instead.
<Hixie> and if you find one, carry on as if that was your data="".


should have some text talking about the fact that it's ok if your page
passes through a period of non-conformance while script is running,
but that in between scripts it should be compliant.


how to handle 205 reset content responses and other HTTP codes in
response to link clicks, link clicks with target="" attributes,
window.open(), the user typing a URI in the URL bar, etc.

XXX Native code for fast sorting of many data?

http://www.microsoft.com/mind/1097/directanim.asp


events: onmousewheel
<hyatt> with a wheelDelta field on the WheelEvent (whcih comes off UIEvent)
<hyatt> but in OS X you can wheel horizontally 
<hyatt> so we actually added wheelX, wheelY, and wheelZ
<hyatt> with wheelDelta just mapping to wheelY for WinIE compat
<Hixie_> oh i don't mind wheelZ, maybe we can even say ctrl+wheel should map to it on some platforms (windows)
<hyatt> but if you hold down Shift+mouse wheel in mac apps on os x you'll wheel horizontally
wheelDelta is multiples of 120
http://msdn.microsoft.com/workshop/author/dhtml/reference/properties/wheeldelta.asp

events:
http://damowmow.com/temp/safari/WebCore-315/khtml/ecma/kjs_events.cpp

Need to resolve whether <a rel=""> should affect an out-of-band UI (or
whether it should just be a may), see
https://bugs.opera.com/show_bug.cgi?id=169791


should have appendix listing what was already implemented
- http://www.xml.com/pub/a/2005/04/27/deviant.html

| Hixie and Steven shared an item: in both XHTML2 and HTML5, it will
| be possible to have a list child of a paragraph. That's good, from a
| structural point of view. But that's bad, from a user's point of
| view. Imagine you have a paragraph, with red background color. And
| you have an unordered list in your clipboard. You place the caret at
| the end of the paragraph and paste your list. Where does it end up?
| In the paragraph or after it? Red background or not? I really fear
| that, once again, document model authors are completely neglecting
| the authoring side.
 - http://www.glazman.org/weblog/dotclear/index.php?2005/05/27/1055-adam-2

need to define how to process MIME types in <style> and <script> and so forth.

http://www.paulgraham.com/popular.html



  <p>In the ECMAScript DOM binding, objects implementing this interface
  can also be dereferenced using square bracket notation (e.g.
  <code>foo[1]</code> or <code>foo["bar"]</code>). Dereferencing with
  an integer index is equivalent to invoking the <code>item()</code>
  method with that index, and dereferencing with a string index is
  equivalent to invoking the <code>namedItem()</code> method with that
  index.</p>


"you have mail": bubble notification; flash taskbar button, 
=> how do you stop advertisers?



events should bubble from documents to Window

say something about events fired on <body> -> document -> window, like
onload? onpopstate is defined as body->html->doc->window; as is the
local storage event. What about the old ones, how do they work? load,
error, scroll, resize, etc?

If we assuming that bubbling events bubble from document to window,
then it seems reasonable for scroll events that bubble to be fired at
the document if the window is resized, and scroll events that don't
bubble to be fired at elements if they are scrolled. window.onscroll
and document.onscroll should both work.


[HIT TESTING TRANSPARENCY]
Definition: IE considers a point of an element "transparent" if any
one of the following are true:

 1. All of the following are true:
    a: The computed value of 'background-image' is 'none', and
    b: The computed value of 'background-color' is 'transparent', and
    c: The point is over a pixel of an AlphaImageLoader filter image
       that has an alpha value of 0 (fully transparent), or the
       element does not have an AlphaImageLoader filter applied;

 2. The point is outside the element's CSS clip rectangle;

 3. The computed value of 'visibility' is 'hidden';

 4. The element is a transparent IFRAME (in IE, an IFRAME with the
    custom attribute "allowtransparency");

 5. The element is an OBJECT with the custom attribute "wmode" set to 
    "transparent" and the point in question is fully transparent.

Given those definitions, when a mouse event occurs, IE finds the
target element as follows:

   A. Take the topmost node that is under the point where the pointer
      was for the event. For CSS boxes, borders, padding areas and
      content areas are considered part of the node, margins and
      leading generated by the 'line-height' property are not.

   B. If there is no node at that point, no event is fired. STOP.

   C. If the node is a text node, then the event is fired at the text
      node's nearest ancestor element node. STOP.

   D. If the node is not an element, assign the node's nearest
      ancestor element node to a variable X. Otherwise, assign the
      element node itself to X.

   E. If the element X is the BODY element or the HTML element and its
      document is not the document of a transparent IFRAME, goto step
      H. Similarly, if the element X is a TABLE element, or is an IMG
      element, goto step H.

   F. If the point where the pointer was is, per the above definition,
      a point that on the element X is transparent, then ignore that
      element and assign the element that is below that element in the
      stacking order to X. If there is no element below X, or if the
      point on X is not transparent and so the previous condition
      doesn't apply, then leave X as is and go straight to step H.

   G. Goto step E.

   H. If the element X is now a BODY or TABLE element, but the element
      assigned to X in step D was some other element, assign the
      element originally assigned in step D back to X.

   I. The event goes to X. STOP




mousedown's default action is focus, so canceling mousedown stops focus transference.
e.g. on http://www.mozilla.org/editor/midasdemo/

xref all the _ERR exceptions to DOM3CORE


<select><option><hr> support


raising an exception when the wrong number of arguments is passed -
is that a language-specific thing, or what?

why |new XMLHttpRequest()| returns an object that .toStrings to
[object XMLHttpRequest], same with new TCPConnection(); what if a
constructor is called without using "new" in JS?


reload: fire an event when "reload" is pressed so that the page can
reload its data instead of the whole page. cancel the event cancels
the HTTP reload. Abuse prevention required, though.


load event: fire on body, document, window? or just let it bubble?


http://msdn.microsoft.com/workshop/author/dhtml/reference/methods/elementfrompoint.asp
http://msdn.microsoft.com/workshop/author/dhtml/reference/methods/showmodaldialog.asp


refs for TCP/IP (rfc793) and IPv6

http://www.joelonsoftware.com/items/2004/06/17.html
http://www.joelonsoftware.com/items/2004/06/18.html


<neutralise> block that kills scripting or anything dangerous?


XXXX need explanation of when to use undo/redo, and when to use back/forward

XXX "alternate style sheet" should be "alternative style sheet"




  <h5>Using the <code>a</code> element with the <code>command</code> attribute</h5>

  <p>If an <code>a</code> element has a <code
  title="command-attribute">command</code> attribute, then:</p>

  <p>If the element's <code>title</code> attribute is absent, then
  when the UA attempts to display the element's hint, it must instead
  use the specified command's Hint.</p>

  <p>Even if the element's <code>href</code> attribute is absent, the
  element must still match the CSS <code>:link</code> or
  <code>:visited</code> pseudo-classes. It must match the
  <code>:visited</code> pseudo-class if the command's action is to
  follow a link that has already been visited by the user, and must
  match the <code>:link</code> pseudo-class otherwise.</p>

  <p>If a <code>DOMActivate</code> event is dispatched on the element
  and is not canceled, and the event has no other default action, and
  the command's Disabled State is false (enabled), then the command's
  Action must be triggered as the default action.</p>

  <p class="note">The <code>DOMActivate</code> event is fired as the
  default action of the <code>click</code> event.</p>

  <p>If the command's Disabled State is true (disabled) then the
  element must be disabled and must therefore match the
  <code>:disabled</code> pseudo-class. UAs should style disabled links
  in such a way as to clearly convey their disabled state.</p>

  <p>The Label, Icon, Checked State and Type facets of the command are
  ignored by the <code>a</code> element (except for <a
  href="#pseudosAndCommands">matching CSS pseudo-classes</a>).</p>

  <h5>Using the <code>button</code> element with the <code>command</code> attribute</h5>

  <p>If a <code>button</code> element has a <code
  title="command-attribute">command</code> attribute, then:</p>

  <p>If the element's <code>title</code> attribute is absent, then
  when the UA attempts to display the element's hint, it must instead
  use the specified command's Hint.</p>

  <p>If a <code>DOMActivate</code> event is dispatched on the element
  and is not canceled, and the event has no other default action, and
  the command's Disabled State is false (enabled), and the button's
  <code>disabled</code> attribute is absent, then the command's Action
  must be triggered as the default action.</p>

  <p class="note">The <code>DOMActivate</code> event is fired as the
  default action of the <code>click</code> event.</p>

  <p>If the command's Disabled State is true (disabled) then the
  element must be disabled. The <code>button</code> element must also
  be disabled if the element's <code>disabled</code> attribute is
  set.</p>
 
  <p>The Label, Icon, Checked State and Type facets of the command are
  ignored by the <code>button</code> element (except for <a
  href="#pseudosAndCommands">matching CSS pseudo-classes</a>).</p>

  <h5>Using the <code>input</code> element with the <code>command</code> attribute</h5>

  <p>If an <code>input</code> element has no <code>type</code>
  attribute and no <code>name</code> attribute, and it has a <code
  title="command-attribute">command</code> attribute, then:</p>

  <p>If the command is of Type "command" then the element must
  generally be styled and behave as if it was of type
  <code>button</code>; if the Type of the command is "radio" then the
  element must generally be styled and behave as if it was of type
  <code>radio</code>; and if the Type of the command is "checkbox"
  then the element must generally be styled and behave as if it was of
  type <code>checkbox</code>.</p>

  <p>If the command is of Type "command" and the element's
  <code>value</code> attribute is absent, then when the UA attempts to
  display the element's caption, it must instead use the specified
  command's Label. The Label facet is ignored if the command is not of
  Type "command".</p>

  <p>The UA may use the Icon facet of the command to render an
  icon in the control, if appropriate for the UI used.</p>

  <p>If the element's <code>title</code> attribute is absent, then
  when the UA attempts to display the element's hint, it must instead
  use the specified command's Hint.</p>

  <p>If a <code>DOMActivate</code> event is dispatched on the element
  and is not canceled, and the event has no other default action, and
  the command's Disabled State is false (enabled), and the element's
  <code>disabled</code> attribute is absent, then the command's Action
  must be triggered as the default action.</p>

  <p class="note">The <code>DOMActivate</code> event is fired as the
  default action of the <code>click</code> event.</p>

  <p>If the command's Disabled State is true (disabled) then the
  element must be disabled. The <code>input</code> element must also
  be disabled if the element's <code>disabled</code> attribute is
  set.</p>

  <p>If the command's Checked State is true (checked) then the element
  must be checked. The <code>input</code> element must also be checked
  if the element's <code>checked</code> attribute is set.</p>




  <p>This element should not be directly displayed. In CSS-aware user
  agents, this should be achieved by including the following rules, or
  their equivalent, in the UA's user agent style sheet:</p>

  <pre>@namespace xh url(http://www.w3.org/1999/xhtml);
xh|command { display: none; }</pre>



  <h5 id="command-with-command">Using the <code>command</code> element with the <code>command</code> attribute</h5>

  <p>If a <code>command</code> element has a <code
  title="command-attribute">command</code> attribute, then:</p>

  <p>If the element's <code>label</code> attribute is absent, then
  when the UA attempts to display the element's caption, it must instead
  use the specified command's Label.</p>

  <p>If the element's <code>icon</code> attribute is absent, then
  when the UA attempts to display the element's icon, it must instead
  use the specified command's Icon.</p>

  <p>If the element's <code>title</code> attribute is absent, then
  when the UA attempts to display the element's hint, it must instead
  use the specified command's Hint.</p>

  <p>If a <code>click</code> event is dispatched on the element and is
  not canceled, and the command's Disabled State is false (enabled),
  and the element's own <code>disabled</code> attribute is absent,
  then the command's Action must be triggered as the default
  action.</p>

  <p>If the command's Disabled State is true (disabled) then the
  element must be disabled. The <code>command</code> element must also
  be disabled if the element's <code>disabled</code> attribute is
  set.</p>

  <p>If the command's Checked State is true (checked) then the
  element must be checked. The <code>command</code> element must also
  be checked if the element's <code>checked</code> attribute is
  set.</p>

  <p>When a <code title="command-element">command</code> element has a
  <code title="command-attribute">command</code> attribute, any <code
  title="attr-command-type">type</code> and <code
  title="attr-command-radiogroup">radiogroup</code> attribute is
  ignored.</p>



  <h4>The 'icon' property</h4>

  <p>UAs should use the command's Icon as the default generic icon
  provided by the user agent when the 'icon' property computes to
  'auto' on an element that either defines a command or refers to one
  using the <code title="command-attribute">command</code>
  attribute.</p>

  <h4 id="pseudosAndCommands">CSS pseudo-classes and commands</h4>

  <p>When an element uses the <code
  title="command-attribute">command</code> attribute, any UI
  pseudo-classes from the following list that apply to the element
  defining the command also apply to the elements that refer to that
  command.</p>

  <dl>

   <dt>:enabled, :disabled</dt>

   <dd>Matches commands whose Disabled State facet is False and True
   respectively.</dd>

   <dt>:checked</dt>

   <dd>Matches commands whose Type facet is either "radio" or
   "checkbox", and whose Checked State facet is true.</dd>

  </dl>



  <p><code>menu</code> elements with explicit <code>label</code>
  attributes, and <code>menu</code> elements following
  <code>menulabel</code> elements, should be hidden. In CSS-aware UAs,
  this effect should be achieved by including the following rules, or
  their equivalent, in the UA's user agent style sheet:</p>

  <pre>@namespace xh url(http://www.w3.org/1999/xhtml);
xh|menu[label], xh|menulabel + xh|menu { display: none; }</pre>

  <p>All other <code>menu</code> elements should be rendered
  identically to <code>ul</code> elements. In CSS-aware UAs, this
  effect may be achieved by including rules similar to the following
  in the UA's user agent style sheet:</p>

  <pre>@namespace xh url(http://www.w3.org/1999/xhtml);
xh|menu { display: block; margin: 0 0 0 40px; list-style: disc; }</pre>




  <h5>Displaying menus</h5>

  <p>When a <code>menu</code> element is activated, the associated
  menu should be constructed and shown. (For details on how a
  <code>menu</code> element can be activated, see the sections on
  <span>menu links</span> and <span>menu bars</span>.)</p>

  <p>The styles applied to each element in the <code>menu</code>
  element, as well as the element itself, may be applied when
  constructing a menu. UAs are recommended to not apply styling to
  context menus and menus for application menu bars, and to only use
  styles for in-page menus.</p>

  <p>If user agents support styling of menus, they should only support
  the '<code>background</code>', '<code>color</code>',
  '<code>border</code>', '<code>padding</code>' and
  '<code>font</code>' properties on menus and menu items. (This list
  might be incomplete; in general, properties that merely affect the
  appearance of the element should work, but properties that affect
  the layout should not.)</p>

  <p>As the user interacts with a menu, the elements from which the
  menu was created should have appropriate pseudo-classes (:hover,
  :focus, :active) applied.</p>

  <p>The menu items must only consider the computed styles of the
  elements from which they were derived, not other elements.</p>

  <div class="example">

   <p>For example, take this menu:</p>

   <pre>&lt;menu&gt;
&lt;li&gt;&lt;command label="a"/&gt;&lt;/li&gt;
&lt;menu&gt;</pre>

   <p>The menu has one menu item, labelled "a".</p>

   <p>Styles applied to the <code>li</code> element in this menu would
   have no effect on the rendered menu, except in so far as styles
   inherit from that element to the <code>command</code> element.</p>

   <p>Styles applied to the <code>command</code> element could affect
   the menu. While the user is hovering over the menu item, the
   <code>:hover</code> pseudo-class matches the <code>command</code>
   element and any appropriate newly matching rules could be
   applied.</p>

  </div>

  <p>When activated from a <span title="menu links">menu link</span>,
  a menu must be placed in an Appropriate Place. Specifically, if the
  <code>a</code> element is displayed as a vertically-stacked box (as
  is typically seen for elements with '<code>display: block</code>',
  '<code>list-item</code>', or '<code>table</code>'), then the menu
  should appear vertically below the element, anchored so that one of
  its top corners coincides with a bottom corner of the box so that
  the menu and the box each have a horizontal sides in common (or a
  bottom corner of the menu coincides with a top corner of the box, if
  there isn't enough room for the menu to drop down); otherwise, if
  the element is displayed as a horizontally stacked box
  ('<code>display: inline</code>', '<code>table-cell</code>', etc),
  the menu should appear to the <em>side</em> of the box in an
  analogous way. If the element is on the right of the page, the menu
  should drop to the left, and vice versa.</p>

  <p>UAs should implement the drop-down behaviour in more
  platform-appropriate ways if the platform conventions differ from
  the behaviour described above.</p>




  <h4>The <dfn title="command-attribute"><code>command</code></dfn>
  attribute</h4>

  <p>Any element that can define a command can also, instead, have a
  <code>command</code> attribute that specifies the ID of a command
  that the element should defer to. In this case the element does not
  define a command, but, in the absence of attributes to the contrary,
  reflects the state of the element specified.</p>

  <p>If the <code>command</code> attribute specifies an ID that is not
  the ID of an element that defines a command, then the
  <code>command</code> DOM attribute is set to the null value, and the
  element acts as if it was linked to an element that defined a
  command with no Label, no Hint, no Icon, no Action, that was not
  Hidden, not Disabled, not Checked, and that was of Type
  "command".</p>


replaceable DOM properties: http://lxr.mozilla.org/mozilla/source/dom/src/base/nsDOMClassInfo.cpp#5928
<       brendan>|Hixie: so yeah, lxr for JSRESOLVE_QUALIFIED

screen object:
screen contains top left width height pixelDepth colorDepth availWidth availHeight availLeft availTop



  <p>The most direct way to represent a command is by using the <code
  title="command-element">command</code> element. A <code
  title="command-element">command</code> element defines a command if
  it does not have a <code title="command-attribute">command</code>
  attribute.</p>

  <div class="example">
   <pre>...
 &lt;command id="c_stop" label="Emergency Stop" onclick="dostop()"/&gt;
 &lt;command id="c_go" label="Go" onclick="dogo()"/&gt;
 &lt;command id="c_lamp" label="Headlamps" onclick="dof2()" disabled="disabled"/&gt;
...</pre>
</div>

  <p>The <code>command</code> element, in addition to the core and
  internationalisation attributes, may have the following
  attributes specified:</p>

  <dl>

   <!-+- yes i know that some of these are core attributes. If you can
   give me a better introductory paragraph, I'm all for it. -+->

   <dt><dfn title="attr-command-type"><code>type</code></dfn></dt>

   <dd>The command's Type. If present, this attribute must either have
   the value <code>radio</code>, in which case the command is of Type
   "radio", or the value <code>checkbox</code>, in which case the
   command is (amazingly) of Type "checkbox". Any other value, or the
   absence of the attribute altogether, means that the command is of
   Type "command".</dd>

   <dt><dfn title="attr-command-id"><code>id</code></dfn></dt>

   <dd>The command's ID. If this attribute is not specified, then the
   command is anonymous.</dd>

   <dt><dfn title="attr-command-label"><code>label</code></dfn></dt>

   <dd>The command's Label. If the attribute is not specified, the
   command's Label is given by the element's <code>textContent</code>
   DOM attribute.</dd>

   <dt><dfn title="attr-command-title"><code>title</code></dfn></dt>

   <dd>The command's Hint. If the attribute is not specified, the
   command's Hint is the empty string.</dd>

   <dt><dfn title="attr-command-icon"><code>icon</code></dfn></dt>

   <dd>A URI to the command's Icon. If the attribute is not specified,
   then the command has no Icon.</dd>

   <dt><dfn title="attr-command-onclick"><code>onclick</code></dfn></dt>

   <dd>An event handler attribute that listens for <code>click</code>
   events.</dd>

   <dt><dfn title="attr-command-hide"><code>hide</code></dfn></dt>

   <dd>The command's Hidden State. If the attribute is present, the
   command is hidden (and also disabled, regardless of the value of
   the <code>disabled</code> attribute), otherwise, the command is
   shown. If the attribute is present, it should have the value
   "<code>hide</code>". <!-+-The name of the attribute reflects the
   fact that Hidden commands in menus are hidden.-+-></dd>

   <dt><dfn title="attr-command-disabled"><code>disabled</code></dfn></dt>

   <dd>The command's Disabled State. If the attribute is present, the
   command is disabled, otherwise, the command is enabled. If the
   attribute is present, it should have the value
   "<code>disabled</code>".</dd>

   <dt><dfn title="attr-command-checked"><code>checked</code></dfn></dt>

   <dd>The command's Checked State. If the attribute is present, the
   command is checked, otherwise, the command is not. If the attribute
   is present, it should have the value "<code>checked</code>".</dd>

   <dt><dfn title="attr-command-radiogroup"><code>radiogroup</code></dfn></dt>

   <dd>An attribute indicating the name of the group of commands that
   will be toggled when the command itself is toggled. (Described <a
   href="#radiocommand">below</a>.)</dd>

   <dt><dfn title="attr-command-default"><code>default</code></dfn></dt>

   <dd>An attribute indicating whether the command is the default
   command. If the attribute is present, the command is the default
   command, otherwise it is not. If it is set, it should have the
   value <code>default</code>. Used by context menus to indicate what
   the default option would be. The :default pseudo-class matches
   <code>command</code> elements with this attribute.</dd>

  </dl>

  <p>In addition, <code title="command-element">command</code>
  elements may also have a <code
  title="command-attribute">command</code> attribute, as <a
  href="#command-with-command">described below</a>.</p>

  <p>The Type, ID, Label, Hint, Icon, Hidden State, Disabled State,
  and Checked State of the command defined by a <code
  title="command-element">command</code> element are as described
  above. The Action of a <code title="command-element">command</code>
  element is that a <code>{null, "click"}</code> event is fired on the
  element.</p>

  <p>If the Type of the command is "checkbox", when a
  <code>click</code> event is dispatched on the element, user agents
  must toggle the value of the <code>checked</code> attribute before
  the event is dispatched in the document. (If the attribute is
  absent, then it is set to the value <code>checked</code>, and if the
  attribute is present, it is removed.) If the default action of the
  event is canceled, the value of the attribute must be changed back
  to the value it had before the event was dispatched.</p>

  <p id="radiocommand">If the Type of the command is "radio", when a
  <code>click</code> event is dispatched on the element, user agents
  must set the value of the <code>checked</code> attribute on the
  element to <code>checked</code>, and remove the attribute from any
  <code>command</code> elements with <code>type</code> set to
  <code>radio</code> and the same parent element and same
  <code>radiogroup</code> attribute, before the event is dispatched in
  the document. (If the element has no <code>radiogroup</code>
  attribute, then the elements "with the same <code>radiogroup</code>
  attribute" are those elements with <em>no</em>
  <code>radiogroup</code> attribute.) If the default action of the
  event is canceled, the value of the attributes that were changed
  must be changed back to the values they had before the event was
  dispatched.</p>

  <p>In HTML the <code>command</code> element is an empty element with
  no end tag.</p>

  <p>Authors should put <code>command</code> elements inside the
  <code>head</code> element, inside any element that may contain
  <span>block-level elements</span> or <span>inline-level
  content</span>, or inside <code>commandset</code> elements.</p> <!-+-
  should, because hey, if they want to put them elsewhere, why not.
  XXX -+->

  <p>Authors should not put elements or text inside
  <code>command</code> elements.</p>




  <p>The <code title="dom-command-ro-command">command</code> DOM attribute
  is defined with the <code title="attr-command">command</code>
  content attribute.</p>


Need to become consistent about whether or not to quote keyword
("<code title="">foo</code>" vs <code>foo</code>)



  XXX command icons in rendering section:

  If the element defining the command has no explicit icon, then the
  attribute must instead return the computed value of the CSS '<code
  title="">icon</code>' property on that element. <a
  href="#refsCSS3UI">[CSS3UI]</a>

  If the computed value of '<code title="">icon</code>' is
  '<code>auto</code>',


search for event-click and make them all point to:
<a href="http://www.w3.org/TR/DOM-Level-3-Events/events.html#event-click"><code>click</code></a>
...or something.

<code>DOMActivate -> <code title="event-DOMActivate">DOMActivate


onclick="" only fires if it is a MouseEvent


<form> .submit definition - see http://lxr.mozilla.org/mozilla/source/content/html/content/src/nsHTMLFormElement.cpp#600
for how to handle multiple calls in series


http://lxr.mozilla.org/mozilla/source/content/html/content/src/nsHTMLFormElement.cpp#699

How events are handled:
http://lxr.mozilla.org/mozilla/ident?i=HandleDOMEvent

http://www.quirksmode.org/js/events_compinfo.html
e.g. mousedown mouseup click mousedown mouseup click dblclick

http://msdn.microsoft.com/library/default.asp?url=/workshop/author/dhtml/reference/events.asp



05:46 <            bz>|Hixie: let's put it this way
05:46 <            bz>|Hixie: 1)  A script is executed when its data is available
05:47 <            bz>|Hixie: 2) The data for an inline script is available when its </script> is seen
05:47 <            bz>|Hixie: 3) The data for a script with src is available when it finishes loading
05:47 <            bz>|Hixie: all good so far?
05:47 <         Hixie>|i'm waiting for the bit where src= causes blocking in the normal, non-d.w case
05:47 <            bz>|Hixie: 4) The data for a script with src starts loading when the <script> node is inserted into the DOM
05:48 <        shaver>|it causes parser blocking in the normal case
05:48 <            bz>|Hixie: 5)  When such a load starts, all further parsing is suspended until the load has completed and the script has executed.
05:48 <            bz>|Hixie: so if we forget document.write
05:48 <            bz>|Hixie: and look at the HTML:  <script src="foo"></script><div>
05:48 <            bz>|Hixie: the text "<div>" will nto be parsed until after the script runs
05:49 <            bz>|Hixie: this is needed so that if the script does document.write that text can be inserted _before_ the "<div>" text into the parser
05:49 <         Hixie>|sure
05:49 <         Hixie>|all this is fine
05:49 <            bz>|Hixie: ok.  So now let's look at our case
05:49 <         Hixie>|but how does document.write() know when to return?
05:49 -!- davel [davel@moz-4F4E281A.dsl.static.sonic.net] has quit [Quit: davel]
05:49 <            bz>|It gives the data to the parser, and tells the parser to parse it
05:49 <            bz>|Once the parser returns, document.write returns
05:50 <            bz>|The parser returns when it runs out of data to parse (it's parsed it all)
05:50 <            bz>|Or if it's explicitly suspended (eg by a <script src="">)
05:50 <         Hixie>|AH
05:50 <            bz>|All this in Gecko
05:50 <         Hixie>|ok that was the key piece of information i was missing
05:50 <         Hixie>|the "explicit suspension"
05:50 <         Hixie>|ok
but test IE on this...


XXX publish a "Valid HTML5!" button with a kitten on it. Made by an artist. (Doodle?)


XXX rename "Block-level" and "inline-level" to something else to
prevent terminology clash with CSS.

   Interaction with document.open/write/close is undefined
   How to determine the character encoding
   Integration with quirks mode problems
   <style> parsing needs tweaking if we want to exactly match IE
   <base> parsing needs tweaking to handle multiple <base>s
   <isindex> needs some prose in the form submission section
   No-frames and no-script modes aren't yet defined
   Execution of <script> is not yet defined
   New HTML5 elements aren't yet defined
   There are various cases (marked) where EOF handling is undefined
   Interaction with the "load" event is undefined


hsivonen:
> To make document conformance a more useful concept for the purpose of catching
> author errors, I suggest that the following attributes be made required:
> href and rel on link
> href on base
> name and content on meta (other than the encoding decl)
> src on img
> code, height and width on applet
> name and value on param
...
> To allow user agents see whether the author provided the empty string as the
> alternative text of whether the author just didn't care, I suggest that the
> alt attribute on img be made optional.
(i agree -ian)
...
> On the other hand, I have doubts about the requirement of significant
> inline content. When the W3C said that paragraphs mustn't be empty,
> various applications started emitting <p>&nbsp;</p>. If the WHAT WG says
> that paragraphs must contend significant inline content, are the
> developers of those applications suddenly going to decide not to allow
> them to paragraphs to be saved or are they going to come up with an even
> more crufty work-around to comply with the machine-checkable
> requirements of the spec?
(i agree, i think we should drop "significant inline content". -ian)


bjoern:
> If the concern here is what the specification should say, then that's
> what a valid state is, not what a valid document is, since the class of
> "predictably valid" documents does not cover many dynamic documents.



arv asks for: a way to track download progress of, e.g., images when
you are preloading 10 images; cf onprogress on XHR in mozilla


window.getAttention() or some similar API to let the user know the
page wants attention? How do you reduce the chance of irritation?
see also https://bugzilla.mozilla.org/show_bug.cgi?id=293412




ITEM

Items have:
 - parents, children
 - properties
 - commands that can apply to them



   <li>Inline markup for pop-up windows, for example for dialog boxes
   or tool palettes, so that dialogs need not be defined in separate
   files.</li>

   <li>Command updating: applications that have several access
   points for the same feature, for instance a menu item and a
   tool-bar button, would benefit from having to disable such
   commands only once, instead of having to keep each access point
   synchronized with the feature's availability at all times.
   Similarly menu items or tool-bar buttons that represent a toggle
   state could automatically stay synchronized whenever
   toggled.</li>

   <li>More device-independent DOM events: The DOM event set needs
   device-independent events, such as events that fire when a button
   or link is activated, whether via the mouse or the keyboard.
   <code>DOMActivate</code> is a start, but it lacks equivalent HTML
   attributes, and additional events may be needed.</li>

   <li>Richer widget set: the existing HTML controls are quite
   limited, some controls for commonly used types such as date
   controls and range controls would be useful.</li>

   <li>Sortable and multicolumn tree views and list views with rich
   formatting.</li>

   <li>Ability to define custom widgets cleanly, for example using
   XBL and APIs to query and control focus state, widget state, the
   position and state of input devices, etc.</li>

   <li>Rich text editing: an underlying architecture upon which
   domain-specific editors can be created, including things like
   control over the caret position.</li>

   <li>A predefined HTML editor based on the rich text editing
   architecture.</li>

   <li>Drag and drop APIs.</li>

   <li>Text selection manipulation APIs.</li>

   <li>Clipboard APIs (if the security and privacy concerns can be
   addressed).</li>

   <li>Flexible box model: The existing box model in CSS is designed
   largely for documents rather than user interface. We need a new
   box model designed for user interface which would relieve author
   complaints about other aspects of CSS and also reduce the need
   for tables for layout.</li>

   <li>Window-based state management (so that new windows don't
   interfere with existing sessions), for example implemented as a
   per-domain, per-window "file system". This would allow multiple
   instances of the same application (from the same site) to run
   without the instances overwriting each other's cookies.</li>

   <li>Markup to denote <span>mutually exclusive sections</span> (as
   in the commonly seen wizard interfaces).</li>

   <li>An improved CSS object model, for example with better APIs
   for animation, simpler ways to navigate the rendered content, a
   way to find the position of an element, methods to list the
   elements under a coordinate, etc.</li>

   <li>Better defined user authentication state handling. (Being able
   to "log out" of sites reliably, for instance, or being able to
   integrate the HTTP authentication model into the Web page.)</li>


offline storage / caching pining:
http://groups.google.com/group/mozilla.dev.platform/browse_frm/thread/bf866101aa238773/a298294c27b9380a?lnk=gst&q=offline&rnum=1#a298294c27b9380a


DOM0 quirks that Mozilla knows about:
http://lxr.mozilla.org/seamonkey/source/dom/src/base/nsDOMClassInfo.cpp



mutually exclusive sections:
  <p class="example">For example, in an application for an online
  mutiplayer game, there could be four mutually exclusive sections:
  one for the login page, one for the network status page displayed
  while the user is logging in, one for a "lobby" where players get
  together to organise a game, and one for the actual game. The
  different sections are the various states that the application can
  reach.</p>


XXX make a consistent decision of which of the following formats to use:

    U+1234 FOO BAR character ("foo")
    U+1234 FOO BAR character ('foo')
    U+1234 FOO BAR character (foo)
    U+1234 FOO BAR ("foo") character
    U+1234 FOO BAR ('foo') character
    U+1234 FOO BAR (foo) character
    U+1234 FOO BAR character ("<code title="">foo</code>")
    U+1234 FOO BAR character ('<code title="">foo</code>')
    U+1234 FOO BAR character (<code title="">foo</code>)
    U+1234 FOO BAR ("<code title="">foo</code>") character
    U+1234 FOO BAR ('<code title="">foo</code>') character
    U+1234 FOO BAR (<code title="">foo</code>) character

And make these match:

    0x12 (ASCII FOO)
    0x12 (ASCII "foo")
    0x12 (ASCII 'foo')
    0x12 ("foo")
    0x12 ('foo')

-->

  <script src="http://status.whatwg.org/annotate-web-apps.js" type="text/javascript"></script>
 </body>
</html>
